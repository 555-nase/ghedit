var __extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)};define(["require","exports","vs/base/common/async","vs/base/browser/styleMutator","vs/editor/common/core/range","vs/editor/common/editorCommon","vs/editor/browser/editorBrowser","vs/editor/browser/view/viewLayer","vs/editor/browser/viewParts/lines/viewLine","vs/editor/browser/config/configuration","vs/editor/common/view/renderingContext","vs/css!./viewLines"],function(e,t,i,n,o,r,s,a,l,d,u){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var h=function(){function e(){this._currentVisibleRange=new o.Range(1,1,1,1),this._bigNumbersDelta=0}return e.prototype.getCurrentVisibleRange=function(){return this._currentVisibleRange},e.prototype.setCurrentVisibleRange=function(e){this._currentVisibleRange=e},e.prototype.getBigNumbersDelta=function(){return this._bigNumbersDelta},e.prototype.setBigNumbersDelta=function(e){this._bigNumbersDelta=e},e}(),g=function(e){function t(t,n){var o=this;e.call(this,t),this._lineHeight=this._context.configuration.editor.lineHeight,this._isViewportWrapping=this._context.configuration.editor.wrappingInfo.isViewportWrapping,this._revealHorizontalRightPadding=this._context.configuration.editor.viewInfo.revealHorizontalRightPadding,this._canUseTranslate3d=t.configuration.editor.viewInfo.canUseTranslate3d,this._layoutProvider=n,this.domNode.setClassName(s.ClassNames.VIEW_LINES),d.Configuration.applyFontInfo(this.domNode,this._context.configuration.editor.fontInfo),this._maxLineWidth=0,this._asyncUpdateLineWidths=new i.RunOnceScheduler(function(){o._updateLineWidths()},200),this._lastRenderedData=new h,this._lastCursorRevealRangeHorizontallyEvent=null,this._textRangeRestingSpot=document.createElement("div"),this._textRangeRestingSpot.className="textRangeRestingSpot"}return __extends(t,e),t.prototype.dispose=function(){this._asyncUpdateLineWidths.dispose(),this._layoutProvider=null,e.prototype.dispose.call(this)},t.prototype.getDomNode=function(){return this.domNode.domNode},t.prototype.onConfigurationChanged=function(t){var i=e.prototype.onConfigurationChanged.call(this,t);return t.wrappingInfo&&(this._maxLineWidth=0),t.lineHeight&&(this._lineHeight=this._context.configuration.editor.lineHeight),t.wrappingInfo&&(this._isViewportWrapping=this._context.configuration.editor.wrappingInfo.isViewportWrapping),t.viewInfo.revealHorizontalRightPadding&&(this._revealHorizontalRightPadding=this._context.configuration.editor.viewInfo.revealHorizontalRightPadding),t.viewInfo.canUseTranslate3d&&(this._canUseTranslate3d=this._context.configuration.editor.viewInfo.canUseTranslate3d),t.fontInfo&&d.Configuration.applyFontInfo(this.domNode,this._context.configuration.editor.fontInfo),i},t.prototype.onLayoutChanged=function(t){var i=e.prototype.onLayoutChanged.call(this,t);return this._maxLineWidth=0,i},t.prototype.onModelFlushed=function(){var t=e.prototype.onModelFlushed.call(this);return this._maxLineWidth=0,t},t.prototype.onModelDecorationsChanged=function(t){for(var i=e.prototype.onModelDecorationsChanged.call(this,t),n=this._linesCollection.getStartLineNumber(),o=this._linesCollection.getEndLineNumber(),r=n;r<=o;r++)this._linesCollection.getLine(r).onModelDecorationsChanged();return i||!0},t.prototype.onCursorRevealRange=function(e){var t=this._computeScrollTopToRevealRange(this._layoutProvider.getCurrentViewport(),e.range,e.verticalType);return e.revealHorizontal&&(this._lastCursorRevealRangeHorizontallyEvent=e),this._layoutProvider.setScrollPosition({scrollTop:t}),!0},t.prototype.onCursorScrollRequest=function(e){var t=this._layoutProvider.getScrollTop(),i=t+e.deltaLines*this._lineHeight;return this._layoutProvider.setScrollPosition({scrollTop:i}),!0},t.prototype.onScrollChanged=function(t){return this.domNode.setWidth(t.scrollWidth),e.prototype.onScrollChanged.call(this,t)||!0},t.prototype.getPositionFromDOMInfo=function(e,t){var i=this._getLineNumberFromDOMInfo(e);if(i===-1)return null;if(i<1||i>this._context.model.getLineCount())return null;if(1===this._context.model.getLineMaxColumn(i))return{lineNumber:i,column:1};var n=this._linesCollection.getStartLineNumber(),o=this._linesCollection.getEndLineNumber();if(i<n||i>o)return null;var r=this._linesCollection.getLine(i).getColumnOfNodeOffset(i,e,t),s=this._context.model.getLineMinColumn(i);return r<s&&(r=s),{lineNumber:i,column:r}},t.prototype._getLineNumberFromDOMInfo=function(e){for(;e&&1===e.nodeType;){if(e.className===s.ClassNames.VIEW_LINE)return parseInt(e.getAttribute("lineNumber"),10);e=e.parentElement}return-1},t.prototype.getLineWidth=function(e){var t=this._linesCollection.getStartLineNumber(),i=this._linesCollection.getEndLineNumber();return e<t||e>i?-1:this._linesCollection.getLine(e).getWidth()},t.prototype.linesVisibleRangesForRange=function(e,i){if(this.shouldRender())return null;var n=e.endLineNumber;if(e=o.Range.intersectRanges(e,this._lastRenderedData.getCurrentVisibleRange()),!e)return null;var r,s=[],a=this.domNode.domNode.getBoundingClientRect().left;i&&(r=this._context.model.convertViewPositionToModelPosition(e.startLineNumber,1).lineNumber);for(var l=this._linesCollection.getStartLineNumber(),d=this._linesCollection.getEndLineNumber(),h=e.startLineNumber;h<=e.endLineNumber;h++)if(!(h<l||h>d)){var g=h===e.startLineNumber?e.startColumn:1,c=h===e.endLineNumber?e.endColumn:this._context.model.getLineMaxColumn(h),p=this._linesCollection.getLine(h).getVisibleRangesForRange(g,c,a,this._textRangeRestingSpot);if(p&&0!==p.length){if(i&&h<n){var f=r;r=this._context.model.convertViewPositionToModelPosition(h+1,1).lineNumber,f!==r&&(p[p.length-1].width+=t.LINE_FEED_WIDTH)}s.push(new u.LineVisibleRanges(h,p))}}return 0===s.length?null:s},t.prototype.visibleRangesForRange2=function(e,t){if(this.shouldRender())return null;if(e=o.Range.intersectRanges(e,this._lastRenderedData.getCurrentVisibleRange()),!e)return null;for(var i=[],n=this.domNode.domNode.getBoundingClientRect().left,r=this._lastRenderedData.getBigNumbersDelta(),s=this._linesCollection.getStartLineNumber(),a=this._linesCollection.getEndLineNumber(),l=e.startLineNumber;l<=e.endLineNumber;l++)if(!(l<s||l>a)){var d=l===e.startLineNumber?e.startColumn:1,h=l===e.endLineNumber?e.endColumn:this._context.model.getLineMaxColumn(l),g=this._linesCollection.getLine(l).getVisibleRangesForRange(d,h,n,this._textRangeRestingSpot);if(g&&0!==g.length)for(var c=this._layoutProvider.getVerticalOffsetForLineNumber(l)-r+t,p=0,f=g.length;p<f;p++)i.push(new u.VisibleRange(c,g[p].left,g[p].width))}return 0===i.length?null:i},t.prototype._createLine=function(){return l.createLine(this._context)},t.prototype._updateLineWidths=function(){for(var e=this._linesCollection.getStartLineNumber(),t=this._linesCollection.getEndLineNumber(),i=1,n=e;n<=t;n++){var o=this._linesCollection.getLine(n).getWidth();i=Math.max(i,o)}this._ensureMaxLineWidth(i)},t.prototype.prepareRender=function(){throw new Error("Not supported")},t.prototype.render=function(){throw new Error("Not supported")},t.prototype.renderText=function(t,i){if(!this.shouldRender())throw new Error("I did not ask to render!");if(e.prototype._renderLines.call(this,t),this._lastRenderedData.setBigNumbersDelta(t.bigNumbersDelta),this._lastRenderedData.setCurrentVisibleRange(t.visibleRange),this.domNode.setWidth(this._layoutProvider.getScrollWidth()),this.domNode.setHeight(Math.min(this._layoutProvider.getTotalHeight(),1e6)),i(),this._lastCursorRevealRangeHorizontallyEvent){var o=this._lastCursorRevealRangeHorizontallyEvent.range;this._lastCursorRevealRangeHorizontallyEvent=null,this.onDidRender();var r=this._computeScrollLeftToRevealRange(o),s=this._isViewportWrapping;s||this._ensureMaxLineWidth(r.maxHorizontalOffset),this._layoutProvider.setScrollPosition({scrollLeft:r.scrollLeft})}if(this._canUseTranslate3d){var a="translate3d("+-this._layoutProvider.getScrollLeft()+"px, "+t.visibleRangesDeltaTop+"px, 0px)";n.StyleMutator.setTransform(this.domNode.domNode.parentNode,a),n.StyleMutator.setTop(this.domNode.domNode.parentNode,0),n.StyleMutator.setLeft(this.domNode.domNode.parentNode,0)}else n.StyleMutator.setTransform(this.domNode.domNode.parentNode,""),n.StyleMutator.setTop(this.domNode.domNode.parentNode,t.visibleRangesDeltaTop),n.StyleMutator.setLeft(this.domNode.domNode.parentNode,-this._layoutProvider.getScrollLeft());this._asyncUpdateLineWidths.schedule()},t.prototype._ensureMaxLineWidth=function(e){var t=Math.ceil(e);this._maxLineWidth<t&&(this._maxLineWidth=t,this._layoutProvider.onMaxLineWidthChanged(this._maxLineWidth))},t.prototype._computeScrollTopToRevealRange=function(e,t,i){var n,o,s=e.top,a=e.height,l=s+a;n=this._layoutProvider.getVerticalOffsetForLineNumber(t.startLineNumber),o=this._layoutProvider.getVerticalOffsetForLineNumber(t.endLineNumber)+this._layoutProvider.heightInPxForLine(t.endLineNumber),i===r.VerticalRevealType.Simple&&(o+=this._lineHeight);var d;if(i===r.VerticalRevealType.Center||i===r.VerticalRevealType.CenterIfOutsideViewport)if(i===r.VerticalRevealType.CenterIfOutsideViewport&&s<=n&&o<=l)d=s;else{var u=(n+o)/2;d=Math.max(0,u-a/2)}else d=this._computeMinimumScrolling(s,l,n,o);return d},t.prototype._computeScrollLeftToRevealRange=function(e){var i=0;if(e.startLineNumber!==e.endLineNumber)return{scrollLeft:0,maxHorizontalOffset:i};var n=this._layoutProvider.getCurrentViewport(),o=n.left,r=o+n.width,s=this.visibleRangesForRange2(e,0),a=Number.MAX_VALUE,l=0;if(!s)return{scrollLeft:o,maxHorizontalOffset:i};var d,u;for(d=0;d<s.length;d++)u=s[d],u.left<a&&(a=u.left),u.left+u.width>l&&(l=u.left+u.width);i=l,a=Math.max(0,a-t.HORIZONTAL_EXTRA_PX),l+=this._revealHorizontalRightPadding;var h=this._computeMinimumScrolling(o,r,a,l);return{scrollLeft:h,maxHorizontalOffset:i}},t.prototype._computeMinimumScrolling=function(e,t,i,n){e=0|e,t=0|t,i=0|i,n=0|n;var o=t-e,r=n-i;return r<o?i<e?i:n>t?Math.max(0,n-o):e:i},t.LINE_FEED_WIDTH=10,t.HORIZONTAL_EXTRA_PX=30,t}(a.ViewLayer);t.ViewLines=g});