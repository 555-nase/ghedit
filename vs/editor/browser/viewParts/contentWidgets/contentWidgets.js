/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(t,e){function o(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)};define(["require","exports","vs/base/browser/dom","vs/base/browser/styleMutator","vs/editor/browser/editorBrowser","vs/editor/browser/view/viewPart","vs/css!./contentWidgets"],function(t,e,o,i,n,r){"use strict";var s=function(t){function e(e,o){t.call(this,e),this._viewDomNode=o,this._widgets={},this._contentWidth=0,this._contentLeft=0,this._lineHeight=this._context.configuration.editor.lineHeight,this._renderData={},this.domNode=document.createElement("div"),this.domNode.className=n.ClassNames.CONTENT_WIDGETS,this.overflowingContentWidgetsDomNode=document.createElement("div"),this.overflowingContentWidgetsDomNode.className=n.ClassNames.OVERFLOWING_CONTENT_WIDGETS}return __extends(e,t),e.prototype.dispose=function(){t.prototype.dispose.call(this),this._widgets=null,this.domNode=null},e.prototype.onModelFlushed=function(){return!0},e.prototype.onModelDecorationsChanged=function(t){return t.inlineDecorationsChanged},e.prototype.onModelLinesDeleted=function(t){return!0},e.prototype.onModelLineChanged=function(t){return!0},e.prototype.onModelLinesInserted=function(t){return!0},e.prototype.onCursorPositionChanged=function(t){return!1},e.prototype.onCursorSelectionChanged=function(t){return!1},e.prototype.onCursorRevealRange=function(t){return!1},e.prototype.onConfigurationChanged=function(t){return t.lineHeight&&(this._lineHeight=this._context.configuration.editor.lineHeight),!0},e.prototype.onLayoutChanged=function(t){if(this._contentLeft=t.contentLeft,this._contentWidth!==t.contentWidth){this._contentWidth=t.contentWidth;for(var e=Object.keys(this._widgets),o=0,n=e.length;o<n;o++){var r=e[o];i.StyleMutator.setMaxWidth(this._widgets[r].widget.getDomNode(),this._contentWidth)}}return!0},e.prototype.onScrollChanged=function(t){return!0},e.prototype.onZonesChanged=function(){return!0},e.prototype.addWidget=function(t){var e={allowEditorOverflow:t.allowEditorOverflow||!1,widget:t,position:null,preference:null,isVisible:!1};this._widgets[t.getId()]=e;var o=t.getDomNode();o.style.position="absolute",i.StyleMutator.setMaxWidth(o,this._contentWidth),i.StyleMutator.setVisibility(o,"hidden"),o.setAttribute("widgetId",t.getId()),e.allowEditorOverflow?this.overflowingContentWidgetsDomNode.appendChild(o):this.domNode.appendChild(o),this.setShouldRender()},e.prototype.setWidgetPosition=function(t,e,o){var i=this._widgets[t.getId()];i.position=e,i.preference=o,this.setShouldRender()},e.prototype.removeWidget=function(t){var e=t.getId();if(this._widgets.hasOwnProperty(e)){var o=this._widgets[e];delete this._widgets[e];var i=o.widget.getDomNode();i.parentNode.removeChild(i),i.removeAttribute("monaco-visible-content-widget"),this.setShouldRender()}},e.prototype._layoutBoxInViewport=function(t,e,o){var i=o.visibleRangeForPosition(t);if(!i)return null;var n=e.clientWidth,r=e.clientHeight,s=i.top,d=s,l=i.top+this._lineHeight,a=o.viewportHeight-l,p=s-r,h=d>=r,u=l,c=a>=r,f=i.left;return f+n>o.viewportLeft+o.viewportWidth&&(f=o.viewportLeft+o.viewportWidth-n),f<o.viewportLeft&&(f=o.viewportLeft),{aboveTop:p,fitsAbove:h,belowTop:u,fitsBelow:c,left:f}},e.prototype._layoutBoxInPage=function(t,e,i){var n=i.visibleRangeForPosition(t);if(!n)return null;var r=n.left-i.viewportLeft,s=e.clientWidth,d=e.clientHeight;if(r+s<0||r>this._contentWidth)return null;var l=n.top-d,a=n.top+this._lineHeight,p=r+this._contentLeft,h=o.getDomNodePagePosition(this._viewDomNode),u=h.top+l-o.StandardWindow.scrollY,c=h.top+a-o.StandardWindow.scrollY,f=h.left+p-o.StandardWindow.scrollX,g=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,w=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,v=22,_=u>=0,y=c+d<=w-v;if(f+s+20>g){var m=f-(g-s-20);f-=m,p-=m}if(f<0){var m=f;f-=m,p-=m}return{aboveTop:l,fitsAbove:_,belowTop:a,fitsBelow:y,left:p}},e.prototype._prepareRenderWidgetAtExactPosition=function(t,e){var o=e.visibleRangeForPosition(t);return o?{top:o.top,left:o.left}:null},e.prototype._prepareRenderWidget=function(t,e){var o=this;if(!t.position||!t.preference)return null;var i=this._context.model.validateModelPosition(t.position);if(!this._context.model.modelPositionIsVisible(i))return null;for(var r=this._context.model.convertModelPositionToViewPosition(i.lineNumber,i.column),s=null,d=function(){if(!s){var i=t.widget.getDomNode();s=t.allowEditorOverflow?o._layoutBoxInPage(r,i,e):o._layoutBoxInViewport(r,i,e)}},l=1;l<=2;l++)for(var a=0;a<t.preference.length;a++){var p=t.preference[a];if(p===n.ContentWidgetPositionPreference.ABOVE){if(d(),!s)return null;if(2===l||s.fitsAbove)return{top:s.aboveTop,left:s.left}}else{if(p!==n.ContentWidgetPositionPreference.BELOW)return this._prepareRenderWidgetAtExactPosition(r,e);if(d(),!s)return null;if(2===l||s.fitsBelow)return{top:s.belowTop,left:s.left}}}},e.prototype.prepareRender=function(t){if(!this.shouldRender())throw new Error("I did not ask to render!");for(var e={},o=Object.keys(this._widgets),i=0,n=o.length;i<n;i++){var r=o[i],s=this._prepareRenderWidget(this._widgets[r],t);s&&(e[r]=s)}this._renderData=e},e.prototype.render=function(t){for(var e=this._renderData,o=Object.keys(this._widgets),n=0,r=o.length;n<r;n++){var s=o[n],d=this._widgets[s],l=this._widgets[s].widget.getDomNode();e.hasOwnProperty(s)?(d.allowEditorOverflow?(i.StyleMutator.setTop(l,e[s].top),i.StyleMutator.setLeft(l,e[s].left)):(i.StyleMutator.setTop(l,e[s].top+t.viewportTop-t.bigNumbersDelta),i.StyleMutator.setLeft(l,e[s].left)),d.isVisible||(i.StyleMutator.setVisibility(l,"inherit"),l.setAttribute("monaco-visible-content-widget","true"),d.isVisible=!0)):d.isVisible&&(l.removeAttribute("monaco-visible-content-widget"),d.isVisible=!1,i.StyleMutator.setVisibility(l,"hidden"))}},e}(r.ViewPart);e.ViewContentWidgets=s});