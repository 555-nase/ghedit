define(["require","exports","vs/editor/common/core/position","vs/editor/common/core/range","vs/editor/common/editorCommon","vs/editor/browser/editorBrowser","vs/base/browser/dom"],function(e,t,r,o,i,n,s){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var a=function(){function e(e,t,r,i,n,s){void 0===r&&(r=0),void 0===i&&(i=null),void 0===n&&(n=null),void 0===s&&(s=null),this.element=e,this.type=t,this.mouseColumn=r,this.position=i,!n&&i&&(n=new o.Range(i.lineNumber,i.column,i.lineNumber,i.column)),this.range=n,this.detail=s}return e.prototype._typeToString=function(){return this.type===i.MouseTargetType.TEXTAREA?"TEXTAREA":this.type===i.MouseTargetType.GUTTER_GLYPH_MARGIN?"GUTTER_GLYPH_MARGIN":this.type===i.MouseTargetType.GUTTER_LINE_NUMBERS?"GUTTER_LINE_NUMBERS":this.type===i.MouseTargetType.GUTTER_LINE_DECORATIONS?"GUTTER_LINE_DECORATIONS":this.type===i.MouseTargetType.GUTTER_VIEW_ZONE?"GUTTER_VIEW_ZONE":this.type===i.MouseTargetType.CONTENT_TEXT?"CONTENT_TEXT":this.type===i.MouseTargetType.CONTENT_EMPTY?"CONTENT_EMPTY":this.type===i.MouseTargetType.CONTENT_VIEW_ZONE?"CONTENT_VIEW_ZONE":this.type===i.MouseTargetType.CONTENT_WIDGET?"CONTENT_WIDGET":this.type===i.MouseTargetType.OVERVIEW_RULER?"OVERVIEW_RULER":this.type===i.MouseTargetType.SCROLLBAR?"SCROLLBAR":this.type===i.MouseTargetType.OVERLAY_WIDGET?"OVERLAY_WIDGET":"UNKNOWN"},e.prototype.toString=function(){return this._typeToString()+": "+this.position+" - "+this.range+" - "+this.detail},e}(),u=function(){function e(e){return"[^/]*"+e+"[^/]*"}function t(){return"[^/]+"}function r(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];var r=!1;return"$"===e[e.length-1]&&(r=!0,e.pop()),new RegExp(o+e.join("\\/")+(r?"$":""))}var o="^"+n.ClassNames.OVERFLOW_GUARD+"\\/";return{IS_TEXTAREA_COVER:r(e(n.ClassNames.TEXTAREA_COVER),"$"),IS_TEXTAREA:r(n.ClassNames.TEXTAREA,"$"),IS_VIEW_LINES:r(t(),t(),n.ClassNames.VIEW_LINES,"$"),IS_CURSORS_LAYER:r(t(),t(),e(n.ClassNames.VIEW_CURSORS_LAYER),"$"),IS_CHILD_OF_VIEW_LINES:r(t(),t(),n.ClassNames.VIEW_LINES),IS_CHILD_OF_SCROLLABLE_ELEMENT:r(e(n.ClassNames.SCROLLABLE_ELEMENT)),IS_CHILD_OF_CONTENT_WIDGETS:r(t(),t(),n.ClassNames.CONTENT_WIDGETS),IS_CHILD_OF_OVERFLOWING_CONTENT_WIDGETS:new RegExp("^"+n.ClassNames.OVERFLOWING_CONTENT_WIDGETS+"\\/"),IS_CHILD_OF_OVERLAY_WIDGETS:r(n.ClassNames.OVERLAY_WIDGETS),IS_CHILD_OF_VIEW_OVERLAYS:r(n.ClassNames.MARGIN_VIEW_OVERLAYS),IS_CHILD_OF_VIEW_ZONES:r(t(),t(),n.ClassNames.VIEW_ZONES)}}(),T=function(){function e(e,t){this._context=e,this._viewHelper=t}return e.prototype.getClassNamePathTo=function(e,t){for(var r,o=[];e&&e!==document.body&&e!==t;)e.nodeType===e.ELEMENT_NODE&&(r=e.className,r&&o.unshift(r)),e=e.parentNode;return o.join("/")},e.prototype.mouseTargetIsWidget=function(e){var t=e.target,r=this.getClassNamePathTo(t,this._viewHelper.viewDomNode);return!(!u.IS_CHILD_OF_CONTENT_WIDGETS.test(r)&&!u.IS_CHILD_OF_OVERFLOWING_CONTENT_WIDGETS.test(r))||!!u.IS_CHILD_OF_OVERLAY_WIDGETS.test(r)},e.prototype.createMouseTarget=function(e,t,r){try{var o=this._unsafeCreateMouseTarget(e,t,r);return o}catch(t){return this.createMouseTargetFromUnknownTarget(t.target)}},e.prototype._unsafeCreateMouseTarget=function(e,t,r){var o=Math.max(0,this._viewHelper.getScrollTop()+(t.posy-t.editorPos.top)),n=this._viewHelper.getScrollLeft()+(t.posx-t.editorPos.left)-e.contentLeft,s=this._getMouseColumn(n),T=t.target,l=this.getClassNamePathTo(T,this._viewHelper.viewDomNode);if(u.IS_CHILD_OF_CONTENT_WIDGETS.test(l)||u.IS_CHILD_OF_OVERFLOWING_CONTENT_WIDGETS.test(l))return this.createMouseTargetFromContentWidgetsChild(T,s);if(u.IS_CHILD_OF_OVERLAY_WIDGETS.test(l))return this.createMouseTargetFromOverlayWidgetsChild(T,s);var _=T.hasAttribute&&T.hasAttribute("lineNumber")?T.getAttribute("lineNumber"):null,p=T.hasAttribute&&T.hasAttribute("column")?T.getAttribute("column"):null;if(_&&p)return this.createMouseTargetFromViewCursor(T,parseInt(_,10),parseInt(p,10),s);if(u.IS_TEXTAREA_COVER.test(l))return this._context.configuration.editor.viewInfo.glyphMargin?this.createMouseTargetFromGlyphMargin(T,o,s):this._context.configuration.editor.viewInfo.lineNumbers?this.createMouseTargetFromLineNumbers(T,o,s):this.createMouseTargetFromLinesDecorationsChild(T,o,s);if(u.IS_TEXTAREA.test(l))return new a(T,i.MouseTargetType.TEXTAREA);if(u.IS_CHILD_OF_VIEW_ZONES.test(l)){var E=this._getZoneAtCoord(o);return E?new a(T,i.MouseTargetType.CONTENT_VIEW_ZONE,s,E.position,null,E):this.createMouseTargetFromUnknownTarget(T)}if(u.IS_VIEW_LINES.test(l)){if(this._viewHelper.isAfterLines(o))return this.createMouseTargetFromViewLines(T,o,s);var E=this._getZoneAtCoord(o);if(E)return new a(T,i.MouseTargetType.CONTENT_VIEW_ZONE,s,E.position,null,E);var g=this._doHitTest(t,o);return g.position?this.createMouseTargetFromHitTestPosition(T,g.position.lineNumber,g.position.column,n,s):this.createMouseTargetFromViewLines(T,o,s)}if(!r||u.IS_CHILD_OF_VIEW_LINES.test(l)){var g=this._doHitTest(t,o);if(g.position)return this.createMouseTargetFromHitTestPosition(T,g.position.lineNumber,g.position.column,n,s);if(g.hitTarget){T=g.hitTarget,l=this.getClassNamePathTo(T,this._viewHelper.viewDomNode);var N=T.hasAttribute&&T.hasAttribute("lineNumber")?T.getAttribute("lineNumber"):null,h=T.hasAttribute&&T.hasAttribute("column")?T.getAttribute("column"):null;if(N&&h)return this.createMouseTargetFromViewCursor(T,parseInt(N,10),parseInt(h,10),s)}}if(u.IS_CURSORS_LAYER.test(l))return new a(T,i.MouseTargetType.UNKNOWN);if(u.IS_CHILD_OF_SCROLLABLE_ELEMENT.test(l))return this.createMouseTargetFromScrollbar(T,o,s);if(u.IS_CHILD_OF_VIEW_OVERLAYS.test(l)){var m=Math.abs(t.posx-t.editorPos.left);return m<=e.glyphMarginWidth?this.createMouseTargetFromGlyphMargin(T,o,s):(m-=e.glyphMarginWidth,m<=e.lineNumbersWidth?this.createMouseTargetFromLineNumbers(T,o,s):(m-=e.lineNumbersWidth,this.createMouseTargetFromLinesDecorationsChild(T,o,s)))}return/OverviewRuler/i.test(l)?this.createMouseTargetFromScrollbar(T,o,s):this.createMouseTargetFromUnknownTarget(T)},e.prototype._isChild=function(e,t,r){for(;e&&e!==document.body;){if(e===t)return!0;if(e===r)return!1;e=e.parentNode}return!1},e.prototype._findAttribute=function(e,t,r){for(;e&&e!==document.body;){if(e.hasAttribute&&e.hasAttribute(t))return e.getAttribute(t);if(e===r)return null;e=e.parentNode}return null},e.prototype._doHitTestWithCaretRangeFromPoint=function(e,t){var r=this._viewHelper.getLineNumberAtVerticalOffset(t),o=this._viewHelper.getVerticalOffsetForLineNumber(r),i=o+Math.floor(this._context.configuration.editor.lineHeight/2),n=e.posy+(i-t);n<=e.editorPos.top&&(n=e.editorPos.top+1),n>=e.editorPos.top+this._context.configuration.editor.layoutInfo.height&&(n=e.editorPos.top+this._context.configuration.editor.layoutInfo.height-1);var a=this._actualDoHitTestWithCaretRangeFromPoint(e.viewportx,n-s.StandardWindow.scrollY);return a.position?a:this._actualDoHitTestWithCaretRangeFromPoint(e.viewportx,e.viewporty)},e.prototype._actualDoHitTestWithCaretRangeFromPoint=function(e,t){var r=document.caretRangeFromPoint(e,t);if(!r||!r.startContainer)return{position:null,hitTarget:null};var o,i=r.startContainer;if(i.nodeType===i.TEXT_NODE){var s=i.parentNode,a=s?s.parentNode:null,u=a?a.parentNode:null,T=u&&u.nodeType===u.ELEMENT_NODE?u.className:null;if(T===n.ClassNames.VIEW_LINE)return{position:this._viewHelper.getPositionFromDOMInfo(s,r.startOffset),hitTarget:null};o=i.parentNode}else if(i.nodeType===i.ELEMENT_NODE){var s=i.parentNode,a=s?s.parentNode:null,l=a&&a.nodeType===a.ELEMENT_NODE?a.className:null;if(l===n.ClassNames.VIEW_LINE)return{position:this._viewHelper.getPositionFromDOMInfo(i,i.textContent.length),hitTarget:null};o=i}return{position:null,hitTarget:o}},e.prototype._doHitTestWithCaretPositionFromPoint=function(e){var t=document.caretPositionFromPoint(e.viewportx,e.viewporty),r=document.createRange();r.setStart(t.offsetNode,t.offset),r.collapse(!0);var o=this._viewHelper.getPositionFromDOMInfo(r.startContainer.parentNode,r.startOffset);return r.detach(),{position:o,hitTarget:null}},e.prototype._doHitTestWithMoveToPoint=function(e){var t=null,r=null,o=document.body.createTextRange();try{o.moveToPoint(e.viewportx,e.viewporty)}catch(i){return{position:null,hitTarget:null}}o.collapse(!0);var s=o?o.parentElement():null,a=s?s.parentNode:null,u=a?a.parentNode:null,T=u&&u.nodeType===u.ELEMENT_NODE?u.className:"";if(T===n.ClassNames.VIEW_LINE){var l=o.duplicate();l.moveToElementText(s),l.setEndPoint("EndToStart",o),t=this._viewHelper.getPositionFromDOMInfo(s,l.text.length),l.moveToElementText(this._viewHelper.viewDomNode)}else r=s;return o.moveToElementText(this._viewHelper.viewDomNode),{position:t,hitTarget:r}},e.prototype._doHitTest=function(e,t){return document.caretRangeFromPoint?this._doHitTestWithCaretRangeFromPoint(e,t):document.caretPositionFromPoint?this._doHitTestWithCaretPositionFromPoint(e):document.body.createTextRange?this._doHitTestWithMoveToPoint(e):{position:null,hitTarget:null}},e.prototype._getZoneAtCoord=function(e){var t=this._viewHelper.getWhitespaceAtVerticalOffset(e);if(t){var o=t.verticalOffset+t.height/2,i=this._context.model.getLineCount(),n=null,s=void 0,a=null;return t.afterLineNumber!==i&&(a=new r.Position(t.afterLineNumber+1,1)),t.afterLineNumber>0&&(n=new r.Position(t.afterLineNumber,this._context.model.getLineMaxColumn(t.afterLineNumber))),s=null===a?n:null===n?a:e<o?n:a,{viewZoneId:t.id,afterLineNumber:t.afterLineNumber,positionBefore:n,positionAfter:a,position:s}}return null},e.prototype._getFullLineRangeAtCoord=function(e){if(this._viewHelper.isAfterLines(e)){var t=this._context.model.getLineCount(),r=this._context.model.getLineMaxColumn(t);return{range:new o.Range(t,r,t,r),isAfterLines:!0}}var i=this._viewHelper.getLineNumberAtVerticalOffset(e),n=this._context.model.getLineMaxColumn(i);return{range:new o.Range(i,1,i,n),isAfterLines:!1}},e.prototype.getMouseColumn=function(e,t){var r=this._viewHelper.getScrollLeft()+(t.posx-t.editorPos.left)-e.contentLeft;return this._getMouseColumn(r)},e.prototype._getMouseColumn=function(e){if(e<0)return 1;var t=this._context.configuration.editor.fontInfo.typicalHalfwidthCharacterWidth,r=Math.round(e/t);return r+1},e.prototype.createMouseTargetFromViewCursor=function(e,t,o,n){return new a(e,i.MouseTargetType.CONTENT_TEXT,n,new r.Position(t,o))},e.prototype.createMouseTargetFromViewLines=function(e,t,o){var n=this._context.model.getLineCount(),s=this._context.model.getLineMaxColumn(n);return new a(e,i.MouseTargetType.CONTENT_EMPTY,o,new r.Position(n,s))},e.prototype.createMouseTargetFromHitTestPosition=function(e,t,n,s,u){var T=new r.Position(t,n),l=this._viewHelper.getLineWidth(t);if(s>l)return new a(e,i.MouseTargetType.CONTENT_EMPTY,u,T);var _=this._viewHelper.visibleRangeForPosition2(t,n);if(!_)return new a(e,i.MouseTargetType.UNKNOWN,u,T);var p=_.left;if(s===p)return new a(e,i.MouseTargetType.CONTENT_TEXT,u,T);var E;if(n>1){var g=_.left;if(E=!1,E=E||g<s&&s<p,E=E||p<s&&s<g){var N=new o.Range(t,n,t,n-1);return new a(e,i.MouseTargetType.CONTENT_TEXT,u,T,N)}}var h=this._context.model.getLineMaxColumn(t);if(n<h){var m=this._viewHelper.visibleRangeForPosition2(t,n+1);if(m){var c=m.left;if(E=!1,E=E||p<s&&s<c,E=E||c<s&&s<p){var N=new o.Range(t,n,t,n+1);return new a(e,i.MouseTargetType.CONTENT_TEXT,u,T,N)}}}return new a(e,i.MouseTargetType.CONTENT_TEXT,u,T)},e.prototype.createMouseTargetFromContentWidgetsChild=function(e,t){var r=this._findAttribute(e,"widgetId",this._viewHelper.viewDomNode);return r?new a(e,i.MouseTargetType.CONTENT_WIDGET,t,null,null,r):new a(e,i.MouseTargetType.UNKNOWN)},e.prototype.createMouseTargetFromOverlayWidgetsChild=function(e,t){var r=this._findAttribute(e,"widgetId",this._viewHelper.viewDomNode);return r?new a(e,i.MouseTargetType.OVERLAY_WIDGET,t,null,null,r):new a(e,i.MouseTargetType.UNKNOWN)},e.prototype.createMouseTargetFromLinesDecorationsChild=function(e,t,o){var n=this._getZoneAtCoord(t);if(n)return new a(e,i.MouseTargetType.GUTTER_VIEW_ZONE,o,n.position,null,n);var s=this._getFullLineRangeAtCoord(t);return new a(e,i.MouseTargetType.GUTTER_LINE_DECORATIONS,o,new r.Position(s.range.startLineNumber,s.range.startColumn),s.range,s.isAfterLines)},e.prototype.createMouseTargetFromLineNumbers=function(e,t,o){var n=this._getZoneAtCoord(t);if(n)return new a(e,i.MouseTargetType.GUTTER_VIEW_ZONE,o,n.position,null,n);var s=this._getFullLineRangeAtCoord(t);return new a(e,i.MouseTargetType.GUTTER_LINE_NUMBERS,o,new r.Position(s.range.startLineNumber,s.range.startColumn),s.range,s.isAfterLines)},e.prototype.createMouseTargetFromGlyphMargin=function(e,t,o){var n=this._getZoneAtCoord(t);if(n)return new a(e,i.MouseTargetType.GUTTER_VIEW_ZONE,o,n.position,null,n);var s=this._getFullLineRangeAtCoord(t);return new a(e,i.MouseTargetType.GUTTER_GLYPH_MARGIN,o,new r.Position(s.range.startLineNumber,s.range.startColumn),s.range,s.isAfterLines)},e.prototype.createMouseTargetFromScrollbar=function(e,t,o){var n=this._viewHelper.getLineNumberAtVerticalOffset(t),s=this._context.model.getLineMaxColumn(n);return new a(e,i.MouseTargetType.SCROLLBAR,o,new r.Position(n,s))},e.prototype.createMouseTargetFromUnknownTarget=function(e){var t=this._isChild(e,this._viewHelper.viewDomNode,this._viewHelper.viewDomNode),r=null;return t&&(r=this._findAttribute(e,"widgetId",this._viewHelper.viewDomNode)),r?new a(e,i.MouseTargetType.OVERLAY_WIDGET,null,null,r):new a(e,i.MouseTargetType.UNKNOWN)},e}();t.MouseTargetFactory=T});