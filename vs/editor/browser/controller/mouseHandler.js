var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)};define(["require","exports","vs/base/common/lifecycle","vs/base/common/platform","vs/base/browser/browser","vs/base/browser/dom","vs/editor/common/core/position","vs/editor/common/core/selection","vs/editor/common/editorCommon","vs/editor/common/viewModel/viewEventHandler","vs/editor/browser/controller/mouseTarget","vs/base/common/async","vs/editor/browser/editorDom","vs/base/browser/mouseEvent","vs/editor/common/config/commonEditorConfig"],function(e,t,o,i,s,n,r,u,a,l,h,p,_,c,m){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";function v(e){return function(t,o){var i=!1;return e&&(i=e.mouseTargetIsWidget(o)),i||o.preventDefault(),o}}var f=function(e){function t(t,o){var i=this;e.call(this),this._destination=t,this._condition=o,this._retryTimer=this._register(new p.TimeoutTimer),this.handler=function(e){return i._handle(e)}}return __extends(t,e),t.prototype.dispose=function(){this._retryValue=null,e.prototype.dispose.call(this)},t.prototype._handle=function(e){var t=this;this._condition()?(this._retryTimer.cancel(),this._retryValue=null,this._destination(e)):(this._retryValue=e,this._retryTimer.setIfNotSet(function(){var e=t._retryValue;t._retryValue=null,t._handle(e)},10))},t}(o.Disposable),M=function(){function e(e,t){this.position=e,this.mouseColumn=t}return e}(),y=function(e){function t(o,i,s){var r=this;e.call(this),this._context=o,this.viewController=i,this.viewHelper=s,this.mouseTargetFactory=new h.MouseTargetFactory(this._context,s),this.listenersToRemove=[],this._mouseDownOperation=new d(this._context,this.viewController,this.viewHelper,function(e,t){return r._createMouseTarget(e,t)},function(e){return r._getMouseColumn(e)}),this.toDispose=[],this.lastMouseLeaveTime=-1;var u=new _.EditorMouseEventFactory(this.viewHelper.viewDomNode);this.listenersToRemove.push(u.onContextMenu(this.viewHelper.viewDomNode,function(e){return r._onContextMenu(e,!0)})),this._mouseMoveEventHandler=new f(function(e){return r._onMouseMove(e)},function(){return!r.viewHelper.isDirty()}),this.toDispose.push(this._mouseMoveEventHandler),this.listenersToRemove.push(u.onMouseMoveThrottled(this.viewHelper.viewDomNode,this._mouseMoveEventHandler.handler,v(this.mouseTargetFactory),t.MOUSE_MOVE_MINIMUM_TIME)),this.listenersToRemove.push(u.onMouseUp(this.viewHelper.viewDomNode,function(e){return r._onMouseUp(e)})),this.listenersToRemove.push(u.onMouseLeave(this.viewHelper.viewDomNode,function(e){return r._onMouseLeave(e)})),this.listenersToRemove.push(u.onMouseDown(this.viewHelper.viewDomNode,function(e){return r._onMouseDown(e)}));var a=function(e){if(r._context.configuration.editor.viewInfo.mouseWheelZoom){var t=new c.StandardMouseWheelEvent(e);if(t.browserEvent.ctrlKey){var o=m.EditorZoom.getZoomLevel(),i=t.deltaY>0?1:-1;m.EditorZoom.setZoomLevel(o+i),t.preventDefault(),t.stopPropagation()}}};this.listenersToRemove.push(n.addDisposableListener(this.viewHelper.viewDomNode,"mousewheel",a,!0)),this.listenersToRemove.push(n.addDisposableListener(this.viewHelper.viewDomNode,"DOMMouseScroll",a,!0)),this._context.addEventHandler(this)}return __extends(t,e),t.prototype.dispose=function(){this._context.removeEventHandler(this),this.listenersToRemove=o.dispose(this.listenersToRemove),this.toDispose=o.dispose(this.toDispose),this._mouseDownOperation.dispose()},t.prototype.onLayoutChanged=function(e){return this._layoutInfo=e,!1},t.prototype.onScrollChanged=function(e){return this._mouseDownOperation.onScrollChanged(),!1},t.prototype.onCursorSelectionChanged=function(e){return this._mouseDownOperation.onCursorSelectionChanged(e),!1},t.prototype._createMouseTarget=function(e,t){return this.mouseTargetFactory.createMouseTarget(this._layoutInfo,e,t)},t.prototype._getMouseColumn=function(e){return this.mouseTargetFactory.getMouseColumn(this._layoutInfo,e)},t.prototype._onContextMenu=function(e,t){this.viewController.emitContextMenu({event:e,target:this._createMouseTarget(e,t)})},t.prototype._onMouseMove=function(e){if(!this._mouseDownOperation.isActive()){var t=e.timestamp;t<this.lastMouseLeaveTime||this.viewController.emitMouseMove({event:e,target:this._createMouseTarget(e,!0)})}},t.prototype._onMouseLeave=function(e){this.lastMouseLeaveTime=(new Date).getTime(),this.viewController.emitMouseLeave({event:e,target:null})},t.prototype._onMouseUp=function(e){this.viewController.emitMouseUp({event:e,target:this._createMouseTarget(e,!0)})},t.prototype._onMouseDown=function(e){var t=this,o=this._createMouseTarget(e,!0),n=o.type===a.MouseTargetType.CONTENT_TEXT||o.type===a.MouseTargetType.CONTENT_EMPTY,r=o.type===a.MouseTargetType.GUTTER_GLYPH_MARGIN||o.type===a.MouseTargetType.GUTTER_LINE_NUMBERS||o.type===a.MouseTargetType.GUTTER_LINE_DECORATIONS,u=o.type===a.MouseTargetType.GUTTER_LINE_NUMBERS,l=this._context.configuration.editor.viewInfo.selectOnLineNumbers,h=o.type===a.MouseTargetType.CONTENT_VIEW_ZONE||o.type===a.MouseTargetType.GUTTER_VIEW_ZONE,p=e.leftButton;if(i.isMacintosh&&e.ctrlKey&&(p=!1),p&&(n||u&&l))s.isIE11orEarlier?e.browserEvent.fromElement?(e.preventDefault(),this.viewHelper.focusTextArea()):setTimeout(function(){t.viewHelper.focusTextArea()}):(e.preventDefault(),this.viewHelper.focusTextArea()),this._mouseDownOperation.start(o.type,e);else if(r)e.preventDefault();else if(h){var _=o.detail;this.viewHelper.shouldSuppressMouseDownOnViewZone(_.viewZoneId)&&e.preventDefault()}this.viewController.emitMouseDown({event:e,target:o})},t.MOUSE_MOVE_MINIMUM_TIME=100,t}(l.ViewEventHandler);t.MouseHandler=y;var d=function(e){function t(t,o,i,s,n){var r=this;e.call(this),this._context=t,this._viewController=o,this._viewHelper=i,this._createMouseTarget=s,this._getMouseColumn=n,this._currentSelection=new u.Selection(1,1,1,1),this._mouseState=new w,this._onScrollTimeout=this._register(new p.TimeoutTimer),this._isActive=!1,this._lastMouseEvent=null,this._mouseMoveMonitor=this._register(new _.GlobalEditorMouseMoveMonitor(this._viewHelper.viewDomNode)),this._mouseDownThenMoveEventHandler=this._register(new f(function(e){return r._onMouseDownThenMove(e)},function(){return!r._viewHelper.isDirty()}))}return __extends(t,e),t.prototype.dispose=function(){e.prototype.dispose.call(this)},t.prototype.isActive=function(){return this._isActive},t.prototype._onMouseDownThenMove=function(e){this._lastMouseEvent=e,this._mouseState.setModifiers(e);var t=this._findMousePosition(e,!0);t&&this._dispatchMouse(t,!0)},t.prototype.start=function(e,t){var o=this;this._lastMouseEvent=t,this._mouseState.setStartedOnLineNumbers(e===a.MouseTargetType.GUTTER_LINE_NUMBERS),this._mouseState.setModifiers(t);var i=this._findMousePosition(t,!0);i&&(this._mouseState.trySetCount(t.detail,i.position),t.detail=this._mouseState.count,this._dispatchMouse(i,t.shiftKey),this._isActive||(this._isActive=!0,this._mouseMoveMonitor.startMonitoring(v(null),this._mouseDownThenMoveEventHandler.handler,function(){return o._stop()})))},t.prototype._stop=function(){this._isActive=!1,this._onScrollTimeout.cancel()},t.prototype.onScrollChanged=function(){var e=this;this._isActive&&this._onScrollTimeout.setIfNotSet(function(){var t=e._findMousePosition(e._lastMouseEvent,!1);t&&e._dispatchMouse(t,!0)},10)},t.prototype.onCursorSelectionChanged=function(e){this._currentSelection=e.selection},t.prototype._getPositionOutsideEditor=function(e){var t=e.editorPos,o=this._getMouseColumn(e);if(e.posy<t.top){var i=this._viewHelper.getLineNumberAtVerticalOffset(Math.max(this._viewHelper.getScrollTop()-(t.top-e.posy),0));return new M(new r.Position(i,1),o)}if(e.posy>t.top+t.height){var s=this._viewHelper.getLineNumberAtVerticalOffset(this._viewHelper.getScrollTop()+(e.posy-t.top));return new M(new r.Position(s,this._context.model.getLineMaxColumn(s)),o)}var n=this._viewHelper.getLineNumberAtVerticalOffset(this._viewHelper.getScrollTop()+(e.posy-t.top));return e.posx<t.left?new M(new r.Position(n,1),o):e.posx>t.left+t.width?new M(new r.Position(n,this._context.model.getLineMaxColumn(n)),o):null},t.prototype._findMousePosition=function(e,t){var o=this._getPositionOutsideEditor(e);if(o)return o;var i=this._createMouseTarget(e,t),s=i.position;if(!s)return null;if(i.type===a.MouseTargetType.CONTENT_VIEW_ZONE||i.type===a.MouseTargetType.GUTTER_VIEW_ZONE){var n=new r.Position(this._currentSelection.selectionStartLineNumber,this._currentSelection.selectionStartColumn),u=i.detail,l=u.positionBefore,h=u.positionAfter;if(l&&h)return l.isBefore(n)?new M(l,i.mouseColumn):new M(h,i.mouseColumn)}return new M(s,i.mouseColumn)},t.prototype._dispatchMouse=function(e,t){this._viewController.dispatchMouse({position:e.position,mouseColumn:e.mouseColumn,startedOnLineNumbers:this._mouseState.startedOnLineNumbers,inSelectionMode:t,mouseDownCount:this._mouseState.count,altKey:this._mouseState.altKey,ctrlKey:this._mouseState.ctrlKey,metaKey:this._mouseState.metaKey,shiftKey:this._mouseState.shiftKey})},t}(o.Disposable),w=function(){function e(){this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._startedOnLineNumbers=!1,this._lastMouseDownPosition=null,this._lastMouseDownPositionEqualCount=0,this._lastMouseDownCount=0,this._lastSetMouseDownCountTime=0}return Object.defineProperty(e.prototype,"altKey",{get:function(){return this._altKey},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ctrlKey",{get:function(){return this._ctrlKey},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"metaKey",{get:function(){return this._metaKey},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"shiftKey",{get:function(){return this._shiftKey},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"startedOnLineNumbers",{get:function(){return this._startedOnLineNumbers},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"count",{get:function(){return this._lastMouseDownCount},enumerable:!0,configurable:!0}),e.prototype.setModifiers=function(e){this._altKey=e.altKey,this._ctrlKey=e.ctrlKey,this._metaKey=e.metaKey,this._shiftKey=e.shiftKey},e.prototype.setStartedOnLineNumbers=function(e){this._startedOnLineNumbers=e},e.prototype.trySetCount=function(t,o){var i=(new Date).getTime();i-this._lastSetMouseDownCountTime>e.CLEAR_MOUSE_DOWN_COUNT_TIME&&(t=1),this._lastSetMouseDownCountTime=i,t>this._lastMouseDownCount+1&&(t=this._lastMouseDownCount+1),this._lastMouseDownPosition&&this._lastMouseDownPosition.equals(o)?this._lastMouseDownPositionEqualCount++:this._lastMouseDownPositionEqualCount=1,this._lastMouseDownPosition=o,this._lastMouseDownCount=Math.min(t,this._lastMouseDownPositionEqualCount)},e.CLEAR_MOUSE_DOWN_COUNT_TIME=400,e}()});