/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)},__decorate=this&&this.__decorate||function(e,t,i,o){var n,s=arguments.length,r=s<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,o);else for(var d=e.length-1;d>=0;d--)(n=e[d])&&(r=(s<3?n(r):s>3?n(t,i,r):n(t,i))||r);return s>3&&r&&Object.defineProperty(t,i,r),r},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}};define(["require","exports","vs/nls","vs/base/common/async","vs/base/common/keyCodes","vs/base/common/lifecycle","vs/base/common/winjs.base","vs/base/browser/dom","vs/base/browser/htmlContentRenderer","vs/base/browser/keyboardEvent","vs/base/browser/styleMutator","vs/platform/keybinding/common/keybindingResolver","vs/platform/keybinding/common/keybinding","vs/editor/common/core/range","vs/editor/common/editorAction","vs/editor/common/editorActionEnablement","vs/editor/common/editorCommon","vs/editor/common/editorCommonExtensions","vs/editor/browser/editorBrowser","vs/editor/browser/editorBrowserExtensions","vs/editor/contrib/snippet/common/snippet","vs/editor/contrib/defineKeybinding/common/smartSnippetInserter","vs/css!./defineKeybinding"],function(e,t,i,o,n,s,r,d,a,u,c,h,p,l,_,g,y,b,m,f,v,D){"use strict";function N(e){if(e.getConfiguration().readOnly)return!1;var t=e.getModel();if(!t)return!1;var i=t.uri.toString();return I.test(i)}var K=i.localize("defineKeybinding.start","Define Keybinding"),C=i.localize("defineKeybinding.initial","Press desired key combination and ENTER"),w=i.localize("DefineKeybindingAction","Define Keybinding"),k=i.localize("defineKeybinding.kbLayoutInfoMessage","For your current keyboard layout press "),E=i.localize("defineKeybinding.kbLayoutErrorMessage","You won't be able to produce this key combination under your current keyboard layout."),I=/keybindings\.json$/,S=function(){function e(e,t){var i=this;this._dec=[],this._editor=e,this._keybindingService=t,this._toDispose=[],this._launchWidget=new W(this._editor,t,function(){return i.launch()}),this._defineWidget=new T(this._editor,t,function(e){return i._onAccepted(e)}),this._toDispose.push(this._editor.onDidChangeConfiguration(function(e){N(i._editor)?i._launchWidget.show():i._launchWidget.hide()})),this._toDispose.push(this._editor.onDidChangeModel(function(e){N(i._editor)?i._launchWidget.show():i._launchWidget.hide(),i._onModel()})),this._updateDecorations=new o.RunOnceScheduler(function(){return i._updateDecorationsNow()},500),this._toDispose.push(this._updateDecorations),this._modelToDispose=[],this._onModel()}return e.get=function(t){return t.getContribution(e.ID)},e.prototype.getId=function(){return e.ID},e.prototype.dispose=function(){this._modelToDispose=s.dispose(this._modelToDispose),this._toDispose=s.dispose(this._toDispose),this._launchWidget.dispose(),this._launchWidget=null,this._defineWidget.dispose(),this._defineWidget=null},e.prototype.launch=function(){N(this._editor)&&this._defineWidget.start()},e.prototype._onAccepted=function(e){var t=["{",'\t"key": "'+e+'",','\t"command": "{{commandId}}",','\t"when": "{{editorTextFocus}}"',"}{{}}"].join("\n"),i=D.SmartSnippetInserter.insertSnippet(this._editor.getModel(),this._editor.getPosition());t=i.prepend+t+i.append,this._editor.setPosition(i.position),v.getSnippetController(this._editor).run(new v.CodeSnippet(t),0,0)},e.prototype._onModel=function(){var e=this;this._modelToDispose=s.dispose(this._modelToDispose);var t=this._editor.getModel();if(t){var i=t.uri.toString();I.test(i)&&(this._modelToDispose.push(t.onDidChangeContent(function(t){return e._updateDecorations.schedule()})),this._modelToDispose.push({dispose:function(){e._dec=e._editor.deltaDecorations(e._dec,[]),e._updateDecorations.cancel()}}),this._updateDecorations.schedule())}},e.prototype._updateDecorationsNow=function(){var e=this,t=this._editor.getModel(),i=n.Keybinding.getUserSettingsKeybindingRegex(),o=t.findMatches(i,!1,!0,!1,!1),s=o.map(function(i){var o=t.getValueInRange(i),s=o.substring(1,o.length-1);s=s.replace(/\\\\/g,"\\");var r=h.IOSupport.readKeybinding(s),d=new n.Keybinding(r);return{strKeybinding:s,keybinding:d,usLabel:d._toUSLabel(),label:e._keybindingService.getLabelFor(d),range:i}});s=s.filter(function(e){return e.usLabel!==e.label});var r=[];s.forEach(function(t){var i,o,n,s;t.label?(i=[k],i=i.concat(e._keybindingService.getLabelFor(t.keybinding)),o="keybindingInfo",n="inlineKeybindingInfo",s="rgba(100, 100, 250, 0.6)"):(i=[E],o="keybindingError",n="inlineKeybindingError",s="rgba(250, 100, 100, 0.6)"),r.push({range:new l.Range(t.range.startLineNumber,t.range.startColumn,t.range.startLineNumber,t.range.startColumn+1),options:{stickiness:y.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,inlineClassName:n}}),r.push({range:t.range,options:{stickiness:y.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,className:o,hoverMessage:i,overviewRuler:{color:s,darkColor:s,position:y.OverviewRulerLane.Right}}})}),this._dec=this._editor.deltaDecorations(this._dec,r)},e.ID="editor.contrib.defineKeybinding",e=__decorate([__param(1,p.IKeybindingService)],e)}();t.DefineKeybindingController=S;var W=function(){function e(e,t,i){this._editor=e,this._domNode=document.createElement("div"),this._domNode.className="defineKeybindingLauncher",this._domNode.style.display="none",this._isVisible=!1;var o=t.lookupKeybindings(M.ID),n="";o.length>0&&(n+=" ("+t.getLabelFor(o[0])+")"),this._domNode.appendChild(document.createTextNode(K+n)),this._toDispose=[],this._toDispose.push(d.addDisposableListener(this._domNode,"click",function(e){i()})),this._editor.addOverlayWidget(this)}return e.prototype.dispose=function(){this._editor.removeOverlayWidget(this),this._toDispose=s.dispose(this._toDispose)},e.prototype.show=function(){this._isVisible||(this._domNode.style.display="block",this._isVisible=!0,this._editor.layoutOverlayWidget(this))},e.prototype.hide=function(){this._isVisible&&(this._domNode.style.display="none",this._isVisible=!1,this._editor.layoutOverlayWidget(this))},e.prototype.getId=function(){return e.ID},e.prototype.getDomNode=function(){return this._domNode},e.prototype.getPosition=function(){return{preference:this._isVisible?m.OverlayWidgetPositionPreference.BOTTOM_RIGHT_CORNER:null}},e.ID="editor.contrib.defineKeybindingLauncherWidget",e}(),T=function(){function e(t,i,o){var s=this;this._editor=t,this._keybindingService=i,this._onAccepted=o,this._toDispose=[],this._lastKeybinding=null,this._domNode=document.createElement("div"),this._domNode.className="defineKeybindingWidget",c.StyleMutator.setWidth(this._domNode,e.WIDTH),c.StyleMutator.setHeight(this._domNode,e.HEIGHT),this._domNode.style.display="none",this._isVisible=!1,this._messageNode=document.createElement("div"),this._messageNode.className="message",this._messageNode.innerText=C,this._domNode.appendChild(this._messageNode),this._inputNode=document.createElement("input"),this._inputNode.className="input",this._inputNode.type="text",this._domNode.appendChild(this._inputNode),this._outputNode=document.createElement("div"),this._outputNode.className="output",this._domNode.appendChild(this._outputNode),this._toDispose.push(d.addDisposableListener(this._inputNode,"keydown",function(e){var t=new u.StandardKeyboardEvent(e);t.preventDefault(),t.stopPropagation();var i=new n.Keybinding(t.asKeybinding());switch(i.value){case n.CommonKeybindings.ENTER:return s._lastKeybinding&&s._onAccepted(s._lastKeybinding.toUserSettingsLabel()),void s._stop();case n.CommonKeybindings.ESCAPE:return void s._stop()}s._lastKeybinding=i,s._inputNode.value=s._lastKeybinding.toUserSettingsLabel().toLowerCase(),s._inputNode.title="keyCode: "+t.browserEvent.keyCode,d.clearNode(s._outputNode);var o=s._keybindingService.getHTMLLabelFor(s._lastKeybinding);o.forEach(function(e){return s._outputNode.appendChild(a.renderHtml(e))})})),this._toDispose.push(this._editor.onDidChangeConfiguration(function(e){s._isVisible&&s._layout()})),this._toDispose.push(d.addDisposableListener(this._inputNode,"blur",function(e){return s._stop()})),this._editor.addOverlayWidget(this)}return e.prototype.dispose=function(){this._editor.removeOverlayWidget(this),this._toDispose=s.dispose(this._toDispose)},e.prototype.getId=function(){return e.ID},e.prototype.getDomNode=function(){return this._domNode},e.prototype.getPosition=function(){return{preference:null}},e.prototype._show=function(){this._isVisible||(this._isVisible=!0,this._layout(),this._domNode.style.display="block")},e.prototype._hide=function(){this._isVisible&&(this._isVisible=!1,this._domNode.style.display="none")},e.prototype._layout=function(){var t=this._editor.getLayoutInfo(),i=Math.round((t.height-e.HEIGHT)/2);c.StyleMutator.setTop(this._domNode,i);var o=Math.round((t.width-e.WIDTH)/2);c.StyleMutator.setLeft(this._domNode,o)},e.prototype.start=function(){this._editor.revealPositionInCenterIfOutsideViewport(this._editor.getPosition()),this._show(),this._lastKeybinding=null,this._inputNode.value="",d.clearNode(this._outputNode),this._inputNode.focus()},e.prototype._stop=function(){this._editor.focus(),this._hide()},e.ID="editor.contrib.defineKeybindingWidget",e.WIDTH=340,e.HEIGHT=90,e}(),M=function(e){function t(t,i){e.call(this,t,i,g.Behaviour.WidgetFocus|g.Behaviour.UpdateOnModelChange|g.Behaviour.Writeable)}return __extends(t,e),t.prototype.isSupported=function(){return!!e.prototype.isSupported.call(this)&&N(this.editor)},t.prototype.run=function(){var e=S.get(this.editor);return e.launch(),r.TPromise.as(!0)},t.ID="editor.action.defineKeybinding",t}(_.EditorAction);t.DefineKeybindingAction=M,f.EditorBrowserRegistry.registerEditorContribution(S),b.CommonEditorRegistry.registerEditorAction(new b.EditorActionDescriptor(M,M.ID,w,{context:b.ContextKey.EditorFocus,primary:n.KeyMod.chord(n.KeyMod.CtrlCmd|n.KeyCode.KEY_K,n.KeyMod.CtrlCmd|n.KeyCode.KEY_K)},"Define Keybinding"))});