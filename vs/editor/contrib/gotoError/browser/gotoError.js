/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)},__decorate=this&&this.__decorate||function(e,t,i,o){var r,n=arguments.length,s=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,o);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(n<3?r(s):n>3?r(t,i,s):r(t,i))||s);return n>3&&s&&Object.defineProperty(t,i,s),s},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}};define(["require","exports","vs/nls","vs/base/common/errors","vs/base/common/event","vs/base/common/keyCodes","vs/base/common/lifecycle","vs/base/common/severity","vs/base/common/winjs.base","vs/base/browser/dom","vs/base/browser/htmlContentRenderer","vs/platform/commands/common/commands","vs/platform/keybinding/common/keybinding","vs/platform/markers/common/markers","vs/platform/telemetry/common/telemetry","vs/editor/common/core/position","vs/editor/common/core/range","vs/editor/common/editorAction","vs/editor/common/editorActionEnablement","vs/editor/common/editorCommonExtensions","vs/editor/browser/editorBrowserExtensions","vs/editor/contrib/zoneWidget/browser/zoneWidget","vs/editor/contrib/quickFix/common/quickFix","vs/css!./gotoError"],function(e,t,i,o,r,n,s,a,d,c,h,l,m,u,p,_,g,f,v,y,C,x,k){"use strict";var b=function(){function e(e,t){var i=this;this._editor=e,this._markers=null,this._nextIdx=-1,this._toUnbind=[],this._ignoreSelectionChange=!1,this._onCurrentMarkerChanged=new r.Emitter,this._onMarkerSetChanged=new r.Emitter,this.setMarkers(t),this._toUnbind.push(this._editor.onDidDispose(function(){return i.dispose()})),this._toUnbind.push(this._editor.onDidChangeCursorPosition(function(){i._ignoreSelectionChange||(i._nextIdx=-1)}))}return Object.defineProperty(e.prototype,"onCurrentMarkerChanged",{get:function(){return this._onCurrentMarkerChanged.event},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMarkerSetChanged",{get:function(){return this._onMarkerSetChanged.event},enumerable:!0,configurable:!0}),e.prototype.setMarkers=function(e){this._markers=e||[],this._markers.sort(function(e,t){return a["default"].compare(e.severity,t.severity)||g.Range.compareRangesUsingStarts(e,t)}),this._nextIdx=-1,this._onMarkerSetChanged.fire(this)},e.prototype.withoutWatchingEditorPosition=function(e){this._ignoreSelectionChange=!0;try{e()}finally{this._ignoreSelectionChange=!1}},e.prototype.initIdx=function(e){for(var t=!1,i=this._editor.getPosition(),o=0,r=this._markers.length;o<r&&!t;o++){var n={lineNumber:this._markers[o].startLineNumber,column:this._markers[o].startColumn};i.isBeforeOrEqual(n)&&(this._nextIdx=o+(e?0:-1),t=!0)}t||(this._nextIdx=e?0:this._markers.length-1),this._nextIdx<0&&(this._nextIdx=this._markers.length-1)},e.prototype.move=function(e){if(!this.canNavigate())return void this._onCurrentMarkerChanged.fire(void 0);this._nextIdx===-1?this.initIdx(e):e?(this._nextIdx+=1,this._nextIdx>=this._markers.length&&(this._nextIdx=0)):(this._nextIdx-=1,this._nextIdx<0&&(this._nextIdx=this._markers.length-1));var t=this._markers[this._nextIdx];this._onCurrentMarkerChanged.fire(t)},e.prototype.canNavigate=function(){return this._markers.length>0},e.prototype.next=function(){this.move(!0)},e.prototype.previous=function(){this.move(!1)},e.prototype.goTo=function(e){for(var t=0;t<this._markers.length;t++){var i=this._markers[t];if(i.startLineNumber<=e.lineNumber&&i.endLineNumber>=e.lineNumber&&i.startColumn<=e.column&&i.endColumn>=e.column)return void this._onCurrentMarkerChanged.fire(i)}return null},Object.defineProperty(e.prototype,"stats",{get:function(){for(var e=0,t=0,i=0,o=this._markers;i<o.length;i++){var r=o[i];r.severity===a["default"].Error?e+=1:t+=1}return{errors:e,others:t}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"total",{get:function(){return this._markers.length},enumerable:!0,configurable:!0}),e.prototype.indexOf=function(e){return 1+this._markers.indexOf(e)},e.prototype.reveal=function(){var e=this;this._nextIdx!==-1&&this.withoutWatchingEditorPosition(function(){var t=new _.Position(e._markers[e._nextIdx].startLineNumber,e._markers[e._nextIdx].startColumn);e._editor.setPosition(t),e._editor.revealPositionInCenter(t)})},e.prototype.dispose=function(){this._toUnbind=s.dispose(this._toUnbind)},e}(),E=function(){function e(e,t){var i=this;this._commandService=t,this._disposeOnUpdate=[],this.domNode=document.createElement("div"),e.appendChild(this.domNode),this._listener=c.addStandardDisposableListener(e,"keydown",function(e){switch(e.asKeybinding()){case n.CommonKeybindings.LEFT_ARROW:i._move(!0),e.preventDefault(),e.stopPropagation();break;case n.CommonKeybindings.RIGHT_ARROW:i._move(!1),e.preventDefault(),e.stopPropagation()}})}return e.prototype.dispose=function(){this._disposeOnUpdate=s.dispose(this._disposeOnUpdate),this._listener=s.dispose(this._listener)},e.prototype.update=function(e){var t=this;return this._disposeOnUpdate=s.dispose(this._disposeOnUpdate),this.domNode.style.display="none",e.then(function(e){return t._doUpdate(e)},o.onUnexpectedError)},e.prototype._doUpdate=function(e){var t=this;if(c.clearNode(this.domNode),e&&0!==e.length){var o=document.createElement("span");o.className="quickfixhead",o.appendChild(document.createTextNode(e.length>1?i.localize("quickfix.multiple.label","Suggested fixes: "):i.localize("quickfix.single.label","Suggested fix: "))),this.domNode.appendChild(o);var r=document.createElement("span");r.className="quickfixcontainer",e.forEach(function(e,i,o){if(i>0){var s=document.createElement("span");s.appendChild(document.createTextNode(", ")),r.appendChild(s)}var a=document.createElement("a");a.tabIndex=0,a.className="quickfixentry",a.dataset.idx=String(i),a.dataset.next=String(i<o.length-1?i+1:0),a.dataset.prev=String(i>0?i-1:o.length-1),a.appendChild(document.createTextNode(e.command.title)),t._disposeOnUpdate.push(c.addDisposableListener(a,c.EventType.CLICK,function(){return(i=t._commandService).executeCommand.apply(i,[e.command.id].concat(e.command.arguments)),!0;var i})),t._disposeOnUpdate.push(c.addStandardDisposableListener(a,"keydown",function(i){switch(i.asKeybinding()){case n.CommonKeybindings.ENTER:case n.CommonKeybindings.SPACE:(o=t._commandService).executeCommand.apply(o,[e.command.id].concat(e.command.arguments)),i.preventDefault(),i.stopPropagation()}var o})),r.appendChild(a)}),this.domNode.appendChild(r),this.domNode.style.display=""}},e.prototype._move=function(e){var t;if(document.activeElement.classList.contains("quickfixentry")){var i=document.activeElement,o=e?i.dataset.prev:i.dataset.next;t=this.domNode.querySelector("a[data-idx='"+o+"']")}else t=this.domNode.querySelector(".quickfixentry");t.focus()},e=__decorate([__param(1,l.ICommandService)],e)}(),S=function(e){function t(t,i,o){e.call(this,t,{showArrow:!0,showFrame:!0,isAccessible:!0}),this._model=i,this._commandService=o,this._callOnDispose=[],this._editor=t,this.create(),this._wireModelAndView()}return __extends(t,e),t.prototype._fillContainer=function(e){this._parentContainer=e,c.addClass(e,"marker-widget"),this._parentContainer.tabIndex=0,this._parentContainer.setAttribute("role","tooltip"),this._container=document.createElement("div"),e.appendChild(this._container),this._title=document.createElement("div"),this._title.className="block title",this._container.appendChild(this._title),this._messages=document.createElement("div"),this.editor.applyFontInfo(this._messages),this._messages.className="block descriptioncontainer",this._messages.setAttribute("aria-live","assertive"),this._messages.setAttribute("role","alert"),this._container.appendChild(this._messages),this._fixesWidget=new E(this._container,this._commandService),this._fixesWidget.domNode.classList.add("fixes"),this._callOnDispose.push(this._fixesWidget)},t.prototype.show=function(t,i){e.prototype.show.call(this,t,i),this._parentContainer.focus()},t.prototype._wireModelAndView=function(){this._model.onCurrentMarkerChanged(this.showAtMarker,this,this._callOnDispose)},t.prototype.showAtMarker=function(e){var t=this;if(e){switch(e.severity){case a["default"].Error:this.options.frameColor="#ff5a5a";break;case a["default"].Warning:case a["default"].Info:this.options.frameColor="#5aac5a"}e.source?this._title.innerHTML=i.localize("title.w_source","({0}/{1}) [{2}]",this._model.indexOf(e),this._model.total,e.source):this._title.innerHTML=i.localize("title.wo_source","({0}/{1})",this._model.indexOf(e),this._model.total),c.clearNode(this._messages),this._messages.appendChild(h.renderHtml(e.message));var o=g.Range.lift(e);this._model.withoutWatchingEditorPosition(function(){return t.show(o.getStartPosition(),t.computeRequiredHeight())}),this._fixesWidget.update(k.getCodeActions(this.editor.getModel(),o)).then(function(){return t.show(o.getStartPosition(),t.computeRequiredHeight())})}},t.prototype.computeRequiredHeight=function(){var e=this._editor.getConfiguration().lineHeight||12;return Math.max(1,Math.ceil(this._container.clientHeight/e))+1},t.prototype.dispose=function(){this._callOnDispose=s.dispose(this._callOnDispose),e.prototype.dispose.call(this)},t}(x.ZoneWidget),M=function(e){function t(t,i,o,r){e.call(this,t,i,v.Behaviour.WidgetFocus|v.Behaviour.Writeable|v.Behaviour.UpdateOnModelChange),this.telemetryService=r,this._isNext=o}return __extends(t,e),t.prototype.run=function(){var e=w.getMarkerController(this.editor).getOrCreateModel();return this.telemetryService.publicLog("zoneWidgetShown",{mode:"go to error"}),e&&(this._isNext?e.next():e.previous(),e.reveal()),d.TPromise.as(!0)},t=__decorate([__param(3,p.ITelemetryService)],t)}(f.EditorAction),w=function(){function e(e,t,i,o){this._markerService=t,this._keybindingService=i,this._commandService=o,this._callOnClose=[],this._editor=e,this._markersNavigationVisible=this._keybindingService.createKey(O,!1)}return e.getMarkerController=function(t){return t.getContribution(e.ID)},e.prototype.getId=function(){return e.ID},e.prototype.dispose=function(){this._cleanUp()},e.prototype._cleanUp=function(){this._markersNavigationVisible.reset(),this._callOnClose=s.dispose(this._callOnClose),this._zone=null,this._model=null},e.prototype.getOrCreateModel=function(){var e=this;if(this._model)return this._model;var t=this._getMarkers();return this._model=new b(this._editor,t),this._zone=new S(this._editor,this._model,this._commandService),this._markersNavigationVisible.set(!0),this._callOnClose.push(this._model),this._callOnClose.push(this._zone),this._callOnClose.push(this._editor.onDidChangeModel(function(){return e._cleanUp()})),this._model.onCurrentMarkerChanged(function(t){return!t&&e._cleanUp()},void 0,this._callOnClose),this._markerService.onMarkerChanged(this._onMarkerChanged,this,this._callOnClose),this._model},e.prototype.closeMarkersNavigation=function(){this._cleanUp(),this._editor.focus()},e.prototype._onMarkerChanged=function(e){var t=this;e.some(function(e){return t._editor.getModel().uri.toString()===e.toString()})&&this._model.setMarkers(this._getMarkers())},e.prototype._getMarkers=function(){var e=this._editor.getModel().uri,t=this._markerService.read({resource:e});return t},e.ID="editor.contrib.markerController",e=__decorate([__param(1,u.IMarkerService),__param(2,m.IKeybindingService),__param(3,l.ICommandService)],e)}(),I=function(e){function t(t,i,o){e.call(this,t,i,!0,o)}return __extends(t,e),t.ID="editor.action.marker.next",t=__decorate([__param(2,p.ITelemetryService)],t)}(M),N=function(e){function t(t,i,o){e.call(this,t,i,!1,o)}return __extends(t,e),t.ID="editor.action.marker.prev",t=__decorate([__param(2,p.ITelemetryService)],t)}(M),O="markersNavigationVisible";y.CommonEditorRegistry.registerEditorAction(new y.EditorActionDescriptor(I,I.ID,i.localize("markerAction.next.label","Go to Next Error or Warning"),{context:y.ContextKey.EditorFocus,primary:n.KeyCode.F8},"Go to Next Error or Warning")),y.CommonEditorRegistry.registerEditorAction(new y.EditorActionDescriptor(N,N.ID,i.localize("markerAction.previous.label","Go to Previous Error or Warning"),{context:y.ContextKey.EditorFocus,primary:n.KeyMod.Shift|n.KeyCode.F8},"Go to Previous Error or Warning")),y.CommonEditorRegistry.registerEditorCommand("closeMarkersNavigation",y.CommonEditorRegistry.commandWeight(50),{primary:n.KeyCode.Escape,secondary:[n.KeyMod.Shift|n.KeyCode.Escape]},!1,O,function(e,t,i){var o=w.getMarkerController(t);o.closeMarkersNavigation()}),C.EditorBrowserRegistry.registerEditorContribution(w)});