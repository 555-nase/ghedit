/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)},__decorate=this&&this.__decorate||function(e,t,i,n){var r,s=arguments.length,o=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(s<3?r(o):s>3?r(t,i,o):r(t,i))||o);return s>3&&o&&Object.defineProperty(t,i,o),o},__param=this&&this.__param||function(e,t){return function(i,n){t(i,n,e)}};define(["require","exports","vs/nls","vs/base/common/lifecycle","vs/base/common/winjs.base","vs/base/browser/dom","vs/base/browser/ui/aria/aria","vs/editor/common/modes","vs/editor/browser/editorBrowser","vs/base/common/async","vs/base/common/errors","vs/base/common/event","vs/platform/keybinding/common/keybinding","../common/parameterHints","vs/css!./parameterHints"],function(e,t,i,n,r,s,o,a,h,l,u,d,p,c){"use strict";var g=s.emmet,f=function(e){function t(i){var n=this;e.call(this),this._onHint=this._register(new d.Emitter),this.onHint=this._onHint.event,this._onCancel=this._register(new d.Emitter),this.onCancel=this._onCancel.event,this.editor=i,this.enabled=!1,this.triggerCharactersListeners=[],this.throttledDelayer=new l.RunOnceScheduler(function(){return n.doTrigger()},t.DELAY),this.active=!1,this._register(this.editor.onDidChangeConfiguration(function(){return n.onEditorConfigurationChange()})),this._register(this.editor.onDidChangeModel(function(e){return n.onModelChanged()})),this._register(this.editor.onDidChangeModelMode(function(e){return n.onModelChanged()})),this._register(this.editor.onDidChangeCursorSelection(function(e){return n.onCursorChange(e)})),this._register(a.SignatureHelpProviderRegistry.onDidChange(this.onModelChanged,this)),this.onEditorConfigurationChange(),this.onModelChanged()}return __extends(t,e),t.prototype.cancel=function(e){void 0===e&&(e=!1),this.active=!1,this.throttledDelayer.cancel(),e||this._onCancel.fire(void 0)},t.prototype.trigger=function(e){if(void 0===e&&(e=t.DELAY),this.enabled&&a.SignatureHelpProviderRegistry.has(this.editor.getModel()))return this.cancel(!0),this.throttledDelayer.schedule(e)},t.prototype.doTrigger=function(){var e=this;c.provideSignatureHelp(this.editor.getModel(),this.editor.getPosition()).then(null,u.onUnexpectedError).then(function(t){if(!t||0===t.signatures.length)return e.cancel(),e._onCancel.fire(void 0),!1;e.active=!0;var i={hints:t};return e._onHint.fire(i),!0})},t.prototype.isTriggered=function(){return this.active||this.throttledDelayer.isScheduled()},t.prototype.onModelChanged=function(){var e=this;this.active&&this.cancel(),this.triggerCharactersListeners=n.dispose(this.triggerCharactersListeners);var t=this.editor.getModel();if(t){var i=a.SignatureHelpProviderRegistry.ordered(t)[0];i&&(this.triggerCharactersListeners=i.signatureHelpTriggerCharacters.map(function(t){return e.editor.addTypingListener(t,function(){e.trigger()})}))}},t.prototype.onCursorChange=function(e){"mouse"===e.source?this.cancel():this.isTriggered()&&this.trigger()},t.prototype.onEditorConfigurationChange=function(){this.enabled=this.editor.getConfiguration().contribInfo.parameterHints,this.enabled||this.cancel()},t.prototype.dispose=function(){this.cancel(!0),this.triggerCharactersListeners=n.dispose(this.triggerCharactersListeners),e.prototype.dispose.call(this)},t.DELAY=120,t}(n.Disposable);t.ParameterHintsModel=f;var m=function(){function e(e,t){var i=this;this.editor=e,this.allowEditorOverflow=!0,this.model=new f(e),this.keyVisible=t.createKey(c.Context.Visible,!1),this.keyMultipleSignatures=t.createKey(c.Context.MultipleSignatures,!1),this.visible=!1,this.disposables=[],this.disposables.push(this.model.onHint(function(e){i.show(),i.parameterHints=e.hints,i.render(e.hints),i.currentSignature=e.hints.activeSignature,i.select(i.currentSignature)})),this.disposables.push(this.model.onCancel(function(){i.hide()})),this.element=g(".editor-widget.parameter-hints-widget"),this.disposables.push(s.addDisposableListener(this.element,"click",function(){i.next(),i.editor.focus()}));var n=s.append(this.element,g(".wrapper.monaco-editor-background")),r=s.append(n,g(".buttons")),o=s.append(r,g(".button.previous")),a=s.append(r,g(".button.next"));this.disposables.push(s.addDisposableListener(o,"click",function(e){e.preventDefault(),e.stopPropagation(),i.previous()})),this.disposables.push(s.addDisposableListener(a,"click",function(e){e.preventDefault(),e.stopPropagation(),i.next()})),this.overloads=s.append(n,g(".overloads")),this.signatures=s.append(n,g(".signatures")),this.signatureViews=[],this.currentSignature=0,this.editor.addContentWidget(this),this.hide(),this.disposables.push(this.editor.onDidChangeCursorSelection(function(e){i.visible&&i.editor.layoutContentWidget(i)}))}return e.prototype.show=function(){var e=this;this.model&&!this.visible&&(this.keyVisible.set(!0),this.visible=!0,r.TPromise.timeout(100).done(function(){return s.addClass(e.element,"visible")}),this.editor.layoutContentWidget(this))},e.prototype.hide=function(){this.model&&this.visible&&(this.keyVisible.reset(),this.visible=!1,this.parameterHints=null,this.announcedLabel=null,s.removeClass(this.element,"visible"),this.editor.layoutContentWidget(this))},e.prototype.getPosition=function(){return this.visible?{position:this.editor.getPosition(),preference:[h.ContentWidgetPositionPreference.ABOVE,h.ContentWidgetPositionPreference.BELOW]}:null},e.prototype.render=function(e){e.signatures.length>1?s.addClass(this.element,"multiple"):s.removeClass(this.element,"multiple"),this.signatures.innerHTML="",this.signatureViews=[];for(var t=0,i=0,n=e.signatures.length;i<n;i++){var r=e.signatures[i],o=this.renderSignature(this.signatures,r,e.activeParameter);this.renderDocumentation(o,r,e.activeParameter);var a=s.getContentHeight(o);this.signatureViews.push({top:t,height:a}),t+=a}this.keyMultipleSignatures.set(this.signatureViews.length>1)},e.prototype.applyFont=function(e){var t=this.editor.getConfiguration().fontInfo;e.style.fontFamily=t.fontFamily},e.prototype.renderSignature=function(e,t,i){var n=s.append(e,g(".signature")),r=s.append(n,g(".code")),o=t.parameters.length>0;if(this.applyFont(r),!o){var a=s.append(r,g("span"));return a.textContent=t.label,r}for(var h=g("span.parameters"),l=0,u=0,d=0,p=t.parameters.length;d<p;d++){var c=t.parameters[d];u=t.label.indexOf(c.label,u);var f=0,m=0;u>=0&&(f=u,u+=c.label.length,m=u);var v=0===d?r:h,b=g("span");b.textContent=t.label.substring(l,f),s.append(v,b);var y=g("span.parameter");s.addClass(y,d===i?"active":""),y.textContent=t.label.substring(f,m),s.append(h,y),l=m}var C=g("span");return C.textContent=t.label.substring(l),s.append(r,h),s.append(r,C),n},e.prototype.renderDocumentation=function(e,t,i){if(t.documentation){var n=g(".documentation");n.textContent=t.documentation,s.append(e,n)}var r=t.parameters[i];if(r&&r.documentation){var o=g(".documentation-parameter"),a=g("span.parameter");this.applyFont(a),a.textContent=r.label;var n=g("span.documentation");n.textContent=r.documentation,s.append(o,a),s.append(o,n),s.append(e,o)}},e.prototype.select=function(e){var t=this.signatureViews[e];if(t){this.signatures.style.height=t.height+"px",this.signatures.scrollTop=t.top;var n=""+(e+1);if(this.signatureViews.length<10&&(n+="/"+this.signatureViews.length),this.overloads.textContent=n,this.parameterHints&&this.parameterHints.signatures[e].parameters[this.parameterHints.activeParameter]){var r=this.parameterHints.signatures[e].parameters[this.parameterHints.activeParameter].label;this.announcedLabel!==r&&(o.alert(i.localize("hint","{0}, hint",r)),this.announcedLabel=r)}this.editor.layoutContentWidget(this)}},e.prototype.next=function(){return this.signatureViews.length<2?(this.cancel(),!1):(this.currentSignature=(this.currentSignature+1)%this.signatureViews.length,this.select(this.currentSignature),!0)},e.prototype.previous=function(){return this.signatureViews.length<2?(this.cancel(),!1):(this.currentSignature--,this.currentSignature<0&&(this.currentSignature=this.signatureViews.length-1),this.select(this.currentSignature),!0)},e.prototype.cancel=function(){this.model.cancel()},e.prototype.getDomNode=function(){return this.element},e.prototype.getId=function(){return e.ID},e.prototype.trigger=function(){this.model.trigger(0)},e.prototype.dispose=function(){this.disposables=n.dispose(this.disposables),this.model=null},e.ID="editor.widget.parameterHintsWidget",e=__decorate([__param(1,p.IKeybindingService)],e)}();t.ParameterHintsWidget=m});