define(["require","exports","vs/base/common/eventEmitter","vs/base/common/event","vs/base/common/paths","vs/base/common/strings","vs/base/common/idGenerator","vs/base/common/winjs.base","vs/editor/common/core/range"],function(e,r,t,n,i,o,u,a,s){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var c=function(){function e(e,r,t){this._parent=e,this._range=r,this._eventBus=t,this._id=u.defaultGenerator.nextId()}return Object.defineProperty(e.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"model",{get:function(){return this._parent},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"uri",{get:function(){return this._parent.uri},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this._parent.name},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"directory",{get:function(){return this._parent.directory},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"range",{get:function(){return this._range},set:function(e){this._range=e,this._eventBus.emit("ref/changed",this)},enumerable:!0,configurable:!0}),e}();r.OneReference=c;var f=function(){function e(e){this._value=e}return e.prototype.preview=function(e,r){void 0===r&&(r=8);var t=e.startLineNumber,n=e.startColumn,i=e.endColumn,u=this._value.getWordUntilPosition({lineNumber:t,column:n-r}),a=new s.Range(t,u.startColumn,t,n),c=new s.Range(t,i,t,Number.MAX_VALUE),f={before:this._value.getValueInRange(a).replace(/^\s+/,o.empty),inside:this._value.getValueInRange(e),after:this._value.getValueInRange(c).replace(/\s+$/,o.empty)};return f},e}();r.FilePreview=f;var p=function(){function e(e,r){this._parent=e,this._uri=r,this._children=[]}return Object.defineProperty(e.prototype,"id",{get:function(){return this._uri.toString()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"children",{get:function(){return this._children},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"uri",{get:function(){return this._uri},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return i.basename(this.uri.fsPath)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"directory",{get:function(){return i.dirname(this.uri.fsPath)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"preview",{get:function(){return this._preview},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"failure",{get:function(){return this._loadFailure},enumerable:!0,configurable:!0}),e.prototype.resolve=function(e){var r=this;return this._resolved?a.TPromise.as(this):e.resolveEditorModel({resource:this._uri}).then(function(e){if(!e)throw new Error;return r._preview=new f(e.textEditorModel),r._resolved=!0,r},function(e){return r._children=[],r._resolved=!0,r._loadFailure=e,r})},e}();r.FileReferences=p;var g=function(){function e(r){this._groups=[],this._references=[],this._eventBus=new t.EventEmitter,this.onDidChangeReferenceRange=n.fromEventEmitter(this._eventBus,"ref/changed"),r.sort(e._compareReferences);for(var i,o=0,u=r;o<u.length;o++){var a=u[o];if(i&&i.uri.toString()===a.uri.toString()||(i=new p(this,a.uri),this.groups.push(i)),0===i.children.length||!s.Range.equalsRange(a.range,i.children[i.children.length-1].range)){var f=new c(i,a.range,this._eventBus);this._references.push(f),i.children.push(f)}}}return Object.defineProperty(e.prototype,"empty",{get:function(){return 0===this._groups.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"references",{get:function(){return this._references},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"groups",{get:function(){return this._groups},enumerable:!0,configurable:!0}),e.prototype.nextReference=function(e){var r=e.parent.children.indexOf(e),t=e.parent.children.length,n=e.parent.parent.groups.length;return r+1<t||1===n?e.parent.children[(r+1)%t]:(r=e.parent.parent.groups.indexOf(e.parent),r=(r+1)%n,e.parent.parent.groups[r].children[0])},e.prototype.nearestReference=function(e,r){var t=this._references.map(function(t,n){return{idx:n,prefixLen:o.commonPrefixLength(t.uri.toString(),e.toString()),offsetDist:100*Math.abs(t.range.startLineNumber-r.lineNumber)+Math.abs(t.range.startColumn-r.column)}}).sort(function(e,r){return e.prefixLen>r.prefixLen?-1:e.prefixLen<r.prefixLen?1:e.offsetDist<r.offsetDist?-1:e.offsetDist>r.offsetDist?1:0})[0];if(t)return this._references[t.idx]},e._compareReferences=function(e,r){return e.uri.toString()<r.uri.toString()?-1:e.uri.toString()>r.uri.toString()?1:s.Range.compareRangesUsingStarts(e.range,r.range)},e}();r.ReferencesModel=g});