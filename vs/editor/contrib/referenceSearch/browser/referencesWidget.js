var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},__decorate=this&&this.__decorate||function(e,t,n,o){var i,r=arguments.length,s=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,o);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(r<3?i(s):r>3?i(t,n,s):i(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},__param=this&&this.__param||function(e,t){return function(n,o){t(n,o,e)}};define(["require","exports","vs/nls","vs/base/common/collections","vs/base/common/errors","vs/base/common/labels","vs/base/common/event","vs/base/common/lifecycle","vs/base/common/network","vs/base/common/strings","vs/base/common/winjs.base","vs/base/browser/builder","vs/base/browser/dom","vs/base/browser/ui/sash/sash","vs/base/browser/ui/countBadge/countBadge","vs/base/browser/ui/fileLabel/fileLabel","vs/base/browser/ui/leftRightWidget/leftRightWidget","vs/base/parts/tree/browser/treeDefaults","vs/base/parts/tree/browser/treeImpl","vs/platform/editor/common/editor","vs/platform/instantiation/common/serviceCollection","vs/platform/workspace/common/workspace","vs/editor/common/config/defaultConfig","vs/editor/common/core/range","vs/editor/common/editorCommon","vs/editor/common/model/model","vs/editor/browser/widget/embeddedCodeEditorWidget","vs/editor/contrib/zoneWidget/browser/peekViewWidget","./referencesModel","vs/css!./referencesWidget"],function(e,t,n,o,i,r,s,a,c,l,h,d,p,u,f,_,v,g,m,y,w,C,b,D,S,E,R,O,M){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var F=function(){function e(e,t){var n=this;this.editor=e,this.model=t,this._decorationSet=o.createStringDictionary(),this._decorationIgnoreSet=o.createStringDictionary(),this._callOnDispose=[],this._callOnModelChange=[],this._callOnDispose.push(this.editor.onDidChangeModel(function(){return n._onModelChanged()})),this._onModelChanged()}return e.prototype.dispose=function(){this._callOnModelChange=a.dispose(this._callOnModelChange),this._callOnDispose=a.dispose(this._callOnDispose),this.removeDecorations()},e.prototype._onModelChanged=function(){this.removeDecorations(),this._callOnModelChange=a.dispose(this._callOnModelChange);var e=this.editor.getModel();if(e)for(var t=0,n=this.model.groups.length;t<n;t++)if(this.model.groups[t].uri.toString()===e.uri.toString())return void this._addDecorations(this.model.groups[t])},e.prototype._addDecorations=function(t){var n=this;this._callOnModelChange.push(this.editor.getModel().onDidChangeDecorations(function(e){return n._onDecorationChanged(e)})),this.editor.getModel().changeDecorations(function(o){for(var i=[],r=[],s=0,a=t.children.length;s<a;s++){var c=t.children[s];n._decorationIgnoreSet[c.id]||(i.push({range:c.range,options:e.DecorationOptions}),r.push(s))}for(var l=o.deltaDecorations([],i),h=0;h<l.length;h++)n._decorationSet[l[h]]=t.children[r[h]]})},e.prototype._onDecorationChanged=function(e){for(var t=this,n=e.addedOrChangedDecorations,i=[],r=0,s=n.length;r<s;r++){var a=o.lookup(this._decorationSet,n[r].id);if(a){var c=n[r].range,l=!1;if(!D.Range.equalsRange(c,a.range)){if(D.Range.spansMultipleLines(c))l=!0;else{var h=a.range.endColumn-a.range.startColumn,d=c.endColumn-c.startColumn;h!==d&&(l=!0)}l?(this._decorationIgnoreSet[a.id]=a,i.push(n[r].id)):a.range=c}}}this.editor.changeDecorations(function(e){for(var n=0,o=i.length;n<o;n++)delete t._decorationSet[i[n]];e.deltaDecorations(i,[])})},e.prototype.removeDecorations=function(){var e=Object.keys(this._decorationSet);e.length>0&&this.editor.changeDecorations(function(t){t.deltaDecorations(e,[])}),this._decorationSet={}},e.DecorationOptions={stickiness:S.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,className:"reference-decoration"},e}(),T=function(){function e(e){this._editorService=e}return e.prototype.getId=function(e,t){return t instanceof M.ReferencesModel?"root":t instanceof M.FileReferences?t.id:t instanceof M.OneReference?t.id:void 0},e.prototype.hasChildren=function(e,t){return t instanceof M.ReferencesModel||(t instanceof M.FileReferences&&!t.failure||void 0)},e.prototype.getChildren=function(e,t){return t instanceof M.ReferencesModel?h.TPromise.as(t.groups):t instanceof M.FileReferences?t.resolve(this._editorService).then(function(n){return t.failure?e.refresh(t).then(function(){return n.children}):n.children}):h.TPromise.as([])},e.prototype.getParent=function(e,t){var n=null;return t instanceof M.FileReferences?n=t.parent:t instanceof M.OneReference&&(n=t.parent),h.TPromise.as(n)},e=__decorate([__param(0,y.IEditorService)],e)}(),P=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.onTap=function(n,o,i){if(o instanceof M.FileReferences)return i.preventDefault(),i.stopPropagation(),this._expandCollapse(n,o);var r=e.prototype.onTap.call(this,n,o,i);return n.emit(t.Events.FOCUSED,o),r},t.prototype.onMouseDown=function(n,o,i){if(i.leftButton){if(o instanceof M.FileReferences)return i.preventDefault(),i.stopPropagation(),this._expandCollapse(n,o);var r=e.prototype.onClick.call(this,n,o,i);return i.ctrlKey||i.metaKey?n.emit(t.Events.OPEN_TO_SIDE,o):2===i.detail?n.emit(t.Events.SELECTED,o):n.emit(t.Events.FOCUSED,o),r}return!1},t.prototype.onClick=function(t,n,o){return!o.leftButton&&e.prototype.onClick.call(this,t,n,o)},t.prototype._expandCollapse=function(e,t){return e.isExpanded(t)?e.collapse(t).done(null,i.onUnexpectedError):e.expand(t).done(null,i.onUnexpectedError),!0},t.prototype.onEscape=function(e,t){return!1},t.prototype.onEnter=function(n,o){var i=n.getFocus();if(i instanceof M.FileReferences)return this._expandCollapse(n,i);var r=e.prototype.onEnter.call(this,n,o);return o.ctrlKey||o.metaKey?n.emit(t.Events.OPEN_TO_SIDE,i):n.emit(t.Events.SELECTED,i),r},t.prototype.onUp=function(t,n){return e.prototype.onUp.call(this,t,n),this._fakeFocus(t,n),!0},t.prototype.onPageUp=function(t,n){return e.prototype.onPageUp.call(this,t,n),this._fakeFocus(t,n),!0},t.prototype.onLeft=function(t,n){return e.prototype.onLeft.call(this,t,n),this._fakeFocus(t,n),!0},t.prototype.onDown=function(t,n){return e.prototype.onDown.call(this,t,n),this._fakeFocus(t,n),!0},t.prototype.onPageDown=function(t,n){return e.prototype.onPageDown.call(this,t,n),this._fakeFocus(t,n),!0},t.prototype.onRight=function(t,n){return e.prototype.onRight.call(this,t,n),this._fakeFocus(t,n),!0},t.prototype._fakeFocus=function(e,n){var o=e.getFocus();e.setSelection([o]),e.emit(t.Events.FOCUSED,o)},t.Events={FOCUSED:"events/custom/focused",SELECTED:"events/custom/selected",OPEN_TO_SIDE:"events/custom/opentoside"},t}(g.DefaultController),L=function(e){function t(t){e.call(this),this._contextService=t}return __extends(t,e),t.prototype.getHeight=function(e,t){return 22},t.prototype.render=function(e,t,o){var i=this;if(p.clearNode(o),t instanceof M.FileReferences){var r=d.$(".reference-file");new v.LeftRightWidget(r,function(e){return new _.FileLabel(e,t.uri,i._contextService),null},function(e){var o=t.children.length,i=new f.CountBadge(e,o);return t.failure?i.setTitleFormat(n.localize("referencesFailre","Failed to resolve file.")):o>1?i.setTitleFormat(n.localize("referencesCount","{0} references",o)):i.setTitleFormat(n.localize("referenceCount","{0} reference",o)),i}),r.appendTo(o)}else if(t instanceof M.OneReference){var s=t.parent.preview.preview(t.range);d.$(".reference").innerHtml(l.format('<span>{0}</span><span class="referenceMatch">{1}</span><span>{2}</span>',l.escape(s.before),l.escape(s.inside),l.escape(s.after))).appendTo(o)}return null},t=__decorate([__param(0,C.IWorkspaceContextService)],t)}(g.LegacyRenderer),k=function(){function e(e,t){var n=this;this._disposables=new a.Disposables,this._onDidChangePercentages=new s.Emitter,this._ratio=t,this._sash=new u.Sash(e,{getVerticalSashLeft:function(){return n._width*n._ratio},getVerticalSashHeight:function(){return n._height}});var o;this._disposables.add(this._sash.addListener2("start",function(e){o=e.startX-n._width*n.ratio})),this._disposables.add(this._sash.addListener2("change",function(e){var t=e.currentX-o;t>20&&t+20<n._width&&(n._ratio=t/n._width,n._sash.layout(),n._onDidChangePercentages.fire(n))}))}return e.prototype.dispose=function(){this._sash.dispose(),this._onDidChangePercentages.dispose(),this._disposables.dispose()},Object.defineProperty(e.prototype,"onDidChangePercentages",{get:function(){return this._onDidChangePercentages.event},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{set:function(e){this._width=e,this._sash.layout()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{set:function(e){this._height=e,this._sash.layout()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"percentages",{get:function(){var e=100*this._ratio,t=100-e;return[e+"%",t+"%"]},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ratio",{get:function(){return this._ratio},enumerable:!0,configurable:!0}),e}(),N=function(e){function t(n,o,i,r,a){e.call(this,n,t.INNER_EDITOR_CONTEXT_KEY,{frameColor:"#007ACC",showFrame:!1,showArrow:!0,isResizeable:!0}),this.layoutData=o,this._editorService=i,this._contextService=r,this._instantiationService=a,this._disposeOnNewModel=[],this._onDidSelectReference=new s.Emitter,this._instantiationService=this._instantiationService.createChild(new w.ServiceCollection([O.IPeekViewService,this])),this.create()}return __extends(t,e),t.prototype.dispose=function(){this.setModel(null),a.dispose(this._preview,this._previewNotAvailableMessage,this._tree,this._sash),e.prototype.dispose.call(this)},Object.defineProperty(t.prototype,"onDidSelectReference",{get:function(){return this._onDidSelectReference.event},enumerable:!0,configurable:!0}),t.prototype.show=function(t){this.editor.revealRangeInCenterIfOutsideViewport(t),e.prototype.show.call(this,t,this.layoutData.heightInLines||18)},t.prototype.focus=function(){this._tree.DOMFocus()},t.prototype._onTitleClick=function(e){this._preview&&this._preview.getModel()&&this._onDidSelectReference.fire({element:this._getFocusedReference(),kind:e.ctrlKey||e.metaKey?"side":"open",source:"title"})},t.prototype._fillBody=function(e){var t=this,o=d.$(e);o.addClass("reference-zone-widget"),o.div({"class":"messages"},function(e){t._messageContainer=e.hide()}),o.div({"class":"preview inline"},function(e){var o={scrollBeyondLastLine:!1,scrollbar:b.DefaultConfig.editor.scrollbar,overviewRulerLanes:2};t._preview=t._instantiationService.createInstance(R.EmbeddedCodeEditorWidget,e.getHTMLElement(),o,t.editor),t._previewContainer=e.hide(),t._previewNotAvailableMessage=E.Model.createFromString(n.localize("missingPreviewMessage","no preview available"))}),this._sash=new k(e,this.layoutData.ratio||.8),this._sash.onDidChangePercentages(function(){var e=t._sash.percentages,n=e[0],o=e[1];t._previewContainer.style({width:n}),t._treeContainer.style({width:o}),t._preview.layout(),t._tree.layout(),t.layoutData.ratio=t._sash.ratio}),o.div({"class":"ref-tree inline"},function(e){var o={dataSource:t._instantiationService.createInstance(T),renderer:t._instantiationService.createInstance(L),controller:new P},i={allowHorizontalScroll:!1,twistiePixels:20,ariaLabel:n.localize("treeAriaLabel","References")};t._tree=new m.Tree(e.getHTMLElement(),o,i),t._treeContainer=e.hide()})},t.prototype._doLayoutBody=function(t,n){e.prototype._doLayoutBody.call(this,t,n);var o=t+"px";this._sash.height=t,this._sash.width=n;var i=this._sash.percentages,r=i[0],s=i[1];this._previewContainer.style({height:o,width:r}),this._treeContainer.style({height:o,width:s}),this._tree.layout(t),this._preview.layout(),this.layoutData={heightInLines:this._viewZone.heightInLines,ratio:this._sash.ratio}},t.prototype._onWidth=function(e){this._sash.width=e,this._preview.layout()},t.prototype.setSelection=function(e){return this._revealReference(e)},t.prototype.setModel=function(e){if(this._disposeOnNewModel=a.dispose(this._disposeOnNewModel),this._model=e,this._model)return this._onNewModel()},t.prototype._onNewModel=function(){var e=this;if(this._model.empty)return this.setTitle(""),this._messageContainer.innerHtml(n.localize("noResults","No results")).show(),h.TPromise.as(void 0);this._messageContainer.hide(),this._decorationsManager=new F(this._preview,this._model),this._disposeOnNewModel.push(this._decorationsManager),this._disposeOnNewModel.push(this._model.onDidChangeReferenceRange(function(t){return e._tree.refresh(t)})),this._disposeOnNewModel.push(this._tree.addListener2(P.Events.FOCUSED,function(t){t instanceof M.OneReference&&(e._revealReference(t),e._onDidSelectReference.fire({element:t,kind:"show",source:"tree"}))})),this._disposeOnNewModel.push(this._tree.addListener2(P.Events.SELECTED,function(t){t instanceof M.OneReference&&(e._revealReference(t),e._onDidSelectReference.fire({element:t,kind:"goto",source:"tree"}))})),this._disposeOnNewModel.push(this._tree.addListener2(P.Events.OPEN_TO_SIDE,function(t){t instanceof M.OneReference&&e._onDidSelectReference.fire({element:t,kind:"side",source:"tree"})})),this._disposeOnNewModel.push(this._preview.onMouseDown(function(t){2===t.event.detail&&e._onDidSelectReference.fire({element:e._getFocusedReference(),kind:t.event.ctrlKey||t.event.metaKey?"side":"open",source:"editor"})})),p.addClass(this.container,"results-loaded"),this._treeContainer.show(),this._previewContainer.show(),this._preview.layout(),this._tree.layout(),this.focus();var t=1===this._model.groups.length?this._model.groups[0]:this._model;return this._tree.setInput(t)},t.prototype._getFocusedReference=function(){var e=this._tree.getFocus();return e instanceof M.OneReference?e:e instanceof M.FileReferences&&e.children.length>0?e.children[0]:void 0},t.prototype._revealReference=function(e){var t=this;return e.uri.scheme!==c.Schemas.inMemory?this.setTitle(e.name,r.getPathLabel(e.directory,this._contextService)):this.setTitle(n.localize("peekView.alternateTitle","References")),h.TPromise.join([this._editorService.resolveEditorModel({resource:e.uri}),this._tree.reveal(e)]).then(function(n){if(t._model){var o=n[0];if(o){t._preview.setModel(o.textEditorModel);var i=D.Range.lift(e.range).collapseToStart();t._preview.setSelection(i),t._preview.revealRangeInCenter(i)}else t._preview.setModel(t._previewNotAvailableMessage);t._tree.setSelection([e]),t._tree.setFocus(e)}},i.onUnexpectedError)},t.INNER_EDITOR_CONTEXT_KEY="inReferenceSearchEditor",t}(O.PeekViewWidget);t.ReferenceWidget=N});