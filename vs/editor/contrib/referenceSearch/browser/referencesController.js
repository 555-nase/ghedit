var __decorate=this&&this.__decorate||function(e,t,i,o){var r,n=arguments.length,s=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,o);else for(var c=e.length-1;c>=0;c--)(r=e[c])&&(s=(n<3?r(s):n>3?r(t,i,s):r(t,i))||s);return n>3&&s&&Object.defineProperty(t,i,s),s},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}};define(["require","exports","vs/nls","vs/base/common/errors","vs/base/common/lifecycle","vs/base/common/severity","vs/platform/editor/common/editor","vs/platform/instantiation/common/instantiation","vs/platform/keybinding/common/keybinding","vs/platform/message/common/message","vs/platform/telemetry/common/telemetry","vs/platform/configuration/common/configuration","vs/platform/workspace/common/workspace","vs/platform/storage/common/storage","vs/editor/browser/editorBrowserExtensions","vs/editor/contrib/zoneWidget/browser/peekViewWidget","./referencesWidget"],function(e,t,i,o,r,n,s,c,a,d,l,_,g,h,u,f,p){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";t.ctxReferenceSearchVisible="referenceSearchVisible";var m=function(){function e(e,i,o,r,n,s,c,a,d,l){this._editorService=o,this._telemetryService=r,this._messageService=n,this._instantiationService=s,this._contextService=c,this._storageService=a,this._configurationService=d,this._peekViewService=l,this._requestIdPool=0,this._disposables=[],this._ignoreModelChangeEvent=!1,this._editor=e,this._referenceSearchVisible=i.createKey(t.ctxReferenceSearchVisible,!1)}return e.getController=function(t){return t.getContribution(e.ID)},e.prototype.getId=function(){return e.ID},e.prototype.dispose=function(){this._widget&&(this._widget.dispose(),this._widget=null),this._editor=null},e.prototype.toggleWidget=function(e,t,o){var r,s=this;if(this._widget&&(r=this._widget.position),this.closeWidget(),r&&e.containsPosition(r))return null;this._referenceSearchVisible.set(!0),this._disposables.push(this._editor.onDidChangeModelMode(function(){s.closeWidget()})),this._disposables.push(this._editor.onDidChangeModel(function(){s._ignoreModelChangeEvent||s.closeWidget()}));var c="peekViewLayout",a=JSON.parse(this._storageService.get(c,void 0,"{}"));this._widget=new p.ReferenceWidget(this._editor,a,this._editorService,this._contextService,this._instantiationService),this._widget.setTitle(i.localize("labelLoading","Loading...")),this._widget.show(e),this._disposables.push(this._widget.onDidClose(function(){t.cancel(),s._storageService.store(c,JSON.stringify(s._widget.layoutData)),s._widget=null,s.closeWidget()})),this._disposables.push(this._widget.onDidSelectReference(function(e){var t=e.element,i=e.kind;switch(i){case"open":if("editor"===e.source&&_.getConfigurationValue(s._configurationService.getConfiguration(),"editor.stablePeek",!1))break;case"side":s._openReference(t,"side"===i);break;case"goto":o.onGoto?o.onGoto(t):s._gotoReference(t)}}));var d=++this._requestIdPool,l=this._telemetryService.timedPublicLog("findReferences",{mode:this._editor.getModel().getMode().getId()});t.then(function(t){if(d===s._requestIdPool&&s._widget){s._model=t;var i=Date.now();return s._disposables.push({dispose:function(){s._telemetryService.publicLog("zoneWidgetShown",{mode:"reference search",elapsedTime:Date.now()-i})}}),s._widget.setModel(s._model).then(function(){s._widget.setMetaTitle(o.getMetaTitle(s._model));var t=s._editor.getModel().uri,i={lineNumber:e.startLineNumber,column:e.startColumn},r=s._model.nearestReference(t,i);if(r)return s._widget.setSelection(r)})}},function(e){s._messageService.show(n["default"].Error,e)}).done(function(){l.stop()})},e.prototype.closeWidget=function(){this._widget&&(this._widget.dispose(),this._widget=null),this._referenceSearchVisible.reset(),this._disposables=r.dispose(this._disposables),this._model=null,this._editor.focus(),this._requestIdPool+=1},e.prototype._gotoReference=function(e){var t=this;this._ignoreModelChangeEvent=!0;var i=e.uri,r=e.range;this._editorService.openEditor({resource:i,options:{selection:r}}).done(function(e){return t._ignoreModelChangeEvent=!1,e&&e.getControl()===t._editor?(t._widget.show(r),void t._widget.focus()):void t.closeWidget()},function(e){t._ignoreModelChangeEvent=!1,o.onUnexpectedError(e)})},e.prototype._openReference=function(e,t){var i=e.uri,o=e.range;this._editorService.openEditor({resource:i,options:{selection:o}},t),t||this.closeWidget()},e.ID="editor.contrib.referencesController",e=__decorate([__param(1,a.IKeybindingService),__param(2,s.IEditorService),__param(3,l.ITelemetryService),__param(4,d.IMessageService),__param(5,c.IInstantiationService),__param(6,g.IWorkspaceContextService),__param(7,h.IStorageService),__param(8,_.IConfigurationService),__param(9,c.optional(f.IPeekViewService))],e)}();t.ReferencesController=m,u.EditorBrowserRegistry.registerEditorContribution(m)});