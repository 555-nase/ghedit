var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)};define(["require","exports","vs/nls","vs/base/common/uri","vs/base/common/winjs.base","vs/base/browser/htmlContentRenderer","vs/platform/opener/common/opener","vs/editor/common/core/range","vs/editor/common/core/position","vs/editor/common/modes","vs/editor/common/modes/textToHtmlTokenizer","../common/hover","./hoverOperation","./hoverWidgets","vs/base/common/htmlContent","vs/css!vs/base/browser/ui/progressbar/progressbar"],function(e,t,n,o,s,i,r,a,h,c,u,g,l,_,p){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var d=function(){function e(e){this._editor=e,this._range=null}return e.prototype.setRange=function(e){this._range=e,this._result=[]},e.prototype.clearResult=function(){this._result=[]},e.prototype.computeAsync=function(){var e=this._editor.getModel();return c.HoverProviderRegistry.has(e)?g.getHover(e,new h.Position(this._range.startLineNumber,this._range.startColumn)):s.TPromise.as(null)},e.prototype.computeSync=function(){var e=this,t=[],n=this._range.startLineNumber;if(n>this._editor.getModel().getLineCount())return t;var o=function(e){return e&&(!Array.isArray(e)||e.length>0)},s=this._editor.getLineDecorations(n),i=this._editor.getModel().getLineMaxColumn(n);return s.forEach(function(s){var r=s.range.startLineNumber===n?s.range.startColumn:1,h=s.range.endLineNumber===n?s.range.endColumn:i;if(r<=e._range.startColumn&&e._range.endColumn<=h&&o(s.options.hoverMessage)){var c={contents:[],range:new a.Range(e._range.startLineNumber,r,e._range.startLineNumber,h)};s.options.hoverMessage&&(Array.isArray(s.options.hoverMessage)?c.contents=c.contents.concat(s.options.hoverMessage):c.contents.push(s.options.hoverMessage)),t.push(c)}}),t},e.prototype.onResult=function(e,t){t?this._result=e.concat(this._result):this._result=this._result.concat(e)},e.prototype.getResult=function(){return this._result.slice(0)},e.prototype.getResultWithLoadingMessage=function(){return this._result.slice(0).concat([this._getLoadingMessage()])},e.prototype._getLoadingMessage=function(){return{range:this._range,contents:[p.textToMarkedString(n.localize("modesContentHover.loading","Loading..."))]}},e}(),m=function(e){function t(n,o,s){var i=this;e.call(this,t.ID,n),this._computer=new d(this._editor),this._highlightDecorations=[],this._isChangingDecorations=!1,this._openerService=o||r.NullOpenerService,this._modeService=s,this._hoverOperation=new l.HoverOperation(this._computer,function(e){return i._withResult(e,!0)},null,function(e){return i._withResult(e,!1)})}return __extends(t,e),t.prototype.dispose=function(){this._hoverOperation.cancel(),e.prototype.dispose.call(this)},t.prototype.onModelDecorationsChanged=function(){this._isChangingDecorations||this._isVisible&&(this._hoverOperation.cancel(),this._computer.clearResult(),this._hoverOperation.start())},t.prototype.startShowingAt=function(e,t){if(!this._lastRange||!this._lastRange.equalsRange(e)){if(this._hoverOperation.cancel(),this._isVisible)if(this._showAtPosition.lineNumber!==e.startLineNumber)this.hide();else{for(var n=[],o=0,s=this._messages.length;o<s;o++){var i=this._messages[o],r=i.range;r.startColumn<=e.startColumn&&r.endColumn>=e.endColumn&&n.push(i)}n.length>0?this._renderMessages(e,n):this.hide()}this._lastRange=e,this._computer.setRange(e),this._shouldFocus=t,this._hoverOperation.start()}},t.prototype.hide=function(){this._lastRange=null,this._hoverOperation.cancel(),e.prototype.hide.call(this),this._isChangingDecorations=!0,this._highlightDecorations=this._editor.deltaDecorations(this._highlightDecorations,[]),this._isChangingDecorations=!1},t.prototype._withResult=function(e,t){this._messages=e,this._lastRange&&this._messages.length>0?this._renderMessages(this._lastRange,this._messages):t&&this.hide()},t.prototype._renderMessages=function(e,t){var n=this,s=Number.MAX_VALUE,r=t[0].range,h=document.createDocumentFragment();t.forEach(function(e){if(e.range){s=Math.min(s,e.range.startColumn),r=a.Range.plusRange(r,e.range);var t=document.createElement("div"),c=t;e.contents&&e.contents.length>0&&c.appendChild(i.renderMarkedString(e.contents,{actionCallback:function(e){n._openerService.open(o["default"].parse(e))},codeBlockRenderer:function(e,t){var o=n._modeService.getMode(e);return o?u.tokenizeToString(t,o):n._modeService.getOrCreateMode(e).then(function(e){return u.tokenizeToString(t,e)},function(e){return u.tokenizeToString(t,null)})}})),h.appendChild(t)}}),this._domNode.textContent="",this._domNode.appendChild(h),this.showAt({lineNumber:e.startLineNumber,column:s},this._shouldFocus),this._isChangingDecorations=!0,this._highlightDecorations=this._editor.deltaDecorations(this._highlightDecorations,[{range:r,options:{className:"hoverHighlight"}}]),this._isChangingDecorations=!1},t.ID="editor.contrib.modesContentHoverWidget",t}(_.ContentHoverWidget);t.ModesContentHoverWidget=m});