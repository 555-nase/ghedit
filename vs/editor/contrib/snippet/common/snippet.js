/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate=this&&this.__decorate||function(e,t,n,r){var o,i=arguments.length,l=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(o=e[s])&&(l=(i<3?o(l):i>3?o(t,n,l):o(t,n))||l);return i>3&&l&&Object.defineProperty(t,n,l),l},__param=this&&this.__param||function(e,t){return function(n,r){t(n,r,e)}};define(["require","exports","vs/base/common/collections","vs/base/common/keyCodes","vs/base/common/strings","vs/platform/keybinding/common/keybinding","vs/editor/common/core/editOperation","vs/editor/common/core/range","vs/editor/common/core/selection","vs/editor/common/editorCommon","vs/editor/common/editorCommonExtensions","vs/base/common/lifecycle"],function(e,t,n,r,o,i,l,s,a,d,c,p){"use strict";function h(e){return e.getContribution(f.ID)}!function(e){e[e.TextMateSnippet=0]="TextMateSnippet",e[e.EmmetSnippet=1]="EmmetSnippet"}(t.ExternalSnippetType||(t.ExternalSnippetType={}));var u=t.ExternalSnippetType,g=function(){function e(e){this.lines=[],this.placeHolders=[],this._lastGeneratedId=0,this.finishPlaceHolderIndex=-1,this.parseTemplate(e)}return e.prototype.parseTemplate=function(e){var t,r,o,i,l={},a=e.split("\n");for(t=0,r=a.length;t<r;t++){var d=this.parseLine(a[t],function(e){return n.contains(l,e)?l[e].value:""});for(o=0,i=d.placeHolders.length;o<i;o++){var c,p=d.placeHolders[o],h=new s.Range(t+1,p.startColumn,t+1,p.endColumn);n.contains(l,p.id)?c=l[p.id]:(c={id:p.id,value:p.value,occurences:[]},this.placeHolders.push(c),l[p.id]=c),c.occurences.push(h)}this.lines.push(d.line)}this.placeHolders.sort(function(e,t){var n=function(e){return!/^\d+$/.test(e.id)},r=function(e){return""===e.id&&""===e.value};return r(e)?1:r(t)?-1:n(e)&&n(t)?0:n(e)?-1:n(t)?1:e.id===t.id?0:Number(e.id)<Number(t.id)?-1:1}),this.placeHolders.length>0&&""===this.placeHolders[this.placeHolders.length-1].value&&(this.finishPlaceHolderIndex=this.placeHolders.length-1)},e.prototype.parseLine=function(e,t){for(var n=[{placeHolderId:"",placeHolderText:""}],r=[],o=0,i=e.length,l=0;o<i;){var s=e.substr(o);if(/^{{/.test(s)){o+=2,n.push({placeHolderId:"",placeHolderText:""});var a=s.match(/^{{(\w+):/);Array.isArray(a)&&2===a.length&&(n[n.length-1].placeHolderId=a[1],o+=a[1].length+1)}else if(n.length>1&&/^}}/.test(s)){if(o+=2,0===n[n.length-1].placeHolderId.length&&(n[n.length-1].placeHolderId=n[n.length-1].placeHolderText,"_"===n[n.length-1].placeHolderId&&(n[n.length-1].placeHolderId="TAB_STOP_"+String(++this._lastGeneratedId),n[n.length-1].placeHolderText="",--l)),0===n[n.length-1].placeHolderText.length){var d=t(n[n.length-1].placeHolderId);n[n.length-1].placeHolderText=d,l+=d.length}r.push({id:n[n.length-1].placeHolderId,value:n[n.length-1].placeHolderText,startColumn:l+1-n[n.length-1].placeHolderText.length,endColumn:l+1}),n[n.length-2].placeHolderText+=n[n.length-1].placeHolderText,n.pop()}else/^\\./.test(s)&&("{"===s.charAt(1)||"}"===s.charAt(1)||"\\"===s.charAt(1)?++o:(n[n.length-1].placeHolderText+=e.charAt(o),++l,++o)),n[n.length-1].placeHolderText+=e.charAt(o),++l,++o}return r.sort(function(e,t){return e.startColumn<t.startColumn?-1:e.startColumn>t.startColumn?1:e.endColumn<t.endColumn?-1:e.endColumn>t.endColumn?1:0}),{line:n[0].placeHolderText,placeHolders:r}},e.convertExternalSnippet=function(e,t){for(var n=0,r="",o=0,i=e.length;o<i;){var l=e.substr(o);if(/^\$0/.test(l))o+=2,r+=t===u.EmmetSnippet?"{{_}}":"{{}}";else if(/^\$\{0\}/.test(l))o+=4,r+=t===u.EmmetSnippet?"{{_}}":"{{}}";else{var s=l.match(/^\$(\d+)/);Array.isArray(s)&&2===s.length?(o+=1+s[1].length,r+="{{"+s[1]+":}}"):(s=l.match(/^\$\{(\d+)\}/),Array.isArray(s)&&2===s.length?(o+=3+s[1].length,r+="{{"+s[1]+":}}"):/^\${/.test(l)?(o+=2,++n,r+="{{"):n>0&&/^}/.test(l)?(o+=1,--n,r+="}}"):/^\\./.test(l)?(o+=2,r+=/^\\\$/.test(l)?"$":l.substr(0,2)):(s=l.match(/^({|})/),Array.isArray(s)&&2===s.length?(o+=1,r+="\\"+s[1]):(o+=1,r+=l.charAt(0))))}}return r},e.prototype.extractLineIndentation=function(e,t){void 0===t&&(t=Number.MAX_VALUE);var n=o.getLeadingWhitespace(e);return n.length>t-1?n.substring(0,t-1):n},e.prototype.bind=function(e,t,n,r){var o,i,l,s,a,d,c,p,h=[],u=[],g=this.extractLineIndentation(e,n+1),m=[];for(a=0,d=this.lines.length;a<d;a++)o=this.lines[a],0===a?(m[a+1]=n,h[a]=o):(i=this.extractLineIndentation(o),l=o.substr(i.length),s=r.normalizeIndentation(g+i),m[a+1]=s.length-i.length,h[a]=s+l);var f,v,C;for(a=0,d=this.placeHolders.length;a<d;a++){for(f=this.placeHolders[a],C=[],c=0,p=f.occurences.length;c<p;c++)v=f.occurences[c],C.push({startLineNumber:v.startLineNumber+t,startColumn:v.startColumn+m[v.startLineNumber],endLineNumber:v.endLineNumber+t,endColumn:v.endColumn+m[v.endLineNumber]});u.push({id:f.id,value:f.value,occurences:C})}return{lines:h,placeHolders:u,finishPlaceHolderIndex:this.finishPlaceHolderIndex}},e}();t.CodeSnippet=g;var m=function(){function e(e,t,n,r,o){this.editor=e,this._onStop=o,this.model=e.getModel(),this.finishPlaceHolderIndex=t.finishPlaceHolderIndex,this.trackedPlaceHolders=[],this.placeHolderDecorations=[],this.currentPlaceHolderIndex=0,this.highlightDecorationId=null,this.isFinished=!1,this._initialAlternativeVersionId=r,this.initialize(t,n)}return e.prototype.dispose=function(){this.stopAll()},e.prototype.initialize=function(e,t){var n,r,o=this;for(n=0,r=e.placeHolders.length;n<r;n++){for(var i=e.placeHolders[n],l=[],a=0,c=i.occurences.length;a<c;a++)l.push(this.model.addTrackedRange(i.occurences[a],d.TrackedRangeStickiness.AlwaysGrowsWhenTypingAtEdges));this.trackedPlaceHolders.push({ranges:l})}this.editor.changeDecorations(function(n){var r=[],i=t+e.lines.length-1,l=o.model.getLineMaxColumn(i);r.push({range:new s.Range(t,1,i,l),options:{className:"new-snippet",isWholeLine:!0}});for(var a=0,d=o.trackedPlaceHolders.length;a<d;a++){var c=a===o.finishPlaceHolderIndex?"finish-snippet-placeholder":"snippet-placeholder";r.push({range:o.model.getTrackedRange(o.trackedPlaceHolders[a].ranges[0]),options:{className:c}})}var p=n.deltaDecorations([],r);o.highlightDecorationId=p[0],o.placeHolderDecorations=p.slice(1)}),this.listenersToRemove=[],this.listenersToRemove.push(this.editor.onDidChangeModelRawContent(function(e){if(!o.isFinished){if(e.changeType===d.EventType.ModelRawContentChangedFlush)o.stopAll();else if(e.changeType===d.EventType.ModelRawContentChangedLineChanged){var t=e.lineNumber,n=o.model.getDecorationRange(o.highlightDecorationId);(t<n.startLineNumber||t>n.endLineNumber)&&o.stopAll()}else if(e.changeType===d.EventType.ModelRawContentChangedLinesInserted){var r=e.fromLineNumber,n=o.model.getDecorationRange(o.highlightDecorationId);(r<n.startLineNumber||r>n.endLineNumber)&&o.stopAll()}else if(e.changeType===d.EventType.ModelRawContentChangedLinesDeleted){var i=e.fromLineNumber,l=e.toLineNumber,n=o.model.getDecorationRange(o.highlightDecorationId),s=l<n.startLineNumber,a=i>n.endLineNumber;(s||a)&&o.stopAll()}var c=o.editor.getModel().getAlternativeVersionId();o._initialAlternativeVersionId===c&&o.stopAll()}})),this.listenersToRemove.push(this.editor.onDidChangeCursorPosition(function(e){if(!o.isFinished){var t=o.model.getDecorationRange(o.highlightDecorationId),n=e.position.lineNumber;(n<t.startLineNumber||n>t.endLineNumber)&&o.stopAll()}})),this.listenersToRemove.push(this.editor.onDidChangeModel(function(){o.stopAll()}));var p=-1;this.listenersToRemove.push(this.editor.onDidBlurEditor(function(){p=setTimeout(function(){o.stopAll()},100)})),this.listenersToRemove.push(this.editor.onDidFocusEditor(function(){p!==-1&&(clearTimeout(p),p=-1)})),this.listenersToRemove.push(this.model.onDidChangeDecorations(function(e){if(!o.isFinished){for(var t=o.model.getEditableRange(),n=null,r=!0,i=!0,l=0;(r||i)&&l<o.trackedPlaceHolders.length;l++)for(var s=o.trackedPlaceHolders[l].ranges,a=0;(r||i)&&a<s.length;a++){var d=o.model.getTrackedRange(s[a]);r&&(d.isEmpty()?null===n?n=d:n.equalsRange(d)||(r=!1):r=!1),i&&!t.equalsRange(d)&&(i=!1)}if(r||i)o.stopAll();else if(o.finishPlaceHolderIndex!==-1){var c=o.placeHolderDecorations[o.finishPlaceHolderIndex],p=o.model.getDecorationRange(c),h=o.model.getDecorationOptions(c),u=p.isEmpty(),g="finish-snippet-placeholder"===h.className,m=Number(u)^Number(g);m&&o.editor.changeDecorations(function(e){var t=u?"finish-snippet-placeholder":"snippet-placeholder";e.changeDecorationOptions(c,{className:t})})}}})),this.doLinkEditing()},e.prototype.onNextPlaceHolder=function(){return this.changePlaceHolder(!0)},e.prototype.onPrevPlaceHolder=function(){return this.changePlaceHolder(!1)},e.prototype.changePlaceHolder=function(e){if(this.isFinished)return!1;var t=this.currentPlaceHolderIndex,n=this.model.getTrackedRange(this.trackedPlaceHolders[t].ranges[0]),r=!0;do{e?this.currentPlaceHolderIndex=(this.currentPlaceHolderIndex+1)%this.trackedPlaceHolders.length:this.currentPlaceHolderIndex=(this.trackedPlaceHolders.length+this.currentPlaceHolderIndex-1)%this.trackedPlaceHolders.length;var o=this.model.getTrackedRange(this.trackedPlaceHolders[this.currentPlaceHolderIndex].ranges[0]);r=n.equalsRange(o)}while(this.currentPlaceHolderIndex!==t&&r);return this.doLinkEditing(),!0},e.prototype.onAccept=function(){if(this.isFinished)return!1;if(this.finishPlaceHolderIndex!==-1){var e=this.model.getTrackedRange(this.trackedPlaceHolders[this.finishPlaceHolderIndex].ranges[0]);this.editor.setPosition({lineNumber:e.endLineNumber,column:e.endColumn})}return this.stopAll(),!0},e.prototype.onEscape=function(){return!this.isFinished&&(this.stopAll(),this.editor.setSelections([this.editor.getSelections()[0]]),!0)},e.prototype.doLinkEditing=function(){for(var e=[],t=0,n=this.trackedPlaceHolders[this.currentPlaceHolderIndex].ranges.length;t<n;t++){var r=this.model.getTrackedRange(this.trackedPlaceHolders[this.currentPlaceHolderIndex].ranges[t]);e.push({selectionStartLineNumber:r.startLineNumber,selectionStartColumn:r.startColumn,positionLineNumber:r.endLineNumber,positionColumn:r.endColumn})}this.editor.setSelections(e)},e.prototype.stopAll=function(){var e=this;if(!this.isFinished){this._onStop(),this.isFinished=!0,this.listenersToRemove=p.dispose(this.listenersToRemove);for(var t=0;t<this.trackedPlaceHolders.length;t++)for(var n=this.trackedPlaceHolders[t].ranges,r=0;r<n.length;r++)this.model.removeTrackedRange(n[r]);this.trackedPlaceHolders=[],this.editor.changeDecorations(function(t){var n=[];n.push(e.highlightDecorationId);for(var r=0;r<e.placeHolderDecorations.length;r++)n.push(e.placeHolderDecorations[r]);t.deltaDecorations(n,[]),e.placeHolderDecorations=[],e.highlightDecorationId=null})}},e}();t.getSnippetController=h;var f=function(){function e(e,n){this._editor=e,this._currentController=null,this._inSnippetMode=n.createKey(t.CONTEXT_SNIPPET_MODE,!1)}return e.prototype.dispose=function(){this._currentController&&(this._currentController.dispose(),this._currentController=null)},e.prototype.getId=function(){return e.ID},e.prototype.run=function(t,n,r,o){var i=this;this._runAndRestoreController(function(){if(0===t.placeHolders.length)i._runForAllSelections(t,n,r,o);else{var l=e._prepareSnippet(i._editor,i._editor.getSelection(),t,n,r,o);i._runPreparedSnippetForPrimarySelection(l,!0)}})},e.prototype.runWithReplaceRange=function(t,n,r){var o=this;this._runAndRestoreController(function(){o._runPreparedSnippetForPrimarySelection({typeRange:n,adaptedSnippet:e._getAdaptedSnippet(o._editor.getModel(),t,n)},r)})},e.prototype._runAndRestoreController=function(e){var t=this._currentController;this._currentController=null,e(),this._currentController?t&&t.dispose():this._currentController=t},e._getTypeRangeForSelection=function(e,t,n,r){var o;return o=n||r?e.validateRange(s.Range.plusRange(t,{startLineNumber:t.positionLineNumber,startColumn:t.positionColumn-n,endLineNumber:t.positionLineNumber,endColumn:t.positionColumn+r})):t},e._getAdaptedSnippet=function(e,t,n){return t.bind(e.getLineContent(n.startLineNumber),n.startLineNumber-1,n.startColumn-1,e)},e._addCommandForSnippet=function(e,t,n,r){var o=t.lines.join("\n"),i=e.getValueInRange(n,d.EndOfLinePreference.LF);o!==i&&r.push(l.EditOperation.replaceMove(n,o))},e.prototype._runPreparedSnippetForPrimarySelection=function(t,n){var r=this,o=this._editor.getModel().getAlternativeVersionId(),i=[];e._addCommandForSnippet(this._editor.getModel(),t.adaptedSnippet,t.typeRange,i),i.length>0&&(n&&this._editor.pushUndoStop(),this._editor.executeEdits("editor.contrib.insertSnippetHelper",i),n&&this._editor.pushUndoStop());var l=e._getSnippetCursorOnly(t.adaptedSnippet);l?this._editor.setSelection(new a.Selection(l.lineNumber,l.column,l.lineNumber,l.column)):t.adaptedSnippet.placeHolders.length>0&&(this._inSnippetMode.set(!0),this._currentController=new m(this._editor,t.adaptedSnippet,t.typeRange.startLineNumber,o,function(){r._inSnippetMode.reset()}))},e.prototype._runForAllSelections=function(t,n,r,o){for(var i=this._editor.getSelections(),l=[],s=0;s<i.length;s++){var a=e._prepareSnippet(this._editor,i[s],t,n,r,o);e._addCommandForSnippet(this._editor.getModel(),a.adaptedSnippet,a.typeRange,l)}l.length>0&&(this._editor.pushUndoStop(),this._editor.executeEdits("editor.contrib.insertSnippetHelper",l),this._editor.pushUndoStop())},e._prepareSnippet=function(t,n,r,i,l,s){void 0===s&&(s=!0);var a=t.getModel(),d=e._getTypeRangeForSelection(a,n,i,l);if(1===r.lines.length){var c=a.getLineContent(d.endLineNumber).substr(d.endColumn-1),p=r.lines[0].substr(i),h=o.commonPrefixLength(c,p);h>0&&s&&(d=d.setEndPosition(d.endLineNumber,d.endColumn+h))}var u=e._getAdaptedSnippet(a,r,d);return{typeRange:d,adaptedSnippet:u}},e._getSnippetCursorOnly=function(e){if(1!==e.placeHolders.length)return null;var t=e.placeHolders[0];if(""!==t.value||1!==t.occurences.length)return null;var n=t.occurences[0];return s.Range.isEmpty(n)?{lineNumber:n.startLineNumber,column:n.startColumn}:null},e.prototype.jumpToNextPlaceholder=function(){this._currentController&&this._currentController.onNextPlaceHolder()},e.prototype.jumpToPrevPlaceholder=function(){this._currentController&&this._currentController.onPrevPlaceHolder()},e.prototype.acceptSnippet=function(){this._currentController&&this._currentController.onAccept()},e.prototype.leaveSnippet=function(){this._currentController&&this._currentController.onEscape()},e.ID="editor.contrib.snippetController",e=__decorate([__param(1,i.IKeybindingService)],e)}();t.CONTEXT_SNIPPET_MODE="inSnippetMode";var v=c.CommonEditorRegistry.commandWeight(30);c.CommonEditorRegistry.registerEditorContribution(f),c.CommonEditorRegistry.registerEditorCommand("jumpToNextSnippetPlaceholder",v,{primary:r.KeyCode.Tab},!0,t.CONTEXT_SNIPPET_MODE,function(e,t,n){h(t).jumpToNextPlaceholder()}),c.CommonEditorRegistry.registerEditorCommand("jumpToPrevSnippetPlaceholder",v,{primary:r.KeyMod.Shift|r.KeyCode.Tab},!0,t.CONTEXT_SNIPPET_MODE,function(e,t,n){h(t).jumpToPrevPlaceholder()}),c.CommonEditorRegistry.registerEditorCommand("acceptSnippet",v,{primary:r.KeyCode.Enter},!0,t.CONTEXT_SNIPPET_MODE,function(e,t,n){h(t).acceptSnippet()}),c.CommonEditorRegistry.registerEditorCommand("leaveSnippet",v,{primary:r.KeyCode.Escape,secondary:[r.KeyMod.Shift|r.KeyCode.Escape]},!0,t.CONTEXT_SNIPPET_MODE,function(e,t,n){h(t).leaveSnippet()})});