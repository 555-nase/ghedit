var __extends=this&&this.__extends||function(t,i){function e(){this.constructor=t}for(var o in i)i.hasOwnProperty(o)&&(t[o]=i[o]);t.prototype=null===i?Object.create(i):(e.prototype=i.prototype,new e)};define(["require","exports","vs/base/common/arrays","vs/base/common/async","vs/base/common/errors","vs/base/common/eventEmitter","vs/base/common/lifecycle","vs/base/common/timer","vs/base/common/winjs.base","vs/editor/common/core/range","vs/editor/common/modes","../common/quickFix","./lightBulpWidget"],function(t,i,e,o,s,r,n,u,a,h,l,c,g){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var p;!function(t){t[t.NOT_ACTIVE=0]="NOT_ACTIVE",t[t.MANUAL_TRIGGER=1]="MANUAL_TRIGGER",t[t.AUTO_TRIGGER=2]="AUTO_TRIGGER"}(p||(p={}));var d=function(t){function i(i,e,o){var s=this;t.call(this),this.editor=i,this.markerService=e,this.onAccept=o,this.quickFixRequestPromise=null,this.lightBulpDecoration=[],this.toDispose=[],this.toLocalDispose=[],this.lightBulp=new g.LightBulpWidget(i,function(t){s.onLightBulpClicked(t)}),this.enableAutoQuckFix=!1,this.autoSuggestDelay=this.editor.getConfiguration().contribInfo.quickSuggestionsDelay,(isNaN(this.autoSuggestDelay)||!this.autoSuggestDelay&&0!==this.autoSuggestDelay||this.autoSuggestDelay>2e3||this.autoSuggestDelay<0)&&(this.autoSuggestDelay=300),this.toDispose.push(this.editor.onDidChangeModel(function(){return s.onModelChanged()})),this.toDispose.push(this.editor.onDidChangeModelMode(function(){return s.onModelChanged()})),this.toDispose.push(l.CodeActionProviderRegistry.onDidChange(this.onModelChanged,this))}return __extends(i,t),i.prototype.onModelChanged=function(){var t=this;return this.cancelDialog(),this.localDispose(),this.lastMarker=null,this.lightBulpPosition=null,this.markers=null,this.updateScheduler=null,!l.CodeActionProviderRegistry.has(this.editor.getModel())||this.editor.getConfiguration().readOnly?void this.setDecoration(null):(this.markerService.onMarkerChanged(this.onMarkerChanged,this,this.toLocalDispose),void this.toLocalDispose.push(this.editor.onDidChangeCursorPosition(function(i){t.onCursorPositionChanged()})))},i.prototype.onLightBulpClicked=function(t){this.triggerDialog(!0,t)},i.prototype.isSimilarMarker=function(t,i){return t?i&&t.owner===i.owner&&t.code===i.code:!i},i.prototype.onMarkerChanged=function(t){var i=this.editor.getModel();if(i){var e=i.uri;if(t.some(function(t){return e.toString()===t.toString()})){var o=this.lastMarker;this.markers=null,this.lastMarker=null;var s=this.findMarker(this.editor.getPosition(),!1);this.isSimilarMarker(s,o)?this.lastMarker=s:this.onCursorPositionChanged()}}},i.prototype.setDecoration=function(t){this.lightBulpPosition=t,this.updateDecoration()},i.prototype.updateDecoration=function(){this.lightBulpPosition&&this.state===p.NOT_ACTIVE?this.lightBulp.show(this.lightBulpPosition):this.lightBulp.hide()},i.prototype.onCursorPositionChanged=function(){var t=this;this.triggerAutoSuggestPromise&&(this.triggerAutoSuggestPromise.cancel(),this.triggerAutoSuggestPromise=null),this.cancelDialog(),this.updateScheduler||(this.updateScheduler=new o.RunOnceScheduler(function(){var i=t.lastMarker,o=t.editor.getPosition();if(i&&h.Range.containsPosition(i,o))return void(t.lightBulpPosition&&t.setDecoration(o));if(t.lastMarker=i=t.findMarker(o,!1),!i)return void t.setDecoration(null);var r=u.start(u.Topic.EDITOR,"quickfix/lighbulp"),n=t.computeFixes(i);n.done(function(s){t.setDecoration(e.isFalsyOrEmpty(s)?null:o),t.triggerAutoSuggest(i),r.stop()},function(i){s.onUnexpectedError(i),t.setDecoration(null),r.stop()})},250),this.toLocalDispose.push(this.updateScheduler)),this.updateScheduler.schedule()},i.prototype.computeFixes=function(t){var i=this.editor.getModel();return l.CodeActionProviderRegistry.has(i)?this.quickFixRequestPromise&&t===this.quickFixRequestPromiseRange?this.quickFixRequestPromise:(this.quickFixRequestPromise&&(this.quickFixRequestPromise.cancel(),this.quickFixRequestPromise=null),this.quickFixRequestPromiseRange=t,this.quickFixRequestPromise=c.getCodeActions(i,h.Range.lift(t)),this.quickFixRequestPromise):a.TPromise.as(null)},i.prototype.getMarkers=function(){if(null!==this.markers)return this.markers;var t=this.editor.getModel();if(t)return this.markers=this.markerService.read({resource:t.uri}).sort(function(t,i){return t.startLineNumber-i.startLineNumber}),this.markers},i.prototype.findMarker=function(t,i){if(this.lastMarker&&h.Range.containsPosition(this.lastMarker,t))return this.lastMarker;for(var o=this.getMarkers(),s=null,r=0,n=t.lineNumber,u=e.findFirst(o,function(t){return t.startLineNumber>=n});u<o.length&&o[u].startLineNumber===n;){var a=o[u];if(a.startColumn<=t.column&&a.endColumn>=t.column)return a;if(i){var l=t.column<a.startColumn?a.startColumn-t.column:t.column-a.endColumn;(!s||l<r)&&(s=a,r=l)}u++}return s},i.prototype.cancelDialog=function(t){return void 0===t&&(t=!1),this.state!==p.NOT_ACTIVE&&(this.state=p.NOT_ACTIVE,t||this.emit("cancel"),this.updateDecoration(),!0)},i.prototype.isAutoSuggest=function(){return this.state===p.AUTO_TRIGGER},i.prototype.triggerAutoSuggest=function(t){var i=this;this.enableAutoQuckFix&&this.state===p.NOT_ACTIVE&&(this.triggerAutoSuggestPromise=a.TPromise.timeout(this.autoSuggestDelay),this.triggerAutoSuggestPromise.then(function(){i.triggerAutoSuggestPromise=null,t===i.lastMarker&&i.triggerDialog(!0,i.editor.getPosition())}))},i.prototype.triggerDialog=function(t,i){var e=this;this.cancelDialog(!1);var o;if(t){if(o=this.findMarker(i,!0),!o)return}else o=this.findMarker(i,!0),o||(o=this.editor.getSelection()),h.Range.containsPosition(o,i)||this.editor.setPosition({lineNumber:o.startLineNumber,column:o.startColumn});var r=u.start(u.Topic.EDITOR,"quickfix/triggerdialog");this.state=t?p.AUTO_TRIGGER:p.MANUAL_TRIGGER,this.updateDecoration(),this.emit("loading",{auto:this.isAutoSuggest()}),this.computeFixes(o).done(function(t){t&&t.length>0?(t.sort(function(t,i){return i.score-t.score}),e.emit("suggest",{fixes:t,range:o,auto:e.isAutoSuggest()})):e.emit("empty",{auto:e.isAutoSuggest()}),r.stop()},function(t){s.onUnexpectedError(t),e.emit("empty",{auto:e.isAutoSuggest()}),r.stop()})},i.prototype.accept=function(t,i){return this.cancelDialog(),!!t&&(this.onAccept(t,i),!0)},i.prototype.localDispose=function(){this.toLocalDispose=n.dispose(this.toLocalDispose),this.quickFixRequestPromise&&(this.quickFixRequestPromise.cancel(),this.quickFixRequestPromise=null)},i.prototype.dispose=function(){this.localDispose(),this.toDispose=n.dispose(this.toDispose),this.emit("destroy",null)},i}(r.EventEmitter);i.QuickFixModel=d});