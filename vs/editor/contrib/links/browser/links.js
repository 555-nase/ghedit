/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)},__decorate=this&&this.__decorate||function(e,t,o,i){var n,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,i);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(s=(r<3?n(s):r>3?n(t,o,s):n(t,o))||s);return r>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}};define(["require","exports","vs/nls","vs/base/common/errors","vs/base/common/keyCodes","vs/base/common/platform","vs/base/common/severity","vs/base/common/uri","vs/base/common/winjs.base","vs/platform/editor/common/editor","vs/platform/message/common/message","vs/editor/common/editorAction","vs/editor/common/editorActionEnablement","vs/editor/common/editorCommon","vs/editor/common/editorCommonExtensions","vs/editor/common/modes","vs/editor/common/services/editorWorkerService","vs/editor/contrib/links/common/links","vs/base/common/lifecycle","vs/editor/browser/editorBrowserExtensions","vs/css!./links"],function(e,t,o,i,n,r,s,c,u,a,d,l,h,p,m,v,g,f,E,y){"use strict";var k=function(){function e(e,t){this.link=e,this.decorationId=t}return e.decoration=function(t){return{range:{startLineNumber:t.range.startLineNumber,startColumn:t.range.startColumn,endLineNumber:t.range.startLineNumber,endColumn:t.range.endColumn},options:e._getOptions(t,!1)}},e._getOptions=function(e,t){var o="";return o+=t?C.CLASS_NAME_ACTIVE:C.CLASS_NAME,{stickiness:p.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,inlineClassName:o,hoverMessage:C.HOVER_MESSAGE_GENERAL}},e.prototype.activate=function(t){t.changeDecorationOptions(this.decorationId,e._getOptions(this.link,!0))},e.prototype.deactivate=function(t){t.changeDecorationOptions(this.decorationId,e._getOptions(this.link,!1))},e}(),C=function(){function e(e,t,o,i){var n=this;this.editor=e,this.editorService=t,this.messageService=o,this.editorWorkerService=i,this.listenersToRemove=[],this.listenersToRemove.push(e.onDidChangeModelContent(function(e){return n.onChange()})),this.listenersToRemove.push(e.onDidChangeModel(function(e){return n.onModelChanged()})),this.listenersToRemove.push(e.onDidChangeModelMode(function(e){return n.onModelModeChanged()})),this.listenersToRemove.push(v.LinkProviderRegistry.onDidChange(function(e){return n.onModelModeChanged()})),this.listenersToRemove.push(this.editor.onMouseUp(function(e){return n.onEditorMouseUp(e)})),this.listenersToRemove.push(this.editor.onMouseMove(function(e){return n.onEditorMouseMove(e)})),this.listenersToRemove.push(this.editor.onKeyDown(function(e){return n.onEditorKeyDown(e)})),this.listenersToRemove.push(this.editor.onKeyUp(function(e){return n.onEditorKeyUp(e)})),this.timeoutPromise=null,this.computePromise=null,this.currentOccurences={},this.activeLinkDecorationId=null,this.beginCompute()}return e.get=function(t){return t.getContribution(e.ID)},e.prototype.getId=function(){return e.ID},e.prototype.isComputing=function(){return u.TPromise.is(this.computePromise)},e.prototype.onModelChanged=function(){this.lastMouseEvent=null,this.currentOccurences={},this.activeLinkDecorationId=null,this.stop(),this.beginCompute()},e.prototype.onModelModeChanged=function(){this.stop(),this.beginCompute()},e.prototype.onChange=function(){var t=this;this.timeoutPromise||(this.timeoutPromise=u.TPromise.timeout(e.RECOMPUTE_TIME),this.timeoutPromise.then(function(){t.timeoutPromise=null,t.beginCompute()}))},e.prototype.beginCompute=function(){var e=this;this.editor.getModel()&&v.LinkProviderRegistry.has(this.editor.getModel())&&(this.computePromise=f.getLinks(this.editor.getModel()).then(function(t){e.updateDecorations(t),e.computePromise=null}))},e.prototype.updateDecorations=function(e){var t=this;this.editor.changeDecorations(function(o){for(var i=[],n=Object.keys(t.currentOccurences),r=0,s=n.length;r<s;r++){var c=n[r],u=t.currentOccurences[c];i.push(u.decorationId)}var a=[];if(e)for(var d=0;d<e.length;d++)a.push(k.decoration(e[d]));var l=o.deltaDecorations(i,a);t.currentOccurences={},t.activeLinkDecorationId=null;for(var h=0,s=l.length;h<s;h++){var p=new k(e[h],l[h]);t.currentOccurences[p.decorationId]=p}})},e.prototype.onEditorKeyDown=function(t){t.keyCode===e.TRIGGER_KEY_VALUE&&this.lastMouseEvent&&this.onEditorMouseMove(this.lastMouseEvent,t)},e.prototype.onEditorKeyUp=function(t){t.keyCode===e.TRIGGER_KEY_VALUE&&this.cleanUpActiveLinkDecoration()},e.prototype.onEditorMouseMove=function(e,t){var o=this;if(this.lastMouseEvent=e,this.isEnabled(e,t)){this.cleanUpActiveLinkDecoration();var i=this.getLinkOccurence(e.target.position);i&&this.editor.changeDecorations(function(e){i.activate(e),o.activeLinkDecorationId=i.decorationId})}else this.cleanUpActiveLinkDecoration()},e.prototype.cleanUpActiveLinkDecoration=function(){if(this.activeLinkDecorationId){var e=this.currentOccurences[this.activeLinkDecorationId];e&&this.editor.changeDecorations(function(t){e.deactivate(t)}),this.activeLinkDecorationId=null}},e.prototype.onEditorMouseUp=function(e){if(this.isEnabled(e)){var t=this.getLinkOccurence(e.target.position);t&&this.openLinkOccurence(t,e.event.altKey)}},e.prototype.openLinkOccurence=function(e,t){if(this.editorService){var n=e.link,r=n.url,u=r.indexOf("#"),a=-1,d=-1;if(u>=0){var l=r.substr(u+1),h=l.split(",");h.length>0&&(a=Number(h[0])),h.length>1&&(d=Number(h[1])),(a>=0||d>=0)&&(r=r.substr(0,u))}var p;try{p=c["default"].parse(r)}catch(m){return void this.messageService.show(s["default"].Warning,o.localize("invalid.url","Invalid URI: cannot open {0}",r))}var v={resource:p};a>=0&&(v.options={selection:{startLineNumber:a,startColumn:d}}),this.editorService.openEditor(v,t).done(null,i.onUnexpectedError)}},e.prototype.getLinkOccurence=function(e){for(var t=this.editor.getModel().getDecorationsInRange({startLineNumber:e.lineNumber,startColumn:e.column,endLineNumber:e.lineNumber,endColumn:e.column},null,!0),o=0;o<t.length;o++){var i=t[o],n=this.currentOccurences[i.id];if(n)return n}return null},e.prototype.isEnabled=function(t,o){return t.target.type===p.MouseTargetType.CONTENT_TEXT&&(t.event[e.TRIGGER_MODIFIER]||o&&o.keyCode===e.TRIGGER_KEY_VALUE)},e.prototype.stop=function(){this.timeoutPromise&&(this.timeoutPromise.cancel(),this.timeoutPromise=null),this.computePromise&&(this.computePromise.cancel(),this.computePromise=null)},e.prototype.dispose=function(){this.listenersToRemove=E.dispose(this.listenersToRemove),this.stop()},e.ID="editor.linkDetector",e.RECOMPUTE_TIME=1e3,e.TRIGGER_KEY_VALUE=r.isMacintosh?n.KeyCode.Meta:n.KeyCode.Ctrl,e.TRIGGER_MODIFIER=r.isMacintosh?"metaKey":"ctrlKey",e.HOVER_MESSAGE_GENERAL=r.isMacintosh?o.localize("links.navigate.mac","Cmd + click to follow link"):o.localize("links.navigate","Ctrl + click to follow link"),e.CLASS_NAME="detected-link",e.CLASS_NAME_ACTIVE="detected-link-active",e=__decorate([__param(1,a.IEditorService),__param(2,d.IMessageService),__param(3,g.IEditorWorkerService)],e)}(),M=function(e){function t(t,o){e.call(this,t,o,h.Behaviour.WidgetFocus|h.Behaviour.UpdateOnCursorPositionChange)}return __extends(t,e),t.prototype.dispose=function(){e.prototype.dispose.call(this)},t.prototype.getEnablementState=function(){return!!C.get(this.editor).isComputing()||!!C.get(this.editor).getLinkOccurence(this.editor.getPosition())},t.prototype.run=function(){var e=C.get(this.editor).getLinkOccurence(this.editor.getPosition());return e&&C.get(this.editor).openLinkOccurence(e,!1),u.TPromise.as(null)},t.ID="editor.action.openLink",t}(l.EditorAction);m.CommonEditorRegistry.registerEditorAction(new m.EditorActionDescriptor(M,M.ID,o.localize("label","Open Link"),(void 0),"Open Link")),y.EditorBrowserRegistry.registerEditorContribution(C)});