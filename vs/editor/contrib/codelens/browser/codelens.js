/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate=this&&this.__decorate||function(e,t,o,n){var i,s=arguments.length,r=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,o,n);else for(var d=e.length-1;d>=0;d--)(i=e[d])&&(r=(s<3?i(r):s>3?i(t,o,r):i(t,o))||r);return s>3&&r&&Object.defineProperty(t,o,r),r},__param=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};define(["require","exports","vs/base/common/async","vs/base/common/errors","vs/base/common/lifecycle","vs/base/common/severity","vs/base/common/strings","vs/base/common/winjs.base","vs/base/browser/dom","vs/platform/commands/common/commands","vs/platform/message/common/message","vs/editor/common/core/range","vs/editor/common/editorCommon","vs/editor/common/modes","vs/editor/common/services/modelService","vs/editor/browser/editorBrowser","vs/editor/browser/editorBrowserExtensions","../common/codelens","vs/css!./codelens"],function(e,t,o,n,i,s,r,d,a,c,l,h,u,m,_,p,g,f){"use strict";function v(e,t){for(var o=1,n=e.getModels().filter(function(e){return e.getMode().getId()===t}).map(function(e){return{url:e.uri.toString(),versionId:e.getVersionId()}}).sort(function(e,t){return e.url<t.url?-1:e.url>t.url?1:0}),i=0;i<n.length;i++)o=(31*o|0)+n[i].versionId|0;return o}var b=function(){function e(e){this.afterLineNumber=e,this.heightInLines=1,this.suppressMouseDown=!0,this.domNode=document.createElement("div")}return e.prototype.setAfterLineNumber=function(e){this.afterLineNumber=e},e}(),y=function(){function e(t,o,n,i){var r=this;this._commands=Object.create(null),this._id="codeLensWidget"+ ++e.ID,this._editor=t,this.setSymbolRange(o),this._domNode=document.createElement("span"),this._domNode.style.height=t.getConfiguration().lineHeight+"px",this._domNode.innerHTML="&nbsp;",a.addClass(this._domNode,"codelens-decoration"),a.addClass(this._domNode,"invisible-cl"),this._subscription=a.addDisposableListener(this._domNode,"click",function(e){var o=e.target;if("A"===o.tagName&&o.id){var d=r._commands[o.id];d&&(t.focus(),n.executeCommand.apply(n,[d.id].concat(d.arguments)).done(void 0,function(e){i.show(s["default"].Error,e)}))}}),this.updateVisibility()}return e.prototype.dispose=function(){this._subscription.dispose(),this._symbolRange=null},e.prototype.updateVisibility=function(){this.isVisible()&&(a.removeClass(this._domNode,"invisible-cl"),a.addClass(this._domNode,"fadein"))},e.prototype.withCommands=function(e){if(this._commands=Object.create(null),!e||!e.length)return void(this._domNode.innerHTML="no commands");for(var t=[],o=0;o<e.length;o++){var n=e[o].command,i=void 0;n.id?(i=r.format("<a id={0}>{1}</a>",o,n.title),this._commands[o]=n):i=r.format("<span>{0}</span>",n.title),t.push(i)}this._domNode.innerHTML=t.join("<span>&nbsp;|&nbsp;</span>"),this._editor.layoutContentWidget(this)},e.prototype.getId=function(){return this._id},e.prototype.getDomNode=function(){return this._domNode},e.prototype.setSymbolRange=function(e){this._symbolRange=e;var t=e.startLineNumber,o=this._editor.getModel().getLineFirstNonWhitespaceColumn(t);this._widgetPosition={position:{lineNumber:t,column:o},preference:[p.ContentWidgetPositionPreference.ABOVE]}},e.prototype.getPosition=function(){return this._widgetPosition},e.prototype.isVisible=function(){return this._domNode.hasAttribute("monaco-visible-content-widget")},e.ID=0,e}(),C=function(){function e(){this._removeDecorations=[],this._addDecorations=[],this._addDecorationsCallbacks=[]}return e.prototype.addDecoration=function(e,t){this._addDecorations.push(e),this._addDecorationsCallbacks.push(t)},e.prototype.removeDecoration=function(e){this._removeDecorations.push(e)},e.prototype.commit=function(e){for(var t=e.deltaDecorations(this._removeDecorations,this._addDecorations),o=0,n=t.length;o<n;o++)this._addDecorationsCallbacks[o](t[o])},e}(),D=function(){function e(e,t,o,n,i,s){var r=this;this._editor=t,this._data=e,this._decorationIds=new Array(this._data.length);var d;this._data.forEach(function(e,t){o.addDecoration({range:e.symbol.range,options:{}},function(e){return r._decorationIds[t]=e});for(var n=0,i=r._data;n<i.length;n++){var s=i[n];d=d?h.Range.plusRange(d,s.symbol.range):s.symbol.range}}),this._viewZone=new b(d.startLineNumber-1),this._contentWidget=new y(t,h.Range.lift(d),i,s),this._viewZoneId=n.addZone(this._viewZone),this._editor.addContentWidget(this._contentWidget),this._lastUpdateModelsVersionId=-1}return e.prototype.dispose=function(e,t){for(;this._decorationIds.length;)e.removeDecoration(this._decorationIds.pop());t&&t.removeZone(this._viewZoneId),this._editor.removeContentWidget(this._contentWidget),this._contentWidget.dispose()},e.prototype.isValid=function(){var e=this;return this._decorationIds.some(function(t){var o=e._editor.getModel().getDecorationRange(t);return o&&!o.isEmpty()})},e.prototype.updateCodeLensSymbols=function(e,t){for(var o=this;this._decorationIds.length;)t.removeDecoration(this._decorationIds.pop());this._data=e,this._decorationIds=new Array(this._data.length),this._data.forEach(function(e,n){t.addDecoration({range:e.symbol.range,options:{}},function(e){return o._decorationIds[n]=e})})},e.prototype.computeIfNecessary=function(e,t){if(this._contentWidget.updateVisibility(),!this._contentWidget.isVisible())return null;if(this._lastUpdateModelsVersionId===e)return null;for(var o=0;o<this._decorationIds.length;o++)this._data[o].symbol.range=t.getDecorationRange(this._decorationIds[o]);return this._data},e.prototype.updateCommands=function(e,t){this._contentWidget.withCommands(e),this._lastUpdateModelsVersionId=t},e.prototype.getLineNumber=function(){var e=this._editor.getModel().getDecorationRange(this._decorationIds[0]);return e?e.startLineNumber:-1},e.prototype.update=function(e){if(this.isValid()){var t=this._editor.getModel().getDecorationRange(this._decorationIds[0]);this._viewZone.setAfterLineNumber(t.startLineNumber-1),e.layoutZone(this._viewZoneId),this._contentWidget.setSymbolRange(t),this._editor.layoutContentWidget(this._contentWidget)}},e}(),L=function(){function e(e,t,o,n){var i=this;this._editor=e,this._modelService=t,this._commandService=o,this._messageService=n,this._isEnabled=this._editor.getConfiguration().contribInfo.referenceInfos,this._globalToDispose=[],this._localToDispose=[],this._lenses=[],this._currentFindCodeLensSymbolsPromise=null,this._modelChangeCounter=0,this._globalToDispose.push(this._editor.onDidChangeModel(function(){return i.onModelChange()})),this._globalToDispose.push(this._editor.onDidChangeModelMode(function(){return i.onModelChange()})),this._globalToDispose.push(this._editor.onDidChangeConfiguration(function(e){var t=i._isEnabled;i._isEnabled=i._editor.getConfiguration().contribInfo.referenceInfos,t!==i._isEnabled&&i.onModelChange()})),this._globalToDispose.push(m.CodeLensProviderRegistry.onDidChange(this.onModelChange,this)),this.onModelChange()}return e.prototype.dispose=function(){this.localDispose(),this._globalToDispose=i.dispose(this._globalToDispose)},e.prototype.localDispose=function(){this._currentFindCodeLensSymbolsPromise&&(this._currentFindCodeLensSymbolsPromise.cancel(),this._currentFindCodeLensSymbolsPromise=null,this._modelChangeCounter++),this._currentFindOccPromise&&(this._currentFindOccPromise.cancel(),this._currentFindOccPromise=null),this._localToDispose=i.dispose(this._localToDispose)},e.prototype.getId=function(){return e.ID},e.prototype.onModelChange=function(){var e=this;this.localDispose();var t=this._editor.getModel();if(t&&this._isEnabled&&m.CodeLensProviderRegistry.has(t)){var i=new o.RunOnceScheduler(function(){e._onViewportChanged(t.getMode().getId())},500),s=new o.RunOnceScheduler(function(){e._currentFindCodeLensSymbolsPromise&&e._currentFindCodeLensSymbolsPromise.cancel(),e._currentFindCodeLensSymbolsPromise=f.getCodeLensData(t);var o=++e._modelChangeCounter;e._currentFindCodeLensSymbolsPromise.then(function(t){o===e._modelChangeCounter&&(e.renderCodeLensSymbols(t),i.schedule())},function(e){n.onUnexpectedError(e)})},250);this._localToDispose.push(s),this._localToDispose.push(i),this._localToDispose.push(t.addBulkListener(function(t){for(var o=!1,n=0;n<t.length;n++){var r=t[n].getType();if(r===u.EventType.ModelRawContentChanged){o=!0;break}}o&&(e._editor.changeDecorations(function(t){e._editor.changeViewZones(function(o){var n=[];e._lenses.forEach(function(e){e.isValid()?e.update(o):n.push(e)});var i=new C;n.forEach(function(t){t.dispose(i,o),e._lenses.splice(e._lenses.indexOf(t),1)}),i.commit(t)})}),i.schedule(),s.schedule())})),this._localToDispose.push(this._editor.onDidScrollChange(function(e){e.scrollTopChanged&&i.schedule()})),this._localToDispose.push({dispose:function(){e._editor.getModel()?e._editor.changeDecorations(function(t){e._editor.changeViewZones(function(o){e._disposeAllLenses(t,o)})}):e._disposeAllLenses(null,null)}}),s.schedule()}},e.prototype._disposeAllLenses=function(e,t){var o=new C;this._lenses.forEach(function(e){return e.dispose(o,t)}),e&&o.commit(e),this._lenses=[]},e.prototype.renderCodeLensSymbols=function(e){var t=this;if(this._editor.getModel()){e=e?e.sort(function(e,t){return h.Range.compareRangesUsingStarts(h.Range.lift(e.symbol.range),h.Range.lift(t.symbol.range))}):[];for(var o,n=this._editor.getModel().getLineCount(),i=[],s=0,r=e;s<r.length;s++){var d=r[s],a=d.symbol.range.startLineNumber;a<1||a>=n||(o&&o[o.length-1].symbol.range.startLineNumber===a?o.push(d):(o=[d],i.push(o)))}var c=this._editor.getCenteredRangeInViewport(),l=i.length!==this._lenses.length&&0!==this._editor.getScrollTop();this._editor.changeDecorations(function(e){t._editor.changeViewZones(function(o){for(var n=0,s=0,r=new C;s<i.length&&n<t._lenses.length;){var d=i[s][0].symbol.range.startLineNumber,a=t._lenses[n].getLineNumber();a<d?(t._lenses[n].dispose(r,o),t._lenses.splice(n,1)):a===d?(t._lenses[n].updateCodeLensSymbols(i[s],r),s++,n++):(t._lenses.splice(n,0,new D(i[s],t._editor,r,o,t._commandService,t._messageService)),n++,s++)}for(;n<t._lenses.length;)t._lenses[n].dispose(r,o),t._lenses.splice(n,1);for(;s<i.length;)t._lenses.push(new D(i[s],t._editor,r,o,t._commandService,t._messageService)),s++;r.commit(e)})}),l&&this._editor.revealRangeInCenter(c)}},e.prototype._onViewportChanged=function(e){var t=this;this._currentFindOccPromise&&(this._currentFindOccPromise.cancel(),this._currentFindOccPromise=null);var n=this._editor.getModel();if(n){var i=v(this._modelService,e),s=[],r=[];if(this._lenses.forEach(function(e){var t=e.computeIfNecessary(i,n);t&&(s.push(t),r.push(e))}),0!==s.length){var a=s.map(function(e,t){var s=new Array(e.length),a=e.map(function(e,t){return o.asWinJsPromise(function(t){return e.support.resolveCodeLens(n,e.symbol,t)}).then(function(e){s[t]=e})});return d.TPromise.join(a).then(function(){r[t].updateCommands(s,i)})});this._currentFindOccPromise=d.TPromise.join(a).then(function(){t._currentFindOccPromise=null})}}},e.ID="css.editor.codeLens",e=__decorate([__param(1,_.IModelService),__param(2,c.ICommandService),__param(3,l.IMessageService)],e)}();t.CodeLensContribution=L,g.EditorBrowserRegistry.registerEditorContribution(L)});