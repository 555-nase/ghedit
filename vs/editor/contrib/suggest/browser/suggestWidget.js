/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate=this&&this.__decorate||function(t,e,i,s){var o,n=arguments.length,l=n<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(t,e,i,s);else for(var a=t.length-1;a>=0;a--)(o=t[a])&&(l=(n<3?o(l):n>3?o(e,i,l):o(e,i))||l);return n>3&&l&&Object.defineProperty(e,i,l),l},__param=this&&this.__param||function(t,e){return function(i,s){e(i,s,t)}};define(["require","exports","vs/nls","vs/base/common/strings","vs/base/common/winjs.base","vs/base/common/errors","vs/base/common/lifecycle","vs/base/browser/dom","vs/base/browser/ui/highlightedlabel/highlightedLabel","vs/base/browser/ui/list/listWidget","vs/base/browser/ui/scrollbar/scrollableElement","vs/platform/instantiation/common/instantiation","vs/platform/keybinding/common/keybinding","vs/editor/browser/editorBrowser","../common/suggest","vs/base/browser/ui/aria/aria","vs/platform/telemetry/common/telemetry","vs/css!./suggest"],function(t,e,i,s,o,n,l,a,r,u,h,d,c,g,p,m,f){"use strict";function b(t,e,i){for(var s=t.toLowerCase(),o=0,n=0;n<e.length&&n<t.length;n++)if(e[n]===t[n])o+=2;else{if(i[n]!==s[n])break;o+=1}return o}var y,v=/^(#([\da-f]{3}){1,2}|(rgb|hsl)a\(\s*(\d{1,3}%?\s*,\s*){3}(1|0?\.\d+)\)|(rgb|hsl)\(\s*\d{1,3}%?(\s*,\s*\d{1,3}%?){2}\s*\))$/i,D=function(){function t(t,e,i){this.widget=t,this.editor=e;var s=i.lookupKeybindings("editor.action.triggerSuggest");this.triggerKeybindingLabel=0===s.length?"":" ("+i.getLabelFor(s[0])+")"}return Object.defineProperty(t.prototype,"templateId",{get:function(){return"suggestion"},enumerable:!0,configurable:!0}),t.prototype.renderTemplate=function(t){var e=this,s=Object.create(null);s.disposables=[],s.root=t,s.icon=a.append(t,a.emmet(".icon")),s.colorspan=a.append(s.icon,a.emmet("span.colorspan"));var o=a.append(t,a.emmet(".text")),n=a.append(o,a.emmet(".main"));s.highlightedLabel=new r.HighlightedLabel(n),s.disposables.push(s.highlightedLabel),s.typeLabel=a.append(n,a.emmet("span.type-label"));var l=a.append(o,a.emmet(".docs"));s.documentation=a.append(l,a.emmet("span.docs-text")),s.documentationDetails=a.append(l,a.emmet("span.docs-details.octicon.octicon-info")),s.documentationDetails.title=i.localize("readMore","Read More...{0}",this.triggerKeybindingLabel);var u=function(){var t=e.editor.getConfiguration().fontInfo;n.style.fontFamily=t.fontFamily};return u(),s.disposables.push(this.editor.onDidChangeConfiguration(function(t){t.fontInfo&&u()})),s},t.prototype.renderElement=function(t,e,s){var o=this,n=s,l=t.suggestion;if(l.documentationLabel?n.root.setAttribute("aria-label",i.localize("suggestionWithDetailsAriaLabel","{0}, suggestion, has details",l.label)):n.root.setAttribute("aria-label",i.localize("suggestionAriaLabel","{0}, suggestion",l.label)),n.icon.className="icon "+l.type,n.colorspan.style.backgroundColor="","color"===l.type){var r=l.label.match(v)&&l.label||l.documentationLabel.match(v)&&l.documentationLabel;r&&(n.icon.className="icon customcolor",n.colorspan.style.backgroundColor=r)}n.highlightedLabel.set(l.label,t.highlights),n.typeLabel.textContent=l.typeLabel||"",n.documentation.textContent=l.documentationLabel||"",l.documentationLabel?(a.show(n.documentationDetails),n.documentationDetails.onmousedown=function(t){t.stopPropagation(),t.preventDefault()},n.documentationDetails.onclick=function(t){t.stopPropagation(),t.preventDefault(),o.widget.toggleDetails()}):(a.hide(n.documentationDetails),n.documentationDetails.onmousedown=null,n.documentationDetails.onclick=null)},t.prototype.disposeTemplate=function(t){t.highlightedLabel.dispose(),t.disposables=l.dispose(t.disposables)},t=__decorate([__param(2,c.IKeybindingService)],t)}(),S=35,w=19,L=function(){function t(t){this.listProvider=t}return t.prototype.getHeight=function(t){var e=this.listProvider().getFocusedElements()[0];return t.suggestion.documentationLabel&&t===e?S:w},t.prototype.getTemplateId=function(t){return"suggestion"},t}();!function(t){t[t.Hidden=0]="Hidden",t[t.Loading=1]="Loading",t[t.Empty=2]="Empty",t[t.Open=3]="Open",t[t.Frozen=4]="Frozen",t[t.Details=5]="Details"}(y||(y={}));var A=function(){function t(t,e,s){var o=this;this.widget=e,this.editor=s,this.disposables=[],this.el=a.append(t,a.emmet(".details")),this.disposables.push(l.toDisposable(function(){return t.removeChild(o.el)}));var n=a.append(this.el,a.emmet(".header"));this.title=a.append(n,a.emmet("span.title")),this.back=a.append(n,a.emmet("span.go-back.octicon.octicon-mail-reply")),this.back.title=i.localize("goback","Go back"),this.body=a.emmet(".body"),this.scrollbar=new h.DomScrollableElement(this.body,{canUseTranslate3d:!1}),a.append(this.el,this.scrollbar.getDomNode()),this.disposables.push(this.scrollbar),this.type=a.append(this.body,a.emmet("p.type")),this.docs=a.append(this.body,a.emmet("p.docs")),this.ariaLabel=null,this.configureFont(),this.disposables.push(this.editor.onDidChangeConfiguration(function(t){t.fontInfo&&o.configureFont()}))}return Object.defineProperty(t.prototype,"element",{get:function(){return this.el},enumerable:!0,configurable:!0}),t.prototype.render=function(t){var e=this;return t?(this.title.innerText=t.suggestion.label,this.type.innerText=t.suggestion.typeLabel||"",this.docs.innerText=t.suggestion.documentationLabel,this.back.onmousedown=function(t){t.preventDefault(),t.stopPropagation()},this.back.onclick=function(t){t.preventDefault(),t.stopPropagation(),e.widget.toggleDetails()},this.scrollbar.scanDomNode(),void(this.ariaLabel=s.format("{0}\n{1}\n{2}",t.suggestion.label||"",t.suggestion.typeLabel||"",t.suggestion.documentationLabel||""))):(this.title.textContent="",this.type.textContent="",this.docs.textContent="",void(this.ariaLabel=null))},t.prototype.getAriaLabel=function(){return this.ariaLabel},t.prototype.scrollDown=function(t){void 0===t&&(t=8),this.body.scrollTop+=t},t.prototype.scrollUp=function(t){void 0===t&&(t=8),this.body.scrollTop-=t},t.prototype.pageDown=function(){this.scrollDown(80)},t.prototype.pageUp=function(){this.scrollUp(80)},t.prototype.configureFont=function(){var t=this.editor.getConfiguration().fontInfo;this.title.style.fontFamily=t.fontFamily,this.type.style.fontFamily=t.fontFamily},t.prototype.dispose=function(){this.disposables=l.dispose(this.disposables)},t}(),E=function(){function t(e,i,s,o,n){var l=this;this.editor=e,this.model=i,this.telemetryService=s,this.allowEditorOverflow=!0,this.isAuto=!1,this.focusedItem=null,this.element=a.emmet(".editor-widget.suggest-widget.monaco-editor-background"),this.element.style.width=t.WIDTH+"px",this.element.style.top="0",this.element.style.left="0",this.editor.getConfiguration().contribInfo.iconsInSuggestions||a.addClass(this.element,"no-icons"),this.messageElement=a.append(this.element,a.emmet(".message")),this.listElement=a.append(this.element,a.emmet(".tree")),this.details=new A(this.element,this,this.editor);var r=n.createInstance(D,this,this.editor);this.delegate=new L(function(){return l.list}),this.list=new u.List(this.listElement,this.delegate,[r],{useShadows:!1}),this.toDispose=[e.onDidBlurEditorText(function(){return l.onEditorBlur()}),this.list.onSelectionChange(function(t){return l.onListSelection(t)}),this.list.onFocusChange(function(t){return l.onListFocus(t)}),this.editor.onDidChangeCursorSelection(function(){return l.onCursorSelectionChanged()}),this.model.onDidTrigger(function(t){return l.onDidTrigger(t)}),this.model.onDidSuggest(function(t){return l.onDidSuggest(t)}),this.model.onDidCancel(function(t){return l.onDidCancel(t)})],this.suggestWidgetVisible=o.createKey(p.Context.Visible,!1),this.suggestWidgetMultipleSuggestions=o.createKey(p.Context.MultipleSuggestions,!1),this.suggestionSupportsAutoAccept=o.createKey(p.Context.AcceptOnKey,!0),this.editor.addContentWidget(this),this.setState(y.Hidden)}return t.prototype.onCursorSelectionChanged=function(){this.state!==y.Hidden&&this.editor.layoutContentWidget(this)},t.prototype.onEditorBlur=function(){var t=this;this.editorBlurTimeout=o.TPromise.timeout(150).then(function(){t.editor.isFocused()||t.setState(y.Hidden)})},t.prototype.onListSelection=function(t){if(t.elements.length){var e=t.elements[0],s=e.container,o="undefined"==typeof e.suggestion.overwriteBefore?s.currentWord.length:e.suggestion.overwriteBefore,n="undefined"==typeof e.suggestion.overwriteAfter?0:Math.max(0,e.suggestion.overwriteAfter);this.model.accept(e.suggestion,o,n),m.alert(i.localize("suggestionAriaAccepted","{0}, accepted",e.suggestion.label)),this.editor.focus()}},t.prototype._getSuggestionAriaAlertLabel=function(t){return t.suggestion.documentationLabel?i.localize("ariaCurrentSuggestionWithDetails","{0}, suggestion, has details",t.suggestion.label):i.localize("ariaCurrentSuggestion","{0}, suggestion",t.suggestion.label)},t.prototype._ariaAlert=function(t){this._lastAriaAlertLabel!==t&&(this._lastAriaAlertLabel=t,this._lastAriaAlertLabel&&m.alert(this._lastAriaAlertLabel))},t.prototype.onListFocus=function(t){var e=this;if(!t.elements.length)return this.currentSuggestionDetails&&(this.currentSuggestionDetails.cancel(),this.currentSuggestionDetails=null,this.focusedItem=null),void this._ariaAlert(null);var i=t.elements[0];if(this._ariaAlert(this._getSuggestionAriaAlertLabel(i)),i!==this.focusedItem){this.currentSuggestionDetails&&(this.currentSuggestionDetails.cancel(),this.currentSuggestionDetails=null);var s=t.indexes[0];this.suggestionSupportsAutoAccept.set(!i.suggestion.noAutoAccept),this.focusedItem=i,this.updateWidgetHeight(),this.list.reveal(s);var o=this.model.getRequestPosition()||this.editor.getPosition();this.currentSuggestionDetails=i.resolveDetails(this.editor.getModel(),o).then(function(t){i.updateDetails(t),e.list.setFocus(s),e.updateWidgetHeight(),e.list.reveal(s),e._ariaAlert(e._getSuggestionAriaAlertLabel(i))}).then(null,function(t){return!n.isPromiseCanceledError(t)&&n.onUnexpectedError(t)}).then(function(){return e.currentSuggestionDetails=null})}},t.prototype.setState=function(e){if(this.element){var i=this.state!==e;switch(this.state=e,a.toggleClass(this.element,"frozen",e===y.Frozen),e){case y.Hidden:a.hide(this.messageElement,this.details.element),a.show(this.listElement),this.hide(),i&&this.list.splice(0,this.list.length);break;case y.Loading:this.messageElement.innerText=t.LOADING_MESSAGE,a.hide(this.listElement,this.details.element),a.show(this.messageElement),this.show();break;case y.Empty:this.messageElement.innerText=t.NO_SUGGESTIONS_MESSAGE,a.hide(this.listElement,this.details.element),a.show(this.messageElement),this.show();break;case y.Open:a.hide(this.messageElement,this.details.element),a.show(this.listElement),this.show();break;case y.Frozen:a.hide(this.messageElement,this.details.element),a.show(this.listElement),this.show();break;case y.Details:a.hide(this.messageElement,this.listElement),a.show(this.details.element),this.show(),this._ariaAlert(this.details.getAriaLabel())}i&&this.editor.layoutContentWidget(this)}},t.prototype.onDidTrigger=function(t){var e=this;this.state===y.Hidden&&(this.isAuto=!!t.auto,this.isAuto||(this.loadingTimeout=setTimeout(function(){e.loadingTimeout=null,e.setState(y.Loading)},50)))},t.prototype.onDidSuggest=function(t){if(this.loadingTimeout&&(clearTimeout(this.loadingTimeout),this.loadingTimeout=null),this.completionModel=t.completionModel,t.isFrozen&&this.state!==y.Empty)return void this.setState(y.Frozen);var e=this.completionModel.items.length,i=0===e;if(this.suggestWidgetMultipleSuggestions.set(e>1),i)t.auto?this.setState(y.Hidden):this.setState(y.Empty),this.completionModel=null;else{var s=t.currentWord,o=s.toLowerCase(),n=-1,l=-1;this.completionModel.items.forEach(function(t,e){var i=b(t.suggestion.label,s,o);i>l&&(l=i,n=e)}),(a=this.list).splice.apply(a,[0,this.list.length].concat(this.completionModel.items)),this.list.setFocus(n),this.list.reveal(n,0),this.setState(y.Open),this.telemetryService.publicLog("suggestWidget",{suggestionCount:e,wasAutomaticallyTriggered:!!t.auto})}var a},t.prototype.onDidCancel=function(t){this.loadingTimeout&&(clearTimeout(this.loadingTimeout),this.loadingTimeout=null),t.retrigger||this.setState(y.Hidden)},t.prototype.selectNextPage=function(){switch(this.state){case y.Hidden:return!1;case y.Details:return this.details.pageDown(),!0;case y.Loading:return!this.isAuto;default:return this.list.focusNextPage(),!0}},t.prototype.selectNext=function(){switch(this.state){case y.Hidden:return!1;case y.Details:return this.details.scrollDown(),!0;case y.Loading:return!this.isAuto;default:return this.list.focusNext(1,!0),!0}},t.prototype.selectPreviousPage=function(){switch(this.state){case y.Hidden:return!1;case y.Details:return this.details.pageUp(),!0;case y.Loading:return!this.isAuto;default:return this.list.focusPreviousPage(),!0}},t.prototype.selectPrevious=function(){switch(this.state){case y.Hidden:return!1;case y.Details:return this.details.scrollUp(),!0;case y.Loading:return!this.isAuto;default:return this.list.focusPrevious(1,!0),!1}},t.prototype.acceptSelectedSuggestion=function(){switch(this.state){case y.Hidden:return!1;case y.Empty:return!1;case y.Loading:return!this.isAuto;default:var t=this.list.getFocusedElements()[0];return t?this.list.setSelection(this.completionModel.items.indexOf(t)):this.model.cancel(),!0}},t.prototype.toggleDetails=function(){if(this.state===y.Details)return this.setState(y.Open),void this.editor.focus();if(this.state===y.Open){var t=this.list.getFocusedElements()[0];t&&t.suggestion.documentationLabel&&(this.setState(y.Details),this.editor.focus())}},t.prototype.show=function(){var t=this;this.updateWidgetHeight(),this.suggestWidgetVisible.set(!0),this.renderDetails(),this.showTimeout=o.TPromise.timeout(100).then(function(){a.addClass(t.element,"visible")})},t.prototype.hide=function(){this.suggestWidgetVisible.reset(),a.removeClass(this.element,"visible")},t.prototype.cancel=function(){this.state===y.Details?this.toggleDetails():this.model.cancel()},t.prototype.getPosition=function(){return this.state===y.Hidden?null:{position:this.editor.getPosition(),preference:[g.ContentWidgetPositionPreference.BELOW,g.ContentWidgetPositionPreference.ABOVE]}},t.prototype.getDomNode=function(){return this.element},t.prototype.getId=function(){return t.ID},t.prototype.updateWidgetHeight=function(){var t=0;if(this.state===y.Empty||this.state===y.Loading)t=w;else if(this.state===y.Details)t=12*w;else{var e=this.list.getFocusedElements()[0],i=e?this.delegate.getHeight(e):w;t=i;var s=(this.list.contentHeight-i)/w;t+=Math.min(s,11)*w}return this.element.style.height=t+"px",this.list.layout(t),this.editor.layoutContentWidget(this),t},t.prototype.renderDetails=function(){this.state!==y.Details?this.details.render(null):this.details.render(this.list.getFocusedElements()[0])},t.prototype.dispose=function(){this.state=null,this.suggestionSupportsAutoAccept=null,this.currentSuggestionDetails=null,this.focusedItem=null,this.element=null,this.messageElement=null,this.listElement=null,this.details.dispose(),this.details=null,this.list.dispose(),this.list=null,this.toDispose=l.dispose(this.toDispose),this.loadingTimeout&&(clearTimeout(this.loadingTimeout),this.loadingTimeout=null),this.editorBlurTimeout&&(this.editorBlurTimeout.cancel(),this.editorBlurTimeout=null),this.showTimeout&&(this.showTimeout.cancel(),this.showTimeout=null)},t.ID="editor.widget.suggestWidget",t.WIDTH=438,t.LOADING_MESSAGE=i.localize("suggestWidget.loading","Loading..."),t.NO_SUGGESTIONS_MESSAGE=i.localize("suggestWidget.noSuggestions","No suggestions."),t=__decorate([__param(2,f.ITelemetryService),__param(3,c.IKeybindingService),__param(4,d.IInstantiationService)],t)}();e.SuggestWidget=E});