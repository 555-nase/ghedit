define(["require","exports","vs/base/common/strings","vs/editor/common/core/editOperation","vs/editor/common/core/position","vs/editor/common/core/range","vs/editor/common/core/selection","./blockCommentCommand","vs/editor/common/modes/languageConfigurationRegistry"],function(e,t,n,o,r,i,m,s,a){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";!function(e){e[e.Toggle=0]="Toggle",e[e.ForceAdd=1]="ForceAdd",e[e.ForceRemove=2]="ForceRemove"}(t.Type||(t.Type={}));var l=t.Type,u=function(){function e(e,t,n){this._selection=e,this._tabSize=t,this._type=n,this._deltaColumn=0}return e._gatherPreflightCommentStrings=function(e,t,n){var o,r,i,m,s,l,u=[],c=Object.create(null);for(i=0,m=n-t+1;i<m;i++){if(s=t+i,l=e.getModeIdAtPosition(s,1),c[l])r=c[l];else{if(o=a.LanguageConfigurationRegistry.getComments(l),r=o?o.lineCommentToken:null,!r)return null;c[l]=r}u.push({ignore:!1,commentStr:r,commentStrOffset:0,commentStrLength:r.length})}return u},e._analyzeLines=function(e,t,o,r){var i,m,a,u,c,d,g,C,f=" ".charCodeAt(0),h=!0;for(g=e===l.Toggle||e!==l.ForceAdd,u=0,c=o.length;u<c;u++)i=o[u],d=r+u,C=t.getLineContent(d),m=n.firstNonWhitespaceIndex(C),m!==-1?(h=!1,i.ignore=!1,i.commentStrOffset=m,g&&!s.BlockCommentCommand._haystackHasNeedleAtOffset(C,i.commentStr,m)&&(e===l.Toggle?g=!1:e===l.ForceAdd||(i.ignore=!0)),g&&(a=m+i.commentStrLength,a<C.length&&C.charCodeAt(a)===f&&(i.commentStrLength+=1))):(e===l.Toggle?i.ignore=!0:e===l.ForceAdd?i.ignore=!0:i.ignore=!0,i.commentStrOffset=C.length);if(e===l.Toggle&&h)for(g=!1,u=0,c=o.length;u<c;u++)o[u].ignore=!1;return{supported:!0,shouldRemoveComments:g,lines:o}},e._gatherPreflightData=function(t,n,o,r){var i=e._gatherPreflightCommentStrings(n,o,r);return null===i?{supported:!1,shouldRemoveComments:!1,lines:null}:e._analyzeLines(t,n,i,o)},e.prototype._executeLineComments=function(t,n,o,i){var m;o.shouldRemoveComments?m=e._createRemoveLineCommentsOperations(o.lines,i.startLineNumber):(e._normalizeInsertionPoint(t,o.lines,i.startLineNumber,this._tabSize),m=e._createAddLineCommentsOperations(o.lines,i.startLineNumber));for(var s=new r.Position(i.positionLineNumber,i.positionColumn),a=0,l=m.length;a<l;a++)n.addEditOperation(m[a].range,m[a].text),m[a].range.isEmpty()&&m[a].range.getStartPosition().equals(s)&&(this._deltaColumn=m[a].text.length);this._selectionId=n.trackSelection(i)},e.prototype._attemptRemoveBlockComment=function(e,t,n,o){var r=t.startLineNumber,i=t.endLineNumber,m=o.length+Math.max(e.getLineFirstNonWhitespaceColumn(t.startLineNumber),t.startColumn),a=e.getLineContent(r).lastIndexOf(n,m-1),l=e.getLineContent(i).indexOf(o,t.endColumn-1-n.length);return a!==-1&&l===-1&&(l=e.getLineContent(r).indexOf(o,a+n.length),i=r),a===-1&&l!==-1&&(a=e.getLineContent(i).lastIndexOf(n,l),r=i),!t.isEmpty()||a!==-1&&l!==-1||(a=e.getLineContent(r).indexOf(n),a!==-1&&(l=e.getLineContent(r).indexOf(o,a+n.length))),a!==-1&&l!==-1?s.BlockCommentCommand._createRemoveBlockCommentOperations({startLineNumber:r,startColumn:a+n.length+1,endLineNumber:i,endColumn:l+1},n,o):null},e.prototype._executeBlockComment=function(e,t,o){var r=e.getModeIdAtPosition(o.startLineNumber,o.startColumn),i=a.LanguageConfigurationRegistry.getComments(r);if(i&&i.blockCommentStartToken&&i.blockCommentEndToken){var m=i.blockCommentStartToken,l=i.blockCommentEndToken,u=this._attemptRemoveBlockComment(e,o,m,l);if(!u){if(o.isEmpty()){var c=e.getLineContent(o.startLineNumber),d=n.firstNonWhitespaceIndex(c);d===-1&&(d=c.length),u=s.BlockCommentCommand._createAddBlockCommentOperations({startLineNumber:o.startLineNumber,startColumn:d+1,endLineNumber:o.startLineNumber,endColumn:c.length+1},m,l)}else u=s.BlockCommentCommand._createAddBlockCommentOperations({startLineNumber:o.startLineNumber,startColumn:e.getLineFirstNonWhitespaceColumn(o.startLineNumber),endLineNumber:o.endLineNumber,endColumn:e.getLineMaxColumn(o.endLineNumber)},m,l);1===u.length&&(this._deltaColumn=m.length)}this._selectionId=t.trackSelection(o);for(var g=0;g<u.length;g++)t.addEditOperation(u[g].range,u[g].text)}},e.prototype.getEditOperations=function(t,n){var o=this._selection;this._moveEndPositionDown=!1,o.startLineNumber<o.endLineNumber&&1===o.endColumn&&(this._moveEndPositionDown=!0,o=o.setEndPosition(o.endLineNumber-1,t.getLineMaxColumn(o.endLineNumber-1)));var r=e._gatherPreflightData(this._type,t,o.startLineNumber,o.endLineNumber);return r.supported?this._executeLineComments(t,n,r,o):this._executeBlockComment(t,n,o)},e.prototype.computeCursorState=function(e,t){var n=t.getTrackedSelection(this._selectionId);return this._moveEndPositionDown&&(n=n.setEndPosition(n.endLineNumber+1,1)),new m.Selection(n.startLineNumber,n.startColumn+this._deltaColumn,n.endLineNumber,n.endColumn+this._deltaColumn)},e._createRemoveLineCommentsOperations=function(e,t){var n,r,m,s=[];for(n=0,r=e.length;n<r;n++)m=e[n],m.ignore||s.push(o.EditOperation["delete"](new i.Range(t+n,m.commentStrOffset+1,t+n,m.commentStrOffset+m.commentStrLength+1)));return s},e._createAddLineCommentsOperations=function(e,t){var n,i,m,s=[];for(n=0,i=e.length;n<i;n++)m=e[n],m.ignore||s.push(o.EditOperation.insert(new r.Position(t+n,m.commentStrOffset+1),m.commentStr+" "));return s},e.nextVisibleColumn=function(e,t,n,o){return n?e+(t-e%t):e+o},e._normalizeInsertionPoint=function(t,n,o,r){var i,m,s,a,l,u,c=Number.MAX_VALUE,d="\t".charCodeAt(0);for(i=0,m=n.length;i<m;i++)if(!n[i].ignore){for(s=t.getLineContent(o+i),u=0,a=0,l=n[i].commentStrOffset;u<c&&a<l;a++)u=e.nextVisibleColumn(u,r,s.charCodeAt(a)===d,1);u<c&&(c=u)}for(c=Math.floor(c/r)*r,i=0,m=n.length;i<m;i++)if(!n[i].ignore){for(s=t.getLineContent(o+i),u=0,a=0,l=n[i].commentStrOffset;u<c&&a<l;a++)u=e.nextVisibleColumn(u,r,s.charCodeAt(a)===d,1);u>c?n[i].commentStrOffset=a-1:n[i].commentStrOffset=a}},e}();t.LineCommentCommand=u});