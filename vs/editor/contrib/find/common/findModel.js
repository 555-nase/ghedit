define(["require","exports","vs/base/common/async","vs/base/common/lifecycle","vs/platform/search/common/replace","vs/editor/common/commands/replaceCommand","vs/editor/common/core/position","vs/editor/common/core/range","vs/editor/common/editorCommon","./findDecorations","./replaceAllCommand","vs/editor/common/core/selection"],function(t,e,i,o,n,s,a,r,c,h,d,l){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";e.FIND_IDS={StartFindAction:"actions.find",NextMatchFindAction:"editor.action.nextMatchFindAction",PreviousMatchFindAction:"editor.action.previousMatchFindAction",NextSelectionMatchFindAction:"editor.action.nextSelectionMatchFindAction",PreviousSelectionMatchFindAction:"editor.action.previousSelectionMatchFindAction",AddSelectionToNextFindMatchAction:"editor.action.addSelectionToNextFindMatch",AddSelectionToPreviousFindMatchAction:"editor.action.addSelectionToPreviousFindMatch",MoveSelectionToNextFindMatchAction:"editor.action.moveSelectionToNextFindMatch",MoveSelectionToPreviousFindMatchAction:"editor.action.moveSelectionToPreviousFindMatch",StartFindReplaceAction:"editor.action.startFindReplaceAction",CloseFindWidgetCommand:"closeFindWidget",ToggleCaseSensitiveCommand:"toggleFindCaseSensitive",ToggleWholeWordCommand:"toggleFindWholeWord",ToggleRegexCommand:"toggleFindRegex",ReplaceOneAction:"editor.action.replaceOne",ReplaceAllAction:"editor.action.replaceAll",SelectAllMatchesAction:"editor.action.selectAllMatches"},e.MATCHES_LIMIT=999;var g=function(){function t(t,e){var o=this;this._editor=t,this._state=e,this._toDispose=[],this._isDisposed=!1,this._decorations=new h.FindDecorations(t),this._toDispose.push(this._decorations),this._updateDecorationsScheduler=new i.RunOnceScheduler(function(){return o.research(!1)},100),this._toDispose.push(this._updateDecorationsScheduler),this._toDispose.push(this._editor.onDidChangeCursorPosition(function(t){t.reason!==c.CursorChangeReason.Explicit&&t.reason!==c.CursorChangeReason.Undo&&t.reason!==c.CursorChangeReason.Redo||o._decorations.setStartPosition(o._editor.getPosition())})),this._ignoreModelContentChanged=!1,this._toDispose.push(this._editor.onDidChangeModelRawContent(function(t){o._ignoreModelContentChanged||(t.changeType===c.EventType.ModelRawContentChangedFlush&&o._decorations.reset(),o._decorations.setStartPosition(o._editor.getPosition()),o._updateDecorationsScheduler.schedule())})),this._toDispose.push(this._state.addChangeListener(function(t){return o._onStateChanged(t)})),this.research(!1,this._state.searchScope)}return t.prototype.dispose=function(){this._isDisposed=!0,this._toDispose=o.dispose(this._toDispose)},t.prototype._onStateChanged=function(t){this._isDisposed||(t.searchString||t.isReplaceRevealed||t.isRegex||t.wholeWord||t.matchCase||t.searchScope)&&(t.searchScope?this.research(t.moveCursor,this._state.searchScope):this.research(t.moveCursor))},t._getSearchRange=function(t,e,i){var o;return o=e?t.getEditableRange():t.getFullModelRange(),i&&(o=o.intersectRanges(i)),o},t.prototype.research=function(t,i){var o=null;o="undefined"!=typeof i?i:this._decorations.getFindScope(),null!==o&&(o=new r.Range(o.startLineNumber,1,o.endLineNumber,this._editor.getModel().getLineMaxColumn(o.endLineNumber)));var n=this._findMatches(o,e.MATCHES_LIMIT);this._decorations.set(n,o),this._state.changeMatchInfo(this._decorations.getCurrentMatchesPosition(this._editor.getSelection()),this._decorations.getCount(),void 0),t&&this._moveToNextMatch(this._decorations.getStartPosition())},t.prototype._hasMatches=function(){return this._state.matchesCount>0},t.prototype._cannotFind=function(){if(!this._hasMatches()){var t=this._decorations.getFindScope();return t&&this._editor.revealRangeInCenterIfOutsideViewport(t),!0}return!1},t.prototype._setCurrentFindMatch=function(t){var e=this._decorations.setCurrentFindMatch(t);this._state.changeMatchInfo(e,this._decorations.getCount(),t),this._editor.setSelection(t),this._editor.revealRangeInCenterIfOutsideViewport(t)},t.prototype._moveToPrevMatch=function(e,i){if(void 0===i&&(i=!1),!this._cannotFind()){var o=this._decorations.getFindScope(),n=t._getSearchRange(this._editor.getModel(),this._state.isReplaceRevealed,o);n.getEndPosition().isBefore(e)&&(e=n.getEndPosition()),e.isBefore(n.getStartPosition())&&(e=n.getEndPosition());var s=e.lineNumber,r=e.column,c=this._editor.getModel(),h=new a.Position(s,r),d=c.findPreviousMatch(this._state.searchString,h,this._state.isRegex,this._state.matchCase,this._state.wholeWord);if(d&&d.isEmpty()&&d.getStartPosition().equals(h)){var l=this._state.isRegex&&(this._state.searchString.indexOf("^")>=0||this._state.searchString.indexOf("$")>=0);l||1===r?(1===s?s=c.getLineCount():s--,r=c.getLineMaxColumn(s)):r--,h=new a.Position(s,r),d=c.findPreviousMatch(this._state.searchString,h,this._state.isRegex,this._state.matchCase,this._state.wholeWord)}if(d)return i||n.containsRange(d)?void this._setCurrentFindMatch(d):this._moveToPrevMatch(d.getStartPosition(),!0)}},t.prototype.moveToPrevMatch=function(){this._moveToPrevMatch(this._editor.getSelection().getStartPosition())},t.prototype._moveToNextMatch=function(t){var e=r.Range.isIRange(t)?t:a.Position.isIPosition(t)?this._getNextMatch(t):null;e&&this._setCurrentFindMatch(e)},t.prototype._getNextMatch=function(e,i){if(void 0===i&&(i=!1),this._cannotFind())return null;var o=this._decorations.getFindScope(),n=t._getSearchRange(this._editor.getModel(),this._state.isReplaceRevealed,o);n.getEndPosition().isBefore(e)&&(e=n.getStartPosition()),e.isBefore(n.getStartPosition())&&(e=n.getStartPosition());var s=e.lineNumber,r=e.column,c=this._editor.getModel(),h=new a.Position(s,r),d=c.findNextMatch(this._state.searchString,h,this._state.isRegex,this._state.matchCase,this._state.wholeWord);if(d&&d.isEmpty()&&d.getStartPosition().equals(h)){var l=this._state.isRegex&&(this._state.searchString.indexOf("^")>=0||this._state.searchString.indexOf("$")>=0);l||r===c.getLineMaxColumn(s)?(s===c.getLineCount()?s=1:s++,r=1):r++,h=new a.Position(s,r),d=c.findNextMatch(this._state.searchString,h,this._state.isRegex,this._state.matchCase,this._state.wholeWord)}return d?i||n.containsRange(d)?d:this._getNextMatch(d.getEndPosition(),!0):void 0},t.prototype.moveToNextMatch=function(){this._moveToNextMatch(this._editor.getSelection().getEndPosition())},t.prototype.getReplaceString=function(t){var e=new n.ReplacePattern(this._state.replaceString,{pattern:this._state.searchString,isRegExp:this._state.isRegex,isCaseSensitive:this._state.matchCase,isWordMatch:this._state.wholeWord});return e.getReplaceString(t)},t.prototype.replace=function(){if(this._hasMatches()){var t=this._editor.getSelection(),e=this._editor.getModel().getValueInRange(t),i=this._getNextMatch(t.getStartPosition());if(i)if(t.equalsRange(i)){var o=this.getReplaceString(e),n=new s.ReplaceCommand(t,o);this._executeEditorCommand("replace",n),this._decorations.setStartPosition(new a.Position(t.startLineNumber,t.startColumn+o.length)),this.research(!0)}else this._decorations.setStartPosition(this._editor.getPosition()),this._moveToNextMatch(i)}},t.prototype._findMatches=function(e,i){var o=t._getSearchRange(this._editor.getModel(),this._state.isReplaceRevealed,e);return this._editor.getModel().findMatches(this._state.searchString,o,this._state.isRegex,this._state.matchCase,this._state.wholeWord,i)},t.prototype.replaceAll=function(){if(this._hasMatches()){for(var t=this._editor.getModel(),e=this._decorations.getFindScope(),i=this._findMatches(e,Number.MAX_VALUE),o=[],n=0,s=i.length;n<s;n++)o.push(this.getReplaceString(t.getValueInRange(i[n])));var a=new d.ReplaceAllCommand(this._editor.getSelection(),i,o);this._executeEditorCommand("replaceAll",a),this.research(!1)}},t.prototype.selectAllMatches=function(){if(this._hasMatches()){var t=this._decorations.getFindScope(),e=this._findMatches(t,Number.MAX_VALUE);this._editor.setSelections(e.map(function(t){return new l.Selection(t.startLineNumber,t.startColumn,t.endLineNumber,t.endColumn)}))}},t.prototype._executeEditorCommand=function(t,e){try{this._ignoreModelContentChanged=!0,this._editor.executeCommand(t,e)}finally{this._ignoreModelContentChanged=!1}},t}();e.FindModelBoundToEditorModel=g});