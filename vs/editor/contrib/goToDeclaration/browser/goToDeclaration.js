/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)},__decorate=this&&this.__decorate||function(e,t,o,n){var i,r=arguments.length,s=r<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(r<3?i(s):r>3?i(t,o,s):i(t,o))||s);return r>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};define(["require","exports","vs/nls","vs/platform/keybinding/common/keybinding","vs/base/common/async","vs/base/common/errors","vs/base/common/htmlContent","vs/base/common/keyCodes","vs/base/common/platform","vs/base/common/severity","vs/base/common/strings","vs/base/common/winjs.base","vs/base/browser/browser","vs/platform/editor/common/editor","vs/platform/message/common/message","vs/editor/common/core/range","vs/editor/common/editorAction","vs/editor/common/editorActionEnablement","vs/editor/common/editorCommon","vs/editor/common/editorCommonExtensions","vs/editor/common/modes","vs/editor/browser/editorBrowserExtensions","vs/editor/contrib/goToDeclaration/common/goToDeclaration","vs/editor/contrib/referenceSearch/browser/referencesController","vs/editor/contrib/referenceSearch/browser/referencesModel","vs/base/common/lifecycle","vs/editor/contrib/zoneWidget/browser/peekViewWidget","vs/platform/instantiation/common/instantiation","vs/css!./goToDeclaration"],function(e,t,o,n,i,r,s,a,d,c,u,l,h,p,m,g,f,v,E,_,y,C,D,M,b,I,S,R){"use strict";var T=function(){function e(e,t,o,n){void 0===e&&(e=v.Behaviour.WidgetFocus|v.Behaviour.UpdateOnCursorPositionChange),void 0===t&&(t=!1),void 0===o&&(o=!1),void 0===n&&(n=!0),this.condition=e,this.openToSide=t,this.openInPeek=o,this.filterCurrent=n}return e}();t.DefinitionActionConfig=T;var K=function(e){function t(t,o,n,i,r){e.call(this,t,o,r.condition),this._messageService=n,this._editorService=i,this._configuration=r}return __extends(t,e),t.prototype.isSupported=function(){return y.DefinitionProviderRegistry.has(this.editor.getModel())&&e.prototype.isSupported.call(this)},t.prototype.getEnablementState=function(){return!!e.prototype.getEnablementState.call(this)&&y.DefinitionProviderRegistry.has(this.editor.getModel())},t.prototype.run=function(){var e=this,t=this.editor.getModel(),o=this.editor.getPosition();return D.getDeclarationsAtPosition(t,o).then(function(n){if(n){for(var i=[],r=0;r<n.length;r++){var s=n[r];if(s){var a=s.uri,d=s.range;e._configuration.filterCurrent&&a.toString()===t.uri.toString()&&g.Range.containsPosition(d,o)||i.push({uri:a,range:g.Range.collapseToStart(d)})}}if(0!==i.length)return e._onResult(new b.ReferencesModel(i))}},function(t){return e._messageService.show(c["default"].Error,t),!1})},t.prototype._onResult=function(e){var t=this;if(this._configuration.openInPeek)this._openInPeek(this.editor,e);else{var o=e.nearestReference(this.editor.getModel().uri,this.editor.getPosition());this._openReference(o,this._configuration.openToSide).then(function(o){e.references.length>1&&t._openInPeek(o,e)})}},t.prototype._openReference=function(e,t){var o=e.uri,n=e.range;return this._editorService.openEditor({resource:o,options:{selection:n,revealIfVisible:!t}},t).then(function(e){return e.getControl()})},t.prototype._openInPeek=function(e,t){var n=this,i=M.ReferencesController.getController(e);i.toggleWidget(e.getSelection(),l.TPromise.as(t),{getMetaTitle:function(e){return e.references.length>1&&o.localize("meta.title"," – {0} definitions",e.references.length)},onGoto:function(e){return i.closeWidget(),n._openReference(e,!1)}})},t}(f.EditorAction);t.DefinitionAction=K;var U=function(e){function t(t,o,n,i){e.call(this,t,o,n,i,new T)}return __extends(t,e),t.ID="editor.action.goToDeclaration",t=__decorate([__param(2,m.IMessageService),__param(3,p.IEditorService)],t)}(K);t.GoToDefinitionAction=U;var w=function(e){function t(t,o,n,i){e.call(this,t,o,n,i,new T(v.Behaviour.WidgetFocus|v.Behaviour.UpdateOnCursorPositionChange,(!0)))}return __extends(t,e),t.ID="editor.action.openDeclarationToTheSide",t=__decorate([__param(2,m.IMessageService),__param(3,p.IEditorService)],t)}(K);t.OpenDefinitionToSideAction=w;var k=function(e){function t(t,o,n,i,r){e.call(this,t,o,n,i,new T((void 0),(void 0),(!0),(!1))),this._peekViewService=r}return __extends(t,e),t.prototype.getEnablementState=function(){return(!this._peekViewService||!this._peekViewService.isActive)&&e.prototype.getEnablementState.call(this)},t.ID="editor.action.previewDeclaration",t=__decorate([__param(2,m.IMessageService),__param(3,p.IEditorService),__param(4,R.optional(S.IPeekViewService))],t)}(K);t.PeekDefinitionAction=k;var x=function(){function e(e,t){var o=this;this.editorService=t,this.toUnhook=[],this.decorations=[],this.editor=e,this.throttler=new i.Throttler,this.toUnhook.push(this.editor.onMouseDown(function(e){return o.onEditorMouseDown(e)})),this.toUnhook.push(this.editor.onMouseUp(function(e){return o.onEditorMouseUp(e)})),this.toUnhook.push(this.editor.onMouseMove(function(e){return o.onEditorMouseMove(e)})),this.toUnhook.push(this.editor.onKeyDown(function(e){return o.onEditorKeyDown(e)})),this.toUnhook.push(this.editor.onKeyUp(function(e){return o.onEditorKeyUp(e)})),this.toUnhook.push(this.editor.onDidChangeCursorSelection(function(e){return o.onDidChangeCursorSelection(e)})),this.toUnhook.push(this.editor.onDidChangeModel(function(e){return o.resetHandler()})),this.toUnhook.push(this.editor.onDidChangeModelContent(function(){return o.resetHandler()})),this.toUnhook.push(this.editor.onDidScrollChange(function(e){(e.scrollTopChanged||e.scrollLeftChanged)&&o.resetHandler()}))}return e.prototype.onDidChangeCursorSelection=function(e){e.selection&&e.selection.startColumn!==e.selection.endColumn&&this.resetHandler()},e.prototype.onEditorMouseMove=function(e,t){this.lastMouseMoveEvent=e,this.startFindDefinition(e,t)},e.prototype.startFindDefinition=function(t,n){var i=this;if(!this.isEnabled(t,n))return this.currentWordUnderMouse=null,void this.removeDecorations();var s=t.target.position,a=s?this.editor.getModel().getWordAtPosition(s):null;if(!a)return this.currentWordUnderMouse=null,void this.removeDecorations();if(!this.currentWordUnderMouse||this.currentWordUnderMouse.startColumn!==a.startColumn||this.currentWordUnderMouse.endColumn!==a.endColumn||this.currentWordUnderMouse.word!==a.word){this.currentWordUnderMouse=a;var d=this.editor.captureState(E.CodeEditorStateFlag.Position,E.CodeEditorStateFlag.Value,E.CodeEditorStateFlag.Selection,E.CodeEditorStateFlag.Scroll);this.throttler.queue(function(){return d.validate(i.editor)?i.findDefinition(t.target):l.TPromise.as(null)}).then(function(t){if(!t||!t.length||!d.validate(i.editor))return void i.removeDecorations();if(t.length>1)i.addDecoration({startLineNumber:s.lineNumber,startColumn:a.startColumn,endLineNumber:s.lineNumber,endColumn:a.endColumn},o.localize("multipleResults","Click to show the {0} definitions found.",t.length),!1);else{var n=t[0];i.editorService.resolveEditorModel({resource:n.uri}).then(function(t){var o;if(t&&t.textEditorModel){var r=Math.max(1,n.range.startLineNumber),d=void 0,c=void 0;c=t.textEditorModel,d=n.range.startLineNumber!==n.range.endLineNumber||n.range.startColumn!==n.range.endColumn?Math.min(n.range.endLineNumber,n.range.startLineNumber+e.MAX_SOURCE_PREVIEW_LINES,c.getLineCount()):Math.min(r+e.MAX_SOURCE_PREVIEW_LINES,c.getLineCount()),o=c.getValueInRange({startLineNumber:r,startColumn:1,endLineNumber:d,endColumn:c.getLineMaxColumn(d)}).trim();for(var l=Number.MAX_VALUE,h=/^[ \t]*/,p=void 0,m=void 0;r<=d&&l>0;)m=c.getLineContent(r++),0!==m.trim().length&&(p=h.exec(m),l=Math.min(l,p[0].length));o=o.replace(new RegExp("^([ \\t]{"+l+"})","gm"),u.empty),n.range.endLineNumber-n.range.startLineNumber>e.MAX_SOURCE_PREVIEW_LINES&&(o+="\n…")}i.addDecoration({startLineNumber:s.lineNumber,startColumn:a.startColumn,endLineNumber:s.lineNumber,endColumn:a.endColumn},o,!0)})}}).done(void 0,r.onUnexpectedError)}},e.prototype.addDecoration=function(e,t,o){var n=this.editor.getModel();if(n){var i=void 0;t&&t.trim().length>0&&(i=o?{language:n.getMode().getId(),value:t}:s.textToMarkedString(t));var r={range:e,options:{inlineClassName:"goto-definition-link",hoverMessage:i}};this.decorations=this.editor.deltaDecorations(this.decorations,[r])}},e.prototype.removeDecorations=function(){this.decorations.length>0&&(this.decorations=this.editor.deltaDecorations(this.decorations,[]))},e.prototype.onEditorKeyDown=function(t){this.lastMouseMoveEvent&&(t.keyCode===e.TRIGGER_KEY_VALUE||t.keyCode===e.TRIGGER_SIDEBYSIDE_KEY_VALUE&&t[e.TRIGGER_MODIFIER])?this.startFindDefinition(this.lastMouseMoveEvent,t):t[e.TRIGGER_MODIFIER]&&this.removeDecorations()},e.prototype.resetHandler=function(){this.lastMouseMoveEvent=null,this.hasTriggerKeyOnMouseDown=!1,this.removeDecorations()},e.prototype.onEditorMouseDown=function(t){this.hasTriggerKeyOnMouseDown=!!t.event[e.TRIGGER_MODIFIER]},e.prototype.onEditorMouseUp=function(e){var t=this;this.isEnabled(e)&&this.hasTriggerKeyOnMouseDown&&this.gotoDefinition(e.target,e.event.altKey).done(function(){t.removeDecorations()},function(e){t.removeDecorations(),r.onUnexpectedError(e)})},e.prototype.onEditorKeyUp=function(t){t.keyCode===e.TRIGGER_KEY_VALUE&&(this.removeDecorations(),this.currentWordUnderMouse=null)},e.prototype.isEnabled=function(t,o){return this.editor.getModel()&&(h.isIE11orEarlier||t.event.detail<=1)&&t.target.type===E.MouseTargetType.CONTENT_TEXT&&(t.event[e.TRIGGER_MODIFIER]||o&&o.keyCode===e.TRIGGER_KEY_VALUE)&&y.DefinitionProviderRegistry.has(this.editor.getModel())},e.prototype.findDefinition=function(e){var t=this.editor.getModel();return t?D.getDeclarationsAtPosition(this.editor.getModel(),e.position):l.TPromise.as(null)},e.prototype.gotoDefinition=function(e,t){var o=t?w.ID:U.ID;return this.editor.setPosition(e.position),this.editor.getAction(o).run()},e.prototype.getId=function(){return e.ID},e.prototype.dispose=function(){this.toUnhook=I.dispose(this.toUnhook)},e.ID="editor.contrib.gotodefinitionwithmouse",e.TRIGGER_MODIFIER=d.isMacintosh?"metaKey":"ctrlKey",e.TRIGGER_SIDEBYSIDE_KEY_VALUE=a.KeyCode.Alt,e.TRIGGER_KEY_VALUE=d.isMacintosh?a.KeyCode.Meta:a.KeyCode.Ctrl,e.MAX_SOURCE_PREVIEW_LINES=7,e=__decorate([__param(1,p.IEditorService)],e)}();_.CommonEditorRegistry.registerEditorAction({id:k.ID,ctor:k,label:o.localize("actions.previewDecl.label","Peek Definition"),alias:"Peek Definition",kbOpts:{context:_.ContextKey.EditorTextFocus,primary:a.KeyMod.Alt|a.KeyCode.F12,linux:{primary:a.KeyMod.CtrlCmd|a.KeyMod.Shift|a.KeyCode.F10}},menuOpts:{group:"navigation",order:1.2,kbExpr:n.KbExpr.has(E.ModeContextKeys.hasDefinitionProvider)}});var P=d.isWeb?a.KeyMod.CtrlCmd|a.KeyCode.F12:a.KeyCode.F12;_.CommonEditorRegistry.registerEditorAction({ctor:U,id:U.ID,label:o.localize("actions.goToDecl.label","Go to Definition"),alias:"Go to Definition",kbOpts:{context:_.ContextKey.EditorTextFocus,primary:P},menuOpts:{group:"navigation",order:1.1,kbExpr:n.KbExpr.has(E.ModeContextKeys.hasDefinitionProvider)}}),_.CommonEditorRegistry.registerEditorAction(new _.EditorActionDescriptor(w,w.ID,o.localize("actions.goToDeclToSide.label","Open Definition to the Side"),{context:_.ContextKey.EditorTextFocus,primary:a.KeyMod.chord(a.KeyMod.CtrlCmd|a.KeyCode.KEY_K,P)},"Open Definition to the Side")),C.EditorBrowserRegistry.registerEditorContribution(x)});