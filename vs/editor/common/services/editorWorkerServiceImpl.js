var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},__decorate=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,s=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(s=(i<3?n(s):i>3?n(t,r,s):n(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s},__param=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};define(["require","exports","vs/base/common/async","vs/base/common/lifecycle","vs/base/common/winjs.base","vs/base/common/worker/simpleWorker","vs/base/worker/defaultWorkerFactory","vs/editor/common/editorCommon","vs/editor/common/model/textModelWithTokensHelpers","vs/editor/common/modes","vs/editor/common/services/modelService","vs/editor/common/services/editorSimpleWorker","vs/base/common/worker/workerClient"],function(e,t,r,o,n,i,s,c,a,l,u,d,h){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var p=6e4,_=3e5,f=function(){function e(e){var t=this;this._workerManager=new g(e),this._registration=l.LinkProviderRegistry.register("*",{provideLinks:function(e,o){return r.wireCancellationToken(o,t._workerManager.withWorker().then(function(t){return t.computeLinks(e.uri)}))}})}return e.prototype.dispose=function(){this._workerManager.dispose(),this._registration.dispose()},e.prototype.computeDiff=function(e,t,r){return this._workerManager.withWorker().then(function(o){return o.computeDiff(e,t,r)})},e.prototype.computeDirtyDiff=function(e,t,r){return this._workerManager.withWorker().then(function(o){return o.computeDirtyDiff(e,t,r)})},e.prototype.textualSuggest=function(e,t){return this._workerManager.withWorker().then(function(r){return r.textualSuggest(e,t)})},e.prototype.navigateValueSet=function(e,t,r){return this._workerManager.withWorker().then(function(o){return o.navigateValueSet(e,t,r)})},e=__decorate([__param(0,u.IModelService)],e)}();t.EditorWorkerServiceImpl=f;var g=function(e){function t(t){var o=this;e.call(this),this._modelService=t,this._editorWorkerClient=null;var n=this._register(new r.IntervalTimer);n.cancelAndSet(function(){return o._checkStopWorker()},Math.round(_/2))}return __extends(t,e),t.prototype.dispose=function(){this._editorWorkerClient&&(this._editorWorkerClient.dispose(),this._editorWorkerClient=null),e.prototype.dispose.call(this)},t.prototype._checkStopWorker=function(){if(this._editorWorkerClient){var e=(new Date).getTime()-this._lastWorkerUsedTime;e>_&&(this._editorWorkerClient.dispose(),this._editorWorkerClient=null)}},t.prototype.withWorker=function(){return this._lastWorkerUsedTime=(new Date).getTime(),this._editorWorkerClient||(this._editorWorkerClient=new v(this._modelService)),n.TPromise.as(this._editorWorkerClient)},t}(o.Disposable),y=function(e){function t(t,o,n){var i=this;if(e.call(this),this._syncedModels=Object.create(null),this._syncedModelsLastUsedTime=Object.create(null),this._proxy=t,this._modelService=o,!n){var s=new r.IntervalTimer;s.cancelAndSet(function(){return i._checkStopModelSync()},Math.round(p/2)),this._register(s)}}return __extends(t,e),t.prototype.dispose=function(){for(var t in this._syncedModels)o.dispose(this._syncedModels[t]);this._syncedModels=Object.create(null),this._syncedModelsLastUsedTime=Object.create(null),e.prototype.dispose.call(this)},t.prototype.esureSyncedResources=function(e){for(var t=0;t<e.length;t++){var r=e[t],o=r.toString();this._syncedModels[o]||this._beginModelSync(r),this._syncedModels[o]&&(this._syncedModelsLastUsedTime[o]=(new Date).getTime())}},t.prototype._checkStopModelSync=function(){var e=(new Date).getTime(),t=[];for(var r in this._syncedModelsLastUsedTime){var o=e-this._syncedModelsLastUsedTime[r];o>p&&t.push(r)}for(var n=0;n<t.length;n++)this._stopModelSync(t[n])},t.prototype._beginModelSync=function(e){var t=this,r=e.toString(),o=this._modelService.getModel(e);if(o&&!o.isTooLargeForHavingARichMode()){this._proxy.acceptNewModel({url:o.uri.toString(),value:o.toRawText(),versionId:o.getVersionId()});var n=[];n.push(o.addBulkListener(function(e){for(var o=[],n=0,i=e.length;n<i;n++){var s=e[n];switch(s.getType()){case c.EventType.ModelContentChanged2:o.push(s.getData());break;case c.EventType.ModelDispose:return void t._stopModelSync(r)}}o.length>0&&t._proxy.acceptModelChanged(r.toString(),o)})),n.push({dispose:function(){t._proxy.acceptRemovedModel(r)}}),this._syncedModels[r]=n}},t.prototype._stopModelSync=function(e){var t=this._syncedModels[e];delete this._syncedModels[e],delete this._syncedModelsLastUsedTime[e],o.dispose(t)},t}(o.Disposable),m=function(){function e(e){this._instance=e,this._proxyObj=n.TPromise.as(this._instance)}return e.prototype.dispose=function(){this._instance.dispose(),this._instance=null,this._proxyObj=null},e.prototype.getProxyObject=function(){return new r.ShallowCancelThenPromise(this._proxyObj)},e}(),v=function(e){function t(t){e.call(this),this._modelService=t,this._workerFactory=new s.DefaultWorkerFactory((!1)),this._worker=null,this._modelManager=null}return __extends(t,e),t.prototype._getOrCreateWorker=function(){if(!this._worker)try{this._worker=this._register(new i.SimpleWorkerClient(this._workerFactory,"vs/editor/common/services/editorSimpleWorker"))}catch(e){h.logOnceWebWorkerWarning(e),this._worker=new m(new d.EditorSimpleWorkerImpl)}return this._worker},t.prototype._getProxy=function(){var e=this;return new r.ShallowCancelThenPromise(this._getOrCreateWorker().getProxyObject().then(null,function(t){return h.logOnceWebWorkerWarning(t),e._worker=new m(new d.EditorSimpleWorkerImpl),e._getOrCreateWorker().getProxyObject()}))},t.prototype._getOrCreateModelManager=function(e){return this._modelManager||(this._modelManager=this._register(new y(e,this._modelService,(!1)))),this._modelManager},t.prototype._withSyncedResources=function(e){var t=this;return this._getProxy().then(function(r){return t._getOrCreateModelManager(r).esureSyncedResources(e),r})},t.prototype.computeDiff=function(e,t,r){return this._withSyncedResources([e,t]).then(function(o){return o.computeDiff(e.toString(),t.toString(),r)})},t.prototype.computeDirtyDiff=function(e,t,r){return this._withSyncedResources([e,t]).then(function(o){return o.computeDirtyDiff(e.toString(),t.toString(),r)})},t.prototype.computeLinks=function(e){return this._withSyncedResources([e]).then(function(t){return t.computeLinks(e.toString())})},t.prototype.textualSuggest=function(e,t){var r=this;return this._withSyncedResources([e]).then(function(o){var n=r._modelService.getModel(e);if(!n)return null;var i=a.WordHelper.massageWordDefinitionOf(n.getMode()),s=i.source,c=(i.global?"g":"")+(i.ignoreCase?"i":"")+(i.multiline?"m":"");return o.textualSuggest(e.toString(),t,s,c)})},t.prototype.navigateValueSet=function(e,t,r){var o=this;return this._withSyncedResources([e]).then(function(n){var i=o._modelService.getModel(e);if(!i)return null;var s=a.WordHelper.massageWordDefinitionOf(i.getMode()),c=s.source,l=(s.global?"g":"")+(s.ignoreCase?"i":"")+(s.multiline?"m":"");return n.navigateValueSet(e.toString(),t,r,c,l)})},t}(o.Disposable);t.EditorWorkerClient=v});