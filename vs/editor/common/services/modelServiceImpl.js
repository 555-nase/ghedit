var __decorate=this&&this.__decorate||function(e,t,o,n){var i,r=arguments.length,s=r<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(r<3?i(s):r>3?i(t,o,s):i(t,o))||s);return r>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,n){t(o,n,e)}};define(["require","exports","vs/nls","vs/base/common/network","vs/base/common/event","vs/base/common/htmlContent","vs/base/common/severity","vs/platform/markers/common/markers","vs/platform/telemetry/common/telemetry","vs/editor/common/core/range","vs/editor/common/editorCommon","vs/editor/common/model/model","vs/base/common/platform","vs/platform/configuration/common/configuration","vs/editor/common/config/defaultConfig","vs/platform/message/common/message"],function(e,t,o,n,i,r,s,a,d,c,l,m,u,p,h,f){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";function _(e){return e.toString()}var v=function(){function e(e,t){var o=this;this.model=e,this._markerDecorations=[],this._modelEventsListener=e.addBulkListener(function(e){return t(o,e)})}return e.prototype.dispose=function(){this._markerDecorations=this.model.deltaDecorations(this._markerDecorations,[]),this._modelEventsListener.dispose(),this._modelEventsListener=null,this.model=null},e.prototype.getModelId=function(){return _(this.model.uri)},e.prototype.acceptMarkerDecorations=function(e){this._markerDecorations=this.model.deltaDecorations(this._markerDecorations,e)},e}(),g=function(){function e(){}return e.setMarkers=function(e,t){var o=this;t=t.slice(0,500);var n=t.map(function(t){return{range:o._createDecorationRange(e.model,t),options:o._createDecorationOption(t)}});e.acceptMarkerDecorations(n)},e._createDecorationRange=function(e,t){var o=e.validateRange(new c.Range(t.startLineNumber,t.startColumn,t.endLineNumber,t.endColumn)),n=new c.Range(o.startLineNumber,o.startColumn,o.endLineNumber,o.endColumn);if(n.isEmpty()){var i=e.getWordAtPosition(n.getStartPosition());if(i)n.startColumn=i.startColumn,n.endColumn=i.endColumn;else{var r=e.getLineLastNonWhitespaceColumn(o.startLineNumber)||e.getLineMaxColumn(o.startLineNumber);1===r||(n.endColumn>=r?(n.endColumn=r,n.startColumn=r-1):n.endColumn+=1)}}else if(t.endColumn===Number.MAX_VALUE&&1===t.startColumn&&n.startLineNumber===n.endLineNumber){var s=e.getLineFirstNonWhitespaceColumn(t.startLineNumber);s<n.endColumn&&(n.startColumn=s,t.startColumn=s)}return n},e._createDecorationOption=function(e){var t,o,n,i=null;switch(e.severity){case s["default"].Ignore:break;case s["default"].Warning:case s["default"].Info:t=l.ClassName.EditorWarningDecoration,o="rgba(18,136,18,0.7)",n="rgba(18,136,18,0.7)";break;case s["default"].Error:default:t=l.ClassName.EditorErrorDecoration,o="rgba(255,18,18,0.7)",n="rgba(255,18,18,0.7)"}return"string"==typeof e.message?i=[r.textToMarkedString(e.message)]:Array.isArray(e.message)?i=e.message:e.message&&(i=[e.message]),i&&e.source&&i.unshift("["+e.source+"] "),{stickiness:l.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,className:t,hoverMessage:i,overviewRuler:{color:o,darkColor:n,position:l.OverviewRulerLane.Right}}},e}(),S=function(){function e(e,t,n){var r=this;this._modelCreationOptions={tabSize:h.DEFAULT_INDENTATION.tabSize,insertSpaces:h.DEFAULT_INDENTATION.insertSpaces,detectIndentation:h.DEFAULT_INDENTATION.detectIndentation,defaultEOL:u.isLinux||u.isMacintosh?l.DefaultEndOfLine.LF:l.DefaultEndOfLine.CRLF,trimAutoWhitespace:h.DEFAULT_TRIM_AUTO_WHITESPACE},this._markerService=e,this._configurationService=t,this._messageService=n,this._hasShownMigrationMessage=!1,this._models={},this._onModelAdded=new i.Emitter,this._onModelRemoved=new i.Emitter,this._onModelModeChanged=new i.Emitter,this._markerService&&(this._markerServiceSubscription=this._markerService.onMarkerChanged(this._handleMarkerChange,this));var a=function(e){var t=!1,n=h.DEFAULT_INDENTATION.tabSize;if(e.editor&&"undefined"!=typeof e.editor.tabSize){var i=parseInt(e.editor.tabSize,10);isNaN(i)||(n=i),t=t||"auto"===e.editor.tabSize}var a=h.DEFAULT_INDENTATION.insertSpaces;e.editor&&"undefined"!=typeof e.editor.insertSpaces&&(a="false"!==e.editor.insertSpaces&&Boolean(e.editor.insertSpaces),t=t||"auto"===e.editor.insertSpaces);var d=r._modelCreationOptions.defaultEOL,c=e.files&&e.files.eol;"\r\n"===c?d=l.DefaultEndOfLine.CRLF:"\n"===c&&(d=l.DefaultEndOfLine.LF);var m=r._modelCreationOptions.trimAutoWhitespace;e.editor&&"undefined"!=typeof e.editor.trimAutoWhitespace&&(m="false"!==e.editor.trimAutoWhitespace&&Boolean(e.editor.trimAutoWhitespace));var u=h.DEFAULT_INDENTATION.detectIndentation;e.editor&&"undefined"!=typeof e.editor.detectIndentation&&(u="false"!==e.editor.detectIndentation&&Boolean(e.editor.detectIndentation)),r._setModelOptions({tabSize:n,insertSpaces:a,detectIndentation:u,defaultEOL:d,trimAutoWhitespace:m}),t&&!r._hasShownMigrationMessage&&(r._hasShownMigrationMessage=!0,r._messageService.show(s["default"].Info,o.localize("indentAutoMigrate",'Please update your settings: `editor.detectIndentation` replaces `editor.tabSize`: "auto" or `editor.insertSpaces`: "auto"')))};this._configurationServiceSubscription=this._configurationService.onDidUpdateConfiguration(function(e){a(e.config)}),a(this._configurationService.getConfiguration())}return e.prototype.getCreationOptions=function(){return this._modelCreationOptions},e.prototype._setModelOptions=function(e){if(this._modelCreationOptions.detectIndentation===e.detectIndentation&&this._modelCreationOptions.insertSpaces===e.insertSpaces&&this._modelCreationOptions.tabSize===e.tabSize&&this._modelCreationOptions.trimAutoWhitespace===e.trimAutoWhitespace)return void(this._modelCreationOptions=e);this._modelCreationOptions=e;for(var t=Object.keys(this._models),o=0,n=t.length;o<n;o++){var i=t[o],r=this._models[i];this._modelCreationOptions.detectIndentation?(r.model.detectIndentation(this._modelCreationOptions.insertSpaces,this._modelCreationOptions.tabSize),r.model.updateOptions({trimAutoWhitespace:this._modelCreationOptions.trimAutoWhitespace})):r.model.updateOptions({insertSpaces:this._modelCreationOptions.insertSpaces,tabSize:this._modelCreationOptions.tabSize,trimAutoWhitespace:this._modelCreationOptions.trimAutoWhitespace})}},e.prototype.dispose=function(){this._markerServiceSubscription&&this._markerServiceSubscription.dispose(),this._configurationServiceSubscription.dispose()},e.prototype._handleMarkerChange=function(e){var t=this;e.forEach(function(e){var o=_(e),n=t._models[o];n&&g.setMarkers(n,t._markerService.read({resource:e,take:500}))})},e.prototype._cleanUp=function(e){var t=this;e.uri.scheme!==n.Schemas.inMemory&&e.uri.scheme!==n.Schemas.internal&&e.uri.scheme!==n.Schemas.vscode||this._markerService&&this._markerService.read({resource:e.uri}).map(function(e){return e.owner}).forEach(function(o){return t._markerService.remove(o,[e.uri])})},e.prototype._createModelData=function(e,t,o){var n,i=this;n="string"==typeof e?m.Model.createFromString(e,this._modelCreationOptions,t,o):new m.Model(e,t,o);var r=_(n.uri);if(this._models[r])throw new Error("ModelService: Cannot add model "+d.anonymize(r)+" because it already exists!");var s=new v(n,function(e,t){return i._onModelEvents(e,t)});return this._models[r]=s,s},e.prototype.createModel=function(e,t,o){var n=this._createModelData(e,t,o);return this._markerService&&g.setMarkers(n,this._markerService.read({resource:n.model.uri})),this._onModelAdded.fire(n.model),n.model},e.prototype.destroyModel=function(e){var t=this._models[_(e)];t&&t.model.dispose()},e.prototype.getModels=function(){for(var e=[],t=Object.keys(this._models),o=0,n=t.length;o<n;o++){var i=t[o];e.push(this._models[i].model)}return e},e.prototype.getModel=function(e){var t=_(e),o=this._models[t];return o?o.model:null},Object.defineProperty(e.prototype,"onModelAdded",{get:function(){return this._onModelAdded?this._onModelAdded.event:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onModelRemoved",{get:function(){return this._onModelRemoved?this._onModelRemoved.event:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onModelModeChanged",{get:function(){return this._onModelModeChanged?this._onModelModeChanged.event:null},enumerable:!0,configurable:!0}),e.prototype._onModelDisposing=function(e){var t=_(e.uri),o=this._models[t];this._cleanUp(e),delete this._models[t],o.dispose(),this._onModelRemoved.fire(e)},e.prototype._onModelEvents=function(e,t){for(var o=0,n=t.length;o<n;o++){var i=t[o];if(i.getType()===l.EventType.ModelDispose)return void this._onModelDisposing(e.model)}for(var o=0,n=t.length;o<n;o++){var i=t[o];i.getType()===l.EventType.ModelModeChanged&&this._onModelModeChanged.fire({model:e.model,oldModeId:i.getData().oldMode.getId()})}},e=__decorate([__param(0,a.IMarkerService),__param(1,p.IConfigurationService),__param(2,f.IMessageService)],e)}();t.ModelServiceImpl=S});