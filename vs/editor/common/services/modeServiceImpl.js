var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},__decorate=this&&this.__decorate||function(e,t,n,o){var i,r=arguments.length,s=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,o);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(r<3?i(s):r>3?i(t,n,s):i(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},__param=this&&this.__param||function(e,t){return function(n,o){t(n,o,e)}};define(["require","exports","vs/nls","vs/base/common/errors","vs/base/common/event","vs/base/common/lifecycle","vs/base/common/objects","vs/base/common/paths","vs/base/common/winjs.base","vs/base/common/mime","vs/platform/instantiation/common/descriptors","vs/platform/extensions/common/extensions","vs/platform/extensions/common/extensionsRegistry","vs/platform/instantiation/common/instantiation","vs/editor/common/modes/abstractMode","vs/editor/common/modes/modesRegistry","vs/editor/common/services/languagesRegistry","vs/platform/configuration/common/configuration","vs/editor/common/modes/abstractState","vs/editor/common/modes/supports"],function(e,t,n,o,i,r,s,a,c,u,d,p,g,f,l,y,m,h,_,v){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";function M(e){return"undefined"==typeof e||!!Array.isArray(e)&&e.every(function(e){return"string"==typeof e})}function x(e,t){return e?"string"!=typeof e.id?(t.error(n.localize("require.id","property `{0}` is mandatory and must be of type `string`","id")),!1):M(e.extensions)?M(e.filenames)?"undefined"!=typeof e.firstLine&&"string"!=typeof e.firstLine?(t.error(n.localize("opt.firstLine","property `{0}` can be omitted and must be of type `string`","firstLine")),!1):"undefined"!=typeof e.configuration&&"string"!=typeof e.configuration?(t.error(n.localize("opt.configuration","property `{0}` can be omitted and must be of type `string`","configuration")),!1):M(e.aliases)?!!M(e.mimetypes)||(t.error(n.localize("opt.mimetypes","property `{0}` can be omitted and must be of type `string[]`","mimetypes")),!1):(t.error(n.localize("opt.aliases","property `{0}` can be omitted and must be of type `string[]`","aliases")),!1):(t.error(n.localize("opt.filenames","property `{0}` can be omitted and must be of type `string[]`","filenames")),!1):(t.error(n.localize("opt.extensions","property `{0}` can be omitted and must be of type `string[]`","extensions")),!1):(t.error(n.localize("invalid.empty","Empty value for `contributes.{0}`",b.name)),!1)}var b=g.ExtensionsRegistry.registerExtensionPoint("languages",{description:n.localize("vscode.extension.contributes.languages","Contributes language declarations."),type:"array",items:{type:"object",defaultSnippets:[{body:{id:"{{languageId}}",aliases:["{{label}}"],extensions:["{{extension}}"],configuration:"./language-configuration.json"}}],properties:{id:{description:n.localize("vscode.extension.contributes.languages.id","ID of the language."),type:"string"},aliases:{description:n.localize("vscode.extension.contributes.languages.aliases","Name aliases for the language."),type:"array",items:{type:"string"}},extensions:{description:n.localize("vscode.extension.contributes.languages.extensions","File extensions associated to the language."),"default":[".foo"],type:"array",items:{type:"string"}},filenames:{description:n.localize("vscode.extension.contributes.languages.filenames","File names associated to the language."),type:"array",items:{type:"string"}},filenamePatterns:{description:n.localize("vscode.extension.contributes.languages.filenamePatterns","File name glob patterns associated to the language."),type:"array",items:{type:"string"}},mimetypes:{description:n.localize("vscode.extension.contributes.languages.mimetypes","Mime types associated to the language."),type:"array",items:{type:"string"}},firstLine:{description:n.localize("vscode.extension.contributes.languages.firstLine","A regular expression matching the first line of a file of the language."),type:"string"},configuration:{description:n.localize("vscode.extension.contributes.languages.configuration","A relative path to a file containing configuration options for the language."),type:"string","default":"./language-configuration.json"}}}}),S=function(){function e(e,t){var n=this;this._onDidAddModes=new i.Emitter,this.onDidAddModes=this._onDidAddModes.event,this._onDidCreateMode=new i.Emitter,this.onDidCreateMode=this._onDidCreateMode.event,this._instantiationService=e,this._extensionService=t,this._activationPromises={},this._instantiatedModes={},this._config={},this._registry=new m.LanguagesRegistry,this._registry.onDidAddModes(function(e){return n._onDidAddModes.fire(e)})}return e.prototype.getConfigurationForMode=function(e){return this._config[e]||{}},e.prototype.configureMode=function(e,t){var n=this.getModeId(e);n&&this.configureModeById(n,t)},e.prototype.configureModeById=function(e,t){var n=this._config[e]||{},o=s.mixin(s.clone(n),t);if(!s.equals(n,o)){this._config[e]=o;var i=this.getMode(e);i&&i.configSupport&&i.configSupport.configure(this.getConfigurationForMode(e))}},e.prototype._configureAllModes=function(e){var t=this;if(e){var n=this._registry.getRegisteredModes();n.forEach(function(n){var o=e[n];t.configureModeById(n,o)})}},e.prototype.isRegisteredMode=function(e){return this._registry.isRegisteredMode(e)},e.prototype.isCompatMode=function(e){var t=this._registry.getCompatMode(e);return!!t},e.prototype.getRegisteredModes=function(){return this._registry.getRegisteredModes()},e.prototype.getRegisteredLanguageNames=function(){return this._registry.getRegisteredLanguageNames()},e.prototype.getExtensions=function(e){return this._registry.getExtensions(e)},e.prototype.getMimeForMode=function(e){return this._registry.getMimeForMode(e)},e.prototype.getLanguageName=function(e){return this._registry.getLanguageName(e)},e.prototype.getModeIdForLanguageName=function(e){return this._registry.getModeIdForLanguageNameLowercase(e)},e.prototype.getModeId=function(e){var t=this._registry.extractModeIds(e);return t.length>0?t[0]:null},e.prototype.getConfigurationFiles=function(e){return this._registry.getConfigurationFiles(e)},e.prototype.lookup=function(e){for(var t=[],n=this._registry.extractModeIds(e),o=0;o<n.length;o++){var i=n[o];t.push({modeId:i,isInstantiated:this._instantiatedModes.hasOwnProperty(i)})}return t},e.prototype.getMode=function(e){for(var t=this._registry.extractModeIds(e),n=!1,i=0;i<t.length;i++){if(this._instantiatedModes.hasOwnProperty(t[i]))return this._instantiatedModes[t[i]];n=n||"plaintext"===t[i]}if(n){var r=null;return this.getOrCreateMode(e).then(function(e){r=e}).done(null,o.onUnexpectedError),r}},e.prototype.getModeIdByLanguageName=function(e){var t=this._registry.getModeIdsFromLanguageName(e);return t.length>0?t[0]:null},e.prototype.getModeIdByFilenameOrFirstLine=function(e,t){var n=this._registry.getModeIdsFromFilenameOrFirstLine(e,t);return n.length>0?n[0]:null},e.prototype.onReady=function(){return this._extensionService.onReady()},e.prototype.getOrCreateMode=function(e){var t=this;return this.onReady().then(function(){var n=t.getModeId(e);return t._getOrCreateMode(n||"plaintext")})},e.prototype.getOrCreateModeByLanguageName=function(e){var t=this;return this.onReady().then(function(){var n=t.getModeIdByLanguageName(e);return t._getOrCreateMode(n||"plaintext")})},e.prototype.getOrCreateModeByFilenameOrFirstLine=function(e,t){var n=this;return this.onReady().then(function(){var o=n.getModeIdByFilenameOrFirstLine(e,t);return n._getOrCreateMode(o||"plaintext")})},e.prototype._getOrCreateMode=function(e){var t=this;if(this._instantiatedModes.hasOwnProperty(e))return c.TPromise.as(this._instantiatedModes[e]);if(this._activationPromises.hasOwnProperty(e))return this._activationPromises[e];var n,i,r=new c.TPromise(function(e,t,o){n=e,i=t});return this._activationPromises[e]=r,this._createMode(e).then(function(n){return t._instantiatedModes[e]=n,delete t._activationPromises[e],t._onDidCreateMode.fire(n),t._extensionService.activateByEvent("onLanguage:"+e).done(null,o.onUnexpectedError),t._instantiatedModes[e]}).then(n,i),r},e.prototype._createMode=function(e){var t=this,n=this._createModeDescriptor(e),o=this._registry.getCompatMode(e);if(o){var i=null;return i=Array.isArray(o.deps)?c.TPromise.join(o.deps.map(function(e){return t.getOrCreateMode(e)})):c.TPromise.as(null),i.then(function(i){var r=d.createAsyncDescriptor1(o.moduleId,o.ctorName);return t._instantiationService.createInstance(r,n).then(function(n){return n.configSupport&&n.configSupport.configure(t.getConfigurationForMode(e)),n})})}return c.TPromise.as(this._instantiationService.createInstance(l.FrankensteinMode,n))},e.prototype._createModeDescriptor=function(e){return{id:e}},e.prototype._registerTokenizationSupport=function(e,t){return e.setTokenizationSupport?e.setTokenizationSupport(t):(console.warn("Cannot register tokenizationSupport on mode "+e.getId()+" because it does not support it."),r.empty)},e.prototype.registerModeSupport=function(e,t){var n=this;if(this._instantiatedModes.hasOwnProperty(e))return this._registerTokenizationSupport(this._instantiatedModes[e],t);var o,i=new c.TPromise(function(e,t){o=e}),r=this.onDidCreateMode(function(i){i.getId()===e&&(o(n._registerTokenizationSupport(i,t)),r.dispose())});return{dispose:function(){i.done(function(e){return e.dispose()},null)}}},e.prototype.registerTokenizationSupport=function(e,t){return this.registerModeSupport(e,t)},e.prototype.registerTokenizationSupport2=function(e,t){return this.registerModeSupport(e,function(e){return new C(e,t)})},e}();t.ModeServiceImpl=S;var I=function(){function e(e,t,n){this._mode=e,this._actual=t,this._stateData=n}return Object.defineProperty(e.prototype,"actual",{get:function(){return this._actual},enumerable:!0,configurable:!0}),e.prototype.clone=function(){return new e(this._mode,this._actual.clone(),_.AbstractState.safeClone(this._stateData))},e.prototype.equals=function(t){return t instanceof e&&(!!this._actual.equals(t._actual)&&_.AbstractState.safeEquals(this._stateData,t._stateData))},e.prototype.getMode=function(){return this._mode},e.prototype.tokenize=function(e){throw new Error("Unexpected tokenize call!")},e.prototype.getStateData=function(){return this._stateData},e.prototype.setStateData=function(e){this._stateData=e},e}();t.TokenizationState2Adapter=I;var C=function(){function e(e,t){this._mode=e,this._actual=t}return e.prototype.getInitialState=function(){return new I(this._mode,this._actual.getInitialState(),null)},e.prototype.tokenize=function(e,t,n,o){if(void 0===n&&(n=0),t instanceof I){var i=this._actual.tokenize(e,t.actual),r=[];return i.tokens.forEach(function(e){if("string"==typeof e.scopes)r.push(new v.Token(e.startIndex+n,e.scopes));else{if(!Array.isArray(e.scopes)||1!==e.scopes.length)throw new Error("Only token scopes as strings or of precisely 1 length are supported at this time!");r.push(new v.Token(e.startIndex+n,e.scopes[0]))}}),{tokens:r,actualStopOffset:n+e.length,endState:new I(t.getMode(),i.endState,t.getStateData()),modeTransitions:[{startIndex:n,mode:t.getMode()}]}}throw new Error("Unexpected state to tokenize with!")},e}();t.TokenizationSupport2Adapter=C;var z=function(e){function t(t,o,i){var r=this;e.call(this,t,o),this._configurationService=i,b.setHandler(function(e){for(var t=[],o=0,i=e.length;o<i;o++){var r=e[o];if(Array.isArray(r.value))for(var s=0,c=r.value.length;s<c;s++){var u=r.value[s];if(x(u,r.collector)){var d=u.configuration?a.join(r.description.extensionFolderPath,u.configuration):u.configuration;t.push({id:u.id,extensions:u.extensions,filenames:u.filenames,filenamePatterns:u.filenamePatterns,firstLine:u.firstLine,aliases:u.aliases,mimetypes:u.mimetypes,configuration:d})}}else r.collector.error(n.localize("invalid","Invalid `contributes.{0}`. Expected an array.",b.name))}y.ModesRegistry.registerLanguages(t)}),this._configurationService.onDidUpdateConfiguration(function(e){return r.onConfigurationChange(e.config)})}return __extends(t,e),t.prototype.onReady=function(){var e=this;if(!this._onReadyPromise){var t=this._configurationService.getConfiguration();this._onReadyPromise=this._extensionService.onReady().then(function(){return e.onConfigurationChange(t),!0})}return this._onReadyPromise},t.prototype.onConfigurationChange=function(e){var t=this;this._configureAllModes(e),u.clearTextMimes(!0),e.files&&e.files.associations&&Object.keys(e.files.associations).forEach(function(n){u.registerTextMime({mime:t.getMimeForMode(e.files.associations[n]),filepattern:n,userConfigured:!0})})},t=__decorate([__param(0,f.IInstantiationService),__param(1,p.IExtensionService),__param(2,h.IConfigurationService)],t)}(S);t.MainThreadModeServiceImpl=z});