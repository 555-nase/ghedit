var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};define(["require","exports","vs/nls","vs/base/common/arrays","vs/base/common/collections","vs/base/common/uri","vs/base/common/winjs.base","vs/platform/files/common/files","vs/editor/common/core/editOperation","vs/editor/common/core/range","vs/editor/common/core/selection"],function(e,t,r,n,o,i,s,u,a,c,l){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";function h(e,t,r,n,o){void 0===o&&(o=null);var i=d(e,t,r);return i.add(n),i.progress(o),i.finish()}function d(e,t,n){function o(e){c=e}function i(e){l.push.apply(l,e)}function u(){for(var e,t=0,n=l;t<n.length;t++){var o=n[t];h.hasChanged(o.resource)&&(e||(e=[]),e.push(o.resource.fsPath))}if(e)return r.localize("conflict","These files have changed in the meantime: {0}",e.join(", "))}function a(){if(0===l.length)return s.TPromise.as(void 0);var e=u();if(e)return s.TPromise.wrapError(e);var r,o;n&&n.getModel()&&(r=n.getModel().uri,o=n.getSelections());var i=new g(t,r,o,l,c);return i.prepare().then(function(e){var t=u();if(t)throw new Error(t);return h.stop(),i.apply()})}var c,l=[],h=new p(e).start();return{progress:o,add:i,finish:a}}var p=function(){function e(e){this._eventService=e}return e.prototype.start=function(){var e=Object.create(null),t=this._eventService.addListener2(u.EventType.FILE_CHANGES,function(t){t.changes.forEach(function(t){var r=String(t.resource),n=e[r];n||(e[r]=n=[]),n.push(t)})});return{stop:function(){t.dispose()},hasChanged:function(t){return!!e[t.toString()]},allChanges:function(){return n.merge(o.values(e))}}},e}(),f=function(){function e(e){this._endCursorSelection=null,this._model=e,this._edits=[]}return e.prototype.addEdit=function(e){var t;t=e.range?e.range:this._model.getFullModelRange(),this._edits.push(a.EditOperation.replace(c.Range.lift(t),e.newText))},e.prototype.apply=function(){var t=this;0!==this._edits.length&&(this._edits.sort(e._editCompare),this._initialSelections=this._getInitialSelections(),this._model.pushEditOperations(this._initialSelections,this._edits,function(e){return t._getEndCursorSelections(e)}))},e.prototype._getInitialSelections=function(){var e=this._edits[0].range,t=new l.Selection(e.startLineNumber,e.startColumn,e.endLineNumber,e.endColumn);return[t]},e.prototype._getEndCursorSelections=function(e){for(var t=0,r=0;r<e.length;r++)for(var n=e[r].range,o=0;o<this._initialSelections.length;o++){var i=this._initialSelections[o];if(c.Range.areIntersectingOrTouching(n,i)){t=r;break}}var s=e[t].range;return this._endCursorSelection=new l.Selection(s.endLineNumber,s.endColumn,s.endLineNumber,s.endColumn),[this._endCursorSelection]},e.prototype.getEndCursorSelection=function(){return this._endCursorSelection},e._editCompare=function(e,t){return c.Range.compareRangesUsingStarts(e.range,t.range)},e}(),_=function(e){function t(t,r){e.call(this,t),this._knownInitialSelections=r}return __extends(t,e),t.prototype._getInitialSelections=function(){return this._knownInitialSelections},t}(f),g=function(){function e(e,t,r,n,o){void 0===o&&(o=null),this.progress=o,this._numberOfResourcesToModify=0,this._numberOfChanges=0,this._edits=Object.create(null),this._editorService=e,this._sourceModel=t,this._sourceSelections=r,this._sourceModelTask=null;for(var i=0,s=n;i<s.length;i++){var u=s[i];this._addEdit(u)}}return e.prototype.resourcesCount=function(){return this._numberOfResourcesToModify},e.prototype.changeCount=function(){return this._numberOfChanges},e.prototype._addEdit=function(e){var t=this._edits[e.resource.toString()];t||(this._edits[e.resource.toString()]=t=[],this._numberOfResourcesToModify+=1),this._numberOfChanges+=1,t.push(e)},e.prototype.prepare=function(){var e=this;if(this._tasks)throw new Error("illegal state - already prepared");this._tasks=[];var t=[];return this.progress&&this.progress.total(2*this._numberOfResourcesToModify),o.forEach(this._edits,function(r){var n=e._editorService.resolveEditorModel({resource:i["default"].parse(r.key)}).then(function(t){if(!t||!t.textEditorModel)throw new Error("Cannot load file "+r.key);var n,o=t.textEditorModel;e._sourceModel&&o.uri.toString()===e._sourceModel.toString()?(e._sourceModelTask=new _(o,e._sourceSelections),n=e._sourceModelTask):n=new f(o),r.value.forEach(function(e){return n.addEdit(e)}),e._tasks.push(n),e.progress&&e.progress.worked(1)});t.push(n)}),s.TPromise.join(t).then(function(t){return e})},e.prototype.apply=function(){var e=this;this._tasks.forEach(function(t){return e.applyTask(t)});var t=null;return this._sourceModelTask&&(t=this._sourceModelTask.getEndCursorSelection()),t},e.prototype.applyTask=function(e){e.apply(),this.progress&&this.progress.worked(1)},e}();t.bulkEdit=h,t.createBulkEdit=d});