define(["require","exports","vs/base/common/errors","vs/editor/common/controller/oneCursor","vs/editor/common/core/selection","vs/editor/common/modes/languageConfigurationRegistry"],function(r,e,t,o,s,i){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var n=function(){function r(r,e,t,s){this.editorId=r,this.model=e,this.configuration=t,this.viewModelHelper=s,this.modeConfiguration=this.getModeConfiguration(),this.primaryCursor=new o.OneCursor(this.editorId,this.model,this.configuration,this.modeConfiguration,this.viewModelHelper),this.secondaryCursors=[],this.lastAddedCursorIndex=0}return r.prototype.dispose=function(){this.primaryCursor.dispose(),this.killSecondaryCursors()},r.prototype.saveState=function(){return{primary:this.primaryCursor.saveState(),secondary:this.secondaryCursors.map(function(r){return r.saveState()})}},r.prototype.restoreState=function(r){this.primaryCursor.restoreState(r.primary),this.killSecondaryCursors();for(var e=0;e<r.secondary.length;e++)this.addSecondaryCursor(null),this.secondaryCursors[e].restoreState(r.secondary[e])},r.prototype.updateMode=function(){var r=this;this.modeConfiguration=this.getModeConfiguration(),this.getAll().forEach(function(e){e.updateModeConfiguration(r.modeConfiguration)})},r.prototype.getAll=function(){var r=[];return r.push(this.primaryCursor),r=r.concat(this.secondaryCursors)},r.prototype.getPosition=function(r){return 0===r?this.primaryCursor.getPosition():this.secondaryCursors[r-1].getPosition()},r.prototype.getViewPosition=function(r){return 0===r?this.primaryCursor.getViewPosition():this.secondaryCursors[r-1].getViewPosition()},r.prototype.getPositions=function(){var r=[];r.push(this.primaryCursor.getPosition());for(var e=0,t=this.secondaryCursors.length;e<t;e++)r.push(this.secondaryCursors[e].getPosition());return r},r.prototype.getViewPositions=function(){var r=[];r.push(this.primaryCursor.getViewPosition());for(var e=0,t=this.secondaryCursors.length;e<t;e++)r.push(this.secondaryCursors[e].getViewPosition());return r},r.prototype.getSelection=function(r){return 0===r?this.primaryCursor.getSelection():this.secondaryCursors[r-1].getSelection()},r.prototype.getSelections=function(){var r=[];r.push(this.primaryCursor.getSelection());for(var e=0,t=this.secondaryCursors.length;e<t;e++)r.push(this.secondaryCursors[e].getSelection());return r},r.prototype.getViewSelections=function(){var r=[];r.push(this.primaryCursor.getViewSelection());for(var e=0,t=this.secondaryCursors.length;e<t;e++)r.push(this.secondaryCursors[e].getViewSelection());return r},r.prototype.setSelections=function(r,e){if(this.primaryCursor.setSelection(r[0]),this._setSecondarySelections(r.slice(1)),e){this.primaryCursor.setViewSelection(e[0]);for(var t=0;t<this.secondaryCursors.length;t++)this.secondaryCursors[t].setViewSelection(e[t+1])}},r.prototype.killSecondaryCursors=function(){return this._setSecondarySelections([])>0},r.prototype.normalize=function(){this._mergeCursorsIfNecessary(),this.primaryCursor.adjustBracketDecorations();for(var r=0,e=this.secondaryCursors.length;r<e;r++)this.secondaryCursors[r].adjustBracketDecorations()},r.prototype.addSecondaryCursor=function(r){var e=new o.OneCursor(this.editorId,this.model,this.configuration,this.modeConfiguration,this.viewModelHelper);r&&e.setSelection(r),this.secondaryCursors.push(e),this.lastAddedCursorIndex=this.secondaryCursors.length},r.prototype.duplicateCursors=function(){var r=[];r.push(this.primaryCursor.duplicate());for(var e=0,t=this.secondaryCursors.length;e<t;e++)r.push(this.secondaryCursors[e].duplicate());this.secondaryCursors=this.secondaryCursors.concat(r),this.lastAddedCursorIndex=this.secondaryCursors.length},r.prototype.getLastAddedCursor=function(){return 0===this.secondaryCursors.length||0===this.lastAddedCursorIndex?this.primaryCursor:this.secondaryCursors[this.lastAddedCursorIndex-1]},r.prototype._setSecondarySelections=function(r){var e=this.secondaryCursors.length,t=r.length,o=t-e;if(e<t)for(var s=t-e,i=0;i<s;i++)this.addSecondaryCursor(null);else if(e>t)for(var n=e-t,i=0;i<n;i++)this._removeSecondaryCursor(this.secondaryCursors.length-1);for(var i=0;i<t;i++)r[i]&&this.secondaryCursors[i].setSelection(r[i]);return o},r.prototype._removeSecondaryCursor=function(r){this.lastAddedCursorIndex>=r+1&&this.lastAddedCursorIndex--,this.secondaryCursors[r].dispose(),this.secondaryCursors.splice(r,1)},r.prototype._mergeCursorsIfNecessary=function(){if(0!==this.secondaryCursors.length){for(var r=this.getAll(),e=[],t=0;t<r.length;t++)e.push({index:t,selection:r[t].getSelection(),viewSelection:r[t].getViewSelection()});e.sort(function(r,e){return r.viewSelection.startLineNumber===e.viewSelection.startLineNumber?r.viewSelection.startColumn-e.viewSelection.startColumn:r.viewSelection.startLineNumber-e.viewSelection.startLineNumber});for(var o=0;o<e.length-1;o++){var i=e[o],n=e[o+1],a=i.viewSelection,u=n.viewSelection;if(u.getStartPosition().isBeforeOrEqual(a.getEndPosition())){var c=i.index<n.index?o:o+1,d=i.index<n.index?o+1:o,l=e[d].index,h=e[c].index,C=e[d].selection,p=e[c].selection;if(!C.equalsSelection(p)){var y,g=C.plusRange(p),f=C.selectionStartLineNumber===C.startLineNumber&&C.selectionStartColumn===C.startColumn,m=p.selectionStartLineNumber===p.startLineNumber&&p.selectionStartColumn===p.startColumn;l===this.lastAddedCursorIndex?(y=f,this.lastAddedCursorIndex=h):y=m;var S;S=y?new s.Selection(g.startLineNumber,g.startColumn,g.endLineNumber,g.endColumn):new s.Selection(g.endLineNumber,g.endColumn,g.startLineNumber,g.startColumn),e[c].selection=S,r[h].setSelection(S)}for(var v=0;v<e.length;v++)e[v].index>l&&e[v].index--;r.splice(l,1),e.splice(d,1),this._removeSecondaryCursor(l-1),o--}}}},r.prototype.getModeConfiguration=function(){var r,e={electricChars:{},autoClosingPairsOpen:{},autoClosingPairsClose:{},surroundingPairs:{}},o=i.LanguageConfigurationRegistry.getElectricCharacterSupport(this.model.getMode().getId());if(o){var s=null;try{s=o.getElectricCharacters()}catch(n){t.onUnexpectedError(n),s=null}if(s)for(r=0;r<s.length;r++)e.electricChars[s[r]]=!0}var a=i.LanguageConfigurationRegistry.getCharacterPairSupport(this.model.getMode().getId());if(a){var u=void 0;try{u=a.getAutoClosingPairs()}catch(n){t.onUnexpectedError(n),u=null}if(u)for(r=0;r<u.length;r++)e.autoClosingPairsOpen[u[r].open]=u[r].close,e.autoClosingPairsClose[u[r].close]=u[r].open;var c=void 0;try{c=a.getSurroundingPairs()}catch(n){t.onUnexpectedError(n),c=null}if(c)for(r=0;r<c.length;r++)e.surroundingPairs[c[r].open]=c[r].close}return e},r}();e.CursorCollection=n});