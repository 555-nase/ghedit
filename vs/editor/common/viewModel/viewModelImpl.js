var __extends=this&&this.__extends||function(e,n){function t(){this.constructor=e}for(var o in n)n.hasOwnProperty(o)&&(e[o]=n[o]);e.prototype=null===n?Object.create(n):(t.prototype=n.prototype,new t)};define(["require","exports","vs/base/common/eventEmitter","vs/base/common/lifecycle","vs/base/common/strings","vs/editor/common/core/position","vs/editor/common/core/range","vs/editor/common/core/selection","vs/editor/common/editorCommon","vs/editor/common/viewModel/viewModelCursors","vs/editor/common/viewModel/viewModelDecorations"],function(e,n,t,o,i,r,s,u,a,l,c){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var d=function(e){function n(n,o,i,r,s){var u=this;e.call(this),this.lines=n,this.editorId=o,this.configuration=i,this.model=r,this.getCurrentCenteredModelRange=s,this.decorations=new c.ViewModelDecorations(this.editorId,this.configuration,{convertModelRangeToViewRange:function(e,n){return n?u.convertWholeLineModelRangeToViewRange(e):u.convertModelRangeToViewRange(e)}}),this.decorations.reset(this.model),this.cursors=new l.ViewModelCursors(this.configuration,this),this.listenersToRemove=[],this._toDispose=[],this.listenersToRemove.push(this.model.addBulkListener(function(e){return u.onEvents(e)})),this._toDispose.push(this.configuration.onDidChange(function(e){u.onEvents([new t.EmitterEvent(a.EventType.ConfigurationChanged,e)])}))}return __extends(n,e),n.prototype.setHiddenAreas=function(e){var n=this;this.deferredEmit(function(){var t=n.lines.setHiddenAreas(e,function(e,t){return n.emit(e,t)});t&&(n.emit(a.ViewEventNames.LineMappingChangedEvent),n.decorations.onLineMappingChanged(function(e,t){return n.emit(e,t)}),n.cursors.onLineMappingChanged(function(e,t){return n.emit(e,t)}))})},n.prototype.dispose=function(){this.listenersToRemove=o.dispose(this.listenersToRemove),this._toDispose=o.dispose(this._toDispose),this.decorations.dispose(),this.decorations=null,this.lines.dispose(),this.lines=null,this.configuration=null,this.model=null},n.prototype._onTabSizeChange=function(e){var n=this,t=this.lines.setTabSize(e,function(e,t){return n.emit(e,t)});return t&&(this.emit(a.ViewEventNames.LineMappingChangedEvent),this.decorations.onLineMappingChanged(function(e,t){return n.emit(e,t)}),this.cursors.onLineMappingChanged(function(e,t){return n.emit(e,t)})),t},n.prototype._onWrappingIndentChange=function(e){var n=this,t=this.lines.setWrappingIndent(e,function(e,t){return n.emit(e,t)});return t&&(this.emit(a.ViewEventNames.LineMappingChangedEvent),this.decorations.onLineMappingChanged(function(e,t){return n.emit(e,t)}),this.cursors.onLineMappingChanged(function(e,t){return n.emit(e,t)})),t},n.prototype._restoreCenteredModelRange=function(e){var n=this.convertModelRangeToViewRange(e),t={range:n,verticalType:a.VerticalRevealType.Center,revealHorizontal:!1};this.emit(a.ViewEventNames.RevealRangeEvent,t)},n.prototype._onWrappingColumnChange=function(e,n){var t=this,o=this.lines.setWrappingColumn(e,n,function(e,n){return t.emit(e,n)});return o&&(this.emit(a.ViewEventNames.LineMappingChangedEvent),this.decorations.onLineMappingChanged(function(e,n){return t.emit(e,n)}),this.cursors.onLineMappingChanged(function(e,n){return t.emit(e,n)})),o},n.prototype.addEventSource=function(e){var n=this;this.listenersToRemove.push(e.addBulkListener2(function(e){return n.onEvents(e)}))},n.prototype.onEvents=function(e){var n=this;this.deferredEmit(function(){var t,o=e.some(function(e){return e.getType()===a.EventType.ModelRawContentChanged});o||(t=n.getCurrentCenteredModelRange());var i,r,s,u,l,c=!1,d=!1,p=!1;for(i=0,r=e.length;i<r;i++)switch(s=e[i],u=s.getData(),s.getType()){case a.EventType.ModelRawContentChanged:switch(l=u,l.changeType){case a.EventType.ModelRawContentChangedFlush:n.onModelFlushed(l),c=!0;break;case a.EventType.ModelRawContentChangedLinesDeleted:n.onModelLinesDeleted(l),c=!0;break;case a.EventType.ModelRawContentChangedLinesInserted:n.onModelLinesInserted(l),c=!0;break;case a.EventType.ModelRawContentChangedLineChanged:d=n.onModelLineChanged(l);break;default:console.info("ViewModel received unknown event: "),console.info(s)}break;case a.EventType.ModelTokensChanged:n.onModelTokensChanged(u);break;case a.EventType.ModelModeChanged:break;case a.EventType.ModelModeSupportChanged:break;case a.EventType.ModelContentChanged2:break;case a.EventType.ModelOptionsChanged:var h=n.lines.getOutputLineCount(),m=n._onTabSizeChange(n.model.getOptions().tabSize),g=n.lines.getOutputLineCount();m&&h!==g&&(p=!0);break;case a.EventType.ModelDecorationsChanged:n.onModelDecorationsChanged(u);break;case a.EventType.ModelDispose:break;case a.EventType.CursorPositionChanged:n.onCursorPositionChanged(u);break;case a.EventType.CursorSelectionChanged:n.onCursorSelectionChanged(u);break;case a.EventType.CursorRevealRange:n.onCursorRevealRange(u);break;case a.EventType.CursorScrollRequest:n.onCursorScrollRequest(u);break;case a.EventType.ConfigurationChanged:if(p=n._onWrappingIndentChange(n.configuration.editor.wrappingInfo.wrappingIndent)||p,p=n._onWrappingColumnChange(n.configuration.editor.wrappingInfo.wrappingColumn,n.configuration.editor.fontInfo.typicalFullwidthCharacterWidth/n.configuration.editor.fontInfo.typicalHalfwidthCharacterWidth)||p,u.readOnly){n.decorations.reset(n.model);var v={inlineDecorationsChanged:!1};n.emit(a.ViewEventNames.DecorationsChangedEvent,v)}n.emit(s.getType(),u);break;default:console.info("View received unknown event: "),console.info(s)}!c&&d&&(n.emit(a.ViewEventNames.LineMappingChangedEvent),n.decorations.onLineMappingChanged(function(e,t){return n.emit(e,t)}),n.cursors.onLineMappingChanged(function(e,t){return n.emit(e,t)})),p&&t&&n._restoreCenteredModelRange(t)})},n.prototype.onModelFlushed=function(e){var n=this;this.lines.onModelFlushed(e.versionId,function(e,t){return n.emit(e,t)}),this.decorations.reset(this.model)},n.prototype.onModelDecorationsChanged=function(e){var n=this;this.decorations.onModelDecorationsChanged(e,function(e,t){return n.emit(e,t)})},n.prototype.onModelLinesDeleted=function(e){var n=this;this.lines.onModelLinesDeleted(e.versionId,e.fromLineNumber,e.toLineNumber,function(e,t){return n.emit(e,t)})},n.prototype.onModelTokensChanged=function(e){var n=this.convertModelPositionToViewPosition(e.fromLineNumber,1).lineNumber,t=this.convertModelPositionToViewPosition(e.toLineNumber,this.model.getLineMaxColumn(e.toLineNumber)).lineNumber,e={fromLineNumber:n,toLineNumber:t};this.emit(a.ViewEventNames.TokensChangedEvent,e)},n.prototype.onModelLineChanged=function(e){var n=this,t=this.lines.onModelLineChanged(e.versionId,e.lineNumber,e.detail,function(e,t){return n.emit(e,t)});return t},n.prototype.onModelLinesInserted=function(e){var n=this;this.lines.onModelLinesInserted(e.versionId,e.fromLineNumber,e.toLineNumber,e.detail.split("\n"),function(e,t){return n.emit(e,t)})},n.prototype.validateViewRange=function(e,n,t,o,i){var r=this.validateViewPosition(n,n,i.getStartPosition()),u=this.validateViewPosition(t,o,i.getEndPosition());return new s.Range(r.lineNumber,r.column,u.lineNumber,u.column)},n.prototype.validateViewPosition=function(e,n,t){e<1&&(e=1);var o=this.getLineCount();e>o&&(e=o);var i=this.getLineMinColumn(e),s=this.getLineMaxColumn(e);n<i&&(n=i),n>s&&(n=s);var u=this.convertViewPositionToModelPosition(e,n);return u.equals(t)?new r.Position(e,n):this.convertModelPositionToViewPosition(t.lineNumber,t.column)},n.prototype.validateViewSelection=function(e,n){var t=new r.Position(n.selectionStartLineNumber,n.selectionStartColumn),o=new r.Position(n.positionLineNumber,n.positionColumn),i=this.validateViewPosition(e.selectionStartLineNumber,e.selectionStartColumn,t),s=this.validateViewPosition(e.positionLineNumber,e.positionColumn,o);return new u.Selection(i.lineNumber,i.column,s.lineNumber,s.column)},n.prototype.onCursorPositionChanged=function(e){var n=this;this.cursors.onCursorPositionChanged(e,function(e,t){return n.emit(e,t)})},n.prototype.onCursorSelectionChanged=function(e){var n=this;this.cursors.onCursorSelectionChanged(e,function(e,t){return n.emit(e,t)})},n.prototype.onCursorRevealRange=function(e){var n=this;this.cursors.onCursorRevealRange(e,function(e,t){return n.emit(e,t)})},n.prototype.onCursorScrollRequest=function(e){var n=this;this.cursors.onCursorScrollRequest(e,function(e,t){return n.emit(e,t)})},n.prototype.getTabSize=function(){return this.model.getOptions().tabSize},n.prototype.getLineCount=function(){return this.lines.getOutputLineCount()},n.prototype.getLineContent=function(e){return this.lines.getOutputLineContent(e)},n.prototype.getLineIndentGuide=function(e){return this.lines.getOutputIndentGuide(e)},n.prototype.getLineMinColumn=function(e){return this.lines.getOutputLineMinColumn(e)},n.prototype.getLineMaxColumn=function(e){return this.lines.getOutputLineMaxColumn(e)},n.prototype.getLineFirstNonWhitespaceColumn=function(e){var n=i.firstNonWhitespaceIndex(this.getLineContent(e));return n===-1?0:n+1},n.prototype.getLineLastNonWhitespaceColumn=function(e){var n=i.lastNonWhitespaceIndex(this.getLineContent(e));return n===-1?0:n+2},n.prototype.getLineTokens=function(e){return this.lines.getOutputLineTokens(e)},n.prototype.getLineRenderLineNumber=function(e){var n=this.convertViewPositionToModelPosition(e,1);if(1!==n.column)return"";var t=n.lineNumber;return"function"==typeof this.configuration.editor.viewInfo.lineNumbers?this.configuration.editor.viewInfo.lineNumbers(t):t.toString()},n.prototype.getMaxLineNumber=function(){return this.model.getLineCount()},n.prototype.getDecorationsViewportData=function(e,n){return this.decorations.getDecorationsViewportData(e,n)},n.prototype.getAllDecorations=function(){return this.decorations.getAllDecorations()},n.prototype.getEOL=function(){return this.model.getEOL()},n.prototype.getValueInRange=function(e,n){var t=this.convertViewRangeToModelRange(e);return this.model.getValueInRange(t,n)},n.prototype.getSelections=function(){return this.cursors.getSelections()},n.prototype.convertViewPositionToModelPosition=function(e,n){return this.lines.convertOutputPositionToInputPosition(e,n)},n.prototype.convertViewRangeToModelRange=function(e){var n=this.convertViewPositionToModelPosition(e.startLineNumber,e.startColumn),t=this.convertViewPositionToModelPosition(e.endLineNumber,e.endColumn);return new s.Range(n.lineNumber,n.column,t.lineNumber,t.column)},n.prototype.convertViewSelectionToModelSelection=function(e){var n=this.convertViewPositionToModelPosition(e.selectionStartLineNumber,e.selectionStartColumn),t=this.convertViewPositionToModelPosition(e.positionLineNumber,e.positionColumn);return new u.Selection(n.lineNumber,n.column,t.lineNumber,t.column)},n.prototype.getModelLineContent=function(e){return this.model.getLineContent(e)},n.prototype.getModelLineMaxColumn=function(e){return this.model.getLineMaxColumn(e)},n.prototype.validateModelPosition=function(e){return this.model.validatePosition(e)},n.prototype.convertModelPositionToViewPosition=function(e,n){return this.lines.convertInputPositionToOutputPosition(e,n)},n.prototype.convertModelRangeToViewRange=function(e){var n=this.convertModelPositionToViewPosition(e.startLineNumber,e.startColumn),t=this.convertModelPositionToViewPosition(e.endLineNumber,e.endColumn);return new s.Range(n.lineNumber,n.column,t.lineNumber,t.column)},n.prototype.convertWholeLineModelRangeToViewRange=function(e){var n=this.convertModelPositionToViewPosition(e.startLineNumber,1),t=this.convertModelPositionToViewPosition(e.endLineNumber,this.model.getLineMaxColumn(e.endLineNumber));return new s.Range(n.lineNumber,n.column,t.lineNumber,t.column)},n.prototype.convertModelSelectionToViewSelection=function(e){var n=this.convertModelPositionToViewPosition(e.selectionStartLineNumber,e.selectionStartColumn),t=this.convertModelPositionToViewPosition(e.positionLineNumber,e.positionColumn);return new u.Selection(n.lineNumber,n.column,t.lineNumber,t.column)},n.prototype.modelPositionIsVisible=function(e){return this.lines.inputPositionIsVisible(e.lineNumber,e.column)},n}(t.EventEmitter);n.ViewModel=d});