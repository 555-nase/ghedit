var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)};define(["require","exports","vs/base/common/actions","vs/base/common/errors","vs/base/common/eventEmitter","vs/base/common/lifecycle","vs/base/common/timer","vs/base/common/winjs.base","vs/platform/instantiation/common/serviceCollection","vs/platform/keybinding/common/keybinding","vs/editor/common/config/defaultConfig","vs/editor/common/controller/cursor","vs/editor/common/controller/cursorMoveHelper","vs/editor/common/core/editorState","vs/editor/common/core/position","vs/editor/common/core/range","vs/editor/common/core/selection","vs/editor/common/editorAction","vs/editor/common/editorCommon","vs/editor/common/viewModel/characterHardWrappingLineMapper","vs/editor/common/viewModel/splitLinesCollection","vs/editor/common/viewModel/viewModelImpl","vs/base/common/hash","vs/editor/common/modes/editorModeContext"],function(e,t,o,i,n,r,s,a,d,l,c,u,p,h,v,y,m,g,f,C,T,E,_,b){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var M=0,w=function(e){function t(t,o,i,n,r,a,u){var p=this;e.call(this),this.domElement=t,this.id=++M,this._codeEditorService=n;var h=s.start(s.Topic.EDITOR,"CodeEditor.ctor");this._lifetimeDispose=[],this._commandService=r,this._keybindingService=a,this._editorIdContextKey=this._keybindingService.createKey("editorId",this.getId()),this._editorFocusContextKey=this._keybindingService.createKey(f.KEYBINDING_CONTEXT_EDITOR_FOCUS,void 0),this._editorTabMovesFocusKey=this._keybindingService.createKey(f.KEYBINDING_CONTEXT_EDITOR_TAB_MOVES_FOCUS,!1),this._editorReadonly=this._keybindingService.createKey(f.KEYBINDING_CONTEXT_EDITOR_READONLY,!1),this._hasMultipleSelectionsKey=this._keybindingService.createKey(f.KEYBINDING_CONTEXT_EDITOR_HAS_MULTIPLE_SELECTIONS,!1),this._hasNonEmptySelectionKey=this._keybindingService.createKey(f.KEYBINDING_CONTEXT_EDITOR_HAS_NON_EMPTY_SELECTION,!1),this._langIdKey=this._keybindingService.createKey(f.KEYBINDING_CONTEXT_EDITOR_LANGUAGE_ID,void 0),this._lifetimeDispose.push(new b.EditorModeContext(this,this._keybindingService)),this._decorationTypeKeysToIds={},this._decorationTypeSubtypes={},o=o||{},"undefined"==typeof o.ariaLabel&&(o.ariaLabel=c.DefaultConfig.editor.ariaLabel),this._configuration=this._createConfiguration(o),this._configuration.editor.tabFocusMode&&this._editorTabMovesFocusKey.set(!0),this._editorReadonly.set(this._configuration.editor.readOnly),this._lifetimeDispose.push(this._configuration.onDidChange(function(e){p._configuration.editor.tabFocusMode?p._editorTabMovesFocusKey.set(!0):p._editorTabMovesFocusKey.reset(),p.emit(f.EventType.ConfigurationChanged,e)})),this._telemetryService=u,this._instantiationService=i.createChild(new d.ServiceCollection([l.IKeybindingService,this._keybindingService])),this._attachModel(null),this.contributions={},h.stop(),this._codeEditorService.addCodeEditor(this)}return __extends(t,e),t.prototype.onDidChangeModelRawContent=function(e){return this.addListener2(f.EventType.ModelRawContentChanged,e)},t.prototype.onDidChangeModelContent=function(e){return this.addListener2(f.EventType.ModelContentChanged2,e)},t.prototype.onDidChangeModelMode=function(e){return this.addListener2(f.EventType.ModelModeChanged,e)},t.prototype.onDidChangeModelOptions=function(e){return this.addListener2(f.EventType.ModelOptionsChanged,e)},t.prototype.onDidChangeModelModeSupport=function(e){return this.addListener2(f.EventType.ModelModeSupportChanged,e)},t.prototype.onDidChangeModelDecorations=function(e){return this.addListener2(f.EventType.ModelDecorationsChanged,e)},t.prototype.onDidChangeConfiguration=function(e){return this.addListener2(f.EventType.ConfigurationChanged,e)},t.prototype.onDidChangeModel=function(e){return this.addListener2(f.EventType.ModelChanged,e)},t.prototype.onDidChangeCursorPosition=function(e){return this.addListener2(f.EventType.CursorPositionChanged,e)},t.prototype.onDidChangeCursorSelection=function(e){return this.addListener2(f.EventType.CursorSelectionChanged,e)},t.prototype.onDidFocusEditorText=function(e){return this.addListener2(f.EventType.EditorTextFocus,e)},t.prototype.onDidBlurEditorText=function(e){return this.addListener2(f.EventType.EditorTextBlur,e)},t.prototype.onDidFocusEditor=function(e){return this.addListener2(f.EventType.EditorFocus,e)},t.prototype.onDidBlurEditor=function(e){return this.addListener2(f.EventType.EditorBlur,e)},t.prototype.onDidDispose=function(e){return this.addListener2(f.EventType.Disposed,e)},t.prototype.getId=function(){return this.getEditorType()+":"+this.id},t.prototype.getEditorType=function(){return f.EditorType.ICodeEditor},t.prototype.destroy=function(){this.dispose()},t.prototype.dispose=function(){this._codeEditorService.removeCodeEditor(this),this._lifetimeDispose=r.dispose(this._lifetimeDispose);for(var t=Object.keys(this.contributions),o=0,i=t.length;o<i;o++){var n=t[o];this.contributions[n].dispose()}this.contributions={},this._postDetachModelCleanup(this._detachModel()),this._configuration.dispose(),this._keybindingService.dispose(),this.emit(f.EventType.Disposed),e.prototype.dispose.call(this)},t.prototype.captureState=function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];return new h.EditorState(this,e)},t.prototype.updateOptions=function(e){this._configuration.updateOptions(e),this._editorReadonly.set(this._configuration.editor.readOnly),this._editorTabMovesFocusKey.set(this._configuration.editor.tabFocusMode)},t.prototype.getConfiguration=function(){return this._configuration.editorClone},t.prototype.getRawConfiguration=function(){return this._configuration.getRawOptions()},t.prototype.getValue=function(e){if(void 0===e&&(e=null),this.model){var t=!(!e||!e.preserveBOM),o=f.EndOfLinePreference.TextDefined;return e&&e.lineEnding&&"\n"===e.lineEnding?o=f.EndOfLinePreference.LF:e&&e.lineEnding&&"\r\n"===e.lineEnding&&(o=f.EndOfLinePreference.CRLF),this.model.getValue(o,t)}return""},t.prototype.setValue=function(e){this.model&&this.model.setValue(e)},t.prototype.getModel=function(){return this.model},t.prototype.setModel=function(e){if(void 0===e&&(e=null),this.model!==e){var t=s.start(s.Topic.EDITOR,"CodeEditor.setModel"),o=this._detachModel();this._attachModel(e);var i={oldModelUrl:o?o.uri:null,newModelUrl:e?e.uri:null};t.stop(),this.emit(f.EventType.ModelChanged,i),this._postDetachModelCleanup(o)}},t.prototype.getVisibleColumnFromPosition=function(e){if(!this.model)return e.column;var t=this.model.validatePosition(e),o=this.model.getOptions().tabSize;return p.CursorMoveHelper.visibleColumnFromColumn(this.model,t.lineNumber,t.column,o)+1},t.prototype.getPosition=function(){return this.cursor?this.cursor.getPosition().clone():null},t.prototype.setPosition=function(e,t,o,i){if(void 0===t&&(t=!1),void 0===o&&(o=!1),void 0===i&&(i=!1),this.cursor){if(!v.Position.isIPosition(e))throw new Error("Invalid arguments");this.cursor.setSelections("api",[{selectionStartLineNumber:e.lineNumber,selectionStartColumn:e.column,positionLineNumber:e.lineNumber,positionColumn:e.column}]),t&&this.revealPosition(e,o,i)}},t.prototype._sendRevealRange=function(e,t,o){if(this.model&&this.cursor){if(!y.Range.isIRange(e))throw new Error("Invalid arguments");var i=this.model.validateRange(e),n={range:i,viewRange:null,verticalType:t,revealHorizontal:o};this.cursor.emit(f.EventType.CursorRevealRange,n)}},t.prototype.revealLine=function(e){this._sendRevealRange({startLineNumber:e,startColumn:1,endLineNumber:e,endColumn:1},f.VerticalRevealType.Simple,!1)},t.prototype.revealLineInCenter=function(e){this._sendRevealRange({startLineNumber:e,startColumn:1,endLineNumber:e,endColumn:1},f.VerticalRevealType.Center,!1)},t.prototype.revealLineInCenterIfOutsideViewport=function(e){this._sendRevealRange({startLineNumber:e,startColumn:1,endLineNumber:e,endColumn:1},f.VerticalRevealType.CenterIfOutsideViewport,!1)},t.prototype.revealPosition=function(e,t,o){if(void 0===t&&(t=!1),void 0===o&&(o=!1),!v.Position.isIPosition(e))throw new Error("Invalid arguments");this._sendRevealRange({startLineNumber:e.lineNumber,startColumn:e.column,endLineNumber:e.lineNumber,endColumn:e.column},t?f.VerticalRevealType.Center:f.VerticalRevealType.Simple,o)},t.prototype.revealPositionInCenter=function(e){if(!v.Position.isIPosition(e))throw new Error("Invalid arguments");this._sendRevealRange({startLineNumber:e.lineNumber,startColumn:e.column,endLineNumber:e.lineNumber,endColumn:e.column},f.VerticalRevealType.Center,!0)},t.prototype.revealPositionInCenterIfOutsideViewport=function(e){if(!v.Position.isIPosition(e))throw new Error("Invalid arguments");this._sendRevealRange({startLineNumber:e.lineNumber,startColumn:e.column,endLineNumber:e.lineNumber,endColumn:e.column},f.VerticalRevealType.CenterIfOutsideViewport,!0)},t.prototype.getSelection=function(){return this.cursor?this.cursor.getSelection().clone():null},t.prototype.getSelections=function(){if(!this.cursor)return null;for(var e=this.cursor.getSelections(),t=[],o=0,i=e.length;o<i;o++)t[o]=e[o].clone();return t},t.prototype.setSelection=function(e,t,o,i){void 0===t&&(t=!1),void 0===o&&(o=!1),void 0===i&&(i=!1);var n=m.Selection.isISelection(e),r=y.Range.isIRange(e);if(!n&&!r)throw new Error("Invalid arguments");if(n)this._setSelectionImpl(e,t,o,i);else if(r){var s={selectionStartLineNumber:e.startLineNumber,selectionStartColumn:e.startColumn,positionLineNumber:e.endLineNumber,positionColumn:e.endColumn};this._setSelectionImpl(s,t,o,i)}},t.prototype._setSelectionImpl=function(e,t,o,i){if(this.cursor){var n=new m.Selection(e.selectionStartLineNumber,e.selectionStartColumn,e.positionLineNumber,e.positionColumn);this.cursor.setSelections("api",[n]),t&&this.revealRange(n,o,i)}},t.prototype.revealLines=function(e,t){this._sendRevealRange({startLineNumber:e,startColumn:1,endLineNumber:t,endColumn:1},f.VerticalRevealType.Simple,!1)},t.prototype.revealLinesInCenter=function(e,t){this._sendRevealRange({startLineNumber:e,startColumn:1,endLineNumber:t,endColumn:1},f.VerticalRevealType.Center,!1)},t.prototype.revealLinesInCenterIfOutsideViewport=function(e,t){this._sendRevealRange({startLineNumber:e,startColumn:1,endLineNumber:t,endColumn:1},f.VerticalRevealType.CenterIfOutsideViewport,!1)},t.prototype.revealRange=function(e,t,o){void 0===t&&(t=!1),void 0===o&&(o=!0),this._sendRevealRange(e,t?f.VerticalRevealType.Center:f.VerticalRevealType.Simple,o)},t.prototype.revealRangeInCenter=function(e){this._sendRevealRange(e,f.VerticalRevealType.Center,!0)},t.prototype.revealRangeInCenterIfOutsideViewport=function(e){this._sendRevealRange(e,f.VerticalRevealType.CenterIfOutsideViewport,!0)},t.prototype.setSelections=function(e){if(this.cursor){if(!e||0===e.length)throw new Error("Invalid arguments");for(var t=0,o=e.length;t<o;t++)if(!m.Selection.isISelection(e[t]))throw new Error("Invalid arguments");this.cursor.setSelections("api",e)}},t.prototype.onVisible=function(){},t.prototype.onHide=function(){},t.prototype.getContribution=function(e){return this.contributions[e]||null},t.prototype.addAction=function(e){if("string"!=typeof e.id||"string"!=typeof e.label||"function"!=typeof e.run)throw new Error("Invalid action descriptor, `id`, `label` and `run` are required properties!");var t=this._instantiationService.createInstance(g.DynamicEditorAction,e,this);this.contributions[t.getId()]=t},t.prototype.getActions=function(){for(var e=[],t=Object.keys(this.contributions),i=0,n=t.length;i<n;i++){var r=t[i],s=this.contributions[r];o.isAction(s)&&e.push(s)}return e},t.prototype.getAction=function(e){var t=this.contributions[e];return t&&o.isAction(t)?t:null},t.prototype.trigger=function(e,t,o){o=o||{};var n=this.getAction(t);if(null!==n)n.enabled&&(this._telemetryService.publicLog("editorActionInvoked",{name:n.label,id:n.id}),a.TPromise.as(n.run()).done(null,i.onUnexpectedError));else{if(!this.cursor)return;this.cursor.trigger(e,t,o)}},t.prototype.executeCommand=function(e,t){this.cursor&&this.cursor.trigger(e,f.Handler.ExecuteCommand,t)},t.prototype.pushUndoStop=function(){return!!this.cursor&&(!this._configuration.editor.readOnly&&(this.model.pushStackElement(),!0))},t.prototype.executeEdits=function(e,t){var o=this;return!!this.cursor&&(!this._configuration.editor.readOnly&&(this.model.pushEditOperations(this.cursor.getSelections(),t,function(){return o.cursor.getSelections()}),!0))},t.prototype.executeCommands=function(e,t){this.cursor&&this.cursor.trigger(e,f.Handler.ExecuteCommands,t)},t.prototype.changeDecorations=function(e){return this.model?this.model.changeDecorations(e,this.id):null},t.prototype.getLineDecorations=function(e){return this.model?this.model.getLineDecorations(e,this.id,this._configuration.editor.readOnly):null},t.prototype.deltaDecorations=function(e,t){return this.model?0===e.length&&0===t.length?e:this.model.deltaDecorations(e,t,this.id):[]},t.prototype.setDecorations=function(e,t){var o={},i=this._decorationTypeSubtypes[e]||{};this._decorationTypeSubtypes[e]=o;for(var n=[],r=0,s=t;r<s.length;r++){var a=s[r],d=e;if(a.renderOptions){var l=_.hash(a.renderOptions).toString(16);d=e+"-"+l,i[l]||o[l]||this._codeEditorService.registerDecorationType(d,a.renderOptions,e),o[l]=!0}var c=this._codeEditorService.resolveDecorationOptions(d,!!a.hoverMessage);a.hoverMessage&&(c.hoverMessage=a.hoverMessage),n.push({range:a.range,options:c})}for(var l in i)o[l]||this._codeEditorService.removeDecorationType(e+"-"+l);var u=this._decorationTypeKeysToIds[e]||[];this._decorationTypeKeysToIds[e]=this.deltaDecorations(u,n)},t.prototype.removeDecorations=function(e){var t=this._decorationTypeKeysToIds[e];t&&this.deltaDecorations(t,[]),this._decorationTypeKeysToIds.hasOwnProperty(e)&&delete this._decorationTypeKeysToIds[e],this._decorationTypeSubtypes.hasOwnProperty(e)&&delete this._decorationTypeSubtypes[e]},t.prototype.addTypingListener=function(e,t){var o=this;return this.cursor?(this.cursor.addTypingListener(e,t),{dispose:function(){o.cursor&&o.cursor.removeTypingListener(e,t)}}):{dispose:function(){}}},t.prototype.getLayoutInfo=function(){return this._configuration.editor.layoutInfo},t.prototype._attachModel=function(e){var t=this;if(this.model=e?e:null,this.listenersToRemove=[],this.viewModel=null,this.cursor=null,this.model){this.domElement.setAttribute("data-mode-id",this.model.getMode().getId()),this._langIdKey.set(this.model.getMode().getId()),this._configuration.setIsDominatedByLongLines(this.model.isDominatedByLongLines()),this.model.onBeforeAttached();var o=new C.CharacterHardWrappingLineMapperFactory(this._configuration.editor.wrappingInfo.wordWrapBreakBeforeCharacters,this._configuration.editor.wrappingInfo.wordWrapBreakAfterCharacters,this._configuration.editor.wrappingInfo.wordWrapBreakObtrusiveCharacters),i=new T.SplitLinesCollection(this.model,o,this.model.getOptions().tabSize,this._configuration.editor.wrappingInfo.wrappingColumn,this._configuration.editor.fontInfo.typicalFullwidthCharacterWidth/this._configuration.editor.fontInfo.typicalHalfwidthCharacterWidth,this._configuration.editor.wrappingInfo.wrappingIndent);this.viewModel=new E.ViewModel(i,this.id,this._configuration,this.model,function(){return t.getCenteredRangeInViewport()});var n={viewModel:this.viewModel,getCurrentVisibleViewRangeInViewPort:function(){return t.viewModel.convertModelRangeToViewRange(t.getVisibleRangeInViewport())},getCurrentVisibleModelRangeInViewPort:function(){return t.getVisibleRangeInViewport()},convertModelPositionToViewPosition:function(e,o){return t.viewModel.convertModelPositionToViewPosition(e,o)},convertModelRangeToViewRange:function(e){return t.viewModel.convertModelRangeToViewRange(e)},convertViewToModelPosition:function(e,o){return t.viewModel.convertViewPositionToModelPosition(e,o)},convertViewSelectionToModelSelection:function(e){return t.viewModel.convertViewSelectionToModelSelection(e)},convertViewRangeToModelRange:function(e){return t.viewModel.convertViewRangeToModelRange(e)},validateViewPosition:function(e,o,i){return t.viewModel.validateViewPosition(e,o,i)},validateViewRange:function(e,o,i,n,r){return t.viewModel.validateViewRange(e,o,i,n,r)}};this.cursor=new u.Cursor(this.id,this._configuration,this.model,n,this._enableEmptySelectionClipboard()),this.viewModel.addEventSource(this.cursor),this._createView(),this.listenersToRemove.push(this._getViewInternalEventBus().addBulkListener2(function(e){for(var o=0,i=e.length;o<i;o++){var n=e[o].getType(),r=e[o].getData();switch(n){case f.EventType.ViewFocusGained:t.emit(f.EventType.EditorTextFocus),t.emit(f.EventType.EditorFocus,{});break;case"scroll":t.emit("scroll",r);break;case f.EventType.ViewFocusLost:t.emit(f.EventType.EditorTextBlur);break;case f.EventType.ContextMenu:t.emit(f.EventType.ContextMenu,r);break;case f.EventType.MouseDown:t.emit(f.EventType.MouseDown,r);break;case f.EventType.MouseUp:t.emit(f.EventType.MouseUp,r);break;case f.EventType.KeyUp:t.emit(f.EventType.KeyUp,r);break;case f.EventType.MouseMove:t.emit(f.EventType.MouseMove,r);break;case f.EventType.MouseLeave:t.emit(f.EventType.MouseLeave,r);break;case f.EventType.KeyDown:t.emit(f.EventType.KeyDown,r);break;case f.EventType.ViewLayoutChanged:t.emit(f.EventType.EditorLayout,r)}}})),this.listenersToRemove.push(this.model.addBulkListener(function(e){for(var o=0,i=e.length;o<i;o++){var n=e[o].getType(),r=e[o].getData();switch(n){case f.EventType.ModelDecorationsChanged:t.emit(f.EventType.ModelDecorationsChanged,r);break;case f.EventType.ModelModeChanged:t.domElement.setAttribute("data-mode-id",t.model.getMode().getId()),t._langIdKey.set(t.model.getMode().getId()),t.emit(f.EventType.ModelModeChanged,r);break;case f.EventType.ModelModeSupportChanged:t.emit(f.EventType.ModelModeSupportChanged,r);break;case f.EventType.ModelRawContentChanged:t.emit(f.EventType.ModelRawContentChanged,r);break;case f.EventType.ModelContentChanged2:t.emit(f.EventType.ModelContentChanged2,r);break;case f.EventType.ModelOptionsChanged:t.emit(f.EventType.ModelOptionsChanged,r);break;case f.EventType.ModelDispose:t.setModel(null)}}}));var r=function(e){var t=[e.selection].concat(e.secondarySelections);return t.some(function(e){return!e.isEmpty()})};this.listenersToRemove.push(this.cursor.addBulkListener2(function(e){for(var o=!1,i=!1,n=!1,s=!1,a=0,d=e.length;a<d;a++){var l=e[a].getType(),c=e[a].getData();switch(l){case f.EventType.CursorPositionChanged:var u=c;o=!0,i=u.secondaryPositions.length>0,t.emit(f.EventType.CursorPositionChanged,c);break;case f.EventType.CursorSelectionChanged:var p=c;o=!0,i=p.secondarySelections.length>0,n=!0,s=r(p),t.emit(f.EventType.CursorSelectionChanged,c)}}o&&(i?t._hasMultipleSelectionsKey.set(!0):t._hasMultipleSelectionsKey.reset()),n&&(s?t._hasNonEmptySelectionKey.set(!0):t._hasNonEmptySelectionKey.reset())}))}else this.hasView=!1},t.prototype._postDetachModelCleanup=function(e){if(e){if(this._decorationTypeKeysToIds={},this._decorationTypeSubtypes){for(var t in this._decorationTypeSubtypes){var o=this._decorationTypeSubtypes[t];for(var i in o)this._codeEditorService.removeDecorationType(t+"-"+i)}this._decorationTypeSubtypes={}}e.removeAllDecorationsWithOwnerId(this.id)}},t.prototype._detachModel=function(){this.model&&this.model.onBeforeDetached(),this.hasView=!1,this.listenersToRemove=r.dispose(this.listenersToRemove),this.cursor&&(this.cursor.dispose(),this.cursor=null),this.viewModel&&(this.viewModel.dispose(),this.viewModel=null);var e=this.model;return this.model=null,this.domElement.removeAttribute("data-mode-id"),e},t}(n.EventEmitter);t.CommonCodeEditor=w});