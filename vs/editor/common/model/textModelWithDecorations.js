var __extends=this&&this.__extends||function(e,o){function t(){this.constructor=e}for(var n in o)o.hasOwnProperty(n)&&(e[n]=o[n]);e.prototype=null===o?Object.create(o):(t.prototype=o.prototype,new t)};define(["require","exports","vs/base/common/errors","vs/base/common/htmlContent","vs/base/common/strings","vs/base/common/idGenerator","vs/editor/common/core/range","vs/editor/common/editorCommon","vs/editor/common/model/textModelWithTrackedRanges"],function(e,o,t,n,r,i,a,s,d){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";function c(e){return e.replace(/[^a-z0-9\-]/gi," ")}function h(e){return new v(e)}function l(e,o){return void 0===o&&(o=null),new f(e,o)}var p=function(){function e(){this.changedMarkers={},this.oldDecorationRange={},this.oldDecorationOptions={},this.newOrChangedDecorations={},this.removedDecorations={}}return e.prototype.addNewDecoration=function(e){this.newOrChangedDecorations[e]=!0},e.prototype.addRemovedDecoration=function(e,o,t,n){this.newOrChangedDecorations.hasOwnProperty(e)&&delete this.newOrChangedDecorations[e],this.oldDecorationRange.hasOwnProperty(e)||(this.oldDecorationRange[e]=t),this.oldDecorationOptions.hasOwnProperty(e)||(this.oldDecorationOptions[e]=n),this.removedDecorations[e]=!0},e.prototype.addMovedDecoration=function(e,o){this.oldDecorationRange.hasOwnProperty(e)||(this.oldDecorationRange[e]=o),this.newOrChangedDecorations[e]=!0},e.prototype.addUpdatedDecoration=function(e,o){this.oldDecorationOptions.hasOwnProperty(e)||(this.oldDecorationOptions[e]=o),this.newOrChangedDecorations[e]=!0},e}();o.DeferredEventsBuilder=p;var g=0,u=function(e){function o(o,t,n){o.push(s.EventType.ModelDecorationsChanged),e.call(this,o,t,n),this._decorationIdGenerator=new i.IdGenerator(++g+";"),this.decorations={},this.rangeIdToDecorationId={},this._currentDeferredEvents=null}return __extends(o,e),o.prototype.dispose=function(){this.decorations=null,this.rangeIdToDecorationId=null,e.prototype.dispose.call(this)},o.prototype._resetValue=function(o,t){e.prototype._resetValue.call(this,o,t),this.decorations={},this.rangeIdToDecorationId={}},o.prototype.changeDecorations=function(e,o){var n=this;return void 0===o&&(o=0),this._withDeferredEvents(function(r){var i={addDecoration:function(e,t){return n._addDecorationImpl(r,o,n.validateRange(e),h(t))},changeDecoration:function(e,o){n._changeDecorationImpl(r,e,n.validateRange(o))},changeDecorationOptions:function(e,o){n._changeDecorationOptionsImpl(r,e,h(o))},removeDecoration:function(e){n._removeDecorationImpl(r,e)},deltaDecorations:function(e,t){return n._deltaDecorationsImpl(r,o,e,n._normalizeDeltaDecorations(t))}},a=null;try{a=e(i)}catch(s){t.onUnexpectedError(s)}return i.addDecoration=null,i.changeDecoration=null,i.removeDecoration=null,i.deltaDecorations=null,a})},o.prototype.deltaDecorations=function(e,o,t){return void 0===t&&(t=0),e||(e=[]),this.changeDecorations(function(t){return t.deltaDecorations(e,o)},t)},o.prototype.removeAllDecorationsWithOwnerId=function(e){for(var o=[],t=Object.keys(this.decorations),n=0,r=t.length;n<r;n++){var i=t[n],a=this.decorations[i];a.ownerId===e&&o.push(a.id)}this._removeDecorationsImpl(null,o)},o.prototype.getDecorationOptions=function(e){return this.decorations.hasOwnProperty(e)?this.decorations[e].options:null},o.prototype.getDecorationRange=function(e){if(this.decorations.hasOwnProperty(e)){var o=this.decorations[e];return this.getTrackedRange(o.rangeId)}return null},o.prototype.getLineDecorations=function(e,o,t){return void 0===o&&(o=0),void 0===t&&(t=!1),e<1||e>this.getLineCount()?[]:this.getLinesDecorations(e,e,o,t)},o.prototype._getDecorationsInRange=function(e,o,t,n,r,i){var a,d,c,h,l=[],p=this.getLinesTrackedRanges(e,t);for(d=0,h=p.length;d<h;d++)if(c=p[d],this.rangeIdToDecorationId.hasOwnProperty(c.id)){if(a=this.decorations[this.rangeIdToDecorationId[c.id]],r&&a.ownerId&&a.ownerId!==r)continue;if(i&&(a.options.className===s.ClassName.EditorErrorDecoration||a.options.className===s.ClassName.EditorWarningDecoration))continue;if(c.range.startLineNumber===e&&c.range.endColumn<o)continue;if(c.range.endLineNumber===t&&c.range.startColumn>n)continue;l.push({id:a.id,ownerId:a.ownerId,range:c.range,options:a.options})}return l},o.prototype.getLinesDecorations=function(e,o,t,n){void 0===t&&(t=0),void 0===n&&(n=!1);var r=this.getLineCount();return e=Math.min(r,Math.max(1,e)),o=Math.min(r,Math.max(1,o)),this._getDecorationsInRange(e,1,o,Number.MAX_VALUE,t,n)},o.prototype.getDecorationsInRange=function(e,o,t){var n=this.validateRange(e);return this._getDecorationsInRange(n.startLineNumber,n.startColumn,n.endLineNumber,n.endColumn,o,t)},o.prototype.getAllDecorations=function(e,o){void 0===e&&(e=0),void 0===o&&(o=!1);for(var t=[],n=Object.keys(this.decorations),r=0,i=n.length;r<i;r++){var a=n[r],d=this.decorations[a];e&&d.ownerId&&d.ownerId!==e||(!o||d.options.className!==s.ClassName.EditorErrorDecoration&&d.options.className!==s.ClassName.EditorWarningDecoration)&&t.push({id:d.id,ownerId:d.ownerId,range:this.getTrackedRange(d.rangeId),options:d.options})}return t},o.prototype._withDeferredEvents=function(e){var o=this;return this.deferredEmit(function(){var t=!o._currentDeferredEvents;t&&(o._currentDeferredEvents=new p);try{var n=e(o._currentDeferredEvents);t&&o._handleCollectedEvents(o._currentDeferredEvents)}finally{t&&(o._currentDeferredEvents=null)}return n})},o.prototype._handleCollectedEvents=function(e){var o=this._getMarkersInMap(e.changedMarkers),t=this._onChangedMarkers(o);this._onChangedRanges(e,t),this._handleCollectedDecorationsEvents(e);for(var n=0,r=o.length;n<r;n++)o[n].oldLineNumber=0,o[n].oldColumn=0},o.prototype._onChangedRanges=function(e,o){for(var t=Object.keys(o),n=0,r=t.length;n<r;n++){var i=t[n];if(this.rangeIdToDecorationId.hasOwnProperty(i)){var a=this.rangeIdToDecorationId[i];e.addMovedDecoration(a,o[i])}}},o.prototype._handleCollectedDecorationsEvents=function(e){for(var o,t,n=[],r=[],i=[],a=Object.keys(e.newOrChangedDecorations),d=0,c=a.length;d<c;d++){var h=a[d];i.push(h),o=this._getDecorationData(h),o.isForValidation=o.options.className===s.ClassName.EditorErrorDecoration||o.options.className===s.ClassName.EditorWarningDecoration,n.push(o),e.oldDecorationRange.hasOwnProperty(h)&&(t=e.oldDecorationRange[h],t.startLineNumber=t.startLineNumber||o.range.startLineNumber,t.startColumn=t.startColumn||o.range.startColumn,t.endLineNumber=t.endLineNumber||o.range.endLineNumber,t.endColumn=t.endColumn||o.range.endColumn)}a=Object.keys(e.removedDecorations);for(var d=0,c=a.length;d<c;d++){var h=a[d];i.push(h),r.push(h)}if(i.length>0){var l={ids:i,addedOrChangedDecorations:n,removedDecorations:r,oldOptions:e.oldDecorationOptions,oldRanges:e.oldDecorationRange};this.emitModelDecorationsChangedEvent(l)}},o.prototype._getDecorationData=function(e){var o=this.decorations[e];return{id:o.id,ownerId:o.ownerId,range:this.getTrackedRange(o.rangeId),isForValidation:!1,options:o.options}},o.prototype.emitModelDecorationsChangedEvent=function(e){this._isDisposing||this.emit(s.EventType.ModelDecorationsChanged,e)},o.prototype._normalizeDeltaDecorations=function(e){for(var o=[],t=0,n=e.length;t<n;t++){var r=e[t];o.push(new D(t,this.validateRange(r.range),h(r.options)))}return o},o.prototype._addDecorationImpl=function(e,o,t,n){var r=this.addTrackedRange(t,n.stickiness),i=new m(this._decorationIdGenerator.nextId(),o,r,n);return this.decorations[i.id]=i,this.rangeIdToDecorationId[r]=i.id,e.addNewDecoration(i.id),i.id},o.prototype._addDecorationsImpl=function(e,o,t){for(var n=this._addTrackedRanges(t.map(function(e){return e.range}),t.map(function(e){return e.options.stickiness})),r=[],i=0,a=t.length;i<a;i++){var s=n[i],d=new m(this._decorationIdGenerator.nextId(),o,s,t[i].options);this.decorations[d.id]=d,this.rangeIdToDecorationId[s]=d.id,e.addNewDecoration(d.id),r.push(d.id)}return r},o.prototype._changeDecorationImpl=function(e,o,t){if(this.decorations.hasOwnProperty(o)){var n=this.decorations[o],r=this.getTrackedRange(n.rangeId);this.changeTrackedRange(n.rangeId,t),e.addMovedDecoration(o,r)}},o.prototype._changeDecorationOptionsImpl=function(e,o,t){if(this.decorations.hasOwnProperty(o)){var n=this.decorations[o],r=n.options;r.stickiness!==t.stickiness&&this.changeTrackedRangeStickiness(n.rangeId,t.stickiness),n.options=t,e.addUpdatedDecoration(o,r)}},o.prototype._removeDecorationImpl=function(e,o){if(this.decorations.hasOwnProperty(o)){var t=this.decorations[o],n=null;e&&(n=this.getTrackedRange(t.rangeId)),this.removeTrackedRange(t.rangeId),delete this.rangeIdToDecorationId[t.rangeId],delete this.decorations[o],e&&e.addRemovedDecoration(o,t.ownerId,n,t.options)}},o.prototype._removeDecorationsImpl=function(e,o){for(var t=[],n=0,r=o.length;n<r;n++){var i=o[n];if(this.decorations.hasOwnProperty(i)){var a=this.decorations[i];if(e){var s=this.getTrackedRange(a.rangeId);e.addRemovedDecoration(i,a.ownerId,s,a.options)}t.push(a.rangeId),delete this.rangeIdToDecorationId[a.rangeId],delete this.decorations[i]}}t.length>0&&this.removeTrackedRanges(t)},o.prototype._resolveOldDecorations=function(e){for(var o=[],t=0,n=e.length;t<n;t++){var r=e[t];if(this.decorations.hasOwnProperty(r)){var i=this.decorations[r];o.push({id:r,range:this.getTrackedRange(i.rangeId),options:i.options})}}return o},o.prototype._deltaDecorationsImpl=function(e,o,t,n){if(0===t.length)return this._addDecorationsImpl(e,o,n);if(0===n.length)return this._removeDecorationsImpl(e,t),[];var r=this._resolveOldDecorations(t);r.sort(function(e,o){return a.Range.compareRangesUsingStarts(e.range,o.range)}),n.sort(function(e,o){return a.Range.compareRangesUsingStarts(e.range,o.range)});for(var i=[],s=0,d=r.length,c=0,h=n.length,l=[],p=[];s<d&&c<h;){var g=r[s],u=n[c],m=a.Range.compareRangesUsingStarts(g.range,u.range);m<0?(p.push(g.id),s++):m>0?(l.push(u),c++):g.options.equals(u.options)?(i[u.index]=g.id,s++,c++):(p.push(g.id),s++)}for(;s<d;)p.push(r[s].id),s++;for(;c<h;)l.push(n[c]),c++;if(p.length>0&&this._removeDecorationsImpl(e,p),l.length>0)for(var v=this._addDecorationsImpl(e,o,l),D=0,f=l.length;D<f;D++)i[l[D].index]=v[D];return i},o}(d.TextModelWithTrackedRanges);o.TextModelWithDecorations=u;var m=function(){function e(e,o,t,n){this.id=e,this.ownerId=o,this.rangeId=t,this.options=n}return e}(),v=function(){function e(e){this.stickiness=e.stickiness||s.TrackedRangeStickiness.AlwaysGrowsWhenTypingAtEdges,this.className=c(e.className||r.empty),this.glyphMarginHoverMessage=e.glyphMarginHoverMessage||r.empty,this.hoverMessage=e.hoverMessage||[],this.isWholeLine=e.isWholeLine||!1,this.overviewRuler=l(e.overviewRuler,e.showInOverviewRuler),this.glyphMarginClassName=c(e.glyphMarginClassName||r.empty),this.linesDecorationsClassName=c(e.linesDecorationsClassName||r.empty),this.inlineClassName=c(e.inlineClassName||r.empty),this.beforeContentClassName=c(e.beforeContentClassName||r.empty),this.afterContentClassName=c(e.afterContentClassName||r.empty)}return e._overviewRulerEquals=function(e,o){return e.color===o.color&&e.position===o.position&&e.darkColor===o.darkColor},e.prototype.equals=function(o){return this.stickiness===o.stickiness&&this.className===o.className&&this.glyphMarginHoverMessage===o.glyphMarginHoverMessage&&this.isWholeLine===o.isWholeLine&&this.showInOverviewRuler===o.showInOverviewRuler&&this.glyphMarginClassName===o.glyphMarginClassName&&this.linesDecorationsClassName===o.linesDecorationsClassName&&this.inlineClassName===o.inlineClassName&&this.beforeContentClassName===o.beforeContentClassName&&this.afterContentClassName===o.afterContentClassName&&n.markedStringsEquals(this.hoverMessage,o.hoverMessage)&&e._overviewRulerEquals(this.overviewRuler,o.overviewRuler)},e}(),D=function(){function e(e,o,t){this.index=e,this.range=o,this.options=t}return e}(),f=function(){function e(e,o){this.color=r.empty,this.darkColor=r.empty,this.position=s.OverviewRulerLane.Center,o&&(this.color=o),e&&e.color&&(this.color=e.color),e&&e.darkColor&&(this.darkColor=e.darkColor),e&&e.hasOwnProperty("position")&&(this.position=e.position)}return e}()});