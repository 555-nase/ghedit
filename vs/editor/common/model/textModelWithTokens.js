var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)};define(["require","exports","vs/nls","vs/base/common/async","vs/base/common/errors","vs/base/common/lifecycle","vs/base/common/stopwatch","vs/base/common/timer","vs/base/common/winjs.base","vs/editor/common/editorCommon","vs/editor/common/model/textModel","vs/editor/common/model/textModelWithTokensHelpers","vs/editor/common/model/tokenIterator","vs/editor/common/modes/nullMode","vs/editor/common/modes/supports","vs/editor/common/modes/supports/richEditBrackets","vs/editor/common/core/modeTransition","vs/editor/common/model/lineToken","vs/editor/common/model/tokensBinaryEncoding","vs/editor/common/modes/languageConfigurationRegistry"],function(e,t,n,i,o,s,r,a,d,l,u,h,_,m,p,c,f,g,k,T){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var v=function(){function e(e,t){var n=this;this._modePromise=e,this._externalModePromise=new d.TPromise(function(e,t,i){n._externalModePromise_c=e,n._externalModePromise_e=t},function(){}),this._model=t,this._isDisposed=!1,d.TPromise.timeout(0).then(function(){return n._modePromise}).then(function(e){if(n._isDisposed)return void n._externalModePromise_c(!1);var t=n._model;n.dispose(),t.setMode(e),t._warmUpTokens(),n._externalModePromise_c(!0)}).done(null,function(e){n._externalModePromise_e(e),o.onUnexpectedError(e)})}return e.prototype.getModePromise=function(){return this._externalModePromise},e.prototype.dispose=function(){this._modePromise=null,this._model=null,this._isDisposed=!0},e}(),I=function(){function e(e,t){var n=this;this._retokenizePromise=e,this._model=t,this._isDisposed=!1,this.isFulfilled=!1,d.TPromise.timeout(0).then(function(){return n._retokenizePromise}).then(function(){n._isDisposed||(n.isFulfilled=!0,n._model.onRetokenizerFulfilled())}).done(null,o.onUnexpectedError)}return e.prototype.getRange=function(){return null},e.prototype.dispose=function(){this._retokenizePromise=null,this._model=null,this._isDisposed=!0},e}();t.FullModelRetokenizer=I;var M=function(){function e(e,t,n){this.modeTransitions=t.getModeTransitions(e),this._text=t.text,this._lineTokens=t.getTokens(n)}return e.prototype.getLineContent=function(){return this._text},e.prototype.getTokenCount=function(){return this._lineTokens.getTokenCount()},e.prototype.getTokenStartIndex=function(e){return this._lineTokens.getTokenStartIndex(e)},e.prototype.getTokenEndIndex=function(e){return this._lineTokens.getTokenEndIndex(e,this._text.length)},e.prototype.getTokenType=function(e){return this._lineTokens.getTokenType(e)},e.prototype.getTokenText=function(e){var t=this._lineTokens.getTokenStartIndex(e),n=this._lineTokens.getTokenEndIndex(e,this._text.length);return this._text.substring(t,n)},e.prototype.findIndexOfOffset=function(e){return this._lineTokens.findIndexOfOffset(e)},e}(),x=function(e){function t(t,n,o){var s=this;if(t.push(l.EventType.ModelTokensChanged),t.push(l.EventType.ModelModeChanged),t.push(l.EventType.ModelModeSupportChanged),e.call(this,t,n),this._mode=null,this._modeListener=null,this._modeToModelBinder=null,this._tokensInflatorMap=null,this._invalidLineStartIndex=0,this._lastState=null,this._revalidateTokensTimeout=-1,this._scheduleRetokenizeNow=null,this._retokenizers=null,o)if(d.TPromise.is(o)){var r=o._value;if(r&&"function"==typeof r.getId)this._mode=this._massageMode(r),this._resetModeListener(this._mode);else{var a=o;this._modeToModelBinder=new v(a,this),this._mode=new m.NullMode}}else this._mode=this._massageMode(o),this._resetModeListener(this._mode);else this._mode=new m.NullMode;this._revalidateTokensTimeout=-1,this._scheduleRetokenizeNow=new i.RunOnceScheduler(function(){return s._retokenizeNow()},200),this._retokenizers=[],this._resetTokenizationState()}return __extends(t,e),t.prototype.dispose=function(){this._modeToModelBinder&&(this._modeToModelBinder.dispose(),this._modeToModelBinder=null),this._resetModeListener(null),this._clearTimers(),this._mode=null,this._lastState=null,this._tokensInflatorMap=null,this._retokenizers=s.dispose(this._retokenizers),this._scheduleRetokenizeNow.dispose(),e.prototype.dispose.call(this)},t.prototype._shouldAutoTokenize=function(){return!1},t.prototype._massageMode=function(e){return this.isTooLargeForHavingAMode()?new m.NullMode:this.isTooLargeForHavingARichMode()?e.toSimplifiedMode():e},t.prototype.whenModeIsReady=function(){var e=this;return this._modeToModelBinder?this._modeToModelBinder.getModePromise().then(function(){return e._mode}):d.TPromise.as(this._mode)},t.prototype.onRetokenizerFulfilled=function(){this._scheduleRetokenizeNow.schedule()},t.prototype._retokenizeNow=function(){var e=this._retokenizers.filter(function(e){return e.isFulfilled});this._retokenizers=this._retokenizers.filter(function(e){return!e.isFulfilled});for(var t=!1,n=0;n<e.length;n++)e[n].getRange()||(t=!0);if(t){for(var n=0,i=this._lines.length;n<i;n++)this._lines[n].isInvalid=!0;this._invalidLineStartIndex=0}else{for(var o=Number.MAX_VALUE,n=0;n<e.length;n++){var s=e[n].getRange();o=Math.min(o,s.startLineNumber);for(var r=s.startLineNumber;r<=s.endLineNumber;r++)this._lines[r-1].isInvalid=!0}o-1<this._invalidLineStartIndex&&(this._invalidLineStartIndex<this._lines.length&&(this._lines[this._invalidLineStartIndex].isInvalid=!0),this._invalidLineStartIndex=o-1)}this._beginBackgroundTokenization();for(var n=0;n<e.length;n++)e[n].dispose()},t.prototype._createRetokenizer=function(e,t){return new I(e,this)},t.prototype._resetValue=function(t,n){e.prototype._resetValue.call(this,t,n),this._resetTokenizationState()},t.prototype._resetMode=function(e,t){this._mode=t,this._resetModeListener(t),this._resetTokenizationState(),this.emitModelTokensChangedEvent(1,this.getLineCount())},t.prototype._resetModeListener=function(e){var t=this;this._modeListener&&(this._modeListener.dispose(),this._modeListener=null),e&&"function"==typeof e.addSupportChangedListener&&(this._modeListener=e.addSupportChangedListener(function(e){return t._onModeSupportChanged(e)}))},t.prototype._onModeSupportChanged=function(e){this._emitModelModeSupportChangedEvent(e),e.tokenizationSupport&&(this._resetTokenizationState(),this.emitModelTokensChangedEvent(1,this.getLineCount()))},t.prototype._resetTokenizationState=function(){this._retokenizers=s.dispose(this._retokenizers),this._scheduleRetokenizeNow.cancel(),this._clearTimers();for(var e=0;e<this._lines.length;e++)this._lines[e].setState(null);this._initializeTokenizationState()},t.prototype._clearTimers=function(){this._revalidateTokensTimeout!==-1&&(clearTimeout(this._revalidateTokensTimeout),this._revalidateTokensTimeout=-1)},t.prototype._initializeTokenizationState=function(){var e=null;if(this._mode.tokenizationSupport)try{e=this._mode.tokenizationSupport.getInitialState()}catch(n){n.friendlyMessage=t.MODE_TOKENIZATION_FAILED_MSG,o.onUnexpectedError(n),this._mode=new m.NullMode}e||(e=new m.NullState(this._mode,null)),this._lines[0].setState(e),this._lastState=null,this._tokensInflatorMap=new k.TokensInflatorMap,this._invalidLineStartIndex=0,this._beginBackgroundTokenization()},t.prototype.getLineTokens=function(e,t){if(void 0===t&&(t=!1),e<1||e>this.getLineCount())throw new Error("Illegal value "+e+" for `lineNumber`");return t||this._updateTokensUntilLine(e,!0),this._lines[e-1].getTokens(this._tokensInflatorMap)},t.prototype.getLineContext=function(e){if(e<1||e>this.getLineCount())throw new Error("Illegal value "+e+" for `lineNumber`");return this._updateTokensUntilLine(e,!0),new M(this._mode,this._lines[e-1],this._tokensInflatorMap)},t.prototype._getInternalTokens=function(e){return this._updateTokensUntilLine(e,!0),this._lines[e-1].getTokens(this._tokensInflatorMap)},t.prototype.getMode=function(){return this._mode},t.prototype.setMode=function(e){if(e)if(this._modeToModelBinder&&(this._modeToModelBinder.dispose(),this._modeToModelBinder=null),d.TPromise.is(e))this._modeToModelBinder=new v(e,this);else{var t=this._massageMode(e);if(this._mode!==t){var n={oldMode:this._mode,newMode:t};this._resetMode(n,t),this._emitModelModeChangedEvent(n)}}},t.prototype.getModeIdAtPosition=function(e,t){var n=this.validatePosition({lineNumber:e,column:t}),i=n.lineNumber,o=n.column;if(1===o)return this.getStateBeforeLine(i).getMode().getId();if(o===this.getLineMaxColumn(i))return this.getStateAfterLine(i).getMode().getId();var s=this._getLineModeTransitions(i),r=f.ModeTransition.findIndexInSegmentsArray(s,o-1);return s[r].modeId},t.prototype._invalidateLine=function(e){this._lines[e].isInvalid=!0,e<this._invalidLineStartIndex&&(this._invalidLineStartIndex<this._lines.length&&(this._lines[this._invalidLineStartIndex].isInvalid=!0),this._invalidLineStartIndex=e,this._beginBackgroundTokenization())},t._toLineTokens=function(e){if(!e||0===e.length)return[];if(e[0]instanceof g.LineToken)return e;for(var t=[],n=0,i=e.length;n<i;n++)t[n]=new g.LineToken(e[n].startIndex,e[n].type);return t},t._toModeTransitions=function(e){if(!e||0===e.length)return[];if(e[0]instanceof f.ModeTransition)return e;for(var t=[],n=0,i=e.length;n<i;n++)t[n]=new f.ModeTransition(e[n].startIndex,e[n].mode);return t},t.prototype._updateLineTokens=function(e,n,i,o){this._lines[e].setTokens(n,t._toLineTokens(o.tokens),i,t._toModeTransitions(o.modeTransitions))},t.prototype._beginBackgroundTokenization=function(){var e=this;this._shouldAutoTokenize()&&this._revalidateTokensTimeout===-1&&(this._revalidateTokensTimeout=setTimeout(function(){e._revalidateTokensTimeout=-1,e._revalidateTokensNow()},0))},t.prototype._warmUpTokens=function(){for(var e=Math.min(100,this.getLineCount()),t=e,n=1;n<=e;n++){var i=this._lines[n-1].text;if(i.length>=200){t=n-1;break}}this._revalidateTokensNow(t),this._invalidLineStartIndex<this._lines.length&&this._beginBackgroundTokenization()},t.prototype._revalidateTokensNow=function(e){void 0===e&&(e=this._invalidLineStartIndex+1e6);var t=a.start(a.Topic.EDITOR,"backgroundTokenization");e=Math.min(this._lines.length,e);for(var n,i=20,o=this._invalidLineStartIndex+1,s=0,d=0,l=0,u=r.StopWatch.create(!1),h=o;h<=e;h++){if(n=u.elapsed(),n>i){e=h-1;break}if(d=this._lines[h-1].text.length,s>0&&(l=n/s*d,n+l>i)){e=h-1;break}this._updateTokensUntilLine(h,!1),s+=d}n=u.elapsed(),o<=e&&this.emitModelTokensChangedEvent(o,e),this._invalidLineStartIndex<this._lines.length&&this._beginBackgroundTokenization(),t.stop()},t.prototype.getStateBeforeLine=function(e){return this._updateTokensUntilLine(e-1,!0),this._lines[e-1].getState()},t.prototype.getStateAfterLine=function(e){return this._updateTokensUntilLine(e,!0),e<this._lines.length?this._lines[e].getState():this._lastState},t.prototype._getLineModeTransitions=function(e){if(e<1||e>this.getLineCount())throw new Error("Illegal value "+e+" for `lineNumber`");return this._updateTokensUntilLine(e,!0),this._lines[e-1].getModeTransitions(this._mode)},t.prototype._updateTokensUntilLine=function(e,n){for(var i=this._lines.length,s=e-1,r=1e9,a=this._invalidLineStartIndex+1,d=e,l=this._invalidLineStartIndex;l<=s;l++){var u=l+1,h=null,_=this._lines[l].text;if(this._mode.tokenizationSupport){try{h=this._mode.tokenizationSupport.tokenize(this._lines[l].text,this._lines[l].getState(),0,r)}catch(p){p.friendlyMessage=t.MODE_TOKENIZATION_FAILED_MSG,o.onUnexpectedError(p)}h&&h.retokenize&&this._retokenizers.push(this._createRetokenizer(h.retokenize,l+1)),h&&h.tokens&&h.tokens.length>0&&(h.actualStopOffset=Math.max(h.actualStopOffset,h.tokens[h.tokens.length-1].startIndex+1)),h&&h.actualStopOffset<_.length&&(h.tokens.push({startIndex:h.actualStopOffset,type:""}),h.endState=this._lines[l].getState())}if(h||(h=m.nullTokenize(this._mode,_,this._lines[l].getState())),h.modeTransitions||(h.modeTransitions=[]),0===h.modeTransitions.length&&h.modeTransitions.push({startIndex:0,mode:this._mode}),this._updateLineTokens(l,this._tokensInflatorMap,this._mode,h),this._lines[l].isInvalid&&(this._lines[l].isInvalid=!1),u<i)if(null!==this._lines[u].getState()&&h.endState.equals(this._lines[u].getState())){for(var c=l+1;c<i&&!this._lines[c].isInvalid;){if(c+1<i){if(null===this._lines[c+1].getState())break}else if(null===this._lastState)break;c++}this._invalidLineStartIndex=Math.max(this._invalidLineStartIndex,c),l=c-1}else this._lines[u].setState(h.endState);else this._lastState=h.endState}this._invalidLineStartIndex=Math.max(this._invalidLineStartIndex,s+1),n&&a<=d&&this.emitModelTokensChangedEvent(a,d)},t.prototype.emitModelTokensChangedEvent=function(e,t){var n={fromLineNumber:e,toLineNumber:t};this._isDisposing||this.emit(l.EventType.ModelTokensChanged,n)},t.prototype._emitModelModeChangedEvent=function(e){this._isDisposing||this.emit(l.EventType.ModelModeChanged,e)},t.prototype._emitModelModeSupportChangedEvent=function(e){this._isDisposing||this.emit(l.EventType.ModelModeSupportChanged,e)},t.prototype._lineIsTokenized=function(e){return this._invalidLineStartIndex>e-1},t.prototype._getWordDefinition=function(){return h.WordHelper.massageWordDefinitionOf(this._mode)},t.prototype.getWordAtPosition=function(e){return h.WordHelper.getWordAtPosition(this,this.validatePosition(e))},t.prototype.getWordUntilPosition=function(e){var t=this.getWordAtPosition(e);return t?{word:t.word.substr(0,e.column-t.startColumn),startColumn:t.startColumn,endColumn:e.column}:{word:"",startColumn:e.column,endColumn:e.column}},t.prototype.tokenIterator=function(e,t){var n=new _.TokenIterator(this,this.validatePosition(e)),i=t(n);return n._invalidate(),i},t.prototype.findMatchingBracketUp=function(e,t){var n=this.validatePosition(t),i=this._lines[n.lineNumber-1].getModeTransitions(this._mode),o=f.ModeTransition.findIndexInSegmentsArray(i,n.column-1),s=i[o],r=T.LanguageConfigurationRegistry.getBracketsSupport(s.modeId);if(!r)return null;var a=r.textIsBracket[e];return a?this._findMatchingBracketUp(a,n):null},t.prototype.matchBracket=function(e){return this._matchBracket(this.validatePosition(e))},t.prototype._matchBracket=function(e){var t=e.lineNumber,n=this._lines[t-1].text,i=this._lines[t-1].getTokens(this._tokensInflatorMap),o=i.findIndexOfOffset(e.column-1),s=i.getTokenStartIndex(o),r=this._lines[t-1].getModeTransitions(this._mode),a=f.ModeTransition.findIndexInSegmentsArray(r,e.column-1),d=r[a],l=T.LanguageConfigurationRegistry.getBracketsSupport(d.modeId);if(o>0&&s===e.column-1){var u=o-1,h=i.getTokenType(u);if(!p.ignoreBracketsInToken(h)){var _=i.getTokenStartIndex(u),m=d,g=l;if(a>0&&d.startIndex===e.column-1&&(m=r[a-1],g=T.LanguageConfigurationRegistry.getBracketsSupport(m.modeId)),g){_=Math.max(_,e.column-1-g.maxBracketLength);var k=c.BracketsUtils.findPrevBracketInToken(g.reversedRegex,t,n,_,s);if(k&&k.startColumn<=e.column&&e.column<=k.endColumn){var v=n.substring(k.startColumn-1,k.endColumn-1),I=this._matchFoundBracket(k,g.textIsBracket[v],g.textIsOpenBracket[v]);if(I)return I}}}}if(!p.ignoreBracketsInToken(i.getTokenType(o))&&l){s=Math.max(s,e.column-1-l.maxBracketLength);var M=i.getTokenEndIndex(o,n.length);for(M=Math.min(M,e.column-1+l.maxBracketLength);;){var k=c.BracketsUtils.findNextBracketInText(l.forwardRegex,t,n.substring(s,M),s);if(!k)break;if(k.startColumn<=e.column&&e.column<=k.endColumn){var v=n.substring(k.startColumn-1,k.endColumn-1),I=this._matchFoundBracket(k,l.textIsBracket[v],l.textIsOpenBracket[v]);if(I)return I}s=k.endColumn-1}}return null},t.prototype._matchFoundBracket=function(e,t,n){if(n){var i=this._findMatchingBracketDown(t,e.getEndPosition());if(i)return[e,i]}else{var i=this._findMatchingBracketUp(t,e.getStartPosition());if(i)return[e,i]}return null},t.prototype._findMatchingBracketUp=function(e,t){for(var n=e.modeId,i=e.reversedRegex,o=-1,s=t.lineNumber;s>=1;s--){var r=this._lines[s-1].getTokens(this._tokensInflatorMap),a=this._lines[s-1].text,d=this._lines[s-1].getModeTransitions(this._mode),l=d.length-1,u=d[l].startIndex,h=d[l].modeId,_=r.getTokenCount()-1,m=a.length;s===t.lineNumber&&(_=r.findIndexOfOffset(t.column-1),m=t.column-1,l=f.ModeTransition.findIndexInSegmentsArray(d,t.column-1),u=d[l].startIndex,h=d[l].modeId);for(var g=_;g>=0;g--){var k=r.getTokenType(g),T=r.getTokenStartIndex(g);if(T<u&&(l--,u=d[l].startIndex,h=d[l].modeId),h===n&&!p.ignoreBracketsInToken(k))for(;;){var v=c.BracketsUtils.findPrevBracketInToken(i,s,a,T,m);if(!v)break;var I=a.substring(v.startColumn-1,v.endColumn-1);if(I===e.open?o++:I===e.close&&o--,0===o)return v;m=v.startColumn-1}m=T}}return null},t.prototype._findMatchingBracketDown=function(e,t){for(var n=e.modeId,i=e.forwardRegex,o=1,s=t.lineNumber,r=this.getLineCount();s<=r;s++){var a=this._lines[s-1].getTokens(this._tokensInflatorMap),d=this._lines[s-1].text,l=this._lines[s-1].getModeTransitions(this._mode),u=0,h=u+1<l.length?l[u+1].startIndex:d.length+1,_=l[u].modeId,m=0,g=a.getTokenStartIndex(m);s===t.lineNumber&&(m=a.findIndexOfOffset(t.column-1),g=Math.max(g,t.column-1),u=f.ModeTransition.findIndexInSegmentsArray(l,t.column-1),h=u+1<l.length?l[u+1].startIndex:d.length+1,_=l[u].modeId);for(var k=m,T=a.getTokenCount();k<T;k++){var v=a.getTokenType(k),I=a.getTokenEndIndex(k,d.length);if(g>=h&&(u++,h=u+1<l.length?l[u+1].startIndex:d.length+1,_=l[u].modeId),_===n&&!p.ignoreBracketsInToken(v))for(;;){var M=c.BracketsUtils.findNextBracketInToken(i,s,d,g,I);if(!M)break;var x=d.substring(M.startColumn-1,M.endColumn-1);if(x===e.open?o++:x===e.close&&o--,0===o)return M;g=M.endColumn-1}g=I}}return null},t.prototype.findPrevBracket=function(e){for(var t=this.validatePosition(e),n=/[\(\)\[\]\{\}]/,i=t.lineNumber;i>=1;i--){var o=this._lines[i-1].getTokens(this._tokensInflatorMap),s=this._lines[i-1].text,r=o.getTokenCount()-1,a=s.length;i===t.lineNumber&&(r=o.findIndexOfOffset(t.column-1),a=t.column-1);for(var d=r;d>=0;d--){var l=o.getTokenType(d),u=o.getTokenStartIndex(d);if(!p.ignoreBracketsInToken(l)){var h=c.BracketsUtils.findPrevBracketInToken(n,i,s,u,a);if(h)return this._toFoundBracket(h)}a=u}}return null},t.prototype.findNextBracket=function(e){for(var t=this.validatePosition(e),n=/[\(\)\[\]\{\}]/,i=t.lineNumber,o=this.getLineCount();i<=o;i++){var s=this._lines[i-1].getTokens(this._tokensInflatorMap),r=this._lines[i-1].text,a=0,d=s.getTokenStartIndex(a);i===t.lineNumber&&(a=s.findIndexOfOffset(t.column-1),d=Math.max(d,t.column-1));for(var l=a,u=s.getTokenCount();l<u;l++){var h=s.getTokenType(l),_=s.getTokenEndIndex(l,r.length);if(!p.ignoreBracketsInToken(h)){var m=c.BracketsUtils.findNextBracketInToken(n,i,r,d,_);if(m)return this._toFoundBracket(m)}d=_}}return null},t.prototype._toFoundBracket=function(e){if(!e)return null;var t=this.getValueInRange(e);switch(t){case"(":return{range:e,open:"(",close:")",isOpen:!0};case")":return{range:e,open:"(",close:")",isOpen:!1};case"[":return{range:e,open:"[",close:"]",isOpen:!0};case"]":return{range:e,open:"[",close:"]",isOpen:!1};case"{":return{range:e,open:"{",close:"}",isOpen:!0};case"}":return{range:e,open:"{",close:"}",isOpen:!1}}return null},t.MODE_TOKENIZATION_FAILED_MSG=n.localize("mode.tokenizationSupportFailed","The mode has failed while tokenizing the input."),t}(u.TextModel);t.TextModelWithTokens=x});