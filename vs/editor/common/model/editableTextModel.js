var __extends=this&&this.__extends||function(e,n){function t(){this.constructor=e}for(var i in n)n.hasOwnProperty(i)&&(e[i]=n[i]);e.prototype=null===n?Object.create(n):(t.prototype=n.prototype,new t)};define(["require","exports","vs/editor/common/core/range","vs/editor/common/editorCommon","vs/editor/common/model/editStack","vs/editor/common/model/modelLine","vs/editor/common/model/textModelWithDecorations","vs/base/common/strings"],function(e,n,t,i,r,a,s,o){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var l=function(e){function n(n,t,a){n.push(i.EventType.ModelRawContentChanged),n.push(i.EventType.ModelContentChanged2),e.call(this,n,t,a),this._commandManager=new r.EditStack(this),this._isUndoing=!1,this._isRedoing=!1,this._hasEditableRange=!1,this._editableRangeId=null,this._trimAutoWhitespaceLines=null}return __extends(n,e),n.prototype.onDidChangeRawContent=function(e){return this.addListener2(i.EventType.ModelRawContentChanged,e)},n.prototype.onDidChangeContent=function(e){return this.addListener2(i.EventType.ModelContentChanged2,e)},n.prototype.dispose=function(){this._commandManager=null,e.prototype.dispose.call(this)},n.prototype._resetValue=function(n,t){e.prototype._resetValue.call(this,n,t),this._commandManager=new r.EditStack(this),this._hasEditableRange=!1,this._editableRangeId=null,this._trimAutoWhitespaceLines=null},n.prototype.pushStackElement=function(){this._commandManager.pushStackElement()},n.prototype.pushEditOperations=function(e,n,i){var r=this;return this.deferredEmit(function(){if(r._options.trimAutoWhitespace&&r._trimAutoWhitespaceLines){for(var a=n.map(function(e){return{range:r.validateRange(e.range),text:e.text}}),s=!0,o=0,l=e.length;o<l;o++){for(var g=e[o],d=!1,h=0,u=a.length;h<u;h++){var p=a[h].range,c=p.startLineNumber>g.endLineNumber,m=g.startLineNumber>p.endLineNumber;if(!c&&!m){d=!0;break}}if(!d){s=!1;break}}if(s)for(var o=0,l=r._trimAutoWhitespaceLines.length;o<l;o++){for(var _=r._trimAutoWhitespaceLines[o],v=r.getLineMaxColumn(_),f=!0,h=0,u=a.length;h<u;h++){var p=a[h].range,L=a[h].text;if(!(_<p.startLineNumber||_>p.endLineNumber||_===p.startLineNumber&&p.startColumn===v&&p.isEmpty()&&L&&L.length>0&&"\n"===L.charAt(0))){f=!1;break}}f&&n.push({identifier:null,range:new t.Range(_,1,_,v),text:null,forceMoveMarkers:!1,isAutoWhitespaceEdit:!1})}r._trimAutoWhitespaceLines=null}return r._commandManager.pushEditOperation(e,n,i)})},n.prototype._reduceOperations=function(e){return e.length<1e3?e:[this._toSingleEditOperation(e)]},n.prototype._toSingleEditOperation=function(e){for(var n=!1,i=e[0].range,r=e[e.length-1].range,a=new t.Range(i.startLineNumber,i.startColumn,r.endLineNumber,r.endColumn),s=i.startLineNumber,o=i.startColumn,l=[],g=0,d=e.length;g<d;g++){var h=e[g],u=h.range;n=n||h.forceMoveMarkers;for(var p=s;p<u.startLineNumber;p++)p===s?l.push(this._lines[p-1].text.substring(o-1)):(l.push("\n"),l.push(this._lines[p-1].text));if(u.startLineNumber===s?l.push(this._lines[u.startLineNumber-1].text.substring(o-1,u.startColumn-1)):(l.push("\n"),l.push(this._lines[u.startLineNumber-1].text.substring(0,u.startColumn-1))),h.lines)for(var c=0,m=h.lines.length;c<m;c++)0!==c&&l.push("\n"),l.push(h.lines[c]);s=h.range.endLineNumber,o=h.range.endColumn}return{sortIndex:0,identifier:e[0].identifier,range:a,rangeLength:this.getValueLengthInRange(a),lines:l.join("").split("\n"),forceMoveMarkers:n,isAutoWhitespaceEdit:!1}},n._sortOpsAscending=function(e,n){var i=t.Range.compareRangesUsingEnds(e.range,n.range);return 0===i?e.sortIndex-n.sortIndex:i},n._sortOpsDescending=function(e,n){var i=t.Range.compareRangesUsingEnds(e.range,n.range);return 0===i?n.sortIndex-e.sortIndex:-i},n.prototype.applyEdits=function(e){if(0===e.length)return[];for(var t=[],i=0;i<e.length;i++){var r=e[i],a=this.validateRange(r.range);t[i]={sortIndex:i,identifier:r.identifier,range:a,rangeLength:this.getValueLengthInRange(a),lines:r.text?r.text.split(/\r\n|\r|\n/):null,forceMoveMarkers:r.forceMoveMarkers,isAutoWhitespaceEdit:r.isAutoWhitespaceEdit||!1}}t.sort(n._sortOpsAscending);for(var i=0,s=t.length-1;i<s;i++){var l=t[i].range.getEndPosition(),g=t[i+1].range.getStartPosition();if(g.isBefore(l))throw new Error("Overlapping ranges are not allowed!")}t=this._reduceOperations(t);for(var d=this.getEditableRange(),h=d.getStartPosition(),u=d.getEndPosition(),i=0;i<t.length;i++){var p=t[i].range;if(!h.isBeforeOrEqual(p.getStartPosition())||!p.getEndPosition().isBeforeOrEqual(u))throw new Error("Editing outside of editable range not allowed!")}for(var c=n._getInverseEditRanges(t),m=[],_=[],i=0;i<t.length;i++){var r=t[i],v=c[i];if(m[i]={identifier:r.identifier,range:v,text:this.getValueInRange(r.range),forceMoveMarkers:r.forceMoveMarkers},this._options.trimAutoWhitespace&&r.isAutoWhitespaceEdit&&r.range.isEmpty())for(var f=v.startLineNumber;f<=v.endLineNumber;f++){var L="";f===v.startLineNumber&&(L=this.getLineContent(r.range.startLineNumber),o.firstNonWhitespaceIndex(L)!==-1)||_.push({lineNumber:f,oldContent:L})}}if(this._applyEdits(t),this._trimAutoWhitespaceLines=null,this._options.trimAutoWhitespace&&_.length>0){_.sort(function(e,n){return n.lineNumber-e.lineNumber}),this._trimAutoWhitespaceLines=[];for(var i=0,E=_.length;i<E;i++){var f=_[i].lineNumber;if(!(i>0&&_[i-1].lineNumber===f)){var b=_[i].oldContent,M=this.getLineContent(f);0!==M.length&&M!==b&&o.firstNonWhitespaceIndex(M)===-1&&this._trimAutoWhitespaceLines.push(f)}}}return m},n._getInverseEditRanges=function(e){for(var n,i,r=[],a=null,s=0,o=e.length;s<o;s++){var l=e[s],g=void 0,d=void 0;a?a.range.endLineNumber===l.range.startLineNumber?(g=n,d=i+(l.range.startColumn-a.range.endColumn)):(g=n+(l.range.startLineNumber-a.range.endLineNumber),d=l.range.startColumn):(g=l.range.startLineNumber,d=l.range.startColumn);var h=void 0;if(l.lines&&l.lines.length>0){var u=l.lines.length,p=l.lines[0],c=l.lines[u-1];h=1===u?new t.Range(g,d,g,d+p.length):new t.Range(g,d,g+u-1,c.length+1)}else h=new t.Range(g,d,g,d);n=h.endLineNumber,i=h.endColumn,r.push(h),a=l}return r},n.prototype._applyEdits=function(e){var r=this,s=this._options.tabSize;e.sort(n._sortOpsDescending),this._withDeferredEvents(function(n){for(var o=[],l=[],g=[],d=function(e){e.startColumn===e.endColumn&&0===e.text.length||g.push(e)},h=function(){if(0!==g.length){g.reverse();for(var e=g[0].lineNumber,t=0,i=1,a=g.length;i<a;i++){var l=g[i].lineNumber;l!==e&&(r._invalidateLine(e-1),r._lines[e-1].applyEdits(n.changedMarkers,g.slice(t,i),s),r._lineStarts&&r._lineStarts.changeValue(e-1,r._lines[e-1].text.length+r._EOL.length),o.push(r._createLineChangedEvent(e)),e=l,t=i)}r._invalidateLine(e-1),r._lines[e-1].applyEdits(n.changedMarkers,g.slice(t,g.length),s),r._lineStarts&&r._lineStarts.changeValue(e-1,r._lines[e-1].text.length+r._EOL.length),o.push(r._createLineChangedEvent(e)),g=[]}},u=e[e.length-1].range.startLineNumber,p=e[0].range.endLineNumber+1,c=0,m=0,_=e.length;m<_;m++){var v=e[m],f=v.range.startLineNumber,L=v.range.startColumn,E=v.range.endLineNumber,b=v.range.endColumn;if(f!==E||L!==b||v.lines&&0!==v.lines.length){var M=E-f,R=v.lines?v.lines.length-1:0,C=Math.min(M,R);c+=R-M;for(var N=C;N>=0;N--){var y=f+N;d({lineNumber:y,startColumn:y===f?L:1,endColumn:y===E?b:r.getLineMaxColumn(y),text:v.lines?v.lines[N]:"",forceMoveMarkers:v.forceMoveMarkers})}if(C<M){h();var x=f+C,k=r.getLineMaxColumn(x),w=r._lines[E-1].split(n.changedMarkers,b,!1,s);r._invalidateLine(x-1);for(var I=E-x,S=[],N=0;N<I;N++){var O=x+N;S=S.concat(r._lines[O].deleteLine(n.changedMarkers,k,O+1))}r._lines.splice(x,I),r._lineStarts&&r._lineStarts.removeValues(x,I),r._lines[x-1].append(n.changedMarkers,w,s),r._lineStarts&&r._lineStarts.changeValue(x-1,r._lines[x-1].text.length+r._EOL.length),r._lines[x-1].addMarkers(S),o.push(r._createLineChangedEvent(x)),o.push(r._createLinesDeletedEvent(x+1,x+I))}if(C<R){h();var A=f+C,T=A===f?L:1;v.lines&&(T+=v.lines[C].length);var W=r._lines[A-1].split(n.changedMarkers,T,v.forceMoveMarkers,s);r._lineStarts&&r._lineStarts.changeValue(A-1,r._lines[A-1].text.length+r._EOL.length),o.push(r._createLineChangedEvent(A)),r._invalidateLine(A-1);for(var V=[],U=[],N=C+1;N<=R;N++){var D=f+N;r._lines.splice(D-1,0,new a.ModelLine(D,v.lines[N],s)),V.push(v.lines[N]),U.push(v.lines[N].length+r._EOL.length)}V[V.length-1]+=W.text,r._lineStarts&&r._lineStarts.insertValues(f+C,U),r._lines[f+R-1].append(n.changedMarkers,W,s),r._lineStarts&&r._lineStarts.changeValue(f+R-1,r._lines[f+R-1].text.length+r._EOL.length),o.push(r._createLinesInsertedEvent(A+1,f+R,V.join("\n")))}l.push({range:new t.Range(f,L,E,b),rangeLength:v.rangeLength,text:v.lines?v.lines.join(r.getEOL()):"",eol:r._EOL,versionId:-1,isUndoing:r._isUndoing,isRedoing:r._isRedoing})}}h(),p=Math.max(1,Math.min(r.getLineCount(),p+c)),0!==c&&(p=r.getLineCount());for(var P=u;P<=p;P++)r._lines[P-1].updateLineNumber(n.changedMarkers,P);if(0!==o.length||0!==l.length){0===o.length&&o.push(r._createLineChangedEvent(u));var j=Math.max(o.length,l.length),q=r.getVersionId()+j;r._setVersionId(q);for(var m=o.length-1,B=q;m>=0;m--,B--)o[m].versionId=B;for(var m=l.length-1,B=q;m>=0;m--,B--)l[m].versionId=B;for(var m=0,_=o.length;m<_;m++)r.emit(i.EventType.ModelRawContentChanged,o[m]);for(var m=0,_=l.length;m<_;m++)r.emit(i.EventType.ModelContentChanged2,l[m])}r._resetIndentRanges()})},n.prototype._assertLineNumbersOK=function(){for(var e=0,n=0,t=this._lines.length;n<t;n++){var i=this._lines[n],r=n+1;if(i.lineNumber!==r)throw new Error("Invalid lineNumber at line: "+r+"; text is: "+this.getValue());for(var a=i.getMarkers(),s=0,o=a.length;s<o;s++){e++;var l=a[s].id,g=this._markerIdToMarker[l];if(g.line!==i)throw new Error("Misplaced marker with id "+l)}}var d=Object.keys(this._markerIdToMarker).length;if(d!==e)throw new Error("There are misplaced markers!")},n.prototype.undo=function(){var e=this;return this._withDeferredEvents(function(){e._isUndoing=!0;var n=e._commandManager.undo();return e._isUndoing=!1,n?(e._overwriteAlternativeVersionId(n.recordedVersionId),n.selections):null})},n.prototype.redo=function(){var e=this;return this._withDeferredEvents(function(){e._isRedoing=!0;var n=e._commandManager.redo();return e._isRedoing=!1,n?(e._overwriteAlternativeVersionId(n.recordedVersionId),n.selections):null})},n.prototype.setEditableRange=function(e){this._commandManager.clear(),this._hasEditableRange&&(this.removeTrackedRange(this._editableRangeId),this._editableRangeId=null,this._hasEditableRange=!1),e&&(this._hasEditableRange=!0,this._editableRangeId=this.addTrackedRange(e,i.TrackedRangeStickiness.AlwaysGrowsWhenTypingAtEdges))},n.prototype.hasEditableRange=function(){return this._hasEditableRange},n.prototype.getEditableRange=function(){return this._hasEditableRange?this.getTrackedRange(this._editableRangeId):this.getFullModelRange()},n.prototype._createLineChangedEvent=function(e){return{changeType:i.EventType.ModelRawContentChangedLineChanged,lineNumber:e,detail:this._lines[e-1].text,versionId:-1,isUndoing:this._isUndoing,isRedoing:this._isRedoing}},n.prototype._createLinesDeletedEvent=function(e,n){return{changeType:i.EventType.ModelRawContentChangedLinesDeleted,fromLineNumber:e,toLineNumber:n,versionId:-1,isUndoing:this._isUndoing,isRedoing:this._isRedoing}},n.prototype._createLinesInsertedEvent=function(e,n,t){return{changeType:i.EventType.ModelRawContentChangedLinesInserted,fromLineNumber:e,toLineNumber:n,detail:t,versionId:-1,isUndoing:this._isUndoing,isRedoing:this._isRedoing}},n}(s.TextModelWithDecorations);n.EditableTextModel=l});