define(["require","exports","vs/editor/common/modes/lineStream","vs/editor/common/modes/nullMode","vs/editor/common/modes/supports"],function(e,t,o,n,i){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";function s(e){return"function"==typeof e}var d=function(){function e(e,t,o){if(this._mode=e,this.customization=t,this.supportsNestedModes=o,this._embeddedModesListeners={},this.supportsNestedModes&&!this._mode.setTokenizationSupport)throw new Error("Cannot be a mode with nested modes unless I can emit a tokenizationSupport changed event!");this.defaults={enterNestedMode:!s(t.enterNestedMode),getNestedMode:!s(t.getNestedMode),getNestedModeInitialState:!s(t.getNestedModeInitialState),getLeavingNestedModeData:!s(t.getLeavingNestedModeData),onReturningFromNestedMode:!s(t.onReturningFromNestedMode)}}return e.prototype.dispose=function(){for(var e in this._embeddedModesListeners)this._embeddedModesListeners[e].dispose(),delete this._embeddedModesListeners[e]},e.prototype.getInitialState=function(){return this.customization.getInitialState()},e.prototype.tokenize=function(e,t,o,n){return void 0===o&&(o=0),void 0===n&&(n=o+e.length),t.getMode()!==this._mode?this._nestedTokenize(e,t,o,n,[],[]):this._myTokenize(e,t,o,n,[],[])},e.prototype._nestedTokenize=function(e,t,o,i,s,d){for(var r=t.getStateData(),a=this.getLeavingNestedModeData(e,r),u=t;u.getStateData()&&u.getStateData().getMode()!==this._mode;)u=u.getStateData();var p=u.getMode();if(!a){var m;return m=p.tokenizationSupport?p.tokenizationSupport.tokenize(e,t,o,i):n.nullTokenize(p,e,t,o),m.tokens=s.concat(m.tokens),m.modeTransitions=d.concat(m.modeTransitions),m}var g=a.nestedModeBuffer;if(g.length>0){var l;l=p.tokenizationSupport?p.tokenizationSupport.tokenize(g,t,o,i):n.nullTokenize(p,g,t,o),t=l.endState,s=s.concat(l.tokens),d=d.concat(l.modeTransitions)}var M=a.bufferAfterNestedMode,h=a.stateAfterNestedMode;return h.setStateData(r.getStateData()),this.onReturningFromNestedMode(h,t),this._myTokenize(M,h,o+g.length,i,s,d)},e.prototype._myTokenize=function(t,n,s,d,r,a){var u,p,m=this,g=new o.LineStream(t),l=null,M=null;n=n.clone(),(a.length<=0||a[a.length-1].mode!==this._mode)&&a.push({startIndex:s,mode:this._mode});for(var h=Math.min(d-s,t.length);g.pos()<h;){p=g.pos();do{if(u=n.tokenize(g),null===u||void 0===u||(void 0===u.type||null===u.type)&&(void 0===u.nextState||null===u.nextState))throw new Error("Tokenizer must return a valid state");if(u.nextState&&(u.nextState.setStateData(n.getStateData()),n=u.nextState),g.pos()<=p)throw new Error("Stream did not advance while tokenizing. Mode id is "+this._mode.getId()+' (stuck at token type: "'+u.type+'", prepend tokens: "'+r.map(function(e){return e.type}).join(",")+'").')}while(!u.type&&""!==u.type);if((l!==u.type||u.dontMergeWithPrev||null===l)&&r.push(new i.Token(p+s,u.type)),l=u.type,this.supportsNestedModes&&this.enterNestedMode(n)){var f=this._getEmbeddedLevel(n);if(f<e.MAX_EMBEDDED_LEVELS){var S=this.getNestedModeInitialState(n),c=S.state.getMode();if("function"==typeof c.addSupportChangedListener&&!this._embeddedModesListeners.hasOwnProperty(c.getId())){var v=!1;this._embeddedModesListeners[c.getId()]=c.addSupportChangedListener(function(e){v||e.tokenizationSupport&&(v=!0,m._mode.setTokenizationSupport(function(e){return e.tokenizationSupport}),v=!1)})}if(!g.eos()){var N=t.substr(g.pos()),k=this._nestedTokenize(N,S.state,s+g.pos(),d,r,a);return k.retokenize=k.retokenize||S.missingModePromise,k}n=S.state,M=S.missingModePromise}}}return{tokens:r,actualStopOffset:g.pos()+s,modeTransitions:a,endState:n,retokenize:M}},e.prototype._getEmbeddedLevel=function(e){for(var t=-1;e;)t++,e=e.getStateData();return t},e.prototype.enterNestedMode=function(e){return!this.defaults.enterNestedMode&&this.customization.enterNestedMode(e)},e.prototype.getNestedMode=function(e){return this.defaults.getNestedMode?null:this.customization.getNestedMode(e)},e._validatedNestedMode=function(e){var t=new n.NullMode,o=null;return e&&e.mode&&(t=e.mode),e&&e.missingModePromise&&(o=e.missingModePromise),{mode:t,missingModePromise:o}},e.prototype.getNestedModeInitialState=function(t){if(this.defaults.getNestedModeInitialState){var o,i=e._validatedNestedMode(this.getNestedMode(t)),s=i.missingModePromise;return o=i.mode.tokenizationSupport?i.mode.tokenizationSupport.getInitialState():new n.NullState(i.mode,null),o.setStateData(t),{state:o,missingModePromise:s}}return this.customization.getNestedModeInitialState(t)},e.prototype.getLeavingNestedModeData=function(e,t){return this.defaults.getLeavingNestedModeData?null:this.customization.getLeavingNestedModeData(e,t)},e.prototype.onReturningFromNestedMode=function(e,t){return this.defaults.onReturningFromNestedMode?null:this.customization.onReturningFromNestedMode(e,t)},e.MAX_EMBEDDED_LEVELS=5,e}();t.TokenizationSupport=d});