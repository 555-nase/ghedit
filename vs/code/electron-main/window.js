/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate=this&&this.__decorate||function(e,t,i,n){var o,r=arguments.length,s=r<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,i,s):o(t,i))||s);return r>3&&s&&Object.defineProperty(t,i,s),s},__param=this&&this.__param||function(e,t){return function(i,n){t(i,n,e)}};define(["require","exports","path","vs/base/common/platform","vs/base/common/objects","vs/code/electron-main/storage","electron","vs/base/common/winjs.base","vs/code/electron-main/env","vs/code/electron-main/log"],function(e,t,i,n,o,r,s,a,d,h){"use strict";!function(e){e[e.Maximized=0]="Maximized",e[e.Normal=1]="Normal",e[e.Minimized=2]="Minimized",e[e.Fullscreen=3]="Fullscreen"}(t.WindowMode||(t.WindowMode={}));var l=t.WindowMode;t.defaultWindowState=function(e){return void 0===e&&(e=l.Normal),{width:1024,height:768,mode:e}},function(e){e[e.NONE=0]="NONE",e[e.LOADING=1]="LOADING",e[e.NAVIGATING=2]="NAVIGATING",e[e.READY=3]="READY"}(t.ReadyState||(t.ReadyState={}));var u=t.ReadyState,c=function(){function c(e,t,o,r){this.logService=t,this.envService=o,this.storageService=r,this.options=e,this._lastFocusTime=-1,this._readyState=u.NONE,this._extensionDevelopmentPath=e.extensionDevelopmentPath,this.whenReadyCallbacks=[],this.restoreWindowState(e.state);var a=/vs($| )/.test(this.storageService.getItem(c.themeStorageKey));global.windowShow||(global.windowShow=Date.now());var d=this.currentWindowMode===l.Maximized||this.currentWindowMode===l.Fullscreen,h={width:this.windowState.width,height:this.windowState.height,x:this.windowState.x,y:this.windowState.y,backgroundColor:a?"#FFFFFF":n.isMacintosh?"#131313":"#1E1E1E",minWidth:c.MIN_WIDTH,minHeight:c.MIN_HEIGHT,show:!d,title:this.envService.product.nameLong,webPreferences:{backgroundThrottling:!1}};n.isLinux&&(h.icon=i.join(this.envService.appRoot,"resources/linux/code.png")),this._win=new s.BrowserWindow(h),this._id=this._win.id,d&&(this.win.maximize(),this.currentWindowMode===l.Fullscreen&&this.win.setFullScreen(!0),this.win.isVisible()||this.win.show()),this._lastFocusTime=Date.now(),this.storageService.getItem(c.menuBarHiddenKey,!1)&&this.setMenuBarVisibility(!1),this.registerListeners()}return Object.defineProperty(c.prototype,"isPluginDevelopmentHost",{get:function(){return!!this._extensionDevelopmentPath},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"extensionDevelopmentPath",{get:function(){return this._extensionDevelopmentPath},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"config",{get:function(){return this.currentConfig},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"win",{get:function(){return this._win},enumerable:!0,configurable:!0}),c.prototype.focus=function(){this._win&&(this._win.isMinimized()&&this._win.restore(),this._win.focus())},Object.defineProperty(c.prototype,"lastFocusTime",{get:function(){return this._lastFocusTime},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"openedWorkspacePath",{get:function(){return this.currentConfig.workspacePath},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"openedFilePath",{get:function(){return this.currentConfig.filesToOpen&&this.currentConfig.filesToOpen[0]&&this.currentConfig.filesToOpen[0].filePath},enumerable:!0,configurable:!0}),c.prototype.setReady=function(){for(this._readyState=u.READY;this.whenReadyCallbacks.length;)this.whenReadyCallbacks.pop()(this)},c.prototype.ready=function(){var e=this;return new a.TPromise(function(t){return e._readyState===u.READY?t(e):void e.whenReadyCallbacks.push(t)})},Object.defineProperty(c.prototype,"readyState",{get:function(){return this._readyState},enumerable:!0,configurable:!0}),c.prototype.registerListeners=function(){var e=this;this._win.webContents.on("did-finish-load",function(){e._readyState=u.LOADING,e.pendingLoadConfig&&(e.currentConfig=e.pendingLoadConfig,e.pendingLoadConfig=null),e.win.isVisible()||(global.windowShow||(global.windowShow=Date.now()),e.currentWindowMode===l.Maximized&&e.win.maximize(),e.win.isVisible()||e.win.show())}),this._win.on("app-command",function(t,i){e.readyState===u.READY&&("browser-backward"===i?e.send("vscode:runAction","workbench.action.navigateBack"):"browser-forward"===i&&e.send("vscode:runAction","workbench.action.navigateForward"))}),this._win.webContents.on("new-window",function(e,t){e.preventDefault(),s.shell.openExternal(t)}),this._win.on("focus",function(){e._lastFocusTime=Date.now()}),this._win.webContents.on("did-fail-load",function(e,t,i){console.warn("[electron event]: fail to load, ",i)}),this.envService.isBuilt&&this._win.webContents.on("will-navigate",function(e){e&&e.preventDefault()})},c.prototype.load=function(e){var t=this;this.readyState===u.NONE?this.currentConfig=e:(this.pendingLoadConfig=e,this._readyState=u.NAVIGATING),this._win.loadURL(this.getUrl(e)),e.isBuilt||(this.showTimeoutHandle=setTimeout(function(){!t._win||t._win.isVisible()||t._win.isMinimized()||(t._win.show(),t._win.focus(),t._win.webContents.openDevTools())},1e4))},c.prototype.reload=function(e){var t=o.mixin({},this.currentConfig);delete t.filesToOpen,delete t.filesToCreate,delete t.filesToDiff,delete t.extensionsToInstall,this.isPluginDevelopmentHost&&e&&(t.verboseLogging=e.verboseLogging,t.logExtensionHostCommunication=e.logExtensionHostCommunication,t.debugBrkFileWatcherPort=e.debugBrkFileWatcherPort,t.debugExtensionHostPort=e.debugExtensionHostPort,t.debugBrkExtensionHost=e.debugBrkExtensionHost,t.extensionsHomePath=e.extensionsHomePath),this.load(t)},c.prototype.getUrl=function(t){var i=e.toUrl("vs/workbench/electron-browser/index.html");return i+="?config="+encodeURIComponent(JSON.stringify(t))},c.prototype.serializeWindowState=function(){if(this.win.isFullScreen())return{mode:l.Fullscreen};var e,t=Object.create(null);if(e=!n.isMacintosh&&this.win.isMaximized()?l.Maximized:this.win.isMinimized()?l.Minimized:l.Normal,e===l.Maximized?t.mode=l.Maximized:e!==l.Minimized&&(t.mode=l.Normal),e===l.Normal||e===l.Maximized){var i=this.win.getPosition(),o=this.win.getSize();t.x=i[0],t.y=i[1],t.width=o[0],t.height=o[1]}return t},c.prototype.restoreWindowState=function(e){if(e)try{e=this.validateWindowState(e)}catch(i){this.logService.log("Unexpected error validating window state: "+i+"\n"+i.stack)}e||(e=t.defaultWindowState()),this.windowState=e,this.currentWindowMode=this.windowState.mode},c.prototype.validateWindowState=function(e){if(!e)return null;if(e.mode===l.Fullscreen)return this.options.allowFullscreen?e:null;if([e.x,e.y,e.width,e.height].some(function(e){return"number"!=typeof e}))return null;if(e.width<=0||e.height<=0)return null;var i=s.screen.getAllDisplays();if(1===i.length){var n=i[0].bounds;return e.mode!==l.Maximized&&n.width>0&&n.height>0&&(e.x<n.x&&(e.x=n.x),e.y<n.y&&(e.y=n.y),e.x>n.x+n.width&&(e.x=n.x),e.y>n.y+n.height&&(e.y=n.y),e.width>n.width&&(e.width=n.width),e.height>n.height&&(e.height=n.height)),e.mode===l.Maximized?t.defaultWindowState(l.Maximized):e}var o={x:e.x,y:e.y,width:e.width,height:e.height},r=s.screen.getDisplayMatching(o);if(r&&r.bounds.x+r.bounds.width>o.x&&r.bounds.y+r.bounds.height>o.y){if(e.mode===l.Maximized){var a=t.defaultWindowState(l.Maximized);return a.x=e.x,a.y=e.y,a}return e}return null},c.prototype.getBounds=function(){var e=this.win.getPosition(),t=this.win.getSize();return{x:e[0],y:e[1],width:t[0],height:t[1]}},c.prototype.toggleFullScreen=function(){var e=!this.win.isFullScreen();this.win.setFullScreen(e),(n.isWindows||n.isLinux)&&(e?this.setMenuBarVisibility(!1):this.setMenuBarVisibility(!this.storageService.getItem(c.menuBarHiddenKey,!1)))},c.prototype.setMenuBarVisibility=function(e){this.win.setMenuBarVisibility(e),this.win.setAutoHideMenuBar(!e)},c.prototype.sendWhenReady=function(e){for(var t=this,i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];this.ready().then(function(){t.send.apply(t,[e].concat(i))})},c.prototype.send=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];(n=this._win.webContents).send.apply(n,[e].concat(t));var n},c.prototype.dispose=function(){this.showTimeoutHandle&&clearTimeout(this.showTimeoutHandle),this._win=null},c.menuBarHiddenKey="menuBarHidden",c.themeStorageKey="theme",c.MIN_WIDTH=200,c.MIN_HEIGHT=120,c=__decorate([__param(1,h.ILogService),__param(2,d.IEnvironmentService),__param(3,r.IStorageService)],c)}();t.VSCodeWindow=c});