/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},__decorate=this&&this.__decorate||function(e,t,n,r){var i,o=arguments.length,u=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)u=Reflect.decorate(e,t,n,r);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(u=(o<3?i(u):o>3?i(t,n,u):i(t,n))||u);return o>3&&u&&Object.defineProperty(t,n,u),u},__param=this&&this.__param||function(e,t){return function(n,r){t(n,r,e)}};define(["require","exports","path","vs/base/node/pfs","vs/base/node/crypto","events","os","child_process","vs/base/node/extfs","vs/base/common/types","vs/base/common/winjs.base","vs/base/node/request","vs/base/node/proxy","vs/code/electron-main/settings","vs/code/electron-main/lifecycle","vs/code/electron-main/env"],function(e,t,n,r,i,o,u,c,s,a,l,h,p,f,d,v){"use strict";var m=function(e){function t(t,n,r){e.call(this),this.lifecycleService=t,this.envService=n,this.settingsService=r,this.url=null,this.currentRequest=null}return __extends(t,e),Object.defineProperty(t.prototype,"cachePath",{get:function(){var e=n.join(u.tmpdir(),"vscode-update");return new l.TPromise(function(t,n){return s.mkdirp(e,null,function(r){return r?n(r):t(e)})})},enumerable:!0,configurable:!0}),t.prototype.setFeedURL=function(e){this.url=e},t.prototype.checkForUpdates=function(){var e=this;if(!this.url)throw new Error("No feed url set.");if(!this.currentRequest){this.emit("checking-for-update");var t=this.settingsService.getValue("http.proxy"),n=this.settingsService.getValue("http.proxyStrictSSL",!0),o=p.getProxyAgent(this.url,{proxyUrl:t,strictSSL:n});this.currentRequest=h.json({url:this.url,agent:o}).then(function(o){return o&&o.url&&o.version?(e.emit("update-available"),e.cleanup(o.version).then(function(){return e.getUpdatePackagePath(o.version).then(function(e){return r.exists(e).then(function(u){if(u)return l.TPromise.as(e);var c=o.url,s=o.hash,a=e+".tmp",f=p.getProxyAgent(c,{proxyUrl:t,strictSSL:n});return h.download(a,{url:c,agent:f,strictSSL:n}).then(s?function(){return i.checksum(a,o.hash)}:function(){return null}).then(function(){return r.rename(a,e)}).then(function(){return e})})}).then(function(t){e.emit("update-downloaded",{},o.releaseNotes,o.version,new Date,e.url,function(){return e.quitAndUpdate(t)})})})):(e.emit("update-not-available"),e.cleanup())}).then(null,function(t){a.isString(t)&&/^Server returned/.test(t)||(e.emit("update-not-available"),e.emit("error",t))}).then(function(){return e.currentRequest=null})}},t.prototype.getUpdatePackagePath=function(e){var t=this;return this.cachePath.then(function(r){return n.join(r,"CodeSetup-"+t.envService.quality+"-"+e+".exe")})},t.prototype.quitAndUpdate=function(e){this.lifecycleService.quit().done(function(t){t||c.spawn(e,["/silent","/mergetasks=runcode,!desktopicon,!quicklaunchicon"],{detached:!0,stdio:["ignore","ignore","ignore"]})})},t.prototype.cleanup=function(e){var t=this;void 0===e&&(e=null);var i=e?function(n){return!new RegExp(t.envService.quality+"-"+e+"\\.exe$").test(n)}:function(){return!0};return this.cachePath.then(function(e){return r.readdir(e).then(function(t){return l.Promise.join(t.filter(i).map(function(t){return r.unlink(n.join(e,t)).then(null,function(){return null})}))})})},t=__decorate([__param(0,d.ILifecycleService),__param(1,v.IEnvironmentService),__param(2,f.ISettingsService)],t)}(o.EventEmitter);t.Win32AutoUpdaterImpl=m});