/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate=this&&this.__decorate||function(e,t,i,o){var n,r=arguments.length,s=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,o);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(s=(r<3?n(s):r>3?n(t,i,s):n(t,i))||s);return r>3&&s&&Object.defineProperty(t,i,s),s},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}};define(["require","exports","events","electron","vs/base/common/winjs.base","vs/code/electron-main/window","vs/code/electron-main/env","vs/platform/instantiation/common/instantiation","vs/code/electron-main/log","vs/code/electron-main/storage"],function(e,t,i,o,n,r,s,c,a,l){"use strict";var u={BEFORE_QUIT:"before-quit"};t.ILifecycleService=c.createDecorator("lifecycleService");var d=function(){function e(e,t,o){this.envService=e,this.logService=t,this.storageService=o,this.eventEmitter=new i.EventEmitter,this.windowToCloseRequest=Object.create(null),this.quitRequested=!1,this.oneTimeListenerTokenGenerator=0,this._wasUpdated=!1,this.handleUpdated()}return e.prototype.handleUpdated=function(){this._wasUpdated=!!this.storageService.getItem(e.QUIT_FROM_UPDATE_MARKER),this._wasUpdated&&this.storageService.removeItem(e.QUIT_FROM_UPDATE_MARKER)},Object.defineProperty(e.prototype,"wasUpdated",{get:function(){return this._wasUpdated},enumerable:!0,configurable:!0}),e.prototype.onBeforeQuit=function(e){var t=this;return this.eventEmitter.addListener(u.BEFORE_QUIT,e),function(){return t.eventEmitter.removeListener(u.BEFORE_QUIT,e)}},e.prototype.ready=function(){this.registerListeners()},e.prototype.registerListeners=function(){var e=this;o.app.on("before-quit",function(t){e.logService.log("Lifecycle#before-quit"),e.quitRequested||e.eventEmitter.emit(u.BEFORE_QUIT),e.quitRequested=!0}),o.app.on("window-all-closed",function(){e.logService.log("Lifecycle#window-all-closed"),(e.quitRequested||"darwin"!==process.platform||e.envService.cliArgs.waitForWindowClose)&&o.app.quit()})},e.prototype.registerWindow=function(e){var t=this;e.win.on("close",function(i){var o=e.id;return t.logService.log("Lifecycle#window-before-close",o),t.windowToCloseRequest[o]?(t.logService.log("Lifecycle#window-close",o),void delete t.windowToCloseRequest[o]):(i.preventDefault(),void t.unload(e).done(function(i){i?(t.quitRequested=!1,delete t.windowToCloseRequest[o]):(t.windowToCloseRequest[o]=!0,e.win.close())}))})},e.prototype.unload=function(e){var t=this;return e.readyState!==r.ReadyState.READY?n.TPromise.as(!1):(this.logService.log("Lifecycle#unload()",e.id),new n.TPromise(function(i){var n=t.oneTimeListenerTokenGenerator++,r="vscode:ok"+n,s="vscode:cancel"+n;o.ipcMain.once(r,function(){i(!1)}),o.ipcMain.once(s,function(){t.pendingQuitPromiseComplete&&(t.pendingQuitPromiseComplete(!0),t.pendingQuitPromiseComplete=null,t.pendingQuitPromise=null),i(!0)}),e.send("vscode:beforeUnload",{okChannel:r,cancelChannel:s})}))},e.prototype.quit=function(t){var i=this;return this.logService.log("Lifecycle#quit()"),this.pendingQuitPromise||(this.pendingQuitPromise=new n.TPromise(function(n){i.pendingQuitPromiseComplete=n,o.app.once("will-quit",function(){i.pendingQuitPromiseComplete&&(t&&i.storageService.setItem(e.QUIT_FROM_UPDATE_MARKER,!0),i.pendingQuitPromiseComplete(!1),i.pendingQuitPromiseComplete=null,i.pendingQuitPromise=null)}),o.app.quit()})),this.pendingQuitPromise},e.QUIT_FROM_UPDATE_MARKER="quit.from.update",e=__decorate([__param(0,s.IEnvironmentService),__param(1,a.ILogService),__param(2,l.IStorageService)],e)}();t.LifecycleService=d});