/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)},__decorate=this&&this.__decorate||function(e,t,i,n){var a,r=arguments.length,o=r<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,n);else for(var c=e.length-1;c>=0;c--)(a=e[c])&&(o=(r<3?a(o):r>3?a(t,i,o):a(t,i))||o);return r>3&&o&&Object.defineProperty(t,i,o),o},__param=this&&this.__param||function(e,t){return function(i,n){t(i,n,e)}};define(["require","exports","original-fs","path","electron","vs/base/common/platform","events","vs/code/electron-main/env","vs/code/electron-main/settings","vs/code/electron-main/auto-updater.win32","vs/code/electron-main/auto-updater.linux","vs/code/electron-main/lifecycle","vs/platform/instantiation/common/instantiation"],function(e,t,i,n,a,r,o,c,l,s,p,u,d){"use strict";!function(e){e[e.Uninitialized=0]="Uninitialized",e[e.Idle=1]="Idle",e[e.CheckingForUpdate=2]="CheckingForUpdate",e[e.UpdateAvailable=3]="UpdateAvailable",e[e.UpdateDownloaded=4]="UpdateDownloaded"}(t.State||(t.State={}));var h=t.State;!function(e){e[e.Implicit=0]="Implicit",e[e.Explicit=1]="Explicit"}(t.ExplicitState||(t.ExplicitState={}));var f=t.ExplicitState;t.IUpdateService=d.createDecorator("updateService");var v=function(e){function t(t,i,n,o){e.call(this),this.lifecycleService=i,this.envService=n,this.settingsService=o,this._state=h.Uninitialized,this.explicitState=f.Implicit,this._availableUpdate=null,this._lastCheckDate=null,this._feedUrl=null,this._channel=null,r.isWindows?this.raw=t.createInstance(s.Win32AutoUpdaterImpl):r.isLinux?this.raw=t.createInstance(p.LinuxAutoUpdaterImpl):r.isMacintosh&&(this.raw=a.autoUpdater),this.raw&&this.initRaw()}return __extends(t,e),t.prototype.initRaw=function(){var e=this;this.raw.on("error",function(t,i){e.emit("error",t,i),e.setState(h.Idle)}),this.raw.on("checking-for-update",function(){e.emit("checking-for-update"),e.setState(h.CheckingForUpdate)}),this.raw.on("update-available",function(t,i){e.emit("update-available",i);var n=null;i&&(n={releaseNotes:"",version:"",date:new Date,quitAndUpdate:function(){return a.shell.openExternal(i)}}),e.setState(h.UpdateAvailable,n)}),this.raw.on("update-not-available",function(){e.emit("update-not-available",e.explicitState===f.Explicit),e.setState(h.Idle)}),this.raw.on("update-downloaded",function(t,i,n,a,r,o){var c={releaseNotes:i,version:n,date:a,quitAndUpdate:function(){return e.quitAndUpdate(o)}};e.emit("update-downloaded",c),e.setState(h.UpdateDownloaded,c)})},t.prototype.quitAndUpdate=function(e){this.lifecycleService.quit(!0).done(function(t){t||(r.isMacintosh&&a.session.defaultSession.flushStorageData(),e())})},Object.defineProperty(t.prototype,"feedUrl",{get:function(){return this._feedUrl},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"channel",{get:function(){return this._channel},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;if(!this.feedUrl){var t=this.getUpdateChannel(),i=this.getUpdateFeedUrl(t);if(i){try{this.raw.setFeedURL(i)}catch(n){return}this._channel=t,this._feedUrl=i,this.setState(h.Idle);var a=setTimeout(function(){return e.checkForUpdates()},3e4);this.on("error",function(e,t){return console.error(e,t)}),this.on("checking-for-update",function(){return clearTimeout(a)}),this.on("update-not-available",function(){a=setTimeout(function(){return e.checkForUpdates()},36e5)})}}},Object.defineProperty(t.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"availableUpdate",{get:function(){return this._availableUpdate},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lastCheckDate",{get:function(){return this._lastCheckDate},enumerable:!0,configurable:!0}),t.prototype.checkForUpdates=function(e){void 0===e&&(e=!1),this.explicitState=e?f.Explicit:f.Implicit,this._lastCheckDate=new Date,this.raw.checkForUpdates()},t.prototype.setState=function(e,t){void 0===t&&(t=null),this._state=e,this._availableUpdate=t,this.emit("change")},t.prototype.getUpdateChannel=function(){var e=this.settingsService.getValue("update.channel")||"default";return"none"===e?null:this.envService.quality},t.prototype.getUpdateFeedUrl=function(e){return e?r.isWindows&&!i.existsSync(n.join(n.dirname(process.execPath),"unins000.exe"))?null:this.envService.updateUrl&&this.envService.product.commit?this.envService.updateUrl+"/api/update/"+c.getPlatformIdentifier()+"/"+e+"/"+this.envService.product.commit:null:null},t=__decorate([__param(0,d.IInstantiationService),__param(1,u.ILifecycleService),__param(2,c.IEnvironmentService),__param(3,l.ISettingsService)],t)}(o.EventEmitter);t.UpdateManager=v});