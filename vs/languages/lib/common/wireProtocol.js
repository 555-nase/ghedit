define(["require","exports"],function(e,t){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var n=8192,i="Content-Length: ",r=Buffer.byteLength(i,"utf8"),f=new Buffer(" ","utf8")[0],h=new Buffer("\r","utf8")[0],s=new Buffer("\n","utf8")[0],u=function(){function e(){this.index=0,this.buffer=new Buffer(n)}return e.prototype.append=function(e){var t=null;if(t=Buffer.isBuffer(e)?e:new Buffer(e,"utf8"),this.buffer.length-this.index>=t.length)t.copy(this.buffer,this.index,0,t.length);else{var i=(Math.ceil((this.index+t.length)/n)+1)*n;0===this.index?(this.buffer=new Buffer(i),t.copy(this.buffer,0,0,t.length)):this.buffer=Buffer.concat([this.buffer.slice(0,this.index),t],i)}this.index+=t.length},e.prototype.tryReadContentLength=function(){for(var e=-1,t=0;t<this.index&&(this.buffer[t]===f||this.buffer[t]===h||this.buffer[t]===s);)t++;if(this.index<t+r)return e;t+=r;for(var n=t;t<this.index&&this.buffer[t]!==h;)t++;if(t+3>=this.index||this.buffer[t+1]!==s||this.buffer[t+2]!==h||this.buffer[t+3]!==s)return e;var i=this.buffer.toString("utf8",n,t);return e=parseInt(i),this.buffer=this.buffer.slice(t+4),this.index=this.index-(t+4),e},e.prototype.tryReadContent=function(e){if(this.index<e)return null;for(var t=this.buffer.toString("utf8",0,e),n=e;n<this.index&&(this.buffer[n]===h||this.buffer[n]===s);)n++;return this.buffer.copy(this.buffer,0,n),this.index=this.index-n,t},e.prototype.tryReadLine=function(){for(var e=0;e<this.index&&this.buffer[e]!==h&&this.buffer[e]!==s;)e++;if(e>=this.index)return null;for(var t=this.buffer.toString("utf8",0,e);e<this.index&&(this.buffer[e]===h||this.buffer[e]===s);)e++;return this.index===e?this.index=0:(this.buffer.copy(this.buffer,0,e),this.index=this.index-e),t},Object.defineProperty(e.prototype,"numberOfBytes",{get:function(){return this.index},enumerable:!0,configurable:!0}),e}();!function(e){e[e.Length=0]="Length",e[e.Line=1]="Line"}(t.ReaderType||(t.ReaderType={}));var a=t.ReaderType,o=function(){function e(e,t,n){var i=this;void 0===n&&(n=a.Length),this.readable=e,this.buffer=new u,this.callback=t,this.nextMessageLength=-1,n===a.Length?this.readable.on("data",function(e){i.onLengthData(e)}):n===a.Line&&this.readable.on("data",function(e){i.onLineData(e)})}return e.prototype.onLengthData=function(e){for(this.buffer.append(e);;){if(this.nextMessageLength===-1&&(this.nextMessageLength=this.buffer.tryReadContentLength(),this.nextMessageLength===-1))return;var t=this.buffer.tryReadContent(this.nextMessageLength);if(null===t)return;this.nextMessageLength=-1;var n=JSON.parse(t);this.callback(n)}},e.prototype.onLineData=function(e){for(this.buffer.append(e);;){var t=this.buffer.tryReadLine();if(null===t)return;this.callback(JSON.parse(t))}},e}();t.Reader=o;var b=function(){function e(e){this.writable=e}return e.prototype.write=function(e){var t=JSON.stringify(e),n=[i,Buffer.byteLength(t,"utf8").toString(),"\r\n\r\n",t,"\r\n"];this.writable.write(n.join(""),"utf8")},e}();t.Writer=b});