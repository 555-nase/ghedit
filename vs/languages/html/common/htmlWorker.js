var __decorate=this&&this.__decorate||function(e,t,n,r){var o,i=arguments.length,s=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(i<3?o(s):i>3?o(t,n,s):o(t,n))||s);return i>3&&s&&Object.defineProperty(t,n,s),s},__param=this&&this.__param||function(e,t){return function(n,r){t(n,r,e)}};define(["require","exports","vs/base/common/uri","vs/base/common/winjs.base","vs/languages/lib/common/beautify-html","vs/languages/html/common/htmlTags","vs/base/common/network","vs/editor/common/modes","vs/base/common/strings","vs/editor/common/services/resourceService","vs/languages/html/common/htmlScanner","vs/languages/html/common/htmlTokenTypes","vs/languages/html/common/htmlEmptyTagsShared","vs/editor/common/modes/supports/suggestSupport","vs/base/common/paths"],function(e,t,n,r,o,i,s,a,g,c,u,l,p,T,h){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";function f(e){return/^\s*$/.test(e)}var m;!function(e){e[e.LOOKING_FOR_HREF_OR_SRC=1]="LOOKING_FOR_HREF_OR_SRC",e[e.AFTER_HREF_OR_SRC=2]="AFTER_HREF_OR_SRC"}(m||(m={}));var d=function(){function e(e,t){this._modeId=e,this.resourceService=t,this._tagProviders=[],this._tagProviders.push(i.getHTML5TagProvider()),this.addCustomTagProviders(this._tagProviders)}return e.prototype.addCustomTagProviders=function(e){e.push(i.getAngularTagProvider()),e.push(i.getIonicTagProvider())},e.prototype.provideDocumentRangeFormattingEdits=function(e,t,n){return this.formatHTML(e,t,n)},e.prototype.formatHTML=function(e,t,n){var i=this.resourceService.get(e),s=t?i.getValueInRange(t):i.getValue(),a={indent_size:n.insertSpaces?n.tabSize:1,indent_char:n.insertSpaces?" ":"\t",wrap_line_length:this.getFormatOption("wrapLineLength",120),unformatted:this.getTagsFormatOption("unformatted",void 0),indent_inner_html:this.getFormatOption("indentInnerHtml",!1),preserve_newlines:this.getFormatOption("preserveNewLines",!1),max_preserve_newlines:this.getFormatOption("maxPreserveNewLines",void 0),indent_handlebars:this.getFormatOption("indentHandlebars",!1),end_with_newline:this.getFormatOption("endWithNewline",!1),extra_liners:this.getTagsFormatOption("extraLiners",void 0)},g=o.html_beautify(s,a);return r.TPromise.as([{range:t,text:g}])},e.prototype.getFormatOption=function(e,t){if(this.formatSettings&&this.formatSettings.hasOwnProperty(e)){var n=this.formatSettings[e];if(null!==n)return n}return t},e.prototype.getTagsFormatOption=function(e,t){var n=this.getFormatOption(e,null);return"string"==typeof n?n.length>0?n.split(",").map(function(e){return e.trim().toLowerCase()}):[]:t},e.prototype._doConfigure=function(e){return this.formatSettings=e&&e.format,r.TPromise.as(null)},e.prototype.findMatchingOpenTag=function(e){for(var t={},n=!1;e.scanBack();)if(l.isTag(e.getTokenType())&&!n){var r=e.getTokenContent();if(e.scanBack(),e.getTokenType()===l.DELIM_END)t[r]=(t[r]||0)+1;else if(!p.isEmptyElement(r)){if(!t[r])return r;t[r]--}}else e.getTokenType()===l.DELIM_START&&(n="/>"===e.getTokenContent());return null},e.prototype.collectTagSuggestions=function(e,t,n){var r=this,o=e.getModel(),i=o.getLineContent(t.lineNumber),s=i.substr(t.column-1),a=f(s)||g.startsWith(s,"<")?">":"",c=function(i){var s=e.getTokenPosition(),g=r.findMatchingOpenTag(e);if(g){var c={label:"/"+g,codeSnippet:"/"+g+a,overwriteBefore:i,type:"property"};n.suggestions.push(c);var u=e.getTokenPosition();if(s.lineNumber!==u.lineNumber){var l=o.getLineContent(u.lineNumber).substring(0,u.column-1),p=o.getLineContent(s.lineNumber).substring(0,s.column-1);f(l)&&f(p)&&(c.overwriteBefore=t.column-1,c.codeSnippet=l+"</"+g+a,c.filterText=p+"</"+g+a)}return!0}return!1};if(e.getTokenType()===l.DELIM_END&&e.getTokenRange().endColumn===t.column){var u=c(n.currentWord.length+1);u||this._tagProviders.forEach(function(e){e.collectTags(function(e,t){n.suggestions.push({label:"/"+e,overwriteBefore:n.currentWord.length+1,codeSnippet:"/"+e+a,type:"property",documentationLabel:t,filterText:"</"+e+a})})})}else c(n.currentWord.length),this._tagProviders.forEach(function(e){e.collectTags(function(e,t){n.suggestions.push({label:e,codeSnippet:e,type:"property",documentationLabel:t,overwriteBefore:n.currentWord.length})})})},e.prototype.collectContentSuggestions=function(e){},e.prototype.collectAttributeSuggestions=function(e,t){var n=null;do{if(l.isTag(e.getTokenType())){n=e.getTokenContent();break}if(e.getTokenType()===l.DELIM_START)break}while(e.scanBack());this._tagProviders.forEach(function(e){e.collectAttributes(n,function(e,n){var r=e;"v"!==n&&(r+='="{{}}"'),t.suggestions.push({label:e,codeSnippet:r,type:"handler"===n?"function":"value",overwriteBefore:t.currentWord.length})})})},e.prototype.collectAttributeValueSuggestions=function(e,t){for(var n=e.getTokenType()===l.DELIM_ASSIGN,r=null,o=null;e.scanBack();)if(e.getTokenType()===l.ATTRIB_NAME){r=e.getTokenContent();break}for(;e.scanBack();){if(l.isTag(e.getTokenType())){o=e.getTokenContent();break}if(e.getTokenType()===l.DELIM_START)return}this._tagProviders.forEach(function(e){e.collectValues(o,r,function(e){t.suggestions.push({label:e,codeSnippet:n?'"'+e+'"':e,type:"unit",overwriteBefore:t.currentWord.length})})})},e.prototype.provideCompletionItems=function(e,t){var n=this.resourceService.get(e),o=n.getModeIdAtPosition(t.lineNumber,t.column);return o===this._modeId?this.suggestHTML(e,t):r.TPromise.as([])},e.prototype.suggestHTML=function(e,t){return this.doSuggest(e,t).then(function(e){return T.filterSuggestions(e)})},e.prototype.doSuggest=function(e,t){var n=this.resourceService.get(e),o=n.getWordUntilPosition(t).word,i={currentWord:o,suggestions:[]},s=u.getScanner(n,t);switch(s.getTokenType()){case l.DELIM_START:case l.DELIM_END:s.isOpenBrace()?this.collectTagSuggestions(s,t,i):this.collectContentSuggestions(i);break;case l.ATTRIB_NAME:this.collectAttributeSuggestions(s,i);break;case l.ATTRIB_VALUE:this.collectAttributeValueSuggestions(s,i);break;case l.DELIM_ASSIGN:s.isAtTokenEnd()&&this.collectAttributeValueSuggestions(s,i);break;case"":if(f(s.getTokenContent())&&s.scanBack())switch(s.getTokenType()){case l.ATTRIB_VALUE:case l.ATTRIB_NAME:this.collectAttributeSuggestions(s,i);break;case l.DELIM_ASSIGN:this.collectAttributeValueSuggestions(s,i);break;case l.DELIM_START:case l.DELIM_END:s.isOpenBrace()?this.collectTagSuggestions(s,t,i):this.collectContentSuggestions(i);break;default:l.isTag(s.getTokenType())&&this.collectAttributeSuggestions(s,i)}else this.collectContentSuggestions(i);break;default:l.isTag(s.getTokenType())&&(s.scanBack(),this.collectTagSuggestions(s,t,i))}return r.TPromise.as(i)},e.prototype.findMatchingBracket=function(e,t){if(p.isEmptyElement(e))return null;var n=0;if(t.scanBack(),t.getTokenType()===l.DELIM_END)for(var r=!1;t.scanBack();)if(l.isTag(t.getTokenType())&&t.getTokenContent()===e&&!r){var o=t.getTokenRange();if(t.scanBack(),t.getTokenType()===l.DELIM_START){if(0===n)return o;n--}else n++}else t.getTokenType()===l.DELIM_START&&(r="/>"===t.getTokenContent());else for(var i=!1;t.scanForward();)if(l.isTag(t.getTokenType())&&t.getTokenContent()===e)if(i){if(n--,n<=0)return t.getTokenRange()}else if(t.scanForward(),t.getTokenType()===l.DELIM_START&&"/>"===t.getTokenContent()){if(n<=0)return null}else n++;else t.getTokenType()===l.DELIM_START?i=!1:t.getTokenType()===l.DELIM_END&&(i=!0);return null},e.prototype.provideDocumentHighlights=function(e,t,n){void 0===n&&(n=!1);var o=this.resourceService.get(e),i=o.getWordAtPosition(t),s=i?i.word:"",g=[],c=u.getScanner(o,t);if(l.isTag(c.getTokenType())){var p=c.getTokenContent();g.push({range:c.getTokenRange(),kind:a.DocumentHighlightKind.Read});var T=this.findMatchingBracket(p,c);T&&g.push({range:T,kind:a.DocumentHighlightKind.Read})}else for(var h=o.getAllWordsWithRange(),f=Math.min(1e3,h.length),m=0;m<f;m++)h[m].text===s&&g.push({range:h[m].range,kind:a.DocumentHighlightKind.Read});return r.TPromise.as(g)},e._stripQuotes=function(e){return e.replace(/^'([^']+)'$/,function(e,t){return t}).replace(/^"([^"]+)"$/,function(e,t){return t})},e._getWorkspaceUrl=function(t,n,r){if(r=e._stripQuotes(r),/^\s*javascript\:/i.test(r)||/^\s*\#/i.test(r))return null;if(/^\s*https?:\/\//i.test(r)||/^\s*file:\/\//i.test(r))return r.replace(/^\s*/g,"");if(/^\s*\/\//i.test(r)){var o=s.Schemas.http;return t.scheme===s.Schemas.https&&(o=s.Schemas.https),o+":"+r.replace(/^\s*/g,"")}var i=h.dirname(t.path),a=null;r.length>0&&"/"===r.charAt(0)?a=r:(a=h.join(i,r),a=a.replace(/^(\/\.\.)+/,""));var c=t["with"]({path:a}).toString(),u=n?n.toString():null;if(u&&g.startsWith(t.toString(),u)){var l=g.commonPrefixLength(u,c);return g.endsWith(u,"/")&&(l=c.lastIndexOf("/",l)+1),u+c.substr(l)}return c},e.prototype.createLink=function(t,n,r,o,i,s){var a=e._getWorkspaceUrl(t,n,r);return a?{range:{startLineNumber:o,startColumn:i,endLineNumber:o,endColumn:s},url:a}:null},e.prototype._computeHTMLLinks=function(e,t){var r,o,i,s,a,g,c,u,p,T,h=e.getLineCount(),f=[],d=m.LOOKING_FOR_HREF_OR_SRC,_=e.uri,v=null;if(t){var k=String(t);v="/"===k.charAt(k.length-1)?n["default"].parse(k):n["default"].parse(k+"/")}for(r=1;r<=h;r++)for(o=e.getLineContent(r),i=o.length,s=e.getLineTokens(r),c=0,g=s.getTokenCount();c<g;c++)switch(a=s.getTokenType(c)){case l.DELIM_ASSIGN:case"":break;case l.ATTRIB_NAME:u=s.getTokenEndIndex(c,i),p=o.substring(s.getTokenStartIndex(c),u).toLowerCase(),d="src"===p||"href"===p?m.AFTER_HREF_OR_SRC:m.LOOKING_FOR_HREF_OR_SRC;break;case l.ATTRIB_VALUE:d===m.AFTER_HREF_OR_SRC&&(u=s.getTokenEndIndex(c,i),p=o.substring(s.getTokenStartIndex(c),u),T=this.createLink(_,v,p,r,s.getTokenStartIndex(c)+2,u),T&&f.push(T),d=m.LOOKING_FOR_HREF_OR_SRC);default:l.isTag(a)?d=m.LOOKING_FOR_HREF_OR_SRC:d===m.AFTER_HREF_OR_SRC&&(d=m.LOOKING_FOR_HREF_OR_SRC)}return f},e.prototype.provideLinks=function(e,t){var n=this.resourceService.get(e);return r.TPromise.as(this._computeHTMLLinks(n,t))},e=__decorate([__param(1,c.IResourceService)],e)}();t.HTMLWorker=d});