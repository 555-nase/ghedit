define(["require","exports","vs/base/common/keyCodes","vs/base/common/platform","vs/platform/keybinding/common/keybinding"],function(n,e,i,t,r){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";function o(n,e){return n.length<e?n+new Array(e-n.length).join(" "):n}function a(n,e){return n.weight1!==e.weight1?n.weight1-e.weight1:n.command<e.command?-1:n.command>e.command?1:n.weight2-e.weight2}var d=function(){function n(n,e,i,t){this.keybinding=n,this.command=e,this.actualCommand=this.command?this.command.replace(/^\^/,""):this.command,this.when=i,this.isDefault=t}return n.fromKeybindingItem=function(e,i){var t=null;return e.when&&(t=e.when.normalize()),new n(e.keybinding,e.command,t,i)},n}();e.NormalizedKeybindingItem=d;var u=function(){function n(e,t,r){void 0===r&&(r=!0),e=e.slice(0).sort(a),this._defaultKeybindings=e,this._shouldWarnOnConflict=r,this._defaultBoundCommands=Object.create(null);for(var o=0,d=e.length;o<d;o++)this._defaultBoundCommands[e[o].command]=!0;this._map=Object.create(null),this._lookupMap=Object.create(null),this._lookupMapUnreachable=Object.create(null),this._chords=Object.create(null);for(var u=n.combine(e,t),o=0,d=u.length;o<d;o++){var s=u[o];if(0!==s.keybinding){var c={when:s.when,keybinding:s.keybinding,commandId:s.command};if(i.BinaryKeybindings.hasChord(s.keybinding)){var h=i.BinaryKeybindings.extractFirstPart(s.keybinding),m=i.BinaryKeybindings.extractChordPart(s.keybinding);this._chords[h]=this._chords[h]||Object.create(null),this._chords[h][m]=this._chords[h][m]||[],this._chords[h][m].push(c),this._addKeyPress(h,c,s)}else this._addKeyPress(s.keybinding,c,s)}}}return n._isTargetedForRemoval=function(n,e,i,t){if(n.actualCommand!==i)return!1;if(e&&n.keybinding!==e)return!1;if(t){if(!n.when)return!1;if(!t.equals(n.when))return!1}return!0},n.combine=function(n,e){for(var i=n.map(function(n){return d.fromKeybindingItem(n,!0)}),t=[],r=0,o=e.length;r<o;r++){var a=d.fromKeybindingItem(e[r],!1);if(a.command&&0!==a.command.length&&"-"===a.command.charAt(0))for(var u=a.command.substr(1),s=a.keybinding,c=a.when,h=i.length-1;h>=0;h--)this._isTargetedForRemoval(i[h],s,u,c)&&i.splice(h,1);else t.push(a)}return i.concat(t)},n.prototype._addKeyPress=function(e,t,r){if(!this._map[e])return this._map[e]=[t],void this._addToLookupMap(r);for(var o=this._map[e],a=o.length-1;a>=0;a--){var d=o[a];d.commandId!==r.command&&(i.BinaryKeybindings.hasChord(d.keybinding)&&i.BinaryKeybindings.hasChord(t.keybinding)&&d.keybinding!==t.keybinding||n.whenIsEntirelyIncluded(!0,d.when,r.when)&&(this._shouldWarnOnConflict&&r.isDefault&&console.warn("Conflict detected, command `"+d.commandId+"` cannot be triggered by "+i.Keybinding.toUserSettingsLabel(e)+" due to "+r.command),this._lookupMapUnreachable[d.commandId]=this._lookupMapUnreachable[d.commandId]||[],this._lookupMapUnreachable[d.commandId].push(d.keybinding)))}o.push(t),this._addToLookupMap(r)},n.whenIsEntirelyIncluded=function(n,e,i){if(n||(e=e?e.normalize():null,i=i?i.normalize():null),!i)return!0;if(!e)return!1;for(var t=e.serialize().split(" && "),r=i.serialize().split(" && "),o=Object.create(null),a=0,d=t.length;a<d;a++)o[t[a]]=!0;for(var a=0,d=r.length;a<d;a++)if(!o[r[a]])return!1;return!0},n.prototype._addToLookupMap=function(n){n.command&&(this._lookupMap[n.command]=this._lookupMap[n.command]||[],this._lookupMap[n.command].push(n))},n.prototype.getDefaultBoundCommands=function(){return this._defaultBoundCommands},n.prototype.getDefaultKeybindings=function(){var n=new s;n.writeLine("[");var e=this._defaultKeybindings.length-1;return this._defaultKeybindings.forEach(function(i,t){c.writeKeybindingItem(n,i),t!==e?n.writeLine(","):n.writeLine()}),n.writeLine("]"),n.toString()},n.prototype.lookupKeybinding=function(n){var e=this._lookupMap[n];if(!e)return[];var t=e.map(function(n){return n.keybinding}),r=this._lookupMapUnreachable[n];r&&(t=t.filter(function(n){return r.indexOf(n)===-1}));var o=[],a=t.filter(function(n){return!(o.indexOf(n)>=0)&&(o.push(n),!0)});return a.map(function(n){return new i.Keybinding(n)}).reverse()},n.prototype.resolve=function(n,e,t){var r=null;if(0!==e){var o=this._chords[e];if(!o)return null;r=o[t]}else r=this._map[t];var a=this._findCommand(n,r);return a?0===e&&i.BinaryKeybindings.hasChord(a.keybinding)?{enterChord:t,commandId:null}:{enterChord:0,commandId:a.commandId}:null},n.prototype._findCommand=function(e,i){if(!i)return null;for(var t=i.length-1;t>=0;t--){var r=i[t];if(n.contextMatchesRules(e,r.when))return r}return null},n.contextMatchesRules=function(n,e){return!e||e.evaluate(n)},n}();e.KeybindingResolver=u;var s=function(){function n(){this._lines=[],this._currentLine=""}return n.prototype.write=function(n){this._currentLine+=n},n.prototype.writeLine=function(n){void 0===n&&(n=""),this._lines.push(this._currentLine+n),this._currentLine=""},n.prototype.toString=function(){return this.writeLine(),this._lines.join("\n")},n}();e.OutputBuilder=s;var c=function(){function n(){}return n.writeKeybindingItem=function(e,i){var t=JSON.stringify(n.writeKeybinding(i.keybinding));e.write('{ "key": '+o(t+",",25)+' "command": ');var r=i.when?i.when.serialize():"",a=JSON.stringify(i.command);r.length>0?(e.write(a+","),e.writeLine(),e.write('                                     "when": "'+r+'" ')):e.write(a+" "),e.write("}")},n.readKeybindingItem=function(e,i){var t=n.readKeybinding(e.key),r=n.readKeybindingWhen(e.when);return{keybinding:t,command:e.command,when:r,weight1:1e3,weight2:i}},n.writeKeybinding=function(n,e){return void 0===e&&(e=t),i.Keybinding.toUserSettingsLabel(n,e)},n.readKeybinding=function(n,e){return void 0===e&&(e=t),i.Keybinding.fromUserSettingsLabel(n,e)},n.readKeybindingWhen=function(n){return r.KbExpr.deserialize(n)},n}();e.IOSupport=c});