define(["require","exports","vs/base/common/paths","vs/base/common/winjs.base","vs/base/common/objects","vs/base/common/errors","./model","vs/base/common/async","vs/base/common/collections","vs/platform/files/common/files","./configurationRegistry","vs/platform/platform","vs/base/common/event"],function(e,o,n,t,i,r,s,a,c,u,f,h,l){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var p=function(){function e(e,o,n){void 0===n&&(n=".vscode"),this._onDidUpdateConfiguration=new l.Emitter,this.contextService=e,this.eventService=o,this.workspaceSettingsRootFolder=n,this.workspaceFilePathToConfiguration=Object.create(null),this.cachedConfig={config:{}},this.registerListeners()}return Object.defineProperty(e.prototype,"onDidUpdateConfiguration",{get:function(){return this._onDidUpdateConfiguration.event},enumerable:!0,configurable:!0}),e.prototype.registerListeners=function(){var e=this,o=this.eventService.addListener2(u.EventType.FILE_CHANGES,function(o){return e.handleFileEvents(o)}),n=h.Registry.as(f.Extensions.Configuration).onDidRegisterConfiguration(function(){return e.onDidRegisterConfiguration()});this.callOnDispose={dispose:function(){o.dispose(),n.dispose()}}},e.prototype.initialize=function(){return this.doLoadConfiguration().then(function(){return null})},e.prototype.getConfiguration=function(e){var o=e?this.cachedConfig.config[e]:this.cachedConfig.config,n=this.cachedConfig.parseErrors;return n&&n.length>0&&(o||(o={}),o.$parseErrors=n),o},e.prototype.loadConfiguration=function(e){return this.bulkFetchFromWorkspacePromise=null,this.workspaceFilePathToConfiguration=Object.create(null),this.doLoadConfiguration(e)},e.prototype.doLoadConfiguration=function(e){var o=this,n=this.loadGlobalConfiguration();return this.loadWorkspaceConfiguration().then(function(e){var o=s.consolidate(e),t=i.mixin(i.clone(n.contents),o.contents,!0),r=[];return o.parseErrors&&(r=o.parseErrors),n.parseErrors&&r.push.apply(r,n.parseErrors),{config:t,parseErrors:r}}).then(function(n){return o.cachedConfig=n,o.getConfiguration(e)})},e.prototype.loadGlobalConfiguration=function(){return{contents:s.getDefaultValues()}},e.prototype.hasWorkspaceConfiguration=function(){return!!this.workspaceFilePathToConfiguration[".vscode/"+s.CONFIG_DEFAULT_NAME+".json"]},e.prototype.loadWorkspaceConfiguration=function(e){var o=this;return this.bulkFetchFromWorkspacePromise||(this.bulkFetchFromWorkspacePromise=this.resolveStat(this.contextService.toResource(this.workspaceSettingsRootFolder)).then(function(e){return e.isDirectory?o.resolveContents(e.children.filter(function(e){return".json"===n.extname(e.resource.fsPath)}).map(function(e){return e.resource})):t.TPromise.as([])},function(e){if(e)return[]}).then(function(e){e.forEach(function(e){return o.workspaceFilePathToConfiguration[o.contextService.toWorkspaceRelativePath(e.resource)]=t.TPromise.as(s.newConfigFile(e.value))})},r.onUnexpectedError)),this.bulkFetchFromWorkspacePromise.then(function(){return t.TPromise.join(o.workspaceFilePathToConfiguration)})},e.prototype.onDidRegisterConfiguration=function(){this.cachedConfig.config=i.mixin(i.clone(s.getDefaultValues()),this.cachedConfig.config,!0),this._onDidUpdateConfiguration.fire({config:this.cachedConfig.config})},e.prototype.handleConfigurationChange=function(){var o=this;this.reloadConfigurationScheduler||(this.reloadConfigurationScheduler=new a.RunOnceScheduler(function(){o.doLoadConfiguration().then(function(e){return o._onDidUpdateConfiguration.fire({config:e})}).done(null,r.onUnexpectedError)},e.RELOAD_CONFIGURATION_DELAY)),this.reloadConfigurationScheduler.isScheduled()||this.reloadConfigurationScheduler.schedule()},e.prototype.handleFileEvents=function(e){for(var o=e.changes,t=!1,i=0,a=o.length;i<a;i++){var f=this.contextService.toWorkspaceRelativePath(o[i].resource);if(f&&(f===this.workspaceSettingsRootFolder&&o[i].type===u.FileChangeType.DELETED&&(this.workspaceFilePathToConfiguration=Object.create(null),t=!0),".json"===n.extname(f)&&n.isEqualOrParent(f,this.workspaceSettingsRootFolder)))switch(o[i].type){case u.FileChangeType.DELETED:t=c.remove(this.workspaceFilePathToConfiguration,f);break;case u.FileChangeType.UPDATED:case u.FileChangeType.ADDED:this.workspaceFilePathToConfiguration[f]=this.resolveContent(o[i].resource).then(function(e){return s.newConfigFile(e.value)},r.onUnexpectedError),t=!0}}t&&this.handleConfigurationChange()},e.prototype.dispose=function(){this.reloadConfigurationScheduler&&this.reloadConfigurationScheduler.dispose(),this.callOnDispose.dispose(),this._onDidUpdateConfiguration.dispose()},e.RELOAD_CONFIGURATION_DELAY=50,e}();o.ConfigurationService=p});