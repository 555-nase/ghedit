define(["require","exports","vs/base/common/winjs.base","vs/base/common/marshalling","vs/base/common/errors"],function(e,r,t,n,s){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";function a(e){var r=0;return function(t,n,s){var a=String(++r),i=new u(function(){e(o.cancel(a))});return c[a]=i,e(o.request(a,t,n,s)),i}}function i(e){function r(){var r=f;f=[],e(r)}function s(e){0===f.length&&process.nextTick(r),f.push(e)}function i(e,r,n){try{return t.TPromise.as(l.handle(e,r,n))}catch(s){return t.TPromise.wrapError(s)}}var u=a(s),l=null,h=Object.create(null),f=[],_=[],d=function(){var e=_.shift();_.length>0&&process.nextTick(d);var r=n.parse(e);if(r.seq){if(!c.hasOwnProperty(r.seq))return void console.warn("Got reply to unknown seq");var t=c[r.seq];if(delete c[r.seq],r.err){var a=r.err;return r.err.$isError&&(a=new Error,a.name=r.err.name,a.message=r.err.message,a.stack=r.err.stack),void t.resolveErr(a)}return void t.resolveOk(r.res)}if(r.cancel)return void(h[r.cancel]&&h[r.cancel].cancel());if(r.err)return void console.error(r.err);var u=r.rpcId;if(!l)throw new Error("got message before big handler attached!");var f=r.req;h[f]=i(u,r.method,r.args),h[f].then(function(e){delete h[f],s(o.replyOK(f,e))},function(e){delete h[f],s(o.replyErr(f,e))})},p={callOnRemote:u,setManyHandler:function(e){l=e},handle:function(e){0===_.length&&process.nextTick(d),_=_.concat(e)}};return p}var c={},o=function(){function e(){}return e.cancel=function(e){return'{"cancel":"'+e+'"}'},e.request=function(e,r,t,s){return'{"req":"'+e+'","rpcId":"'+r+'","method":"'+t+'","args":'+n.stringify(s)+"}"},e.replyOK=function(e,r){return"undefined"==typeof r?'{"seq":"'+e+'"}':'{"seq":"'+e+'","res":'+n.stringify(r)+"}"},e.replyErr=function(e,r){return"undefined"==typeof r?'{"seq":"'+e+'","err":null}':'{"seq":"'+e+'","err":'+n.stringify(s.transformErrorForSerialization(r))+"}"},e}(),u=function(){function e(e){this._onCancel=e,this._actual=null,this._actualOk=null,this._actualErr=null,this._hasValue=!1,this._value=null,this._hasErr=!1,this._err=null,this._isCanceled=!1}return e.prototype._ensureActual=function(){var e=this;return this._actual||(this._actual=new t.TPromise(function(r,t){e._actualOk=r,e._actualErr=t},this._onCancel),this._hasValue&&this._actualOk(this._value),this._hasErr&&this._actualErr(this._err)),this._actual},e.prototype.resolveOk=function(e){this._isCanceled||this._hasErr||(this._hasValue=!0,this._value=e,this._actual&&this._actualOk(e))},e.prototype.resolveErr=function(e){this._isCanceled||this._hasValue||(this._hasErr=!0,this._err=e,this._actual&&this._actualErr(e))},e.prototype.then=function(e,r){if(!this._isCanceled)return this._ensureActual().then(e,r)},e.prototype.done=function(e,r){this._isCanceled||this._ensureActual().done(e,r)},e.prototype.cancel=function(){this._hasValue||this._hasErr||(this._isCanceled=!0,this._actual?this._actual.cancel():this._onCancel())},e}();r.create=i});