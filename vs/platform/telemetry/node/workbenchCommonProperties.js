/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","winreg","os","vs/base/common/winjs.base","vs/base/common/errors","vs/base/common/uuid","../node/machineId","../node/commonProperties"],function(e,n,t,r,o,s,i,m,c){"use strict";function u(e,n,t){return c.resolveCommonProperties(n,t).then(function(n){n["common.version.shell"]=process.versions&&process.versions.electron,n["common.version.renderer"]=process.versions&&process.versions.chrome,n["common.osVersion"]=r.release();var t=e.get("telemetry.lastSessionDate"),s=e.get("telemetry.firstSessionDate")||(new Date).toUTCString();e.store("telemetry.firstSessionDate",s),e.store("telemetry.lastSessionDate",(new Date).toUTCString()),n["common.firstSessionDate"]=s,n["common.lastSessionDate"]=t,n["common.isNewSession"]=t?"0":"1";var i=[];return i.push(a(e).then(function(e){return n["common.instanceId"]=e})),i.push(f(e).then(function(e){return n["common.machineId"]=e})),"win32"===process.platform&&(i.push(l(e).then(function(e){return n["common.sqm.userid"]=e})),i.push(h(e).then(function(e){return n["common.sqm.machineid"]=e}))),o.TPromise.join(i).then(function(){return n})})}function a(e){var n=e.get("telemetry.instanceId")||i.generateUuid();return e.store("telemetry.instanceId",n),o.TPromise.as(n)}function f(e){var n="telemetry.machineId",t=e.get(n);return t?o.TPromise.as(t):m.getMachineId().then(function(t){return e.store(n,t),t})}function l(e){var n=e.get("telemetry.sqm.userId");return n?o.TPromise.as(n):d(v,"UserId",t.HKCU).then(function(n){if(n)return e.store("telemetry.sqm.userId",n),n})}function h(e){var n=e.get("telemetry.sqm.machineId");return n?o.TPromise.as(n):d(v,"MachineId",t.HKLM).then(function(n){if(n)return e.store("telemetry.sqm.machineId",n),n})}function d(e,n,r){return new o.TPromise(function(o,i){if("win32"===process.platform)try{var m=new t({hive:r,key:e});m.get(n,function(e,n){e||!n?i(null):o(n.value)})}catch(c){s.onUnexpectedError(c),i(c)}else o(null)}).then(void 0,function(e){})}var v="\\Software\\Microsoft\\SQMClient";n.resolveWorkbenchCommonProperties=u});