/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate=this&&this.__decorate||function(e,t,i,n){var o,r=arguments.length,s=r<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,i,s):o(t,i))||s);return r>3&&s&&Object.defineProperty(t,i,s),s},__param=this&&this.__param||function(e,t){return function(i,n){t(i,n,e)}};define(["require","exports","vs/nls","vs/base/common/strings","vs/platform/instantiation/common/instantiation","vs/platform/configuration/common/configuration","vs/platform/configuration/common/configurationRegistry","vs/base/common/winjs.base","vs/base/common/lifecycle","vs/base/common/timer","vs/base/common/objects","vs/platform/platform"],function(e,t,i,n,o,r,s,a,p,c,u,l){"use strict";var f=function(){function e(e,t){var i=this;this._configurationService=t,this._disposables=[],this._cleanupPatterns=[],this._appender=e.appender,this._commonProperties=e.commonProperties||a.TPromise.as({}),this._piiPaths=e.piiPaths||[],this._userOptIn="undefined"==typeof e.userOptIn||e.userOptIn;for(var o=0,r=this._piiPaths;o<r.length;o++){var s=r[o];this._cleanupPatterns.push([new RegExp(n.escapeRegExpCharacters(s),"gi"),""])}this._cleanupPatterns.push([/file:\/\/\/.*?\/resources\/app\//gi,""],[/file:\/\/\/.*/gi,""],[/ENOENT: no such file or directory.*?\'([^\']+)\'/gi,"ENOENT: no such file or directory"]),this._timeKeeper=new c.TimeKeeper,this._disposables.push(this._timeKeeper),this._disposables.push(this._timeKeeper.addListener(function(e){return i._onTelemetryTimerEventStop(e)})),this._configurationService&&(this._updateUserOptIn(),this._configurationService.onDidUpdateConfiguration(this._updateUserOptIn,this,this._disposables),this.publicLog("optInStatus",{optIn:this._userOptIn}))}return e.prototype._updateUserOptIn=function(){var e=this._configurationService.getConfiguration(m);this._userOptIn=e?e.enableTelemetry:this._userOptIn},e.prototype._onTelemetryTimerEventStop=function(e){for(var t=0;t<e.length;t++){var i=e[t],n=i.data||{};n.duration=i.timeTaken(),this.publicLog(i.name,n)}},Object.defineProperty(e.prototype,"isOptedIn",{get:function(){return this._userOptIn},enumerable:!0,configurable:!0}),e.prototype.getTelemetryInfo=function(){return this._commonProperties.then(function(e){var t=e.sessionID,i=e["common.instanceId"],n=e["common.machineId"];return{sessionId:t,instanceId:i,machineId:n}})},e.prototype.dispose=function(){this._disposables=p.dispose(this._disposables)},e.prototype.timedPublicLog=function(e,t){var i="public",n=this._timeKeeper.start(i,e);return t&&(n.data=t),n},e.prototype.publicLog=function(e,t){var i=this;return this._userOptIn||"optInStatus"===e?this._commonProperties.then(function(n){t=u.mixin(t,n),t=u.cloneAndChange(t,function(e){if("string"==typeof e)return i._cleanupInfo(e)}),i._appender.log(e,t)},function(e){console.error(e)}):a.TPromise.as(void 0)},e.prototype._cleanupInfo=function(e){for(var t=0,i=this._cleanupPatterns;t<i.length;t++){var n=i[t],o=n[0],r=n[1];e=e.replace(o,r)}return e},e.IDLE_START_EVENT_NAME="UserIdleStart",e.IDLE_STOP_EVENT_NAME="UserIdleStop",e=__decorate([__param(1,o.optional(r.IConfigurationService))],e)}();t.TelemetryService=f;var m="telemetry";l.Registry.as(s.Extensions.Configuration).registerConfiguration({id:m,order:110,type:"object",title:i.localize("telemetryConfigurationTitle","Telemetry"),properties:{"telemetry.enableTelemetry":{type:"boolean",description:i.localize("telemetry.enableTelemetry","Enable usage data and errors to be sent to Microsoft."),"default":!0}}})});