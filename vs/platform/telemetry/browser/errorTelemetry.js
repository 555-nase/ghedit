/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","vs/base/common/arrays","vs/base/common/platform","vs/base/common/lifecycle","vs/base/common/errors","vs/base/common/objects"],function(e,s,t,r,o,a,n){"use strict";var i;!function(e){function s(e,s){return e.stack<s.stack?-1:e.stack>s.stack?1:0}e.compare=s}(i||(i={}));var u=function(){function e(s,t){var n=this;void 0===t&&(t=e.ERROR_FLUSH_TIMEOUT),this._flushHandle=-1,this._buffer=[],this._disposables=[],this._telemetryService=s,this._flushDelay=t;var i=a.errorHandler.addListener(function(e){return n._onErrorEvent(e)});this._disposables.push(o.toDisposable(i));var u,f=this;"function"==typeof r.globals.onerror&&(u=r.globals.onerror),r.globals.onerror=function(e,s,t,r,o){f._onUncaughtError(e,s,t,r,o),u&&u.apply(this,arguments)},this._disposables.push(o.toDisposable(function(){u&&(r.globals.onerror=u)}))}return e.prototype.dispose=function(){clearTimeout(this._flushHandle),this._flushBuffer(),this._disposables=o.dispose(this._disposables)},e.prototype._onErrorEvent=function(e){if(e){e.detail&&e.detail.stack&&(e=e.detail);var s=Array.isArray(e.stack)?e.stack.join("\n"):e.stack,t=e.message?e.message:n.safeStringify(e);s&&this._enqueue({message:t,stack:s})}},e.prototype._onUncaughtError=function(e,s,t,r,o){var a={stack:e,message:e,filename:s,line:t,column:r};if(o){var n=o.name,i=o.message,u=o.stack;a.error={name:n,message:i},u&&(a.stack=Array.isArray(o.stack)?o.stack=o.stack.join("\n"):o.stack)}this._enqueue(a)},e.prototype._enqueue=function(e){var s=this,r=t.binarySearch(this._buffer,e,i.compare);r<0?(e.count=1,this._buffer.splice(~r,0,e)):this._buffer[r].count+=1,this._flushHandle===-1&&(this._flushHandle=setTimeout(function(){s._flushBuffer(),s._flushHandle=-1},this._flushDelay))},e.prototype._flushBuffer=function(){for(var e=0,s=this._buffer;e<s.length;e++){var t=s[e];this._telemetryService.publicLog("UnhandledError",t)}this._buffer.length=0},e.ERROR_FLUSH_TIMEOUT=5e3,e}();Object.defineProperty(s,"__esModule",{value:!0}),s["default"]=u});