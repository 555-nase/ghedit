/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate=this&&this.__decorate||function(e,t,r,n){var i,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(s<3?i(a):s>3?i(t,r,a):i(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a},__param=this&&this.__param||function(e,t){return function(r,n){t(r,n,e)}};define(["require","exports","vs/base/common/winjs.base","vs/platform/extensionManagement/common/extensionManagement","vs/base/common/types","vs/base/common/objects","vs/platform/request/common/request","vs/platform/telemetry/common/telemetry","vs/platform/package","vs/platform/product"],function(e,t,r,n,i,s,a,o,u,l){"use strict";function c(e,t){var r=(e||[]).filter(function(e){return e.statisticName===t})[0];return r?r.value:0}function d(e,t,r){var n=e.versions.map(function(e){return{version:e.version,date:e.lastUpdated,downloadHeaders:r,downloadUrl:e.assetUri+"/"+g.VSIX+"?install=true",manifestUrl:e.assetUri+"/"+g.Manifest,readmeUrl:e.assetUri+"/"+g.Details,iconUrl:e.assetUri+"/"+g.Icon}});return{id:e.extensionId,name:e.extensionName,displayName:e.displayName,publisherId:e.publisher.publisherId,publisher:e.publisher.publisherName,publisherDisplayName:e.publisher.displayName,description:e.shortDescription||"",installCount:c(e.statistics,"install"),rating:c(e.statistics,"averagerating"),ratingCount:c(e.statistics,"ratingcount"),versions:n}}var p;!function(e){e[e.None=0]="None",e[e.IncludeVersions=1]="IncludeVersions",e[e.IncludeFiles=2]="IncludeFiles",e[e.IncludeCategoryAndTags=4]="IncludeCategoryAndTags",e[e.IncludeSharedAccounts=8]="IncludeSharedAccounts",e[e.IncludeVersionProperties=16]="IncludeVersionProperties",e[e.ExcludeNonValidated=32]="ExcludeNonValidated",e[e.IncludeInstallationTargets=64]="IncludeInstallationTargets",e[e.IncludeAssetUri=128]="IncludeAssetUri",e[e.IncludeStatistics=256]="IncludeStatistics",e[e.IncludeLatestVersionOnly=512]="IncludeLatestVersionOnly"}(p||(p={}));var f;!function(e){e[e.Tag=1]="Tag",e[e.ExtensionId=4]="ExtensionId",e[e.Category=5]="Category",e[e.ExtensionName=7]="ExtensionName",e[e.Target=8]="Target",e[e.Featured=9]="Featured",e[e.SearchText=10]="SearchText"}(f||(f={}));var g={Icon:"Microsoft.VisualStudio.Services.Icons.Default",Details:"Microsoft.VisualStudio.Services.Content.Details",Manifest:"Microsoft.VisualStudio.Code.Manifest",VSIX:"Microsoft.VisualStudio.Services.VSIXPackage"},y=10,h={pageNumber:1,pageSize:y,sortBy:n.SortBy.NoneOrRelevance,sortOrder:n.SortOrder.Default,flags:p.None,criteria:[],assetTypes:[]},m=function(){function e(e){void 0===e&&(e=h),this.state=e}return Object.defineProperty(e.prototype,"pageNumber",{get:function(){return this.state.pageNumber},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pageSize",{get:function(){return this.state.pageSize},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sortBy",{get:function(){return this.state.sortBy},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sortOrder",{get:function(){return this.state.sortOrder},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"flags",{get:function(){return this.state.flags},enumerable:!0,configurable:!0}),e.prototype.withPage=function(t,r){return void 0===r&&(r=this.state.pageSize),new e(s.assign({},this.state,{pageNumber:t,pageSize:r}))},e.prototype.withFilter=function(t,r){var n={filterType:t};i.isUndefined(r)||(n.value=r);var a=this.state.criteria.slice();return a.push(n),new e(s.assign({},this.state,{criteria:a}))},e.prototype.withSortBy=function(t){return new e(s.assign({},this.state,{sortBy:t}))},e.prototype.withSortOrder=function(t){return new e(s.assign({},this.state,{sortOrder:t}))},e.prototype.withFlags=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];return new e(s.assign({},this.state,{flags:t.reduce(function(e,t){return e|t},0)}))},e.prototype.withAssetTypes=function(){for(var t=[],r=0;r<arguments.length;r++)t[r-0]=arguments[r];return new e(s.assign({},this.state,{assetTypes:t}))},Object.defineProperty(e.prototype,"raw",{get:function(){var e=this.state,t=e.criteria,r=e.pageNumber,n=e.pageSize,i=e.sortBy,s=e.sortOrder,a=e.flags,o=e.assetTypes,u=[{criteria:t,pageNumber:r,pageSize:n,sortBy:i,sortOrder:s}];return{filters:u,assetTypes:o,flags:a}},enumerable:!0,configurable:!0}),e}(),v=function(){function e(e,t){this.requestService=e,this.telemetryService=t;var r=l["default"].extensionsGallery;this.extensionsGalleryUrl=r&&r.serviceUrl,this.machineId=t.getTelemetryInfo().then(function(e){var t=e.machineId;return t})}return e.prototype.api=function(e){return void 0===e&&(e=""),""+this.extensionsGalleryUrl+e},e.prototype.isEnabled=function(){return!!this.extensionsGalleryUrl},e.prototype.query=function(e){var t=this;if(void 0===e&&(e={}),!this.isEnabled())return r.TPromise.wrapError(new Error("No extension gallery service configured."));var i=e.names?"ids":e.text?"text":"all",a=e.text||"",o=s.getOrDefault(e,function(e){return e.pageSize},50);this.telemetryService.publicLog("galleryService:query",{type:i,text:a});var u=(new m).withFlags(p.IncludeVersions,p.IncludeCategoryAndTags,p.IncludeAssetUri,p.IncludeStatistics).withPage(1,o).withFilter(f.Target,"Microsoft.VisualStudio.Code");return u=a?u.withFilter(f.SearchText,a).withSortBy(n.SortBy.NoneOrRelevance):e.ids?e.ids.reduce(function(e,t){return e.withFilter(f.ExtensionId,t)},u):e.names?e.names.reduce(function(e,t){return e.withFilter(f.ExtensionName,t)},u):u.withSortBy(n.SortBy.InstallCount),"number"==typeof e.sortBy&&(u=u.withSortBy(e.sortBy)),"number"==typeof e.sortOrder&&(u=u.withSortOrder(e.sortOrder)),this.queryGallery(u).then(function(e){var r=e.galleryExtensions,n=e.total;return t.getRequestHeaders().then(function(e){var i=r.map(function(r){return d(r,t.extensionsGalleryUrl,e)}),s=u.pageSize,a=function(r){return t.queryGallery(u.withPage(r+1)).then(function(r){var n=r.galleryExtensions;return n.map(function(r){return d(r,t.extensionsGalleryUrl,e)})})};return{firstPage:i,total:n,pageSize:s,getPage:a}})})},e.prototype.queryGallery=function(e){var t=this,r=JSON.stringify(e.raw);return this.getRequestHeaders().then(function(e){e=s.assign(e,{"Content-Type":"application/json",Accept:"application/json;api-version=3.0-preview.1","Accept-Encoding":"gzip","Content-Length":r.length});var n={type:"POST",url:t.api("/extensionquery"),data:r,headers:e};return t.requestService.makeRequest(n)}).then(function(e){return JSON.parse(e.responseText).results[0]}).then(function(e){var t=e.extensions,r=e.resultMetadata&&e.resultMetadata.filter(function(e){return"ResultCount"===e.metadataType})[0],n=r&&r.metadataItems.filter(function(e){return"TotalCount"===e.name})[0].count||0;return{galleryExtensions:t,total:n}})},e.prototype.getRequestHeaders=function(){return this.machineId.then(function(e){var t={"X-Market-Client-Id":"VSCode "+u["default"].version,"User-Agent":"VSCode "+u["default"].version};return e&&(t["X-Market-User-Id"]=e),t})},e=__decorate([__param(0,a.IRequestService),__param(1,o.ITelemetryService)],e)}();t.ExtensionGalleryService=v});