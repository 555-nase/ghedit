/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate=this&&this.__decorate||function(n,t,e,i){var r,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,e):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(n,t,e,i);else for(var a=n.length-1;a>=0;a--)(r=n[a])&&(s=(o<3?r(s):o>3?r(t,e,s):r(t,e))||s);return o>3&&s&&Object.defineProperty(t,e,s),s},__param=this&&this.__param||function(n,t){return function(e,i){t(e,i,n)}};define(["require","exports","vs/nls","os","path","vs/base/common/types","vs/base/node/pfs","vs/base/common/objects","vs/base/common/lifecycle","vs/base/common/arrays","vs/base/node/zip","vs/base/common/winjs.base","vs/base/node/request","vs/base/node/proxy","vs/platform/environment/common/environment","vs/base/common/async","vs/base/common/event","vs/base/node/userSettings","semver","vs/base/common/collections","vs/platform/extensions/node/extensionValidator","vs/platform/package"],function(n,t,e,i,r,o,s,a,u,l,f,c,h,m,d,p,v,x,E,b,g,y){"use strict";function P(n){return new c.Promise(function(t,i){try{var r=JSON.parse(n),o=r.__metadata||null;delete r.__metadata,t({manifest:r,metadata:o})}catch(s){i(new Error(e.localize("invalidManifest","Extension invalid: package.json is not a JSON file.")))}})}function _(n,t,i){return f.buffer(n,"extension/package.json").then(function(n){return P(n.toString("utf8"))}).then(function(n){var r=n.manifest;if(t){if(t.name!==r.name)return c.Promise.wrapError(Error(e.localize("invalidName","Extension invalid: manifest name mismatch.")));if(t.publisher!==r.publisher)return c.Promise.wrapError(Error(e.localize("invalidPublisher","Extension invalid: manifest publisher mismatch.")));if(i!==r.version)return c.Promise.wrapError(Error(e.localize("invalidVersion","Extension invalid: manifest version mismatch.")))}return c.TPromise.as(r)})}function w(n,t){return n.publisher+"."+n.name+"-"+t}var O=function(){function n(n){this.environmentService=n,this._onInstallExtension=new v.Emitter,this.onInstallExtension=this._onInstallExtension.event,this._onDidInstallExtension=new v.Emitter,this.onDidInstallExtension=this._onDidInstallExtension.event,this._onUninstallExtension=new v.Emitter,this.onUninstallExtension=this._onUninstallExtension.event,this._onDidUninstallExtension=new v.Emitter,this.onDidUninstallExtension=this._onDidUninstallExtension.event,this.extensionsPath=n.extensionsPath,this.obsoletePath=r.join(this.extensionsPath,".obsolete"),this.obsoleteFileLimiter=new p.Limiter(1)}return n.prototype.install=function(n){var t,i,r=this;if(o.isString(n)){var s=n;i=_(s).then(function(n){return t=w(n,n.version),r._onInstallExtension.fire({id:t}),r.installValidExtension(s,t)})}else{var a=n;t=w(a,a.versions[0].version),this._onInstallExtension.fire({id:t,gallery:a}),i=this.isObsolete(t).then(function(t){return t?c.TPromise.wrapError(new Error(e.localize("restartCode","Please restart Code before reinstalling {0}.",a.displayName||a.name))):r.installFromGallery(n)})}return i.then(function(n){return r._onDidInstallExtension.fire({id:t,local:n})},function(n){return r._onDidInstallExtension.fire({id:t,error:n}),c.TPromise.wrapError(n)})},n.prototype.installFromGallery=function(n){var t=this;return this.getLastValidExtensionVersion(n).then(function(e){var o=e.version,s=e.downloadUrl,u=e.downloadHeaders,l=r.join(i.tmpdir(),n.id),f=w(n,o),c={id:n.id,publisherId:n.publisherId,publisherDisplayName:n.publisherDisplayName};return t.request(s).then(function(n){return a.assign(n,{headers:u})}).then(function(n){return h.download(l,n)}).then(function(){return _(l,n,o)}).then(function(){return t.installValidExtension(l,f,c)})})},n.prototype.getLastValidExtensionVersion=function(n){return this._getLastValidExtensionVersion(n,n.versions)},n.prototype._getLastValidExtensionVersion=function(n,t){var i=this;if(!t.length)return c.TPromise.wrapError(new Error(e.localize("noCompatible","Couldn't find a compatible version of {0} with this version of Code.",n.displayName||n.name)));var r={"accept-encoding":"gzip"},o=t[0];return this.request(o.manifestUrl).then(function(n){return a.assign(n,{headers:r})}).then(function(n){return h.json(n)}).then(function(e){var r={isBuiltin:!1,engines:{vscode:e.engines.vscode},main:e.main};return g.isValidExtensionVersion(y["default"].version,r,[])?o:i._getLastValidExtensionVersion(n,t.slice(1))})},n.prototype.installValidExtension=function(n,t,e){void 0===e&&(e=null);var i=r.join(this.extensionsPath,t),o=r.join(i,"package.json");return f.extract(n,i,{sourcePath:"extension",overwrite:!0}).then(function(){return s.readFile(o,"utf8")}).then(function(n){return P(n)}).then(function(n){var r=n.manifest;return s.readdir(i).then(function(n){var u=n.filter(function(n){return/^readme(\.txt|\.md|)$/i.test(n)})[0],l=u?"file://"+i+"/"+u:null,f={id:t,manifest:r,metadata:e,path:i,readmeUrl:l},c=a.assign(r,{__metadata:e});return s.writeFile(o,JSON.stringify(c,null,"\t")).then(function(){return f})})})},n.prototype.uninstall=function(n){var t=this,i=n.id,o=r.join(this.extensionsPath,i);return s.exists(o).then(function(n){return n?null:c.Promise.wrapError(new Error(e.localize("notExists","Could not find extension")))}).then(function(){return t._onUninstallExtension.fire(i)}).then(function(){return t.setObsolete(i)}).then(function(){return s.rimraf(o)}).then(function(){return t.unsetObsolete(i)}).then(function(){return t._onDidUninstallExtension.fire(i)})},n.prototype.getInstalled=function(n){void 0===n&&(n=!1);var t=this.getAllInstalled();return n?t:t.then(function(n){var t=b.values(b.groupBy(n,function(n){return n.manifest.publisher+"."+n.manifest.name}));return t.map(function(n){return n.sort(function(n,t){return E.rcompare(n.manifest.version,t.manifest.version)})[0]})})},n.prototype.getAllInstalled=function(){var n=this,t=new p.Limiter(10);return this.getObsoleteExtensions().then(function(e){return s.readdir(n.extensionsPath).then(function(n){return n.filter(function(n){return!e[n]})}).then(function(e){return c.Promise.join(e.map(function(e){var i=r.join(n.extensionsPath,e),o=function(){return s.readdir(i).then(function(n){var t=n.filter(function(n){return/^readme(\.txt|\.md|)$/i.test(n)})[0],o=t?"file://"+i+"/"+t:null;return s.readFile(r.join(i,"package.json"),"utf8").then(function(n){return P(n)}).then(function(n){var t=n.manifest,r=n.metadata;return{id:e,manifest:t,metadata:r,path:i,readmeUrl:o}})}).then(null,function(){return null})};return t.queue(o)}))}).then(function(n){return n.filter(function(n){return!!n})})})},n.prototype.removeDeprecatedExtensions=function(){var n=this,t=this.getOutdatedExtensionIds().then(function(n){return n.map(function(n){return w(n.manifest,n.manifest.version)})}),e=this.getObsoleteExtensions().then(function(n){return Object.keys(n)});return c.TPromise.join([t,e]).then(function(n){return l.flatten(n)}).then(function(t){return c.TPromise.join(t.map(function(t){return s.rimraf(r.join(n.extensionsPath,t)).then(function(){return n.withObsoleteExtensions(function(n){return delete n[t]})})}))})},n.prototype.getOutdatedExtensionIds=function(){return this.getAllInstalled().then(function(n){return b.values(b.groupBy(n,function(n){return n.manifest.publisher+"."+n.manifest.name}))}).then(function(n){return l.flatten(n.map(function(n){return n.sort(function(n,t){return E.rcompare(n.manifest.version,t.manifest.version)}).slice(1)}))})},n.prototype.isObsolete=function(n){return this.withObsoleteExtensions(function(t){return!!t[n]})},n.prototype.setObsolete=function(n){return this.withObsoleteExtensions(function(t){return a.assign(t,(e={},e[n]=!0,e));var e})},n.prototype.unsetObsolete=function(n){return this.withObsoleteExtensions(function(t){return delete t[n]})},n.prototype.getObsoleteExtensions=function(){return this.withObsoleteExtensions(function(n){return n})},n.prototype.withObsoleteExtensions=function(n){var t=this;return this.obsoleteFileLimiter.queue(function(){var e=null;return s.readFile(t.obsoletePath,"utf8").then(null,function(n){return"ENOENT"===n.code?c.TPromise.as("{}"):c.TPromise.wrapError(n)}).then(function(n){return JSON.parse(n)}).then(function(t){return e=n(t),t}).then(function(n){if(0===Object.keys(n).length)return s.rimraf(t.obsoletePath);var e=JSON.stringify(n);return s.writeFile(t.obsoletePath,e)}).then(function(){return e})})},n.prototype.request=function(n){var t=c.TPromise.join([x.UserSettings.getValue(this.environmentService.userDataPath,"http.proxy"),x.UserSettings.getValue(this.environmentService.userDataPath,"http.proxyStrictSSL")]);return t.then(function(t){var e=t[0],i=t[1],r=m.getProxyAgent(n,{proxyUrl:e,strictSSL:i});return{url:n,agent:r,strictSSL:i}})},n.prototype.dispose=function(){this.disposables=u.dispose(this.disposables)},n=__decorate([__param(0,d.IEnvironmentService)],n)}();t.ExtensionManagementService=O});