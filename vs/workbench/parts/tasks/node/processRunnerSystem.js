var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)};define(["require","exports","vs/nls","vs/base/common/objects","vs/base/common/types","vs/base/common/platform","vs/base/common/winjs.base","vs/base/common/async","vs/base/common/severity","vs/base/common/strings","vs/base/common/eventEmitter","vs/base/node/processes","vs/workbench/parts/tasks/common/problemCollectors","vs/workbench/parts/tasks/common/taskSystem","./processRunnerConfiguration","vs/base/common/lifecycle"],function(e,t,r,s,i,n,o,a,u,c,l,h,d,p,m,f){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var v=function(e){function t(t,r,s,i,n,o,a,u){void 0===u&&(u=!0),e.call(this),this.fileConfig=t,this.variables=r,this.markerService=s,this.modelService=i,this.outputService=o,this.telemetryService=n,this.defaultBuildTaskIdentifier=null,this.defaultTestTaskIdentifier=null,this.childProcess=null,this.activeTaskIdentifier=null,this.outputChannel=this.outputService.getChannel(a),u&&this.clearOutput(),this.errorsShown=!1;var c=m.parse(t,this);this.validationStatus=c.validationStatus,this.configuration=c.configuration,this.defaultBuildTaskIdentifier=c.defaultBuildTaskIdentifier,this.defaultTestTaskIdentifier=c.defaultTestTaskIdentifier,this.validationStatus.isOK()||this.showOutput()}return __extends(t,e),t.prototype.build=function(){if(!this.defaultBuildTaskIdentifier)throw new p.TaskError(u["default"].Info,r.localize("TaskRunnerSystem.noBuildTask","No build task configured."),p.TaskErrors.NoBuildTask);return this.executeTask(this.defaultBuildTaskIdentifier,p.Triggers.shortcut)},t.prototype.rebuild=function(){throw new Error("Task - Rebuild: not implemented yet")},t.prototype.clean=function(){throw new Error("Task - Clean: not implemented yet")},t.prototype.runTest=function(){if(!this.defaultTestTaskIdentifier)throw new p.TaskError(u["default"].Info,r.localize("TaskRunnerSystem.noTestTask","No test task configured."),p.TaskErrors.NoTestTask);return this.executeTask(this.defaultTestTaskIdentifier,p.Triggers.shortcut)},t.prototype.run=function(e){return this.executeTask(e)},t.prototype.isActive=function(){return o.TPromise.as(!!this.childProcess)},t.prototype.isActiveSync=function(){return!!this.childProcess},t.prototype.canAutoTerminate=function(){if(this.childProcess){if(this.activeTaskIdentifier){var e=this.configuration.tasks[this.activeTaskIdentifier];if(e)return!e.promptOnClose}return!1}return!0},t.prototype.terminate=function(){return this.childProcess?this.childProcess.terminate():o.TPromise.as({success:!0})},t.prototype.tasks=function(){var e,t=this;return e=this.configuration&&this.configuration.tasks?Object.keys(this.configuration.tasks).map(function(e){return t.configuration.tasks[e]}):[],o.TPromise.as(e)},t.prototype.executeTask=function(e,s){var i=this;if(void 0===s&&(s=p.Triggers.command),this.validationStatus.isFatal())throw new p.TaskError(u["default"].Error,r.localize("TaskRunnerSystem.fatalError","The provided task configuration has validation errors. See tasks output log for details."),p.TaskErrors.ConfigValidationError);var n=this.configuration.tasks[e];if(!n)throw new p.TaskError(u["default"].Info,r.localize("TaskRunnerSystem.norebuild","No task to execute found."),p.TaskErrors.TaskNotFound);var a={trigger:s,command:"other",success:!0};try{var c=this.doExecuteTask(n,a);return c.promise=c.promise.then(function(e){return i.telemetryService.publicLog(t.TelemetryEventName,a),e},function(e){return a.success=!1,i.telemetryService.publicLog(t.TelemetryEventName,a),o.TPromise.wrapError(e)}),c}catch(l){if(a.success=!1,this.telemetryService.publicLog(t.TelemetryEventName,a),l instanceof p.TaskError)throw l;if(l instanceof Error){var h=l;throw this.outputChannel.append(h.message),new p.TaskError(u["default"].Error,h.message,p.TaskErrors.UnknownError)}throw this.outputChannel.append(l.toString()),new p.TaskError(u["default"].Error,r.localize("TaskRunnerSystem.unknownError","A unknown error has occurred while executing a task. See task output log for details."),p.TaskErrors.UnknownError)}},t.prototype.doExecuteTask=function(e,t){var s=this,i={},o=this.configuration;this.validationStatus.isOK()||this.errorsShown?this.clearOutput():(this.showOutput(),this.errorsShown=!0);var u=this.configuration.args?this.configuration.args.slice():[];e.suppressTaskName||(this.fileConfig.taskSelector?u.push(this.fileConfig.taskSelector+e.name):u.push(e.name)),e.args&&(u=u.concat(e.args)),u=this.resolveVariables(u);var l=this.resolveVariable(o.command);if(this.childProcess=new h.LineProcess(l,u,o.isShellCommand,this.resolveOptions(o.options)),t.command=this.childProcess.getSanitizedCommand(),(e.showOutput===p.ShowOutput.Always||e.showOutput===p.ShowOutput.Silent&&0===e.problemMatchers.length)&&this.showOutput(),e.echoCommand){var m=n.isWindows?">":"$";this.log("running command"+m+" "+l+" "+u.join(" "))}if(e.isWatching){var v=new d.WatchingProblemCollector(this.resolveMatchers(e.problemMatchers),this.markerService,this.modelService),k=[],T={taskId:e.id,taskName:e.name,type:p.TaskType.Watching},g=0;k.push(v.addListener2(d.ProblemCollectorEvents.WatchingBeginDetected,function(){g++,s.emit(p.TaskSystemEvents.Active,T)})),k.push(v.addListener2(d.ProblemCollectorEvents.WatchingEndDetected,function(){g--,s.emit(p.TaskSystemEvents.Inactive,T)})),v.aboutToStart();var y=null;this.activeTaskIdentifier=e.id;var w=this.childProcess.start().then(function(t){s.childProcessEnded(),v.dispose(),k=f.dispose(k),k=null;for(var n=0;n<g;n++)s.emit(p.TaskSystemEvents.Inactive,T);return g=0,s.checkTerminated(e,t)||s.log(r.localize("TaskRunnerSystem.watchingBuildTaskFinished","\nWatching build tasks has finished.")),t.cmdCode&&1===t.cmdCode&&0===v.numberOfMatches&&e.showOutput!==p.ShowOutput.Never&&s.showOutput(),i.exitCode=t.cmdCode,i},function(t){s.childProcessEnded(),v.dispose(),k=f.dispose(k),k=null;for(var r=0;r<g;r++)s.emit(p.TaskSystemEvents.Inactive,T);return g=0,s.handleError(e,t)},function(e){var t=c.removeAnsiEscapeCodes(e.line);s.outputChannel.append(t+"\n"),v.processLine(t),null===y&&(y=new a.Delayer(3e3)),y.trigger(function(){return v.forceDelivery(),null}).then(function(){y=null})}),E=e.tscWatch?{restartOnFileChanges:"**/*.ts",promise:w}:{promise:w};return E}var S={taskId:e.id,taskName:e.name,type:p.TaskType.SingleRun};this.emit(p.TaskSystemEvents.Active,S);var b=new d.StartStopProblemCollector(this.resolveMatchers(e.problemMatchers),this.markerService,this.modelService);this.activeTaskIdentifier=e.id;var w=this.childProcess.start().then(function(t){return s.childProcessEnded(),b.done(),b.dispose(),s.checkTerminated(e,t),s.emit(p.TaskSystemEvents.Inactive,S),t.cmdCode&&1===t.cmdCode&&0===b.numberOfMatches&&e.showOutput!==p.ShowOutput.Never&&s.showOutput(),i.exitCode=t.cmdCode,i},function(t){return s.childProcessEnded(),b.dispose(),s.emit(p.TaskSystemEvents.Inactive,S),s.handleError(e,t)},function(e){var t=c.removeAnsiEscapeCodes(e.line);s.outputChannel.append(t+"\n"),b.processLine(t)});return{promise:w}},t.prototype.childProcessEnded=function(){this.childProcess=null,this.activeTaskIdentifier=null},t.prototype.handleError=function(e,t){var s=!1;if(t.error&&!t.terminated){var i=this.configuration.args?this.configuration.args.join(" "):"";this.log(r.localize("TaskRunnerSystem.childProcessError","Failed to launch external program {0} {1}.",this.configuration.command,i)),this.outputChannel.append(t.error.message),s=!0}return t.stdout&&(this.outputChannel.append(t.stdout),s=!0),t.stderr&&(this.outputChannel.append(t.stderr),s=!0),s=this.checkTerminated(e,t)||s,s&&this.showOutput(),o.Promise.wrapError(t)},t.prototype.checkTerminated=function(e,t){return!!t.terminated&&(this.log(r.localize("TaskRunnerSystem.cancelRequested","\nThe task '{0}' was terminated per user request.",e.name)),!0)},t.prototype.resolveOptions=function(e){var t=this,r={cwd:this.resolveVariable(e.cwd)};return e.env&&(r.env=Object.create(null),Object.keys(e.env).forEach(function(s){var n=e.env[s];i.isString(n)?r.env[s]=t.resolveVariable(n):r.env[s]=n.toString()})),r},t.prototype.resolveVariables=function(e){var t=this;return e.map(function(e){return t.resolveVariable(e)})},t.prototype.resolveMatchers=function(e){var t=this;if(0===e.length)return e;var r=[];return e.forEach(function(e){if(e.filePrefix){var i=s.clone(e);i.filePrefix=t.resolveVariable(i.filePrefix),r.push(i)}else r.push(e)}),r},t.prototype.resolveVariable=function(e){return this.variables.resolve(e)},t.prototype.log=function(e){this.outputChannel.append(e+"\n")},t.prototype.showOutput=function(){this.outputChannel.show(!0)},t.prototype.clearOutput=function(){this.outputChannel.clear()},t.TelemetryEventName="taskService",t}(l.EventEmitter);t.ProcessRunnerSystem=v});