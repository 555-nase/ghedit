var __extends=this&&this.__extends||function(e,r){function t(){this.constructor=e}for(var n in r)r.hasOwnProperty(n)&&(e[n]=r[n]);e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)};define(["require","exports","vs/base/common/eventEmitter","vs/platform/markers/common/problemMatcher"],function(e,r,t,n){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var s;!function(e){e.WatchingBeginDetected="watchingBeginDetected",e.WatchingEndDetected="watchingEndDetected"}(s=r.ProblemCollectorEvents||(r.ProblemCollectorEvents={}));var o=function(e){function r(r,t){var s=this;e.call(this),this.modelService=t,this.matchers=Object.create(null),this.bufferLength=1,r.map(function(e){return n.createLineMatcher(e)}).forEach(function(e){var r=e.matchLength;r>s.bufferLength&&(s.bufferLength=r);var t=s.matchers[r];t||(t=[],s.matchers[r]=t),t.push(e)}),this.buffer=[],this.activeMatcher=null,this.openModels=Object.create(null),this.modelListeners=[],this.modelService.onModelAdded(function(e){s.openModels[e.uri.toString()]=!0},this,this.modelListeners),this.modelService.onModelRemoved(function(e){delete s.openModels[e.uri.toString()]},this,this.modelListeners),this.modelService.getModels().forEach(function(e){return s.openModels[e.uri.toString()]=!0})}return __extends(r,e),r.prototype.dispose=function(){this.modelListeners.forEach(function(e){return e.dispose()})},Object.defineProperty(r.prototype,"numberOfMatches",{get:function(){return this._numberOfMatches},enumerable:!0,configurable:!0}),r.prototype.tryFindMarker=function(e){var r=null;if(this.activeMatcher){if(r=this.activeMatcher.next(e))return this._numberOfMatches++,r;this.clearBuffer(),this.activeMatcher=null}if(this.buffer.length<this.bufferLength)this.buffer.push(e);else{for(var t=this.buffer.length-1,n=0;n<t;n++)this.buffer[n]=this.buffer[n+1];this.buffer[t]=e}return r=this.tryMatchers(),r&&this.clearBuffer(),r},r.prototype.isOpen=function(e){return!!this.openModels[e.toString()]},r.prototype.shouldApplyMatch=function(e){switch(e.description.applyTo){case n.ApplyToKind.allDocuments:return!0;case n.ApplyToKind.openDocuments:return this.openModels[e.resource.toString()];case n.ApplyToKind.closedDocuments:return!this.openModels[e.resource.toString()];default:return!0}},r.prototype.tryMatchers=function(){this.activeMatcher=null;for(var e=this.buffer.length,r=0;r<e;r++){var t=this.matchers[e-r];if(t)for(var n=0;n<t.length;n++){var s=t[n],o=s.handle(this.buffer,r);if(o.match)return this._numberOfMatches++,o["continue"]&&(this.activeMatcher=s),o.match}}return null},r.prototype.clearBuffer=function(){this.buffer.length>0&&(this.buffer=[])},r}(t.EventEmitter);r.AbstractProblemCollector=o,function(e){e[e.Clean=0]="Clean"}(r.ProblemHandlingStrategy||(r.ProblemHandlingStrategy={}));var i=r.ProblemHandlingStrategy,c=function(e){function r(r,t,n,s){var o=this;void 0===s&&(s=i.Clean),e.call(this,r,n),this.currentResource=null,this.currentResourceAsString=null,this.markers=Object.create(null);var c=Object.create(null);r.forEach(function(e){return c[e.owner]=!0}),this.owners=Object.keys(c),this.markerService=t,this.strategy=s,this.currentResourcesWithMarkers=Object.create(null),this.reportedResourcesWithMarkers=Object.create(null),this.owners.forEach(function(e){o.currentResourcesWithMarkers[e]=o.markerService.read({owner:e}).map(function(e){return e.resource}),o.reportedResourcesWithMarkers[e]=Object.create(null)}),this.currentResource=null,this.currentResourceAsString=null,this.markers=Object.create(null)}return __extends(r,e),r.prototype.processLine=function(e){var r=this,t=this.tryFindMarker(e);if(t){var n=t.description.owner,s=t.resource,o=s.toString(),i=this.shouldApplyMatch(t);if(i){this.currentResourceAsString!==o&&(this.currentResource&&(Object.keys(this.markers).forEach(function(e){r.markerService.changeOne(e,r.currentResource,r.markers[e])}),this.markers=Object.create(null)),this.reportedResourcesWithMarkers[n][o]=s,this.currentResource=s,this.currentResourceAsString=o);var c=this.markers[n];c||(c=[],this.markers[n]=c),c.push(t.marker)}else this.reportedResourcesWithMarkers[n][o]=s}},r.prototype.done=function(){var e=this;this.currentResource&&Object.keys(this.markers).forEach(function(r){e.markerService.changeOne(r,e.currentResource,e.markers[r])}),this.strategy===i.Clean&&Object.keys(this.currentResourcesWithMarkers).forEach(function(r){var t=[],n=e.reportedResourcesWithMarkers[r];e.currentResourcesWithMarkers[r].forEach(function(e){n[e.toString()]||t.push(e)}),e.markerService.remove(r,t)}),this.currentResource=null,this.currentResourceAsString=null,this.markers=Object.create(null)},r}(o);r.StartStopProblemCollector=c;var a=function(e){function r(r,t,n){var s=this;e.call(this,r,n),this.problemMatchers=r,this.markerService=t,this.resetCurrentResource(),this.resourcesToClean=Object.create(null),this.ignoreOpenResourcesByOwner=Object.create(null),this.watchingBeginsPatterns=[],this.watchingEndsPatterns=[],this.problemMatchers.forEach(function(e){e.watching&&(s.watchingBeginsPatterns.push({problemMatcher:e,pattern:e.watching.beginsPattern}),s.watchingEndsPatterns.push({problemMatcher:e,pattern:e.watching.endsPattern}))})}return __extends(r,e),r.prototype.aboutToStart=function(){var e=this;this.problemMatchers.forEach(function(r){r.watching&&r.watching.activeOnStart&&(e.emit(s.WatchingBeginDetected,{}),e.recordResourcesToClean(r.owner));var t=e.ignoreOpenResourcesByOwner[r.owner];if(t){var o=t&&r.applyTo===n.ApplyToKind.closedDocuments;o!==t&&(e.ignoreOpenResourcesByOwner[r.owner]=o)}else e.ignoreOpenResourcesByOwner[r.owner]=r.applyTo===n.ApplyToKind.closedDocuments})},r.prototype.processLine=function(e){if(!this.tryBegin(e)&&!this.tryFinish(e)){var r=this.tryFindMarker(e);if(r){var t=r.resource,n=r.description.owner,s=t.toString(),o=this.shouldApplyMatch(r);if(o){this.currentResourceAsString!==s&&(this.removeResourceToClean(n,s),this.currentResource&&this.deliverMarkersForCurrentResource(),this.currentResource=t,this.currentResourceAsString=s);var i=this.markers[n];i||(i=[],this.markers[n]=i),i.push(r.marker)}else this.removeResourceToClean(n,s)}}},r.prototype.forceDelivery=function(){var e=this;this.deliverMarkersForCurrentResource(!1),Object.keys(this.resourcesToClean).forEach(function(r){e.cleanMarkers(r,!1)}),this.resourcesToClean=Object.create(null)},r.prototype.tryBegin=function(e){for(var r=!1,t=0;t<this.watchingBeginsPatterns.length;t++){var o=this.watchingBeginsPatterns[t],i=o.pattern.regexp.exec(e);if(i){this.emit(s.WatchingBeginDetected,{}),r=!0;var c=o.problemMatcher.owner;if(i[1]){var a=n.getResource(i[1],o.problemMatcher);this.currentResourceAsString&&this.currentResourceAsString===a.toString()&&this.resetCurrentResource(),this.recordResourceToClean(c,a)}else this.recordResourcesToClean(c),this.resetCurrentResource()}}return r},r.prototype.tryFinish=function(e){for(var r=!1,t=0;t<this.watchingEndsPatterns.length;t++){var n=this.watchingEndsPatterns[t],o=n.pattern.regexp.exec(e);if(o){this.emit(s.WatchingEndDetected,{}),r=!0;var i=n.problemMatcher.owner;this.cleanMarkers(i),this.deliverMarkersForCurrentResource()}}return r},r.prototype.recordResourcesToClean=function(e){var r=this.getResourceSetToClean(e);this.markerService.read({owner:e}).forEach(function(e){return r[e.resource.toString()]=e.resource})},r.prototype.recordResourceToClean=function(e,r){this.getResourceSetToClean(e)[r.toString()]=r},r.prototype.removeResourceToClean=function(e,r){var t=this.resourcesToClean[e];t&&delete t[r]},r.prototype.cleanMarkers=function(e,r){var t=this;void 0===r&&(r=!0);var n=this.resourcesToClean[e];if(n){var s=Object.keys(n).map(function(e){return n[e]}).filter(function(r){return!t.ignoreOpenResourcesByOwner[e]||!t.isOpen(r)});this.markerService.remove(e,s),r&&delete this.resourcesToClean[e]}},r.prototype.deliverMarkersForCurrentResource=function(e){var r=this;void 0===e&&(e=!0),this.currentResource&&Object.keys(this.markers).forEach(function(e){r.markerService.changeOne(e,r.currentResource,r.markers[e])}),e&&this.resetCurrentResource()},r.prototype.getResourceSetToClean=function(e){var r=this.resourcesToClean[e];return r||(r=Object.create(null),this.resourcesToClean[e]=r),r},r.prototype.resetCurrentResource=function(){this.currentResource=null,this.currentResourceAsString=null,this.markers=Object.create(null)},r}(o);r.WatchingProblemCollector=a});