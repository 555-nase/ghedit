/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate=this&&this.__decorate||function(e,t,n,i){var r,l=arguments.length,a=l<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,i);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(a=(l<3?r(a):l>3?r(t,n,a):r(t,n))||a);return l>3&&a&&Object.defineProperty(t,n,a),a},__param=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}};define(["require","exports","vs/base/common/event","vs/base/common/arrays","vs/base/common/objects","vs/base/common/async","vs/base/common/winjs.base","vs/base/common/lifecycle","vs/base/common/paging","vs/platform/telemetry/common/telemetry","vs/platform/extensionManagement/common/extensionManagement","semver","path","vs/base/common/uri","./extensions","vs/css!./media/extensionsViewlet"],function(e,t,n,i,r,l,a,s,o,u,c,h,f,p,d){"use strict";function y(e){return e.replace(/-\d+\.\d+\.\d+$/,"")}function g(e){switch(e){case m.Installing:return"extensionGallery:install";case m.Updating:return"extensionGallery:update";case m.Uninstalling:return"extensionGallery:uninstall"}return""}var m,b=function(){function t(e,t,n){void 0===n&&(n=null),this.stateProvider=e,this.local=t,this.gallery=n,this.needsRestart=!1}return Object.defineProperty(t.prototype,"name",{get:function(){return this.local?this.local.manifest.name:this.gallery.name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"displayName",{get:function(){return this.local?this.local.manifest.displayName||this.local.manifest.name:this.gallery.displayName||this.gallery.name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"publisher",{get:function(){return this.local?this.local.manifest.publisher:this.gallery.publisher},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"publisherDisplayName",{get:function(){return this.local?this.local.metadata&&this.local.metadata.publisherDisplayName?this.local.metadata.publisherDisplayName:this.local.manifest.publisher:this.gallery.publisherDisplayName||this.gallery.publisher},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"version",{get:function(){return this.local?this.local.manifest.version:this.gallery.versions[0].version},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"latestVersion",{get:function(){return this.gallery?this.gallery.versions[0].version:this.local.manifest.version},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"description",{get:function(){return this.local?this.local.manifest.description:this.gallery.description},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"readmeUrl",{get:function(){return this.local&&this.local.readmeUrl?this.local.readmeUrl:this.gallery&&this.gallery.versions[0].readmeUrl?this.gallery.versions[0].readmeUrl:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"iconUrl",{get:function(){return this.local&&this.local.manifest.icon?p["default"].file(f.join(this.local.path,this.local.manifest.icon)).toString():this.gallery&&this.gallery.versions[0].iconUrl?this.gallery.versions[0].iconUrl:e.toUrl("./media/defaultIcon.png")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this.stateProvider(this)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"installCount",{get:function(){return this.gallery?this.gallery.installCount:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rating",{get:function(){return this.gallery?this.gallery.rating:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ratingCount",{get:function(){return this.gallery?this.gallery.ratingCount:null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"outdated",{get:function(){return h.gt(this.latestVersion,this.version)},enumerable:!0,configurable:!0}),t}();!function(e){e[e.Installing=0]="Installing",e[e.Updating=1]="Updating",e[e.Uninstalling=2]="Uninstalling"}(m||(m={}));var v=function(){function e(t,i,r,a){var s=this;this.extensionService=t,this.galleryService=i,this.telemetryService=r,this.tipsService=a,this.installing=[],this.uninstalling=[],this.installed=[],this.disposables=[],this._onChange=new n.Emitter,this.stateProvider=function(e){return s.getExtensionState(e)},this.disposables.push(t.onInstallExtension(function(e){var t=e.id,n=e.gallery;return s.onInstallExtension(t,n)})),this.disposables.push(t.onDidInstallExtension(function(e){var t=e.id,n=e.local,i=e.error;return s.onDidInstallExtension(t,n,i)})),this.disposables.push(t.onUninstallExtension(function(e){return s.onUninstallExtension(e)})),this.disposables.push(t.onDidUninstallExtension(function(e){return s.onDidUninstallExtension(e)})),this.syncDelayer=new l.ThrottledDelayer(e.SyncPeriod),this.queryLocal().done(function(){return s.syncWithGallery(!0)})}return Object.defineProperty(e.prototype,"onChange",{get:function(){return this._onChange.event},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"local",{get:function(){var e=this,t=this.installing.filter(function(t){return!e.installed.some(function(e){return y(e.local.id)===t.id})}).map(function(e){return e.extension});return this.installed.concat(t)},enumerable:!0,configurable:!0}),e.prototype.queryLocal=function(){var e=this;return this.extensionService.getInstalled().then(function(t){var n=i.index(e.installed,function(e){return e.local.id});return e.installed=t.map(function(t){var i=n[t.id]||new b(e.stateProvider,t);return i.local=t,i}),e._onChange.fire(),e.local})},e.prototype.queryGallery=function(e){var t=this;return void 0===e&&(e={}),this.galleryService.query(e).then(function(e){return o.mapPager(e,function(e){return t.fromGallery(e)})}).then(null,function(e){return/No extension gallery service configured/.test(e.message)?a.TPromise.as(o.singlePagePager([])):a.TPromise.wrapError(e)})},e.prototype.getRecommendations=function(){var e=this;return this.tipsService.getRecommendations().then(function(t){return t.map(function(t){return e.fromGallery(t)}).filter(function(e){return e.state===d.ExtensionState.Uninstalled})})},e.prototype.fromGallery=function(e){var t=i.index(this.installed,function(e){return e.local.metadata?e.local.metadata.id:""}),n=e.id,r=t[n];return r?(r.gallery=e,this._onChange.fire(),r):new b(this.stateProvider,null,e)},e.prototype.syncWithGallery=function(t){var n=this;void 0===t&&(t=!1);var i=function(){return n.doSyncWithGallery().then(function(){return n.syncWithGallery()})},r=t?0:e.SyncPeriod;this.syncDelayer.trigger(i,r)},e.prototype.doSyncWithGallery=function(){var e=this.installed.filter(function(e){return!(!e.local||!e.local.metadata)}).map(function(e){return e.local.metadata.id});return 0===e.length?a.TPromise.as(null):this.queryGallery({ids:e,pageSize:e.length})},e.prototype.canInstall=function(e){if(e instanceof b)return!!e.gallery},e.prototype.install=function(e){if(e instanceof b){var t=e,n=t.gallery;return n?this.extensionService.install(n):a.TPromise.wrapError(new Error("Missing gallery"))}},e.prototype.uninstall=function(e){if(e instanceof b){var t=e,n=t.local||this.installed.filter(function(e){return e.local.metadata&&t.gallery&&e.local.metadata.id===t.gallery.id})[0].local;return n?this.extensionService.uninstall(n):a.TPromise.wrapError(new Error("Missing local"))}},e.prototype.onInstallExtension=function(e,t){if(t){var n=this.installed.filter(function(e){return(e.local.metadata&&e.local.metadata.id)===t.id})[0];n||(n=new b(this.stateProvider,null,t)),n.gallery=t;var i=new Date,r=m.Uninstalling;this.installing.push({id:y(e),operation:r,extension:n,start:i}),this._onChange.fire()}},e.prototype.onDidInstallExtension=function(e,t,n){e=y(e);var i=this.installing.filter(function(t){return t.id===e})[0];if(i){var r=i.extension;r.local=t,r.needsRestart=!0;var l="extensionGallery:install";if(this.installing=this.installing.filter(function(t){return t.id!==e}),!n){var a=t.metadata&&t.metadata.id,s=this.installed.filter(function(e){return(e.local.metadata&&e.local.metadata.id)===a})[0];a&&s?(l="extensionGallery:update",s.local=t):this.installed.push(r)}this.reportTelemetry(i,!n),this._onChange.fire()}},e.prototype.onUninstallExtension=function(e){var t=this.installed.length,n=this.installed.filter(function(t){return t.local.id===e})[0];if(this.installed=this.installed.filter(function(t){return t.local.id!==e}),t!==this.installed.length){var i=new Date,r=m.Uninstalling,l=this.uninstalling.filter(function(t){return t.id===e})[0]||{id:e,operation:r,extension:n,start:i};this.uninstalling=[l].concat(this.uninstalling.filter(function(t){return t.id!==e})),this._onChange.fire()}},e.prototype.onDidUninstallExtension=function(e){var t=this.uninstalling.filter(function(t){return t.id===e})[0];this.uninstalling=this.uninstalling.filter(function(t){return t.id!==e}),t&&this.reportTelemetry(t,!0)},e.prototype.getExtensionState=function(e){if(e.gallery&&this.installing.some(function(t){return t.extension.gallery.id===e.gallery.id}))return d.ExtensionState.Installing;var t=this.installed.filter(function(t){return t===e||t.gallery&&e.gallery&&t.gallery.id===e.gallery.id})[0];return t?t.needsRestart?d.ExtensionState.NeedsRestart:d.ExtensionState.Installed:d.ExtensionState.Uninstalled},e.prototype.reportTelemetry=function(e,t){if(e.extension){var n=e.extension.local,i=e.extension.gallery,l=null;l=i?{id:i.publisher+"."+i.name,name:i.name,galleryId:i.id,publisherId:i.publisherId,publisherName:i.publisher,publisherDisplayName:i.publisherDisplayName}:{id:n.manifest.publisher+"."+n.manifest.name,name:n.manifest.name,galleryId:n.metadata?n.metadata.id:null,publisherId:n.metadata?n.metadata.publisherId:null,publisherName:n.manifest.publisher,publisherDisplayName:n.metadata?n.metadata.publisherDisplayName:null};var a=(new Date).getTime()-e.start.getTime(),s=g(e.operation);this.telemetryService.publicLog(s,r.assign(l,{success:t,duration:a}))}},e.prototype.dispose=function(){this.disposables=s.dispose(this.disposables)},e.SyncPeriod=432e5,e=__decorate([__param(0,c.IExtensionManagementService),__param(1,c.IExtensionGalleryService),__param(2,u.ITelemetryService),__param(3,c.IExtensionTipsService)],e)}();t.ExtensionsWorkbenchService=v});