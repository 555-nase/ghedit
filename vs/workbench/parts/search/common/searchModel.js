/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)},__decorate=this&&this.__decorate||function(e,t,i,r){var s,n=arguments.length,o=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,r);else for(var c=e.length-1;c>=0;c--)(s=e[c])&&(o=(n<3?s(o):n>3?s(t,i,o):s(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o},__param=this&&this.__param||function(e,t){return function(i,r){t(i,r,e)}};define(["require","exports","vs/base/common/timer","vs/base/common/paths","vs/base/common/strings","vs/base/common/errors","vs/base/common/async","vs/base/common/lifecycle","vs/base/common/map","vs/base/common/set","vs/base/common/event","vs/platform/search/common/replace","vs/platform/telemetry/common/telemetry","vs/editor/common/core/range","vs/editor/common/editorCommon","vs/platform/instantiation/common/instantiation","vs/editor/common/services/modelService","vs/platform/search/common/search","vs/workbench/parts/search/common/replace"],function(e,t,i,r,s,n,o,c,h,a,l,u,p,d,_,m,f,g,v){"use strict";var y=function(){function e(e,t,i,r,s){this._parent=e,this._lineText=t,this._range=new d.Range(1+i,1+r,1+i,1+r+s),this._id=this._parent.id()+">"+i+">"+r+this.getMatchString()}return e.prototype.id=function(){return this._id},e.prototype.parent=function(){return this._parent},e.prototype.text=function(){return this._lineText},e.prototype.range=function(){return this._range},e.prototype.preview=function(){var e=this._lineText.substring(0,this._range.startColumn-1),t=this.getMatchString(),i=this._lineText.substring(this._range.endColumn-1,Math.min(this._range.endColumn+150,this._lineText.length));return e=s.lcut(e,26),{before:e,inside:t,after:i}},Object.defineProperty(e.prototype,"replaceString",{get:function(){return this.parent().parent().searchModel.replacePattern.getReplaceString(this.getMatchString())},enumerable:!0,configurable:!0}),e.prototype.getMatchString=function(){return this._lineText.substring(this._range.startColumn-1,this._range.endColumn-1)},e}();t.Match=y;var M=function(e){function t(t,i,r,s,n){e.call(this),this._query=t,this._parent=i,this.rawMatch=r,this.modelService=s,this.replaceService=n,this._onChange=this._register(new l.Emitter),this.onChange=this._onChange.event,this._onDispose=this._register(new l.Emitter),this.onDispose=this._onDispose.event,this._modelDecorations=[],this._resource=this.rawMatch.resource,this._matches=new h.SimpleMap,this._removedMatches=new a.ArraySet,this._updateScheduler=new o.RunOnceScheduler(this.updateMatches.bind(this),250),this.createMatches(),this.registerListeners()}return __extends(t,e),t.getDecorationOption=function(e){return{stickiness:_.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges,className:e?"currentFindMatch":"findMatch",overviewRuler:{color:"rgba(246, 185, 77, 0.7)",darkColor:"rgba(246, 185, 77, 0.7)",position:_.OverviewRulerLane.Center}}},t.prototype.createMatches=function(){var e=this,t=this.modelService.getModel(this._resource);t?(this.bindModel(t),this.updateMatches()):this.rawMatch.lineMatches.forEach(function(t){t.offsetAndLengths.forEach(function(i){var r=new y(e,t.preview,t.lineNumber,i[0],i[1]);e.add(r)})})},t.prototype.registerListeners=function(){var e=this;this._register(this.modelService.onModelAdded(function(t){t.uri.toString()===e._resource.toString()&&e.bindModel(t)}))},t.prototype.bindModel=function(e){var t=this;this._model=e,this._modelListener=this._model.onDidChangeContent(function(e){t._updateScheduler.schedule()}),this._model.onWillDispose(function(){return t.onModelWillDispose()}),this.updateHighlights()},t.prototype.onModelWillDispose=function(){this.updateMatches(),this.unbindModel()},t.prototype.unbindModel=function(){this._model&&(this._updateScheduler.cancel(),this._model.deltaDecorations(this._modelDecorations,[]),this._model=null,this._modelListener.dispose())},t.prototype.updateMatches=function(){var e=this;if(this._model){this._matches=new h.SimpleMap;var t=this._model.findMatches(this._query.pattern,this._model.getFullModelRange(),this._query.isRegExp,this._query.isCaseSensitive,this._query.isWordMatch);t.forEach(function(t){var i=new y(e,e._model.getLineContent(t.startLineNumber),t.startLineNumber-1,t.startColumn-1,t.endColumn-t.startColumn);e._removedMatches.contains(i.id())||(e.add(i),e.isMatchSelected(i)&&(e._selectedMatch=i))}),this._onChange.fire(!0),this.updateHighlights()}},t.prototype.updateHighlights=function(){var e=this;this._model&&(this.parent().showHighlights?this._modelDecorations=this._model.deltaDecorations(this._modelDecorations,this.matches().map(function(i){return{range:i.range(),options:t.getDecorationOption(e.isMatchSelected(i))}})):this._modelDecorations=this._model.deltaDecorations(this._modelDecorations,[]))},t.prototype.id=function(){return this.resource().toString()},t.prototype.parent=function(){return this._parent},t.prototype.matches=function(){return this._matches.values()},t.prototype.remove=function(e){this.removeMatch(e),this._removedMatches.set(e.id()),this._onChange.fire(!1)},t.prototype.replace=function(e){var t=this;return this.replaceService.replace(e).then(function(){t.removeMatch(e),t._onChange.fire(!1)})},t.prototype.setSelectedMatch=function(e){if(e){if(!this._matches.has(e.id()))return;if(this.isMatchSelected(e))return}this._selectedMatch=e,this.updateHighlights()},t.prototype.getSelectedMatch=function(){return this._selectedMatch},t.prototype.isMatchSelected=function(e){return this._selectedMatch&&this._selectedMatch.id()===e.id()},t.prototype.count=function(){return this.matches().length},t.prototype.resource=function(){return this._resource},t.prototype.name=function(){return r.basename(this.resource().fsPath)},t.prototype.add=function(e,t){this._matches.set(e.id(),e),t&&this._onChange.fire(!0)},t.prototype.removeMatch=function(e){this._matches["delete"](e.id()),this.isMatchSelected(e)?this.setSelectedMatch(null):this.updateHighlights()},t.prototype.dispose=function(){this.setSelectedMatch(null),this.unbindModel(),this._onDispose.fire(),e.prototype.dispose.call(this)},t=__decorate([__param(3,f.IModelService),__param(4,v.IReplaceService)],t)}(c.Disposable);t.FileMatch=M;var S=function(e){function t(t,i,r,s){e.call(this),this._searchModel=t,this.replaceService=i,this.telemetryService=r,this.instantiationService=s,this._onChange=this._register(new l.Emitter),this.onChange=this._onChange.event,this._query=null,this._replacingAll=!1,this._fileMatches=new h.SimpleMap,this._unDisposedFileMatches=new h.SimpleMap}return __extends(t,e),Object.defineProperty(t.prototype,"query",{set:function(e){this._query=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"searchModel",{get:function(){return this._searchModel},enumerable:!0,configurable:!0}),t.prototype.add=function(e,t){var i=this;void 0===t&&(t=!1);var r=[];e.forEach(function(e){if(!i._fileMatches.has(e.resource)){var t=i.instantiationService.createInstance(M,i._query,i,e);i.doAdd(t),r.push(t);var s=t.onChange(function(){return i.onFileChange(t)});t.onDispose(function(){return s.dispose()})}}),t||this._onChange.fire({elements:r,added:!0})},t.prototype.clear=function(){var e=this.matches();this.disposeMatches(),this._onChange.fire({elements:e,removed:!0})},t.prototype.remove=function(e){this.doRemove(e)},t.prototype.replace=function(e){var t=this;return this.replaceService.replace([e]).then(function(){t.doRemove(e,!1,!0)})},t.prototype.replaceAll=function(e){var t=this;this._replacingAll=!0;var i=this.telemetryService.timedPublicLog("replaceAll.started");return this.replaceService.replace(this.matches(),e).then(function(){i.stop(),t._replacingAll=!1,t.clear()},function(){t._replacingAll=!1,i.stop()})},t.prototype.matches=function(){return this._fileMatches.values()},t.prototype.isEmpty=function(){return 0===this.fileCount()},t.prototype.fileCount=function(){return this._fileMatches.size},t.prototype.count=function(){return this.matches().reduce(function(e,t){return e+t.count()},0)},Object.defineProperty(t.prototype,"showHighlights",{get:function(){return this._showHighlights},enumerable:!0,configurable:!0}),t.prototype.toggleHighlights=function(e){this._showHighlights!==e&&(this._showHighlights=e,this.matches().forEach(function(e){e.updateHighlights()}))},t.prototype.onFileChange=function(e){var t=!1,i=!1;this._fileMatches.has(e.resource())||(this.doAdd(e),t=!0),0===e.count()&&(this.doRemove(e,!1,!1),t=!1,i=!0),this._replacingAll||this._onChange.fire({elements:[e],added:t,removed:i})},t.prototype.doAdd=function(e){this._fileMatches.set(e.resource(),e),this._unDisposedFileMatches.has(e.resource())&&this._unDisposedFileMatches["delete"](e.resource())},t.prototype.doRemove=function(e,t,i){void 0===t&&(t=!0),void 0===i&&(i=!0),this._fileMatches["delete"](e.resource()),t?e.dispose():this._unDisposedFileMatches.set(e.resource(),e),i&&this._onChange.fire({elements:[e],removed:!0})},t.prototype.disposeMatches=function(){this._fileMatches.values().forEach(function(e){return e.dispose()}),this._unDisposedFileMatches.values().forEach(function(e){return e.dispose()}),this._fileMatches.clear(),this._unDisposedFileMatches.clear()},t.prototype.dispose=function(){this.disposeMatches(),e.prototype.dispose.call(this)},t=__decorate([__param(1,v.IReplaceService),__param(2,p.ITelemetryService),__param(3,m.IInstantiationService)],t)}(c.Disposable);t.SearchResult=S;var b=function(e){function t(t,i,r){e.call(this),this.searchService=t,this.telemetryService=i,this.instantiationService=r,this._searchQuery=null,this._replaceActive=!1,this._replaceString=null,this._replacePattern=null,this._searchResult=this.instantiationService.createInstance(S,this)}return __extends(t,e),t.prototype.isReplaceActive=function(){return this._replaceActive},Object.defineProperty(t.prototype,"replaceActive",{set:function(e){this._replaceActive=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"replacePattern",{get:function(){return this._replacePattern},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"replaceString",{get:function(){return this._replaceString},set:function(e){this._replaceString=e,this._searchQuery&&(this._replacePattern=new u.ReplacePattern(e,this._searchQuery.contentPattern))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"searchResult",{get:function(){return this._searchResult},enumerable:!0,configurable:!0}),t.prototype.search=function(e){var t=this;return this.cancelSearch(),this.searchResult.clear(),this._searchQuery=e,this._searchResult.query=this._searchQuery.contentPattern,this._replacePattern=new u.ReplacePattern(this._replaceString,this._searchQuery.contentPattern),this.progressTimer=this.telemetryService.timedPublicLog("searchResultsFirstRender"),this.doneTimer=this.telemetryService.timedPublicLog("searchResultsFinished"),this.timerEvent=i.start(i.Topic.WORKBENCH,"Search"),this.currentRequest=this.searchService.search(this._searchQuery),this.currentRequest.then(function(e){return t.onSearchCompleted(e)},function(e){return t.onSearchError(e)},function(e){return t.onSearchProgress(e)}),this.currentRequest},t.prototype.onSearchCompleted=function(e){return this.progressTimer.stop(),this.timerEvent.stop(),this.doneTimer.stop(),e&&this._searchResult.add(e.results,!1),this.telemetryService.publicLog("searchResultsShown",{count:this._searchResult.count(),fileCount:this._searchResult.fileCount()}),e},t.prototype.onSearchError=function(e){n.isPromiseCanceledError(e)?this.onSearchCompleted(null):(this.progressTimer.stop(),this.doneTimer.stop(),this.timerEvent.stop())},t.prototype.onSearchProgress=function(e){e.resource&&(this._searchResult.add([e],!0),this.progressTimer.stop())},t.prototype.cancelSearch=function(){return!!this.currentRequest&&(this.currentRequest.cancel(),this.currentRequest=null,!0)},t.prototype.dispose=function(){this.cancelSearch(),this.searchResult.dispose(),e.prototype.dispose.call(this)},t=__decorate([__param(0,g.ISearchService),__param(1,p.ITelemetryService),__param(2,m.IInstantiationService)],t)}(c.Disposable);t.SearchModel=b});