/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},__decorate=this&&this.__decorate||function(e,t,n,r){var s,i=arguments.length,o=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(i<3?s(o):i>3?s(t,n,o):s(t,n))||o);return i>3&&o&&Object.defineProperty(t,n,o),o},__param=this&&this.__param||function(e,t){return function(n,r){t(n,r,e)}};define(["require","exports","vs/base/common/arrays","vs/base/common/objects","vs/base/common/winjs.base","vs/nls","vs/base/common/async","vs/base/common/types","vs/base/common/platform","vs/base/common/scorer","vs/base/common/paths","vs/base/common/labels","vs/base/common/strings","vs/base/parts/quickopen/browser/quickOpenModel","vs/workbench/browser/quickopen","vs/workbench/parts/search/browser/openFileHandler","vs/workbench/parts/search/browser/openSymbolHandler","vs/platform/message/common/message","vs/platform/instantiation/common/instantiation","vs/platform/telemetry/common/telemetry","vs/workbench/services/workspace/common/contextService","vs/platform/configuration/common/configuration"],function(e,t,n,r,s,i,o,a,c,l,u,h,m,p,d,f,g,v,S,b,y,T){"use strict";t.OpenSymbolHandler=g.OpenSymbolHandler;var _=function(e){function d(n,r,s,i,a){e.call(this),this.messageService=n,this.contextService=r,this.configurationService=i,this.telemetryService=a,this.openSymbolHandler=s.createInstance(t.OpenSymbolHandler),this.openFileHandler=s.createInstance(f.OpenFileHandler),this.openSymbolHandler.setOptions({skipDelay:!0,skipLocalSymbols:!0,skipSorting:!0}),this.resultsToSearchCache=Object.create(null),this.scorerCache=Object.create(null),this.delayer=new o.ThrottledDelayer(d.SEARCH_DELAY)}return __extends(d,e),d.prototype.getResults=function(e){var t=this,r=this.telemetryService.timedPublicLog("openAnything"),i=r.startTime?r.startTime.getTime():Date.now();if(e=e.replace(/ /g,""),c.isWindows&&(e=e.replace(/\//g,"\\")),this.cancelPendingSearch(),this.isClosed=!1,!e)return s.TPromise.as(new p.QuickOpenModel);var o=this.extractRange(e);o&&(e=o.search);var a=this.getResultsFromCache(e,o?o.range:null);if(a){var l=a[0],u=a[1];return r.data=this.createTimerEventData(i,u),r.stop(),s.TPromise.as(new p.QuickOpenModel(l))}var h=function(){var a,c=!1,l=[];if(o)l.push(s.TPromise.as(new p.QuickOpenModel));else{var u=function(e){return s.TPromise.timeout(e).then(function(){return c?s.TPromise.as(new p.QuickOpenModel):u(d.SYMBOL_SEARCH_SUBSEQUENT_TIMEOUT)})},h=t.openSymbolHandler.getResults(e),g=u(d.SYMBOL_SEARCH_INITIAL_TIMEOUT);l.push(s.TPromise.any([h,g]).then(function(e){return e.value}))}return l.push(t.openFileHandler.getResultsWithStats(e).then(function(e){var t=e[0],n=e[1];return c=!0,a=n,t})),t.pendingSearch=s.TPromise.join(l).then(function(c){var l=Date.now();if(t.pendingSearch=null,t.isClosed)return s.TPromise.as(new p.QuickOpenModel);var u=c[0].entries.concat(c[1].entries);t.resultsToSearchCache[e]=u;var h=m.stripWildcards(e).toLowerCase(),g=function(n,r){return p.QuickOpenEntry.compareByScore(n,r,e,h,t.scorerCache)},v=n.top(u,g,d.MAX_DISPLAYED_RESULTS),S=Date.now();return v.forEach(function(t){if(t instanceof f.FileEntry){t.setRange(o?o.range:null);var n=p.QuickOpenEntry.highlight(t,e,!0),r=n.labelHighlights,s=n.descriptionHighlights;t.setHighlights(r,s)}}),r.data=t.createTimerEventData(i,{fromCache:!1,searchLength:e.length,searchStats:a,unsortedResultTime:l,sortedResultTime:S,numberOfResultEntries:u.length}),r.stop(),s.TPromise.as(new p.QuickOpenModel(v))},function(e){t.pendingSearch=null,t.messageService.show(v.Severity.Error,e)}),t.pendingSearch};return this.delayer.trigger(h)},d.prototype.extractRange=function(e){var t=null,n=d.LINE_COLON_PATTERN.exec(e);if(n&&n.length>1){var r=parseInt(n[1],10);if(a.isNumber(r)){if(t={startLineNumber:r,startColumn:1,endLineNumber:r,endColumn:1},n.length>3){var s=parseInt(n[3],10);a.isNumber(s)&&(t.startColumn=s,t.endColumn=s)}}else""===n[1]&&(t={startLineNumber:1,startColumn:1,endLineNumber:1,endColumn:1})}return t?{search:e.substr(0,n.index),range:t}:null},d.prototype.getResultsFromCache=function(e,t){var r=this;if(void 0===t&&(t=null),u.isAbsolute(e))return null;var s;for(var i in this.resultsToSearchCache)if(0===e.indexOf(i)){if(e.indexOf(u.nativeSep)>=0&&i.indexOf(u.nativeSep)<0)continue;s=this.resultsToSearchCache[i];break}if(!s)return null;for(var o=[],a=m.stripWildcards(e).toLowerCase(),c=0;c<s.length;c++){var g=s[c];if(!t||g instanceof f.FileEntry){var v=g.getResource(),S=v?h.getPathLabel(v,this.contextService):g.getLabel();l.matches(S,a)&&o.push(g)}}var b=Date.now(),y=function(t,n){return p.QuickOpenEntry.compareByScore(t,n,e,a,r.scorerCache)},T=n.top(o,y,d.MAX_DISPLAYED_RESULTS),_=Date.now();return T.forEach(function(n){n instanceof f.FileEntry&&n.setRange(t);var r=p.QuickOpenEntry.highlight(n,e,!0),s=r.labelHighlights,i=r.descriptionHighlights;n.setHighlights(s,i)}),[T,{fromCache:!0,searchLength:e.length,unsortedResultTime:b,sortedResultTime:_,numberOfResultEntries:o.length}]},d.prototype.getGroupLabel=function(){return i.localize("fileAndTypeResults","file and symbol results")},d.prototype.getAutoFocus=function(e){return{autoFocusFirstEntry:!0}},d.prototype.onClose=function(e){this.isClosed=!0,this.cancelPendingSearch(),this.resultsToSearchCache=Object.create(null),this.scorerCache=Object.create(null),this.openSymbolHandler.onClose(e),this.openFileHandler.onClose(e)},d.prototype.cancelPendingSearch=function(){this.pendingSearch&&(this.pendingSearch.cancel(),this.pendingSearch=null)},d.prototype.createTimerEventData=function(e,t){var n={fromCache:t.fromCache,searchLength:t.searchLength,unsortedResultDuration:t.unsortedResultTime-e,sortedResultDuration:t.sortedResultTime-e,numberOfResultEntries:t.numberOfResultEntries},s=t.searchStats;return s?r.assign(n,{fileWalkStartDuration:s.fileWalkStartTime-e,fileWalkResultDuration:s.fileWalkResultTime-e,directoriesWalked:s.directoriesWalked,filesWalked:s.filesWalked}):n},d.LINE_COLON_PATTERN=/[#|:|\(](\d*)([#|:|,](\d*))?\)?$/,d.SYMBOL_SEARCH_INITIAL_TIMEOUT=500,d.SYMBOL_SEARCH_SUBSEQUENT_TIMEOUT=100,d.SEARCH_DELAY=300,d.MAX_DISPLAYED_RESULTS=512,d=__decorate([__param(0,v.IMessageService),__param(1,y.IWorkspaceContextService),__param(2,S.IInstantiationService),__param(3,T.IConfigurationService),__param(4,b.ITelemetryService)],d)}(d.QuickOpenHandler);t.OpenAnythingHandler=_});