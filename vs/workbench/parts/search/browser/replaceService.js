/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate=this&&this.__decorate||function(e,t,r,o){var n,c=arguments.length,i=c<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(i=(c<3?n(i):c>3?n(t,r,i):n(t,r))||i);return c>3&&i&&Object.defineProperty(t,r,i),i},__param=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};define(["require","exports","vs/nls","vs/base/common/errors","vs/base/common/winjs.base","vs/base/common/uri","vs/base/common/network","vs/base/common/map","vs/platform/editor/common/editor","vs/editor/common/services/modelService","vs/platform/event/common/event","vs/workbench/parts/search/common/searchModel","vs/editor/common/services/bulkEdit","vs/workbench/common/editor/diffEditorInput","vs/platform/telemetry/common/telemetry"],function(e,t,r,o,n,c,i,s,a,u,p,l,h,v,d){"use strict";var f=function(){function e(e,t,r){this.replaceService=e,this.editorService=t,this.modelService=r,this.cache=new s.SimpleMap}return e.prototype.hasInput=function(e){return this.cache.has(e.resource())},e.prototype.getInput=function(e){var t=this,r=this.cache.get(e.resource());return r||(r=this.createInput(e),this.cache.set(e.resource(),r),this.refreshInput(e,!0),e.onDispose(function(){return t.disposeInput(e)}),e.onChange(function(r){return t.refreshInput(e,r)})),r},e.prototype.refreshInput=function(e,t){var r=this;void 0===t&&(t=!1);var o=this.cache.get(e.resource());o&&o.done(function(){if(t)r.editorService.resolveEditorModel({resource:e.resource()}).then(function(t){var o=r.getReplaceResource(e.resource());r.modelService.getModel(o).setValue(t.textEditorModel.getValue()),r.replaceService.replace(e,null,o)});else{var o=r.getReplaceResource(e.resource());r.modelService.getModel(o).undo(),r.replaceService.replace(e,null,o)}})},e.prototype.disposeInput=function(e){var t=this,r=e instanceof c["default"]?e:e instanceof l.FileMatch?e.resource():null;if(r){var o=this.cache.get(r);o&&o.done(function(e){t.cleanInput(r),e.dispose()})}},e.prototype.disposeAll=function(){var e=this;this.cache.keys().forEach(function(t){return e.disposeInput(t)})},e.prototype.createInput=function(e){var t=this;return n.TPromise.join([this.createLeftInput(e),this.createRightInput(e)]).then(function(o){var n=o[0],c=o[1],i=new v.DiffEditorInput(r.localize("fileReplaceChanges","{0} â†” {1} (Replace Preview)",e.name(),e.name()),(void 0),n,c);return i.addListener2("dispose",function(){return t.cleanInput(e.resource())}),i})},e.prototype.createLeftInput=function(e){return this.editorService.createInput({resource:e.resource()})},e.prototype.createRightInput=function(e){var t=this;return new n.TPromise(function(r,o,n){t.editorService.resolveEditorModel({resource:e.resource()}).then(function(o){var n=o.textEditorModel,c=t.getReplaceResource(e.resource());t.modelService.createModel(n.getValue(),n.getMode(),c),r(t.editorService.createInput({resource:c}))})})},e.prototype.cleanInput=function(e){this.modelService.destroyModel(this.getReplaceResource(e)),this.cache["delete"](e)},e.prototype.getReplaceResource=function(e){return e["with"]({scheme:i.Schemas.internal,fragment:"preview"})},e}(),m=function(){function e(e,t,r,o){this.telemetryService=e,this.eventService=t,this.editorService=r,this.modelService=o,this.cache=new f(this,r,o)}return e.prototype.replace=function(e,t,r){var o=this;void 0===t&&(t=null),void 0===r&&(r=null);var n=h.createBulkEdit(this.eventService,this.editorService,null);if(n.progress(t),e instanceof l.Match){var c=e;n.add([this.createEdit(c,c.replaceString,r)])}return e instanceof l.FileMatch&&(e=[e]),e instanceof Array&&e.forEach(function(e){var t=e;t.count()>0&&t.matches().forEach(function(e){n.add([o.createEdit(e,e.replaceString,r)])})}),n.finish()},e.prototype.getInput=function(e){return this.cache.getInput(e)},e.prototype.refreshInput=function(e,t){void 0===t&&(t=!1),this.cache.refreshInput(e,t)},e.prototype.disposeAllInputs=function(){this.cache.disposeAll()},e.prototype.openReplacePreviewEditor=function(e,t,r,n){var c=this;return this.telemetryService.publicLog("replace.open.previewEditor"),this.getInput(e instanceof l.Match?e.parent():e).then(function(r){c.editorService.openEditor(r,{preserveFocus:t,pinned:n,revealIfVisible:!0}).then(function(t){var r=t.getControl();e instanceof l.Match&&r.revealLineInCenter(e.range().startLineNumber)},o.onUnexpectedError)},o.onUnexpectedError)},e.prototype.isReplacePreviewEditorOpened=function(e){return this.cache.hasInput(e instanceof l.Match?e.parent():e)},e.prototype.createEdit=function(e,t,r){void 0===r&&(r=null);var o=e.parent(),n={resource:null!==r?r:o.resource(),range:e.range(),newText:t};return n},e=__decorate([__param(0,d.ITelemetryService),__param(1,p.IEventService),__param(2,a.IEditorService),__param(3,u.IModelService)],e)}();t.ReplaceService=m});