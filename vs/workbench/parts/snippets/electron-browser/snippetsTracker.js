/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate=this&&this.__decorate||function(e,t,n,i){var r,s=arguments.length,o=s<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,i);else for(var c=e.length-1;c>=0;c--)(r=e[c])&&(o=(s<3?r(o):s>3?r(t,n,o):r(t,n))||o);return s>3&&o&&Object.defineProperty(t,n,o),o},__param=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}};define(["require","exports","vs/base/common/paths","vs/base/common/async","vs/base/common/winjs.base","vs/base/node/extfs","vs/base/common/lifecycle","vs/editor/node/textMate/TMSnippets","vs/platform/files/common/files","vs/platform/lifecycle/common/lifecycle","vs/platform/workspace/common/workspace","fs"],function(e,t,n,i,r,s,o,c,p,a,u,f){"use strict";function l(e){return new r.TPromise(function(t,n,i){s.readdir(e,function(e,i){return e?n(e):void t(i)})})}function h(e){return new r.TPromise(function(t,n,i){f.stat(e,function(e,n){return e?t(!1):n.isFile()?t(!0):void t(!1)})})}function d(e,t){return void 0===t&&(t=null),l(e).then(function(i){return r.TPromise.join(i.map(function(i){return t&&!t.test(i)?r.TPromise.as(null):h(n.join(e,i)).then(function(e){return e?i:null})})).then(function(e){return e.filter(function(e){return null!==e})})})}var m=function(){function e(t,r,s){var o=this;this.fileService=t,this.lifecycleService=r,this.snippetFolder=n.join(s.getConfiguration().env.appSettingsHome,"snippets"),this.toDispose=[],this.fileWatchDelayer=new i.ThrottledDelayer(e.FILE_WATCH_DELAY),f.existsSync(this.snippetFolder)||f.mkdirSync(this.snippetFolder),this.scanUserSnippets().then(function(e){o.registerListeners()})}return e.prototype.registerListeners=function(){var e=this,t=new i.RunOnceScheduler(function(){e.scanUserSnippets()},500);this.toDispose.push(t);try{this.watcher=f.watch(this.snippetFolder),this.watcher.on("change",function(n){return"delete"===n?void e.unregisterListener():void t.schedule()})}catch(n){}this.lifecycleService.onShutdown(this.dispose,this)},e.prototype.scanUserSnippets=function(){var e=this;return d(this.snippetFolder,/\.json$/).then(function(t){return r.TPromise.join(t.map(function(t){var i=t.replace(/\.json$/,"").toLowerCase(),r=n.join(e.snippetFolder,t);return c.readAndRegisterSnippets(i,r)}))})},e.prototype.unregisterListener=function(){this.watcher&&(this.watcher.close(),this.watcher=null)},e.prototype.getId=function(){return"vs.snippets.snippetsTracker"},e.prototype.dispose=function(){this.unregisterListener(),this.toDispose=o.dispose(this.toDispose)},e.FILE_WATCH_DELAY=200,e=__decorate([__param(0,p.IFileService),__param(1,a.ILifecycleService),__param(2,u.IWorkspaceContextService)],e)}();t.SnippetsTracker=m});