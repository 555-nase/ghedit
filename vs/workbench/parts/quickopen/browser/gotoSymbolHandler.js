/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)},__decorate=this&&this.__decorate||function(e,t,o,i){var n,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(r<3?n(s):r>3?n(t,o,s):n(t,o))||s);return r>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}};define(["require","exports","vs/base/common/winjs.base","vs/nls","vs/base/common/errors","vs/base/common/types","vs/base/common/strings","vs/base/parts/quickopen/common/quickOpen","vs/base/parts/quickopen/browser/quickOpenModel","vs/workbench/browser/quickopen","vs/workbench/browser/parts/editor/textEditor","vs/workbench/common/editor","vs/base/common/filters","vs/base/common/keyCodes","vs/editor/common/editorCommon","vs/workbench/services/editor/common/editorService","vs/workbench/services/quickopen/common/quickOpenService","vs/platform/workspace/common/workspace","vs/editor/contrib/quickOpen/common/quickOpen","vs/editor/common/modes","vs/css!./media/gotoSymbolHandler"],function(e,t,o,i,n,r,s,a,l,c,u,d,h,p,g,f,m,v,b,y){"use strict";t.GOTO_SYMBOL_PREFIX="@",t.SCOPE_PREFIX=":";var S=function(e){function o(o,i,n){e.call(this,o,i,t.GOTO_SYMBOL_PREFIX,n)}return __extends(o,e),o.ID="workbench.action.gotoSymbol",o.LABEL=i.localize("gotoSymbol","Go to Symbol..."),o=__decorate([__param(2,m.IQuickOpenService)],o)}(c.QuickOpenAction);t.GotoSymbolAction=S;var O=function(e){function o(t,o){e.call(this,o),this.outline=t}return __extends(o,e),o.prototype.dofilter=function(e){var o=e;0===e.indexOf(t.SCOPE_PREFIX)&&(o=o.substr(t.SCOPE_PREFIX.length)),this.entries.forEach(function(e){if(e.setGroupLabel(null),e.setShowBorder(!1),e.setHighlights(null),e.setHidden(!1),o){var t=h.matchesFuzzy(o,e.getLabel());t?(e.setHighlights(t),e.setHidden(!1)):e.isHidden()||e.setHidden(!0)}}),e?0===e.indexOf(t.SCOPE_PREFIX)?this.entries.sort(this.sortScoped.bind(this,e.toLowerCase())):this.entries.sort(this.sortNormal.bind(this,e.toLowerCase())):this.entries.sort(function(e,t){return e.getIndex()-t.getIndex()});var n=this.getEntries(!0);if(n.length>0&&0===e.indexOf(t.SCOPE_PREFIX)){for(var r=null,s=null,a=0,l=0;l<n.length;l++){var c=n[l];r!==c.getType()?(s&&s.setGroupLabel(this.renderGroupLabel(r,a,this.outline)),r=c.getType(),s=c,a=1,c.setShowBorder(l>0)):a++}s&&s.setGroupLabel(this.renderGroupLabel(r,a,this.outline))}else n.length>0&&n[0].setGroupLabel(i.localize("symbols","symbols ({0})",n.length))},o.prototype.sortNormal=function(e,t,o){if(t.isHidden()&&o.isHidden())return 0;if(t.isHidden())return 1;if(o.isHidden())return-1;var i=t.getLabel().toLowerCase(),n=o.getLabel().toLowerCase(),r=i.localeCompare(n);if(0!==r)return r;var s=t.getRange(),a=o.getRange();return s.startLineNumber-a.startLineNumber},o.prototype.sortScoped=function(e,o,i){if(o.isHidden()&&i.isHidden())return 0;if(o.isHidden())return 1;if(i.isHidden())return-1;e=e.substr(t.SCOPE_PREFIX.length);var n=o.getType(),r=i.getType(),s=n.localeCompare(r);if(0!==s)return s;if(e){var a=o.getLabel().toLowerCase(),l=i.getLabel().toLowerCase();if(s=a.localeCompare(l),0!==s)return s}var c=o.getRange(),u=i.getRange();return c.startLineNumber-u.startLineNumber},o.prototype.renderGroupLabel=function(e,t,i){var n=o.getDefaultGroupLabelPatterns()[e];return n?s.format(n,t):e},o.getDefaultGroupLabelPatterns=function(){var e=Object.create(null);return e.method=i.localize("method","methods ({0})"),e["function"]=i.localize("function","functions ({0})"),e.constructor=i.localize("_constructor","constructors ({0})"),e.variable=i.localize("variable","variables ({0})"),e["class"]=i.localize("class","classes ({0})"),e["interface"]=i.localize("interface","interfaces ({0})"),e.namespace=i.localize("namespace","namespaces ({0})"),e["package"]=i.localize("package","packages ({0})"),e.module=i.localize("modules","modules ({0})"),e.property=i.localize("property","properties ({0})"),e["enum"]=i.localize("enum","enumerations ({0})"),e.string=i.localize("string","strings ({0})"),e.rule=i.localize("rule","rules ({0})"),e.file=i.localize("file","files ({0})"),e.array=i.localize("array","arrays ({0})"),e.number=i.localize("number","numbers ({0})"),e["boolean"]=i.localize("boolean","booleans ({0})"),e.object=i.localize("object","objects ({0})"),e.key=i.localize("key","keys ({0})"),e},o}(l.QuickOpenModel),E=function(e){function t(t,o,i,n,r,s,a,l,c){e.call(this),this.index=t,this.name=o,this.type=i,this.icon=r,this.description=n,this.range=s,this.setHighlights(a),this.editorService=l,this.handler=c}return __extends(t,e),t.prototype.getIndex=function(){return this.index},t.prototype.getLabel=function(){return this.name},t.prototype.getAriaLabel=function(){return i.localize("entryAriaLabel","{0}, symbols",this.getLabel())},t.prototype.getIcon=function(){return this.icon},t.prototype.getDescription=function(){return this.description},t.prototype.getType=function(){return this.type},t.prototype.getRange=function(){return this.range},t.prototype.getInput=function(){return this.editorService.getActiveEditorInput()},t.prototype.getOptions=function(){var e=new d.TextEditorOptions;return e.selection(this.range.startLineNumber,this.range.startColumn,this.range.startLineNumber,this.range.startColumn),e},t.prototype.run=function(e,t){return e===a.Mode.OPEN?this.runOpen(t):this.runPreview()},t.prototype.runOpen=function(e){var t=e.keymods.indexOf(p.KeyMod.CtrlCmd)>=0;if(t)this.editorService.openEditor(this.getInput(),this.getOptions(),!0).done(null,n.onUnexpectedError);else{var o=this.toSelection(),i=this.editorService.getActiveEditor();if(i){var r=i.getControl();r.setSelection(o),r.revealRangeInCenter(o)}}return!0},t.prototype.runPreview=function(){var e=this.toSelection(),t=this.editorService.getActiveEditor();if(t){var o=t.getControl();o.revealRangeInCenter(e),r.isFunction(o.changeDecorations)&&this.handler.decorateOutline(this.range,e,o,t.position)}return!1},t.prototype.toSelection=function(){return{startLineNumber:this.range.startLineNumber,startColumn:this.range.startColumn||1,endLineNumber:this.range.startLineNumber,endColumn:this.range.startColumn||1}},t}(c.EditorQuickOpenEntryGroup),w=function(e){function n(t,o){e.call(this),this.editorService=t,this.contextService=o,this.outlineToModelCache={}}return __extends(n,e),n.prototype.getResults=function(e){if(e=e.trim(),!this.lastKnownEditorViewState){var t=this.editorService.getActiveEditor();this.lastKnownEditorViewState=t.getControl().saveViewState()}return this.getActiveOutline().then(function(t){return t.dofilter(e),t})},n.prototype.getEmptyLabel=function(e){return e.length>0?i.localize("noSymbolsMatching","No symbols matching"):i.localize("noSymbolsFound","No symbols found")},n.prototype.getAriaLabel=function(){return i.localize("gotoSymbolHandlerAriaLabel","Type to narrow down symbols of the currently active editor.")},n.prototype.canRun=function(){var e=!1,t=this.editorService.getActiveEditor();if(t instanceof u.BaseTextEditor){var o=t.getControl(),n=o.getModel();n&&n.modified&&n.original&&(n=n.modified),n&&r.isFunction(n.getMode)&&(e=y.DocumentSymbolProviderRegistry.has(n))}return!!e||(t instanceof u.BaseTextEditor?i.localize("cannotRunGotoSymbolInFile","Unfortunately we have no symbol information for the file"):i.localize("cannotRunGotoSymbol","Open a text file first to go to a symbol"))},n.prototype.getAutoFocus=function(e){return e=e.trim(),0===e.indexOf(t.SCOPE_PREFIX)&&(e=e.substr(t.SCOPE_PREFIX.length)),{autoFocusPrefixMatch:e,autoFocusFirstEntry:!!e}},n.prototype.toQuickOpenEntries=function(e){for(var t=[],o=0;o<e.length;o++){var i=e[o],n=s.trim(i.name),r=i.containerName,a=y.SymbolKind.from(i.kind);t.push(new E(o,n,y.SymbolKind.from(i.kind),r,a,i.location.range,null,this.editorService,this))}return t},n.prototype.getActiveOutline=function(){return this.activeOutlineRequest||(this.activeOutlineRequest=this.doGetActiveOutline()),this.activeOutlineRequest},n.prototype.doGetActiveOutline=function(){var e=this,t=this.editorService.getActiveEditor();if(t instanceof u.BaseTextEditor){var i=t.getControl(),n=i.getModel();if(n&&n.modified&&n.original&&(n=n.modified),n&&r.isFunction(n.getMode)){var s=n.id;return this.outlineToModelCache[s]?o.TPromise.as(this.outlineToModelCache[s]):b.getDocumentSymbols(n).then(function(t){var o=new O(t,e.toQuickOpenEntries(t.entries));return e.outlineToModelCache={},e.outlineToModelCache[s]=o,o})}}return o.TPromise.as(null)},n.prototype.decorateOutline=function(e,t,o,i){var n=this;o.changeDecorations(function(o){var r=[];n.lineHighlightDecorationId&&(r.push(n.lineHighlightDecorationId.lineDecorationId),r.push(n.lineHighlightDecorationId.lineHighlightId),n.lineHighlightDecorationId=null);var s=[{range:e,options:{className:"lineHighlight",isWholeLine:!0}},{range:t,options:{overviewRuler:{color:"rgba(0, 122, 204, 0.6)",darkColor:"rgba(0, 122, 204, 0.6)",position:g.OverviewRulerLane.Full}}}],a=o.deltaDecorations(r,s),l=a[0],c=a[1];n.lineHighlightDecorationId={lineHighlightId:l,lineDecorationId:c,position:i}})},n.prototype.clearDecorations=function(){var e=this;this.lineHighlightDecorationId&&(this.editorService.getVisibleEditors().forEach(function(t){if(t.position===e.lineHighlightDecorationId.position){var o=t.getControl();o.changeDecorations(function(t){t.deltaDecorations([e.lineHighlightDecorationId.lineDecorationId,e.lineHighlightDecorationId.lineHighlightId],[])})}}),this.lineHighlightDecorationId=null)},n.prototype.onClose=function(e){if(this.outlineToModelCache={},this.clearDecorations(),e&&this.lastKnownEditorViewState){var t=this.editorService.getActiveEditor();if(t){var o=t.getControl();o.restoreViewState(this.lastKnownEditorViewState)}}this.lastKnownEditorViewState=null,this.activeOutlineRequest=null},n=__decorate([__param(0,f.IWorkbenchEditorService),__param(1,v.IWorkspaceContextService)],n)}(c.QuickOpenHandler);t.GotoSymbolHandler=w});