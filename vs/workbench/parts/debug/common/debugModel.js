/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)};define(["require","exports","vs/base/common/winjs.base","vs/nls","vs/base/common/lifecycle","vs/base/common/event","vs/base/common/uuid","vs/base/common/objects","vs/base/common/types","vs/base/common/arrays","vs/workbench/parts/debug/common/debugSource"],function(e,t,n,i,r,s,a,o,h,l,u){"use strict";function c(e){return e?e.replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t"):e}function p(e,t,r,s){return e?e.evaluate({expression:r.name,frameId:t?t.frameId:void 0,context:s}).then(function(e){return r.available=!(!e||!e.body),e.body&&(r.value=e.body.result,r.reference=e.body.variablesReference,r.namedVariables=e.body.namedVariables,r.indexedVariables=e.body.indexedVariables,r.type=e.body.type),r},function(e){return r.value=e.message,r.available=!1,r.reference=0,r}):(r.value="repl"===s?i.localize("startDebugFirst","Please start a debug session to evaluate"):_.DEFAULT_VALUE,r.available=!1,r.reference=0,n.TPromise.as(r))}function d(e,t){var n=[e.name];if(e instanceof x)for(var i=e.parent;i instanceof x||i instanceof _;)n.push(i.name),i=i.parent;n=n.reverse();var r=null;return n.forEach(function(e){r=r?b.test(e)||"node"===t&&!m.test(e)?e&&0===e.indexOf("[")?""+r+e:r+"['"+e+"']":r+"."+e:e}),r}var f=1e4,v=i.localize("unknownSource","Unknown Source");t.evaluateExpression=p;var m=/^[a-zA-Z_][a-zA-Z0-9_]*$/,b=/\[.*\]$/;t.getFullExpressionName=d;var g=function(){function e(e,t){this.name=e,this.threadId=t,this.promisedCallStack=void 0,this.stoppedDetails=void 0,this.cachedCallStack=void 0,this.stopped=!1}return e.prototype.getId=function(){return"thread:"+this.name+":"+this.threadId},e.prototype.clearCallStack=function(){this.promisedCallStack=void 0,this.cachedCallStack=void 0},e.prototype.getCachedCallStack=function(){return this.cachedCallStack},e.prototype.getCallStack=function(e,t){var i=this;return void 0===t&&(t=!1),this.stopped?(this.promisedCallStack?t&&(this.promisedCallStack=this.promisedCallStack.then(function(t){return i.getCallStackImpl(e,t.length).then(function(e){return i.cachedCallStack=t.concat(e),i.cachedCallStack})})):this.promisedCallStack=this.getCallStackImpl(e,0).then(function(e){return i.cachedCallStack=e,e}),this.promisedCallStack):n.TPromise.as([])},e.prototype.getCallStackImpl=function(e,t){var n=this,r=e.getActiveSession();return r.stackTrace({threadId:this.threadId,startFrame:t,levels:20}).then(function(e){return n.stoppedDetails.totalFrames=e.body.totalFrames,e.body.stackFrames.map(function(e,t){return e?new S(n.threadId,e.id,e.source?new u.Source(e.source):new u.Source({name:v},(!1)),e.name,e.line,e.column):new S(n.threadId,0,new u.Source({name:v},(!1)),i.localize("unknownStack","Unknown stack location"),(void 0),(void 0))})},function(e){return n.stoppedDetails.framesErrorMessage=e.message,[]})},e}();t.Thread=g;var E=function(){function e(t){void 0===t&&(t=e.ID_COUNTER++),this.id=t}return e.prototype.getId=function(){return"outputelement:"+this.id},e.ID_COUNTER=0,e}();t.OutputElement=E;var k=function(e){function t(t,n,i,r){void 0===r&&(r=1),e.call(this),this.value=t,this.severity=n,this.category=i,this.counter=r}return __extends(t,e),t}(E);t.ValueOutputElement=k;var y=function(e){function t(t,n,i){e.call(this),this.key=t,this.valueObj=n,this.annotation=i,this._valueName=null}return __extends(t,e),Object.defineProperty(t.prototype,"value",{get:function(){return null===this._valueName&&(null===this.valueObj?this._valueName="null":Array.isArray(this.valueObj)?this._valueName="Array["+this.valueObj.length+"]":h.isObject(this.valueObj)?this._valueName="Object":h.isString(this.valueObj)?this._valueName='"'+c(this.valueObj)+'"':this._valueName=String(this.valueObj),this._valueName||(this._valueName="")),this._valueName},enumerable:!0,configurable:!0}),t.prototype.getChildren=function(){var e=this;return this.children||(Array.isArray(this.valueObj)?this.children=this.valueObj.slice(0,t.MAX_CHILDREN).map(function(e,n){return new t(String(n),e,null)}):h.isObject(this.valueObj)?this.children=Object.getOwnPropertyNames(this.valueObj).slice(0,t.MAX_CHILDREN).map(function(n){return new t(n,e.valueObj[n],null)}):this.children=[]),this.children},t.MAX_CHILDREN=1e3,t}(E);t.KeyValueOutputElement=y;var C=function(){function e(e,t,n,i,r,s){void 0===s&&(s=0),this.reference=e,this.id=t,this.cacheChildren=n,this.namedVariables=i,this.indexedVariables=r,this.chunkIndex=s}return e.prototype.getChildren=function(t){var i=this;if(!this.cacheChildren||!this.children){var r=t.getActiveSession();!r||this.reference<=0?this.children=n.TPromise.as([]):this.children=(this.namedVariables?this.fetchVariables(r,void 0,void 0,"named"):n.TPromise.as([])).then(function(t){if(i.indexedVariables>e.CHUNK_SIZE){for(var n=i.indexedVariables/e.CHUNK_SIZE,s=0;s<n;s++){var a=Math.min(e.CHUNK_SIZE,i.indexedVariables-s*e.CHUNK_SIZE),o="["+s*e.CHUNK_SIZE+".."+(s*e.CHUNK_SIZE+a-1)+"]";t.push(new x(i,i.reference,o,"",null,a,null,(!0),s))}return t}var h=i.getChildrenInChunks?i.chunkIndex*e.CHUNK_SIZE:void 0,l=i.getChildrenInChunks?i.indexedVariables:void 0;return i.fetchVariables(r,h,l,"indexed").then(function(e){return t.concat(e)})})}return this.children},e.prototype.getId=function(){return this.id},Object.defineProperty(e.prototype,"value",{get:function(){return this._value},set:function(t){this._value=c(t),this.valueChanged=e.allValues[this.getId()]&&e.allValues[this.getId()]!==_.DEFAULT_VALUE&&e.allValues[this.getId()]!==t,e.allValues[this.getId()]=t},enumerable:!0,configurable:!0}),e.prototype.fetchVariables=function(e,t,n,i){var r=this;return e.variables({variablesReference:this.reference,start:t,count:n,filter:i}).then(function(e){return l.distinct(e.body.variables.filter(function(e){return!!e}),function(e){return e.name}).map(function(e){return new x(r,e.variablesReference,e.name,e.value,e.namedVariables,e.indexedVariables,e.type)})},function(e){return[new x(r,0,null,e.message,0,0,null,(!1))]})},Object.defineProperty(e.prototype,"getChildrenInChunks",{get:function(){return!!this.indexedVariables},enumerable:!0,configurable:!0}),e.allValues={},e.CHUNK_SIZE=100,e}();t.ExpressionContainer=C;var _=function(e){function t(n,i,r){void 0===r&&(r=a.generateUuid()),e.call(this,0,r,i,0,0),this.name=n,this.value=t.DEFAULT_VALUE,this.available=!1}return __extends(t,e),t.DEFAULT_VALUE="not available",t}(C);t.Expression=_;var x=function(e){function t(t,n,i,r,s,a,o,h,l){void 0===o&&(o=null),void 0===h&&(h=!0),void 0===l&&(l=0),e.call(this,n,"variable:"+t.getId()+":"+i,!0,s,a,l),this.parent=t,this.name=i,this.type=o,this.available=h,this.value=c(r)}return __extends(t,e),t}(C);t.Variable=x;var I=function(e){function t(t,n,i,r,s,a){e.call(this,i,"scope:"+t+":"+n+":"+i,!0,s,a),this.threadId=t,this.name=n,this.expensive=r}return __extends(t,e),t}(C);t.Scope=I;var S=function(){function e(e,t,n,i,r,s){this.threadId=e,this.frameId=t,this.source=n,this.name=i,this.lineNumber=r,this.column=s,this.scopes=null}return e.prototype.getId=function(){return"stackframe:"+this.threadId+":"+this.frameId},e.prototype.getScopes=function(e){var t=this;return this.scopes||(this.scopes=e.getActiveSession().scopes({frameId:this.frameId}).then(function(e){return e.body.scopes.map(function(e){return new I(t.threadId,e.name,e.variablesReference,e.expensive,e.namedVariables,e.indexedVariables)})},function(e){return[]})),this.scopes},e}();t.StackFrame=S;var D=function(){function e(e,t,n,i){this.source=e,this.desiredLineNumber=t,this.enabled=n,this.condition=i,void 0===n&&(this.enabled=!0),this.lineNumber=this.desiredLineNumber,this.verified=!1,this.id=a.generateUuid()}return e.prototype.getId=function(){return this.id},e}();t.Breakpoint=D;var w=function(){function e(e,t){this.name=e,this.enabled=t,this.verified=!1,this.id=a.generateUuid()}return e.prototype.getId=function(){return this.id},e}();t.FunctionBreakpoint=w;var B=function(){function e(e,t,n){this.filter=e,this.label=t,this.enabled=n,this.id=a.generateUuid()}return e.prototype.getId=function(){return this.id},e}();t.ExceptionBreakpoint=B;var O=function(){function e(e,t,n,i,r){this.breakpoints=e,this.breakpointsActivated=t,this.functionBreakpoints=n,this.exceptionBreakpoints=i,this.watchExpressions=r,this.threads={},this.replElements=[],this.toDispose=[],this._onDidChangeBreakpoints=new s.Emitter,this._onDidChangeCallStack=new s.Emitter,this._onDidChangeWatchExpressions=new s.Emitter,this._onDidChangeREPLElements=new s.Emitter}return e.prototype.getId=function(){return"root"},Object.defineProperty(e.prototype,"onDidChangeBreakpoints",{get:function(){return this._onDidChangeBreakpoints.event},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onDidChangeCallStack",{get:function(){return this._onDidChangeCallStack.event},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onDidChangeWatchExpressions",{get:function(){return this._onDidChangeWatchExpressions.event},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onDidChangeReplElements",{get:function(){return this._onDidChangeREPLElements.event},enumerable:!0,configurable:!0}),e.prototype.getThreads=function(){return this.threads},e.prototype.clearThreads=function(e,t){var n=this;void 0===t&&(t=void 0),t?this.threads[t]&&(this.threads[t].clearCallStack(),this.threads[t].stoppedDetails=void 0,this.threads[t].stopped=!1,e&&delete this.threads[t]):(Object.keys(this.threads).forEach(function(e){n.threads[e].clearCallStack(),n.threads[e].stoppedDetails=void 0,n.threads[e].stopped=!1}),e&&(this.threads={},C.allValues={})),this._onDidChangeCallStack.fire()},e.prototype.getBreakpoints=function(){return this.breakpoints},e.prototype.getFunctionBreakpoints=function(){return this.functionBreakpoints},e.prototype.getExceptionBreakpoints=function(){return this.exceptionBreakpoints},e.prototype.setExceptionBreakpoints=function(e){var t=this;e&&(this.exceptionBreakpoints=e.map(function(e){var n=t.exceptionBreakpoints.filter(function(t){return t.filter===e.filter}).pop();return new B(e.filter,e.label,n?n.enabled:e["default"])}))},e.prototype.areBreakpointsActivated=function(){return this.breakpointsActivated},e.prototype.setBreakpointsActivated=function(e){this.breakpointsActivated=e,this._onDidChangeBreakpoints.fire()},e.prototype.addBreakpoints=function(e){var t=this;this.breakpoints=this.breakpoints.concat(e.map(function(e){return new D(new u.Source(u.Source.toRawSource(e.uri,t)),e.lineNumber,e.enabled,e.condition)})),this.breakpointsActivated=!0,this._onDidChangeBreakpoints.fire()},e.prototype.removeBreakpoints=function(e){this.breakpoints=this.breakpoints.filter(function(t){return!e.some(function(e){return e.getId()===t.getId()})}),this._onDidChangeBreakpoints.fire()},e.prototype.updateBreakpoints=function(e){this.breakpoints.forEach(function(t){var n=e[t.getId()];n&&(t.lineNumber=n.line?n.line:t.lineNumber,t.verified=n.verified,t.idFromAdapter=n.id,t.message=n.message)}),this._onDidChangeBreakpoints.fire()},e.prototype.setEnablement=function(e,t){if(e.enabled=t,e instanceof D&&!e.enabled){var n=e;n.lineNumber=n.desiredLineNumber,n.verified=!1}this._onDidChangeBreakpoints.fire()},e.prototype.enableOrDisableAllBreakpoints=function(e){this.breakpoints.forEach(function(t){t.enabled=e,e||(t.lineNumber=t.desiredLineNumber,t.verified=!1)}),this.exceptionBreakpoints.forEach(function(t){return t.enabled=e}),this.functionBreakpoints.forEach(function(t){return t.enabled=e}),this._onDidChangeBreakpoints.fire()},e.prototype.addFunctionBreakpoint=function(e){this.functionBreakpoints.push(new w(e,(!0))),this._onDidChangeBreakpoints.fire()},e.prototype.updateFunctionBreakpoints=function(e){this.functionBreakpoints.forEach(function(t){var n=e[t.getId()];n&&(t.name=n.name||t.name,t.verified=n.verified,t.idFromAdapter=n.id)}),this._onDidChangeBreakpoints.fire()},e.prototype.removeFunctionBreakpoints=function(e){this.functionBreakpoints=e?this.functionBreakpoints.filter(function(t){return t.getId()!==e}):[],this._onDidChangeBreakpoints.fire()},e.prototype.getReplElements=function(){return this.replElements},e.prototype.addReplExpression=function(e,t,n){var i=this,r=new _(n,(!0));return this.addReplElements([r]),p(e,t,r,"repl").then(function(){return i._onDidChangeREPLElements.fire()})},e.prototype.logToRepl=function(e,t){var n=[],r=this.replElements.length&&this.replElements[this.replElements.length-1];if("string"==typeof e)if(e&&e.trim()&&r&&r.value===e&&r.severity===t)r.counter++;else{var s=e.trim().split("\n");s.forEach(function(e,i){n.push(new k(e,t))})}else n.push(new y(e.prototype,e,i.localize("snapshotObj","Only primitive values are shown for this object.")));n.length&&this.addReplElements(n),this._onDidChangeREPLElements.fire()},e.prototype.appendReplOutput=function(e,t){var n=[],i=this.replElements.length&&this.replElements[this.replElements.length-1],r=e.split("\n"),s=!!i&&"output"===i.category&&t===i.severity;s?i.value+=r.shift():i&&""===i.value&&this.replElements.pop(),r.forEach(function(e,i){n.push(new k(e,t,"output"))}),this.addReplElements(n),this._onDidChangeREPLElements.fire()},e.prototype.addReplElements=function(e){(t=this.replElements).push.apply(t,e),this.replElements.length>f&&this.replElements.splice(0,this.replElements.length-f);var t},e.prototype.removeReplExpressions=function(){this.replElements.length>0&&(this.replElements=[],this._onDidChangeREPLElements.fire())},e.prototype.getWatchExpressions=function(){return this.watchExpressions},e.prototype.addWatchExpression=function(e,t,i){var r=new _(i,(!1));return this.watchExpressions.push(r),i?this.evaluateWatchExpressions(e,t,r.getId()):(this._onDidChangeWatchExpressions.fire(r),n.TPromise.as(null))},e.prototype.renameWatchExpression=function(e,t,i,r){var s=this,a=this.watchExpressions.filter(function(e){return e.getId()===i});return 1===a.length?(a[0].name=r,p(e,t,a[0],"watch").then(function(){s._onDidChangeWatchExpressions.fire(a[0])})):n.TPromise.as(null)},e.prototype.evaluateWatchExpressions=function(e,t,i){var r=this;if(void 0===i&&(i=null),i){var s=this.watchExpressions.filter(function(e){return e.getId()===i});return 1!==s.length?n.TPromise.as(null):p(e,t,s[0],"watch").then(function(){r._onDidChangeWatchExpressions.fire(s[0])})}return n.TPromise.join(this.watchExpressions.map(function(n){return p(e,t,n,"watch")})).then(function(){r._onDidChangeWatchExpressions.fire()})},e.prototype.clearWatchExpressionValues=function(){this.watchExpressions.forEach(function(e){e.value=_.DEFAULT_VALUE,e.available=!1,e.reference=0}),this._onDidChangeWatchExpressions.fire()},e.prototype.removeWatchExpressions=function(e){void 0===e&&(e=null),this.watchExpressions=e?this.watchExpressions.filter(function(t){return t.getId()!==e}):[],this._onDidChangeWatchExpressions.fire()},e.prototype.sourceIsUnavailable=function(e){var t=this;Object.keys(this.threads).forEach(function(n){t.threads[n].getCachedCallStack()&&t.threads[n].getCachedCallStack().forEach(function(t){t.source.uri.toString()===e.uri.toString()&&(t.source.available=!1)})}),this._onDidChangeCallStack.fire()},e.prototype.rawUpdate=function(e){var t=this;e.thread&&!this.threads[e.threadId]&&(this.threads[e.threadId]=new g(e.thread.name,e.thread.id)),e.stoppedDetails&&(e.allThreadsStopped?Object.keys(this.threads).forEach(function(n){t.threads[n].stoppedDetails=o.clone(e.stoppedDetails),t.threads[n].stopped=!0,t.threads[n].clearCallStack()}):(this.threads[e.threadId].stoppedDetails=e.stoppedDetails,this.threads[e.threadId].clearCallStack(),this.threads[e.threadId].stopped=!0)),this._onDidChangeCallStack.fire()},e.prototype.dispose=function(){this.threads=null,this.breakpoints=null,this.exceptionBreakpoints=null,this.functionBreakpoints=null,this.watchExpressions=null,this.replElements=null,this.toDispose=r.dispose(this.toDispose)},e}();t.Model=O});