/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate=this&&this.__decorate||function(e,t,o,i){var n,r=arguments.length,a=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,o):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,i);else for(var s=e.length-1;s>=0;s--)(n=e[s])&&(a=(r<3?n(a):r>3?n(t,o,a):n(t,o))||a);return r>3&&a&&Object.defineProperty(t,o,a),a},__param=this&&this.__param||function(e,t){return function(o,i){t(o,i,e)}};define(["require","exports","vs/nls","vs/base/common/winjs.base","vs/base/common/objects","vs/base/common/lifecycle","vs/editor/common/editorCommon","vs/workbench/parts/debug/common/debug","vs/editor/common/services/modelService"],function(e,t,o,i,n,r,a,s,c){"use strict";function d(e){for(var t={},o=0,i=e.length;o<i;o++)t[e[o]]=!0;return t}function p(e,t,o,i){return{startLineNumber:e,startColumn:t,endLineNumber:o,endColumn:i}}var l=function(){function e(e,t){this.modelService=e,this.debugService=t,this.modelData={},this.toDispose=[],this.registerListeners()}return e.prototype.getId=function(){return e.ID},e.prototype.dispose=function(){for(var e in this.modelData)if(this.modelData.hasOwnProperty(e)){var t=this.modelData[e];r.dispose(t.toDispose),t.model.deltaDecorations(t.breakpointDecorationIds,[]),t.model.deltaDecorations(t.currentStackDecorations,[])}this.toDispose=r.dispose(this.toDispose),this.modelData=null},e.prototype.registerListeners=function(){var e=this;this.toDispose.push(this.modelService.onModelAdded(this.onModelAdded,this)),this.modelService.getModels().forEach(function(t){return e.onModelAdded(t)}),this.toDispose.push(this.modelService.onModelRemoved(this.onModelRemoved,this)),this.toDispose.push(this.debugService.getModel().onDidChangeBreakpoints(function(){return e.onBreakpointsChange()})),this.toDispose.push(this.debugService.getViewModel().onDidFocusStackFrame(function(){return e.onFocusStackFrame()})),this.toDispose.push(this.debugService.onDidChangeState(function(t){t===s.State.Inactive&&Object.keys(e.modelData).forEach(function(t){return e.modelData[t].dirty=!1})}))},e.prototype.onModelAdded=function(e){var t=this,o=e.uri.toString(),i=this.debugService.getModel().getBreakpoints().filter(function(e){return e.source.uri.toString()===o}),n=e.deltaDecorations([],this.createCallStackDecorations(o)),r=e.deltaDecorations([],this.createBreakpointDecorations(i)),a=[e.onDidChangeDecorations(function(e){return t.onModelDecorationsChanged(o,e)})];this.modelData[o]={model:e,toDispose:a,breakpointDecorationIds:r,breakpointLines:i.map(function(e){return e.lineNumber}),breakpointDecorationsAsMap:d(r),currentStackDecorations:n,topStackFrameRange:null,dirty:!1}},e.prototype.onModelRemoved=function(e){var t=e.uri.toString();if(this.modelData.hasOwnProperty(t)){var o=this.modelData[t];delete this.modelData[t],r.dispose(o.toDispose)}},e.prototype.onFocusStackFrame=function(){var e=this;Object.keys(this.modelData).forEach(function(t){var o=e.modelData[t];o.currentStackDecorations=o.model.deltaDecorations(o.currentStackDecorations,e.createCallStackDecorations(t))})},e.prototype.createCallStackDecorations=function(t){var o=this,i=[],n=this.debugService.getViewModel().getFocusedStackFrame(),r=this.debugService.getViewModel().getFocusedThreadId(),a=this.debugService.getModel().getThreads();if(!n||!a[r]||!a[r].getCachedCallStack())return i;var s=a[r];return s.getCachedCallStack().filter(function(e){return e.source.uri.toString()===t}).forEach(function(r){var a=p(r.lineNumber,r.column,r.lineNumber,Number.MAX_VALUE);r===s.getCachedCallStack()[0]?(i.push({options:e.TOP_STACK_FRAME_MARGIN,range:p(r.lineNumber,r.column,r.lineNumber,r.column+1)}),"exception"===s.stoppedDetails.reason?i.push({options:e.TOP_STACK_FRAME_EXCEPTION_DECORATION,range:a}):(i.push({options:e.TOP_STACK_FRAME_DECORATION,range:a}),o.modelData[t]&&(o.modelData[t].topStackFrameRange&&o.modelData[t].topStackFrameRange.startLineNumber===a.startLineNumber&&o.modelData[t].topStackFrameRange.startColumn!==a.startColumn&&i.push({options:e.TOP_STACK_FRAME_COLUMN_DECORATION,range:a}),o.modelData[t].topStackFrameRange=a))):r===n&&(i.push({options:e.FOCUSED_STACK_FRAME_MARGIN,range:p(r.lineNumber,r.column,r.lineNumber,r.column+1)}),i.push({options:e.FOCUSED_STACK_FRAME_DECORATION,range:a}))}),i},e.prototype.onModelDecorationsChanged=function(e,t){var o=this,n=this.modelData[e];if(t.addedOrChangedDecorations.some(function(e){return n.breakpointDecorationsAsMap.hasOwnProperty(e.id)})){var r=[],a={};this.debugService.getModel().getBreakpoints().filter(function(t){return t.source.uri.toString()===e}).forEach(function(e){a[e.lineNumber]={enabled:e.enabled,condition:e.condition}});for(var s=n.model.uri,c=0,d=n.breakpointDecorationIds.length;c<d;c++){var p=n.model.getDecorationRange(n.breakpointDecorationIds[c]);p.endColumn-p.startColumn>0&&r.push({uri:s,lineNumber:p.startLineNumber,enabled:a[n.breakpointLines[c]].enabled,condition:a[n.breakpointLines[c]].condition})}n.dirty=!!this.debugService.getActiveSession();var l=this.debugService.getModel().getBreakpoints().filter(function(e){return e.source.uri.toString()===s.toString()});i.TPromise.join(l.map(function(e){return o.debugService.removeBreakpoints(e.getId())})).then(function(){o.debugService.addBreakpoints(r)})}},e.prototype.onBreakpointsChange=function(){var e=this,t={};this.debugService.getModel().getBreakpoints().forEach(function(e){var o=e.source.uri.toString();t[o]?t[o].push(e):t[o]=[e]}),Object.keys(t).forEach(function(o){e.modelData.hasOwnProperty(o)&&e.updateBreakpoints(e.modelData[o],t[o])}),Object.keys(this.modelData).forEach(function(o){t.hasOwnProperty(o)||e.updateBreakpoints(e.modelData[o],[])})},e.prototype.updateBreakpoints=function(e,t){e.breakpointDecorationIds=e.model.deltaDecorations(e.breakpointDecorationIds,this.createBreakpointDecorations(t)),e.breakpointDecorationsAsMap=d(e.breakpointDecorationIds),e.breakpointLines=t.map(function(e){return e.lineNumber})},e.prototype.createBreakpointDecorations=function(e){var t=this;return e.map(function(e){return{options:t.getBreakpointDecorationOptions(e),range:p(e.lineNumber,1,e.lineNumber,2)}})},e.prototype.getBreakpointDecorationOptions=function(t){var o=this.debugService.getModel().areBreakpointsActivated(),i=this.debugService.state,r=i===s.State.Running||i===s.State.Stopped||i===s.State.Initializing,c=this.modelData[t.source.uri.toString()],d=this.debugService.getActiveSession(),p=t.enabled&&o?r&&c&&c.dirty&&!t.verified?e.BREAKPOINT_DIRTY_DECORATION:r&&!t.verified?e.BREAKPOINT_UNVERIFIED_DECORATION:t.condition?null:e.BREAKPOINT_DECORATION:e.BREAKPOINT_DISABLED_DECORATION;return p&&t.message&&(p=n.clone(p),p.glyphMarginHoverMessage=t.message),p?p:!d||d.configuration.capabilities.supportsConditionalBreakpoints?{glyphMarginClassName:"debug-breakpoint-conditional-glyph",glyphMarginHoverMessage:t.condition,stickiness:a.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges}:e.BREAKPOINT_UNSUPPORTED_DECORATION},e.ID="breakpointManager",e.BREAKPOINT_DECORATION={glyphMarginClassName:"debug-breakpoint-glyph",glyphMarginHoverMessage:o.localize("breakpointHover","Breakpoint"),stickiness:a.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges},e.BREAKPOINT_DISABLED_DECORATION={glyphMarginClassName:"debug-breakpoint-disabled-glyph",glyphMarginHoverMessage:o.localize("breakpointDisabledHover","Disabled Breakpoint"),stickiness:a.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges},e.BREAKPOINT_UNVERIFIED_DECORATION={glyphMarginClassName:"debug-breakpoint-unverified-glyph",glyphMarginHoverMessage:o.localize("breakpointUnverifieddHover","Unverified Breakpoint"),stickiness:a.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges},e.BREAKPOINT_DIRTY_DECORATION={glyphMarginClassName:"debug-breakpoint-unverified-glyph",glyphMarginHoverMessage:o.localize("breakpointDirtydHover","Unverified breakpoint. File is modified, please restart debug session."),stickiness:a.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges},e.BREAKPOINT_UNSUPPORTED_DECORATION={glyphMarginClassName:"debug-breakpoint-unsupported-glyph",glyphMarginHoverMessage:o.localize("breakpointUnsupported","Conditional breakpoints not supported by this debug type"),stickiness:a.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges},e.TOP_STACK_FRAME_MARGIN={glyphMarginClassName:"debug-top-stack-frame-glyph",stickiness:a.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges},e.FOCUSED_STACK_FRAME_MARGIN={glyphMarginClassName:"debug-focused-stack-frame-glyph",stickiness:a.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges},e.TOP_STACK_FRAME_DECORATION={isWholeLine:!0,className:"debug-top-stack-frame-line",stickiness:a.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges},e.TOP_STACK_FRAME_EXCEPTION_DECORATION={isWholeLine:!0,className:"debug-top-stack-frame-exception-line",stickiness:a.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges},e.TOP_STACK_FRAME_COLUMN_DECORATION={isWholeLine:!1,className:"debug-top-stack-frame-column",stickiness:a.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges},e.FOCUSED_STACK_FRAME_DECORATION={isWholeLine:!0,className:"debug-focused-stack-frame-line",stickiness:a.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges},e=__decorate([__param(0,c.IModelService),__param(1,s.IDebugService)],e)}();t.DebugEditorModelManager=l});