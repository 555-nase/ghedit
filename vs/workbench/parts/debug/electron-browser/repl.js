/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},__decorate=this&&this.__decorate||function(e,t,r,n){var i,s=arguments.length,o=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(o=(s<3?i(o):s>3?i(t,r,o):i(t,r))||o);return s>3&&o&&Object.defineProperty(t,r,o),o},__param=this&&this.__param||function(e,t){return function(r,n){t(r,n,e)}};define(["require","exports","vs/nls","vs/base/common/errors","vs/base/common/lifecycle","vs/base/browser/dom","vs/base/common/platform","vs/base/parts/tree/browser/treeImpl","vs/platform/event/common/event","vs/workbench/common/events","vs/workbench/parts/debug/electron-browser/replViewer","vs/workbench/parts/debug/common/debug","vs/workbench/parts/debug/common/debugModel","vs/workbench/parts/debug/browser/debugActions","vs/workbench/parts/debug/common/replHistory","vs/workbench/browser/panel","vs/platform/telemetry/common/telemetry","vs/platform/contextview/browser/contextView","vs/platform/instantiation/common/instantiation","vs/workbench/services/workspace/common/contextService","vs/platform/storage/common/storage","vs/base/common/keyCodes","vs/css!./../browser/media/repl"],function(e,t,r,n,i,s,o,a,p,c,l,h,u,d,v,m,f,S,g,b,y,R){"use strict";var _=s.emmet,I={indentPixels:8,twistiePixels:20,paddingOnRow:!1,ariaLabel:r.localize("replAriaLabel","Read Eval Print Loop Panel")},E="debug.repl.history",w=function(e){function t(t,r,n,i,s,o,a,p){e.call(this,h.REPL_ID,i),this.debugService=t,this.contextMenuService=r,this.contextService=n,this.instantiationService=s,this.contextViewService=o,this.storageService=a,this.eventService=p,this.toDispose=[],this.registerListeners()}return __extends(t,e),t.prototype.registerListeners=function(){var e=this;this.toDispose.push(this.debugService.getModel().onDidChangeReplElements(function(){e.onReplElementsUpdated()})),this.toDispose.push(this.eventService.addListener2(c.EventType.COMPOSITE_OPENED,function(t){if(t.compositeId===h.REPL_ID){var r=e.debugService.getModel().getReplElements();if(r.length>0)return e.reveal(r[r.length-1])}}))},t.prototype.onReplElementsUpdated=function(){var e=this;if(this.tree){if(this.refreshTimeoutHandle)return;this.refreshTimeoutHandle=setTimeout(function(){e.refreshTimeoutHandle=null;var t=e.tree.getScrollPosition();e.tree.refresh().then(function(){0!==t&&1!==t||e.tree.setScrollPosition(1);var r=e.debugService.getModel().getReplElements(),n=r.length>0?r[r.length-1]:null;if(n instanceof u.Expression&&n.reference>0)return e.tree.expand(r[r.length-1]).then(function(){return e.tree.reveal(r[r.length-1],0)})},n.onUnexpectedError)},t.REFRESH_DELAY)}},t.prototype.create=function(r){var n=this;e.prototype.create.call(this,r);var i=s.append(r.getHTMLElement(),_(".repl"));this.treeContainer=s.append(i,_(".repl-tree"));var p=s.append(i,_(".repl-input-wrapper"));this.replInput=s.append(p,_("input.repl-input")),this.replInput.type="text",this.toDispose.push(s.addStandardDisposableListener(this.replInput,"keydown",function(e){if(e.equals(R.CommonKeybindings.ENTER))n.debugService.addReplExpression(n.replInput.value),t.HISTORY.evaluated(n.replInput.value),n.replInput.value="",e.preventDefault();else if(e.equals(R.CommonKeybindings.UP_ARROW)||e.equals(R.CommonKeybindings.DOWN_ARROW)){var r=e.equals(R.CommonKeybindings.UP_ARROW)?t.HISTORY.previous():t.HISTORY.next();r&&(t.HISTORY.remember(n.replInput.value,e.equals(R.CommonKeybindings.UP_ARROW)),n.replInput.value=r,e.preventDefault())}})),this.toDispose.push(s.addStandardDisposableListener(this.replInput,s.EventType.FOCUS,function(){return s.addClass(p,"synthetic-focus")})),this.toDispose.push(s.addStandardDisposableListener(this.replInput,s.EventType.BLUR,function(){return s.removeClass(p,"synthetic-focus")})),this.characterWidthSurveyor=s.append(i,_(".surveyor")),this.characterWidthSurveyor.textContent=t.HALF_WIDTH_TYPICAL;for(var c=0;c<10;c++)this.characterWidthSurveyor.textContent+=this.characterWidthSurveyor.textContent;return this.characterWidthSurveyor.style.fontSize=o.isMacintosh?"12px":"14px",this.renderer=this.instantiationService.createInstance(l.ReplExpressionsRenderer),this.tree=new a.Tree(this.treeContainer,{dataSource:new l.ReplExpressionsDataSource(this.debugService),renderer:this.renderer,accessibilityProvider:new l.ReplExpressionsAccessibilityProvider,controller:new l.ReplExpressionsController(this.debugService,this.contextMenuService,new l.ReplExpressionsActionProvider(this.instantiationService),this.replInput,(!1))},I),t.HISTORY||(t.HISTORY=new v.ReplHistory(JSON.parse(this.storageService.get(E,y.StorageScope.WORKSPACE,"[]")))),this.tree.setInput(this.debugService.getModel())},t.prototype.layout=function(e){this.tree&&(this.renderer.setWidth(e.width-25,this.characterWidthSurveyor.clientWidth/this.characterWidthSurveyor.textContent.length),this.tree.layout(e.height-22),this.tree.refresh().done(void 0,n.onUnexpectedError))},t.prototype.focus=function(){this.replInput.focus()},t.prototype.reveal=function(e){return this.tree.reveal(e)},t.prototype.getActions=function(){var e=this;return this.actions||(this.actions=[this.instantiationService.createInstance(d.ClearReplAction,d.ClearReplAction.ID,d.ClearReplAction.LABEL)],this.actions.forEach(function(t){e.toDispose.push(t)})),this.actions},t.prototype.shutdown=function(){this.storageService.store(E,JSON.stringify(t.HISTORY.save()),y.StorageScope.WORKSPACE)},t.prototype.dispose=function(){this.toDispose=i.dispose(this.toDispose),e.prototype.dispose.call(this)},t.HALF_WIDTH_TYPICAL="n",t.REFRESH_DELAY=500,t=__decorate([__param(0,h.IDebugService),__param(1,S.IContextMenuService),__param(2,b.IWorkspaceContextService),__param(3,f.ITelemetryService),__param(4,g.IInstantiationService),__param(5,S.IContextViewService),__param(6,y.IStorageService),__param(7,p.IEventService)],t)}(m.Panel);t.Repl=w});