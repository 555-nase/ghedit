/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate=this&&this.__decorate||function(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},__param=this&&this.__param||function(e,t){return function(n,i){t(n,i,e)}};define(["require","exports","path","vs/nls","vs/base/common/async","vs/base/common/winjs.base","vs/base/common/strings","vs/base/common/types","vs/base/common/platform","vs/base/common/event","vs/base/common/objects","vs/base/common/uri","vs/base/common/network","vs/base/common/paths","vs/platform/extensions/common/extensionsRegistry","vs/platform/platform","vs/platform/jsonschemas/common/jsonContributionRegistry","vs/platform/configuration/common/configuration","vs/platform/files/common/files","vs/platform/telemetry/common/telemetry","vs/platform/commands/common/commands","vs/workbench/parts/debug/node/debugAdapter","vs/workbench/services/workspace/common/contextService","vs/workbench/services/editor/common/editorService","vs/workbench/services/quickopen/common/quickOpenService","vs/workbench/parts/lib/node/configVariables"],function(e,t,n,i,o,r,s,a,c,u,l,p,g,f,d,b,m,h,v,y,x,k,S,C,j,w){"use strict";t.debuggersExtPoint=d.ExtensionsRegistry.registerExtensionPoint("debuggers",{description:i.localize("vscode.extension.contributes.debuggers","Contributes debug adapters."),type:"array",defaultSnippets:[{body:[{type:"",extensions:[]}]}],items:{type:"object",defaultSnippets:[{body:{type:"",program:"",runtime:"",enableBreakpointsFor:{languageIds:[""]}}}],properties:{type:{description:i.localize("vscode.extension.contributes.debuggers.type","Unique identifier for this debug adapter."),type:"string"},label:{description:i.localize("vscode.extension.contributes.debuggers.label","Display name for this debug adapter."),type:"string"},enableBreakpointsFor:{description:i.localize("vscode.extension.contributes.debuggers.enableBreakpointsFor","Allow breakpoints for these languages."),type:"object",properties:{languageIds:{description:i.localize("vscode.extension.contributes.debuggers.enableBreakpointsFor.languageIds","List of languages."),type:"array",items:{type:"string"}}}},program:{description:i.localize("vscode.extension.contributes.debuggers.program","Path to the debug adapter program. Path is either absolute or relative to the extension folder."),type:"string"},args:{description:i.localize("vscode.extension.contributes.debuggers.args","Optional arguments to pass to the adapter."),type:"array"},runtime:{description:i.localize("vscode.extension.contributes.debuggers.runtime","Optional runtime in case the program attribute is not an executable but requires a runtime."),type:"string"},runtimeArgs:{description:i.localize("vscode.extension.contributes.debuggers.runtimeArgs","Optional runtime arguments."),type:"array"},variables:{description:i.localize("vscode.extension.contributes.debuggers.variables","Mapping from interactive variables (e.g ${action.pickProcess}) in `launch.json` to a command."),type:"object"},initialConfigurations:{description:i.localize("vscode.extension.contributes.debuggers.initialConfigurations","Configurations for generating the initial 'launch.json'."),type:"array"},configurationAttributes:{description:i.localize("vscode.extension.contributes.debuggers.configurationAttributes","JSON schema configurations for validating 'launch.json'."),type:"object"},windows:{description:i.localize("vscode.extension.contributes.debuggers.windows","Windows specific settings."),type:"object",properties:{runtime:{description:i.localize("vscode.extension.contributes.debuggers.windows.runtime","Runtime used for Windows."),type:"string"}}},osx:{description:i.localize("vscode.extension.contributes.debuggers.osx","OS X specific settings."),type:"object",properties:{runtime:{description:i.localize("vscode.extension.contributes.debuggers.osx.runtime","Runtime used for OSX."),type:"string"}}},linux:{description:i.localize("vscode.extension.contributes.debuggers.linux","Linux specific settings."),type:"object",properties:{runtime:{description:i.localize("vscode.extension.contributes.debuggers.linux.runtime","Runtime used for Linux."),type:"string"}}}}}}),t.breakpointsExtPoint=d.ExtensionsRegistry.registerExtensionPoint("breakpoints",{description:i.localize("vscode.extension.contributes.breakpoints","Contributes breakpoints."),type:"array",defaultSnippets:[{body:[{language:""}]}],items:{type:"object",defaultSnippets:[{body:{language:""}}],properties:{language:{description:i.localize("vscode.extension.contributes.breakpoints.language","Allow breakpoints for this language."),type:"string"}}}}),t.schemaId="vscode://schemas/launch";var O={id:t.schemaId,type:"object",title:i.localize("app.launch.json.title","Launch"),required:["version","configurations"],properties:{version:{type:"string",description:i.localize("app.launch.json.version","Version of this file format."),"default":"0.2.0"},configurations:{type:"array",description:i.localize("app.launch.json.configurations","List of configurations. Add new configurations or edit existing ones."),items:{type:"object",oneOf:[]}}}},E=b.Registry.as(m.Extensions.JSONContribution);E.registerSchema(t.schemaId,O);var z=function(){function e(e,t,n,i,o,r,s,a){this.contextService=t,this.fileService=n,this.telemetryService=i,this.editorService=o,this.configurationService=r,this.quickOpenService=s,this.commandService=a,this.systemVariables=this.contextService.getWorkspace()?new w.ConfigVariables(this.configurationService,this.editorService,this.contextService):null,this._onDidConfigurationChange=new u.Emitter,this.setConfiguration(e),this.adapters=[],this.registerListeners(),this.allModeIdsForBreakpoints={}}return e.prototype.registerListeners=function(){var e=this;t.debuggersExtPoint.setHandler(function(t){t.forEach(function(t){t.value.forEach(function(n){var o=new k.Adapter(n,e.systemVariables,t.description),r=e.adapters.filter(function(e){return e.type===o.type})[0];n.type&&"string"==typeof n.type||t.collector.error(i.localize("debugNoType","Debug adapter 'type' can not be omitted and must be of type 'string'.")),r?Object.keys(o).forEach(function(e){o[e]&&("enableBreakpointsFor"===e?Object.keys(o.enableBreakpointsFor).forEach(function(e){return r.enableBreakpointsFor[e]=!0}):r[e]&&"type"!==e&&"extensionDescription"!==e?(r[e]=o[e],t.collector.error(i.localize("duplicateDebuggerType","Debug type '{0}' is already registered and has attribute '{1}', ignoring attribute '{1}'.",o.type,e))):r[e]=o[e])}):e.adapters.push(o),o.enableBreakpointsFor&&o.enableBreakpointsFor.languageIds.forEach(function(t){e.allModeIdsForBreakpoints[t]=!0})})}),e.adapters.forEach(function(e){var t=e.getSchemaAttributes();t&&(n=O.properties.configurations.items.oneOf).push.apply(n,t);var n})}),t.breakpointsExtPoint.setHandler(function(t){t.forEach(function(t){t.value.forEach(function(t){e.allModeIdsForBreakpoints[t.language]=!0})})})},Object.defineProperty(e.prototype,"onDidConfigurationChange",{get:function(){return this._onDidConfigurationChange.event},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"configurationName",{get:function(){return this.configuration?this.configuration.name:null},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"adapter",{get:function(){var e=this;return this.configuration&&this.configuration.type?this.adapters.filter(function(t){return s.equalsIgnoreCase(t.type,e.configuration.type)}).pop():null},enumerable:!0,configurable:!0}),e.prototype.resolveInteractiveVariables=function(){var e=this;if(!this.configuration)return r.TPromise.as(null);var t={},n=function(e){Object.keys(e).forEach(function(i){if(e[i]&&"object"==typeof e[i])n(e[i]);else if("string"==typeof e[i]){var o=/\${command.(.+)}/.exec(e[i]);if(o&&2===o.length){var r=o[1];t[r]||(t[r]=[]),t[r].push({object:e,key:i})}}})};n(this.configuration);var s=Object.keys(t).map(function(n){return function(){var o=e.adapter.variables?e.adapter.variables[n]:null;return o?e.commandService.executeCommand(o,e.configuration).then(function(i){i||(e.configuration.silentlyAbort=!0),t[n].forEach(function(e){return e.object[e.key]=e.object[e.key].replace("${command."+n+"}",i)})}):r.TPromise.wrapError(i.localize("interactiveVariableNotFound","Adapter {0} does not contribute variable {1} that is specified in launch configuration.",e.adapter.type,n))}});return o.sequence(s).then(function(){return e.configuration})},e.prototype.setConfiguration=function(e){var t=this;return this.loadLaunchConfig().then(function(n){if(a.isObject(e))t.configuration=l.deepClone(e);else{if(!n||!n.configurations)return void(t.configuration=null);var i=e?n.configurations.filter(function(t){return t.name===e}):[n.configurations[0]];t.configuration=1===i.length?l.deepClone(i[0]):null,n&&t.configuration&&(t.configuration.debugServer=n.debugServer)}t.configuration&&(c.isWindows&&t.configuration.windows&&Object.keys(t.configuration.windows).forEach(function(e){t.configuration[e]=t.configuration.windows[e]}),c.isMacintosh&&t.configuration.osx&&Object.keys(t.configuration.osx).forEach(function(e){t.configuration[e]=t.configuration.osx[e]}),c.isLinux&&t.configuration.linux&&Object.keys(t.configuration.linux).forEach(function(e){t.configuration[e]=t.configuration.linux[e]}),t.systemVariables&&Object.keys(t.configuration).forEach(function(e){t.configuration[e]=t.systemVariables.resolveAny(t.configuration[e])}))}).then(function(){return t._onDidConfigurationChange.fire(t.configurationName)})},e.prototype.openConfigFile=function(e){var t=this,n=p["default"].file(f.join(this.contextService.getWorkspace().resource.fsPath,"/.vscode/launch.json")),o=!1;return this.fileService.resolveContent(n).then(function(e){return!0},function(e){return t.getInitialConfigFileContent().then(function(e){return!!e&&(o=!0,t.fileService.updateContent(n,e).then(function(){return!0}))})}).then(function(i){return!!i&&(t.telemetryService.publicLog("debugConfigure"),t.editorService.openEditor({resource:n,options:{forceOpen:!0,pinned:o}},e).then(function(){return!0}))},function(e){throw new Error(i.localize("DebugConfig.failed","Unable to create 'launch.json' file inside the '.vscode' folder ({0}).",e))})},e.prototype.getInitialConfigFileContent=function(){var e=this;return this.quickOpenService.pick(this.adapters,{placeHolder:i.localize("selectDebug","Select Environment")}).then(function(t){return t?e.massageInitialConfigurations(t).then(function(){var n=e.configurationService.getConfiguration();return JSON.stringify({version:"0.2.0",configurations:t.initialConfigurations?t.initialConfigurations:[]},null,n.editor.insertSpaces?s.repeat(" ",n.editor.tabSize):"\t")}):null})},e.prototype.massageInitialConfigurations=function(e){if(!e||!e.initialConfigurations||"node"!==e.type)return r.TPromise.as(void 0);var t=p["default"].file(f.join(this.contextService.getWorkspace().resource.fsPath,"/package.json"));return this.fileService.resolveContent(t).then(function(e){try{var t=JSON.parse(e.value);if(t.main)return t.main;if(t.scripts&&"string"==typeof t.scripts.start)return t.scripts.start.split(" ").pop()}catch(n){}return null},function(e){return null}).then(function(t){e.initialConfigurations.forEach(function(e){t&&e.program&&(n.isAbsolute(t)||(t=f.join("${workspaceRoot}",t)),e.program=t)})})},e.prototype.canSetBreakpointsIn=function(e){if(e.uri.scheme===g.Schemas.inMemory)return!1;var t=e?e.getMode():null,n=t?t.getId():null;return!!this.allModeIdsForBreakpoints[n]},e.prototype.loadLaunchConfig=function(){return r.TPromise.as(this.configurationService.getConfiguration("launch"))},e=__decorate([__param(1,S.IWorkspaceContextService),__param(2,v.IFileService),__param(3,y.ITelemetryService),__param(4,C.IWorkbenchEditorService),__param(5,h.IConfigurationService),__param(6,j.IQuickOpenService),__param(7,x.ICommandService)],e)}();t.ConfigurationManager=z});