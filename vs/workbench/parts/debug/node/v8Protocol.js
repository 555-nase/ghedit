/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","vs/base/common/uuid","vs/base/common/winjs.base","vs/base/common/errors"],function(t,e,n,i,s){"use strict";var r=function(){function t(){this.sequence=1,this.contentLength=-1,this.pendingRequests={},this.rawData=new Buffer(0),this.id=n.generateUuid()}return t.prototype.getId=function(){return this.id},t.prototype.connect=function(t,e){var n=this;this.outputStream=e,t.on("data",function(t){n.rawData=Buffer.concat([n.rawData,t]),n.handleData()})},t.prototype.send=function(t,e){var n,r=this;return new i.TPromise(function(i,s){n=s,r.doSend(t,e,function(t){t.success?i(t):s(t)})},function(){return n(s.canceled())})},t.prototype.doSend=function(e,n,i){var s={type:"request",seq:this.sequence++,command:e};n&&Object.keys(n).length>0&&(s.arguments=n),this.pendingRequests[s.seq]=i;var r=JSON.stringify(s),a=Buffer.byteLength(r,"utf8");this.outputStream.write("Content-Length: "+a.toString()+t.TWO_CRLF,"utf8"),this.outputStream.write(r,"utf8")},t.prototype.handleData=function(){for(;;){if(this.contentLength>=0){if(this.rawData.length>=this.contentLength){var e=this.rawData.toString("utf8",0,this.contentLength);this.rawData=this.rawData.slice(this.contentLength),this.contentLength=-1,e.length>0&&this.dispatch(e);continue}}else{var n=this.rawData.toString("utf8",0,this.rawData.length),i=n.indexOf(t.TWO_CRLF);if(i!==-1){var s=/Content-Length: (\d+)/.exec(n);if(s&&s[1]){this.contentLength=Number(s[1]),this.rawData=this.rawData.slice(i+t.TWO_CRLF.length);continue}}}break}},t.prototype.dispatch=function(t){try{var e=JSON.parse(t);if("undefined"!=typeof e.event)this.onEvent(e);else{var n=e,i=this.pendingRequests[n.request_seq];i&&(delete this.pendingRequests[n.request_seq],i(n))}}catch(s){this.onServerError(new Error(s.message||s))}},t.TWO_CRLF="\r\n\r\n",t}();e.V8Protocol=r});