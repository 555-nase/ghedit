/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},__decorate=this&&this.__decorate||function(e,t,r,n){var o,i=arguments.length,s=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(i<3?o(s):i>3?o(t,r,s):o(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s},__param=this&&this.__param||function(e,t){return function(r,n){t(r,n,e)}};define(["require","exports","vs/nls","child_process","fs","net","vs/base/common/event","vs/base/common/platform","vs/base/common/objects","vs/base/common/actions","vs/base/common/errors","vs/base/common/winjs.base","vs/base/common/severity","vs/base/node/stdFork","vs/platform/message/common/message","vs/platform/telemetry/common/telemetry","vs/workbench/parts/debug/common/debug","vs/workbench/parts/debug/node/v8Protocol","vs/workbench/parts/output/common/output","vs/platform/extensionManagement/common/extensionManagement","electron"],function(e,t,r,n,o,i,s,a,u,c,p,d,h,l,f,v,m,b,g,y,P){"use strict";var S=function(e){function t(t,r,n,o,i,a){e.call(this),this.debugServerPort=t,this.adapter=r,this.customTelemetryService=n,this.messageService=o,this.telemetryService=i,this.outputService=a,this.socket=null,this.emittedStopped=!1,this.readyForBreakpoints=!1,this.sentPromises=[],this._onDidInitialize=new s.Emitter,this._onDidStop=new s.Emitter,this._onDidContinued=new s.Emitter,this._onDidTerminateDebugee=new s.Emitter,this._onDidExitAdapter=new s.Emitter,this._onDidThread=new s.Emitter,this._onDidOutput=new s.Emitter,this._onDidBreakpoint=new s.Emitter,this._onDidEvent=new s.Emitter}return __extends(t,e),Object.defineProperty(t.prototype,"onDidInitialize",{get:function(){return this._onDidInitialize.event},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onDidStop",{get:function(){return this._onDidStop.event},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onDidContinued",{get:function(){return this._onDidContinued.event},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onDidTerminateDebugee",{get:function(){return this._onDidTerminateDebugee.event},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onDidExitAdapter",{get:function(){return this._onDidExitAdapter.event},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onDidThread",{get:function(){return this._onDidThread.event},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onDidOutput",{get:function(){return this._onDidOutput.event},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onDidBreakpoint",{get:function(){return this._onDidBreakpoint.event},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onDidEvent",{get:function(){return this._onDidEvent.event},enumerable:!0,configurable:!0}),t.prototype.initServer=function(){var e=this;if(this.cachedInitServer)return this.cachedInitServer;var t=this.debugServerPort?this.connectServer(this.debugServerPort):this.startServer();return this.cachedInitServer=t.then(function(){e.startTime=(new Date).getTime()},function(t){return e.cachedInitServer=null,d.TPromise.wrapError(t)}),this.cachedInitServer},t.prototype.custom=function(e,t){return this.send(e,t)},t.prototype.send=function(t,n,o){var i=this;return void 0===o&&(o=!0),this.initServer().then(function(){var s=e.prototype.send.call(i,t,n).then(function(e){return e},function(e){var t=e.body?e.body.error:null,n=t?m.formatPII(t.format,!0,t.variables):e.message;if(t&&t.sendTelemetry&&(i.telemetryService.publicLog("debugProtocolErrorResponse",{error:n}),i.customTelemetryService&&i.customTelemetryService.publicLog("debugProtocolErrorResponse",{error:n})),p.isPromiseCanceledError(e)||t&&t.showUser===!1)return d.TPromise.as(null);var o=t?m.formatPII(t.format,!1,t.variables):e.message;if(t&&t.url){var s=t.urlLabel?t.urlLabel:r.localize("moreInfo","More Info");return d.TPromise.wrapError(p.create(o,{actions:[f.CloseAction,new c.Action("debug.moreInfo",s,null,(!0),function(){return P.shell.openExternal(t.url),d.TPromise.as(null)})]}))}return d.TPromise.wrapError(new Error(o))});return o&&i.sentPromises.push(s),s})},t.prototype.onEvent=function(e){e.body?e.body.sessionId=this.getId():e.body={sessionId:this.getId()},"initialized"===e.event?(this.readyForBreakpoints=!0,this._onDidInitialize.fire(e)):"stopped"===e.event?(this.emittedStopped=!0,this._onDidStop.fire(e)):"continued"===e.event?this._onDidContinued.fire(e):"thread"===e.event?this._onDidThread.fire(e):"output"===e.event?this._onDidOutput.fire(e):"breakpoint"===e.event?this._onDidBreakpoint.fire(e):"terminated"===e.event?this._onDidTerminateDebugee.fire(e):"exit"===e.event&&this._onDidExitAdapter.fire(e),this._onDidEvent.fire(e)},Object.defineProperty(t.prototype,"configuration",{get:function(){return{type:this.adapter.type,isAttach:this.isAttach,capabilities:this.capabilities||{}}},enumerable:!0,configurable:!0}),t.prototype.initialize=function(e){var t=this;return this.send("initialize",e).then(function(e){return t.readCapabilities(e)})},t.prototype.readCapabilities=function(e){return e&&(this.capabilities=u.mixin(this.capabilities,e.body)),e},t.prototype.launch=function(e){var t=this;return this.isAttach=!1,this.send("launch",e).then(function(e){return t.readCapabilities(e)})},t.prototype.attach=function(e){var t=this;return this.isAttach=!0,this.send("attach",e).then(function(e){return t.readCapabilities(e)})},t.prototype.next=function(e){return this.send("next",e)},t.prototype.stepIn=function(e){return this.send("stepIn",e)},t.prototype.stepOut=function(e){return this.send("stepOut",e)},t.prototype.stepBack=function(e){return this.send("stepBack",e)},t.prototype["continue"]=function(e){return this.send("continue",e)},t.prototype.pause=function(e){return this.send("pause",e)},t.prototype.setVariable=function(e){return this.send("setVariable",e)},t.prototype.restartFrame=function(e){return this.send("restartFrame",e)},t.prototype.disconnect=function(e,t){var r=this;return void 0===e&&(e=!1),void 0===t&&(t=!1),this.stopServerPending&&t?this.stopServer():(setTimeout(function(){r.sentPromises.forEach(function(e){return e.cancel()}),r.sentPromises=[]},1e3),!this.serverProcess&&!this.socket||this.stopServerPending?d.TPromise.as(null):(this.stopServerPending=!0,this.restarted=e,this.send("disconnect",{restart:e},!1).then(function(){return r.stopServer()},function(){return r.stopServer()})))},t.prototype.setBreakpoints=function(e){return this.send("setBreakpoints",e)},t.prototype.setFunctionBreakpoints=function(e){return this.send("setFunctionBreakpoints",e)},t.prototype.setExceptionBreakpoints=function(e){return this.send("setExceptionBreakpoints",e)},t.prototype.configurationDone=function(){return this.send("configurationDone",null)},t.prototype.stackTrace=function(e){return this.send("stackTrace",e)},t.prototype.scopes=function(e){return this.send("scopes",e)},t.prototype.variables=function(e){return this.send("variables",e)},t.prototype.source=function(e){return this.send("source",e)},t.prototype.threads=function(){return this.send("threads",null)},t.prototype.evaluate=function(e){return this.send("evaluate",e)},t.prototype.getLengthInSeconds=function(){return((new Date).getTime()-this.startTime)/1e3},t.prototype.connectServer=function(e){var t=this;return new d.TPromise(function(r,n){t.socket=i.createConnection(e,"127.0.0.1",function(){t.connect(t.socket,t.socket),r(null)}),t.socket.on("error",function(e){n(e)}),t.socket.on("close",function(){return t.onServerExit()})})},t.prototype.startServer=function(){var e=this;return this.adapter.program?this.getLaunchDetails().then(function(t){return e.launchServer(t).then(function(){e.serverProcess.on("error",function(t){return e.onServerError(t)}),e.serverProcess.on("exit",function(t,r){return e.onServerExit()});var t=function(e){return e.toString().replace(/\r?\n$/gm,"")};e.serverProcess.stderr.on("data",function(r){e.outputService.getChannel(y.ExtensionsChannelId).append(t(r))}),e.connect(e.serverProcess.stdout,e.serverProcess.stdin)})}):d.TPromise.wrapError(new Error(r.localize("noDebugAdapterExtensionInstalled","No extension installed for '{0}' debugging.",this.adapter.type)))},t.prototype.launchServer=function(e){var t=this;return new d.TPromise(function(o,i){"node"===e.command?l.fork(e.argv[0],e.argv.slice(1),{},function(n,s){n&&i(new Error(r.localize("unableToLaunchDebugAdapter","Unable to launch debug adapter from '{0}'.",e.argv[0]))),t.serverProcess=s,o(null)}):(t.serverProcess=n.spawn(e.command,e.argv,{stdio:["pipe","pipe","pipe"]}),o(null))})},t.prototype.stopServer=function(){var e=this;if(null!==this.socket&&(this.socket.end(),this.cachedInitServer=null,this.onEvent({event:"exit",type:"event",seq:0})),!this.serverProcess)return d.TPromise.as(null);this.stopServerPending=!0;var t;return a.isWindows?t=new d.TPromise(function(t,r){var o=n.exec("taskkill /F /T /PID "+e.serverProcess.pid,function(e,t,n){if(e)return r(e)});o.on("exit",t),o.on("error",r)}):(this.serverProcess.kill("SIGTERM"),t=d.TPromise.as(null)),t},t.prototype.getLaunchDetails=function(){var e=this;return new d.TPromise(function(t,n){o.exists(e.adapter.program,function(o){o?t(null):n(new Error(r.localize("debugAdapterBinNotFound","Debug adapter executable '{0}' not found.",e.adapter.program)))})}).then(function(){return e.adapter.runtime?{command:e.adapter.runtime,argv:(e.adapter.runtimeArgs||[]).concat([e.adapter.program]).concat(e.adapter.args||[])}:{command:e.adapter.program,argv:e.adapter.args||[]}})},t.prototype.onServerError=function(e){this.messageService.show(h["default"].Error,r.localize("stoppingDebugAdapter","{0}. Stopping the debug adapter.",e.message)),this.stopServer().done(null,p.onUnexpectedError)},t.prototype.onServerExit=function(){this.serverProcess=null,this.cachedInitServer=null,this.stopServerPending||this.messageService.show(h["default"].Error,r.localize("debugAdapterCrash","Debug adapter process has terminated unexpectedly")),this.onEvent({event:"exit",type:"event",seq:0})},t.prototype.dispose=function(){this.disconnect().done(null,p.onUnexpectedError)},t=__decorate([__param(3,f.IMessageService),__param(4,v.ITelemetryService),__param(5,g.IOutputService)],t)}(b.V8Protocol);t.RawDebugSession=S});