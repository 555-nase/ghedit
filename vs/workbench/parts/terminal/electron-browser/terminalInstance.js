/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","vs/base/browser/dom","vs/base/common/lifecycle","vs/nls","os","xterm","vs/platform/message/common/message","vs/base/browser/keyboardEvent","vs/editor/common/config/commonEditorConfig","vs/editor/contrib/toggleTabFocusMode/common/toggleTabFocusMode"],function(e,t,s,i,r,o,n,a,c,l,h){"use strict";var m=function(){function e(e,t,i,o,m,p,u,d,f,x){var g=this;this.terminalProcess=e,this.parentDomElement=t,this.contextMenuService=i,this.contextService=o,this.instantiationService=m,this.keybindingService=p,this.terminalService=u,this.messageService=d,this.terminalFocusContextKey=f,this.onExitCallback=x,this.isExiting=!1;var v=this;this.toDispose=[],this.toggleTabFocusModeKeybindings=v.keybindingService.lookupKeybindings(h.ToggleTabFocusModeAction.ID),this.wrapperElement=document.createElement("div"),s.addClass(this.wrapperElement,"terminal-wrapper"),this.terminalDomElement=document.createElement("div"),this.xterm=n(),this.terminalProcess.process.on("message",function(e){"data"===e.type&&g.xterm.write(e.content)}),this.xterm.on("data",function(e){return g.terminalProcess.process.send({event:"input",data:g.sanitizeInput(e)}),!1}),this.xterm.attachCustomKeydownHandler(function(e){var t=new c.StandardKeyboardEvent(e);return v.toggleTabFocusModeKeybindings.some(function(e){return t.equals(e.value)})?(e.preventDefault(),!1):(!l.TabFocus.getTabFocusMode()||9!==e.keyCode)&&void 0}),this.terminalProcess.process.on("exit",function(e){g.isExiting||(g.isExiting=!0,g.dispose(),e&&g.messageService.show(a.Severity.Error,r.localize("terminal.integrated.exitedWithCode","The terminal process terminated with exit code: {0}",e)),g.onExitCallback(g))}),this.xterm.open(this.terminalDomElement);var b=this.xterm.element.querySelector(".xterm-helpers"),y=document.createElement("div");y.setAttribute("tabindex","0"),s.addClass(y,"focus-trap"),y.addEventListener("focus",function(e){for(var t=y;!s.hasClass(t,"part");)t=t.parentElement;var i=t.querySelector(".hide-panel-action");i.focus()}),b.insertBefore(y,this.xterm.textarea),this.toDispose.push(s.addDisposableListener(this.xterm.textarea,"focus",function(e){v.terminalFocusContextKey.set(!0)})),this.toDispose.push(s.addDisposableListener(this.xterm.textarea,"blur",function(e){v.terminalFocusContextKey.reset()})),this.toDispose.push(s.addDisposableListener(this.xterm.element,"focus",function(e){v.terminalFocusContextKey.set(!0)})),this.toDispose.push(s.addDisposableListener(this.xterm.element,"blur",function(e){v.terminalFocusContextKey.reset()})),this.wrapperElement.appendChild(this.terminalDomElement),this.parentDomElement.appendChild(this.wrapperElement)}return e.prototype.sanitizeInput=function(t){return"string"==typeof t?t.replace(e.eolRegex,o.EOL):t},e.prototype.layout=function(e){if(this.font&&this.font.charWidth&&this.font.charHeight&&e.height){var t=Math.floor(e.width/this.font.charWidth),s=Math.floor(e.height/this.font.charHeight);this.xterm&&this.xterm.resize(t,s),this.terminalProcess.process.connected&&this.terminalProcess.process.send({event:"resize",cols:t,rows:s})}},e.prototype.toggleVisibility=function(e){s.toggleClass(this.wrapperElement,"active",e)},e.prototype.setFont=function(e){this.font=e},e.prototype.setCursorBlink=function(e){this.xterm&&this.xterm.cursorBlink!==e&&(this.xterm.cursorBlink=e,this.xterm.refresh(0,this.xterm.rows-1))},e.prototype.focus=function(e){if(this.xterm){var t=window.getSelection().toString();t&&!e||this.xterm.focus()}},e.prototype.dispose=function(){this.wrapperElement&&(this.parentDomElement.removeChild(this.wrapperElement),this.wrapperElement=null),this.xterm&&(this.xterm.destroy(),this.xterm=null),this.terminalProcess&&(this.terminalService.killTerminalProcess(this.terminalProcess),this.terminalProcess=null),this.toDispose=i.dispose(this.toDispose)},e.eolRegex=/\r?\n/g,e}();t.TerminalInstance=m});