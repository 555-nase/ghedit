/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate=this&&this.__decorate||function(e,n,t,i){var r,o=arguments.length,s=o<3?n:null===i?i=Object.getOwnPropertyDescriptor(n,t):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,n,t,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(o<3?r(s):o>3?r(n,t,s):r(n,t))||s);return o>3&&s&&Object.defineProperty(n,t,s),s},__param=this&&this.__param||function(e,n){return function(t,i){n(t,i,e)}};define(["require","exports","vs/base/common/uri","vs/base/common/event","child_process","vs/nls","os","path","vs/base/common/platform","vs/editor/common/editorCommon","vs/editor/common/services/codeEditorService","vs/platform/configuration/common/configuration","vs/platform/keybinding/common/keybinding","vs/platform/message/common/message","vs/workbench/services/panel/common/panelService","vs/workbench/services/part/common/partService","vs/workbench/parts/terminal/electron-browser/terminal","vs/platform/workspace/common/workspace","vs/base/common/winjs.base","vs/workbench/parts/terminal/electron-browser/terminalConfigHelper"],function(e,n,t,i,r,o,s,a,c,l,h,m,v,u,p,f,d,g,T,I){"use strict";var P=function(){function n(e,n,t,r,o,s,a){this.codeEditorService=e,this.configurationService=n,this.keybindingService=t,this.messageService=r,this.panelService=o,this.partService=s,this.contextService=a,this.activeTerminalIndex=0,this.terminalProcesses=[],this._onActiveInstanceChanged=new i.Emitter,this._onInstancesChanged=new i.Emitter,this._onInstanceTitleChanged=new i.Emitter,this._terminalFocusContextKey=this.keybindingService.createKey(d.KEYBINDING_CONTEXT_TERMINAL_FOCUS,void 0)}return Object.defineProperty(n.prototype,"onActiveInstanceChanged",{get:function(){return this._onActiveInstanceChanged.event},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"onInstancesChanged",{get:function(){return this._onInstancesChanged.event},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"onInstanceTitleChanged",{get:function(){return this._onInstanceTitleChanged.event},enumerable:!0,configurable:!0}),n.prototype.setActiveTerminal=function(e){var n=this;return this.focus().then(function(){return n.showAndGetTerminalPanel().then(function(t){n.activeTerminalIndex=e,t.setActiveTerminal(n.activeTerminalIndex),t.focus(),n._onActiveInstanceChanged.fire()})})},n.prototype.focus=function(){return this.panelService.openPanel(d.TERMINAL_PANEL_ID,!0)},n.prototype.focusNext=function(){var e=this;return this.focus().then(function(){return e.showAndGetTerminalPanel().then(function(n){e.terminalProcesses.length<=1||(e.activeTerminalIndex++,e.activeTerminalIndex>=e.terminalProcesses.length&&(e.activeTerminalIndex=0),n.setActiveTerminal(e.activeTerminalIndex),n.focus(),e._onActiveInstanceChanged.fire())})})},n.prototype.focusPrevious=function(){var e=this;return this.focus().then(function(){return e.showAndGetTerminalPanel().then(function(n){e.terminalProcesses.length<=1||(e.activeTerminalIndex--,e.activeTerminalIndex<0&&(e.activeTerminalIndex=e.terminalProcesses.length-1),n.setActiveTerminal(e.activeTerminalIndex),n.focus(),e._onActiveInstanceChanged.fire())})})},n.prototype.runSelectedText=function(){var e=this;return this.showAndGetTerminalPanel().then(function(n){var t=e.codeEditorService.getFocusedCodeEditor(),i=t.getModel().getValueInRange(t.getSelection(),"\n"===s.EOL?l.EndOfLinePreference.LF:l.EndOfLinePreference.CRLF),r=i+(i.substr(i.length-s.EOL.length)===s.EOL?"":s.EOL);e.terminalProcesses[e.activeTerminalIndex].process.send({event:"input",data:r})})},n.prototype.toggle=function(){var e=this.panelService.getActivePanel();return e&&e.getId()===d.TERMINAL_PANEL_ID?(this.partService.setPanelHidden(!0),T.TPromise.as(null)):this.show()},n.prototype.show=function(){return this.panelService.openPanel(d.TERMINAL_PANEL_ID,!0)},n.prototype.hide=function(){var e=this.panelService.getActivePanel();return e&&e.getId()===d.TERMINAL_PANEL_ID&&this.partService.setPanelHidden(!0),T.TPromise.as(null)},n.prototype.createNew=function(){var e=this,n=this,t=this.terminalProcesses.length;return this.showAndGetTerminalPanel().then(function(i){if(!i)return T.TPromise.as(void 0);if(t===e.terminalProcesses.length)return n.initConfigHelper(i.getContainer()),i.createNewTerminalInstance(n.createTerminalProcess(),e._terminalFocusContextKey),n._onInstancesChanged.fire(),T.TPromise.as(void 0)})},n.prototype.close=function(){return this.showAndGetTerminalPanel().then(function(e){return e.closeActiveTerminal()})},n.prototype.copySelection=function(){return document.activeElement.classList.contains("xterm")?document.execCommand("copy"):this.messageService.show(u.Severity.Warning,o.localize("terminal.integrated.copySelection.noSelection","Cannot copy terminal selection when terminal does not have focus")),T.TPromise.as(void 0)},n.prototype.paste=function(){var e=this;return this.showAndGetTerminalPanel().then(function(n){e.focus().then(function(){document.execCommand("paste")})})},n.prototype.showAndGetTerminalPanel=function(){var e=this;return new T.TPromise(function(n){var t=e.panelService.getActivePanel();t&&t.getId()===d.TERMINAL_PANEL_ID?n(t):e.show().then(function(){t=e.panelService.getActivePanel(),n(t)})})},n.prototype.getActiveTerminalIndex=function(){return this.activeTerminalIndex},n.prototype.getTerminalInstanceTitles=function(){return this.terminalProcesses.map(function(e,n){return n+1+": "+e.title})},n.prototype.initConfigHelper=function(e){this.configHelper||(this.configHelper=new I.TerminalConfigHelper(c.platform,this.configurationService,e))},n.prototype.killTerminalProcess=function(e){e.process.connected&&(e.process.disconnect(),e.process.kill());var n=this.terminalProcesses.indexOf(e);if(n>=0){var t=n===this.getActiveTerminalIndex();this.getActiveTerminalIndex()>=n&&(this.activeTerminalIndex=Math.max(0,this.activeTerminalIndex-1)),this.terminalProcesses.splice(n,1),this._onInstancesChanged.fire(),t&&this._onActiveInstanceChanged.fire()}},n.prototype.createTerminalProcess=function(){var i=this,o=this.configHelper.isSetLocaleVariables()?c.locale:void 0,s=n.createTerminalEnv(process.env,this.configHelper.getShell(),this.contextService.getWorkspace(),o),l={title:"",process:r.fork("./terminalProcess",[],{env:s,cwd:t["default"].parse(a.dirname(e.toUrl("./terminalProcess"))).fsPath})};return this.terminalProcesses.push(l),this._onInstancesChanged.fire(),this.activeTerminalIndex=this.terminalProcesses.length-1,this._onActiveInstanceChanged.fire(),l.process.on("message",function(e){"title"===e.type&&(l.title=e.content,i._onInstanceTitleChanged.fire())}),l},n.createTerminalEnv=function(e,n,t,i){var r=this.cloneEnv(e);return r.PTYPID=process.pid.toString(),r.PTYSHELL=n.executable,n.args.forEach(function(e,n){r["PTYSHELLARG"+n]=e}),r.PTYCWD=t?t.resource.fsPath:s.homedir(),i&&(r.LANG=this.getLangEnvVariable(i)),r},n.cloneEnv=function(e){var n=Object.create(null);return Object.keys(e).forEach(function(t){n[t]=e[t]}),n},n.getLangEnvVariable=function(e){var n=e.split("-"),t=n.length;return t>1&&(n[t-1]=n[t-1].toUpperCase()),n.join("_")+".UTF-8"},n=__decorate([__param(0,h.ICodeEditorService),__param(1,m.IConfigurationService),__param(2,v.IKeybindingService),__param(3,u.IMessageService),__param(4,p.IPanelService),__param(5,f.IPartService),__param(6,g.IWorkspaceContextService)],n)}();n.TerminalService=P});