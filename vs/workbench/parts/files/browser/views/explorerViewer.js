var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},__decorate=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},__param=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};define(["require","exports","vs/base/common/winjs.base","vs/nls","vs/base/common/lifecycle","vs/base/common/objects","vs/base/browser/dom","vs/base/common/uri","vs/base/common/mime","vs/base/common/async","vs/base/common/paths","vs/base/common/errors","vs/base/common/types","vs/base/common/actions","vs/base/common/comparers","vs/base/browser/ui/inputbox/inputBox","vs/base/browser/builder","vs/base/common/platform","vs/base/common/glob","vs/workbench/browser/actionBarRegistry","vs/workbench/parts/files/common/files","vs/platform/files/common/files","vs/workbench/parts/files/common/editors/fileEditorInput","vs/workbench/parts/files/browser/fileActions","vs/workbench/common/editor","vs/base/parts/tree/browser/tree","vs/base/common/labels","vs/base/parts/tree/browser/treeDnd","vs/base/parts/tree/browser/treeDefaults","vs/base/parts/tree/browser/actionsRenderer","vs/workbench/parts/files/common/explorerViewModel","vs/workbench/services/editor/common/editorService","vs/workbench/services/part/common/partService","vs/workbench/services/workspace/common/contextService","vs/platform/configuration/common/configuration","vs/platform/keybinding/common/keybinding","vs/platform/contextview/browser/contextView","vs/platform/event/common/event","vs/platform/instantiation/common/instantiation","vs/platform/message/common/message","vs/platform/progress/common/progress","vs/platform/telemetry/common/telemetry","vs/base/common/keyCodes","vs/platform/actions/common/actions","vs/platform/actions/browser/menuItemActionItem"],function(e,t,r,i,n,o,s,a,c,l,u,p,h,d,v,f,m,g,y,S,b,_,D,E,C,w,A,x,P,R,F,T,I,O,k,M,K,L,B,N,V,U,W,j,G){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var H=function(){function e(e,t,r,i,n){this.progressService=e,this.messageService=t,this.fileService=r,this.partService=i,this.workspace=n.getWorkspace()}return e.prototype.getId=function(e,t){return t.getId()},e.prototype.hasChildren=function(e,t){return t.isDirectory},e.prototype.getChildren=function(e,t){var i=this;if(t.isDirectoryResolved)return r.TPromise.as(t.children);var n=this.fileService.resolveFile(t.resource,{resolveSingleChildDescendants:!0}).then(function(e){for(var r=F.FileStat.create(e),i=0;i<r.children.length;i++)t.addChild(r.children[i]);return t.isDirectoryResolved=!0,t.children},function(e){return i.messageService.show(N.Severity.Error,e),[]});return this.progressService.showWhile(n,this.partService.isCreated()?800:3200),n},e.prototype.getParent=function(e,t){return t?this.workspace&&t.resource.toString()===this.workspace.resource.toString()?r.TPromise.as(null):t.parent?r.TPromise.as(t.parent):r.TPromise.as(null):r.TPromise.as(null)},e=__decorate([__param(0,V.IProgressService),__param(1,N.IMessageService),__param(2,_.IFileService),__param(3,I.IPartService),__param(4,O.IWorkspaceContextService)],e)}();t.FileDataSource=H;var z=function(e){function t(t){e.call(this),this.state=t}return __extends(t,e),t.prototype.hasActions=function(t,r){return!(r instanceof F.NewStatPlaceholder)&&e.prototype.hasActions.call(this,t,r)},t.prototype.getActions=function(t,i){return i instanceof F.NewStatPlaceholder?r.TPromise.as([]):e.prototype.getActions.call(this,t,i)},t.prototype.hasSecondaryActions=function(t,r){return!(r instanceof F.NewStatPlaceholder)&&e.prototype.hasSecondaryActions.call(this,t,r)},t.prototype.getSecondaryActions=function(t,i){return i instanceof F.NewStatPlaceholder?r.TPromise.as([]):e.prototype.getSecondaryActions.call(this,t,i)},t.prototype.runAction=function(e,t,i,n){var s=this;if(void 0===n&&(n={}),n=o.mixin({viewletState:this.state,stat:t},n),!h.isString(i)){var a=i;return a.enabled?a.run(n):null}var c=i,l=this.hasActions(e,t)?this.getActions(e,t):r.TPromise.as([]);return l.then(function(i){for(var o=0,a=i.length;o<a;o++)if(i[o].id===c&&i[o].enabled)return i[o].run(n);return l=s.hasSecondaryActions(e,t)?s.getSecondaryActions(e,t):r.TPromise.as([]),l.then(function(e){for(var t=0,r=e.length;t<r;t++)if(e[t].id===c&&e[t].enabled)return e[t].run(n);return null})})},t}(S.ContributableActionProvider);t.FileActionProvider=z;var J=function(){function e(){this._actionProvider=new z(this),this.editableStats=Object.create(null)}return Object.defineProperty(e.prototype,"actionProvider",{get:function(){return this._actionProvider},enumerable:!0,configurable:!0}),e.prototype.getEditableData=function(e){return this.editableStats[e.resource&&e.resource.toString()]},e.prototype.setEditable=function(e,t){t&&(this.editableStats[e.resource&&e.resource.toString()]=t)},e.prototype.clearEditable=function(e){delete this.editableStats[e.resource&&e.resource.toString()]},e}();t.FileViewletState=J;var q=function(e){function t(t){e.call(this),this.viewletState=t}return __extends(t,e),t.prototype.run=function(t,r){return e.prototype.run.call(this,t,{viewletState:this.viewletState})},t}(d.ActionRunner);t.ActionRunner=q;var Y=function(e){function t(t,r,i){e.call(this,{actionProvider:t.actionProvider,actionRunner:r}),this.contextViewService=i,this.state=t}return __extends(t,e),t.prototype.getContentHeight=function(e,t){return 22},t.prototype.renderContents=function(e,t,r,o){var a=this,c=m.$(r).clearChildren(),u=m.$(".explorer-item").addClass(this.iconClass(t)).appendTo(c),p=this.state.getEditableData(t);if(!p){var h=m.$(".explorer-item-label").appendTo(u);return m.$("a.plain").text(t.name).title(t.resource.fsPath).appendTo(h),null}var d=new f.InputBox(u.getHTMLElement(),this.contextViewService,{validationOptions:{validation:p.validator,showMessage:!0},ariaLabel:i.localize("fileInputAriaLabel","Type file name. Press Enter to confirm or Escape to cancel.")}),v=t.name||"",g=v.lastIndexOf(".");d.value=v,d.select({start:0,end:g>0&&!t.isDirectory?g:v.length}),d.focus();var y=l.once(function(r){e.clearHighlight(),r&&d.value&&a.state.actionProvider.runAction(e,t,p.action,{value:d.value}),setTimeout(function(){e.DOMFocus(),n.dispose(S)},0)}),S=[d,s.addStandardDisposableListener(d.inputElement,s.EventType.KEY_DOWN,function(e){e.equals(W.CommonKeybindings.ENTER)?d.validate()&&y(!0):e.equals(W.CommonKeybindings.ESCAPE)&&y(!1)}),s.addDisposableListener(d.inputElement,"blur",function(){y(d.isInputValid())})];return function(){return y(!0)}},t.prototype.iconClass=function(e){return e.isDirectory?"folder-icon":"text-file-icon"},t=__decorate([__param(2,K.IContextViewService)],t)}(R.ActionsRenderer);t.FileRenderer=Y;var $=function(){function e(){}return e.prototype.getAriaLabel=function(e,t){return i.localize("filesExplorerViewerAriaLabel","{0}, Files Explorer",t.name)},e}();t.FileAccessibilityProvider=$;var Q=function(e){function t(t,r,i,n,o,s,a,c,l,u){e.call(this,{clickBehavior:P.ClickBehavior.ON_MOUSE_DOWN}),this.editorService=r,this.textFileService=i,this.contextMenuService=n,this.eventService=o,this.instantiationService=s,this.telemetryService=a,this.contextService=c,this.contributedContextMenu=l.createMenu(j.MenuId.ExplorerContext,u),this.workspace=c.getWorkspace(),this.didCatchEnterDown=!1,this.downKeyBindingDispatcher.set(g.isMacintosh?W.CommonKeybindings.CTRLCMD_DOWN_ARROW:W.CommonKeybindings.ENTER,this.onEnterDown.bind(this)),this.upKeyBindingDispatcher.set(g.isMacintosh?W.CommonKeybindings.CTRLCMD_DOWN_ARROW:W.CommonKeybindings.ENTER,this.onEnterUp.bind(this)),g.isMacintosh?this.upKeyBindingDispatcher.set(W.CommonKeybindings.WINCTRL_ENTER,this.onModifierEnterUp.bind(this)):this.upKeyBindingDispatcher.set(W.CommonKeybindings.CTRLCMD_ENTER,this.onModifierEnterUp.bind(this)),this.downKeyBindingDispatcher.set(g.isMacintosh?W.CommonKeybindings.ENTER:W.CommonKeybindings.F2,this.onF2.bind(this)),this.downKeyBindingDispatcher.set(W.CommonKeybindings.CTRLCMD_C,this.onCopy.bind(this)),this.downKeyBindingDispatcher.set(W.CommonKeybindings.CTRLCMD_V,this.onPaste.bind(this)),g.isMacintosh?(this.downKeyBindingDispatcher.set(W.CommonKeybindings.CTRLCMD_UP_ARROW,this.onLeft.bind(this)),this.downKeyBindingDispatcher.set(W.CommonKeybindings.CTRLCMD_BACKSPACE,this.onDelete.bind(this))):(this.downKeyBindingDispatcher.set(W.CommonKeybindings.DELETE,this.onDelete.bind(this)),this.downKeyBindingDispatcher.set(W.CommonKeybindings.SHIFT_DELETE,this.onDelete.bind(this))),this.state=t}return __extends(t,e),t.prototype.onLeftClick=function(e,t,r,i){void 0===i&&(i="mouse");var n={origin:i},o="mouse"===i&&2===r.detail;if(e.getHighlight())return r.preventDefault(),r.stopPropagation(),e.clearHighlight(n),!1;if(this.workspace&&t.resource.toString()===this.workspace.resource.toString())return e.clearFocus(n),e.clearSelection(n),!1;var s=r&&r.browserEvent&&"mousedown"===r.browserEvent.type;if(s||r.preventDefault(),r.stopPropagation(),e.DOMFocus(),e.toggleExpansion(t),!r.shiftKey||t instanceof F.NewStatPlaceholder){if(!(t instanceof F.NewStatPlaceholder)){var a=!o;e.setFocus(t,n),o&&r.preventDefault(),t.isDirectory||(e.setSelection([t],n),this.openEditor(t,a,r&&(r.ctrlKey||r.metaKey),o))}}else{var c=e.getSelection();c&&c.length>0&&c[0]===t&&e.clearSelection(n)}return!0},t.prototype.onContextMenu=function(e,t,r){var i=this;if(r.target&&r.target.tagName&&"input"===r.target.tagName.toLowerCase())return!1;if(r.preventDefault(),r.stopPropagation(),e.setFocus(t),!this.state.actionProvider.hasSecondaryActions(e,t))return!0;var n={x:r.posx+1,y:r.posy};return this.contextMenuService.showContextMenu({getAnchor:function(){return n},getActions:function(){return i.state.actionProvider.getSecondaryActions(e,t).then(function(e){return G.fillInActions(i.contributedContextMenu,e),e})},getActionItem:this.state.actionProvider.getActionItem.bind(this.state.actionProvider,e,t),getKeyBinding:function(e){return E.keybindingForAction(e.id)},getActionsContext:function(){return{viewletState:i.state,stat:t}},onHide:function(t){t&&e.DOMFocus()}}),!0},t.prototype.onEnterDown=function(e,t){if(e.getHighlight())return!1;var r={origin:"keyboard"},i=e.getFocus();return i&&(i.isDirectory?e.toggleExpansion(i):(e.setFocus(i,r),this.openEditor(i,!1,!1))),this.didCatchEnterDown=!0,!0},t.prototype.onEnterUp=function(e,t){if(!this.didCatchEnterDown||e.getHighlight())return!1;var r=e.getFocus();return r&&!r.isDirectory&&this.openEditor(r,!1,!1),this.didCatchEnterDown=!1,!0},t.prototype.onModifierEnterUp=function(e,t){if(e.getHighlight())return!1;var r=e.getFocus();return r&&!r.isDirectory&&this.openEditor(r,!1,!0),this.didCatchEnterDown=!1,!0},t.prototype.onCopy=function(e,t){var r=e.getFocus();return!!r&&(this.runAction(e,r,"workbench.files.action.copyFile").done(),!0)},t.prototype.onPaste=function(e,t){var r=e.getFocus()||e.getInput();if(r){var i=this.instantiationService.createInstance(E.PasteFileAction,e,r);if(i._isEnabled())return i.run().done(null,p.onUnexpectedError),!0}return!1},t.prototype.openEditor=function(e,t,r,i){if(void 0===i&&(i=!1),e&&!e.isDirectory){this.telemetryService.publicLog("workbenchActionExecuted",{id:"workbench.files.openFile",from:"explorer"});var n=this.instantiationService.createInstance(D.FileEditorInput,e.resource,e.mime,void 0);this.editorService.openEditor(n,{preserveFocus:t,pinned:i},r).done(null,p.onUnexpectedError)}},t.prototype.onF2=function(e,t){var r=e.getFocus();return!!r&&(this.runAction(e,r,"workbench.files.action.triggerRename").done(),!0)},t.prototype.onDelete=function(e,t){var r=!t.shiftKey,i=e.getFocus();return!!i&&(this.runAction(e,i,r?"workbench.files.action.moveFileToTrash":"workbench.files.action.deleteFile").done(),!0)},t.prototype.runAction=function(e,t,r){return this.state.actionProvider.runAction(e,t,r)},t=__decorate([__param(1,T.IWorkbenchEditorService),__param(2,b.ITextFileService),__param(3,K.IContextMenuService),__param(4,L.IEventService),__param(5,B.IInstantiationService),__param(6,U.ITelemetryService),__param(7,O.IWorkspaceContextService),__param(8,j.IMenuService),__param(9,M.IKeybindingService)],t)}(P.DefaultController);t.FileController=Q;var X=function(){function e(){}return e.prototype.compare=function(e,t,r){return t.isDirectory&&!r.isDirectory?-1:r.isDirectory&&!t.isDirectory?1:t.isDirectory&&r.isDirectory?t.name.toLowerCase().localeCompare(r.name.toLowerCase()):t instanceof F.NewStatPlaceholder?-1:r instanceof F.NewStatPlaceholder?1:v.compareFileNames(t.name,r.name)},e}();t.FileSorter=X;var Z=function(){function e(e){this.contextService=e,this.hiddenExpression=Object.create(null)}return e.prototype.updateConfiguration=function(e){var t=e&&e.files&&e.files.exclude||Object.create(null),r=!o.equals(this.hiddenExpression,t);return this.hiddenExpression=o.clone(t),r},e.prototype.isVisible=function(e,t){return this.doIsVisible(t)},e.prototype.doIsVisible=function(e){if(e instanceof F.NewStatPlaceholder)return!0;var t=e.parent&&e.parent.children&&e.parent.children.map(function(e){return e.name});return!y.match(this.hiddenExpression,this.contextService.toWorkspaceRelativePath(e.resource),t)},e=__decorate([__param(0,O.IWorkspaceContextService)],e)}();t.FileFilter=Z;var ee=function(){function e(e,t,r,i,n,o,s,a){this.messageService=e,this.contextService=t,this.eventService=r,this.progressService=i,this.fileService=n,this.configurationService=o,this.instantiationService=s,this.textFileService=a,this.toDispose=[],this.onConfigurationUpdated(o.getConfiguration()),this.registerListeners()}return e.prototype.registerListeners=function(){var e=this;this.toDispose.push(this.configurationService.onDidUpdateConfiguration(function(t){return e.onConfigurationUpdated(t.config)}))},e.prototype.onConfigurationUpdated=function(e){this.dropEnabled=e&&e.explorer&&e.explorer.enableDragAndDrop},e.prototype.getDragURI=function(e,t){return t.resource&&t.resource.toString()},e.prototype.onDragStart=function(e,t,r){var i=t.getData(),n=null;i.length>0&&(n=i[0]),n&&n.isDirectory&&e.isExpanded(n)&&e.collapse(n,!1),t instanceof x.DesktopDragAndDropData||n&&!n.isDirectory&&r.dataTransfer.setData("DownloadURL",[c.MIME_BINARY,n.name,n.resource.toString()].join(":"))},e.prototype.onDragOver=function(e,t,r,i){if(!this.dropEnabled)return w.DRAG_OVER_REJECT;var n=i&&(i.ctrlKey&&!g.isMacintosh||i.altKey&&g.isMacintosh),o=t instanceof x.DesktopDragAndDropData;if(o){for(var s=t.getData(),a=s.types,c=[],l=0;l<a.length;l++)c.push(a[l]);if(0===c.length||!c.some(function(e){return"Files"===e}))return w.DRAG_OVER_REJECT}else{if(t instanceof x.ExternalElementsDragAndDropData)return w.DRAG_OVER_REJECT;var p=t.getData();if(!Array.isArray(p))return w.DRAG_OVER_REJECT;if(p.some(function(e){return e instanceof F.NewStatPlaceholder||(e.resource.toString()===r.resource.toString()||(!n&&u.dirname(e.resource.fsPath)===r.resource.fsPath||!!u.isEqualOrParent(r.resource.fsPath,e.resource.fsPath)))}))return w.DRAG_OVER_REJECT}return r.isDirectory?o||n?w.DRAG_OVER_ACCEPT_BUBBLE_DOWN_COPY:w.DRAG_OVER_ACCEPT_BUBBLE_DOWN:r.resource.toString()!==this.contextService.getWorkspace().resource.toString()?o||n?w.DRAG_OVER_ACCEPT_BUBBLE_UP_COPY:w.DRAG_OVER_ACCEPT_BUBBLE_UP:w.DRAG_OVER_REJECT},e.prototype.drop=function(e,t,n,o){var s=this,c=r.TPromise.as(null);if(t instanceof x.DesktopDragAndDropData){var l=this.instantiationService.createInstance(E.ImportFileAction,e,n,null);c=l.run({input:{files:t.getData().files}})}else{var h=t.getData()[0],d=o.ctrlKey&&!g.isMacintosh||o.altKey&&g.isMacintosh;c=e.expand(n).then(function(){if(d){var t=s.instantiationService.createInstance(E.DuplicateFileAction,e,h,n);return t.run()}var o=r.TPromise.as(null);if(s.textFileService.isDirty(h.resource)){var c=s.textFileService.confirmSave([h.resource]);if(c===C.ConfirmResult.SAVE)o=s.textFileService.save(h.resource);else if(c===C.ConfirmResult.DONT_SAVE)o=s.textFileService.revert(h.resource);else if(c===C.ConfirmResult.CANCEL)return r.TPromise.as(null)}return o.then(function(){if(s.textFileService.isDirty(h.resource))return s.messageService.show(N.Severity.Warning,i.localize("warningFileDirty","File '{0}' is currently being saved, please try again later.",A.getPathLabel(h.resource))),r.TPromise.as(null);var e=a["default"].file(u.join(n.resource.fsPath,h.name)),t=!1,o=function(e){s.eventService.emit("files.internal:fileChanged",new b.LocalFileChangeEvent(h.clone(),e))};return s.fileService.moveFile(h.resource,e).then(o,function(r){if(r.fileOperationResult!==_.FileOperationResult.FILE_MOVE_CONFLICT)s.messageService.show(N.Severity.Error,r);else{t=!0;var n={message:i.localize("confirmOverwriteMessage","'{0}' already exists in the destination folder. Do you want to replace it?",h.name),detail:i.localize("irreversible","This action is irreversible!"),primaryButton:i.localize({key:"replaceButtonLabel",comment:["&& denotes a mnemonic"]},"&&Replace")};if(s.messageService.confirm(n))return s.fileService.moveFile(h.resource,e,!0).then(function(t){var r=new F.FileStat(e);s.eventService.emit("files.internal:fileChanged",new b.LocalFileChangeEvent(r,null)),o(t)},function(e){s.messageService.show(N.Severity.Error,e)})}})})},p.onUnexpectedError)}this.progressService.showWhile(c,800),c.done(null,p.onUnexpectedError)},e=__decorate([__param(0,N.IMessageService),__param(1,O.IWorkspaceContextService),__param(2,L.IEventService),__param(3,V.IProgressService),__param(4,_.IFileService),__param(5,k.IConfigurationService),__param(6,B.IInstantiationService),__param(7,b.ITextFileService)],e)}();t.FileDragAndDrop=ee});