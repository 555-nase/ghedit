var __extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)},__decorate=this&&this.__decorate||function(e,t,i,o){var n,r=arguments.length,s=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(r<3?n(s):r>3?n(t,i,s):n(t,i))||s);return r>3&&s&&Object.defineProperty(t,i,s),s},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}};define(["require","exports","vs/base/common/winjs.base","vs/nls","vs/base/common/errors","vs/base/common/paths","vs/base/common/actions","vs/base/common/uri","vs/base/common/mime","vs/workbench/common/editor/resourceEditorInput","vs/workbench/common/editor/diffEditorInput","vs/workbench/parts/files/common/editors/fileEditorInput","vs/workbench/parts/files/browser/fileActions","vs/platform/files/common/files","vs/workbench/services/editor/common/editorService","vs/platform/event/common/event","vs/workbench/parts/files/common/files","vs/platform/instantiation/common/instantiation","vs/platform/message/common/message","vs/platform/workspace/common/workspace","vs/editor/common/services/modeService","vs/editor/common/services/modelService"],function(e,t,i,o,n,r,s,a,c,l,v,u,d,h,p,f,m,S,g,_,I,E){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var w=function(){function e(e,t,i){this.messageService=e,this.eventService=t,this.instantiationService=i,this.messages=Object.create(null),this.registerListeners()}return e.prototype.registerListeners=function(){var e=this;this.eventService.addListener2(m.EventType.FILE_SAVED,function(t){return e.onFileSavedOrReverted(t.resource)}),this.eventService.addListener2(m.EventType.FILE_REVERTED,function(t){return e.onFileSavedOrReverted(t.resource)})},e.prototype.onFileSavedOrReverted=function(e){var t=this.messages[e.toString()];t&&(t(),this.messages[e.toString()]=void 0)},e.prototype.onSaveError=function(e,t){var a,c=this,l=t.getResource();if(e.fileOperationResult===h.FileOperationResult.FILE_MODIFIED_SINCE)a=this.instantiationService.createInstance(b,t,null);else{var v=e.fileOperationResult===h.FileOperationResult.FILE_READ_ONLY,u=[];u.push(g.CancelAction),v?u.push(new s.Action("workbench.files.action.overwrite",o.localize("overwrite","Overwrite"),null,(!0),function(){return t.isDisposed()?i.TPromise.as(!0):t.save(!0).then(function(){return!0})})):u.push(new s.Action("workbench.files.action.retry",o.localize("retry","Retry"),null,(!0),function(){var e=c.instantiationService.createInstance(d.SaveFileAction,d.SaveFileAction.ID,d.SaveFileAction.LABEL);return e.setResource(l),e.run().then(function(){return e.dispose(),!0})})),u.push(new s.Action("workbench.files.action.discard",o.localize("discard","Discard"),null,(!0),function(){var e=c.instantiationService.createInstance(d.RevertFileAction,d.RevertFileAction.ID,d.RevertFileAction.LABEL);return e.setResource(l),e.run().then(function(){return e.dispose(),!0})})),u.push(new s.Action("workbench.files.action.saveAs",d.SaveFileAsAction.LABEL,null,(!0),function(){var e=c.instantiationService.createInstance(d.SaveFileAsAction,d.SaveFileAsAction.ID,d.SaveFileAsAction.LABEL);return e.setResource(l),e.run().then(function(){return e.dispose(),!0})}));var p=void 0;p=v?o.localize("readonlySaveError","Failed to save '{0}': File is write protected. Select 'Overwrite' to remove protection.",r.basename(l.fsPath)):o.localize("genericSaveError","Failed to save '{0}': {1}",r.basename(l.fsPath),n.toErrorMessage(e,!1)),a={message:p,actions:u}}this.messages[t.getResource().toString()]=this.messageService.show(g.Severity.Error,a)},e=__decorate([__param(0,g.IMessageService),__param(1,f.IEventService),__param(2,S.IInstantiationService)],e)}();t.SaveErrorHandler=w;var R=function(e){function t(t,i,o,n,r){e.call(this,i,o,n,r),this.model=t}return __extends(t,e),t.prototype.getModel=function(){return this.model},t.prototype.getTypeId=function(){return t.ID},t.ID="workbench.editors.files.conflictResolutionDiffEditorInput",t}(v.DiffEditorInput);t.ConflictResolutionDiffEditorInput=R;var y=function(e){function t(t,i,o,n,r,s,c,l,v){e.call(this,o,n,a["default"].from({scheme:"disk",path:t.fsPath}),r,c),this.modeService=s,this.fileService=l,this.textFileService=v,this.fileResource=t,this.mime=i}return __extends(t,e),t.prototype.getLastModified=function(){return this.lastModified},t.prototype.resolve=function(t){var i=this;return this.textFileService.resolveTextContent(this.fileResource).then(function(o){i.lastModified=o.mtime;var n=i.modelService.getModel(i.resource);return n?n.setValueFromRawText(o.value):(i.modelService.createModel(o.value,i.modeService.getOrCreateMode(i.mime),i.resource),i.createdEditorModel=!0),e.prototype.resolve.call(i,t)})},t.prototype.dispose=function(){this.createdEditorModel&&(this.modelService.destroyModel(this.resource),this.createdEditorModel=!1),e.prototype.dispose.call(this)},t=__decorate([__param(4,E.IModelService),__param(5,I.IModeService),__param(6,S.IInstantiationService),__param(7,h.IFileService),__param(8,m.ITextFileService)],t)}(l.ResourceEditorInput);t.FileOnDiskEditorInput=y;var b=function(){function e(e,t,n,a,l,v){var d=this;this.messageService=n,this.instantiationService=a,this.contextService=l,this.editorService=v,this.model=e;var h=e.getResource();t?this.message=t:this.message=o.localize("staleSaveError","Failed to save '{0}': The content on disk is newer. Click on **Compare** to compare your version with the one on disk.",r.basename(h.fsPath)),this.actions=[new s.Action("workbench.files.action.resolveConflict",o.localize("compareChanges","Compare"),null,(!0),function(){if(!d.model.isDisposed()){var e=c.guessMimeTypes(h.fsPath).join(", "),t=d.instantiationService.createInstance(y,h,e,r.basename(h.fsPath),h.fsPath),n=d.instantiationService.createInstance(u.FileEditorInput,h,e,void 0),s=d.instantiationService.createInstance(R,d.model,o.localize("saveConflictDiffLabel","{0} - on disk â†” in {1}",n.getName(),d.contextService.getConfiguration().env.appName),o.localize("resolveSaveConflict","{0} - Resolve save conflict",n.getDescription()),t,n);return d.editorService.openEditor(s).then(function(e){d.model.setConflictResolutionMode(),d.messageService.show(g.Severity.Info,{message:o.localize("userGuide","Please either select **Revert** to discard your changes or **Overwrite** to replace the content on disk with your changes"),actions:[d.instantiationService.createInstance(F,s,e.position),d.instantiationService.createInstance(A,s,e.position)]})})}return i.TPromise.as(!0)})]}return e=__decorate([__param(2,g.IMessageService),__param(3,S.IInstantiationService),__param(4,_.IWorkspaceContextService),__param(5,p.IWorkbenchEditorService)],e)}(),F=function(e){function t(t,i,n,r,s){e.call(this,"workbench.files.action.acceptLocalChanges",o.localize("acceptLocalChanges","Overwrite"),"conflict-editor-action accept-changes"),this.input=t,this.position=i,this.messageService=n,this.instantiationService=r,this.editorService=s,this.messagesToHide=[]}return __extends(t,e),t.prototype.run=function(){var e=this,t=this.input,i=t.getModel(),n=i.getValue();return t.resolve(!1).then(function(r){var s=t.originalInput.getLastModified();return i.revert().then(function(){var r=i.getLastModifiedTime();return r<=s?(i.textEditorModel.setValue(n),i.save().then(function(){for(;e.messagesToHide.length;)e.messagesToHide.pop()();var o=e.instantiationService.createInstance(u.FileEditorInput,i.getResource(),c.guessMimeTypes(i.getResource().fsPath).join(", "),void 0);return e.editorService.openEditor(o,null,e.position).then(function(){t.dispose()})})):(i.setConflictResolutionMode(),i.textEditorModel.setValue(n),t.originalInput.resolve(!0).then(function(){e.messagesToHide.push(e.messageService.show(g.Severity.Info,o.localize("conflictingFileHasChanged","The content of the file on disk has changed and the left hand side of the compare editor was refreshed. Please review and resolve again.")))}))})})},t=__decorate([__param(2,g.IMessageService),__param(3,S.IInstantiationService),__param(4,p.IWorkbenchEditorService)],t)}(s.Action);t.AcceptLocalChangesAction=F;var A=function(e){function t(t,i,n,r){e.call(this,"workbench.action.files.revert",o.localize("revertLocalChanges","Revert"),"conflict-editor-action revert-changes"),this.input=t,this.position=i,this.instantiationService=n,this.editorService=r}return __extends(t,e),t.prototype.run=function(){var e=this,t=this.input,i=t.getModel();return i.revert().then(function(){var o=e.instantiationService.createInstance(u.FileEditorInput,i.getResource(),c.guessMimeTypes(i.getResource().fsPath).join(", "),void 0);return e.editorService.openEditor(o,null,e.position).then(function(){t.dispose()})})},t=__decorate([__param(2,S.IInstantiationService),__param(3,p.IWorkbenchEditorService)],t)}(s.Action);t.RevertLocalChangesAction=A});