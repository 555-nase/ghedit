var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)},__decorate=this&&this.__decorate||function(e,t,o,r){var i,n=arguments.length,s=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,r);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(n<3?i(s):n>3?i(t,o,s):i(t,o))||s);return n>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};define(["require","exports","vs/base/common/winjs.base","vs/nls","vs/base/common/errors","vs/base/common/mime","vs/base/common/types","vs/base/common/paths","vs/base/common/actions","vs/workbench/common/memento","vs/workbench/parts/files/common/files","vs/workbench/parts/files/browser/saveErrorHandler","vs/workbench/browser/parts/editor/textEditor","vs/workbench/parts/files/common/editors/textFileEditorModel","vs/workbench/common/editor/binaryEditorModel","vs/workbench/parts/files/common/editors/fileEditorInput","vs/workbench/services/viewlet/common/viewletService","vs/platform/files/common/files","vs/platform/telemetry/common/telemetry","vs/workbench/services/workspace/common/contextService","vs/platform/storage/common/storage","vs/platform/configuration/common/configuration","vs/platform/event/common/event","vs/platform/instantiation/common/instantiation","vs/platform/message/common/message","vs/workbench/services/editor/common/editorService","vs/editor/common/services/modeService","vs/workbench/services/themes/common/themeService"],function(e,t,o,r,i,n,s,a,c,l,p,u,d,v,m,f,h,E,g,S,_,I,w,y,b,x,T,F){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var R="textEditorViewState",M=function(e){function t(o,r,i,n,s,a,c,l,p,d,m,f){var h=this;e.call(this,t.ID,o,n,s,a,c,l,p,d,m,f),this.fileService=r,this.viewletService=i,v.TextFileEditorModel.setSaveErrorHandler(n.createInstance(u.SaveErrorHandler)),this.toUnbind.push(this.eventService.addListener2(E.EventType.FILE_CHANGES,function(e){return h.onFilesChanged(e)}))}return __extends(t,e),t.prototype.onFilesChanged=function(e){var t=e.getDeleted();t&&t.length&&this.clearTextEditorViewState(this.storageService,t.map(function(e){return e.resource.toString()}))},t.prototype.getTitle=function(){return this.getInput()?this.getInput().getName():r.localize("textFileEditor","Text File Editor")},t.prototype.setInput=function(t,l){var p=this,u=this.getInput();e.prototype.setInput.call(this,t,l);var d=l&&l.forceOpen;return!d&&t.matches(u)?(l&&s.isFunction(l.apply)&&l.apply(this.getControl()),o.TPromise.as(null)):(u&&this.saveTextEditorViewState(this.storageService,u.getResource().toString()),this.editorService.resolveEditorModel(t,!0).then(function(e){if(e instanceof m.BinaryEditorModel&&p.openAsBinary(t,l))return null;if(!(e instanceof v.TextFileEditorModel))return o.TPromise.wrapError("Invalid editor input. Text file editor requires a model instance of TextFileEditorModel.");var r=e,i=p.getControl();if(!r.textEditorModel)return o.TPromise.wrapError("Unable to open the file because the associated text model is undefined.");if(!p.getInput()||p.getInput().getResource().toString()!==r.getResource().toString())return null;var n=r.textEditorModel.getMode(),a=p.telemetryService.timedPublicLog("editorSetModel",{mode:n&&n.getId(),resource:r.textEditorModel.uri.toString()});i.setModel(r.textEditorModel),a.stop();var c=!1;if(l&&s.isFunction(l.apply)&&(c=l.apply(i)),!c){var u=p.loadTextEditorViewState(p.storageService,p.getInput().getResource().toString());u&&i.restoreViewState(u)}},function(e){if(!(e.fileOperationResult===E.FileOperationResult.FILE_IS_BINARY&&p.openAsBinary(t,l)||e.fileOperationResult===E.FileOperationResult.FILE_IS_DIRECTORY&&p.openAsFolder(t)))return e.fileOperationResult===E.FileOperationResult.FILE_NOT_FOUND&&a.isValidBasename(a.basename(t.getResource().fsPath))?o.TPromise.wrapError(i.create(i.toErrorMessage(e),{actions:[b.CancelAction,new c.Action("workbench.files.action.createMissingFile",r.localize("createFile","Create File"),null,(!0),function(){return p.fileService.updateContent(t.getResource(),"").then(function(){return p.editorService.openEditor({resource:t.getResource(),mime:n.MIME_TEXT,options:{pinned:!0}})})})]})):o.TPromise.wrapError(e)}))},t.prototype.openAsBinary=function(e,t){if(e instanceof f.FileEditorInput){var o=e,r=this.instantiationService.createInstance(f.FileEditorInput,o.getResource(),n.MIME_BINARY,void 0);return this.editorService.openEditor(r,t,this.position).done(null,i.onUnexpectedError),!0}return!1},t.prototype.openAsFolder=function(e){var t=this;return this.editorService.closeEditor(this.position,this.input).done(function(){if(e instanceof f.FileEditorInput){var o=e;t.contextService.isInsideWorkspace(o.getResource())&&t.viewletService.openViewlet(p.VIEWLET_ID,!0).done(function(e){return e.getExplorerView().select(o.getResource(),!0)},i.onUnexpectedError)}},i.onUnexpectedError),!0},t.prototype.getCodeEditorOptions=function(){var t=e.prototype.getCodeEditorOptions.call(this),o=this.getInput(),i=o&&o.getName();return t.ariaLabel=i?r.localize("fileEditorWithInputAriaLabel","{0}. Text file editor.",i):r.localize("fileEditorAriaLabel","Text file editor."),t},t.prototype.saveTextEditorViewState=function(e,t){var o=this.getMemento(e,l.Scope.WORKSPACE),r=o[R];r||(r=Object.create(null),o[R]=r);var i=this.getControl().saveViewState(),n=r[t];n||(n=Object.create(null),r[t]=n),"number"==typeof this.position&&(n[this.position]=i)},t.prototype.clearTextEditorViewState=function(e,t){var o=this.getMemento(e,l.Scope.WORKSPACE),r=o[R];r&&t.forEach(function(e){return delete r[e]})},t.prototype.loadTextEditorViewState=function(e,t){var o=this.getMemento(e,l.Scope.WORKSPACE),r=o[R];if(r){var i=r[t];if(i)return i[this.position]}return null},t.prototype.clearInput=function(){this.input&&this.saveTextEditorViewState(this.storageService,this.input.getResource().toString()),this.getControl().setModel(null),e.prototype.clearInput.call(this)},t.prototype.shutdown=function(){this.input&&this.saveTextEditorViewState(this.storageService,this.input.getResource().toString()),e.prototype.shutdown.call(this)},t.ID=p.TEXT_FILE_EDITOR_ID,t=__decorate([__param(0,g.ITelemetryService),__param(1,E.IFileService),__param(2,h.IViewletService),__param(3,y.IInstantiationService),__param(4,S.IWorkspaceContextService),__param(5,_.IStorageService),__param(6,b.IMessageService),__param(7,I.IConfigurationService),__param(8,w.IEventService),__param(9,x.IWorkbenchEditorService),__param(10,T.IModeService),__param(11,F.IThemeService)],t)}(d.BaseTextEditor);t.TextFileEditor=M});