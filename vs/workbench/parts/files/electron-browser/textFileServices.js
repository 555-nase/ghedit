/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},__decorate=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},__param=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};define(["require","exports","vs/nls","vs/base/common/winjs.base","vs/base/common/paths","vs/base/common/strings","vs/base/common/platform","vs/base/common/uri","vs/workbench/common/editor","vs/platform/event/common/event","vs/workbench/parts/files/common/textFileServices","vs/workbench/parts/files/common/editors/textFileEditorModel","vs/workbench/parts/files/common/files","vs/workbench/services/untitled/common/untitledEditorService","vs/platform/files/common/files","vs/workbench/common/editor/binaryEditorModel","vs/platform/instantiation/common/instantiation","vs/workbench/services/workspace/common/contextService","vs/platform/lifecycle/common/lifecycle","vs/platform/telemetry/common/telemetry","vs/platform/configuration/common/configuration","vs/editor/common/services/modeService","vs/workbench/services/editor/common/editorService","vs/workbench/services/window/electron-browser/windowService","vs/workbench/services/group/common/groupService","vs/editor/common/services/modelService","vs/editor/node/model/modelBuilder"],function(e,t,r,i,n,o,s,a,c,l,u,v,h,m,f,p,d,g,S,y,_,w,A,E,b,F,C){"use strict";var x=function(e){function t(t,r,i,n,o,s,a,c,l,u,v,h,m){e.call(this,t,r,a,s,u,v,c,i,m),this.untitledEditorService=n,this.lifecycleService=o,this.modeService=l,this.windowService=h,this.init()}return __extends(t,e),t.prototype.registerListeners=function(){var t=this;e.prototype.registerListeners.call(this),this.lifecycleService.onWillShutdown(function(e){return e.veto(t.beforeShutdown())}),this.lifecycleService.onShutdown(this.onShutdown,this)},t.prototype.resolveTextContent=function(e,t){var r=this;return this.fileService.resolveStreamContent(e,t).then(function(e){return C.ModelBuilder.fromStringStream(e.value,r.modelService.getCreationOptions()).then(function(t){var r={resource:e.resource,name:e.name,mtime:e.mtime,etag:e.etag,mime:e.mime,encoding:e.encoding,value:t.rawText,valueLogicalHash:t.hash};return r})})},t.prototype.beforeShutdown=function(){var e=this;return!!this.getDirty().length&&(this.getAutoSaveMode()!==h.AutoSaveMode.OFF?this.saveAll(!1).then(function(){return!!e.getDirty().length&&e.confirmBeforeShutdown()}):this.confirmBeforeShutdown())},t.prototype.confirmBeforeShutdown=function(){var e=this.confirmSave();return e===c.ConfirmResult.SAVE?this.saveAll(!0).then(function(e){return!!e.results.some(function(e){return!e.success})}):e!==c.ConfirmResult.DONT_SAVE&&(e===c.ConfirmResult.CANCEL||void 0)},t.prototype.onShutdown=function(){e.prototype.dispose.call(this)},t.prototype.revertAll=function(t,r){var i=this;return e.prototype.revertAll.call(this,t,r).then(function(e){var r=i.untitledEditorService.revertAll(t);return r.forEach(function(t){return e.results.push({source:t,success:!0})}),e})},t.prototype.getDirty=function(t){var r=this,i=e.prototype.getDirty.call(this,t);if(t){var n=t.map(function(e){return r.untitledEditorService.get(e)}).filter(function(e){return e&&e.isDirty()}).map(function(e){return e.getResource()});i.push.apply(i,n)}else i.push.apply(i,this.untitledEditorService.getDirty());return i},t.prototype.isDirty=function(t){return!!e.prototype.isDirty.call(this,t)||this.untitledEditorService.getDirty().some(function(e){return!t||e.toString()===t.toString()})},t.prototype.confirmSave=function(e){if(this.contextService.getConfiguration().env.extensionDevelopmentPath)return c.ConfirmResult.DONT_SAVE;var i=this.getDirty(e);if(0===i.length)return c.ConfirmResult.DONT_SAVE;var o=[1===i.length?r.localize("saveChangesMessage","Do you want to save the changes you made to {0}?",n.basename(i[0].fsPath)):r.localize("saveChangesMessages","Do you want to save the changes to the following {0} files?",i.length)];i.length>1&&(o.push(""),o.push.apply(o,i.slice(0,t.MAX_CONFIRM_FILES).map(function(e){return n.basename(e.fsPath)})),i.length>t.MAX_CONFIRM_FILES&&(i.length-t.MAX_CONFIRM_FILES===1?o.push(r.localize("moreFile","...1 additional file not shown")):o.push(r.localize("moreFiles","...{0} additional files not shown",i.length-t.MAX_CONFIRM_FILES))),o.push(""));var a={label:i.length>1?this.mnemonicLabel(r.localize({key:"saveAll",comment:["&& denotes a mnemonic"]},"&&Save All")):this.mnemonicLabel(r.localize({key:"save",comment:["&& denotes a mnemonic"]},"&&Save")),result:c.ConfirmResult.SAVE},l={label:this.mnemonicLabel(r.localize({key:"dontSave",comment:["&& denotes a mnemonic"]},"Do&&n't Save")),result:c.ConfirmResult.DONT_SAVE},u={label:r.localize("cancel","Cancel"),result:c.ConfirmResult.CANCEL},v=[];s.isWindows?v.push(a,l,u):s.isLinux?v.push(l,u,a):v.push(a,u,l);var h={title:this.contextService.getConfiguration().env.appName,message:o.join("\n"),type:"warning",detail:r.localize("saveChangesDetail","Your changes will be lost if you don't save them."),buttons:v.map(function(e){return e.label}),noLink:!0,cancelId:v.indexOf(u)};s.isLinux&&(h.defaultId=2);var m=this.windowService.getWindow().showMessageBox(h);return v[m].result},t.prototype.mnemonicLabel=function(e){return s.isWindows?e.replace(/&&/g,"&"):e.replace(/\(&&\w\)|&&/g,"")},t.prototype.saveAll=function(e){var t=[];t=Array.isArray(e)?this.getDirty(e):this.getDirty();var r=[],i=[];return t.forEach(function(t){"file"===t.scheme?r.push(t):!Array.isArray(e)&&e!==!0||"untitled"!==t.scheme||i.push(t)}),this.doSaveAll(r,i)},t.prototype.doSaveAll=function(t,r){var n=this;return e.prototype.saveAll.call(this,t).then(function(e){for(var o=[],s=0;s<r.length;s++){var c=n.untitledEditorService.get(r[s]);if(c){var l=void 0;if(n.untitledEditorService.hasAssociatedFilePath(c.getResource()))l=c.getResource().fsPath;else if(l=n.promptForPath(n.suggestFileName(r[s])),!l)return i.TPromise.as({results:t.concat(r).map(function(e){return{source:e}})});o.push(a["default"].file(l))}}var u=[];return o.forEach(function(t,i){var o=n.saveAs(r[i],t).then(function(t){e.results.push({source:r[i],target:t,success:!!t})});u.push(o)}),i.TPromise.join(u).then(function(){return e})})},t.prototype.saveAs=function(e,t){if(!t){var r=e.fsPath;"untitled"===e.scheme&&(r=this.suggestFileName(e));var n=this.promptForPath(r);n&&(t=a["default"].file(n))}return t?e.toString()===t.toString()?this.save(e).then(function(){return e}):this.doSaveAs(e,t):i.TPromise.as(null)},t.prototype.doSaveAs=function(e,t){var r=this,n=i.TPromise.as(null);if("file"===e.scheme)n=i.TPromise.as(v.CACHE.get(e));else if("untitled"===e.scheme){var o=this.untitledEditorService.get(e);o&&(n=o.resolve())}return n.then(function(i){return i?r.doSaveTextFileAs(i,e,t):r.fileService.copyFile(e,t)}).then(function(){return r.revert(e).then(function(){return t})})},t.prototype.doSaveTextFileAs=function(e,t,r){var i=this;return this.fileService.resolveFile(r).then(function(e){return e},function(){return null}).then(function(e){return e||i.fileService.createFile(r)}).then(function(n){return i.editorService.resolveEditorModel({resource:r}).then(function(n){return n instanceof p.BinaryEditorModel?i.fileService.del(r).then(function(){return i.doSaveTextFileAs(e,t,r)}):(n.updatePreferredEncoding(e.getEncoding()),n.textEditorModel.setValue(e.getValue()),n.save())})})},t.prototype.suggestFileName=function(e){var t=this.contextService.getWorkspace();return t?a["default"].file(n.join(t.resource.fsPath,this.untitledEditorService.get(e).suggestFileName())).fsPath:this.untitledEditorService.get(e).suggestFileName()},t.prototype.promptForPath=function(e){return this.windowService.getWindow().showSaveDialog(this.getSaveDialogOptions(e?n.normalize(e,!0):void 0))},t.prototype.getSaveDialogOptions=function(e){var t=this,i={defaultPath:e},s=!0;if(s)return i;var a,c=n.extname(e),l=this.modeService.getRegisteredLanguageNames().map(function(e){var r=t.modeService.getExtensions(e);if(!r||!r.length)return null;var i={name:e,extensions:r.map(function(e){return o.trim(e,".")})};return c&&r.indexOf(c)>=0?(a=i,null):i}).filter(function(e){return!!e}),u={name:r.localize("allFiles","All Files"),extensions:["*"]};return a?(l.unshift(a),l.push(u)):l.unshift(u),i.filters=l,i},t.MAX_CONFIRM_FILES=10,t=__decorate([__param(0,g.IWorkspaceContextService),__param(1,d.IInstantiationService),__param(2,f.IFileService),__param(3,m.IUntitledEditorService),__param(4,S.ILifecycleService),__param(5,y.ITelemetryService),__param(6,_.IConfigurationService),__param(7,l.IEventService),__param(8,w.IModeService),__param(9,A.IWorkbenchEditorService),__param(10,b.IEditorGroupService),__param(11,E.IWindowService),__param(12,F.IModelService)],t)}(u.TextFileService);t.TextFileService=x});