/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate=this&&this.__decorate||function(e,t,i,n){var r,o=arguments.length,c=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(e,t,i,n);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(c=(o<3?r(c):o>3?r(t,i,c):r(t,i))||c);return o>3&&c&&Object.defineProperty(t,i,c),c},__param=this&&this.__param||function(e,t){return function(i,n){t(i,n,e)}};define(["require","exports","vs/base/common/winjs.base","vs/workbench/parts/files/common/files","vs/platform/files/common/files","vs/base/common/platform","vs/workbench/common/editor/diffEditorInput","vs/workbench/common/editor","vs/base/common/errors","vs/workbench/services/editor/common/editorService","vs/base/common/uri","vs/platform/editor/common/editor","vs/workbench/services/window/electron-browser/windowService","vs/workbench/common/events","vs/workbench/services/untitled/common/untitledEditorService","vs/workbench/services/part/common/partService","vs/workbench/services/workspace/common/contextService","vs/platform/event/common/event","vs/platform/instantiation/common/instantiation","vs/platform/lifecycle/common/lifecycle","vs/workbench/services/viewlet/common/viewletService","vs/base/common/lifecycle","electron","vs/workbench/services/group/common/groupService"],function(e,t,i,n,r,o,c,s,d,a,u,v,p,h,l,f,m,S,E,_,b,w,y,I){"use strict";var D=function(){function e(e,t,i,n,r,c,s,d,a,u,v,p){this.contextService=e,this.eventService=t,this.partService=i,this.fileService=n,this.textFileService=r,this.viewletService=c,this.editorService=s,this.editorGroupService=d,this.instantiationService=a,this.untitledEditorService=u,this.lifecycleService=v,this.windowService=p,this.toUnbind=[],this.isDocumentedEdited=!1,this.activeOutOfWorkspaceWatchers=Object.create(null),o.platform===o.Platform.Mac&&y.ipcRenderer.send("vscode:setDocumentEdited",this.windowService.getWindowId(),!1),this.registerListeners()}return e.prototype.registerListeners=function(){var e=this;this.toUnbind.push(this.eventService.addListener2(h.EventType.UNTITLED_FILE_SAVED,function(){return e.onUntitledSavedEvent()})),this.toUnbind.push(this.eventService.addListener2(h.EventType.UNTITLED_FILE_DIRTY,function(){return e.onUntitledDirtyEvent()})),this.toUnbind.push(this.eventService.addListener2(n.EventType.FILE_DIRTY,function(t){return e.onTextFileDirty(t)})),this.toUnbind.push(this.eventService.addListener2(n.EventType.FILE_SAVED,function(t){return e.onTextFileSaved(t)})),this.toUnbind.push(this.eventService.addListener2(n.EventType.FILE_SAVE_ERROR,function(t){return e.onTextFileSaveError(t)})),this.toUnbind.push(this.eventService.addListener2(n.EventType.FILE_REVERTED,function(t){return e.onTextFileReverted(t)})),y.ipcRenderer.on("vscode:openFiles",function(t,i){return e.onOpenFiles(i)}),this.toUnbind.push(this.editorGroupService.onEditorsChanged(function(){return e.onEditorsChanged()})),this.lifecycleService.onShutdown(this.dispose,this)},e.prototype.onOpenFiles=function(e){var t=[],i=2===e.filesToDiff.length;!i&&e.filesToOpen&&t.push.apply(t,this.toInputs(e.filesToOpen,!1)),!i&&e.filesToCreate&&t.push.apply(t,this.toInputs(e.filesToCreate,!0)),i&&t.push.apply(t,this.toInputs(e.filesToDiff,!1)),t.length&&this.openResources(t,i).done(null,d.onUnexpectedError)},e.prototype.openResources=function(e,t){var r=this;return this.partService.joinCreation().then(function(){var o=i.TPromise.as(null);return r.partService.isSideBarHidden()||(o=r.viewletService.openViewlet(n.VIEWLET_ID,!1)),o.then(function(){if(t)return i.TPromise.join(e.map(function(e){return r.editorService.createInput(e)})).then(function(t){return r.editorService.openEditor(new c.DiffEditorInput(c.toDiffLabel(e[0].resource,e[1].resource,r.contextService),null,t[0],t[1]))});if(1===e.length)return r.editorService.openEditor(e[0]);var n=r.editorService.getActiveEditor();return r.editorService.openEditors(e.map(function(e,t){return{input:e,position:n?n.position:v.Position.LEFT}}))})})},e.prototype.toInputs=function(e,t){var i=this;return e.map(function(e){var n={resource:t?i.untitledEditorService.createOrGet(u["default"].file(e.filePath)).getResource():u["default"].file(e.filePath),options:{pinned:!0}};return!t&&e.lineNumber&&(n.options.selection={startLineNumber:e.lineNumber,startColumn:e.columnNumber}),n})},e.prototype.onEditorsChanged=function(){var e=this,t=this.editorService.getVisibleEditors().map(function(e){return s.asFileEditorInput(e.input,!0)}).filter(function(t){return!!t&&!e.contextService.isInsideWorkspace(t.getResource())}).map(function(e){return e.getResource().toString()});Object.keys(this.activeOutOfWorkspaceWatchers).forEach(function(i){t.indexOf(i)<0&&(e.fileService.unwatchFileChanges(i),delete e.activeOutOfWorkspaceWatchers[i])}),t.forEach(function(t){e.activeOutOfWorkspaceWatchers[t]||(e.fileService.watchFileChanges(u["default"].parse(t)),e.activeOutOfWorkspaceWatchers[t]=!0)})},e.prototype.onUntitledDirtyEvent=function(){this.isDocumentedEdited||this.updateDocumentEdited()},e.prototype.onUntitledSavedEvent=function(){this.isDocumentedEdited&&this.updateDocumentEdited()},e.prototype.onTextFileDirty=function(e){this.textFileService.getAutoSaveMode()===n.AutoSaveMode.AFTER_SHORT_DELAY||this.isDocumentedEdited||this.updateDocumentEdited()},e.prototype.onTextFileSaved=function(e){this.isDocumentedEdited&&this.updateDocumentEdited()},e.prototype.onTextFileSaveError=function(e){this.isDocumentedEdited||this.updateDocumentEdited()},e.prototype.onTextFileReverted=function(e){this.isDocumentedEdited&&this.updateDocumentEdited()},e.prototype.updateDocumentEdited=function(){if(o.platform===o.Platform.Mac){var e=this.textFileService.isDirty();this.isDocumentedEdited=e,y.ipcRenderer.send("vscode:setDocumentEdited",this.windowService.getWindowId(),e)}},e.prototype.getId=function(){return"vs.files.electronFileTracker"},e.prototype.dispose=function(){this.toUnbind=w.dispose(this.toUnbind);for(var e in this.activeOutOfWorkspaceWatchers)this.fileService.unwatchFileChanges(e);this.activeOutOfWorkspaceWatchers=Object.create(null)},e=__decorate([__param(0,m.IWorkspaceContextService),__param(1,S.IEventService),__param(2,f.IPartService),__param(3,r.IFileService),__param(4,n.ITextFileService),__param(5,b.IViewletService),__param(6,a.IWorkbenchEditorService),__param(7,I.IEditorGroupService),__param(8,E.IInstantiationService),__param(9,l.IUntitledEditorService),__param(10,_.ILifecycleService),__param(11,p.IWindowService)],e)}();t.FileTracker=D});