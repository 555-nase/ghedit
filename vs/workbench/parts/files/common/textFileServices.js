var __decorate=this&&this.__decorate||function(e,t,o,r){var n,i=arguments.length,s=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,r);else for(var u=e.length-1;u>=0;u--)(n=e[u])&&(s=(i<3?n(s):i>3?n(t,o,s):n(t,o))||s);return i>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};define(["require","exports","vs/base/common/winjs.base","vs/base/common/errors","vs/base/common/event","vs/workbench/parts/files/common/editors/fileEditorInput","vs/workbench/parts/files/common/editors/textFileEditorModel","vs/workbench/parts/files/common/files","vs/workbench/services/workspace/common/contextService","vs/platform/files/common/files","vs/platform/instantiation/common/instantiation","vs/platform/event/common/event","vs/platform/configuration/common/configuration","vs/platform/telemetry/common/telemetry","vs/base/common/lifecycle","vs/workbench/services/editor/common/editorService","vs/workbench/services/group/common/groupService","vs/editor/common/services/modelService"],function(e,t,o,r,n,i,s,u,a,c,f,v,l,g,h,p,d,S){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var m=function(){function e(e,t,o,r,i,s,u,a,c){this.contextService=e,this.instantiationService=t,this.configurationService=o,this.telemetryService=r,this.editorService=i,this.editorGroupService=s,this.eventService=u,this.fileService=a,this.modelService=c,this.listenerToUnbind=[],this._onAutoSaveConfigurationChange=new n.Emitter}return e.prototype.init=function(){this.registerListeners();var e=this.configurationService.getConfiguration();this.onConfigurationChange(e),this.telemetryService.publicLog("autoSave",this.getAutoSaveConfiguration())},Object.defineProperty(e.prototype,"onAutoSaveConfigurationChange",{get:function(){return this._onAutoSaveConfigurationChange.event},enumerable:!0,configurable:!0}),e.prototype.registerListeners=function(){var e=this;this.listenerToUnbind.push(this.configurationService.onDidUpdateConfiguration(function(t){return e.onConfigurationChange(t.config)})),window.addEventListener("blur",function(){return e.onEditorsChanged()},!0),this.listenerToUnbind.push(this.editorGroupService.onEditorsChanged(function(){return e.onEditorsChanged()}))},e.prototype.onEditorsChanged=function(){this.configuredAutoSaveOnFocusChange&&this.getDirty().length&&this.saveAll().done(null,r.onUnexpectedError)},e.prototype.onConfigurationChange=function(e){var t=this.getAutoSaveMode()!==u.AutoSaveMode.OFF,o=e&&e.files&&e.files.autoSave||c.AutoSaveConfiguration.OFF;switch(o){case c.AutoSaveConfiguration.AFTER_DELAY:this.configuredAutoSaveDelay=e&&e.files&&e.files.autoSaveDelay,this.configuredAutoSaveOnFocusChange=!1;break;case c.AutoSaveConfiguration.ON_FOCUS_CHANGE:this.configuredAutoSaveDelay=void 0,this.configuredAutoSaveOnFocusChange=!0;break;default:this.configuredAutoSaveDelay=void 0,this.configuredAutoSaveOnFocusChange=!1}this._onAutoSaveConfigurationChange.fire(this.getAutoSaveConfiguration()),t||this.getAutoSaveMode()===u.AutoSaveMode.OFF||this.saveAll().done(null,r.onUnexpectedError)},e.prototype.getDirty=function(e){return this.getDirtyFileModels(e).map(function(e){return e.getResource()})},e.prototype.isDirty=function(e){return s.CACHE.getAll(e).some(function(e){return e.isDirty()})},e.prototype.save=function(e){return this.saveAll([e]).then(function(e){return 1===e.results.length&&e.results[0].success})},e.prototype.saveAll=function(e){var t=this.getDirtyFileModels(Array.isArray(e)?e:void 0),r=Object.create(null);return t.forEach(function(e){r[e.getResource().toString()]={source:e.getResource()}}),o.TPromise.join(t.map(function(e){return e.save().then(function(){e.isDirty()||(r[e.getResource().toString()].success=!0)})})).then(function(e){return{results:Object.keys(r).map(function(e){return r[e]})}})},e.prototype.getFileModels=function(e){var t=this;if(Array.isArray(e)){var o=[];return e.forEach(function(e){o.push.apply(o,t.getFileModels(e))}),o}return s.CACHE.getAll(e)},e.prototype.getDirtyFileModels=function(e){return this.getFileModels(e).filter(function(e){return e.isDirty()})},e.prototype.confirmSave=function(e){throw new Error("Unsupported")},e.prototype.revert=function(e,t){return this.revertAll([e],t).then(function(e){return 1===e.results.length&&e.results[0].success})},e.prototype.revertAll=function(e,t){var r=t?this.getFileModels(e):this.getDirtyFileModels(e),n=Object.create(null);return r.forEach(function(e){n[e.getResource().toString()]={source:e.getResource()}}),o.TPromise.join(r.map(function(e){return e.revert().then(function(){e.isDirty()||(n[e.getResource().toString()].success=!0)},function(t){if(t.fileOperationResult!==c.FileOperationResult.FILE_NOT_FOUND)return o.TPromise.wrapError(t);var r=i.FileEditorInput.getAll(e.getResource());r.forEach(function(e){return e.dispose()}),s.CACHE.dispose(e.getResource()),n[e.getResource().toString()].success=!0})})).then(function(e){return{results:Object.keys(n).map(function(e){return n[e]})}})},e.prototype.getAutoSaveMode=function(){return this.configuredAutoSaveOnFocusChange?u.AutoSaveMode.ON_FOCUS_CHANGE:this.configuredAutoSaveDelay&&this.configuredAutoSaveDelay>0?this.configuredAutoSaveDelay<=1e3?u.AutoSaveMode.AFTER_SHORT_DELAY:u.AutoSaveMode.AFTER_LONG_DELAY:u.AutoSaveMode.OFF},e.prototype.getAutoSaveConfiguration=function(){return{autoSaveDelay:this.configuredAutoSaveDelay&&this.configuredAutoSaveDelay>0?this.configuredAutoSaveDelay:void 0,autoSaveFocusChange:this.configuredAutoSaveOnFocusChange}},e.prototype.dispose=function(){this.listenerToUnbind=h.dispose(this.listenerToUnbind),s.CACHE.clear()},e=__decorate([__param(0,a.IWorkspaceContextService),__param(1,f.IInstantiationService),__param(2,l.IConfigurationService),__param(3,g.ITelemetryService),__param(4,p.IWorkbenchEditorService),__param(5,d.IEditorGroupService),__param(6,v.IEventService),__param(7,c.IFileService),__param(8,S.IModelService)],e)}();t.TextFileService=m});