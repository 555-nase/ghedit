var __extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)},__decorate=this&&this.__decorate||function(e,t,i,o){var r,n=arguments.length,s=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,o);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(s=(n<3?r(s):n>3?r(t,i,s):r(t,i))||s);return n>3&&s&&Object.defineProperty(t,i,s),s},__param=this&&this.__param||function(e,t){return function(i,o){t(i,o,e)}};define(["require","exports","vs/nls","vs/base/common/winjs.base","vs/base/common/errors","vs/base/common/paths","vs/base/common/diagnostics","vs/base/common/types","vs/workbench/common/events","vs/workbench/parts/files/common/files","vs/workbench/common/editor","vs/workbench/common/editor/textEditorModel","vs/platform/files/common/files","vs/platform/event/common/event","vs/platform/instantiation/common/instantiation","vs/platform/message/common/message","vs/editor/common/services/modeService","vs/editor/common/services/modelService","vs/platform/telemetry/common/telemetry"],function(e,t,i,o,r,n,s,a,d,c,l,u,h,v,p,f,m,E,S){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var g,y=function(){function e(e){this.messageService=e}return e.prototype.onSaveError=function(e,t){this.messageService.show(f.Severity.Error,i.localize("genericSaveError","Failed to save '{0}': {1}",n.basename(t.getResource().fsPath),r.toErrorMessage(e,!1)))},e=__decorate([__param(0,f.IMessageService)],e)}();g||(g=s.register("TextFileEditorModelDiagnostics",function(){for(var e=[],t=0;t<arguments.length;t++)e[t-0]=arguments[t];console.log(e[1]+" - "+e[0]+" (time: "+e[2].getTime()+" ["+e[2].toUTCString()+"])")}));var M=function(e){function s(t,i,o,r,n,s,a,d,c,l){if(e.call(this,n,r),this.messageService=o,this.eventService=s,this.fileService=a,this.instantiationService=d,this.telemetryService=c,this.textFileService=l,this.resource=t,"file"!==this.resource.scheme)throw new Error("TextFileEditorModel can only handle file:// resources.");this.preferredEncoding=i,this.textModelChangeListener=null,this.dirty=!1,this.autoSavePromises=[],this.versionId=0,this.lastDirtyTime=0,this.mapPendingSaveToVersionId={},this.updateAutoSaveConfiguration(l.getAutoSaveConfiguration()),this.registerListeners()}return __extends(s,e),s.prototype.registerListeners=function(){var e=this;this.textFileServiceListener=this.textFileService.onAutoSaveConfigurationChange(function(t){return e.updateAutoSaveConfiguration(t)})},s.prototype.updateAutoSaveConfiguration=function(e){"number"==typeof e.autoSaveDelay&&e.autoSaveDelay>0?(this.autoSaveAfterMillies=e.autoSaveDelay,this.autoSaveAfterMilliesEnabled=!0):(this.autoSaveAfterMillies=void 0,this.autoSaveAfterMilliesEnabled=!1)},s.setSaveErrorHandler=function(e){s.saveErrorHandler=e},s.prototype.setConflictResolutionMode=function(){g("setConflictResolutionMode() - enabled conflict resolution mode",this.resource,new Date),this.inConflictResolutionMode=!0},s.prototype.isInConflictResolutionMode=function(){return this.inConflictResolutionMode},s.prototype.revert=function(){var e=this;if(!this.isResolved())return o.TPromise.as(null);this.cancelAutoSavePromises();var t=this.setDirty(!1);return this.load(!0).then(function(){e.emitEvent(c.EventType.FILE_REVERTED,new c.TextFileChangeEvent(e.resource,e.textEditorModel))},function(i){return i.fileOperationResult===h.FileOperationResult.FILE_NOT_FOUND?e.emitEvent(c.EventType.FILE_REVERTED,new c.TextFileChangeEvent(e.resource,e.textEditorModel)):t(),o.TPromise.wrapError(i)})},s.prototype.load=function(e){var t=this;if(g("load() - enter",this.resource,new Date),this.dirty)return g("load() - exit - without loading because model is dirty",this.resource,new Date),o.TPromise.as(this);var i;return e?i=void 0:this.versionOnDiskStat&&(i=this.versionOnDiskStat.etag),this.textFileService.resolveTextContent(this.resource,{acceptTextOnly:!0,etag:i,encoding:this.preferredEncoding}).then(function(e){g("load() - resolved content",t.resource,new Date),t.telemetryService.publicLog("fileGet",{mimeType:e.mime,ext:n.extname(t.resource.fsPath),path:S.anonymize(t.resource.fsPath)});var i={resource:t.resource,name:e.name,mtime:e.mtime,etag:e.etag,mime:e.mime,isDirectory:!1,hasChildren:!1,children:void 0};t.updateVersionOnDiskStat(i);var r=t.contentEncoding;if(t.contentEncoding=e.encoding,t.preferredEncoding?t.updatePreferredEncoding(t.contentEncoding):r!==t.contentEncoding&&t.eventService.emit(d.EventType.RESOURCE_ENCODING_CHANGED,new d.ResourceEvent(t.resource)),t.textEditorModel){g("load() - updated text editor model",t.resource,new Date),t.setDirty(!1),t.blockModelContentChange=!0;try{t.updateTextEditorModel(e.value)}finally{t.blockModelContentChange=!1}return o.TPromise.as(t)}return t.createTextEditorModelPromise?(g("load() - join existing text editor model promise",t.resource,new Date),t.createTextEditorModelPromise):(g("load() - created text editor model",t.resource,new Date),t.createTextEditorModelPromise=t.createTextEditorModel(e.value,e.resource).then(function(){return t.createTextEditorModelPromise=null,t.setDirty(!1),t.textModelChangeListener=t.textEditorModel.onDidChangeRawContent(function(e){return t.onModelContentChanged(e)}),t},function(e){return t.createTextEditorModelPromise=null,o.TPromise.wrapError(e)}),t.createTextEditorModelPromise)},function(e){return e.fileOperationResult===h.FileOperationResult.FILE_NOT_MODIFIED_SINCE?(t.setDirty(!1),o.TPromise.as(t)):o.TPromise.wrapError(e)})},s.prototype.getOrCreateMode=function(e,t,i){return e.getOrCreateModeByFilenameOrFirstLine(this.resource.fsPath,i)},s.prototype.onModelContentChanged=function(e){if(g("onModelContentChanged("+e.changeType+") - enter",this.resource,new Date),this.versionId++,g("onModelContentChanged() - new versionId "+this.versionId,this.resource,new Date),!this.blockModelContentChange){if(!this.autoSaveAfterMilliesEnabled&&this.textEditorModel.getAlternativeVersionId()===this.bufferSavedVersionId){g("onModelContentChanged() - model content changed back to last saved version",this.resource,new Date);var t=this.dirty;return this.setDirty(!1),void(t&&this.emitEvent(c.EventType.FILE_REVERTED,new c.TextFileChangeEvent(this.resource,this.textEditorModel)))}g("onModelContentChanged() - model content changed and marked as dirty",this.resource,new Date),this.makeDirty(e),this.autoSaveAfterMilliesEnabled&&(this.inConflictResolutionMode?g("makeDirty() - prevented save because we are in conflict resolution mode",this.resource,new Date):this.doAutoSave(this.versionId))}},s.prototype.makeDirty=function(e){var t=this.dirty;this.setDirty(!0),this.lastDirtyTime=Date.now(),t||this.emitEvent(c.EventType.FILE_DIRTY,new c.TextFileChangeEvent(this.resource,this.textEditorModel))},s.prototype.doAutoSave=function(e){var t=this;g("doAutoSave() - enter for versionId "+e,this.resource,new Date),this.cancelAutoSavePromises();var i=o.TPromise.timeout(this.autoSaveAfterMillies).then(function(){e===t.versionId&&t.doSave(e,!0)});return this.autoSavePromises.push(i),i},s.prototype.cancelAutoSavePromises=function(){for(;this.autoSavePromises.length;)this.autoSavePromises.pop().cancel()},s.prototype.save=function(e,t){return this.isResolved()?(g("save() - enter",this.resource,new Date),this.cancelAutoSavePromises(),this.doSave(this.versionId,!1,e,t)):o.TPromise.as(null)},s.prototype.doSave=function(e,t,i,r){var s=this;g("doSave("+e+") - enter with versionId "+e,this.resource,new Date);var a=this.mapPendingSaveToVersionId[e];if(a)return g("doSave("+e+") - exit - found a pending save for versionId "+e,this.resource,new Date),a;if(!this.dirty||e!==this.versionId)return g("doSave("+e+") - exit - because not dirty and/or versionId is different (this.isDirty: "+this.dirty+", this.versionId: "+this.versionId+")",this.resource,new Date),o.TPromise.as(null);if(this.isBusySaving()&&(g("doSave("+e+") - exit - because busy saving",this.resource,new Date),this.autoSaveAfterMilliesEnabled))return this.doAutoSave(e);this.autoSaveAfterMilliesEnabled||this.textEditorModel.pushStackElement(),this.blockModelContentChange=!0;try{var d=new c.TextFileChangeEvent(this.resource,this.textEditorModel);d.setAutoSaved(t),this.emitEvent(c.EventType.FILE_SAVING,d)}finally{this.blockModelContentChange=!1}return e=this.versionId,this.inErrorMode=!1,g("doSave("+e+") - before updateContent()",this.resource,new Date),this.mapPendingSaveToVersionId[e]=this.fileService.updateContent(this.versionOnDiskStat.resource,this.getValue(),{overwriteReadonly:i,overwriteEncoding:r,mtime:this.versionOnDiskStat.mtime,encoding:this.getEncoding(),etag:this.versionOnDiskStat.etag}).then(function(t){g("doSave("+e+") - after updateContent()",s.resource,new Date),s.telemetryService.publicLog("filePUT",{mimeType:t.mime,ext:n.extname(s.versionOnDiskStat.resource.fsPath)}),delete s.mapPendingSaveToVersionId[e],e===s.versionId?(g("doSave("+e+") - setting dirty to false because versionId did not change",s.resource,new Date),s.setDirty(!1)):g("doSave("+e+") - not setting dirty to false because versionId did change meanwhile",s.resource,new Date),s.updateVersionOnDiskStat(t),s.emitEvent(c.EventType.FILE_SAVED,new c.TextFileChangeEvent(s.resource,s.textEditorModel))},function(t){g("doSave("+e+") - exit - resulted in a save error: "+t.toString(),s.resource,new Date),delete s.mapPendingSaveToVersionId[e],s.inErrorMode=!0,s.onSaveError(t),s.emitEvent(c.EventType.FILE_SAVE_ERROR,new c.TextFileChangeEvent(s.resource,s.textEditorModel))}),this.mapPendingSaveToVersionId[e]},s.prototype.setDirty=function(e){var t=this,i=this.dirty,o=this.inConflictResolutionMode,r=this.inErrorMode,n=this.bufferSavedVersionId;return e?this.dirty=!0:(this.dirty=!1,this.inConflictResolutionMode=!1,this.inErrorMode=!1,this.textEditorModel&&(this.bufferSavedVersionId=this.textEditorModel.getAlternativeVersionId())),function(){t.dirty=i,t.inConflictResolutionMode=o,t.inErrorMode=r,t.bufferSavedVersionId=n}},s.prototype.updateVersionOnDiskStat=function(e){this.versionOnDiskStat?this.versionOnDiskStat.mtime<=e.mtime&&(this.versionOnDiskStat=e):this.versionOnDiskStat=e},s.prototype.onSaveError=function(e){s.saveErrorHandler||s.setSaveErrorHandler(this.instantiationService.createInstance(y)),s.saveErrorHandler.onSaveError(e,this)},s.prototype.emitEvent=function(e,t){try{this.eventService.emit(e,t)}catch(o){o.friendlyMessage=i.localize("unexpectedEventError","An unexpected error was thrown from a file change listener of type: {0}",e),r.onUnexpectedError(o)}},s.prototype.isBusySaving=function(){return!a.isEmptyObject(this.mapPendingSaveToVersionId)},s.prototype.isDirty=function(){return this.dirty},s.prototype.getLastDirtyTime=function(){return this.lastDirtyTime},s.prototype.getLastModifiedTime=function(){return this.versionOnDiskStat?this.versionOnDiskStat.mtime:-1},s.prototype.getState=function(){return this.inConflictResolutionMode?c.ModelState.CONFLICT:this.inErrorMode?c.ModelState.ERROR:this.dirty?this.isBusySaving()?c.ModelState.PENDING_SAVE:this.dirty?c.ModelState.DIRTY:void 0:c.ModelState.SAVED},s.prototype.getEncoding=function(){return this.preferredEncoding||this.contentEncoding},s.prototype.setEncoding=function(e,t){if(this.isNewEncoding(e))if(t===l.EncodingMode.Encode)this.updatePreferredEncoding(e),this.isDirty()||(this.versionId++,this.makeDirty()),this.inConflictResolutionMode||this.save(!1,!0).done(null,r.onUnexpectedError);else{if(this.isDirty())return void this.messageService.show(f.Severity.Info,i.localize("saveFileFirst","The file is dirty. Please save it first before reopening it with another encoding."));this.updatePreferredEncoding(e),this.load(!0).done(null,r.onUnexpectedError)}},s.prototype.updatePreferredEncoding=function(e){this.isNewEncoding(e)&&(this.preferredEncoding=e,this.eventService.emit(d.EventType.RESOURCE_ENCODING_CHANGED,new d.ResourceEvent(this.resource)))},s.prototype.isNewEncoding=function(e){return this.preferredEncoding!==e&&!(!this.preferredEncoding&&this.contentEncoding===e)},s.prototype.isResolved=function(){return!a.isUndefinedOrNull(this.versionOnDiskStat)},s.prototype.isDisposed=function(){return this.disposed},s.prototype.getResource=function(){return this.resource},s.prototype.dispose=function(){this.disposed=!0,this.inConflictResolutionMode=!1,this.inErrorMode=!1,this.createTextEditorModelPromise=null,this.textModelChangeListener&&(this.textModelChangeListener.dispose(),this.textModelChangeListener=null),this.textFileServiceListener&&(this.textFileServiceListener.dispose(),this.textFileServiceListener=null),this.cancelAutoSavePromises(),t.CACHE.remove(this.resource),e.prototype.dispose.call(this)},s.ID="workbench.editors.files.textFileEditorModel",s=__decorate([__param(2,f.IMessageService),__param(3,m.IModeService),__param(4,E.IModelService),__param(5,v.IEventService),__param(6,h.IFileService),__param(7,p.IInstantiationService),__param(8,S.ITelemetryService),__param(9,c.ITextFileService)],s)}(u.BaseTextEditorModel);t.TextFileEditorModel=M;var D=function(){function e(){this.mapResourcePathToModel=Object.create(null)}return e.prototype.dispose=function(e){var t=this.get(e);if(t){if(t.isDirty())return;t.dispose()}},e.prototype.get=function(e){return this.mapResourcePathToModel[e.toString()]},e.prototype.getAll=function(e){var t=this;return Object.keys(this.mapResourcePathToModel).filter(function(t){return!e||e.toString()===t}).map(function(e){return t.mapResourcePathToModel[e]})},e.prototype.add=function(e,t){this.mapResourcePathToModel[e.toString()]=t},e.prototype.clear=function(){this.mapResourcePathToModel=Object.create(null)},e.prototype.remove=function(e){delete this.mapResourcePathToModel[e.toString()]},e}();t.TextFileEditorModelCache=D,t.CACHE=new D});