var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},__decorate=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},__param=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};define(["require","exports","vs/base/common/winjs.base","vs/platform/platform","vs/base/common/types","vs/base/common/paths","vs/base/common/mime","vs/base/common/labels","vs/base/common/strings","vs/base/common/assert","vs/workbench/common/editor","vs/workbench/common/editor/binaryEditorModel","vs/platform/files/common/files","vs/workbench/parts/files/common/files","vs/workbench/parts/files/common/editors/textFileEditorModel","vs/workbench/services/workspace/common/contextService","vs/platform/instantiation/common/instantiation","vs/base/common/lifecycle","vs/platform/event/common/event"],function(e,t,r,i,n,o,s,c,a,u,h,p,E,d,f,l,v,_,m){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var I=function(e){function t(t,r,i,n,o,c,a){e.call(this),this.eventService=n,this.instantiationService=o,this.contextService=c,this.textFileService=a,this.toUnbind=[],t&&(this.setResource(t),this.setMime(r||s.guessMimeTypes(this.resource.fsPath).join(", ")),this.preferredEncoding=i),this.registerListeners()}return __extends(t,e),t.prototype.registerListeners=function(){var e=this;this.toUnbind.push(this.eventService.addListener2(d.EventType.FILE_DIRTY,function(t){return e.onDirtyStateChange(t)})),this.toUnbind.push(this.eventService.addListener2(d.EventType.FILE_SAVE_ERROR,function(t){return e.onDirtyStateChange(t)})),this.toUnbind.push(this.eventService.addListener2(d.EventType.FILE_SAVED,function(t){return e.onDirtyStateChange(t)})),this.toUnbind.push(this.eventService.addListener2(d.EventType.FILE_REVERTED,function(t){return e.onDirtyStateChange(t)}))},t.prototype.onDirtyStateChange=function(e){e.resource.toString()===this.resource.toString()&&this._onDidChangeDirty.fire()},t.prototype.setResource=function(e){if("file"!==e.scheme)throw new Error("FileEditorInput can only handle file:// resources.");this.resource=e,this.name=null,this.description=null,this.verboseDescription=null},t.prototype.getResource=function(){return this.resource},t.prototype.getMime=function(){return this.mime},t.prototype.setMime=function(e){u.ok(e,"Editor input needs mime type"),this.mime=e},t.prototype.setPreferredEncoding=function(e){this.preferredEncoding=e},t.prototype.getEncoding=function(){var e=f.CACHE.get(this.resource);return e?e.getEncoding():this.preferredEncoding},t.prototype.setEncoding=function(e,t){this.preferredEncoding=e;var r=f.CACHE.get(this.resource);r&&r.setEncoding(e,t)},t.prototype.getTypeId=function(){return d.FILE_EDITOR_INPUT_ID},t.prototype.getName=function(){return this.name||(this.name=o.basename(this.resource.fsPath)),this.name},t.prototype.getDescription=function(e){return e?(this.verboseDescription||(this.verboseDescription=c.getPathLabel(this.resource.fsPath)),this.verboseDescription):(this.description||(this.description=c.getPathLabel(o.dirname(this.resource.fsPath),this.contextService)),this.description)},t.prototype.isDirty=function(){var e=f.CACHE.get(this.resource);if(!e)return!1;var t=e.getState();return t===d.ModelState.CONFLICT||t===d.ModelState.ERROR||this.textFileService.getAutoSaveMode()!==d.AutoSaveMode.AFTER_SHORT_DELAY&&e.isDirty()},t.prototype.confirmSave=function(){return this.textFileService.confirmSave([this.resource])},t.prototype.save=function(){return this.textFileService.save(this.resource)},t.prototype.revert=function(){return this.textFileService.revert(this.resource)},t.prototype.getPreferredEditorId=function(e){for(var t,r=i.Registry.as(h.Extensions.Editors),o=this.mime.split(","),s=0;s<o.length;s++)for(var c=a.trim(o[s]),u=0;u<e.length;u++)if(t=r.getEditorById(e[u]),n.isFunction(t.getMimeTypes))for(var p=t.getMimeTypes(),E=0;E<p.length;E++){var f=p[E];if(c===f)return t.getId();if(a.endsWith(f,"/*")&&a.startsWith(c,f.substring(0,f.length-1)))return t.getId()}return d.BINARY_FILE_EDITOR_ID},t.prototype.resolve=function(e){var i,o=this,s=this.resource.toString(),c=t.FILE_EDITOR_MODEL_CLIENTS[s];if(n.isUndefinedOrNull(c)?t.FILE_EDITOR_MODEL_CLIENTS[s]=[this]:this.indexOfClient()===-1&&t.FILE_EDITOR_MODEL_CLIENTS[s].push(this),t.FILE_EDITOR_MODEL_LOADERS[s])return t.FILE_EDITOR_MODEL_LOADERS[s];var a=f.CACHE.get(this.resource);return a&&!e?i=r.TPromise.as(a):a&&e?(i=a.load(),t.FILE_EDITOR_MODEL_LOADERS[s]=i):(i=this.createAndLoadModel(),t.FILE_EDITOR_MODEL_LOADERS[s]=i),i.then(function(e){return e instanceof f.TextFileEditorModel&&f.CACHE.add(o.resource,e),t.FILE_EDITOR_MODEL_LOADERS[s]=null,e},function(e){return t.FILE_EDITOR_MODEL_LOADERS[s]=null,r.TPromise.wrapError(e)})},t.prototype.indexOfClient=function(){var e=t.FILE_EDITOR_MODEL_CLIENTS[this.resource.toString()];if(e)for(var r=0;r<e.length;r++){var i=e[r];if(i===this)return r}return-1},t.prototype.createAndLoadModel=function(){var e=this,t=i.Registry.as(h.Extensions.Editors).getEditor(this);if(!t)throw new Error("Unable to find an editor in the registry for this input.");var n=this.instantiationService.createInstance(f.TextFileEditorModel,this.resource,this.preferredEncoding);return n.load().then(function(){return n},function(t){return t.fileOperationResult===E.FileOperationResult.FILE_IS_BINARY||t.fileOperationResult===E.FileOperationResult.FILE_TOO_LARGE?(n.dispose(),e.instantiationService.createInstance(p.BinaryEditorModel,e.resource,e.getName()).load()):r.TPromise.wrapError(t)})},t.prototype.dispose=function(){_.dispose(this.toUnbind);var r=this.indexOfClient();r>=0&&t.FILE_EDITOR_MODEL_CLIENTS[this.resource.toString()].splice(r,1),e.prototype.dispose.call(this)},t.prototype.matches=function(r){return e.prototype.matches.call(this,r)===!0||!!r&&(r instanceof t&&r.resource.toString()===this.resource.toString())},t.getAll=function(e){var r=[],i=t.FILE_EDITOR_MODEL_CLIENTS;for(var n in i){var s=i[n];o.isEqualOrParent(n,e.toString())&&r.push.apply(r,s)}return r},t.FILE_EDITOR_MODEL_CLIENTS=Object.create(null),t.FILE_EDITOR_MODEL_LOADERS=Object.create(null),t=__decorate([__param(3,m.IEventService),__param(4,v.IInstantiationService),__param(5,l.IWorkspaceContextService),__param(6,d.ITextFileService)],t)}(d.FileEditorInput);t.FileEditorInput=I});