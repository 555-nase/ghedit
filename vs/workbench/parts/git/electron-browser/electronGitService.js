/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},__decorate=this&&this.__decorate||function(e,t,n,r){var o,i=arguments.length,c=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(c=(i<3?o(c):i>3?o(t,n,c):o(t,n))||c);return i>3&&c&&Object.defineProperty(t,n,c),c},__param=this&&this.__param||function(e,t){return function(n,r){t(n,r,e)}};define(["require","exports","vs/base/common/winjs.base","vs/workbench/parts/git/common/git","vs/workbench/parts/git/common/noopGitService","vs/workbench/parts/git/browser/gitServices","vs/platform/lifecycle/common/lifecycle","vs/workbench/parts/output/common/output","vs/workbench/services/editor/common/editorService","vs/platform/configuration/common/configuration","vs/platform/event/common/event","vs/platform/instantiation/common/instantiation","vs/platform/message/common/message","vs/platform/workspace/common/workspace","vs/base/parts/ipc/common/ipc","vs/base/parts/ipc/node/ipc.cp","vs/workbench/parts/git/common/gitIpc","vs/workbench/parts/git/node/rawGitService","vs/base/common/uri","child_process","path","electron","vs/platform/storage/common/storage","vs/base/node/pfs"],function(e,t,n,r,o,i,c,a,s,u,f,p,v,l,m,g,h,_,d,S,w,b,P,E){"use strict";function G(e){return e.replace(/^git version /,"")}function R(e){return new n.TPromise(function(t,n){var r=[],o=S.spawn(e,["--version"]);o.stdout.on("data",function(e){return r.push(e)}),o.on("error",n),o.on("exit",function(o){return o?n(new Error("Not found")):t({path:e,version:G(Buffer.concat(r).toString("utf8").trim())})})})}function x(){return new n.TPromise(function(e,t){S.exec("which git",function(n,r){function o(n){S.exec("git --version",function(r,o){return r?t("git not found"):e({path:n,version:G(o.toString("utf8").trim())})})}if(n)return t("git not found");var i=r.toString().replace(/^\s+|\s+$/g,"");return"/usr/bin/git"!==i?o(i):void S.exec("xcode-select -p",function(e){return e&&2===e.code?t("git not found"):void o(i)})})})}function C(e){return e?R(w.join(e,"Git","cmd","git.exe")):n.TPromise.wrapError("Not found")}function I(){var e=w.join(process.env.LOCALAPPDATA,"GitHub");return E.readdir(e).then(function(t){var r=t.filter(function(e){return/^PortableGit/.test(e)})[0];return r?R(w.join(e,r,"cmd","git.exe")):n.TPromise.wrapError("Not found")})}function O(){return C(process.env.ProgramW6432).then(null,function(){return C(process.env["ProgramFiles(x86)"])}).then(null,function(){return C(process.env.ProgramFiles)}).then(null,function(){return R("git")}).then(null,function(){return I()})}function T(e){var t=e?R(e):n.TPromise.wrapError(null);return t.then(null,function(){switch(process.platform){case"darwin":return x();case"win32":return O();default:return R("git")}})}function k(t,r,o,i){var c=n.TPromise.timeout(0).then(function(){return T(t)}).then(function(t){var n=t.path,c=t.version,a=new g.Client(d["default"].parse(e.toUrl("bootstrap")).fsPath,{serverName:"Git",timeout:6e4,args:[n,r,o,b.remote.process.execPath,c],env:{ATOM_SHELL_INTERNAL_RUN_AS_NODE:1,PIPE_LOGGING:"true",AMD_ENTRYPOINT:"vs/workbench/parts/git/node/gitApp",VERBOSE_LOGGING:String(i)}});return a.getChannel("git")}).then(null,function(){return new h.UnavailableGitChannel}),a=m.getNextTickChannel(m.getDelayedChannel(c));return new h.GitChannelClient(a)}function y(t,r,o,i){var c=new n.TPromise(function(n,i){e(["vs/workbench/parts/git/node/rawGitServiceBootstrap"],function(e){var c=e.createRawGitService;T(t).then(function(e){var t=e.path,n=e.version;return c(t,r,o,b.remote.process.execPath,n)}).done(n,i)},i)});return new _.DelayedRawGitService(c)}var N=(function(e){function t(){e.call(this,null)}return __extends(t,e),t.prototype.serviceState=function(){return n.TPromise.as(r.RawServiceState.GitNotFound)},t}(_.RawGitService),function(e){function t(){e.call(this,null)}return __extends(t,e),t.prototype.serviceState=function(){return n.TPromise.as(r.RawServiceState.Disabled)},t}(_.RawGitService)),A=function(e){function t(n,r,i,c,a,s,u,f,p){var v,l=p.getConfiguration("git"),m=p.getConfiguration("files"),g=s.getWorkspace();if(l.enabled)if(g){var h=l.path||null,_=m.encoding||"utf8",d=g.resource.fsPath,S=!s.getConfiguration().env.isBuilt||s.getConfiguration().env.verboseLogging;v=t.USE_REMOTE_PROCESS_SERVICE?k(h,d,_,S):y(h,d,_,S)}else v=new o.NoOpGitService;else v=new N;e.call(this,v,n,r,i,c,a,s,u,f,p)}return __extends(t,e),t.USE_REMOTE_PROCESS_SERVICE=!0,t=__decorate([__param(0,p.IInstantiationService),__param(1,f.IEventService),__param(2,v.IMessageService),__param(3,s.IWorkbenchEditorService),__param(4,a.IOutputService),__param(5,l.IWorkspaceContextService),__param(6,c.ILifecycleService),__param(7,P.IStorageService),__param(8,u.IConfigurationService)],t)}(i.GitService);t.ElectronGitService=A});