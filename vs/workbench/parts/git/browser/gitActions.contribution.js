var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},__decorate=this&&this.__decorate||function(t,e,i,n){var r,o=arguments.length,c=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,i,n);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(c=(o<3?r(c):o>3?r(e,i,c):r(e,i))||c);return o>3&&c&&Object.defineProperty(e,i,c),c},__param=this&&this.__param||function(t,e){return function(i,n){e(i,n,t)}};define(["require","exports","vs/nls","vs/base/common/lifecycle","vs/platform/platform","vs/workbench/browser/actionBarRegistry","vs/base/common/winjs.base","vs/workbench/browser/parts/editor/baseEditor","vs/workbench/common/editor","vs/workbench/browser/parts/editor/textDiffEditor","vs/workbench/browser/parts/editor/textEditor","vs/workbench/parts/files/common/files","vs/workbench/parts/git/browser/gitWorkbenchContributions","vs/workbench/parts/git/common/git","vs/workbench/parts/git/browser/gitEditorInputs","vs/workbench/parts/git/common/stageRanges","vs/workbench/services/editor/common/editorService","vs/workbench/services/viewlet/common/viewletService","vs/workbench/services/part/common/partService","vs/workbench/services/workspace/common/contextService","vs/platform/files/common/files","vs/platform/instantiation/common/instantiation","vs/workbench/common/actionRegistry","vs/platform/actions/common/actions","./gitActions","vs/base/common/paths","vs/base/common/uri"],function(t,e,i,n,r,o,c,a,s,u,p,l,h,d,v,g,S,f,E,_,m,I,A,b,y,D,w){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";function L(t,e,i){var n=t.getModel(),r=n.getRepositoryRoot(),o=n.getStatus(),c=D.normalize(D.relative(r,i.getResource().fsPath));return o.getWorkingTreeStatus().find(c)||o.getIndexStatus().find(c)}var k=function(t){function e(i,n,r,o,c){var a=this;t.call(this,e.ID,e.Label),this["class"]="git-action open-in-diff",this.gitService=n,this.viewletService=r,this.editorService=i,this.partService=o,this.contextService=c,this.toDispose=[this.gitService.addBulkListener2(function(){return a.onGitStateChanged()})],this.enabled=this.isEnabled()}return __extends(e,t),e.prototype.isEnabled=function(){if(!t.prototype.isEnabled.call(this))return!1;if("string"!=typeof this.gitService.getModel().getRepositoryRoot())return!1;var e=this.getStatus();return e&&(e.getStatus()===d.Status.MODIFIED||e.getStatus()===d.Status.INDEX_MODIFIED||e.getStatus()===d.Status.INDEX_RENAMED)},e.prototype.onGitStateChanged=function(){this.gitService.isIdle()&&(this.enabled=this.isEnabled())},e.prototype.getStatus=function(){return L(this.gitService,this.contextService,this.input)},e.prototype.run=function(t){var e=this,i=t?t.event:null,n=!(!i||!i.ctrlKey&&!i.metaKey),r=this.editorService.getActiveEditor().getControl(),o=r?r.saveViewState():null;return this.gitService.getInput(this.getStatus()).then(function(t){var i=c.TPromise.as(null);return e.partService.isVisible(E.Parts.SIDEBAR_PART)&&(i=e.viewletService.openViewlet(h.VIEWLET_ID,!1)),i.then(function(){var i=new s.TextDiffEditorOptions;return i.forceOpen=!0,i.autoRevealFirstChange=!1,e.editorService.openEditor(t,i,n).then(function(t){if(o){var i=e.editorService.getActiveEditor().getControl();i.restoreViewState({original:{},modified:o})}})})})},e.prototype.dispose=function(){this.toDispose=n.dispose(this.toDispose)},e.ID="workbench.action.git.openInDiff",e.Label=i.localize("switchToChangesView","Switch to Changes View"),e=__decorate([__param(0,S.IWorkbenchEditorService),__param(1,d.IGitService),__param(2,f.IViewletService),__param(3,E.IPartService),__param(4,_.IWorkspaceContextService)],e)}(a.EditorInputAction),C=function(t){function e(i,n,r,o,c,a){t.call(this,e.ID,e.LABEL),this["class"]="git-action open-in-editor",this.gitService=r,this.fileService=i,this.viewletService=o,this.editorService=n,this.partService=c,this.contextService=a,this.enabled=this.isEnabled()}return __extends(e,t),e.prototype.isEnabled=function(){if(!t.prototype.isEnabled.call(this))return!1;if("string"!=typeof this.gitService.getModel().getRepositoryRoot())return!1;var i=this.input.getFileStatus();return!(e.DELETED_STATES.indexOf(i.getStatus())>-1)},e.prototype.run=function(t){var e=this,i=this.gitService.getModel(),n=w["default"].file(D.join(i.getRepositoryRoot(),this.getRepositoryRelativePath())),r=t?t.event:null,o=!(!r||!r.ctrlKey&&!r.metaKey),c=this.saveTextViewState();return this.fileService.resolveFile(n).then(function(t){return e.editorService.openEditor({resource:t.resource,mime:t.mime,options:{forceOpen:!0}},o).then(function(t){if(e.restoreTextViewState(c),e.partService.isVisible(E.Parts.SIDEBAR_PART))return e.viewletService.openViewlet(l.VIEWLET_ID,!1)})})},e.prototype.saveTextViewState=function(){var t=this.getTextEditor();return t?t.saveViewState():null},e.prototype.restoreTextViewState=function(t){var e=this.getTextEditor();if(e)return e.restoreViewState(t)},e.prototype.getTextEditor=function(){var t=this.editorService.getActiveEditor();return t instanceof u.TextDiffEditor?t.getControl().getModifiedEditor():t instanceof p.BaseTextEditor?t.getControl():null},e.prototype.getRepositoryRelativePath=function(){var t=this.input.getFileStatus();if(t.getStatus()===d.Status.INDEX_RENAMED)return t.getRename();var e=this.gitService.getModel().getStatus().find(t.getPath(),d.StatusType.INDEX);return e&&e.getStatus()===d.Status.INDEX_RENAMED?e.getRename():t.getPath()},e.DELETED_STATES=[d.Status.BOTH_DELETED,d.Status.DELETED,d.Status.DELETED_BY_US,d.Status.INDEX_DELETED],e.ID="workbench.action.git.openInEditor",e.LABEL=i.localize("openInEditor","Switch to Editor View"),e=__decorate([__param(0,m.IFileService),__param(1,S.IWorkbenchEditorService),__param(2,d.IGitService),__param(3,f.IViewletService),__param(4,E.IPartService),__param(5,_.IWorkspaceContextService)],e)}(a.EditorInputAction),x=function(t){function e(i,n,r,o,c){void 0===i&&(i=e.ID),void 0===n&&(n=e.LABEL),t.call(this,i,n,"",r,o),this.contextService=c,this.onGitServiceChange()}return __extends(e,t),e.prototype.updateEnablement=function(){this.contextService?this.enabled=this.isEnabled():this.enabled=t.prototype.isEnabled.call(this)},e.prototype.isEnabled=function(){if(!t.prototype.isEnabled.call(this))return!1;var e=this.editorService.getActiveEditor();return!!(e&&e instanceof a.BaseEditor)},e.prototype.run=function(e){var i,n=this.editorService.getActiveEditor().input;if(v.isGitEditorInput(n)){var r=n;i=r.getFileStatus()}else i=L(this.gitService,this.contextService,n);return i?t.prototype.run.call(this,i):c.TPromise.as(null)},e.ID="workbench.action.git.stage",e.LABEL=i.localize("workbenchStage","Stage"),e=__decorate([__param(2,d.IGitService),__param(3,S.IWorkbenchEditorService),__param(4,_.IWorkspaceContextService)],e)}(y.BaseStageAction);e.WorkbenchStageAction=x;var R=function(t){function e(i,n,r,o,c){void 0===i&&(i=e.ID),void 0===n&&(n=e.LABEL),t.call(this,i,n,"",r,o),this.contextService=c,this.onGitServiceChange()}return __extends(e,t),e.prototype.updateEnablement=function(){this.contextService?this.enabled=this.isEnabled():this.enabled=t.prototype.isEnabled.call(this)},e.prototype.isEnabled=function(){if(!t.prototype.isEnabled.call(this))return!1;var e=this.editorService.getActiveEditor();return!!(e&&e instanceof a.BaseEditor)},e.prototype.run=function(e){var i,n=this.editorService.getActiveEditor().input;if(v.isGitEditorInput(n)){var r=n;i=r.getFileStatus()}else i=L(this.gitService,this.contextService,n);return i?t.prototype.run.call(this,i):c.TPromise.as(null)},e.ID="workbench.action.git.unstage",e.LABEL=i.localize("workbenchUnstage","Unstage"),e=__decorate([__param(2,d.IGitService),__param(3,S.IWorkbenchEditorService),__param(4,_.IWorkspaceContextService)],e)}(y.BaseUnstageAction);e.WorkbenchUnstageAction=R;var T=function(t){function e(e,i,n,r,o){var c=this;t.call(this,e,i),this.editorService=o,this.gitService=r,this.editor=n.getControl(),this.editor.onDidChangeCursorSelection(function(){return c.updateEnablement()}),this.editor.onDidUpdateDiff(function(){return c.updateEnablement()}),this["class"]="git-action stage-ranges"}return __extends(e,t),e.prototype.isEnabled=function(){if(!t.prototype.isEnabled.call(this))return!1;if(!this.gitService||!this.editorService)return!1;var e=this.editor.getLineChanges(),i=this.editor.getSelections();return!(!e||!i||0===i.length)&&g.getSelectedChanges(e,i).length>0},e.prototype.getRangesAppliedResult=function(t){var e=t.getSelections(),i=g.getSelectedChanges(t.getLineChanges(),e);return g.applyChangesToModel(t.getModel().original,t.getModel().modified,i)},e.prototype.run=function(){var t=this,e=this.getRangesAppliedResult(this.editor),i=this.input.getFileStatus(),n=i.getPath(),r=this.editor.saveViewState();return this.gitService.stage(i.getPath(),e).then(function(){var e=t.gitService.getModel().getStatus();if(i=e.getWorkingTreeStatus().find(n)||e.getIndexStatus().find(n))return t.gitService.getInput(i).then(function(e){var i=new s.TextDiffEditorOptions;return i.forceOpen=!0,i.autoRevealFirstChange=!1,t.editorService.openEditor(e,i,t.position).then(function(){t.editor.restoreViewState(r)})})})},e.prototype.updateEnablement=function(){this.enabled=this.isEnabled()},e=__decorate([__param(3,d.IGitService),__param(4,S.IWorkbenchEditorService)],e)}(a.EditorInputAction);e.BaseStageRangesAction=T;var B=function(t){function e(i,n,r){t.call(this,e.ID,e.LABEL,i,n,r)}return __extends(e,t),e.ID="workbench.action.git.stageRanges",e.LABEL=i.localize("stageSelectedLines","Stage Selected Lines"),e=__decorate([__param(1,d.IGitService),__param(2,S.IWorkbenchEditorService)],e)}(T);e.StageRangesAction=B;var P=function(t){function e(i,n,r){t.call(this,e.ID,e.LABEL,i,n,r)}return __extends(e,t),e.prototype.getRangesAppliedResult=function(t){var e=t.getSelections(),i=g.getSelectedChanges(t.getLineChanges(),e).map(function(t){return{modifiedStartLineNumber:t.originalStartLineNumber,modifiedEndLineNumber:t.originalEndLineNumber,originalStartLineNumber:t.modifiedStartLineNumber,originalEndLineNumber:t.modifiedEndLineNumber}});return g.applyChangesToModel(t.getModel().modified,t.getModel().original,i)},e.ID="workbench.action.git.unstageRanges",e.LABEL=i.localize("unstageSelectedLines","Unstage Selected Lines"),e=__decorate([__param(1,d.IGitService),__param(2,S.IWorkbenchEditorService)],e)}(T);e.UnstageRangesAction=P;var G=function(t){function e(e){t.call(this),this.instantiationService=e}return __extends(e,t),e.prototype.hasActionsForEditorInput=function(t){return t.input instanceof l.FileEditorInput},e.prototype.getActionsForEditorInput=function(t){return[this.instantiationService.createInstance(k)]},e=__decorate([__param(0,I.IInstantiationService)],e)}(a.EditorInputActionContributor),W=function(t){function e(e){t.call(this),this.instantiationService=e}return __extends(e,t),e.prototype.hasActionsForEditorInput=function(t){return v.isGitEditorInput(t.input)},e.prototype.getActionsForEditorInput=function(t){return[this.instantiationService.createInstance(C)]},e=__decorate([__param(0,I.IInstantiationService)],e)}(a.EditorInputActionContributor),F=function(t){function e(e){t.call(this),this.instantiationService=e}return __extends(e,t),e.prototype.hasSecondaryActionsForEditorInput=function(t){return t.input instanceof v.GitDiffEditorInput&&t.editor instanceof u.TextDiffEditor},e.prototype.getSecondaryActionsForEditorInput=function(t){return t.input instanceof v.GitIndexDiffEditorInput?[this.instantiationService.createInstance(P,t.editor)]:[this.instantiationService.createInstance(B,t.editor)]},e=__decorate([__param(0,I.IInstantiationService)],e)}(a.EditorInputActionContributor),O=function(t){function e(e,i,n,r,o,c,a){t.call(this,n,r),this.contextService=o,this.viewletService=c,this.partService=a}return __extends(e,t),e.prototype.getInput=function(){return s.asFileEditorInput(this.editorService.getActiveEditorInput())},e.prototype.run=function(t){var e=this,i=this.getInput();if(!i)return c.TPromise.as(null);var n=L(this.gitService,this.contextService,i);if(!n)return c.TPromise.as(null);var r=!(!t||!t.ctrlKey&&!t.metaKey),o=this.editorService.getActiveEditor().getControl(),a=o?o.saveViewState():null;return this.gitService.getInput(n).then(function(t){var i=c.TPromise.as(null);return e.partService.isVisible(E.Parts.SIDEBAR_PART)&&(i=e.viewletService.openViewlet(h.VIEWLET_ID,!1)),i.then(function(){var i=new s.TextDiffEditorOptions;return i.forceOpen=!0,i.autoRevealFirstChange=!1,e.editorService.openEditor(t,i,r).then(function(t){if(a){var i=e.editorService.getActiveEditor().getControl();i.restoreViewState({original:{},modified:a})}})})})},e.ID="workbench.action.git.globalOpenChange",e.LABEL=i.localize("openChange","Open Change"),e=__decorate([__param(2,S.IWorkbenchEditorService),__param(3,d.IGitService),__param(4,_.IWorkspaceContextService),__param(5,f.IViewletService),__param(6,E.IPartService)],e)}(y.OpenChangeAction),V=function(t){function e(i,n,r,o,c,a){void 0===i&&(i=e.ID),void 0===n&&(n=e.LABEL),t.call(this,r,o,c,a)}return __extends(e,t),e.prototype.run=function(e){var i=s.asFileEditorInput(this.editorService.getActiveEditorInput(),!0);if(!i)return c.TPromise.as(null);var n=L(this.gitService,this.contextService,i);return n?t.prototype.run.call(this,n):c.TPromise.as(null)},e.ID="workbench.action.git.globalOpenFile",e.LABEL=i.localize("openFile","Open File"),e=__decorate([__param(2,S.IWorkbenchEditorService),__param(3,m.IFileService),__param(4,d.IGitService),__param(5,_.IWorkspaceContextService)],e)}(y.OpenFileAction),M=r.Registry.as(o.Extensions.Actionbar);M.registerActionBarContributor(o.Scope.EDITOR,G),M.registerActionBarContributor(o.Scope.EDITOR,W),M.registerActionBarContributor(o.Scope.EDITOR,F);var N=r.Registry.as(A.Extensions.WorkbenchActions),U=i.localize("git","Git");N.registerWorkbenchAction(new b.SyncActionDescriptor(O,O.ID,O.LABEL),"Git: Open Change",U),N.registerWorkbenchAction(new b.SyncActionDescriptor(V,V.ID,V.LABEL),"Git: Open File",U),N.registerWorkbenchAction(new b.SyncActionDescriptor(y.PullAction,y.PullAction.ID,y.PullAction.LABEL),"Git: Pull",U),N.registerWorkbenchAction(new b.SyncActionDescriptor(y.PushAction,y.PushAction.ID,y.PushAction.LABEL),"Git: Push",U),N.registerWorkbenchAction(new b.SyncActionDescriptor(y.SyncAction,y.SyncAction.ID,y.SyncAction.LABEL),"Git: Sync",U),N.registerWorkbenchAction(new b.SyncActionDescriptor(y.PublishAction,y.PublishAction.ID,y.PublishAction.LABEL),"Git: Publish",U),N.registerWorkbenchAction(new b.SyncActionDescriptor(y.StartGitBranchAction,y.StartGitBranchAction.ID,y.StartGitBranchAction.LABEL),"Git: Branch",U),N.registerWorkbenchAction(new b.SyncActionDescriptor(y.StartGitCheckoutAction,y.StartGitCheckoutAction.ID,y.StartGitCheckoutAction.LABEL),"Git: Checkout",U),N.registerWorkbenchAction(new b.SyncActionDescriptor(y.InputCommitAction,y.InputCommitAction.ID,y.InputCommitAction.LABEL),"Git: Commit",U),N.registerWorkbenchAction(new b.SyncActionDescriptor(y.UndoLastCommitAction,y.UndoLastCommitAction.ID,y.UndoLastCommitAction.LABEL),"Git: Undo Last Commit",U),N.registerWorkbenchAction(new b.SyncActionDescriptor(x,x.ID,x.LABEL),"Git: Stage",U),N.registerWorkbenchAction(new b.SyncActionDescriptor(R,R.ID,R.LABEL),"Git: Unstage",U)});