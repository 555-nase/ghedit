/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)},__decorate=this&&this.__decorate||function(e,t,i,r){var o,n=arguments.length,s=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(n<3?o(s):n>3?o(t,i,s):o(t,i))||s);return n>3&&s&&Object.defineProperty(t,i,s),s},__param=this&&this.__param||function(e,t){return function(i,r){t(i,r,e)}};define(["require","exports","vs/nls","vs/base/common/async","vs/base/common/errors","vs/base/common/paths","vs/base/common/lifecycle","vs/base/common/winjs.base","vs/workbench/common/contributions","vs/workbench/parts/git/common/git","vs/editor/common/editorCommon","vs/editor/browser/widget/codeEditorWidget","vs/workbench/browser/viewlet","vs/workbench/browser/parts/statusbar/statusbar","vs/platform/platform","vs/workbench/parts/git/browser/gitWidgets","vs/workbench/common/actionRegistry","vs/workbench/parts/git/browser/gitOutput","vs/workbench/parts/output/common/output","vs/platform/actions/common/actions","vs/editor/browser/editorBrowserExtensions","vs/platform/configuration/common/configurationRegistry","vs/workbench/browser/quickopen","vs/workbench/parts/git/browser/gitEditorContributions","vs/workbench/services/activity/common/activityService","vs/platform/event/common/event","vs/platform/instantiation/common/instantiation","vs/platform/message/common/message","vs/platform/workspace/common/workspace","vs/workbench/services/viewlet/common/viewletService","vs/workbench/services/editor/common/editorService","vs/base/common/keyCodes","vs/editor/common/services/modelService","vs/editor/common/model/textModel","vs/editor/common/services/editorWorkerService","vs/workbench/services/group/common/groupService","vs/css!./media/git.contribution"],function(e,t,i,r,o,n,s,a,c,l,d,u,g,h,p,m,v,f,b,y,S,D,_,w,E,C,I,O,k,R,L,T,N,W,A,M){"use strict";function x(){p.Registry.as(h.Extensions.Statusbar).registerStatusbarItem(new h.StatusbarItemDescriptor(m.GitStatusbarItem,h.StatusbarAlignment.LEFT,100));var e=p.Registry.as(b.Extensions.OutputChannels);e.registerChannel("Git",i.localize("git","Git")),p.Registry.as(c.Extensions.Workbench).registerWorkbenchContribution(f.GitOutput),p.Registry.as(g.Extensions.Viewlets).registerViewlet(new g.ViewletDescriptor("vs/workbench/parts/git/browser/gitViewlet","GitViewlet",t.VIEWLET_ID,i.localize("git","Git"),"git",35)),p.Registry.as(v.Extensions.WorkbenchActions).registerWorkbenchAction(new y.SyncActionDescriptor(B,B.ID,B.LABEL,{primary:null,win:{primary:T.KeyMod.CtrlCmd|T.KeyMod.Shift|T.KeyCode.KEY_G},linux:{primary:T.KeyMod.CtrlCmd|T.KeyMod.Shift|T.KeyCode.KEY_G},mac:{primary:T.KeyMod.WinCtrl|T.KeyMod.Shift|T.KeyCode.KEY_G}}),"View: Show Git",i.localize("view","View")),S.EditorBrowserRegistry.registerEditorContribution(w.MergeDecorator),p.Registry.as(c.Extensions.Workbench).registerWorkbenchContribution(P),p.Registry.as(c.Extensions.Workbench).registerWorkbenchContribution(z),p.Registry.as(_.Extensions.Quickopen).registerQuickOpenHandler(new _.QuickOpenHandlerDescriptor("vs/workbench/parts/git/browser/gitQuickOpen","GitCommandQuickOpenHandler","git ",i.localize("gitCommands","Git Commands")));var r=p.Registry.as(D.Extensions.Configuration);r.registerConfiguration({id:"git",order:15,title:i.localize("gitConfigurationTitle","Git"),type:"object",properties:{"git.enabled":{type:"boolean",description:i.localize("gitEnabled","Is git enabled"),"default":!0},"git.path":{type:["string","null"],description:i.localize("gitPath","Path to the git executable"),"default":null},"git.autorefresh":{type:"boolean",description:i.localize("gitAutoRefresh","Whether auto refreshing is enabled"),"default":!0},"git.autofetch":{type:"boolean",description:i.localize("gitAutoFetch","Whether auto fetching is enabled."),"default":!0},"git.enableLongCommitWarning":{type:"boolean",description:i.localize("gitLongCommit","Whether long commit messages should be warned about."),"default":!0},"git.allowLargeRepositories":{type:"boolean",description:i.localize("gitLargeRepos","Always allow large repositories to be managed by Code."),"default":!1},"git.confirmSync":{type:"boolean",description:i.localize("confirmSync","Confirm before synchronizing git repositories."),"default":!1}}})}var G=l.IGitService,P=function(){function e(e,t,i,o){var n=this;this.gitService=e,this.eventService=t,this.activityService=i,this.messageService=o,this.progressBadgeDelayer=new r.Delayer(200),this.toDispose=[],this.toDispose.push(this.gitService.addBulkListener2(function(e){return n.onGitServiceChange()}))}return e.prototype.onGitServiceChange=function(){var e=this;this.gitService.getState()!==l.ServiceState.OK?(this.progressBadgeDelayer.cancel(),this.activityService.showActivity("workbench.view.git",null,"git-viewlet-label")):this.gitService.isIdle()?this.showChangesBadge():this.progressBadgeDelayer.trigger(function(){e.activityService.showActivity("workbench.view.git",new E.ProgressBadge(function(){return i.localize("gitProgressBadge","Running git status")}),"git-viewlet-label-progress")})},e.prototype.showChangesBadge=function(){var e=this.gitService.getModel().getStatus().getGroups().map(function(e){return e.all().length}).reduce(function(e,t){return e+t},0),t=new E.NumberBadge(e,function(e){return i.localize("gitPendingChangesBadge","{0} pending changes",e)});this.progressBadgeDelayer.cancel(),this.activityService.showActivity("workbench.view.git",t,"git-viewlet-label")},e.prototype.getId=function(){return e.ID},e.prototype.dispose=function(){this.toDispose=s.dispose(this.toDispose)},e.ID="vs.git.statusUpdater",e=__decorate([__param(0,G),__param(1,C.IEventService),__param(2,E.IActivityService),__param(3,O.IMessageService)],e)}();t.StatusUpdater=P;var V=function(){function e(t,i,o,n,s,a,c){var d=this;this.modelService=o,this.editorWorkerService=n,this.editorService=s,this.contextService=a,this.gitService=c,this.model=t,this._originalContentsURI=t.uri["with"]({scheme:e.GIT_ORIGINAL_SCHEME}),this.path=i,this.decorations=[],this.delayer=new r.ThrottledDelayer(500),this.diffDelayer=new r.ThrottledDelayer(200),this.toDispose=[],this.toDispose.push(t.onDidChangeContent(function(){return d.triggerDiff()})),this.toDispose.push(this.gitService.addListener2(l.ServiceEvents.STATE_CHANGED,function(){return d.onChanges()})),this.toDispose.push(this.gitService.addListener2(l.ServiceEvents.OPERATION_END,function(e){e.operation.id!==l.ServiceOperations.BACKGROUND_FETCH&&d.onChanges()})),this.onChanges()}return e.prototype.onChanges=function(){this.gitService&&this.gitService.getState()===l.ServiceState.OK&&this.trigger()},e.prototype.trigger=function(){var e=this;this.delayer.trigger(function(){return e.diffOriginalContents()}).done(null,o.onUnexpectedError)},e.prototype.diffOriginalContents=function(){var e=this;return this.getOriginalContents().then(function(t){if(e.model&&!e.model.isDisposed()){if(!t)return e.modelService.destroyModel(e._originalContentsURI),e.triggerDiff();var i=e.modelService.getModel(e._originalContentsURI);if(i){var r=W.RawText.fromStringWithModelOptions(t,i);if(i.equals(r))return a.TPromise.as(null);i.setValueFromRawText(r)}else e.modelService.createModel(t,null,e._originalContentsURI);return e.triggerDiff()}})},e.prototype.getOriginalContents=function(){var e=this.gitService.getModel(),t=e.getStatus().find(this.path,l.StatusType.INDEX)?"~":"HEAD";return this.gitService.buffer(this.path,t)},e.prototype.triggerDiff=function(){var t=this;return this.diffDelayer?this.diffDelayer.trigger(function(){return!t.model||t.model.isDisposed()?a.TPromise.as([]):t.editorWorkerService.computeDirtyDiff(t._originalContentsURI,t.model.uri,!0)}).then(function(i){if(t.model&&!t.model.isDisposed())return t.decorations=t.model.deltaDecorations(t.decorations,e.changesToDecorations(i||[]))}):a.TPromise.as(null)},e.changesToDecorations=function(t){return t.map(function(t){var i=t.modifiedStartLineNumber,r=t.modifiedEndLineNumber||i;return 0===t.originalEndLineNumber?{range:{startLineNumber:i,startColumn:1,endLineNumber:r,endColumn:1},options:e.ADDED_DECORATION_OPTIONS}:0===t.modifiedEndLineNumber?{range:{startLineNumber:i,startColumn:1,endLineNumber:i,endColumn:1},options:e.DELETED_DECORATION_OPTIONS}:{range:{startLineNumber:i,startColumn:1,endLineNumber:r,endColumn:1},options:e.MODIFIED_DECORATION_OPTIONS}})},e.prototype.dispose=function(){this.modelService.destroyModel(this._originalContentsURI),this.toDispose=s.dispose(this.toDispose),this.model&&!this.model.isDisposed()&&this.model.deltaDecorations(this.decorations,[]),this.model=null,this.decorations=null,this.delayer&&(this.delayer.cancel(),this.delayer=null),this.diffDelayer&&(this.diffDelayer.cancel(),this.diffDelayer=null)},e.GIT_ORIGINAL_SCHEME="git-index",e.ID="vs.git.editor.dirtyDiffDecorator",e.MODIFIED_DECORATION_OPTIONS={linesDecorationsClassName:"git-dirty-modified-diff-glyph",isWholeLine:!0,overviewRuler:{color:"rgba(0, 122, 204, 0.6)",darkColor:"rgba(0, 122, 204, 0.6)",position:d.OverviewRulerLane.Left}},e.ADDED_DECORATION_OPTIONS={linesDecorationsClassName:"git-dirty-added-diff-glyph",isWholeLine:!0,overviewRuler:{color:"rgba(0, 122, 204, 0.6)",darkColor:"rgba(0, 122, 204, 0.6)",position:d.OverviewRulerLane.Left}},e.DELETED_DECORATION_OPTIONS={linesDecorationsClassName:"git-dirty-deleted-diff-glyph",isWholeLine:!0,overviewRuler:{color:"rgba(0, 122, 204, 0.6)",darkColor:"rgba(0, 122, 204, 0.6)",position:d.OverviewRulerLane.Left}},e=__decorate([__param(2,N.IModelService),__param(3,A.IEditorWorkerService),__param(4,L.IWorkbenchEditorService),__param(5,k.IWorkspaceContextService),__param(6,G)],e)}(),z=function(){function e(e,t,i,r,o,n,s){var a=this;this.gitService=e,this.messageService=t,this.editorService=i,this.eventService=o,this.contextService=n,this.instantiationService=s,this.models=[],this.decorators=Object.create(null),this.toDispose=[],this.toDispose.push(r.onEditorsChanged(function(){return a.onEditorsChanged()})),this.toDispose.push(e.addListener2(l.ServiceEvents.DISPOSE,function(){return a.dispose()}))}return e.prototype.getId=function(){return"git.DirtyDiffModelDecorator"},e.prototype.onEditorsChanged=function(){var e=this,t=this.gitService.getModel().getRepositoryRoot();if("string"!=typeof t)return this.gitService.addOneTimeDisposableListener(l.ServiceEvents.STATE_CHANGED,function(){return e.onEditorsChanged()}),this.models.forEach(function(t){return e.onModelInvisible(t)}),void(this.models=[]);var i=this.editorService.getVisibleEditors().map(function(e){return e.getControl()}).filter(function(e){return e instanceof u.CodeEditorWidget}).map(function(e){return e.getModel()}).filter(function(e,t,i){return!!e&&i.indexOf(e,t+1)===-1}).map(function(e){return{model:e,resource:e.uri}}).filter(function(e){return!!e.resource&&"file"===e.resource.scheme&&n.isEqualOrParent(e.resource.fsPath,t)}).map(function(e){return{model:e.model,path:n.normalize(n.relative(t,e.resource.fsPath))}}).filter(function(e){return!!e.path&&e.path.indexOf(".git/")===-1}),r=i.filter(function(t){return e.models.every(function(e){return t.model!==e})}),o=this.models.filter(function(e){return i.every(function(t){return t.model!==e})});r.forEach(function(t){return e.onModelVisible(t.model,t.path)}),o.forEach(function(t){return e.onModelInvisible(t)}),this.models=i.map(function(e){return e.model})},e.prototype.onModelVisible=function(e,t){this.decorators[e.id]=this.instantiationService.createInstance(V,e,t)},e.prototype.onModelInvisible=function(e){this.decorators[e.id].dispose(),delete this.decorators[e.id]},e.prototype.dispose=function(){var e=this;this.toDispose=s.dispose(this.toDispose),this.models.forEach(function(t){return e.decorators[t.id].dispose()}),this.models=null,this.decorators=null},e=__decorate([__param(0,G),__param(1,O.IMessageService),__param(2,L.IWorkbenchEditorService),__param(3,M.IEditorGroupService),__param(4,C.IEventService),__param(5,k.IWorkspaceContextService),__param(6,I.IInstantiationService)],e)}();t.DirtyDiffDecorator=z,t.VIEWLET_ID="workbench.view.git";var B=function(e){function r(i,r,o,n){e.call(this,i,r,t.VIEWLET_ID,o,n)}return __extends(r,e),r.ID=t.VIEWLET_ID,r.LABEL=i.localize("toggleGitViewlet","Show Git"),r=__decorate([__param(2,R.IViewletService),__param(3,L.IWorkbenchEditorService)],r)}(g.ToggleViewletAction);t.registerContributions=x});