/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},__decorate=this&&this.__decorate||function(e,t,r,s){var i,o=arguments.length,n=o<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,r):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,r,s);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(n=(o<3?i(n):o>3?i(t,r,n):i(t,r))||n);return o>3&&n&&Object.defineProperty(t,r,n),n},__param=this&&this.__param||function(e,t){return function(r,s){t(r,s,e)}};define(["require","exports","vs/base/common/errors","vs/base/common/set","vs/base/common/winjs.base","vs/base/common/async","vs/base/browser/dom","vs/base/common/lifecycle","vs/platform/markers/common/markers","vs/platform/telemetry/common/telemetry","vs/platform/event/common/event","vs/workbench/services/group/common/groupService","vs/workbench/parts/files/common/editors/fileEditorInput","vs/workbench/browser/panel","vs/workbench/services/editor/common/editorService","vs/workbench/parts/markers/common/constants","vs/workbench/parts/markers/common/markersModel","vs/workbench/parts/markers/browser/markersTreeController","vs/base/parts/tree/browser/treeImpl","vs/workbench/parts/markers/browser/markersTreeViewer","vs/platform/instantiation/common/instantiation","vs/workbench/parts/markers/browser/markersActionProvider","vs/workbench/parts/markers/browser/markersPanelActions","vs/platform/configuration/common/configuration","vs/workbench/parts/markers/common/messages","vs/css!./media/markers"],function(e,t,r,s,i,o,n,a,c,h,l,p,u,d,m,v,f,g,k,S,y,A,M,b,R){"use strict";var _=function(e){function t(t,r,i,n,a,c,h){e.call(this,v["default"].MARKERS_PANEL_ID,h),this.instantiationService=t,this.markerService=r,this.editorGroupService=i,this.editorService=n,this.eventService=a,this.configurationService=c,this.lastSelectedRelativeTop=0,this.currentActiveFile=null,this.toDispose=[],this.delayedRefresh=new o.Delayer(500),this.autoExpanded=new s.ArraySet}return __extends(t,e),t.prototype.create=function(t){e.prototype.create.call(this,t),this.markersModel=new f.MarkersModel,n.addClass(t.getHTMLElement(),"markers-panel");var r=this.configurationService.getConfiguration();this.onConfigurationsUpdated(r);var s=n.append(t.getHTMLElement(),n.emmet(".markers-panel-container"));return this.createMessageBox(s),this.createTree(s),this.createActions(),this.createListeners(),this.render(),i.TPromise.as(null)},t.prototype.getTitle=function(){var e=this.markerService.getStatistics();return this.markersModel.getTitle(e)},t.prototype.layout=function(e){this.tree.layout(e.height)},t.prototype.focus=function(){this.tree.isDOMFocused()||(this.markersModel.hasFilteredResources()?(this.tree.DOMFocus(),0===this.tree.getSelection().length&&this.tree.focusFirst(),this.autoReveal(!0)):this.messageBox.focus())},t.prototype.getActions=function(){return this.collapseAllAction.enabled=this.markersModel.hasFilteredResources(),this.actions},t.prototype.refreshPanel=function(e){var t=this;return void 0===e&&(e=!1),this.collapseAllAction.enabled=this.markersModel.hasFilteredResources(),e&&this.updateTitleArea(),n.toggleClass(this.treeContainer,"hidden",!this.markersModel.hasFilteredResources()),this.renderMessage(),this.markersModel.hasFilteredResources()?this.tree.refresh().then(function(){t.autoExpand()}):i.TPromise.as(null)},t.prototype.updateFilter=function(e){this.markersModel.update(new f.FilterOptions(e)),this.autoExpanded=new s.ArraySet,this.refreshPanel(),this.autoReveal()},t.prototype.createMessageBox=function(e){this.messageBoxContainer=n.append(e,n.emmet(".message-box-container")),this.messageBox=n.append(this.messageBoxContainer,n.emmet("span")),this.messageBox.setAttribute("tabindex","0")},t.prototype.createTree=function(e){this.treeContainer=n.append(e,n.emmet(".tree-container"));var t=this.instantiationService.createInstance(A.ActionProvider),r=this.instantiationService.createInstance(S.Renderer,this.getActionRunner(),t),s=this.instantiationService.createInstance(g.Controller);this.tree=new k.Tree(this.treeContainer,{dataSource:new S.DataSource,renderer:r,controller:s,accessibilityProvider:new S.MarkersTreeAccessibilityProvider},{indentPixels:0,twistiePixels:20,ariaLabel:R["default"].MARKERS_PANEL_ARIA_LABEL_PROBLEMS_TREE})},t.prototype.createActions=function(){var e=this;this.collapseAllAction=this.instantiationService.createInstance(M.CollapseAllAction,this.tree,!0),this.filterAction=new M.FilterAction(this),this.actions=[this.filterAction,this.collapseAllAction],this.actions.forEach(function(t){e.toDispose.push(t)})},t.prototype.createListeners=function(){var e=this;this.toDispose.push(this.configurationService.onDidUpdateConfiguration(function(t){return e.onConfigurationsUpdated(t.config)})),this.toDispose.push(this.markerService.onMarkerChanged(this.onMarkerChanged,this)),this.toDispose.push(this.editorGroupService.onEditorsChanged(this.onEditorsChanged,this)),this.toDispose.push(this.tree.addListener2("selection",function(){return e.onSelected()}))},t.prototype.onMarkerChanged=function(e){var t=this;this.updateResources(e),this.delayedRefresh.trigger(function(){t.refreshPanel(!0),t.autoReveal()})},t.prototype.onEditorsChanged=function(){var e=this.editorService.getActiveEditorInput();this.currentActiveFile=e instanceof u.FileEditorInput?e.getResource():null,this.autoReveal()},t.prototype.onConfigurationsUpdated=function(e){this.hasToAutoReveal=e&&e.problems&&e.problems.autoReveal},t.prototype.onSelected=function(){var e=this.tree.getSelection();e&&e.length>0&&(this.lastSelectedRelativeTop=this.tree.getRelativeTop(e[0]))},t.prototype.updateResources=function(e){var t=this;e.forEach(function(e){var r=t.markerService.read({resource:e}).slice(0);t.markersModel.update(e,r),t.markersModel.hasResource(e)||t.autoExpanded.unset(e.toString())})},t.prototype.render=function(){var e=this.markerService.read().slice(0);this.markersModel.update(e),this.tree.setInput(this.markersModel).then(this.autoExpand.bind(this)),n.toggleClass(this.treeContainer,"hidden",!this.markersModel.hasFilteredResources()),this.renderMessage()},t.prototype.renderMessage=function(){var e=this.markersModel.getMessage();this.messageBox.textContent=e,n.toggleClass(this.messageBoxContainer,"hidden",this.markersModel.hasFilteredResources())},t.prototype.autoExpand=function(){var e=this;this.markersModel.filteredResources.forEach(function(t){e.autoExpanded.contains(t.uri.toString())||(e.tree.expand(t).done(null,r.onUnexpectedError),e.autoExpanded.set(t.uri.toString()))})},t.prototype.autoReveal=function(e){void 0===e&&(e=!1);var t=this.configurationService.getConfiguration();t&&t.problems&&t.problems.autoReveal&&this.revealMarkersForCurrentActiveEditor(e)},t.prototype.revealMarkersForCurrentActiveEditor=function(e){void 0===e&&(e=!1);var t=this.getResourceForCurrentActiveFile();t?this.tree.isExpanded(t)&&this.hasSelectedMarkerFor(t)?(this.tree.reveal(this.tree.getSelection()[0],this.lastSelectedRelativeTop),e&&this.tree.setFocus(this.tree.getSelection()[0])):(this.tree.reveal(t,0),e&&(this.tree.setFocus(t),this.tree.setSelection([t]))):e&&(this.tree.setSelection([]),this.tree.focusFirst())},t.prototype.getResourceForCurrentActiveFile=function(){var e=this;if(this.currentActiveFile){var t=this.markersModel.filteredResources.filter(function(t){return e.currentActiveFile.toString()===t.uri.toString()});return t.length>0?t[0]:null}return null},t.prototype.hasSelectedMarkerFor=function(e){var t=this.tree.getSelection();return!!(t&&t.length>0&&t[0]instanceof f.Marker&&e.uri.toString()===t[0].marker.resource.toString())},t.prototype.getActionItem=function(t){return t.id===M.FilterAction.ID?this.instantiationService.createInstance(M.FilterInputBoxActionItem,this,t):e.prototype.getActionItem.call(this,t)},t.prototype.dispose=function(){this.delayedRefresh.cancel(),this.toDispose=a.dispose(this.toDispose),this.tree.dispose(),this.markersModel.dispose(),e.prototype.dispose.call(this)},t=__decorate([__param(0,y.IInstantiationService),__param(1,c.IMarkerService),__param(2,p.IEditorGroupService),__param(3,m.IWorkbenchEditorService),__param(4,l.IEventService),__param(5,b.IConfigurationService),__param(6,h.ITelemetryService)],t)}(d.Panel);t.MarkersPanel=_});