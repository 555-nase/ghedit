/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)},__decorate=this&&this.__decorate||function(e,t,i,n){var o,r=arguments.length,s=r<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,n);else for(var c=e.length-1;c>=0;c--)(o=e[c])&&(s=(r<3?o(s):r>3?o(t,i,s):o(t,i))||s);return r>3&&s&&Object.defineProperty(t,i,s),s},__param=this&&this.__param||function(e,t){return function(i,n){t(i,n,e)}};define(["require","exports","vs/base/common/winjs.base","vs/nls","vs/base/browser/builder","vs/base/common/strings","vs/base/common/filters","vs/base/common/uuid","vs/base/common/types","vs/base/parts/quickopen/common/quickOpen","vs/base/parts/quickopen/browser/quickOpenModel","vs/base/parts/quickopen/browser/quickOpenWidget","vs/workbench/browser/actionBarRegistry","vs/base/common/labels","vs/base/common/paths","vs/platform/platform","vs/workbench/common/editor","vs/workbench/common/component","vs/base/common/event","vs/workbench/common/constants","vs/base/common/keyCodes","vs/workbench/browser/quickopen","vs/base/common/errors","vs/workbench/services/editor/common/editorService","vs/workbench/services/viewlet/common/viewletService","vs/platform/storage/common/storage","vs/platform/configuration/common/configuration","vs/platform/event/common/event","vs/platform/instantiation/common/instantiation","vs/platform/message/common/message","vs/platform/telemetry/common/telemetry","vs/workbench/services/workspace/common/contextService","vs/platform/keybinding/common/keybinding","vs/workbench/services/history/common/history","vs/css!./media/quickopen"],function(e,t,i,n,o,r,s,c,u,a,p,l,h,d,g,f,v,m,y,k,O,b,w,E,W,S,P,H,_,T,C,q,R,I){"use strict";var F="?",Q="inQuickOpen",x=function(e){function t(i,n,o,r,s,c,u,a,p,l){e.call(this,t.ID),this.eventService=i,this.storageService=n,this.editorService=o,this.viewletService=r,this.messageService=s,this.telemetryService=c,this.contextService=u,this.historyService=p,this.instantiationService=l,this.actionProvider=new h.ContributableActionProvider,this.previousValue="",this.mapResolvedHandlersToPrefix={},this.promisesToCompleteOnHide=[],this.inQuickOpenMode=a.createKey(Q,!1),this._onShow=new y.Emitter,this._onHide=new y.Emitter}return __extends(t,e),Object.defineProperty(t.prototype,"onShow",{get:function(){return this._onShow.event},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onHide",{get:function(){return this._onHide.event},enumerable:!0,configurable:!0}),t.prototype.quickNavigate=function(e,t){this.quickOpenWidget&&this.quickOpenWidget.quickNavigate(e,t)},t.prototype.input=function(e){var t=this;void 0===e&&(e={});var o,r=e.prompt?n.localize("inputModeEntryDescription","{0} (Press 'Enter' to confirm or 'Escape' to cancel)",e.prompt):n.localize("inputModeEntry","Press 'Enter' to confirm your input or 'Escape' to cancel"),s=r,c=i.TPromise.as(!0),u=e.value||"",a=function(n,p){t.doPick(i.TPromise.as([{label:s}]),{ignoreFocusLost:!1,autoFocus:{autoFocusFirstEntry:!0},password:e.password,placeHolder:e.placeHolder,value:u||e.value,valueSelect:!u||u===e.value,inputDecoration:o,onDidType:function(t){u=t,e.validateInput&&(c&&c.cancel(),c=i.TPromise.timeout(100).then(function(){return e.validateInput(t).then(function(e){o=e?T.Severity.Error:void 0;var t=e||r;return t!==s&&(s=t,n(new i.TPromise(a))),!e})},function(e){}))}}).then(n,p)};return new i.TPromise(a).then(function(e){return c.then(function(t){if(t&&e)return u})})},t.prototype.pick=function(e,t){var n=this;t||(t=Object.create(null));var o;if(Array.isArray(e))o=i.TPromise.as(e);else{if(!i.TPromise.is(e))throw new Error("illegal input");o=e}var r=!1,s=o.then(function(e){return e.map(function(e){return"string"==typeof e?(r=!0,{label:e}):e})});return new i.TPromise(function(e,i,o){function c(e){return e&&r?e.label:e}n.doPick(s,t).then(function(t){return e(c(t))},function(e){return i(e)},function(e){return o(c(e))})})},t.prototype.doPick=function(e,t){var a=this,h=t.autoFocus,d=c.generateUuid();return this.currentPickerToken=d,this.pickOpenWidget?this.pickOpenWidget.setPlaceHolder(t.placeHolder||""):(this.pickOpenWidget=new l.QuickOpenWidget(o.withElementById(k.Identifiers.WORKBENCH_CONTAINER).getHTMLElement(),{onOk:function(){},onCancel:function(){},onType:function(e){},onShow:function(){return a.emitQuickOpenVisibilityChange(!0)},onHide:function(e){e||a.restoreFocus(),a.emitQuickOpenVisibilityChange(!1)}},{inputPlaceHolder:t.placeHolder||""},this.telemetryService),this.pickOpenWidget.create()),t.value&&this.pickOpenWidget.setValue(t.value,t.valueSelect),this.pickOpenWidget.setPassword(t.password),u.isUndefinedOrNull(t.inputDecoration)?this.pickOpenWidget.clearInputDecoration():this.pickOpenWidget.showInputDecoration(t.inputDecoration),this.layoutDimensions&&this.pickOpenWidget.layout(this.layoutDimensions),new i.TPromise(function(o,c,u){var l=!1;e.then(function(e){if(a.currentPickerToken===d){l=!0,a.pickOpenWidget.getProgressBar().stop().getContainer().hide();var i=new p.QuickOpenModel,c=e.map(function(e){var t=e;return t.height&&t.render?new N(t,function(){return u(e)}):new M(t,function(){return u(e)})});0===e.length&&c.push(new M({label:n.localize("emptyPicks","There are no entries to pick from")})),i.setEntries(c),a.pickOpenWidget.setCallbacks({onOk:function(){if(0===e.length)return o(null);var t,i=-1;c.forEach(function(e,n){e.shouldRunWithContext&&(i=n,t=e.shouldRunWithContext)});var n=e[i];n&&"function"==typeof n.run&&n.run(t),o(n||null)},onCancel:function(){return o(void 0)},onFocusLost:function(){return t.ignoreFocusLost},onType:function(n){return t.onDidType?void t.onDidType(n):void(0!==e.length&&(n=n?r.trim(n):n,n?c.forEach(function(e){var i=s.matchesFuzzy(n,e.getLabel()),o=t.matchOnDescription&&s.matchesFuzzy(n,e.getDescription()),r=t.matchOnDetail&&e.getDetail()&&s.matchesFuzzy(n,e.getDetail());e.shouldAlwaysShow()||i||o||r?(e.setHighlights(i,o,r),e.setHidden(!1)):(e.setHighlights(null,null,null),e.setHidden(!0))}):c.forEach(function(e){e.setHighlights(null),e.setHidden(!1)}),a.pickOpenWidget.refresh(i,n?{autoFocusFirstEntry:!0}:h)))},onShow:function(){a.emitQuickOpenVisibilityChange(!0)},onHide:function(e){e||a.restoreFocus(),a.emitQuickOpenVisibilityChange(!1)}}),a.pickOpenWidget.isVisible()?a.pickOpenWidget.setInput(i,h):a.pickOpenWidget.show(i,{autoFocus:h})}},function(e){a.pickOpenWidget.hide(),c(e)}),i.TPromise.timeout(800).then(function(){l||a.currentPickerToken!==d||a.pickOpenWidget.getProgressBar().infinite().getContainer().show()}),l||a.pickOpenWidget.show(new p.QuickOpenModel)})},t.prototype.emitQuickOpenVisibilityChange=function(e){var t=this;this.visibilityChangeTimeoutHandle&&window.clearTimeout(this.visibilityChangeTimeoutHandle),this.visibilityChangeTimeoutHandle=setTimeout(function(){e?t._onShow.fire():t._onHide.fire(),t.visibilityChangeTimeoutHandle=void 0},100)},t.prototype.refresh=function(e){return this.quickOpenWidget.isVisible()?e&&this.previousValue!==e?i.TPromise.as(null):this.show(this.previousValue):i.TPromise.as(null)},t.prototype.show=function(e,t){var r=this,s=t?t.quickNavigateConfiguration:void 0;this.previousValue=e;var c=new i.TPromise(function(e){r.promisesToCompleteOnHide.push(e)}),u=f.Registry.as(b.Extensions.Quickopen),a=u.getQuickOpenHandler(e);if(!a){var p=u.getDefaultQuickOpenHandlers();p.length>0&&(a=p[0])}if(a&&this.telemetryService.publicLog("quickOpenWidgetShown",{mode:a.getId(),quickNavigate:s}),this.quickOpenWidget||(this.quickOpenWidget=new l.QuickOpenWidget(o.withElementById(k.Identifiers.WORKBENCH_CONTAINER).getHTMLElement(),{onOk:function(){return r.onClose(!1)},onCancel:function(){return r.onCancel()},onType:function(e){return r.onType(e||"")},onShow:function(){r.inQuickOpenMode.set(!0),r.emitQuickOpenVisibilityChange(!0)},onHide:function(e){for(r.inQuickOpenMode.reset();r.promisesToCompleteOnHide.length;)r.promisesToCompleteOnHide.pop()(!0);e||r.restoreFocus(),r.emitQuickOpenVisibilityChange(!1)}},{inputPlaceHolder:this.hasHandler(F)?n.localize("quickOpenInput","Type '?' to get help on the actions you can take from here"):""},this.telemetryService),this.quickOpenWidget.create()),this.layoutDimensions&&this.quickOpenWidget.layout(this.layoutDimensions),!this.quickOpenWidget.isVisible()||s)if(e)this.quickOpenWidget.show(e,{quickNavigateConfiguration:s});else{var h=this.getEditorHistoryWithGroupLabel();h.getEntries().length<2&&(s=null);var d=void 0;if(s){var g=this.editorService.getVisibleEditors().length;d={autoFocusFirstEntry:0===g,autoFocusSecondEntry:0!==g}}else d={autoFocusFirstEntry:!0};this.quickOpenWidget.show(h,{quickNavigateConfiguration:s,autoFocus:d})}else this.quickOpenWidget.show(e||"");return c},t.prototype.hasHandler=function(e){return!!f.Registry.as(b.Extensions.Quickopen).getQuickOpenHandler(e)},t.prototype.getEditorHistoryWithGroupLabel=function(){var e=this.getEditorHistoryEntries();return e.length>0&&(e[0]=new p.QuickOpenEntryGroup(e[0],n.localize("historyMatches","recently opened"),(!1))),new p.QuickOpenModel(e,this.actionProvider)},t.prototype.onCancel=function(e){void 0===e&&(e=!0),e&&this.onClose(!0)},t.prototype.onClose=function(e){this.previousActiveHandlerDescriptor=null;for(var t in this.mapResolvedHandlersToPrefix)if(this.mapResolvedHandlersToPrefix.hasOwnProperty(t)){var i=this.mapResolvedHandlersToPrefix[t];i.onClose(e)}},t.prototype.restoreFocus=function(){var e=this.editorService.getActiveEditor();e&&e.focus()},t.prototype.onType=function(e){var t=this;this.previousValue=e;var n=f.Registry.as(b.Extensions.Quickopen),o=n.getQuickOpenHandler(e),s=o&&o.instantProgress,a=c.generateUuid();this.currentResultToken=a,s||this.quickOpenWidget.getProgressBar().stop().getContainer().hide(),this.quickOpenWidget.setExtraClass(null);var p=r.trim(e);if(!p)return void this.quickOpenWidget.setInput(this.getEditorHistoryWithGroupLabel(),{autoFocusFirstEntry:!0});var l,h=!1;if(o)l=this.handleSpecificHandler(o,e,a);else{var d=n.getDefaultQuickOpenHandlers();l=this.handleDefaultHandlers(d,e,a)}this.previousActiveHandlerDescriptor=o,i.TPromise.timeout(s?0:800).then(function(){h||a!==t.currentResultToken||t.quickOpenWidget.getProgressBar().infinite().getContainer().show()}),l.done(function(){h=!0,a===t.currentResultToken&&t.quickOpenWidget.getProgressBar().getContainer().hide()},function(e){h=!0,w.onUnexpectedError(e),t.messageService.show(T.Severity.Error,u.isString(e)?new Error(e):e)})},t.prototype.handleDefaultHandlers=function(e,t,o){var r=this,s=this.getEditorHistoryEntries(t);s.length>0&&(s[0]=new p.QuickOpenEntryGroup(s[0],n.localize("historyMatches","recently opened"),(!1)));var c=new p.QuickOpenModel(s,this.actionProvider);if(this.quickOpenWidget.setInput(c,{autoFocusFirstEntry:!0}),0===e.length)return i.TPromise.as(null);var a=[];return e.forEach(function(e){a.push(r.resolveHandler(e))}),i.TPromise.join(a).then(function(e){var n=[];return e.forEach(function(e){var i=e.canRun();u.isUndefinedOrNull(i)||"boolean"==typeof i&&!i||"string"==typeof i||n.push(e.getResults(t).then(function(t){if(r.currentResultToken===o){var i=t&&t.entries;i||(i=[]),r.mergeResults(c,i,e.getGroupLabel())}}))}),i.TPromise.join(n).then(function(){})})},t.prototype.getEditorHistoryEntries=function(e){var t=this;e&&(e=e.replace(/ /g,""));var i=this.historyService.getHistory();if(!e)return i.map(function(e){return t.instantiationService.createInstance(L,e)});var n=e.indexOf(g.nativeSep)>=0,o=[];return i.forEach(function(i){var r=v.getUntitledOrFileResource(i);if(r){var c=n?d.getPathLabel(r,t.contextService):i.getName();if(s.matchesFuzzy(e,c)){var u=t.instantiationService.createInstance(L,i),a=p.QuickOpenEntry.highlight(u,e),l=a.labelHighlights,h=a.descriptionHighlights;u.setHighlights(l,h),o.push(u)}}}),o.sort(function(t,i){return p.QuickOpenEntry.compare(t,i,e)})},t.prototype.mergeResults=function(e,t,i){for(var o=this.mapEntriesToResource(e),r=[],s=0;s<t.length;s++){var c=t[s],u=c.getResource();u&&o[u.toString()]||r.push(c)}if(r.length>0){var a=e.getEntries().length>0;r[0]=new p.QuickOpenEntryGroup(r[0],i,a),e.addEntries(r),this.quickOpenWidget.refresh(e,{autoFocusFirstEntry:!0})}else 0===e.getEntries().length&&(e.addEntries([new D(n.localize("noResultsFound1","No results found"))]),this.quickOpenWidget.refresh(e,{autoFocusFirstEntry:!0}))},t.prototype.handleSpecificHandler=function(e,t,o){var r=this;return this.resolveHandler(e).then(function(s){t=t.substr(e.prefix.length);var c=s.canRun();if(u.isUndefinedOrNull(c)||"boolean"==typeof c&&!c||"string"==typeof c){var a="string"==typeof c?c:n.localize("canNotRunPlaceholder","This quick open handler can not be used in the current context"),l=new p.QuickOpenModel([new D(a)],r.actionProvider);return r.showModel(l,s.getAutoFocus(t,r.quickOpenWidget.getQuickNavigateConfiguration()),s.getAriaLabel()),i.TPromise.as(null)}var h=s.getClass();return h&&r.quickOpenWidget.setExtraClass(h),r.previousActiveHandlerDescriptor!==e&&r.clearModel(),s.getResults(t).then(function(e){if(r.currentResultToken===o)if(e&&e.entries.length)r.showModel(e,s.getAutoFocus(t,r.quickOpenWidget.getQuickNavigateConfiguration()),s.getAriaLabel());else{var i=new p.QuickOpenModel([new D(s.getEmptyLabel(t))]);r.showModel(i,s.getAutoFocus(t,r.quickOpenWidget.getQuickNavigateConfiguration()),s.getAriaLabel())}})})},t.prototype.showModel=function(e,t,i){return this.quickOpenWidget.getInput()===e?void this.quickOpenWidget.refresh(e,t):void this.quickOpenWidget.setInput(e,t,i)},t.prototype.clearModel=function(){this.showModel(new p.QuickOpenModel,null)},t.prototype.mapEntriesToResource=function(e){var t=e.getEntries(),i={};return t.forEach(function(e){e.getResource()&&(i[e.getResource().toString()]=e)}),i},t.prototype.resolveHandler=function(e){var t=this,n=e.getId();return this.mapResolvedHandlersToPrefix[n]?i.TPromise.as(this.mapResolvedHandlersToPrefix[n]):this.instantiationService.createInstance(e).then(function(e){return t.mapResolvedHandlersToPrefix[n]=e,e},function(t){return i.TPromise.wrapError("Unable to instantiate quick open handler "+e.moduleName+" - "+e.ctorName+": "+JSON.stringify(t))})},t.prototype.layout=function(e){this.layoutDimensions=e,this.quickOpenWidget&&this.quickOpenWidget.layout(this.layoutDimensions),this.pickOpenWidget&&this.pickOpenWidget.layout(this.layoutDimensions)},t.prototype.dispose=function(){this.quickOpenWidget&&this.quickOpenWidget.dispose(),this.pickOpenWidget&&this.pickOpenWidget.dispose(),e.prototype.dispose.call(this)},t.ID="workbench.component.quickopen",t=__decorate([__param(0,H.IEventService),__param(1,S.IStorageService),__param(2,E.IWorkbenchEditorService),__param(3,W.IViewletService),__param(4,T.IMessageService),__param(5,C.ITelemetryService),__param(6,q.IWorkspaceContextService),__param(7,R.IKeybindingService),__param(8,I.IHistoryService),__param(9,_.IInstantiationService)],t)}(m.WorkbenchComponent);t.QuickOpenController=x;var D=function(e){function t(t){e.call(this),this.placeHolderLabel=t}return __extends(t,e),t.prototype.getLabel=function(){return this.placeHolderLabel},t}(p.QuickOpenEntryGroup),M=function(e){function t(t,i){e.call(this,t.label),this.onPreview=i,this.description=t.description,this.detail=t.detail,this.hasSeparator=t.separator&&t.separator.border,this.separatorLabel=t.separator&&t.separator.label,this.alwaysShow=t.alwaysShow}return __extends(t,e),Object.defineProperty(t.prototype,"shouldRunWithContext",{get:function(){return this._shouldRunWithContext},enumerable:!0,configurable:!0}),t.prototype.getDescription=function(){return this.description},t.prototype.getDetail=function(){return this.detail},t.prototype.showBorder=function(){return this.hasSeparator},t.prototype.getGroupLabel=function(){return this.separatorLabel},t.prototype.shouldAlwaysShow=function(){return this.alwaysShow},t.prototype.run=function(e,t){return e===a.Mode.OPEN?(this._shouldRunWithContext=t,!0):(e===a.Mode.PREVIEW&&this.onPreview&&this.onPreview(),!1)},t}(D),N=function(e){function t(t,i){e.call(this),this.onPreview=i,this.label=t.label,this.description=t.description,this.height=t.height,this.renderFn=t.render.bind(t),this.alwaysShow=t.alwaysShow}return __extends(t,e),t.prototype.getHeight=function(){return this.height},t.prototype.render=function(e,t,i){return this.renderFn(e,t,i)},Object.defineProperty(t.prototype,"shouldRunWithContext",{get:function(){return this._shouldRunWithContext},enumerable:!0,configurable:!0}),t.prototype.getLabel=function(){return this.label},t.prototype.getDescription=function(){return this.description},t.prototype.shouldAlwaysShow=function(){return this.alwaysShow},t.prototype.run=function(e,t){return e===a.Mode.OPEN?(this._shouldRunWithContext=t,!0):(e===a.Mode.PREVIEW&&this.onPreview&&this.onPreview(),!1)},t}(p.QuickOpenEntryItem),L=function(e){function t(t,i,n,o,r){e.call(this,i),this.instantiationService=n,this.configurationService=o,this.contextService=r,this.input=t,this.resource=v.getUntitledOrFileResource(t)}return __extends(t,e),t.prototype.getIcon=function(){return this.input.isDirty()?"dirty":""},t.prototype.getLabel=function(){return this.input.getName()},t.prototype.getAriaLabel=function(){return n.localize("entryAriaLabel","{0}, recently opened",this.getLabel())},t.prototype.getDescription=function(){return this.input.getDescription()},t.prototype.getResource=function(){return this.resource},t.prototype.getInput=function(){return this.input},t.prototype.matches=function(e){return this.input.matches(e)},t.prototype.run=function(e,t){if(e===a.Mode.OPEN){var i=!t.quickNavigateConfiguration&&t.keymods.indexOf(O.KeyMod.CtrlCmd)>=0,n=!this.configurationService.getConfiguration().workbench.editor.enablePreviewFromQuickOpen;return this.editorService.openEditor(this.input,{pinned:n},i).done(null,w.onUnexpectedError),!0}return!1},t=__decorate([__param(1,E.IWorkbenchEditorService),__param(2,_.IInstantiationService),__param(3,P.IConfigurationService),__param(4,q.IWorkspaceContextService)],t)}(b.EditorQuickOpenEntry);t.EditorHistoryEntry=L});