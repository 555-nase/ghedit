/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __decorate=this&&this.__decorate||function(t,o,e,i){var r,n=arguments.length,s=n<3?o:null===i?i=Object.getOwnPropertyDescriptor(o,e):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,o,e,i);else for(var c=t.length-1;c>=0;c--)(r=t[c])&&(s=(n<3?r(s):n>3?r(o,e,s):r(o,e))||s);return n>3&&s&&Object.defineProperty(o,e,s),s},__param=this&&this.__param||function(t,o){return function(e,i){o(e,i,t)}};define(["require","exports","vs/nls","vs/platform/platform","vs/workbench/browser/actionBarRegistry","vs/base/common/errors","vs/base/browser/dom","vs/base/common/winjs.base","vs/workbench/browser/parts/editor/baseEditor","vs/base/common/async","vs/base/common/arrays","vs/workbench/common/editor","vs/base/common/events","vs/base/browser/ui/actionbar/actionbar","vs/base/browser/ui/toolbar/toolbar","vs/workbench/services/editor/common/editorService","vs/platform/contextview/browser/contextView","vs/platform/configuration/common/configuration","vs/workbench/services/group/common/groupService","vs/platform/message/common/message","vs/base/browser/mouseEvent","vs/platform/telemetry/common/telemetry","vs/platform/instantiation/common/instantiation","vs/workbench/services/quickopen/common/quickOpenService","vs/platform/keybinding/common/keybinding","vs/workbench/browser/parts/editor/editorActions","vs/base/common/lifecycle","vs/platform/actions/browser/menuItemActionItem","vs/platform/actions/common/actions","vs/platform/actions/common/resourceContextKey","vs/css!./media/titlecontrol"],function(t,o,e,i,r,n,s,c,a,d,p,h,u,l,v,f,A,E,g,m,y,b,S,I,w,C,k,x,T,_){"use strict";var O=!1,D=function(){function t(t,o,e,i,r,n,s,c,a,p){var h=this;this.contextMenuService=t,this.instantiationService=o,this.configurationService=e,this.editorService=i,this.editorGroupService=r,this.keybindingService=n,this.telemetryService=s,this.messageService=c,this.menuService=a,this.quickOpenService=p,this.currentPrimaryEditorActionIds=[],this.currentSecondaryEditorActionIds=[],this.toDispose=[],this.stacks=r.getStacksModel(),this.mapActionsToEditors=Object.create(null),this.onConfigurationUpdated(e.getConfiguration()),this.scheduler=new d.RunOnceScheduler(function(){return h.onSchedule()},0),this.toDispose.push(this.scheduler),this.resourceContext=o.createInstance(_.ResourceContextKey),this.contributedTitleBarMenu=this.menuService.createMenu(T.MenuId.EditorTitle,this.keybindingService),this.toDispose.push(this.contributedTitleBarMenu),this.toDispose.push(this.contributedTitleBarMenu.onDidChange(function(t){return h.update()})),this.initActions(),this.registerListeners()}return t.getDraggedEditor=function(){return t.draggedEditor},t.prototype.setDragged=function(t){this.dragged=t},t.prototype.onEditorDragStart=function(o){t.draggedEditor=o},t.prototype.onEditorDragEnd=function(){t.draggedEditor=void 0},t.prototype.registerListeners=function(){var t=this;this.toDispose.push(this.configurationService.onDidUpdateConfiguration(function(o){return t.onConfigurationUpdated(o.config)})),this.toDispose.push(this.stacks.onModelChanged(function(o){return t.onStacksChanged(o)}))},t.prototype.onStacksChanged=function(t){t.structural&&this.updateSplitActionEnablement()},t.prototype.onConfigurationUpdated=function(t){this.previewEditors=t.workbench.editor.enablePreview,this.showTabs=t.workbench.editor.showTabs},t.prototype.updateSplitActionEnablement=function(){if(this.context){var t=this.stacks.groups.length;this.splitEditorAction.enabled=t<3}},t.prototype.onSchedule=function(){this.refreshScheduled?this.doRefresh():this.doUpdate(),this.refreshScheduled=!1},t.prototype.setContext=function(t){this.context=t},t.prototype.update=function(t){t?(this.scheduler.cancel(),this.onSchedule()):this.scheduler.schedule()},t.prototype.refresh=function(t){this.refreshScheduled=!0,t?(this.scheduler.cancel(),this.onSchedule()):this.scheduler.schedule()},t.prototype.create=function(t){this.parent=t},t.prototype.getContainer=function(){return this.parent},t.prototype.doUpdate=function(){this.doRefresh()},t.prototype.layout=function(){},t.prototype.allowDragging=function(t){return!s.findParentWithClass(t,"monaco-action-bar","one-editor-silo")},t.prototype.initActions=function(){this.closeEditorAction=this.instantiationService.createInstance(C.CloseEditorAction,C.CloseEditorAction.ID,e.localize("close","Close")),this.closeOtherEditorsAction=this.instantiationService.createInstance(C.CloseOtherEditorsInGroupAction,C.CloseOtherEditorsInGroupAction.ID,e.localize("closeOthers","Close Others")),this.closeRightEditorsAction=this.instantiationService.createInstance(C.CloseRightEditorsInGroupAction,C.CloseRightEditorsInGroupAction.ID,e.localize("closeRight","Close to the Right")),this.closeEditorsInGroupAction=this.instantiationService.createInstance(C.CloseEditorsInGroupAction,C.CloseEditorsInGroupAction.ID,e.localize("closeAll","Close All")),this.pinEditorAction=this.instantiationService.createInstance(C.KeepEditorAction,C.KeepEditorAction.ID,e.localize("keepOpen","Keep Open")),this.showEditorsInGroupAction=this.instantiationService.createInstance(C.ShowEditorsInGroupAction,C.ShowEditorsInGroupAction.ID,e.localize("showOpenedEditors","Show Opened Editors")),this.splitEditorAction=this.instantiationService.createInstance(C.SplitEditorAction,C.SplitEditorAction.ID,C.SplitEditorAction.LABEL),this.showEditorsInGroupAction["class"]="show-group-editors-action"},t.prototype.createEditorActionsToolBar=function(t){var o=this;this.editorActionsToolbar=new v.ToolBar(t,this.contextMenuService,{actionItemProvider:function(t){return o.actionItemProvider(t)},orientation:l.ActionsOrientation.HORIZONTAL,ariaLabel:e.localize("araLabelEditorActions","Editor actions"),getKeyBinding:function(t){var e=o.keybindingService.lookupKeybindings(t.id);return e.length>0?e[0]:null}}),this.toDispose.push(this.editorActionsToolbar.actionRunner.addListener2(u.EventType.RUN,function(t){t.error&&!n.isPromiseCanceledError(t.error)&&o.messageService.show(m.Severity.Error,t.error),o.telemetryService&&o.telemetryService.publicLog("workbenchActionExecuted",{id:t.action.id,from:"editorPart"})}))},t.prototype.actionItemProvider=function(t){if(!this.context)return null;var o,e=this.context,n=this.stacks.positionOfGroup(e),s=this.editorService.getVisibleEditors()[n];if(s instanceof a.BaseEditor&&(o=s.getActionItem(t)),!o){var c=i.Registry.as(r.Extensions.Actionbar);o=c.getActionItemForContext(r.Scope.EDITOR,{input:s&&s.input,editor:s,position:n},t)}return o||(o=x.createActionItem(t,this.keybindingService,this.messageService)),o},t.prototype.getEditorActions=function(t){var o=[],e=[],i=t.group,r=this.stacks.positionOfGroup(i);this.resourceContext.set(i&&h.getResource(i.activeEditor));var n=this.editorService.getVisibleEditors()[r];if(n instanceof a.BaseEditor&&n.input&&"number"==typeof n.position){var s=this.mapActionsToEditors[n.getId()];s||(s=this.getEditorActionsForContext(n),this.mapActionsToEditors[n.getId()]=s),o.push.apply(o,s.primary),e.push.apply(e,s.secondary);var c=this.getEditorActionsForContext({input:n.input,editor:n,position:n.position});o.push.apply(o,c.primary),e.push.apply(e,c.secondary),x.fillInActions(this.contributedTitleBarMenu,{primary:o,secondary:e})}return{primary:o,secondary:e}},t.prototype.getEditorActionsForContext=function(t){var o=[],e=[];if(t instanceof a.BaseEditor)o.push.apply(o,t.getActions()),e.push.apply(e,t.getSecondaryActions());else{var n=i.Registry.as(r.Extensions.Actionbar);o.push.apply(o,n.getActionBarActionsForContext(r.Scope.EDITOR,t)),e.push.apply(e,n.getSecondaryActionBarActionsForContext(r.Scope.EDITOR,t))}return{primary:o,secondary:e}},t.prototype.updateEditorActionsToolbar=function(){var t=this.context;if(t){var o=t&&t.activeEditor,e=this.stacks.isActive(t),i=[],n=[];if(e){var s=this.getEditorActions({group:t,editor:o});i=r.prepareActions(s.primary),e&&o instanceof h.EditorInput&&o.supportsSplitEditor()&&i.push(this.splitEditorAction),n=r.prepareActions(s.secondary)}this.showTabs&&O&&i.push(this.showEditorsInGroupAction),this.showTabs&&(O||(n.length>0&&n.push(new l.Separator),n.push(this.showEditorsInGroupAction)),n.push(new l.Separator),n.push(this.closeEditorsInGroupAction));var c=i.map(function(t){return t.id});this.showTabs||c.push(this.closeEditorAction.id);var a=n.map(function(t){return t.id});p.equals(c,this.currentPrimaryEditorActionIds)&&p.equals(a,this.currentSecondaryEditorActionIds)||(this.editorActionsToolbar.setActions(i,n)(),this.showTabs||this.editorActionsToolbar.addPrimaryAction(this.closeEditorAction)(),this.currentPrimaryEditorActionIds=c,this.currentSecondaryEditorActionIds=a)}},t.prototype.clearEditorActionsToolbar=function(){this.editorActionsToolbar.setActions([],[])(),this.currentPrimaryEditorActionIds=[],this.currentSecondaryEditorActionIds=[]},t.prototype.onContextMenu=function(t,o,e){var i=this,r=e;if(o instanceof MouseEvent){var n=new y.StandardMouseEvent(o);r={x:n.posx,y:n.posy}}this.contextMenuService.showContextMenu({getAnchor:function(){return r},getActions:function(){return c.TPromise.as(i.getContextMenuActions(t))},getActionsContext:function(){return t},getKeyBinding:function(t){var o=i.keybindingService.lookupKeybindings(t.id);return o.length>0?o[0]:null}})},t.prototype.getContextMenuActions=function(t){var o=t.editor,e=t.group;this.closeOtherEditorsAction.enabled=e.count>1,this.pinEditorAction.enabled=!e.isPinned(o),this.closeRightEditorsAction.enabled=e.indexOf(o)!==e.count-1;var i=[this.closeEditorAction,this.closeOtherEditorsAction];return this.showTabs&&i.push(this.closeRightEditorsAction),i.push(this.closeEditorsInGroupAction),this.previewEditors&&i.push(new l.Separator,this.pinEditorAction),i},t.prototype.dispose=function(){k.dispose(this.toDispose),[this.splitEditorAction,this.showEditorsInGroupAction,this.closeEditorAction,this.closeRightEditorsAction,this.closeOtherEditorsAction,this.closeEditorsInGroupAction,this.pinEditorAction].forEach(function(t){t.dispose()}),this.editorActionsToolbar.dispose()},t=__decorate([__param(0,A.IContextMenuService),__param(1,S.IInstantiationService),__param(2,E.IConfigurationService),__param(3,f.IWorkbenchEditorService),__param(4,g.IEditorGroupService),__param(5,w.IKeybindingService),__param(6,b.ITelemetryService),__param(7,m.IMessageService),__param(8,T.IMenuService),__param(9,I.IQuickOpenService)],t)}();o.TitleControl=D});