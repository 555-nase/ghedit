/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","path","fs","os","crypto","assert","vs/platform/files/common/files","vs/base/common/strings","vs/base/common/arrays","vs/base/common/mime","vs/base/common/paths","vs/base/common/winjs.base","vs/base/common/types","vs/base/common/objects","vs/base/node/extfs","vs/base/common/async","vs/base/common/uri","vs/nls","vs/base/node/pfs","vs/base/node/encoding","vs/base/node/mime","vs/base/node/flow","vs/workbench/services/files/node/watcher/unix/watcherService","vs/workbench/services/files/node/watcher/win32/watcherService","vs/workbench/services/files/node/watcher/common"],function(e,t,r,i,n,o,s,a,l,c,h,u,p,f,v,m,d,g,F,y,E,P,b,T,w,O){"use strict";function C(e,t){var r,i;return"number"==typeof t?(r=e,i=t):(r=e.size,i=e.mtime.getTime()),'"'+o.createHash("sha1").update(String(r)+String(i)).digest("hex")+'"'}var _=function(){function e(t,i,o){if(this.eventEmitter=o,this.basePath=t?r.normalize(t):void 0,this.basePath&&0===this.basePath.indexOf("\\\\")&&l.endsWith(this.basePath,r.sep)&&(this.basePath=l.rtrim(this.basePath,r.sep)),this.basePath&&!r.isAbsolute(t))throw new Error("basePath has to be an absolute path");this.options=i||Object.create(null),this.tmpPath=this.options.tmpDir||n.tmpdir(),this.options&&!this.options.errorLogger&&(this.options.errorLogger=console.error),this.basePath&&!this.options.disableWatcher&&("win32"===process.platform?this.setupWin32WorkspaceWatching():this.setupUnixWorkspaceWatching()),this.activeFileChangesWatchers=Object.create(null),this.fileChangesWatchDelayer=new d.ThrottledDelayer(e.FS_EVENT_DELAY),this.undeliveredRawFileChangesEvents=[]}return e.prototype.updateOptions=function(e){e&&v.mixin(this.options,e)},e.prototype.setupWin32WorkspaceWatching=function(){this.workspaceWatcherToDispose=new w.FileWatcher(this.basePath,this.options.watcherIgnoredPatterns,this.eventEmitter,this.options.errorLogger,this.options.verboseLogging).startWatching()},e.prototype.setupUnixWorkspaceWatching=function(){this.workspaceWatcherToDispose=new T.FileWatcher(this.basePath,this.options.watcherIgnoredPatterns,this.eventEmitter,this.options.errorLogger,this.options.verboseLogging,this.options.debugBrkFileWatcherPort).startWatching()},e.prototype.resolveFile=function(e,t){return this.resolve(e,t)},e.prototype.existsFile=function(e){return this.resolveFile(e).then(function(){return!0},function(){return!1})},e.prototype.resolveContent=function(e,t){var r=this;return this.doResolveContent(e,t,function(e,t,i){return r.resolveFileContent(e,t,i)})},e.prototype.resolveStreamContent=function(e,t){var r=this;return this.doResolveContent(e,t,function(e,t,i){return r.resolveFileStreamContent(e,t,i)})},e.prototype.doResolveContent=function(e,t,r){var i=this,n=this.toAbsolutePath(e);return d.nfcall(P.detectMimesFromFile,n).then(function(n){var o=n.mimes.indexOf(h.MIME_BINARY)===-1;if(t&&t.acceptTextOnly&&!o)return p.TPromise.wrapError({message:F.localize("fileBinaryError","File seems to be binary and cannot be opened as text"),fileOperationResult:a.FileOperationResult.FILE_IS_BINARY});var s;return t&&t.encoding?s=n.encoding===E.UTF8&&t.encoding===E.UTF8?E.UTF8_with_bom:t.encoding:n.encoding?s=n.encoding===E.UTF8?E.UTF8_with_bom:n.encoding:i.options.encoding===E.UTF8_with_bom&&(s=E.UTF8),r(e,t&&t.etag,s).then(function(e){return e.mime=n.mimes.join(", "),e})},function(e){return f.isUndefinedOrNull(e.fileOperationResult)?y.exists(n).then(function(t){return t?y.stat(n).then(function(t){return t.isDirectory()?p.TPromise.wrapError({message:F.localize("fileIsDirectoryError","File is directory ({0})",n),fileOperationResult:a.FileOperationResult.FILE_IS_DIRECTORY}):p.TPromise.wrapError(e)}):p.TPromise.wrapError({message:F.localize("fileNotFoundError","File not found ({0})",n),fileOperationResult:a.FileOperationResult.FILE_NOT_FOUND})}):p.TPromise.wrapError(e)})},e.prototype.resolveContents=function(t){var r=this,i=new d.Limiter(e.MAX_DEGREE_OF_PARALLEL_FS_OPS),n=[];return t.forEach(function(e){n.push(i.queue(function(){return r.resolveFileContent(e).then(function(e){return e},function(e){return p.TPromise.as(null)})}))}),p.TPromise.join(n).then(function(e){return c.coalesce(e)})},e.prototype.updateContent=function(e,t,i){var n=this;void 0===i&&(i=Object.create(null));var o=this.toAbsolutePath(e);return this.checkFile(o,i).then(function(s){var a;return a=s?p.TPromise.as(null):y.mkdirp(r.dirname(o)),a.then(function(){var r=n.getEncoding(e,i.encoding),a=p.TPromise.as(!1);return r===E.UTF16be||r===E.UTF16le||r===E.UTF8_with_bom?a=p.TPromise.as(!0):s&&r===E.UTF8&&(a=i.overwriteEncoding?p.TPromise.as(!1):d.nfcall(E.detectEncodingByBOM,o).then(function(e){return e===E.UTF8})),a.then(function(i){var s;if(i||r!==E.UTF8){var a=E.encode(t,r,{addBOM:i});s=y.writeFile(o,a)}else s=y.writeFile(o,t,E.UTF8);return s.then(function(){return n.resolve(e)})})})})},e.prototype.createFile=function(e,t){return void 0===t&&(t=""),this.updateContent(e,t)},e.prototype.createFolder=function(e){var t=this,r=this.toAbsolutePath(e);return y.mkdirp(r).then(function(){return t.resolve(e)})},e.prototype.rename=function(e,t){var i=r.join(r.dirname(e.fsPath),t);return this.moveFile(e,g["default"].file(i))},e.prototype.moveFile=function(e,t,r){return this.moveOrCopyFile(e,t,!1,r)},e.prototype.copyFile=function(e,t,r){return this.moveOrCopyFile(e,t,!0,r)},e.prototype.moveOrCopyFile=function(e,t,r,i){var n=this,o=this.toAbsolutePath(e),s=this.toAbsolutePath(t);return this.doMoveOrCopyFile(o,s,r,i).then(function(){return n.resolve(t)})},e.prototype.doMoveOrCopyFile=function(e,t,i,n){var o=this;return y.exists(t).then(function(s){var l=e.toLowerCase()===t.toLowerCase(),c=e===t;if(s&&!l&&!n)return p.TPromise.wrapError({fileOperationResult:a.FileOperationResult.FILE_MOVE_CONFLICT});var h=p.TPromise.as(null);if(s&&!l){if(u.isEqualOrParent(e,t))return p.TPromise.wrapError(F.localize("unableToMoveCopyError","Unable to move/copy. File would replace folder it is contained in."));h=o.del(g["default"].file(t))}return h.then(function(){return y.mkdirp(r.dirname(t)).then(function(){return c?p.TPromise.as(null):i?d.nfcall(m.copy,e,t):d.nfcall(m.mv,e,t)}).then(function(){return s})})})},e.prototype.importFile=function(e,t){var i=this,n=this.toAbsolutePath(e),o=g["default"].file(r.join(t.fsPath,r.basename(e.fsPath))),s=this.toAbsolutePath(o);return y.stat(n).then(function(e){return e.isDirectory()?p.TPromise.wrapError(F.localize("foldersCopyError","Folders cannot be copied into the workspace. Please select individual files to copy them.")):i.doMoveOrCopyFile(n,s,!0,!0).then(function(e){return i.resolve(o).then(function(t){return{isNew:!e,stat:t}})})})},e.prototype.del=function(e){var t=this.toAbsolutePath(e);return d.nfcall(m.del,t,this.tmpPath)},e.prototype.toAbsolutePath=function(e){var t;return t=e instanceof g["default"]?e:e.resource,s.ok(t&&"file"===t.scheme,"Invalid resource: "+t),r.normalize(t.fsPath)},e.prototype.resolve=function(e,t){return void 0===t&&(t=Object.create(null)),this.toStatResolver(e).then(function(e){return e.resolve(t)})},e.prototype.toStatResolver=function(e){var t=this,r=this.toAbsolutePath(e);return y.stat(r).then(function(r){return new R(e,r.isDirectory(),r.mtime.getTime(),r.size,t.options.verboseLogging)})},e.prototype.resolveFileStreamContent=function(e,t,r){var n=this,o=this.toAbsolutePath(e);return this.resolve(e).then(function(e){if(t&&t===e.etag)return p.TPromise.wrapError({fileOperationResult:a.FileOperationResult.FILE_NOT_MODIFIED_SINCE});if(f.isNumber(e.size)&&e.size>a.MAX_FILE_SIZE)return p.TPromise.wrapError({fileOperationResult:a.FileOperationResult.FILE_TOO_LARGE});var s=n.getEncoding(e.resource,r),l=i.createReadStream(o).pipe(E.decodeStream(s)),c=e;return c.value=l,c.encoding=s,p.TPromise.as(c)})},e.prototype.resolveFileContent=function(e,t,r){return this.resolveFileStreamContent(e,t,r).then(function(e){return new p.TPromise(function(t,r){var i=!1,n=[];e.value.on("data",function(e){n.push(e)}),e.value.on("error",function(e){i||(i=!0,r(e))}),e.value.on("end",function(){var r=e;r.value=n.join(""),i||(i=!0,t(r))})})})},e.prototype.getEncoding=function(e,t){var r,i=this.getEncodingOverride(e);return r=i?i:t?t:this.options.encoding,r&&E.encodingExists(r)||(r=E.UTF8),r},e.prototype.getEncodingOverride=function(e){if(e&&this.options.encodingOverride&&this.options.encodingOverride.length)for(var t=0;t<this.options.encodingOverride.length;t++){var r=this.options.encodingOverride[t];if(0===e.toString().indexOf(r.resource.toString()+"/"))return r.encoding}return null},e.prototype.checkFile=function(e,t){return y.exists(e).then(function(r){return r?y.stat(e).then(function(i){if(i.isDirectory())return p.TPromise.wrapError(new Error("Expected file is actually a directory"));if("number"==typeof t.mtime&&"string"==typeof t.etag&&t.mtime<i.mtime.getTime()&&t.etag!==C(i.size,t.mtime))return p.TPromise.wrapError({message:"File Modified Since",fileOperationResult:a.FileOperationResult.FILE_MODIFIED_SINCE});var n=i.mode,o=!(128&n);return o&&!t.overwriteReadonly?p.TPromise.wrapError({message:F.localize("fileReadOnlyError","File is Read Only"),fileOperationResult:a.FileOperationResult.FILE_READ_ONLY}):o?(n=128|n,y.chmod(e,n).then(function(){return r})):p.TPromise.as(r)}):p.TPromise.as(r)})},e.prototype.watchFileChanges=function(e){var t=this;s.ok(e&&"file"===e.scheme,"Invalid resource for watching: "+e);var r=e.fsPath,n=this.activeFileChangesWatchers[e.toString()];if(!n){try{n=i.watch(r)}catch(o){return}this.activeFileChangesWatchers[e.toString()]=n,n.on("change",function(e){"change"===e&&(t.undeliveredRawFileChangesEvents.push({type:a.FileChangeType.UPDATED,path:r}),t.fileChangesWatchDelayer.trigger(function(){var e=t.undeliveredRawFileChangesEvents;t.undeliveredRawFileChangesEvents=[];var r=O.normalize(e);return t.eventEmitter.emit(a.EventType.FILE_CHANGES,O.toFileChangesEvent(r)),p.TPromise.as(null)}))})}},e.prototype.unwatchFileChanges=function(e){var t="string"==typeof e?g["default"].parse(e):e,r=this.activeFileChangesWatchers[t.toString()];r&&(r.close(),delete this.activeFileChangesWatchers[t.toString()])},e.prototype.dispose=function(){this.workspaceWatcherToDispose&&(this.workspaceWatcherToDispose(),this.workspaceWatcherToDispose=null);for(var e in this.activeFileChangesWatchers){var t=this.activeFileChangesWatchers[e];t.close()}this.activeFileChangesWatchers=Object.create(null)},e.FS_EVENT_DELAY=50,e.MAX_DEGREE_OF_PARALLEL_FS_OPS=10,e}();t.FileService=_;var R=function(){function e(e,t,i,n,o){s.ok(e&&"file"===e.scheme,"Invalid resource: "+e),this.resource=e,this.isDirectory=t,this.mtime=i,this.name=r.basename(e.fsPath),this.mime=this.isDirectory?null:h.guessMimeTypes(e.fsPath).join(", "),this.etag=C(n,i),this.size=n,this.verboseLogging=o}return e.prototype.resolve=function(e){var t=this,r={resource:this.resource,isDirectory:this.isDirectory,hasChildren:void 0,name:this.name,etag:this.etag,size:this.size,mtime:this.mtime,mime:this.mime};if(this.isDirectory){var i=null;return e&&e.resolveTo&&(i=[],e.resolveTo.forEach(function(e){i.push(e.fsPath)})),new p.TPromise(function(n,o){t.resolveChildren(t.resource.fsPath,i,e&&e.resolveSingleChildDescendants,function(e){e=c.coalesce(e),r.hasChildren=e&&e.length>0,r.children=e||[],n(r)})})}return p.TPromise.as(r)},e.prototype.resolveChildren=function(e,t,n,o){var s=this;m.readdir(e,function(a,l){return a?(s.verboseLogging&&console.error(a),o(null)):void b.parallel(l,function(o,a){var p,f=g["default"].file(r.resolve(e,o)),v=s;b.sequence(function(e){v.verboseLogging&&console.error(e),a(null,null)},function(){i.stat(f.fsPath,this)},function(e){var t=this;p=e,p.isDirectory()?m.readdir(f.fsPath,function(e,r){t(null,r?r.length:0)}):this(null,0)},function(e){var r={resource:f,isDirectory:p.isDirectory(),hasChildren:e>0,name:o,mtime:p.mtime.getTime(),etag:C(p),size:p.size,mime:p.isDirectory()?void 0:h.guessMimeTypes(f.fsPath).join(", ")};if(!p.isDirectory())return a(null,r);var i=!1;1===l.length&&n?i=!0:e>0&&t&&t.some(function(e){return u.isEqualOrParent(e,f.fsPath)})&&(i=!0),i?v.resolveChildren(f.fsPath,t,n,function(e){e=c.coalesce(e),r.hasChildren=e&&e.length>0,r.children=e||[],a(null,r)}):a(null,r)})},function(e,t){o(t)})})},e}();t.StatResolver=R});