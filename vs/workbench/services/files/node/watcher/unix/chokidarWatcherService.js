/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","chokidar","fs","graceful-fs","vs/base/common/winjs.base","vs/platform/files/common/files","vs/base/common/async","vs/base/common/strings","vs/workbench/services/files/node/watcher/common"],function(e,n,o,r,a,i,t,s,c,l){"use strict";a.gracefulify(r);var g=function(){function e(){}return e.prototype.watch=function(n){var r=this,a={ignoreInitial:!0,ignorePermissionErrors:!0,followSymlinks:!0,ignored:n.ignored,interval:1e3,binaryInterval:1e3},g=o.watch(n.basePath,a);"darwin"!==process.platform||g.options.useFsEvents||console.error("Watcher is not using native fsevents library and is falling back to unefficient polling.");var h=[],p=new s.ThrottledDelayer(e.FS_EVENT_DELAY);return new i.TPromise(function(o,a,s){g.on("all",function(o,a){if(!(a.indexOf(n.basePath)<0)){var g=null;if("change"===o?g={type:0,path:a}:"add"===o||"addDir"===o?g={type:1,path:a}:"unlink"!==o&&"unlinkDir"!==o||(g={type:2,path:a}),g){n.verboseLogging&&console.log(g.type===t.FileChangeType.ADDED?"[ADDED]":g.type===t.FileChangeType.DELETED?"[DELETED]":"[CHANGED]",g.path);var E=Date.now();0===h.length?(r.spamWarningLogged=!1,r.spamCheckStartTime=E):!r.spamWarningLogged&&r.spamCheckStartTime+e.EVENT_SPAM_WARNING_THRESHOLD<E&&(r.spamWarningLogged=!0,console.warn(c.format('Watcher is busy catching up with {0} file changes in 60 seconds. Latest changed path is "{1}"',h.length,g.path))),h.push(g),p.trigger(function(){var e=h;h=[];var o=l.normalize(e);return s(o),n.verboseLogging&&o.forEach(function(e){console.log(" >> normalized",e.type===t.FileChangeType.ADDED?"[ADDED]":e.type===t.FileChangeType.DELETED?"[DELETED]":"[CHANGED]",e.path)}),i.TPromise.as(null)})}}}),g.on("error",function(e){e&&console.error(e.toString())})},function(){g.close(),p.cancel()})},e.FS_EVENT_DELAY=50,e.EVENT_SPAM_WARNING_THRESHOLD=6e4,e}();n.ChokidarWatcherService=g});