/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,o){function n(){this.constructor=e}for(var t in o)o.hasOwnProperty(t)&&(e[t]=o[t]);e.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)},__decorate=this&&this.__decorate||function(e,o,n,t){var s,i=arguments.length,r=i<3?o:null===t?t=Object.getOwnPropertyDescriptor(o,n):t;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,o,n,t);else for(var c=e.length-1;c>=0;c--)(s=e[c])&&(r=(i<3?s(r):i>3?s(o,n,r):s(o,n))||r);return i>3&&r&&Object.defineProperty(o,n,r),r},__param=this&&this.__param||function(e,o){return function(n,t){o(n,t,e)}};define(["require","exports","vs/nls","vs/base/common/actions","vs/base/common/errors","vs/base/common/marshalling","vs/base/common/objects","vs/base/common/strings","vs/base/common/uri","vs/base/common/winjs.base","vs/base/node/ports","vs/platform/extensions/common/ipcRemoteCom","vs/platform/message/common/message","vs/workbench/services/thread/common/abstractThreadService","vs/platform/lifecycle/common/lifecycle","vs/platform/workspace/common/workspace","vs/workbench/services/window/electron-browser/windowService","child_process","electron"],function(e,o,n,t,s,i,r,c,a,l,d,u,v,p,m,g,h,x,f){"use strict";o.EXTENSION_LOG_BROADCAST_CHANNEL="vscode:extensionLog",o.EXTENSION_ATTACH_BROADCAST_CHANNEL="vscode:extensionAttach",o.EXTENSION_TERMINATE_BROADCAST_CHANNEL="vscode:extensionTerminate";var E=!1,H=function(e){function o(o,n,t,s){var i=this;e.call(this,!0),this.extensionHostProcessManager=new b(o,n,t,s);var r=E||o.getConfiguration().env.logExtensionHostCommunication;this.remoteCom=u.create(function(e){r&&console.log("%c[Window → Extension]%c[len: "+c.pad(e.length,5," ")+"]","color: darkgreen","color: grey",e),i.extensionHostProcessManager.postMessage(e)}),this.extensionHostProcessManager.startExtensionHostProcess(function(e){r&&console.log("%c[Extension → Window]%c[len: "+c.pad(e.length,5," ")+"]","color: darkgreen","color: grey",e),i.remoteCom.handle(e)}),this.remoteCom.setManyHandler(this),s.onShutdown(function(){return i.dispose()})}return __extends(o,e),o.prototype.dispose=function(){this.extensionHostProcessManager.terminate()},o.prototype._callOnRemote=function(e,o,n){return this.remoteCom.callOnRemote(e,o,n)},o=__decorate([__param(0,g.IWorkspaceContextService),__param(1,v.IMessageService),__param(2,h.IWindowService),__param(3,m.ILifecycleService)],o)}(p.AbstractThreadService);o.MainThreadService=H;var b=function(){function c(e,o,n,t){this.contextService=e,this.messageService=o,this.windowService=n,this.lifecycleService=t;var s=this.contextService.getConfiguration();this.isExtensionDevelopmentHost=!!s.env.extensionDevelopmentPath,this.isExtensionDevelopmentDebugging=!!s.env.debugBrkExtensionHost,this.isExtensionDevelopmentTestFromCli=this.isExtensionDevelopmentHost&&!!s.env.extensionTestsPath&&!s.env.debugBrkExtensionHost,this.unsentMessages=[],this.extensionHostProcessReady=!1,t.onWillShutdown(this._onWillShutdown,this)}return c.prototype.startExtensionHostProcess=function(c){var d=this,u=this.contextService.getConfiguration(),p={env:r.mixin(r.clone(process.env),{AMD_ENTRYPOINT:"vs/workbench/node/extensionHostProcess",PIPE_LOGGING:"true",VERBOSE_LOGGING:!0})};u.env.isBuilt&&!this.isExtensionDevelopmentHost||(this.initializeTimer=setTimeout(function(){var e=d.isExtensionDevelopmentDebugging?n.localize("extensionHostProcess.startupFailDebug","Extension host did not start in 10 seconds, it might be stopped on the first line and needs a debugger to continue."):n.localize("extensionHostProcess.startupFail","Extension host did not start in 10 seconds, that might be a problem.");d.messageService.show(v.Severity.Warning,e)},1e4)),this.initializeExtensionHostProcess=new l.TPromise(function(r,m){return d.resolveDebugPort(u,function(m){m&&(p.execArgv=["--nolazy",(d.isExtensionDevelopmentDebugging?"--debug-brk=":"--debug=")+m]),d.extensionHostProcessHandle=x.fork(a["default"].parse(e.toUrl("bootstrap")).fsPath,["--type=extensionHost"],p),d.isExtensionDevelopmentHost&&m&&d.windowService.broadcast({channel:o.EXTENSION_ATTACH_BROADCAST_CHANNEL,payload:{port:m}},u.env.extensionDevelopmentPath),d.extensionHostProcessHandle.on("message",function(e){if("ready"===e){d.initializeTimer&&window.clearTimeout(d.initializeTimer);var n=i.stringify({parentPid:process.pid,contextService:{workspace:d.contextService.getWorkspace(),configuration:d.contextService.getConfiguration(),options:d.contextService.getOptions()}});d.extensionHostProcessHandle.send(n)}else if("initialized"===e)d.unsentMessages.forEach(function(e){return d.postMessage(e)}),d.unsentMessages=[],d.extensionHostProcessReady=!0,r(d.extensionHostProcessHandle);else if(e&&"__$console"===e.type){var t=e,s=[];try{var a=JSON.parse(t.arguments);s.push.apply(s,Object.getOwnPropertyNames(a).map(function(e){return a[e]}))}catch(l){s.push(t.arguments)}var v=[];v="string"==typeof s[0]&&s[0].indexOf("%")>=0?["%c[Extension Host]%c "+s[0],"color: blue","color: black"].concat(s.slice(1)):["%c[Extension Host]","color: blue"].concat(s),d.isExtensionDevelopmentTestFromCli||console[t.severity].apply(console,v),d.isExtensionDevelopmentTestFromCli?f.ipcRenderer.send("vscode:log",t):u.env.isBuilt&&!d.isExtensionDevelopmentHost||d.windowService.broadcast({channel:o.EXTENSION_LOG_BROADCAST_CHANNEL,payload:t},u.env.extensionDevelopmentPath)}else c(e)});var g=function(){return d.terminate()};process.once("exit",g),d.extensionHostProcessHandle.on("error",function(e){var o=s.toErrorMessage(e);o!==d.lastExtensionHostError&&(d.lastExtensionHostError=o,d.messageService.show(v.Severity.Error,n.localize("extensionHostProcess.error","Error from the extension host: {0}",o)))}),d.extensionHostProcessHandle.on("exit",function(e,o){process.removeListener("exit",g),d.terminating||(d.isExtensionDevelopmentHost?d.isExtensionDevelopmentTestFromCli?f.ipcRenderer.send("vscode:exit",e):d.windowService.getWindow().close():(d.messageService.show(v.Severity.Error,{message:n.localize("extensionHostProcess.crash","Extension host terminated unexpectedly. Please reload the window to recover."),actions:[new t.Action("reloadWindow",n.localize("reloadWindow","Reload Window"),null,(!0),function(){return d.windowService.getWindow().reload(),l.TPromise.as(null)})]}),console.error("Extension host terminated unexpectedly. Code: ",e," Signal: ",o)))})})},function(){return d.terminate()})},c.prototype.resolveDebugPort=function(e,o){var n=this;return"number"==typeof e.env.debugExtensionHostPort?d.findFreePort(e.env.debugExtensionHostPort,10,5e3,function(t){return t?(t!==e.env.debugExtensionHostPort&&console.warn("%c[Extension Host] %cProvided debugging port "+e.env.debugExtensionHostPort+" is not free, using "+t+" instead.","color: blue","color: black"),n.isExtensionDevelopmentDebugging?console.warn("%c[Extension Host] %cSTOPPED on first line for debugging on port "+t,"color: blue","color: black"):console.info("%c[Extension Host] %cdebugger listening on port "+t,"color: blue","color: black"),o(t)):(console.warn("%c[Extension Host] %cCould not find a free port for debugging","color: blue","color: black"),o(void 0))}):o(void 0)},c.prototype.postMessage=function(e){this.extensionHostProcessReady?this.extensionHostProcessHandle.send(e):this.initializeExtensionHostProcess?this.initializeExtensionHostProcess.done(function(o){return o.send(e)}):this.unsentMessages.push(e)},c.prototype.terminate=function(){this.terminating=!0,this.extensionHostProcessHandle&&this.extensionHostProcessHandle.send({type:"__$terminate"})},c.prototype._onWillShutdown=function(e){!this.isExtensionDevelopmentHost||this.isExtensionDevelopmentTestFromCli||this.isExtensionDevelopmentDebugging||(this.windowService.broadcast({channel:o.EXTENSION_TERMINATE_BROADCAST_CHANNEL,payload:!0},this.contextService.getConfiguration().env.extensionDevelopmentPath),e.veto(l.TPromise.timeout(100).then(function(){return!1})))},c}()});