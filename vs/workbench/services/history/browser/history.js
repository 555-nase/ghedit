/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},__decorate=this&&this.__decorate||function(t,e,i,o){var n,r=arguments.length,s=r<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,i,o);else for(var c=t.length-1;c>=0;c--)(n=t[c])&&(s=(r<3?n(s):r>3?n(e,i,s):n(e,i))||s);return r>3&&s&&Object.defineProperty(e,i,s),s},__param=this&&this.__param||function(t,e){return function(i,o){e(i,o,t)}};define(["require","exports","vs/base/common/errors","vs/base/common/platform","vs/nls","vs/base/common/events","vs/workbench/common/editor","vs/workbench/browser/parts/editor/textEditor","vs/workbench/services/editor/common/editorService","vs/editor/common/core/selection","vs/platform/event/common/event","vs/platform/workspace/common/workspace","vs/base/common/lifecycle","vs/platform/storage/common/storage","vs/platform/lifecycle/common/lifecycle","vs/platform/platform","vs/platform/instantiation/common/instantiation","vs/workbench/services/group/common/groupService"],function(t,e,i,o,n,r,s,c,a,h,d,p,l,u,v,f,y,E){"use strict";var S=function(){function t(t,e){this._editorInput=t,this._selection=e}return Object.defineProperty(t.prototype,"editorInput",{get:function(){return this._editorInput},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selection",{get:function(){return this._selection},enumerable:!0,configurable:!0}),t.prototype.justifiesNewPushState=function(e){if(!this._editorInput.matches(e._editorInput))return!0;if(!h.Selection.isISelection(this._selection)||!h.Selection.isISelection(e._selection))return!0;var i=h.Selection.liftSelection(this._selection),o=h.Selection.liftSelection(e._selection);return!(Math.abs(i.getStartPosition().lineNumber-o.getStartPosition().lineNumber)<t.EDITOR_SELECTION_THRESHOLD)},t.EDITOR_SELECTION_THRESHOLD=5,t}();e.EditorState=S;var m=function(){function t(t,e,i,o){var n=this;this.eventService=t,this.editorGroupService=e,this.editorService=i,this.contextService=o,this.toUnbind=[],this.activeEditorListeners=[],window.document.title=this.getWindowTitle(null),this.toUnbind.push(this.editorGroupService.onEditorsChanged(function(){return n.onEditorsChanged()}))}return t.prototype.onEditorsChanged=function(){var t=this;l.dispose(this.activeEditorListeners),this.activeEditorListeners=[];var e=this.editorService.getActiveEditor(),i=e?e.input:void 0;if(this.onEditorEvent(e),i instanceof s.EditorInput&&this.activeEditorListeners.push(i.onDidChangeDirty(function(){t.updateWindowTitle(i)})),e instanceof c.BaseTextEditor){var o=e.getControl();this.activeEditorListeners.push(o.onDidChangeCursorPosition(function(i){t.handleEditorSelectionChangeEvent(e)}))}},t.prototype.onEditorEvent=function(t){var e=t?t.input:null;this.updateWindowTitle(e),this.handleActiveEditorChange(t)},t.prototype.updateWindowTitle=function(t){var e=null;e=t&&t.getName()?this.getWindowTitle(t):this.getWindowTitle(null),window.document.title=e},t.prototype.getWindowTitle=function(t){var e=this.doGetWindowTitle(t);return this.contextService.getConfiguration().env.extensionDevelopmentPath?n.localize("devExtensionWindowTitle","[Extension Development Host] - {0}",e):e},t.prototype.doGetWindowTitle=function(t){var e=this.contextService.getConfiguration().env.appName,i=t&&t.getName();i&&t&&t.isDirty()&&!o.isMacintosh&&(i=n.localize("prefixDecoration","● {0}",i));var r=this.contextService.getWorkspace();if(r){var s=r.name;return i?o.isMacintosh?n.localize("prefixWorkspaceTitleMac","{0} - {1}",i,s):n.localize("prefixWorkspaceTitle","{0} - {1} - {2}",i,s,e):o.isMacintosh?s:n.localize("workspaceTitle","{0} - {1}",s,e)}return i?o.isMacintosh?i:n.localize("prefixTitle","{0} - {1}",i,e):e},t.prototype.dispose=function(){this.toUnbind=l.dispose(this.toUnbind)},t}();e.BaseHistoryService=m;var g=function(t){function e(e,i,o,n,r,c,a){t.call(this,e,o,i,n),this.storageService=r,this.lifecycleService=c,this.instantiationService=a,this.index=-1,this.stack=[],this.recentlyClosed=[],this.loaded=!1,this.registry=f.Registry.as(s.Extensions.Editors),this.registerListeners()}return __extends(e,t),e.prototype.registerListeners=function(){var t=this;this.toUnbind.push(this.lifecycleService.onShutdown(function(){return t.save()})),this.toUnbind.push(this.editorGroupService.onEditorOpenFail(function(e){return t.remove(e)})),this.toUnbind.push(this.editorGroupService.getStacksModel().onEditorClosed(function(e){return t.onEditorClosed(e)}))},e.prototype.onEditorClosed=function(t){var i=this;if(t.pinned){var o=this.restoreInput(t.editor);o&&(this.removeFromRecentlyClosed(o),this.recentlyClosed.push(o),this.recentlyClosed.length>e.MAX_RECENTLY_CLOSED_EDITORS&&this.recentlyClosed.shift(),o.addOneTimeDisposableListener(r.EventType.DISPOSE,function(){i.restoreInRecentlyClosed(o)}))}},e.prototype.popLastClosedEditor=function(){return this.ensureLoaded(),this.recentlyClosed.pop()},e.prototype.forward=function(){this.stack.length>this.index+1&&(this.index++,this.navigate())},e.prototype.back=function(){this.index>0&&(this.index--,this.navigate())},e.prototype.clear=function(){this.ensureLoaded(),this.index=-1,this.stack.splice(0),this.history=[],this.recentlyClosed=[]},e.prototype.navigate=function(){var t=this,e=this.stack[this.index],o=e.options;o?o.revealIfVisible=!0:o={revealIfVisible:!0},this.blockStackChanges=!0,this.editorService.openEditor(e.input,o).done(function(){t.blockStackChanges=!1},function(e){t.blockStackChanges=!1,i.onUnexpectedError(e)})},e.prototype.handleEditorSelectionChangeEvent=function(t){this.handleEditorEventInStack(t,!0)},e.prototype.handleActiveEditorChange=function(t){this.handleEditorEventInHistory(t),this.handleEditorEventInStack(t,!1)},e.prototype.handleEditorEventInHistory=function(t){var i=this,o=t?t.input:void 0;o&&o.getName()&&(this.ensureLoaded(),this.removeFromHistory(o),this.history.unshift(o),this.history.length>e.MAX_HISTORY_ITEMS&&this.history.pop(),o.addOneTimeDisposableListener(r.EventType.DISPOSE,function(){i.restoreInHistory(o)}))},e.prototype.restoreInHistory=function(t){var e=this.indexOf(t);if(!(e<0)){var i=this.restoreInput(t);i?this.history[e]=i:this.removeFromHistory(t,e)}},e.prototype.remove=function(t){var e=this;this.removeFromHistory(t),this.removeFromStack(t),setTimeout(function(){return e.removeFromRecentlyClosed(t)})},e.prototype.removeFromHistory=function(t,e){this.ensureLoaded(),"number"!=typeof e&&(e=this.indexOf(t)),e>=0&&this.history.splice(e,1)},e.prototype.indexOf=function(t){for(var e=0;e<this.history.length;e++){var i=this.history[e];if(i.matches(t))return e}return-1},e.prototype.handleEditorEventInStack=function(t,e){if(!this.blockStackChanges){if(t instanceof c.BaseTextEditor&&t.input)return void this.handleTextEditorEvent(t,e);this.currentFileEditorState=null,t&&t.input&&this.handleNonTextEditorEvent(t)}},e.prototype.handleTextEditorEvent=function(t,e){var i=new S(t.input,t.getSelection());if(!this.currentFileEditorState||this.currentFileEditorState.justifiesNewPushState(i)){this.currentFileEditorState=i;var o=void 0;if(e){var n=t.getSelection();o={selection:{startLineNumber:n.startLineNumber,startColumn:n.startColumn}}}this.addToStack(t.input,o)}},e.prototype.handleNonTextEditorEvent=function(t){var e=this.stack[this.index];e&&e.input.matches(t.input)||this.addToStack(t.input)},e.prototype.addToStack=function(t,i){var o=this,n=!1;if(this.stack[this.index]){var s=this.stack[this.index];s.input.matches(t)&&!s.options&&(n=!0)}var c={input:t,options:i};this.stack.length>this.index+1&&(this.stack=this.stack.slice(0,this.index+1)),n?this.stack[this.index]=c:(this.index++,this.stack.splice(this.index,0,c),this.stack.length>e.MAX_STACK_ITEMS&&(this.stack.shift(),this.index>0&&this.index--)),t.addOneTimeDisposableListener(r.EventType.DISPOSE,function(){o.restoreInStack(t)})},e.prototype.restoreInStack=function(t){var e,i=this,o=!1;this.stack.forEach(function(n,r){n.input.matches(t)&&(o||(e=i.restoreInput(t),o=!0),e?i.stack[r].input=e:(i.stack.splice(r,1),i.index>=r&&i.index--))})},e.prototype.restoreInRecentlyClosed=function(t){var e,i=this,o=!1;this.recentlyClosed.forEach(function(n,r){n.matches(t)&&(o||(e=i.restoreInput(t),o=!0),e?i.recentlyClosed[r]=e:i.stack.splice(r,1))})},e.prototype.restoreInput=function(t){if(t instanceof s.EditorInput){var e=this.registry.getEditorInputFactory(t.getTypeId());if(e){var i=e.serialize(t);if(i)return e.deserialize(this.instantiationService,i)}}return null},e.prototype.removeFromStack=function(t){var e=this;this.stack.forEach(function(i,o){i.input.matches(t)&&(e.stack.splice(o,1),e.index>=o&&e.index--)})},e.prototype.removeFromRecentlyClosed=function(t){var e=this;this.recentlyClosed.forEach(function(i,o){i.matches(t)&&e.recentlyClosed.splice(o,1)})},e.prototype.getHistory=function(){return this.ensureLoaded(),this.history.slice(0)},e.prototype.ensureLoaded=function(){this.loaded||this.load(),this.loaded=!0},e.prototype.save=function(){var t=this;if(this.history){var i=this.history.map(function(e){var i=t.registry.getEditorInputFactory(e.getTypeId());if(i){var o=i.serialize(e);if("string"==typeof o)return{id:e.getTypeId(),value:o}}}).filter(function(t){return!!t});this.storageService.store(e.STORAGE_KEY,JSON.stringify(i),u.StorageScope.WORKSPACE)}},e.prototype.load=function(){var t=this,i=[],o=this.storageService.get(e.STORAGE_KEY,u.StorageScope.WORKSPACE);o&&(i=JSON.parse(o)),this.history=i.map(function(e){var i=t.registry.getEditorInputFactory(e.id);if(i&&"string"==typeof e.value)return i.deserialize(t.instantiationService,e.value)}).filter(function(t){return!!t})},e.STORAGE_KEY="history.entries",e.MAX_HISTORY_ITEMS=200,e.MAX_STACK_ITEMS=20,e.MAX_RECENTLY_CLOSED_EDITORS=20,e=__decorate([__param(0,d.IEventService),__param(1,a.IWorkbenchEditorService),__param(2,E.IEditorGroupService),__param(3,p.IWorkspaceContextService),__param(4,u.IStorageService),__param(5,v.ILifecycleService),__param(6,y.IInstantiationService)],e)}(m);e.HistoryService=g});