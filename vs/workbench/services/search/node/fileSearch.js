/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","fs","path","vs/base/common/scorer","vs/base/common/arrays","vs/base/common/strings","vs/base/common/types","vs/base/common/glob","vs/base/node/extfs","vs/base/node/flow"],function(t,e,i,n,l,s,r,a,o,u,c){"use strict";var h=function(){function t(t){this.config=t,this.filePattern=t.filePattern,this.excludePattern=t.excludePattern,this.includePattern=t.includePattern,this.maxResults=t.maxResults||null,this.maxFilesize=t.maxFilesize||null,this.walkedPaths=Object.create(null),this.resultCount=0,this.isLimitHit=!1,this.directoriesWalked=0,this.filesWalked=0,this.filePattern&&(this.filePattern=this.filePattern.replace(/\\/g,"/"),this.normalizedFilePatternLowercase=r.stripWildcards(this.filePattern).toLowerCase())}return t.prototype.cancel=function(){this.isCanceled=!0},t.prototype.walk=function(t,e,i,l){var s=this;this.fileWalkStartTime=Date.now(),this.checkFilePatternAbsoluteMatch(function(r,a){return s.isCanceled?l(null,s.isLimitHit):r?(i({path:s.filePattern},a),l(null,s.isLimitHit)):(e&&e.forEach(function(t){o.match(s.excludePattern,t)||s.matchFile(i,t,t)}),void c.parallel(t,function(t,e){s.directoriesWalked++,u.readdir(t,function(l,r){return l||s.isCanceled||s.isLimitHit?e(null,null):s.checkFilePatternRelativeMatch(t,function(l,a){return s.isCanceled||s.isLimitHit?e(null,null):(l&&i({path:l},a),s.doWalk(n.normalize(t),"",r,i,e))})})},function(t,e){l(t?t[0]:null,s.isLimitHit)}))})},t.prototype.getStats=function(){return{fileWalkStartTime:this.fileWalkStartTime,fileWalkResultTime:Date.now(),directoriesWalked:this.directoriesWalked,filesWalked:this.filesWalked}},t.prototype.checkFilePatternAbsoluteMatch=function(t){return this.filePattern&&n.isAbsolute(this.filePattern)?i.stat(this.filePattern,function(e,i){return t(!e&&!i.isDirectory(),i&&i.size)}):t(!1)},t.prototype.checkFilePatternRelativeMatch=function(t,e){if(!this.filePattern||n.isAbsolute(this.filePattern))return e(null);var l=n.join(t,this.filePattern);return i.stat(l,function(t,i){return e(t||i.isDirectory()?null:l,i&&i.size)})},t.prototype.doWalk=function(t,e,l,r,h){var f=this;c.parallel(l,function(s,c){if(f.isCanceled||f.isLimitHit)return c(null);var h=l;f.config.filePattern===s&&(h=[]);var d=e?[e,s].join("/"):s;if(o.match(f.excludePattern,d,h))return c(null);var m=[t,s].join(n.sep);i.lstat(m,function(t,e){return t||f.isCanceled||f.isLimitHit?c(null):void f.statLinkIfNeeded(m,e,function(t,i){return t||f.isCanceled||f.isLimitHit?c(null):i.isDirectory()?(f.directoriesWalked++,f.realPathIfNeeded(m,e,function(t,e){return t||f.isCanceled||f.isLimitHit?c(null):f.walkedPaths[e]?c(null):(f.walkedPaths[e]=!0,u.readdir(m,function(t,e){return t||f.isCanceled||f.isLimitHit?c(null):void f.doWalk(m,d,e,r,c)}))})):(f.filesWalked++,d===f.filePattern?c(null):f.maxFilesize&&a.isNumber(i.size)&&i.size>f.maxFilesize?c(null):(f.matchFile(r,m,d,i.size),c(null)))})})},function(t){return t&&(t=s.coalesce(t)),h(t&&t.length>0?t[0]:null,null)})},t.prototype.matchFile=function(t,e,i,n){!this.isFilePatternMatch(i)||this.includePattern&&!o.match(this.includePattern,i)||(this.resultCount++,this.maxResults&&this.resultCount>this.maxResults&&(this.isLimitHit=!0),this.isLimitHit||t({path:e},n))},t.prototype.isFilePatternMatch=function(t){return!this.filePattern||("*"===this.filePattern||l.matches(t,this.normalizedFilePatternLowercase))},t.prototype.statLinkIfNeeded=function(t,e,n){return e.isSymbolicLink()?i.stat(t,n):n(null,e)},t.prototype.realPathIfNeeded=function(t,e,n){return e.isSymbolicLink()?i.realpath(t,function(t,e){return t?n(t):n(null,e)}):n(null,t)},t}();e.FileWalker=h;var f=function(){function t(t){this.rootFolders=t.rootFolders,this.extraFiles=t.extraFiles,this.walker=new h(t)}return t.prototype.search=function(t,e,i){var n=this;this.walker.walk(this.rootFolders,this.extraFiles,t,function(t,e){i(t,{limitHit:e,stats:n.walker.getStats()})})},t.prototype.cancel=function(){this.walker.cancel()},t}();e.Engine=f});