/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","vs/base/common/strings","fs","vs/base/common/mime","vs/base/node/mime","vs/base/node/encoding"],function(e,t,n,i,r,s,o){"use strict";var c=function(){function e(e,t){this.rootFolders=e.rootFolders,this.extraFiles=e.extraFiles,this.walker=t,this.contentPattern=n.createRegExp(e.contentPattern.pattern,e.contentPattern.isRegExp,e.contentPattern.isCaseSensitive,e.contentPattern.isWordMatch,!0),this.isCanceled=!1,this.limitReached=!1,this.maxResults=e.maxResults,this.worked=0,this.progressed=0,this.total=0,this.fileEncoding=o.encodingExists(e.fileEncoding)?e.fileEncoding:o.UTF8}return e.prototype.cancel=function(){this.isCanceled=!0,this.walker.cancel()},e.prototype.search=function(t,n,i){var r=this,s=0,o=function(){r.progressed++,r.progressed%e.PROGRESS_FLUSH_CHUNK_SIZE===0&&n({total:r.total,worked:r.worked})},c=function(e){r.worked+=e,!e||r.isDone||r.isCanceled||r.limitReached||o(),r.worked===r.total&&r.walkerIsDone&&!r.isDone&&(r.isDone=!0,i(r.walkerError,{limitHit:r.limitReached,stats:r.walker.getStats()}))};this.walker.walk(this.rootFolders,this.extraFiles,function(e,n){if(n=n||1,r.total+=n,r.limitReached||r.isCanceled)return c(n);o();var i=null,h=function(e){return e||r.isCanceled||!i||i.isEmpty()||t(i.serialize()),c(n)},u=function(t,n){if(!r.limitReached&&!r.isCanceled)for(var o=null,c=r.contentPattern.exec(t);null!==c&&c[0].length>0&&!r.limitReached&&!r.isCanceled;)s++,r.maxResults&&s>=r.maxResults&&(r.limitReached=!0),null===i&&(i=new a(e.path)),null===o&&(o=new l(t,n),i.addMatch(o)),o.addMatch(c.index,c[0].length),c=r.contentPattern.exec(t)};r.readlinesAsync(e.path,u,{bufferLength:8096,encoding:r.fileEncoding},h)},function(e,t){r.walkerIsDone=!0,r.walkerError=e,c(0)})},e.prototype.readlinesAsync=function(e,t,n,c){var a=this;i.open(e,"r",null,function(e,l){function h(e){return n.encoding===o.UTF8||n.encoding===o.UTF8_with_bom?e.toString():o.decode(e,n.encoding)}function u(e){m+=h(g.slice(f,p+e)),t(m,w),m="",w++,f=p+e}function d(e,t){return E.limitReached||E.isCanceled?t(null):void i.read(l,g,0,g.length,null,function(i,c,a){if(i||0===c||E.limitReached||E.isCanceled)return t(i);if(f=0,p=0,e){var l=s.detectMimeAndEncodingFromBuffer(a,c);if(l.mimes[l.mimes.length-1]!==r.MIME_TEXT)return t(null);switch(l.encoding){case o.UTF8:f=p=3,n.encoding=o.UTF8;break;case o.UTF16be:f=p=2,n.encoding=o.UTF16be;break;case o.UTF16le:f=p=2,n.encoding=o.UTF16le}}for(v&&(10===a[p]?(u(1),p++):u(0),v=!1);p<c;++p)10===a[p]?u(1):13===a[p]&&(p+1===c?v=!0:10===a[p+1]?(u(2),p++):u(1));m+=h(a.slice(f,c)),d(!1,t)})}if(e)return c(e);var f,p,g=new Buffer(n.bufferLength),m="",w=0,v=!1,E=a;d(!0,function(e){return e?c(e):(m.length&&t(m,w),void i.close(l,function(e){c(e)}))})})},e.PROGRESS_FLUSH_CHUNK_SIZE=50,e}();t.Engine=c;var a=function(){function e(e){this.path=e,this.lineMatches=[]}return e.prototype.addMatch=function(e){this.lineMatches.push(e)},e.prototype.isEmpty=function(){return 0===this.lineMatches.length},e.prototype.serialize=function(){for(var e=[],t=0;t<this.lineMatches.length;t++)e.push(this.lineMatches[t].serialize());return{path:this.path,lineMatches:e}},e}(),l=function(){function e(e,t){this.preview=e.replace(/(\r|\n)*$/,""),this.lineNumber=t,this.offsetAndLengths=[]}return e.prototype.getText=function(){return this.preview},e.prototype.getLineNumber=function(){return this.lineNumber},e.prototype.addMatch=function(e,t){this.offsetAndLengths.push([e,t])},e.prototype.serialize=function(){var e={preview:this.preview,lineNumber:this.lineNumber,offsetAndLengths:this.offsetAndLengths};return e},e}()});