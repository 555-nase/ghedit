var __decorate=this&&this.__decorate||function(e,t,r,n){var i,c=arguments.length,a=c<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(a=(c<3?i(a):c>3?i(t,r,a):i(t,r))||a);return c>3&&a&&Object.defineProperty(t,r,a),a},__param=this&&this.__param||function(e,t){return function(r,n){t(r,n,e)}};define(["require","exports","vs/base/common/winjs.base","vs/base/common/uri","vs/base/common/glob","vs/base/common/objects","vs/base/common/scorer","vs/base/common/strings","vs/base/parts/ipc/common/ipc","vs/base/parts/ipc/node/ipc.cp","vs/platform/search/common/search","vs/workbench/services/untitled/common/untitledEditorService","vs/editor/common/services/modelService","vs/platform/workspace/common/workspace","vs/platform/configuration/common/configuration","./searchIpc"],function(e,t,r,n,i,c,a,o,s,u,l,f,h,m,v,p){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var d=function(){function e(e,t,r,n){this.modelService=e,this.untitledEditorService=t,this.contextService=r,this.configurationService=n;var i=r.getConfiguration();this.diskSearch=new g(!i.env.isBuilt||i.env.verboseLogging)}return e.prototype.search=function(e){var t=this,n=this.configurationService.getConfiguration();if(!e.fileEncoding){var i=n&&n.files&&n.files.encoding;e.fileEncoding=i}var a=n&&n.files&&n.files.exclude;a&&(e.excludePattern?c.mixin(e.excludePattern,a,!1):e.excludePattern=a);var o;return new r.PPromise(function(r,n,i){var c=!1,a=t.getLocalResults(e),s=function(){c||(c=!0,Object.keys(a).map(function(e){return a[e]}).filter(function(e){return!!e}).forEach(i))};o=t.diskSearch.search(e).then(function(e){s(),r({limitHit:e.limitHit,results:e.results.filter(function(e){return"undefined"==typeof a[e.resource.toString()]}),stats:e.stats})},function(e){s(),n(e)},function(e){s(),e.resource?"undefined"==typeof a[e.resource.toString()]&&i(e):i(e)})},function(){return o&&o.cancel()})},e.prototype.getLocalResults=function(e){var t=this,r=Object.create(null);if(e.type===l.QueryType.Text){var n=this.modelService.getModels();n.forEach(function(n){var i=n.uri;if(i){if("untitled"===i.scheme){if(!t.untitledEditorService.get(i))return}else if("file"!==i.scheme)return;if(t.matches(i,e.filePattern,e.includePattern,e.excludePattern)){var c=n.findMatches(e.contentPattern.pattern,!1,e.contentPattern.isRegExp,e.contentPattern.isCaseSensitive,e.contentPattern.isWordMatch);if(c.length){var a=new l.FileMatch(i);r[i.toString()]=a,c.forEach(function(e){a.lineMatches.push(new l.LineMatch(n.getLineContent(e.startLineNumber),e.startLineNumber-1,[[e.startColumn-1,e.endColumn-e.startColumn]]))})}else r[i.toString()]=!1}}})}return r},e.prototype.matches=function(e,t,r,n){var c=this.contextService.toWorkspaceRelativePath(e);if(t){if("file"!==e.scheme)return!1;if(!a.matches(e.fsPath,o.stripWildcards(t).toLowerCase()))return!1}if(r){if("file"!==e.scheme)return!1;if(!i.match(r,c||e.fsPath))return!1}if(n){if("file"!==e.scheme)return!0;if(i.match(n,c||e.fsPath))return!1}return!0},e=__decorate([__param(0,h.IModelService),__param(1,f.IUntitledEditorService),__param(2,m.IWorkspaceContextService),__param(3,v.IConfigurationService)],e)}();t.SearchService=d;var g=function(){function t(t){var r=new u.Client(n["default"].parse(e.toUrl("bootstrap")).fsPath,{serverName:"Search",timeout:6e4,args:["--type=searchService"],env:{AMD_ENTRYPOINT:"vs/workbench/services/search/node/searchApp",PIPE_LOGGING:"true",VERBOSE_LOGGING:t}}),i=s.getNextTickChannel(r.getChannel("search"));this.raw=new p.SearchChannelClient(i)}return t.prototype.search=function(e){var r,n={rootFolders:e.folderResources?e.folderResources.map(function(e){return e.fsPath}):[],extraFiles:e.extraFileResources?e.extraFileResources.map(function(e){return e.fsPath}):[],filePattern:e.filePattern,excludePattern:e.excludePattern,includePattern:e.includePattern,maxResults:e.maxResults};return e.type===l.QueryType.Text&&(n.contentPattern=e.contentPattern,n.fileEncoding=e.fileEncoding),r=e.type===l.QueryType.File?this.raw.fileSearch(n):this.raw.textSearch(n),t.collectResults(r)},t.collectResults=function(e){var t=this,n=[];return new r.PPromise(function(r,i,c){e.done(function(e){r({limitHit:e.limitHit,results:n,stats:e.stats})},i,function(e){if(Array.isArray(e)){var r=e.map(function(e){return t.createFileMatch(e)});n=n.concat(r),r.forEach(c)}else if(e.path){var i=t.createFileMatch(e);n.push(i),c(i)}else c(e)})},function(){return e.cancel()})},t.createFileMatch=function(e){var t=new l.FileMatch(n["default"].file(e.path));if(e.lineMatches)for(var r=0;r<e.lineMatches.length;r++)t.lineMatches.push(new l.LineMatch(e.lineMatches[r].preview,e.lineMatches[r].lineNumber,e.lineMatches[r].offsetAndLengths));return t},t}();t.DiskSearch=g});