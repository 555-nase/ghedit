/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","vs/nls","vs/base/common/platform","vs/base/browser/builder","vs/base/browser/dom","vs/base/browser/ui/aria/aria","vs/base/common/lifecycle","vs/base/common/errors","vs/platform/contextview/browser/contextViewService","vs/base/common/timer","vs/workbench/electron-browser/workbench","vs/workbench/common/storage","vs/platform/telemetry/common/telemetry","vs/platform/telemetry/common/telemetryIpc","vs/platform/telemetry/common/telemetryService","vs/platform/telemetry/browser/idleMonitor","vs/platform/telemetry/browser/errorTelemetry","vs/platform/telemetry/node/workbenchCommonProperties","vs/workbench/electron-browser/integration","vs/workbench/electron-browser/update","vs/workbench/services/telemetry/common/workspaceStats","vs/workbench/services/window/electron-browser/windowService","vs/workbench/services/message/electron-browser/messageService","vs/workbench/services/request/node/requestService","vs/platform/configuration/common/configuration","vs/workbench/services/files/electron-browser/fileService","vs/workbench/services/search/node/searchService","vs/workbench/services/lifecycle/electron-browser/lifecycleService","vs/workbench/services/thread/electron-browser/threadService","vs/platform/markers/common/markerService","vs/editor/common/services/modelService","vs/editor/common/services/modelServiceImpl","vs/editor/common/services/compatWorkerService","vs/editor/common/services/compatWorkerServiceMain","vs/editor/browser/services/codeEditorServiceImpl","vs/editor/common/services/codeEditorService","vs/editor/common/services/editorWorkerServiceImpl","vs/editor/common/services/editorWorkerService","vs/workbench/api/node/mainThreadExtensionService","vs/platform/storage/common/storage","vs/platform/instantiation/common/serviceCollection","vs/platform/instantiation/common/instantiationService","vs/platform/contextview/browser/contextView","vs/platform/event/common/event","vs/platform/files/common/files","vs/platform/lifecycle/common/lifecycle","vs/platform/markers/common/markers","vs/platform/message/common/message","vs/platform/request/common/request","vs/platform/search/common/search","vs/workbench/services/thread/common/threadService","vs/platform/commands/common/commands","vs/platform/commands/common/commandService","vs/platform/workspace/common/workspace","vs/platform/extensions/common/extensions","vs/editor/common/services/modeServiceImpl","vs/editor/common/services/modeService","vs/workbench/services/untitled/common/untitledEditorService","vs/workbench/electron-browser/crashReporter","vs/workbench/services/themes/common/themeService","vs/workbench/services/themes/electron-browser/themeService","vs/base/parts/ipc/common/ipc","vs/base/parts/ipc/node/ipc.net","vs/platform/extensionManagement/common/extensionManagementIpc","vs/platform/extensionManagement/common/extensionManagement","vs/workbench/electron-browser/actions","vs/css!./media/shell","vs/platform/opener/electron-browser/opener.contribution"],function(e,t,r,o,n,i,s,c,a,v,m,h,l,d,p,S,u,w,f,g,b,I,k,y,C,E,T,x,M,W,L,A,R,V,P,D,U,H,_,q,O,$,z,N,j,K,B,F,Z,G,J,Q,X,Y,ee,te,re,oe,ne,ie,se,ce,ae,ve,me,he,le){"use strict";var de=function(){function e(e,t,r,o,n){this.container=e,this.workspace=t,this.configuration=o,this.options=n,this.contextService=r.contextService,this.eventService=r.eventService,this.configurationService=r.configurationService,this.toUnbind=[],this.previousErrorTime=0}return e.prototype.createContents=function(e){var t=this;s.setARIAContainer(document.body);var r=n.$(e).div(),o=this.initServiceCollection(),i=o[0],c=o[1];if(this.configuration.env.crashReporter){var a=i.createInstance(ie.CrashReporter,this.configuration.env.version,this.configuration.env.commitHash);a.start(this.configuration.env.crashReporter)}this.workbench=i.createInstance(h.Workbench,r.getHTMLElement(),this.workspace,this.configuration,this.options,c),this.workbench.startup({onWorkbenchStarted:function(e){t.onWorkbenchStarted(e)}}),this.workbench.getInstantiationService().createInstance(g.ElectronIntegration).integrate(this.container),this.workbench.getInstantiationService().createInstance(b.Update);var v=setTimeout(function(){console.warn("Workbench did not finish loading in 10 seconds, that might be a problem that should be reported.")},1e4);return this.workbench.joinCreation().then(function(){clearTimeout(v)}),r},e.prototype.onWorkbenchStarted=function(e){var t={innerHeight:window.innerHeight,innerWidth:window.innerWidth,outerHeight:window.outerHeight,outerWidth:window.outerWidth};this.telemetryService.publicLog("workspaceLoad",{userAgent:navigator.userAgent,windowSize:t,emptyWorkbench:!this.contextService.getWorkspace(),customKeybindingsCount:e,theme:this.themeService.getTheme(),language:o.language});var n=this.workbench.getInstantiationService().createInstance(I.WorkspaceStats);n.reportWorkspaceTags(),(o.isLinux||o.isMacintosh)&&0===process.getuid()&&this.messageService.show(Z.Severity.Warning,r.localize("runningAsRoot","It is recommended not to run Code as 'root'."))},e.prototype.initServiceCollection=function(){var e=this,t=ve.connect(process.env.VSCODE_SHARED_IPC_HOOK);t.done(function(t){t.onClose(function(){e.messageService.show(Z.Severity.Error,{message:r.localize("sharedProcessCrashed","The shared process terminated unexpectedly. Please reload the window to recover."),actions:[n.createInstance(le.ReloadWindowAction,le.ReloadWindowAction.ID,le.ReloadWindowAction.LABEL)]})})},a.onUnexpectedError);var o=new $.ServiceCollection;o.set(j.IEventService,this.eventService),o.set(ee.IWorkspaceContextService,this.contextService),o.set(E.IConfigurationService,this.configurationService);var n=new z.InstantiationService(o,(!0)),i=new c.Disposables;this.windowService=n.createInstance(k.WindowService),o.set(k.IWindowService,this.windowService);var s=this.configuration.env.extensionTestsPath||!this.workspace&&!this.configuration.env.extensionDevelopmentPath;if(this.storageService=n.createInstance(l.Storage,window.localStorage,s?l.inMemoryLocalStorageInstance:window.localStorage),o.set(O.IStorageService,this.storageService),this.configuration.env.isBuilt&&!this.configuration.env.extensionDevelopmentPath&&this.configuration.env.enableTelemetry){var m=ae.getDelayedChannel(t.then(function(e){return e.getChannel("telemetryAppender")})),h=this.contextService.getConfiguration().env.commitHash,g=this.contextService.getConfiguration().env.version,b={appender:new p.TelemetryAppenderClient(m),commonProperties:f.resolveWorkbenchCommonProperties(this.storageService,h,g),piiPaths:[this.configuration.env.appRoot,this.configuration.env.userExtensionsHome]},I=n.createInstance(S.TelemetryService,b);this.telemetryService=I;var ie=new w["default"](I),de=new u.IdleMonitor(12e4),pe=de.onStatusChange(function(t){return e.telemetryService.publicLog(t===u.UserStatus.Active?S.TelemetryService.IDLE_STOP_EVENT_NAME:S.TelemetryService.IDLE_START_EVENT_NAME)});i.add(I,ie,pe,de)}else this.telemetryService=d.NullTelemetryService;o.set(d.ITelemetryService,this.telemetryService),this.messageService=n.createInstance(y.MessageService),o.set(Z.IMessageService,this.messageService);var Se=i.add(n.createInstance(T.FileService));o.set(K.IFileService,Se);var ue=n.createInstance(M.LifecycleService);this.toUnbind.push(ue.onShutdown(function(){return i.dispose()})),o.set(B.ILifecycleService,ue),this.threadService=n.createInstance(W.MainThreadService),o.set(Q.IThreadService,this.threadService);var we=n.createInstance(q.MainProcessExtensionService);o.set(te.IExtensionService,we),o.set(X.ICommandService,new Y.CommandService(n,we)),this.contextViewService=n.createInstance(v.ContextViewService,this.container),o.set(N.IContextViewService,this.contextViewService);var fe=i.add(n.createInstance(C.RequestService));o.set(G.IRequestService,fe);var ge=n.createInstance(L.MarkerService);o.set(F.IMarkerService,ge);var be=n.createInstance(re.MainThreadModeServiceImpl);o.set(oe.IModeService,be);var Ie=n.createInstance(R.ModelServiceImpl);o.set(A.IModelService,Ie);var ke=n.createInstance(P.MainThreadCompatWorkerService);o.set(V.ICompatWorkerService,ke);var ye=n.createInstance(H.EditorWorkerServiceImpl);o.set(_.IEditorWorkerService,ye);var Ce=n.createInstance(ne.UntitledEditorService);o.set(ne.IUntitledEditorService,Ce),this.themeService=n.createInstance(ce.ThemeService),o.set(se.IThemeService,this.themeService);var Ee=n.createInstance(x.SearchService);o.set(J.ISearchService,Ee);var Te=n.createInstance(D.CodeEditorServiceImpl);o.set(U.ICodeEditorService,Te);var xe=ae.getDelayedChannel(t.then(function(e){return e.getChannel("extensions")})),Me=n.createInstance(me.ExtensionManagementChannelClient,xe);return o.set(he.IExtensionManagementService,Me),[n,o]},e.prototype.open=function(){var e=this;a.setUnexpectedErrorHandler(function(t){e.onUnexpectedError(t)}),n.$(this.container).addClass("monaco-shell"),this.content=n.$(".monaco-shell-content").appendTo(this.container).getHTMLElement(),this.writeTimers(),this.contentsContainer=this.createContents(n.$(this.content)),this.layout(),this.registerListeners(),this.themeService.initialize(this.container).then(null,function(e){a.onUnexpectedError(e)})},e.prototype.registerListeners=function(){var e=this;n.$(window).on(i.EventType.RESIZE,function(){return e.layout()},this.toUnbind)},e.prototype.writeTimers=function(){var e=window.MonacoEnvironment.timers;if(e){var t=[];e.beforeProgram&&t.push({startTime:e.beforeProgram,stopTime:e.afterProgram,topic:"Startup",name:"Program Start",description:"Time it takes to pass control to VSCodes main method"}),e.vscodeStart&&t.push({startTime:e.vscodeStart,stopTime:e.beforeLoad,topic:"Startup",name:"VSCode Startup",description:"Time it takes to create a window and startup VSCode"}),t.push({startTime:e.beforeLoad,stopTime:e.afterLoad,topic:"Startup",name:"Load Modules",description:"Time it takes to load VSCodes main modules"}),t.push({startTime:e.beforeReady,stopTime:e.afterReady,topic:"Startup",name:"Event DOMContentLoaded",description:"Time it takes for the DOM to emit DOMContentLoaded event"}),m.getTimeKeeper().setInitialCollectedEvents(t,e.start)}},e.prototype.onUnexpectedError=function(e){var t=a.toErrorMessage(e,!0);if(t){var r=Date.now();t===this.previousErrorValue&&r-this.previousErrorTime<=1e3||(this.previousErrorTime=r,this.previousErrorValue=t,console.error(t),e&&e.friendlyMessage&&this.messageService&&this.messageService.show(Z.Severity.Error,e.friendlyMessage))}},e.prototype.layout=function(){var e=n.$(this.container).getClientArea(),t=new n.Dimension(e.width,e.height);this.contentsContainer.size(t.width,t.height),this.contextViewService.layout(),this.workbench.layout()},e.prototype.joinCreation=function(){return this.workbench.joinCreation()},e.prototype.dispose=function(){this.workbench&&this.workbench.dispose(),this.contextViewService.dispose(),this.toUnbind=c.dispose(this.toUnbind),n.$(this.container).empty()},e}();t.WorkbenchShell=de});