/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,n){function t(){this.constructor=e}for(var r in n)n.hasOwnProperty(r)&&(e[r]=n[r]);e.prototype=null===n?Object.create(n):(t.prototype=n.prototype,new t)},__decorate=this&&this.__decorate||function(e,n,t,r){var o,i=arguments.length,a=i<3?n:null===r?r=Object.getOwnPropertyDescriptor(n,t):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,n,t,r);else for(var c=e.length-1;c>=0;c--)(o=e[c])&&(a=(i<3?o(a):i>3?o(n,t,a):o(n,t))||a);return i>3&&a&&Object.defineProperty(n,t,a),a},__param=this&&this.__param||function(e,n){return function(t,r){n(t,r,e)}};define(["require","exports","vs/nls","path","fs","os","child_process","vs/base/node/pfs","vs/base/common/async","vs/base/common/winjs.base","vs/base/common/uri","vs/base/common/actions","vs/workbench/common/actionRegistry","vs/workbench/common/contributions","vs/platform/platform","vs/platform/actions/common/actions","vs/platform/message/common/message","vs/platform/editor/common/editor","vs/platform/instantiation/common/instantiation","vs/platform/product"],function(e,n,t,r,o,i,a,c,l,s,u,m,f,d,h,p,v,g,w,b){"use strict";function y(e,n){return void 0===n&&(n=null),function(t){return t.code===e?s.TPromise.as(n):s.TPromise.wrapError(t)}}function _(e){return c.readFile(e,"utf8").then(null,y("ENOENT",""))}var S=u["default"].parse(e.toUrl("")).fsPath,E=r.resolve(S,"..","bin","code"),A=o.existsSync(E),I=function(e){function n(n,t,r,o){e.call(this,n,t),this.messageService=r,this.editorService=o}return __extends(n,e),Object.defineProperty(n.prototype,"target",{get:function(){return"/usr/local/bin/"+b["default"].applicationName},enumerable:!0,configurable:!0}),n.prototype.run=function(){var e=this;return this.checkLegacy().then(function(n){if(n.length>0){var r=n[0],o=r.file,i=r.lineNumber,a=t.localize("exists","Please remove the alias referencing '{0}' in '{1}' (line {2}) and retry this action.",b["default"].darwinBundleIdentifier,o,i),l=u["default"].file(o),f={resource:l,mime:"text/x-shellscript"},d=[new m.Action("inlineEdit",t.localize("editFile","Edit '{0}'",o),"",(!0),function(){return e.editorService.openEditor(f).then(function(){var n=t.localize("again","Please remove the '{0}' alias from '{1}' before continuing.",b["default"].applicationName,o),r=[new m.Action("cancel",t.localize("cancel","Cancel")),new m.Action("continue",t.localize("continue","Continue"),"",(!0),function(){return e.run()})];e.messageService.show(v.Severity.Info,{message:n,actions:r})})})];return e.messageService.show(v.Severity.Warning,{message:a,actions:d}),s.TPromise.as(null)}return e.isInstalled().then(function(n){if(!A||n)return s.TPromise.as(null);var t=function(){return c.unlink(e.target).then(null,y("ENOENT")).then(function(){return c.symlink(E,e.target)})};return t().then(null,function(n){return"EACCES"===n.code||"ENOENT"===n.code?e.createBinFolder().then(function(){return t()}):s.TPromise.wrapError(n)})}).then(function(){return e.messageService.show(v.Severity.Info,t.localize("successIn","Shell command '{0}' successfully installed in PATH.",b["default"].applicationName))})})},n.prototype.isInstalled=function(){var e=this;return c.lstat(this.target).then(function(e){return e.isSymbolicLink()}).then(function(){return c.readlink(e.target)}).then(function(e){return e===E}).then(null,y("ENOENT",!1))},n.prototype.createBinFolder=function(){var e=this;return new s.TPromise(function(n,r){var o=t.localize("warnEscalation","Code will now prompt with 'osascript' for Administrator privileges to install the shell command."),i=[new m.Action("cancel2",t.localize("cancel2","Cancel"),"",(!0),function(){return r(new Error(t.localize("aborted","Aborted"))),null}),new m.Action("ok",t.localize("ok","OK"),"",(!0),function(){var e='osascript -e "do shell script \\"mkdir -p /usr/local/bin && chown \\" & (do shell script (\\"whoami\\")) & \\" /usr/local/bin\\" with administrator privileges"';return l.nfcall(a.exec,e,{}).then(null,function(e){return s.TPromise.wrapError(new Error(t.localize("cantCreateBinFolder","Unable to create '/usr/local/bin'.")))}).done(n,r),null})];e.messageService.show(v.Severity.Info,{message:o,actions:i})})},n.prototype.checkLegacy=function(){var e=[r.join(i.homedir(),".bash_profile"),r.join(i.homedir(),".bashrc"),r.join(i.homedir(),".zshrc")];return s.TPromise.join(e.map(function(e){return _(e)})).then(function(n){return n.reduce(function(n,t,r){var o=e[r],i=t.split(/\r?\n/);return i.some(function(e,t){return e.indexOf(b["default"].darwinBundleIdentifier)>-1&&!/^\s*#/.test(e)&&(n.push({file:o,lineNumber:t+1}),!0)}),n},[])})},n.ID="workbench.action.installCommandLine",n.LABEL=t.localize("install","Install '{0}' command in PATH",b["default"].applicationName),n=__decorate([__param(2,v.IMessageService),__param(3,g.IEditorService)],n)}(m.Action),N=function(e){function n(n,t,r){e.call(this,n,t),this.messageService=r}return __extends(n,e),Object.defineProperty(n.prototype,"target",{get:function(){return"/usr/local/bin/"+b["default"].applicationName},enumerable:!0,configurable:!0}),n.prototype.run=function(){var e=this;return c.unlink(this.target).then(null,y("ENOENT")).then(function(){return e.messageService.show(v.Severity.Info,t.localize("successFrom","Shell command '{0}' successfully uninstalled from PATH.",b["default"].applicationName))})},n.ID="workbench.action.uninstallCommandLine",n.LABEL=t.localize("uninstall","Uninstall '{0}' command from PATH",b["default"].applicationName),n=__decorate([__param(2,v.IMessageService)],n)}(m.Action),P=function(){function e(e,n){var r=e.createInstance(I,I.ID,I.LABEL);r.checkLegacy().done(function(e){if(e.length>0){var o=t.localize("update","Code needs to change the '{0}' shell command. Would you like to do this now?",b["default"].applicationName),i=new m.Action("changeNow",t.localize("changeNow","Change Now"),"",(!0),function(){return r.run()}),a=new m.Action("later",t.localize("later","Later"),"",(!0),function(){return n.show(v.Severity.Info,t.localize("laterInfo","Remember you can always run the '{0}' action from the Command Palette.",r.label)),null}),c=[a,i];n.show(v.Severity.Info,{message:o,actions:c})}})}return e.prototype.getId=function(){return"darwin.cli"},e=__decorate([__param(0,w.IInstantiationService),__param(1,v.IMessageService)],e)}();if(A&&"darwin"===process.platform){var k=t.localize("shellCommand","Shell Command"),z=h.Registry.as(f.Extensions.WorkbenchActions);z.registerWorkbenchAction(new p.SyncActionDescriptor(I,I.ID,I.LABEL),"Shell Command: Install 'code' command in PATH",k),z.registerWorkbenchAction(new p.SyncActionDescriptor(N,N.ID,N.LABEL),"Shell Command: Uninstall 'code' command from PATH",k);var T=h.Registry.as(d.Extensions.Workbench);T.registerWorkbenchContribution(P)}});