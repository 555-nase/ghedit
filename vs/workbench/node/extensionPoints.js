/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(n,e){function t(){this.constructor=n}for(var r in e)e.hasOwnProperty(r)&&(n[r]=e[r]);n.prototype=null===e?Object.create(e):(t.prototype=e.prototype,new t)};define(["require","exports","vs/nls","vs/base/common/platform","vs/base/node/pfs","vs/base/common/severity","vs/base/common/winjs.base","vs/base/common/collections","vs/base/common/paths","vs/base/common/json","vs/base/common/types","vs/platform/extensions/node/extensionValidator","semver"],function(n,e,t,r,o,s,i,a,u,l,c,f,h){"use strict";var p="package.json",_=!!process.env.VSCODE_DEV,d={locale:r.locale,pseudo:"pseudo"===r.locale},m=function(){function n(){this._messages=[]}return n.prototype.getMessages=function(){return this._messages},n.prototype._msg=function(n,e,t){this._messages.push({type:e,message:t,source:n})},n.prototype.error=function(n,e){this._msg(n,s["default"].Error,e)},n.prototype.warn=function(n,e){this._msg(n,s["default"].Warning,e)},n.prototype.info=function(n,e){this._msg(n,s["default"].Info,e)},n}();e.MessagesCollector=m;var v=function(){function n(n,e,t,r){this._ourVersion=n,this._collector=e,this._absoluteFolderPath=t,this._isBuiltin=r,this._absoluteManifestPath=u.join(t,p)}return n}(),g=function(n){function e(){n.apply(this,arguments)}return __extends(e,n),e.prototype.parse=function(){var n=this;return o.readFile(this._absoluteManifestPath).then(function(e){var r=[],o=l.parse(e.toString(),r);return r.length>0?(r.forEach(function(e){n._collector.error(n._absoluteFolderPath,t.localize("jsonParseFail","Failed to parse {0}: {1}.",n._absoluteManifestPath,l.getParseErrorMessage(e.error)))}),null):o},function(e){return n._collector.error(n._absoluteFolderPath,t.localize("fileReadFail","Cannot read file {0}: {1}.",n._absoluteManifestPath,e.message)),null})},e}(v),b=function(n){function e(){n.apply(this,arguments)}return __extends(e,n),e.prototype.replaceNLS=function(n){var r=this,s=u.extname(this._absoluteManifestPath),i=this._absoluteManifestPath.substr(0,this._absoluteManifestPath.length-s.length);return o.fileExists(i+".nls"+s).then(function(s){return s?e.findMessageBundle(i).then(function(s){return s?o.readFile(s).then(function(o){var i=[],a=l.parse(o.toString(),i);return i.length>0?(i.forEach(function(n){r._collector.error(r._absoluteFolderPath,t.localize("jsonParseFail","Failed to parse {0}: {1}.",s,l.getParseErrorMessage(n.error)))}),n):(e._replaceNLStrings(n,a,r._collector,r._absoluteFolderPath),n)},function(n){return r._collector.error(r._absoluteFolderPath,t.localize("fileReadFail","Cannot read file {0}: {1}.",s,n.message)),null}):n}):n})},e.findMessageBundle=function(n){return new i.TPromise(function(e,t,r){function s(n,t){var r=n+".nls."+t+".json";o.fileExists(r).then(function(o){o&&e(r);var i=t.lastIndexOf("-");i===-1?e(n+".nls.json"):(t=t.substring(0,i),s(n,t))})}return _||d.pseudo||!d.locale?e(n+".nls.json"):void s(n,d.locale)})},e._replaceNLStrings=function(n,r,o,s){Object.keys(n).forEach(function(i){if(n.hasOwnProperty(i)){var a=n[i];if(c.isString(a)){var u=a,l=u.length;if(l>1&&"%"===u[0]&&"%"===u[l-1]){var f=u.substr(1,l-2),h=r[f];h?(d.pseudo&&(h="［"+h.replace(/[aouei]/g,"$&$&")+"］"),n[i]=h):o.warn(s,t.localize("missingNLSKey","Couldn't find message for key {0}.",f))}}else c.isObject(a)?e._replaceNLStrings(a,r,o,s):c.isArray(a)&&a.forEach(function(n){c.isObject(n)&&e._replaceNLStrings(n,r,o,s)})}})},e}(v),P=function(n){function e(){n.apply(this,arguments)}return __extends(e,n),e.prototype.validate=function(n){var e=this;n.isBuiltin=this._isBuiltin;var t=[];return f.isValidExtensionDescription(this._ourVersion,this._absoluteFolderPath,n,t)?(t.forEach(function(n){e._collector.warn(e._absoluteFolderPath,n)}),n.id=n.publisher+"."+n.name,n.main&&(n.main=u.normalize(u.join(this._absoluteFolderPath,n.main))),n.extensionFolderPath=this._absoluteFolderPath,n):(t.forEach(function(n){e._collector.error(e._absoluteFolderPath,n)}),null)},e}(v),y=function(){function n(){}return n.scanExtension=function(n,e,t,r){t=u.normalize(t);var o=new g(n,e,t,r);return o.parse().then(function(o){if(null===o)return null;var s=new b(n,e,t,r);return s.replaceNLS(o)}).then(function(o){if(null===o)return null;var s=new P(n,e,t,r);return s.validate(o)})},n.scanExtensions=function(n,e,t,r){var s=this,l=i.TPromise.as({});return r||(l=o.readFile(u.join(t,".obsolete"),"utf8").then(function(n){return JSON.parse(n)}).then(null,function(n){return{}})),l.then(function(l){return o.readDirsInDir(t).then(function(o){return i.TPromise.join(o.map(function(o){return s.scanExtension(n,e,u.join(t,o),r)}))}).then(function(n){return n.filter(function(n){return null!==n})}).then(function(n){return n.filter(function(n){return!l[n.publisher+"."+n.name+"-"+n.version]})}).then(function(n){var e=a.values(a.groupBy(n,function(n){return n.id}));return e.map(function(n){return n.sort(function(n,e){return h.rcompare(n.version,e.version)})[0]})}).then(null,function(n){return e.error(t,n),[]})})},n.scanOneOrMultipleExtensions=function(n,e,t,r){var s=this;return o.fileExists(u.join(t,p)).then(function(o){return o?s.scanExtension(n,e,t,r).then(function(n){return null===n?[]:[n]}):s.scanExtensions(n,e,t,r)},function(n){return e.error(t,n),[]})},n}();e.ExtensionScanner=y});