/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","fs","crypto","vs/nls","vs/base/node/pfs","vs/base/common/uri","vs/base/common/winjs.base","vs/base/common/paths","vs/platform/extensions/common/extensionsRegistry","vs/workbench/api/node/extHost.api.impl","vs/workbench/api/node/extHostExtensionService","vs/workbench/services/thread/common/extHostThreadService","vs/workbench/api/node/extHostTelemetry","vs/platform/workspace/common/baseWorkspaceContextService","vs/workbench/node/extensionPoints","vs/platform/extensionManagement/common/extensionManagementIpc"],function(e,n,t,i,o,r,s,a,c,u,x,h,l,v,f,p,d){"use strict";function g(e){w(e)}var m=s["default"].parse(e.toUrl("./")).fsPath,E=c.normalize(c.join(m,"../../../..")),S=c.join(E,"extensions"),w=process.exit.bind(process);process.exit=function(){var e=new Error("An extension called process.exit() and this was prevented.");console.warn(e.stack)},n.exit=g;var y=function(){function n(e,n,t){this._isTerminating=!1,this._contextService=new f.BaseWorkspaceContextService(n.contextService.workspace,n.contextService.configuration,n.contextService.options);var i=this._getOrCreateWorkspaceStoragePath(),o=new l.ExtHostThreadService(e),r=new v.RemoteTelemetryService("pluginHostTelemetry",o);this._extensionService=new h.ExtHostExtensionService(o,r,{_serviceBrand:"optionalArgs",workspaceStoragePath:i});var s=t.getChannel("extensions");new d.ExtensionManagementChannelClient(s);x.defineAPI(new x.ExtHostAPIImplementation(o,this._extensionService,this._contextService,r))}return n.prototype._getOrCreateWorkspaceStoragePath=function(){function e(n){console.log("Creating Directory "+n);try{return t.mkdirSync(n),!0}catch(i){if("ENOENT"!==i.code)return t.statSync(n).isDirectory();if(e(c.dirname(n)))return t.mkdirSync(n),!0}}var n,o=this._contextService.getWorkspace(),r=this._contextService.getConfiguration().env;if(o){var s=i.createHash("md5");if(s.update(o.resource.fsPath),o.uid&&s.update(o.uid.toString()),n=c.join(r.appSettingsHome,"workspaceStorage",s.digest("hex")),!t.existsSync(n))try{e(n)?t.writeFileSync(c.join(n,"meta.json"),JSON.stringify({workspacePath:o.resource.fsPath,uid:o.uid?o.uid:null},null,4)):n=void 0}catch(a){n=void 0}}return n},n.prototype.start=function(){return this.readExtensions()},n.prototype.terminate=function(){var e=this;if(!this._isTerminating){this._isTerminating=!0;try{var n=u.ExtensionsRegistry.getAllExtensionDescriptions(),t=n.map(function(e){return e.id}),i=t.filter(function(n){return e._extensionService.isActivated(n)});i.forEach(function(n){e._extensionService.deactivate(n)})}catch(o){}setTimeout(function(){g()},1e3)}},n.prototype.readExtensions=function(){var e=this,t=new p.MessagesCollector,i=this._contextService.getConfiguration().env;return n.scanExtensions(t,S,i.disableExtensions?void 0:i.userExtensionsHome,i.disableExtensions?void 0:i.extensionDevelopmentPath,i.version).then(null,function(e){return t.error("",e),[]}).then(function(n){u.ExtensionsRegistry.registerExtensions(n),e._extensionService.registrationDone(t.getMessages())}).then(function(){return e.handleEagerExtensions()}).then(function(){return e.handleExtensionTests()})},n.scanExtensions=function(e,n,t,i,r){var s=p.ExtensionScanner.scanExtensions(r,e,n,!0),c=t?p.ExtensionScanner.scanExtensions(r,e,t,!1):a.TPromise.as([]),u=i?p.ExtensionScanner.scanOneOrMultipleExtensions(r,e,i,!1):a.TPromise.as([]);return a.TPromise.join([s,c,u]).then(function(n){var t=n[0],i=n[1],r=n[2],s={};return t.forEach(function(e){s[e.id]=e}),i.forEach(function(n){s.hasOwnProperty(n.id)&&e.warn(n.extensionFolderPath,o.localize("overwritingExtension","Overwriting extension {0} with {1}.",s[n.id].extensionFolderPath,n.extensionFolderPath)),s[n.id]=n}),r.forEach(function(n){e.info("",o.localize("extensionUnderDevelopment","Loading development extension at {0}",n.extensionFolderPath)),s.hasOwnProperty(n.id)&&e.warn(n.extensionFolderPath,o.localize("overwritingExtension","Overwriting extension {0} with {1}.",s[n.id].extensionFolderPath,n.extensionFolderPath)),s[n.id]=n}),Object.keys(s).map(function(e){return s[e]})})},n.prototype.handleEagerExtensions=function(){return this._extensionService.activateByEvent("*").then(null,function(e){console.error(e)}),this.handleWorkspaceContainsEagerExtensions()},n.prototype.handleWorkspaceContainsEagerExtensions=function(){var e=this,n=this._contextService.getWorkspace();if(!n||!n.resource)return a.TPromise.as(null);var t=n.resource.fsPath,i={};return u.ExtensionsRegistry.getAllExtensionDescriptions().forEach(function(e){var n=e.activationEvents;if(n)for(var t=0;t<n.length;t++)if(/^workspaceContains:/.test(n[t])){var o=n[t].substr("workspaceContains:".length);i[o]=!0}}),a.TPromise.join(Object.keys(i).map(function(e){return r.fileExistsWithResult(c.join(t,e),e)})).then(function(n){n.forEach(function(n){if(n){var t="workspaceContains:"+n;e._extensionService.activateByEvent(t).then(null,function(e){console.error(e)})}})})},n.prototype.handleExtensionTests=function(){var n=this,t=this._contextService.getConfiguration().env;if(!t.extensionTestsPath||!t.extensionDevelopmentPath)return a.TPromise.as(null);var i,r;try{i=e.__$__nodeRequire(t.extensionTestsPath)}catch(s){r=s}return i&&"function"==typeof i.run?new a.TPromise(function(e,o){i.run(t.extensionTestsPath,function(t,i){t?o(t.toString()):e(null),n.gracefulExit(i&&i>0?1:0)})}):(this.gracefulExit(1),a.TPromise.wrapError(r?r.toString():o.localize("extensionTestError","Path {0} does not point to a valid extension test runner.",t.extensionTestsPath)))},n.prototype.gracefulExit=function(e){setTimeout(function(){return g(e)},500)},n}();n.ExtensionHostMain=y});