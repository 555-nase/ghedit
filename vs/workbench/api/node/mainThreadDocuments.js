var __extends=this&&this.__extends||function(e,t){function o(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)},__decorate=this&&this.__decorate||function(e,t,o,r){var i,n=arguments.length,s=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,o,r);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(s=(n<3?i(s):n>3?i(t,o,s):i(t,o))||s);return n>3&&s&&Object.defineProperty(t,o,s),s},__param=this&&this.__param||function(e,t){return function(o,r){t(o,r,e)}};define(["require","exports","vs/base/common/errors","vs/editor/common/services/modelService","vs/editor/common/editorCommon","vs/workbench/services/thread/common/threadService","vs/base/common/uri","vs/base/common/lifecycle","vs/platform/event/common/event","vs/workbench/services/editor/common/editorService","vs/workbench/parts/files/common/files","vs/base/common/winjs.base","vs/platform/files/common/files","vs/editor/common/services/modeService","vs/workbench/services/untitled/common/untitledEditorService","vs/workbench/common/editor/resourceEditorInput","./extHost.protocol"],function(e,t,o,r,i,n,s,c,d,a,u,l,p,h,v,_,m){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var f=function(e){function t(t,o,r,i,n,s,c,d){var a=this;e.call(this),this._modelService=o,this._modeService=r,this._textFileService=n,this._editorService=s,this._fileService=c,this._untitledEditorService=d,this._proxy=t.get(m.ExtHostContext.ExtHostDocuments),this._modelIsSynced={},this._toDispose=[],o.onModelAdded(this._onModelAdded,this,this._toDispose),o.onModelRemoved(this._onModelRemoved,this,this._toDispose),o.onModelModeChanged(this._onModelModeChanged,this,this._toDispose),this._toDispose.push(i.addListener2(u.EventType.FILE_SAVED,function(e){a._shouldHandleFileEvent(e)&&a._proxy.$acceptModelSaved(e.resource.toString())})),this._toDispose.push(i.addListener2(u.EventType.FILE_REVERTED,function(e){a._shouldHandleFileEvent(e)&&a._proxy.$acceptModelReverted(e.resource.toString())})),this._toDispose.push(i.addListener2(u.EventType.FILE_DIRTY,function(e){a._shouldHandleFileEvent(e)&&a._proxy.$acceptModelDirty(e.resource.toString())}));var l=setInterval(function(){return a._runDocumentCleanup()},18e4);this._toDispose.push({dispose:function(){clearInterval(l)}}),this._modelToDisposeMap=Object.create(null),this._resourceContentProvider=Object.create(null),this._virtualDocumentSet=Object.create(null)}return __extends(t,e),t.prototype.dispose=function(){var e=this;Object.keys(this._modelToDisposeMap).forEach(function(t){e._modelToDisposeMap[t].dispose()}),this._modelToDisposeMap=Object.create(null),this._toDispose=c.dispose(this._toDispose)},t.prototype._shouldHandleFileEvent=function(e){var t=this._modelService.getModel(e.resource);return t&&!t.isTooLargeForHavingARichMode()},t.prototype._onModelAdded=function(e){var t=this;if(e.isTooLargeForHavingARichMode())return null;var o=e.uri;this._modelIsSynced[o.toString()]=!0,this._modelToDisposeMap[o.toString()]=e.addBulkListener(function(e){return t._onModelEvents(o,e)}),this._proxy.$acceptModelAdd({url:e.uri,versionId:e.getVersionId(),value:e.toRawText(),modeId:e.getMode().getId(),isDirty:this._textFileService.isDirty(o)})},t.prototype._onModelModeChanged=function(e){var t=e.model,o=e.oldModeId,r=t.uri;this._modelIsSynced[r.toString()]&&this._proxy.$acceptModelModeChanged(t.uri.toString(),o,t.getMode().getId())},t.prototype._onModelRemoved=function(e){var t=e.uri;this._modelIsSynced[t.toString()]&&(delete this._modelIsSynced[t.toString()],this._modelToDisposeMap[t.toString()].dispose(),delete this._modelToDisposeMap[t.toString()],this._proxy.$acceptModelRemoved(t.toString()))},t.prototype._onModelEvents=function(e,t){for(var o=[],r=0,n=t.length;r<n;r++){var s=t[r];switch(s.getType()){case i.EventType.ModelContentChanged2:o.push(s.getData())}}o.length>0&&this._proxy.$acceptModelChanged(e.toString(),o)},t.prototype.$trySaveDocument=function(e){return this._textFileService.save(e)},t.prototype.$tryOpenDocument=function(e){if(!e.scheme||!e.fsPath&&!e.authority)return l.TPromise.wrapError("Invalid uri. Scheme and authority or path must be set.");var t;switch(e.scheme){case"untitled":t=this._handleUnititledScheme(e);break;case"file":default:t=this._handleAsResourceInput(e)}return t.then(function(t){if(!t)return l.TPromise.wrapError("cannot open "+e.toString())},function(t){return l.TPromise.wrapError("cannot open "+e.toString()+". Detail: "+o.toErrorMessage(t))})},t.prototype._handleAsResourceInput=function(e){return this._editorService.resolveEditorModel({resource:e}).then(function(e){return!!e})},t.prototype._handleUnititledScheme=function(e){var t=this,o=s["default"].file(e.fsPath);return this._fileService.resolveFile(o).then(function(e){return l.TPromise.wrapError("file already exists on disk")},function(r){var i=t._untitledEditorService.createOrGet(o);return i.resolve(!0).then(function(o){if(i.getResource().toString()!==e.toString())throw new Error("expected URI "+e.toString()+" BUT GOT "+i.getResource().toString());if(!t._modelIsSynced[e.toString()])throw new Error("expected URI "+e.toString()+" to have come to LIFE");return t._proxy.$acceptModelDirty(e.toString())}).then(function(){return!0})})},t.prototype.$registerTextContentProvider=function(e,t){var o=this;this._resourceContentProvider[e]=_.ResourceEditorInput.registerResourceContentProvider(t,{provideTextContent:function(t){return o._proxy.$provideTextDocumentContent(e,t).then(function(e){if("string"==typeof e){o._virtualDocumentSet[t.toString()]=!0;var r=e.substr(0,1+e.search(/\r?\n/)),i=o._modeService.getOrCreateModeByFilenameOrFirstLine(t.fsPath,r);return o._modelService.createModel(e,i,t)}})}})},t.prototype.$unregisterTextContentProvider=function(e){var t=this._resourceContentProvider[e];t&&(t.dispose(),delete this._resourceContentProvider[e])},t.prototype.$onVirtualDocumentChange=function(e,t){var o=this._modelService.getModel(e);o&&o.setValue(t)},t.prototype._runDocumentCleanup=function(){var e=this,t=[];l.TPromise.join(Object.keys(this._virtualDocumentSet).map(function(o){var r=s["default"].parse(o);return e._editorService.createInput({resource:r}).then(function(o){e._editorService.isVisible(o,!0)||t.push(r)})})).then(function(){for(var o=0,r=t;o<r.length;o++){var i=r[o];e._modelService.destroyModel(i),delete e._virtualDocumentSet[i.toString()]}},o.onUnexpectedError)},t=__decorate([__param(0,n.IThreadService),__param(1,r.IModelService),__param(2,h.IModeService),__param(3,d.IEventService),__param(4,u.ITextFileService),__param(5,a.IWorkbenchEditorService),__param(6,p.IFileService),__param(7,v.IUntitledEditorService)],t)}(m.MainThreadDocumentsShape);t.MainThreadDocuments=f});