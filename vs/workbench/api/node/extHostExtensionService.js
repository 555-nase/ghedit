var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};define(["require","exports","vs/base/common/lifecycle","vs/base/common/paths","vs/base/common/severity","vs/base/common/winjs.base","vs/platform/extensions/common/abstractExtensionService","vs/platform/extensions/common/extensionsRegistry","vs/workbench/api/node/extHostStorage","./extHost.protocol"],function(t,e,n,i,o,r,a,s,c,u){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";function l(e){var n=null;try{n=t.__$__nodeRequire(e)}catch(i){return r.TPromise.wrapError(i)}return r.TPromise.as(n)}function h(t){var e={id:t.id,name:t.name,publisherDisplayName:t.publisher,activationEvents:t.activationEvents?t.activationEvents.join(","):null,isBuiltin:t.isBuiltin};for(var n in t.contributes){var i=t.contributes[n];if(i)switch(n){case"debuggers":var o=i.reduce(function(t,e){return t?t+","+e.type:e.type},"");e["contribution.debuggers"]=o;break;case"grammars":var r=i.reduce(function(t,e){return t?t+","+e.language:e.language},"");e["contribution.grammars"]=r;break;case"languages":var a=i.reduce(function(t,e){return t?t+","+e.id:e.id},"");e["contribution.languages"]=a;break;case"tmSnippets":var s=i.reduce(function(t,e){return t?t+","+e.languageId:e.languageId},"");e["contribution.tmSnippets"]=s;break;default:e["contribution."+n]=!0}}return e}var v=Object.hasOwnProperty,p=function(t){function e(e,n,i,o){t.call(this,e),this.module=n,this.exports=i,this.subscriptions=o}return __extends(e,t),e}(a.ActivatedExtension);e.ExtHostExtension=p;var d=function(t){function e(){t.call(this,!1,{activate:void 0,deactivate:void 0},void 0,[])}return __extends(e,t),e}(p);e.ExtHostEmptyExtension=d;var f=function(){function t(t,e,n){var i=this;this._id=t,this._shared=e,this._storage=n,this._init=this._storage.getValue(this._shared,this._id,Object.create(null)).then(function(t){return i._value=t,i})}return Object.defineProperty(t.prototype,"whenReady",{get:function(){return this._init},enumerable:!0,configurable:!0}),t.prototype.get=function(t,e){var n=this._value[t];return"undefined"==typeof n&&(n=e),n},t.prototype.update=function(t,e){return this._value[t]=e,this._storage.setValue(this._shared,this._id,this._value).then(function(){return!0})},t}(),_=function(t){function e(e,n,i){t.call(this,!1),this._threadService=e,this._storage=new c.ExtHostStorage(e),this._proxy=this._threadService.get(u.MainContext.MainProcessExtensionService),this._telemetryService=n,this._workspaceStoragePath=i.workspaceStoragePath}return __extends(e,t),e.prototype.$localShowMessage=function(t,e){switch(t){case o["default"].Error:console.error(e);break;case o["default"].Warning:console.warn(e);break;default:console.log(e)}},e.prototype.get=function(t){if(!v.call(this._activatedExtensions,t))throw new Error("Extension `"+t+"` is not known or not activated");return this._activatedExtensions[t].exports},e.prototype.deactivate=function(t){var e=this._activatedExtensions[t];if(e){try{"function"==typeof e.module.deactivate&&e.module.deactivate()}catch(i){}try{n.dispose(e.subscriptions)}catch(i){}}},e.prototype.registrationDone=function(t){var e=this;this._proxy.$onExtensionHostReady(s.ExtensionsRegistry.getAllExtensionDescriptions(),t).then(function(){e._triggerOnReady()})},e.prototype._showMessage=function(t,e){this._proxy.$localShowMessage(t,e),this.$localShowMessage(t,e)},e.prototype._createFailedExtension=function(){return new p((!0),{activate:void 0,deactivate:void 0},(void 0),[])},e.prototype._loadExtensionContext=function(t){var e=new f(t.id,(!0),this._storage),n=new f(t.id,(!1),this._storage),o=this._workspaceStoragePath?i.normalize(i.join(this._workspaceStoragePath,t.id)):void 0;return r.TPromise.join([e.whenReady,n.whenReady]).then(function(){return Object.freeze({globalState:e,workspaceState:n,subscriptions:[],get extensionPath(){return t.extensionFolderPath},storagePath:o,asAbsolutePath:function(e){return i.normalize(i.join(t.extensionFolderPath,e),!0)}})})},e.prototype._actualActivateExtension=function(t){var e=this;return this._doActualActivateExtension(t).then(function(n){return e._proxy.$onExtensionActivated(t.id),n},function(n){throw e._proxy.$onExtensionActivationFailed(t.id),n})},e.prototype._doActualActivateExtension=function(t){var n=this,i=h(t);return this._telemetryService.publicLog("activatePlugin",i),t.main?l(t.main).then(function(i){return n._loadExtensionContext(t).then(function(t){return e._callActivate(i,t)})}):r.TPromise.as(new d)},e._callActivate=function(t,e){return t=t||{activate:void 0,deactivate:void 0},this._callActivateOptional(t,e).then(function(n){return new p((!1),t,n,e.subscriptions)})},e._callActivateOptional=function(t,e){if("function"!=typeof t.activate)return r.TPromise.as(t);try{return r.TPromise.as(t.activate.apply(global,[e]))}catch(n){return r.TPromise.wrapError(n)}},e.prototype.$activateExtension=function(t){return this._activateExtension(t)},e}(a.AbstractExtensionService);e.ExtHostExtensionService=_});