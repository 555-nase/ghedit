define(["require","exports","vs/editor/common/editorCommon","vs/base/common/event","vs/base/common/lifecycle","vs/base/common/async","vs/base/common/idGenerator","vs/editor/common/core/range","vs/editor/common/core/selection","vs/workbench/api/node/extHostTypes"],function(e,t,o,i,r,n,s,d,c,a){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";function u(e,t){return!(e&&!t||!e&&t)&&(!e&&!t||e.tabSize===t.tabSize&&e.insertSpaces===t.insertSpaces)}function h(e,t){return e<t?-1:e>t?1:0}!function(e){e[e.Default=0]="Default",e[e.InCenter=1]="InCenter",e[e.InCenterIfOutsideViewport=2]="InCenterIfOutsideViewport"}(t.TextEditorRevealType||(t.TextEditorRevealType={}));var p=t.TextEditorRevealType,l=function(){function e(e,t,o,r,n){var s=this;this._id=e,this._model=t,this._codeEditor=null,this._focusTracker=r,this._modelService=n,this._codeEditorListeners=[],this._onSelectionChanged=new i.Emitter,this._onConfigurationChanged=new i.Emitter,this._lastSelection=[new c.Selection(1,1,1,1)],this._setConfiguration(this._readConfiguration(this._model,this._codeEditor)),this._modelListeners=[],this._modelListeners.push(this._model.onDidChangeOptions(function(e){s._setConfiguration(s._readConfiguration(s._model,s._codeEditor))})),this.setCodeEditor(o)}return e.prototype.dispose=function(){this._model=null,this._modelListeners=r.dispose(this._modelListeners),this._codeEditor=null,this._codeEditorListeners=r.dispose(this._codeEditorListeners)},e.prototype.getId=function(){return this._id},e.prototype.getModel=function(){return this._model},e.prototype.hasCodeEditor=function(e){return this._codeEditor===e},e.prototype.setCodeEditor=function(e){var t=this;if(!this.hasCodeEditor(e)&&(this._codeEditorListeners=r.dispose(this._codeEditorListeners),this._codeEditor=e,this._codeEditor)){this._codeEditorListeners.push(this._codeEditor.onDidChangeModel(function(){t.setCodeEditor(null)}));var o=function(e){t._lastSelection=t._codeEditor.getSelections(),t._onSelectionChanged.fire({selections:t._lastSelection,source:e&&e.source})};this._codeEditorListeners.push(this._codeEditor.onDidChangeCursorSelection(o)),c.Selection.selectionsArrEqual(this._lastSelection,this._codeEditor.getSelections())||o(),this._codeEditorListeners.push(this._codeEditor.onDidFocusEditor(function(){t._focusTracker.onGainedFocus()})),this._codeEditorListeners.push(this._codeEditor.onDidBlurEditor(function(){t._focusTracker.onLostFocus()})),this._codeEditorListeners.push(this._codeEditor.onDidChangeConfiguration(function(){t._setConfiguration(t._readConfiguration(t._model,t._codeEditor))})),this._setConfiguration(this._readConfiguration(this._model,this._codeEditor))}},e.prototype.isVisible=function(){return!!this._codeEditor},Object.defineProperty(e.prototype,"onSelectionChanged",{get:function(){return this._onSelectionChanged.event},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onConfigurationChanged",{get:function(){return this._onConfigurationChanged.event},enumerable:!0,configurable:!0}),e.prototype.getSelections=function(){return this._codeEditor?this._codeEditor.getSelections():this._lastSelection},e.prototype.setSelections=function(e){return this._codeEditor?void this._codeEditor.setSelections(e):(this._lastSelection=e.map(c.Selection.liftSelection),void console.warn("setSelections on invisble editor"))},e.prototype.getConfiguration=function(){return this._configuration},e.prototype._setIndentConfiguration=function(e){if("auto"===e.tabSize||"auto"===e.insertSpaces){var t=this._modelService.getCreationOptions(),o=t.insertSpaces,i=t.tabSize;if("auto"!==e.insertSpaces&&"undefined"!=typeof e.insertSpaces&&(o="false"!==e.insertSpaces&&Boolean(e.insertSpaces)),"auto"!==e.tabSize&&"undefined"!=typeof e.tabSize){var r=parseInt(e.tabSize,10);isNaN(r)||(i=r)}return void this._model.detectIndentation(o,i)}var n={};if("undefined"!=typeof e.insertSpaces&&(n.insertSpaces="false"!==e.insertSpaces&&Boolean(e.insertSpaces)),"undefined"!=typeof e.tabSize){var r=parseInt(e.tabSize,10);isNaN(r)||(n.tabSize=r)}this._model.updateOptions(n)},e.prototype.setConfiguration=function(e){if(this._setIndentConfiguration(e),e.cursorStyle){var t=o.cursorStyleToString(e.cursorStyle);if(!this._codeEditor)return void console.warn("setConfiguration on invisible editor");this._codeEditor.updateOptions({cursorStyle:t})}},e.prototype.setDecorations=function(e,t){return this._codeEditor?void this._codeEditor.setDecorations(e,t):void console.warn("setDecorations on invisible editor")},e.prototype.revealRange=function(e,t){return this._codeEditor?void(t===p.Default?this._codeEditor.revealRange(e):t===p.InCenter?this._codeEditor.revealRangeInCenter(e):t===p.InCenterIfOutsideViewport?this._codeEditor.revealRangeInCenterIfOutsideViewport(e):console.warn("Unknown revealType")):void console.warn("revealRange on invisible editor")},e.prototype._readConfiguration=function(e,t){if(e.isDisposed())return this._configuration;var i=this._configuration?this._configuration.cursorStyle:o.TextEditorCursorStyle.Line;if(t){var r=t.getConfiguration();i=r.viewInfo.cursorStyle}var n=e.getOptions();return{insertSpaces:n.insertSpaces,tabSize:n.tabSize,cursorStyle:i}},e.prototype._setConfiguration=function(e){u(this._configuration,e)||(this._configuration=e,this._onConfigurationChanged.fire(this._configuration))},e.prototype.isFocused=function(){return!!this._codeEditor&&this._codeEditor.isFocused()},e.prototype.matches=function(e){return!!e&&e.getControl()===this._codeEditor},e.prototype.applyEdits=function(e,t,i){if(this._model.getVersionId()!==e)return console.warn("Model has changed in the meantime!"),!1;if(this._codeEditor){i===a.EndOfLine.CRLF?this._model.setEOL(o.EndOfLineSequence.CRLF):i===a.EndOfLine.LF&&this._model.setEOL(o.EndOfLineSequence.LF);var r=t.map(function(e){return{identifier:null,range:d.Range.lift(e.range),text:e.text,forceMoveMarkers:e.forceMoveMarkers}});return this._codeEditor.pushUndoStop(),this._codeEditor.executeEdits("MainThreadTextEditor",r),this._codeEditor.pushUndoStop(),!0}return console.warn("applyEdits on invisible editor"),!1},e}();t.MainThreadTextEditor=l;var _=function(){function e(e,t){var o=this;this._codeEditorService=e,this._modelService=t,this._toDispose=[],this._focusedTextEditorId=null,this._visibleTextEditorIds=[],this._editorModelChangeListeners=Object.create(null),this._model2TextEditors=Object.create(null),this._onTextEditorAdd=new i.Emitter,this._onTextEditorRemove=new i.Emitter,this._onDidUpdateTextEditors=new i.Emitter,this._onDidChangeFocusedTextEditor=new i.Emitter,this._focusTracker={onGainedFocus:function(){return o._updateFocusedTextEditor()},onLostFocus:function(){return o._updateFocusedTextEditor()}},this._modelService.onModelAdded(this._onModelAdded,this,this._toDispose),this._modelService.onModelRemoved(this._onModelRemoved,this,this._toDispose),this._codeEditorService.onCodeEditorAdd(this._onCodeEditorAdd,this,this._toDispose),this._codeEditorService.onCodeEditorRemove(this._onCodeEditorRemove,this,this._toDispose),this._updateMapping=new n.RunOnceScheduler(function(){return o._doUpdateMapping()},0),this._toDispose.push(this._updateMapping)}return e.prototype.dispose=function(){this._toDispose=r.dispose(this._toDispose)},e.prototype._onModelAdded=function(e){this._updateMapping.schedule()},e.prototype._onModelRemoved=function(e){this._updateMapping.schedule()},e.prototype._onCodeEditorAdd=function(e){var t=this;this._editorModelChangeListeners[e.getId()]=e.onDidChangeModel(function(e){return t._updateMapping.schedule()}),this._updateMapping.schedule()},e.prototype._onCodeEditorRemove=function(e){this._editorModelChangeListeners[e.getId()].dispose(),delete this._editorModelChangeListeners[e.getId()],this._updateMapping.schedule()},e.prototype._doUpdateMapping=function(){var t=this,o=this._modelService.getModels();o=o.filter(function(e){return!e.isTooLargeForHavingARichMode()});var i=Object.create(null);o.forEach(function(e){i[e.uri.toString()]=e}),Object.keys(this._model2TextEditors).forEach(function(e){if(!i[e]){var o=t._model2TextEditors[e];delete t._model2TextEditors[e];for(var r=0;r<o.length;r++)t._onTextEditorRemove.fire(o[r]),o[r].dispose()}});var r=this._getVisibleModels();Object.keys(r).forEach(function(o){var i=r[o].model,n=r[o].codeEditors;t._model2TextEditors[o]||(t._model2TextEditors[o]=[]);for(var s=t._model2TextEditors[o];s.length>n.length;){var d=s.pop();t._onTextEditorRemove.fire(d),d.dispose()}for(var c=0;c<s.length;c++)s[c].setCodeEditor(n[c]);for(var c=s.length;c<n.length;c++){var a=new l(e._Ids.nextId(),i,n[c],t._focusTracker,t._modelService);s.push(a),t._onTextEditorAdd.fire(a)}}),o.forEach(function(o){var i=o.uri.toString();if(!r[i]){t._model2TextEditors[i]||(t._model2TextEditors[i]=[]);for(var n=t._model2TextEditors[i];n.length>1;){var s=n.pop();t._onTextEditorRemove.fire(s),s.dispose()}if(0===n.length){var d=new l(e._Ids.nextId(),o,null,t._focusTracker,t._modelService);n.push(d),t._onTextEditorAdd.fire(d)}else n[0].setCodeEditor(null)}}),this._printState(),this._visibleTextEditorIds=this._findVisibleTextEditorIds(),this._updateFocusedTextEditor(),this._onDidUpdateTextEditors.fire(void 0)},e.prototype._updateFocusedTextEditor=function(){this._setFocusedTextEditorId(this._findFocusedTextEditorId())},e.prototype._findFocusedTextEditorId=function(){for(var e=Object.keys(this._model2TextEditors),t=0,o=e.length;t<o;t++)for(var i=this._model2TextEditors[e[t]],r=0,n=i.length;r<n;r++)if(i[r].isFocused())return i[r].getId();return null},e.prototype._findVisibleTextEditorIds=function(){for(var e=[],t=Object.keys(this._model2TextEditors),o=0,i=t.length;o<i;o++)for(var r=this._model2TextEditors[t[o]],n=0,s=r.length;n<s;n++)r[n].isVisible()&&e.push(r[n].getId());return e.sort(),e},e.prototype._setFocusedTextEditorId=function(e){this._focusedTextEditorId!==e&&(this._focusedTextEditorId=e,this._printState(),this._onDidChangeFocusedTextEditor.fire(this._focusedTextEditorId))},e.prototype._printState=function(){},e.prototype._getVisibleModels=function(){var e={},t=this._codeEditorService.listCodeEditors();return t.sort(function(e,t){return h(e.getId(),t.getId())}),t.forEach(function(t){var o=t.getModel();if(o&&!o.isTooLargeForHavingARichMode()){var i=o.uri.toString();e[i]=e[i]||{model:o,codeEditors:[]},e[i].codeEditors.push(t)}}),e},e.prototype.getFocusedTextEditorId=function(){return this._focusedTextEditorId},e.prototype.getVisibleTextEditorIds=function(){return this._visibleTextEditorIds},Object.defineProperty(e.prototype,"onTextEditorAdd",{get:function(){return this._onTextEditorAdd.event},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onTextEditorRemove",{get:function(){return this._onTextEditorRemove.event},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onDidUpdateTextEditors",{get:function(){return this._onDidUpdateTextEditors.event},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onChangedFocusedTextEditor",{get:function(){return this._onDidChangeFocusedTextEditor.event},enumerable:!0,configurable:!0}),e.prototype.findTextEditorIdFor=function(e){for(var t=Object.keys(this._model2TextEditors),o=0,i=t.length;o<i;o++)for(var r=this._model2TextEditors[t[o]],n=0,s=r.length;n<s;n++)if(r[n].hasCodeEditor(e))return r[n].getId();return null},e.prototype.registerTextEditorDecorationType=function(e,t){this._codeEditorService.registerDecorationType(e,t)},e.prototype.removeTextEditorDecorationType=function(e){this._codeEditorService.removeDecorationType(e)},e._Ids=new s.IdGenerator(""),e}();t.MainThreadEditorsTracker=_});