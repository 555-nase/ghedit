var __extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)};define(["require","exports","vs/base/common/errors","vs/editor/common/model/mirrorModel2","vs/base/common/event","vs/workbench/api/node/extHostTypes","./extHostTypeConverters","vs/base/common/winjs.base","vs/base/common/async","vs/editor/common/model/wordHelper","./extHost.protocol"],function(t,e,n,o,i,r,a,s,c,u,d){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";function h(t,e){l[t]=e}function m(t){return l[t]}var l=Object.create(null),p=function(t){function e(e){t.call(this),this._proxy=e.get(d.MainContext.MainThreadDocuments),this._onDidAddDocumentEventEmitter=new i.Emitter,this.onDidAddDocument=this._onDidAddDocumentEventEmitter.event,this._onDidRemoveDocumentEventEmitter=new i.Emitter,this.onDidRemoveDocument=this._onDidRemoveDocumentEventEmitter.event,this._onDidChangeDocumentEventEmitter=new i.Emitter,this.onDidChangeDocument=this._onDidChangeDocumentEventEmitter.event,this._onDidSaveDocumentEventEmitter=new i.Emitter,this.onDidSaveDocument=this._onDidSaveDocumentEventEmitter.event,this._documentData=Object.create(null),this._documentLoader=Object.create(null),this._documentContentProviders=Object.create(null)}return __extends(e,t),e.prototype.getAllDocumentData=function(){var t=[];for(var e in this._documentData)t.push(this._documentData[e]);return t},e.prototype.getDocumentData=function(t){if(t){var e=this._documentData[t.toString()];return e?e:void 0}},e.prototype.ensureDocumentData=function(t){var e=this,n=this._documentData[t.toString()];if(n)return s.TPromise.as(n);var o=this._documentLoader[t.toString()];return o||(o=this._proxy.$tryOpenDocument(t).then(function(){return delete e._documentLoader[t.toString()],e._documentData[t.toString()]},function(n){return delete e._documentLoader[t.toString()],s.TPromise.wrapError(n)}),this._documentLoader[t.toString()]=o),o},e.prototype.registerTextDocumentContentProvider=function(t,o){var i=this;if("file"===t||"untitled"===t)throw new Error("scheme '"+t+"' already registered");var a=e._handlePool++;this._documentContentProviders[a]=o,this._proxy.$registerTextContentProvider(a,t);var s;return"function"==typeof o.onDidChange&&(s=o.onDidChange(function(t){i._documentData[t.toString()]&&i.$provideTextDocumentContent(a,t).then(function(e){return i._proxy.$onVirtualDocumentChange(t,e)},n.onUnexpectedError)})),new r.Disposable(function(){delete i._documentContentProviders[a]&&i._proxy.$unregisterTextContentProvider(a),s&&(s.dispose(),s=void 0)})},e.prototype.$provideTextDocumentContent=function(t,e){var n=this._documentContentProviders[t];return n?c.asWinJsPromise(function(t){return n.provideTextDocumentContent(e,t)}):s.TPromise.wrapError("unsupported uri-scheme: "+e.scheme)},e.prototype.$acceptModelAdd=function(t){var e=new _(this._proxy,t.url,t.value.lines,t.value.EOL,t.modeId,t.versionId,t.isDirty),n=e.document.uri.toString();if(this._documentData[n])throw new Error("Document `"+n+"` already exists.");this._documentData[n]=e,this._onDidAddDocumentEventEmitter.fire(e.document)},e.prototype.$acceptModelModeChanged=function(t,e,n){var o=this._documentData[t];this._onDidRemoveDocumentEventEmitter.fire(o.document),o._acceptLanguageId(n),this._onDidAddDocumentEventEmitter.fire(o.document)},e.prototype.$acceptModelSaved=function(t){var e=this._documentData[t];e._acceptIsDirty(!1),this._onDidSaveDocumentEventEmitter.fire(e.document)},e.prototype.$acceptModelDirty=function(t){var e=this._documentData[t];e._acceptIsDirty(!0)},e.prototype.$acceptModelReverted=function(t){var e=this._documentData[t];e._acceptIsDirty(!1)},e.prototype.$acceptModelRemoved=function(t){if(!this._documentData[t])throw new Error("Document `"+t+"` does not exist.");var e=this._documentData[t];delete this._documentData[t],this._onDidRemoveDocumentEventEmitter.fire(e.document),e.dispose()},e.prototype.$acceptModelChanged=function(t,e){var n=this._documentData[t];n.onEvents(e),this._onDidChangeDocumentEventEmitter.fire({document:n.document,contentChanges:e.map(function(t){return{range:a.toRange(t.range),rangeLength:t.rangeLength,text:t.text}})})},e.prototype.setWordDefinitionFor=function(t,e){h(t,e)},e._handlePool=0,e}(d.ExtHostDocumentsShape);e.ExtHostDocuments=p;var _=function(t){function e(e,n,o,i,r,a,s){t.call(this,n,o,i,a),this._proxy=e,this._languageId=r,this._isDirty=s,this._textLines=[]}return __extends(e,t),e.prototype.dispose=function(){this._textLines.length=0,this._isDirty=!1,t.prototype.dispose.call(this)},Object.defineProperty(e.prototype,"document",{get:function(){if(!this._document){var t=this;this._document={get uri(){return t._uri},get fileName(){return t._uri.fsPath},get isUntitled(){return"file"!==t._uri.scheme},get languageId(){return t._languageId},get version(){return t._versionId},get isDirty(){return t._isDirty},save:function(){return t._proxy.$trySaveDocument(t._uri)},getText:function(e){return e?t._getTextInRange(e):t.getText()},get lineCount(){return t._lines.length},lineAt:function(e){return t.lineAt(e)},offsetAt:function(e){return t.offsetAt(e)},positionAt:function(e){return t.positionAt(e)},validateRange:function(e){return t.validateRange(e)},validatePosition:function(e){return t.validatePosition(e)},getWordRangeAtPosition:function(e){return t.getWordRangeAtPosition(e)}}}return this._document},enumerable:!0,configurable:!0}),e.prototype._acceptLanguageId=function(t){this._languageId=t},e.prototype._acceptIsDirty=function(t){this._isDirty=t},e.prototype._getTextInRange=function(t){var e=this.validateRange(t);if(e.isEmpty)return"";if(e.isSingleLine)return this._lines[e.start.line].substring(e.start.character,e.end.character);var n=this._eol,o=e.start.line,i=e.end.line,r=[];r.push(this._lines[o].substring(e.start.character));for(var a=o+1;a<i;a++)r.push(this._lines[a]);return r.push(this._lines[i].substring(0,e.end.character)),r.join(n)},e.prototype.lineAt=function(t){var e;if(t instanceof r.Position?e=t.line:"number"==typeof t&&(e=t),e<0||e>=this._lines.length)throw new Error("Illegal value for `line`");var n=this._textLines[e];if(!n||n.lineNumber!==e||n.text!==this._lines[e]){var o=this._lines[e],i=/^(\s*)/.exec(o)[1].length,a=new r.Range(e,0,e,o.length),s=e<this._lines.length-1?new r.Range(e,0,e+1,0):a;n=Object.freeze({lineNumber:e,range:a,rangeIncludingLineBreak:s,text:o,firstNonWhitespaceCharacterIndex:i,isEmptyOrWhitespace:i===o.length}),this._textLines[e]=n}return n},e.prototype.offsetAt=function(t){return t=this.validatePosition(t),this._ensureLineStarts(),this._lineStarts.getAccumulatedValue(t.line-1)+t.character},e.prototype.positionAt=function(t){t=Math.floor(t),t=Math.max(0,t),this._ensureLineStarts();var e=this._lineStarts.getIndexOf(t),n=this._lines[e.index].length;return new r.Position(e.index,Math.min(e.remainder,n))},e.prototype.validateRange=function(t){if(!(t instanceof r.Range))throw new Error("Invalid argument");var e=this.validatePosition(t.start),n=this.validatePosition(t.end);return e===t.start&&n===t.end?t:new r.Range(e.line,e.character,n.line,n.character)},e.prototype.validatePosition=function(t){if(!(t instanceof r.Position))throw new Error("Invalid argument");var e=t.line,n=t.character,o=!1;if(e<0)e=0,n=0,o=!0;else if(e>=this._lines.length)e=this._lines.length-1,n=this._lines[e].length,o=!0;else{var i=this._lines[e].length;n<0?(n=0,o=!0):n>i&&(n=i,o=!0)}return o?new r.Position(e,n):t},e.prototype.getWordRangeAtPosition=function(t){var e=this.validatePosition(t),n=u.getWordAtText(e.character+1,u.ensureValidWordDefinition(m(this._languageId)),this._lines[e.line],0);if(n)return new r.Range(e.line,n.startColumn-1,e.line,n.endColumn-1)},e}(o.MirrorModel2);e.ExtHostDocumentData=_});