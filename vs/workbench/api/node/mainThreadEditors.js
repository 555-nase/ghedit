var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},__decorate=this&&this.__decorate||function(t,e,i,o){var r,s=arguments.length,n=s<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,i,o);else for(var d=t.length-1;d>=0;d--)(r=t[d])&&(n=(s<3?r(n):s>3?r(e,i,n):r(e,i))||n);return s>3&&n&&Object.defineProperty(e,i,n),n},__param=this&&this.__param||function(t,e){return function(i,o){e(i,o,t)}};define(["require","exports","vs/base/common/lifecycle","vs/base/common/winjs.base","vs/workbench/services/thread/common/threadService","vs/editor/common/editorCommon","vs/editor/common/services/codeEditorService","vs/workbench/services/editor/common/editorService","vs/workbench/services/group/common/groupService","vs/editor/common/services/modelService","vs/workbench/api/node/mainThreadEditorsTracker","vs/platform/telemetry/common/telemetry","vs/platform/event/common/event","vs/base/common/arrays","vs/base/common/objects","./extHost.protocol"],function(t,e,i,o,r,s,n,d,c,a,p,h,u,_,E,v){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var f=function(t){function e(e,i,o,r,s,n,d){var c=this;t.call(this),this._proxy=e.get(v.ExtHostContext.ExtHostEditors),this._workbenchEditorService=i,this._telemetryService=r,this._toDispose=[],this._textEditorsListenersMap=Object.create(null),this._textEditorsMap=Object.create(null),this._activeTextEditor=null,this._visibleEditors=[],this._editorPositionData=null,this._editorTracker=new p.MainThreadEditorsTracker(s,d),this._toDispose.push(this._editorTracker),this._toDispose.push(this._editorTracker.onTextEditorAdd(function(t){return c._onTextEditorAdd(t)})),this._toDispose.push(this._editorTracker.onTextEditorRemove(function(t){return c._onTextEditorRemove(t)})),this._toDispose.push(this._editorTracker.onDidUpdateTextEditors(function(){return c._updateActiveAndVisibleTextEditors()})),this._toDispose.push(this._editorTracker.onChangedFocusedTextEditor(function(t){return c._updateActiveAndVisibleTextEditors()})),this._toDispose.push(o.onEditorsChanged(function(){return c._updateActiveAndVisibleTextEditors()})),this._toDispose.push(o.onEditorsMoved(function(){return c._updateActiveAndVisibleTextEditors()}))}return __extends(e,t),e.prototype.dispose=function(){var t=this;Object.keys(this._textEditorsListenersMap).forEach(function(e){i.dispose(t._textEditorsListenersMap[e])}),this._textEditorsListenersMap=Object.create(null),this._toDispose=i.dispose(this._toDispose)},e.prototype._onTextEditorAdd=function(t){var e=this,i=t.getId(),o=[];o.push(t.onConfigurationChanged(function(t){e._proxy.$acceptOptionsChanged(i,t)})),o.push(t.onSelectionChanged(function(t){e._proxy.$acceptSelectionsChanged(i,t)})),this._proxy.$acceptTextEditorAdd({id:i,document:t.getModel().uri,options:t.getConfiguration(),selections:t.getSelections(),editorPosition:this._findEditorPosition(t)}),this._textEditorsListenersMap[i]=o,this._textEditorsMap[i]=t},e.prototype._onTextEditorRemove=function(t){var e=t.getId();i.dispose(this._textEditorsListenersMap[e]),delete this._textEditorsListenersMap[e],delete this._textEditorsMap[e],this._proxy.$acceptTextEditorRemove(e)},e.prototype._updateActiveAndVisibleTextEditors=function(){var t=this._editorTracker.getVisibleTextEditorIds(),e=this._findActiveTextEditorId();e===this._activeTextEditor&&_.equals(this._visibleEditors,t,function(t,e){return t===e})||(this._activeTextEditor=e,this._visibleEditors=t,this._proxy.$acceptActiveEditorAndVisibleEditors(this._activeTextEditor,this._visibleEditors));var i=this._getTextEditorPositionData();E.equals(this._editorPositionData,i)||(this._editorPositionData=i,this._proxy.$acceptEditorPositionData(this._editorPositionData))},e.prototype._findActiveTextEditorId=function(){var t=this._editorTracker.getFocusedTextEditorId();if(t)return t;var e=this._workbenchEditorService.getActiveEditor();if(!e)return null;var i=e.getControl();return i&&"function"==typeof i.getEditorType?i.getEditorType()===s.EditorType.ICodeEditor?this._editorTracker.findTextEditorIdFor(i):this._editorTracker.findTextEditorIdFor(i.getModifiedEditor()):null},e.prototype._findEditorPosition=function(t){for(var e=0,i=this._workbenchEditorService.getVisibleEditors();e<i.length;e++){var o=i[e];if(t.matches(o))return o.position}},e.prototype._getTextEditorPositionData=function(){for(var t=Object.create(null),e=0,i=this._workbenchEditorService.getVisibleEditors();e<i.length;e++){var o=i[e],r=o.getControl();if(r&&"function"==typeof r.getEditorType&&r.getEditorType()===s.EditorType.ICodeEditor){var n=this._editorTracker.findTextEditorIdFor(r);n&&(t[n]=o.position)}}return t},e.prototype.$tryShowTextDocument=function(t,e,i){var r=this,s={resource:t,options:{preserveFocus:i}};return this._workbenchEditorService.openEditor(s,e).then(function(t){if(t)return new o.TPromise(function(t){function e(){i.dispose(),clearTimeout(o),t(void 0)}var i,o;i=r._editorTracker.onDidUpdateTextEditors(function(){e()}),o=setTimeout(function(){e()},1e3)}).then(function(){for(var e in r._textEditorsMap)if(r._textEditorsMap[e].matches(t))return e})})},e.prototype.$tryShowEditor=function(t,e){this._telemetryService.publicLog("api.deprecated",{"function":"TextEditor.show"});var i=this._textEditorsMap[t];if(i){var o=i.getModel();return this._workbenchEditorService.openEditor({resource:o.uri,options:{preserveFocus:!1}},e).then(function(){})}},e.prototype.$tryHideEditor=function(t){this._telemetryService.publicLog("api.deprecated",{"function":"TextEditor.hide"});var e=this._textEditorsMap[t];if(e)for(var i=this._workbenchEditorService.getVisibleEditors(),o=0,r=i;o<r.length;o++){var s=r[o];if(e.matches(s))return this._workbenchEditorService.closeEditor(s.position,s.input).then(function(){})}},e.prototype.$trySetSelections=function(t,e){return this._textEditorsMap[t]?(this._textEditorsMap[t].setSelections(e),o.TPromise.as(null)):o.TPromise.wrapError("TextEditor disposed")},e.prototype.$trySetDecorations=function(t,e,i){return this._textEditorsMap[t]?(this._textEditorsMap[t].setDecorations(e,i),o.TPromise.as(null)):o.TPromise.wrapError("TextEditor disposed")},e.prototype.$tryRevealRange=function(t,e,i){return this._textEditorsMap[t]?void this._textEditorsMap[t].revealRange(e,i):o.TPromise.wrapError("TextEditor disposed")},e.prototype.$trySetOptions=function(t,e){return this._textEditorsMap[t]?(this._textEditorsMap[t].setConfiguration(e),o.TPromise.as(null)):o.TPromise.wrapError("TextEditor disposed")},e.prototype.$tryApplyEdits=function(t,e,i,r){return this._textEditorsMap[t]?o.TPromise.as(this._textEditorsMap[t].applyEdits(e,i,r)):o.TPromise.wrapError("TextEditor disposed")},e.prototype.$registerTextEditorDecorationType=function(t,e){this._editorTracker.registerTextEditorDecorationType(t,e)},e.prototype.$removeTextEditorDecorationType=function(t){this._editorTracker.removeTextEditorDecorationType(t)},e=__decorate([__param(0,r.IThreadService),__param(1,d.IWorkbenchEditorService),__param(2,c.IEditorGroupService),__param(3,h.ITelemetryService),__param(4,n.ICodeEditorService),__param(5,u.IEventService),__param(6,a.IModelService)],e)}(v.MainThreadEditorsShape);e.MainThreadEditors=f});