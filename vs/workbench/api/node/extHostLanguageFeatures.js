var __extends=this&&this.__extends||function(t,e){function r(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)};define(["require","exports","vs/base/common/winjs.base","vs/base/common/lifecycle","vs/workbench/api/node/extHostTypeConverters","vs/workbench/api/node/extHostTypes","vs/base/common/async","./extHost.protocol","vs/base/common/strings"],function(t,e,r,n,o,i,s,a,u){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var c=function(){function t(t,e){this._documents=t,this._provider=e}return t.prototype.provideDocumentSymbols=function(t){var e=this,r=this._documents.getDocumentData(t).document;return s.asWinJsPromise(function(t){return e._provider.provideDocumentSymbols(r,t)}).then(function(t){if(Array.isArray(t))return t.map(o.SymbolInformation.toOutlineEntry)})},t}(),p=function(){function t(t,e,r){this._cache=Object.create(null),this._documents=t,this._commands=e,this._provider=r}return t.prototype.provideCodeLenses=function(t){var e=this,r=this._documents.getDocumentData(t).document,i=r.version,a=t.toString(),u=this._cache[a];if(u&&u.version===i)return new s.ShallowCancelThenPromise(u.data.then(function(t){return t.symbols}));var c=s.asWinJsPromise(function(t){return e._provider.provideCodeLenses(r,t)}).then(function(t){if(Array.isArray(t)){var e={lenses:t,symbols:[],disposables:[]};return t.forEach(function(t,r){e.symbols.push({id:String(r),range:o.fromRange(t.range),command:o.Command.from(t.command,e.disposables)})}),e}});return this._cache[a]={version:i,data:c},new s.ShallowCancelThenPromise(c.then(function(t){return u&&u.data.then(function(t){return n.dispose(t.disposables)}),t&&t.symbols}))},t.prototype.resolveCodeLens=function(t,e){var n=this,i=this._cache[t.toString()];if(i)return i.data.then(function(t){if(t){var i=t.lenses[Number(e.id)];if(i){var a;return a="function"!=typeof n._provider.resolveCodeLens||i.isResolved?r.TPromise.as(i):s.asWinJsPromise(function(t){return n._provider.resolveCodeLens(i,t)}),a.then(function(r){i=r||i;var n=i.command;return n||(n={title:"<<MISSING COMMAND>>",command:"missing"}),e.command=o.Command.from(n,t.disposables),e})}}})},t}(),d=function(){function t(t,e){this._documents=t,this._provider=e}return t.prototype.provideDefinition=function(e,r){var n=this,i=this._documents.getDocumentData(e).document,a=o.toPosition(r);return s.asWinJsPromise(function(t){return n._provider.provideDefinition(i,a,t)}).then(function(e){return Array.isArray(e)?e.map(t._convertLocation):e?t._convertLocation(e):void 0})},t._convertLocation=function(t){if(t)return{uri:t.uri,range:o.fromRange(t.range)}},t}(),h=function(){function t(t,e){this._documents=t,this._provider=e}return t.prototype.provideHover=function(t,e){var r=this,n=this._documents.getDocumentData(t).document,a=o.toPosition(e);return s.asWinJsPromise(function(t){return r._provider.provideHover(n,a,t)}).then(function(t){if(t)return t.range||(t.range=n.getWordRangeAtPosition(a)),t.range||(t.range=new i.Range(a,a)),o.fromHover(t)})},t}(),m=function(){function t(t,e){this._documents=t,this._provider=e}return t.prototype.provideDocumentHighlights=function(e,r){var n=this,i=this._documents.getDocumentData(e).document,a=o.toPosition(r);return s.asWinJsPromise(function(t){return n._provider.provideDocumentHighlights(i,a,t)}).then(function(e){if(Array.isArray(e))return e.map(t._convertDocumentHighlight)})},t._convertDocumentHighlight=function(t){return{range:o.fromRange(t.range),kind:t.kind}},t}(),f=function(){function t(t,e){this._documents=t,this._provider=e}return t.prototype.provideReferences=function(e,r,n){var i=this,a=this._documents.getDocumentData(e).document,u=o.toPosition(r);return s.asWinJsPromise(function(t){return i._provider.provideReferences(a,u,n,t)}).then(function(e){if(Array.isArray(e))return e.map(t._convertLocation)})},t._convertLocation=function(t){return{uri:t.uri,range:o.fromRange(t.range)}},t}(),v=function(){function t(t,e,r,n){this._cachedCommands=[],this._documents=t,this._commands=e,this._diagnostics=r,this._provider=n}return t.prototype.provideCodeActions=function(t,e){var r=this,i=this._documents.getDocumentData(t).document,a=o.toRange(e),u=[];return this._diagnostics.forEach(function(e){if(e.has(t))for(var r=0,n=e.get(t);r<n.length;r++){var o=n[r];o.range.intersection(a)&&u.push(o)}}),this._cachedCommands=n.dispose(this._cachedCommands),s.asWinJsPromise(function(t){return r._provider.provideCodeActions(i,a,{diagnostics:u},t)}).then(function(t){if(Array.isArray(t))return t.map(function(t,e){return{command:o.Command.from(t,r._cachedCommands),score:e}})})},t}(),_=function(){function t(t,e){this._documents=t,this._provider=e}return t.prototype.provideDocumentFormattingEdits=function(t,e){var r=this,n=this._documents.getDocumentData(t).document;return s.asWinJsPromise(function(t){return r._provider.provideDocumentFormattingEdits(n,e,t)}).then(function(t){if(Array.isArray(t))return t.map(o.TextEdit.from)})},t}(),g=function(){function t(t,e){this._documents=t,this._provider=e}return t.prototype.provideDocumentRangeFormattingEdits=function(t,e,r){var n=this,i=this._documents.getDocumentData(t).document,a=o.toRange(e);return s.asWinJsPromise(function(t){return n._provider.provideDocumentRangeFormattingEdits(i,a,r,t)}).then(function(t){if(Array.isArray(t))return t.map(o.TextEdit.from)})},t}(),l=function(){function t(t,e){this.autoFormatTriggerCharacters=[],this._documents=t,this._provider=e}return t.prototype.provideOnTypeFormattingEdits=function(t,e,r,n){var i=this,a=this._documents.getDocumentData(t).document,u=o.toPosition(e);return s.asWinJsPromise(function(t){return i._provider.provideOnTypeFormattingEdits(a,u,r,n,t)}).then(function(t){if(Array.isArray(t))return t.map(o.TextEdit.from)})},t}(),y=function(){function t(t){this._provider=t}return t.prototype.getNavigateToItems=function(t){var e=this;return s.asWinJsPromise(function(r){return e._provider.provideWorkspaceSymbols(t,r)}).then(function(t){if(Array.isArray(t))return t.map(o.fromSymbolInformation)})},t}(),D=function(){function t(t,e){this._documents=t,this._provider=e}return t.prototype.provideRenameEdits=function(t,e,n){var i=this,a=this._documents.getDocumentData(t).document,u=o.toPosition(e);return s.asWinJsPromise(function(t){return i._provider.provideRenameEdits(a,u,n,t)}).then(function(t){if(t){for(var e={edits:[]},r=0,n=t.entries();r<n.length;r++)for(var i=n[r],s=i[0],a=i[1],u=0,c=a;u<c.length;u++){var p=c[u];e.edits.push({resource:s,newText:p.newText,range:o.fromRange(p.range)})}return e}},function(t){return"string"==typeof t?{edits:void 0,rejectReason:t}:r.TPromise.wrapError(t)})},t}(),w=function(){function t(t,e){this._cache=Object.create(null),this._documents=t,this._provider=e}return t.prototype.provideCompletionItems=function(t,e){var r=this,n=this._documents.getDocumentData(t).document,a=o.toPosition(e),u=n.getWordRangeAtPosition(a),c=t.toString();return delete this._cache[c],s.asWinJsPromise(function(t){return r._provider.provideCompletionItems(n,a,t)}).then(function(t){var e,s={suggestions:[],currentWord:u?n.getText(new i.Range(u.start.line,u.start.character,a.line,a.character)):""},p=[s];if(Array.isArray(t))e=new i.CompletionList(t);else{if(!(t instanceof i.CompletionList))return t?void console.warn("INVALID result from completion provider. expected CompletionItem-array or CompletionList but got:",t):void 0;e=t,s.incomplete=e.isIncomplete}for(var d=0;d<e.items.length;d++){var h=e.items[d],m=o.Suggest.from(h);if(h.textEdit){var f=h.textEdit.range;if(!f.isSingleLine||f.start.line!==a.line){console.warn("INVALID text edit, must be single line and on the same line");continue}m.codeSnippet=h.textEdit.newText,m.overwriteBefore=a.character-f.start.character,m.overwriteAfter=f.end.character-a.character,p.push({currentWord:n.getText(f),suggestions:[m],incomplete:e.isIncomplete})}else s.suggestions.push(m);m.id=String(d)}return r._cache[c]=e,p})},t.prototype.resolveCompletionItem=function(t,e,n){var i=this;if("function"!=typeof this._provider.resolveCompletionItem)return r.TPromise.as(n);var a=this._cache[t.toString()];if(!a)return r.TPromise.as(n);var u=a.items[Number(n.id)];return u?s.asWinJsPromise(function(t){return i._provider.resolveCompletionItem(u,t)}).then(function(t){return o.Suggest.from(t||u)}):r.TPromise.as(n)},t}(),x=function(){function t(t,e){this._documents=t,this._provider=e}return t.prototype.provideSignatureHelp=function(t,e){var r=this,n=this._documents.getDocumentData(t).document,a=o.toPosition(e);return s.asWinJsPromise(function(t){return r._provider.provideSignatureHelp(n,a,t)}).then(function(t){if(t instanceof i.SignatureHelp)return o.SignatureHelp.from(t)})},t}(),P=function(){function t(t,e){this._documents=t,this._provider=e}return t.prototype.provideLinks=function(t){var e=this,r=this._documents.getDocumentData(t).document;return s.asWinJsPromise(function(t){return e._provider.provideDocumentLinks(r,t)}).then(function(t){if(Array.isArray(t))return t.map(o.DocumentLink.from)})},t}(),A=function(t){function e(e,r,n,o){t.call(this),this._adapter=Object.create(null),this._proxy=e.get(a.MainContext.MainThreadLanguageFeatures),this._documents=r,this._commands=n,this._diagnostics=o}return __extends(e,t),e.prototype._createDisposable=function(t){var e=this;return new i.Disposable(function(){delete e._adapter[t],e._proxy.$unregister(t)})},e.prototype._nextHandle=function(){return e._handlePool++},e.prototype._withAdapter=function(t,e,n){var o=this._adapter[t];return o instanceof e?n(o):r.TPromise.wrapError(new Error("no adapter found"))},e.prototype.registerDocumentSymbolProvider=function(t,e){var r=this._nextHandle();return this._adapter[r]=new c(this._documents,e),this._proxy.$registerOutlineSupport(r,t),this._createDisposable(r)},e.prototype.$provideDocumentSymbols=function(t,e){return this._withAdapter(t,c,function(t){return t.provideDocumentSymbols(e)})},e.prototype.registerCodeLensProvider=function(t,e){var r=this._nextHandle();return this._adapter[r]=new p(this._documents,this._commands,e),this._proxy.$registerCodeLensSupport(r,t),this._createDisposable(r)},e.prototype.$provideCodeLenses=function(t,e){return this._withAdapter(t,p,function(t){return t.provideCodeLenses(e)})},e.prototype.$resolveCodeLens=function(t,e,r){return this._withAdapter(t,p,function(t){return t.resolveCodeLens(e,r)})},e.prototype.registerDefinitionProvider=function(t,e){var r=this._nextHandle();return this._adapter[r]=new d(this._documents,e),this._proxy.$registerDeclaractionSupport(r,t),this._createDisposable(r)},e.prototype.$provideDefinition=function(t,e,r){return this._withAdapter(t,d,function(t){return t.provideDefinition(e,r)})},e.prototype.registerHoverProvider=function(t,e){var r=this._nextHandle();return this._adapter[r]=new h(this._documents,e),this._proxy.$registerHoverProvider(r,t),this._createDisposable(r)},e.prototype.$provideHover=function(t,e,r){return this._withAdapter(t,h,function(t){return t.provideHover(e,r)})},e.prototype.registerDocumentHighlightProvider=function(t,e){var r=this._nextHandle();return this._adapter[r]=new m(this._documents,e),this._proxy.$registerDocumentHighlightProvider(r,t),this._createDisposable(r)},e.prototype.$provideDocumentHighlights=function(t,e,r){return this._withAdapter(t,m,function(t){return t.provideDocumentHighlights(e,r)})},e.prototype.registerReferenceProvider=function(t,e){var r=this._nextHandle();return this._adapter[r]=new f(this._documents,e),this._proxy.$registerReferenceSupport(r,t),this._createDisposable(r)},e.prototype.$provideReferences=function(t,e,r,n){return this._withAdapter(t,f,function(t){return t.provideReferences(e,r,n)})},e.prototype.registerCodeActionProvider=function(t,e){var r=this._nextHandle();return this._adapter[r]=new v(this._documents,this._commands,this._diagnostics,e),this._proxy.$registerQuickFixSupport(r,t),this._createDisposable(r)},e.prototype.$provideCodeActions=function(t,e,r){return this._withAdapter(t,v,function(t){return t.provideCodeActions(e,r)})},e.prototype.registerDocumentFormattingEditProvider=function(t,e){var r=this._nextHandle();return this._adapter[r]=new _(this._documents,e),this._proxy.$registerDocumentFormattingSupport(r,t),this._createDisposable(r)},e.prototype.$provideDocumentFormattingEdits=function(t,e,r){return this._withAdapter(t,_,function(t){return t.provideDocumentFormattingEdits(e,r)})},e.prototype.registerDocumentRangeFormattingEditProvider=function(t,e){var r=this._nextHandle();return this._adapter[r]=new g(this._documents,e),this._proxy.$registerRangeFormattingSupport(r,t),this._createDisposable(r)},e.prototype.$provideDocumentRangeFormattingEdits=function(t,e,r,n){return this._withAdapter(t,g,function(t){return t.provideDocumentRangeFormattingEdits(e,r,n)})},e.prototype.registerOnTypeFormattingEditProvider=function(t,e,r){var n=this._nextHandle();return this._adapter[n]=new l(this._documents,e),this._proxy.$registerOnTypeFormattingSupport(n,t,r),this._createDisposable(n)},e.prototype.$provideOnTypeFormattingEdits=function(t,e,r,n,o){return this._withAdapter(t,l,function(t){return t.provideOnTypeFormattingEdits(e,r,n,o)})},e.prototype.registerWorkspaceSymbolProvider=function(t){var e=this._nextHandle();return this._adapter[e]=new y(t),this._proxy.$registerNavigateTypeSupport(e),this._createDisposable(e)},e.prototype.$getNavigateToItems=function(t,e){return this._withAdapter(t,y,function(t){return t.getNavigateToItems(e)})},e.prototype.registerRenameProvider=function(t,e){var r=this._nextHandle();return this._adapter[r]=new D(this._documents,e),this._proxy.$registerRenameSupport(r,t),this._createDisposable(r)},e.prototype.$provideRenameEdits=function(t,e,r,n){return this._withAdapter(t,D,function(t){return t.provideRenameEdits(e,r,n)})},e.prototype.registerCompletionItemProvider=function(t,e,r){var n=this._nextHandle();return this._adapter[n]=new w(this._documents,e),this._proxy.$registerSuggestSupport(n,t,r),this._createDisposable(n)},e.prototype.$provideCompletionItems=function(t,e,r){return this._withAdapter(t,w,function(t){return t.provideCompletionItems(e,r)})},e.prototype.$resolveCompletionItem=function(t,e,r,n){return this._withAdapter(t,w,function(t){return t.resolveCompletionItem(e,r,n)})},e.prototype.registerSignatureHelpProvider=function(t,e,r){var n=this._nextHandle();return this._adapter[n]=new x(this._documents,e),this._proxy.$registerSignatureHelpProvider(n,t,r),this._createDisposable(n)},e.prototype.$provideSignatureHelp=function(t,e,r){return this._withAdapter(t,x,function(t){return t.provideSignatureHelp(e,r)})},e.prototype.registerDocumentLinkProvider=function(t,e){var r=this._nextHandle();return this._adapter[r]=new P(this._documents,e),this._proxy.$registerDocumentLinkProvider(r,t),this._createDisposable(r)},e.prototype.$providDocumentLinks=function(t,e){return this._withAdapter(t,P,function(t){return t.provideLinks(e)})},e.prototype.setLanguageConfiguration=function(t,e){var r=e.wordPattern;if(r&&u.regExpLeadsToEndlessLoop(r))throw new Error("Invalid language configuration: wordPattern '"+r+"' is not allowed to match the empty string.");r?this._documents.setWordDefinitionFor(t,r):this._documents.setWordDefinitionFor(t,null);var n=this._nextHandle();return this._proxy.$setLanguageConfiguration(n,t,e),this._createDisposable(n)},e._handlePool=0,e}(a.ExtHostLanguageFeaturesShape);e.ExtHostLanguageFeatures=A});