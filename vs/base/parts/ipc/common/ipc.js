/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","vs/base/common/winjs.base","vs/base/common/lifecycle","vs/base/common/event"],function(e,t,n,s,r){"use strict";function i(e){var t=function(t,n){return e.then(function(e){return e.call(t,n)})};return{call:t}}function o(e){var t=!1,s=function(s,r){return t?e.call(s,r):n.TPromise.timeout(0).then(function(){return t=!0}).then(function(){return e.call(s,r)})};return{call:s}}function a(e){var t;return new n.Promise(function(n,s,r){return t=e(r)},function(){return t.dispose()})}function u(e,t){var n,s=new r.Emitter({onFirstListenerAdd:function(){n=e.call(t,null).then(null,function(e){return null},function(e){return s.fire(e)})},onLastListenerRemove:function(){n.cancel(),n=null}});return s.event}var c;!function(e){e[e.Common=0]="Common",e[e.Cancel=1]="Cancel"}(c||(c={}));var l;!function(e){e[e.Initialize=0]="Initialize",e[e.Success=1]="Success",e[e.Progress=2]="Progress",e[e.Error=3]="Error",e[e.ErrorObj=4]="ErrorObj"}(l||(l={}));var f;!function(e){e[e.Uninitialized=0]="Uninitialized",e[e.Idle=1]="Idle"}(f||(f={}));var d=function(){function e(e){var t=this;this.protocol=e,this.channels=Object.create(null),this.activeRequests=Object.create(null),this.protocol.onMessage(function(e){return t.onMessage(e)}),this.protocol.send({type:l.Initialize})}return e.prototype.registerChannel=function(e,t){this.channels[e]=t},e.prototype.onMessage=function(e){switch(e.type){case c.Common:this.onCommonRequest(e);break;case c.Cancel:this.onCancelRequest(e)}},e.prototype.onCommonRequest=function(e){var t,r=this,i=this.channels[e.channelName];try{t=i.call(e.name,e.arg)}catch(o){t=n.Promise.wrapError(o)}var a=e.id,u=t.then(function(t){r.protocol.send({id:a,data:t,type:l.Success}),delete r.activeRequests[e.id]},function(t){t instanceof Error?r.protocol.send({id:a,data:{message:t.message,name:t.name,stack:t.stack?t.stack.split("\n"):void 0},type:l.Error}):r.protocol.send({id:a,data:t,type:l.ErrorObj}),delete r.activeRequests[e.id]},function(e){r.protocol.send({id:a,data:e,type:l.Progress})});this.activeRequests[e.id]=s.toDisposable(function(){return u.cancel()})},e.prototype.onCancelRequest=function(e){var t=this.activeRequests[e.id];t&&(t.dispose(),delete this.activeRequests[e.id])},e.prototype.dispose=function(){var e=this;Object.keys(this.activeRequests).forEach(function(t){e.activeRequests[t].dispose()}),this.activeRequests=null},e}();t.Server=d;var h=function(){function e(e){var t=this;this.protocol=e,this.state=f.Uninitialized,this.bufferedRequests=[],this.handlers=Object.create(null),this.lastRequestId=0,this.protocol.onMessage(function(e){return t.onMessage(e)})}return e.prototype.getChannel=function(e){var t=this,n=function(n,s){return t.request(e,n,s)};return{call:n}},e.prototype.request=function(e,t,n){var s={raw:{id:this.lastRequestId++,type:c.Common,channelName:e,name:t,arg:n}};return this.state===f.Uninitialized?this.bufferRequest(s):this.doRequest(s)},e.prototype.doRequest=function(e){var t=this,s=e.raw.id;return new n.Promise(function(n,r,i){t.handlers[s]=function(e){switch(e.type){case l.Success:delete t.handlers[s],n(e.data);break;case l.Error:delete t.handlers[s];var o=new Error(e.data.message);o.stack=e.data.stack,o.name=e.data.name,r(o);break;case l.ErrorObj:delete t.handlers[s],r(e.data);break;case l.Progress:i(e.data)}},t.send(e.raw)},function(){return t.send({id:s,type:c.Cancel})})},e.prototype.bufferRequest=function(e){var t=this,s=null;return new n.Promise(function(n,r,i){t.bufferedRequests.push(e),e.flush=function(){e.flush=null,s=t.doRequest(e).then(n,r,i)}},function(){if(e.flush=null,t.state!==f.Uninitialized)return void(s&&(s.cancel(),s=null));var n=t.bufferedRequests.indexOf(e);n!==-1&&t.bufferedRequests.splice(n,1)})},e.prototype.onMessage=function(e){if(this.state===f.Uninitialized&&e.type===l.Initialize)return this.state=f.Idle,this.bufferedRequests.forEach(function(e){return e.flush&&e.flush()}),void(this.bufferedRequests=null);var t=this.handlers[e.id];t&&t(e)},e.prototype.send=function(e){try{this.protocol.send(e)}catch(t){}},e}();t.Client=h,t.getDelayedChannel=i,t.getNextTickChannel=o,t.eventToCall=a,t.eventFromCall=u});