/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","net","vs/base/common/winjs.base","vs/base/common/event","vs/base/parts/ipc/common/ipc"],function(e,n,t,r,o,i){"use strict";function s(e,n,t){for(void 0===t&&(t=0);t<e.length&&e[t]!==n;)t++;return t}function c(e){return new r.TPromise(function(n,r){var o=t.createServer();o.on("error",r),o.listen(e,function(){o.removeListener("error",r),n(new l(o))})})}function u(e){return new r.TPromise(function(n,r){var o=t.createConnection(e,function(){o.removeListener("error",r),n(new a(o))});o.once("error",r)})}var f=function(){function e(e){this.socket=e,this.buffer=null}return e.prototype.send=function(n){try{this.socket.write(JSON.stringify(n)),this.socket.write(e.Boundary)}catch(t){}},e.prototype.onMessage=function(e){var n=this;this.socket.on("data",function(t){for(var r=0,o=0;(o=s(t,0,r))<t.length;){var i=t.slice(r,o);n.buffer?(e(JSON.parse(Buffer.concat([n.buffer,i]).toString("utf8"))),n.buffer=null):e(JSON.parse(i.toString("utf8"))),r=o+1}if(o-r>0){var c=t.slice(r,o);n.buffer?n.buffer=Buffer.concat([n.buffer,c]):n.buffer=c}})},e.Boundary=new Buffer([0]),e}(),l=function(){function e(e){var n=this;this.server=e,this.channels=Object.create(null),this.server.on("connection",function(e){var t=new i.Server(new f(e));Object.keys(n.channels).forEach(function(e){return t.registerChannel(e,n.channels[e])}),e.once("close",function(){return t.dispose()})})}return e.prototype.registerChannel=function(e,n){this.channels[e]=n},e.prototype.dispose=function(){this.channels=null,this.server.close(),this.server=null},e}();n.Server=l;var a=function(){function e(e){var n=this;this.socket=e,this._onClose=new o.Emitter,this.ipcClient=new i.Client(new f(e)),e.once("close",function(){return n._onClose.fire()})}return Object.defineProperty(e.prototype,"onClose",{get:function(){return this._onClose.event},enumerable:!0,configurable:!0}),e.prototype.getChannel=function(e){return this.ipcClient.getChannel(e)},e.prototype.dispose=function(){this.socket.end(),this.socket=null,this.ipcClient=null},e}();n.Client=a,n.serve=c,n.connect=u});