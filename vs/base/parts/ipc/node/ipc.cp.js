/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)};define(["require","exports","child_process","vs/base/common/winjs.base","vs/base/common/async","vs/base/common/objects","vs/base/parts/ipc/common/ipc"],function(e,t,n,s,i,o,r){"use strict";var c=function(e){function t(){var t=this;e.call(this,{send:function(e){try{process.send(e)}catch(t){}},onMessage:function(e){return process.on("message",e)}}),process.once("disconnect",function(){return t.dispose()})}return __extends(t,e),t}(r.Server);t.Server=c;var a=function(){function e(e,t){this.modulePath=e,this.options=t;var n=t&&t.timeout?t.timeout:6e4;this.disposeDelayer=new i.Delayer(n),this.activeRequests=[],this.child=null,this._client=null,this.channels=Object.create(null)}return e.prototype.getChannel=function(e){var t=this,n=function(n,s){return t.request(e,n,s)};return{call:n}},e.prototype.request=function(e,t,n){var i=this;this.disposeDelayer.cancel();var o=this.channels[e]||(this.channels[e]=this.client.getChannel(e)),r=o.call(t,n),c=new s.Promise(function(e,t,n){r.then(e,t,n).done(function(){i.activeRequests&&(i.activeRequests.splice(i.activeRequests.indexOf(c),1),0===i.activeRequests.length&&i.disposeDelayer.trigger(function(){return i.disposeClient()}))})},function(){return r.cancel()});return this.activeRequests.push(c),c},Object.defineProperty(e.prototype,"client",{get:function(){var e=this;if(!this._client){var t=this.options&&this.options.args?this.options.args:[],s=Object.create(null);s.env=o.assign(o.clone(process.env),{VSCODE_PARENT_PID:String(process.pid)}),this.options&&this.options.env&&(s.env=o.assign(s.env,this.options.env)),this.options&&"number"==typeof this.options.debug&&(s.execArgv=["--nolazy","--debug="+this.options.debug]),this.options&&"number"==typeof this.options.debugBrk&&(s.execArgv=["--nolazy","--debug-brk="+this.options.debugBrk]),this.child=n.fork(this.modulePath,t,s),this._client=new r.Client({send:function(t){return e.child&&e.child.connected&&e.child.send(t)},onMessage:function(t){e.child.on("message",function(n){if(n&&"__$console"===n.type){var s=["%c[IPC Library: "+e.options.serverName+"]","color: darkgreen"];try{var i=JSON.parse(n.arguments);s=s.concat(Object.getOwnPropertyNames(i).map(function(e){return i[e]}))}catch(o){s.push(n.arguments)}console[n.severity].apply(console,s)}else t(n)})}});var i=function(){return e.disposeClient()};process.once("exit",i),this.child.on("error",function(t){return console.warn('IPC "'+e.options.serverName+'" errored with '+t)}),this.child.on("exit",function(t,n){process.removeListener("exit",i),e.activeRequests&&(e.activeRequests.forEach(function(e){return e.cancel()}),e.activeRequests=[]),t&&"SIGTERM"!==n&&(console.warn('IPC "'+e.options.serverName+'" crashed with exit code '+t),e.disposeDelayer.cancel(),e.disposeClient())})}return this._client},enumerable:!0,configurable:!0}),e.prototype.disposeClient=function(){this._client&&(this.child.kill(),this.child=null,this._client=null,this.channels=Object.create(null))},e.prototype.dispose=function(){this.disposeDelayer.cancel(),this.disposeDelayer=null,this.disposeClient(),this.activeRequests=null},e}();t.Client=a});