var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)};define(["require","exports","vs/base/common/assert","vs/base/common/errors","vs/base/common/lifecycle","vs/base/common/arrays","vs/base/common/eventEmitter","vs/base/common/winjs.base"],function(t,e,i,s,r,n,o,h){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";function l(t,e){for(var i=t.getHierarchy(),s=e.getHierarchy(),r=n.commonPrefixLength(i,s),o=i[r-1],h=o.getNavigator(),l=null,u=null,a=0,p=[];o&&(null===l||null===u);)p.push(o),o===t&&(l=a),o===e&&(u=a),a++,o=h.next();if(null===l||null===u)return[];var c=Math.min(l,u),d=Math.max(l,u);return p.slice(c,d+1)}var u=function(t){function e(e){t.call(this),this._item=e}return __extends(e,t),Object.defineProperty(e.prototype,"item",{get:function(){return this._item},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this.emit("unlock"),t.prototype.dispose.call(this)},e}(o.EventEmitter);e.LockData=u;var a=function(){function t(){this.locks=Object.create({})}return t.prototype.isLocked=function(t){return!!this.locks[t.id]},t.prototype.run=function(t,e){var i=this,s=this.getLock(t);if(s){var r;return new h.Promise(function(n,o){r=s.addOneTimeDisposableListener("unlock",function(){return i.run(t,e).then(n,o)})},function(){r.dispose()})}var n;return new h.Promise(function(s,r){if(t.isDisposed())return r(new Error("Item is disposed."));var o=i.locks[t.id]=new u(t);return n=e().then(function(e){return delete i.locks[t.id],o.dispose(),e}).then(s,r)},function(){return n.cancel()})},t.prototype.getLock=function(t){var e;for(e in this.locks){var i=this.locks[e];if(t.intersects(i.item))return i}return null},t}();e.Lock=a;var p=function(t){function e(){t.call(this),this._isDisposed=!1,this.items={}}return __extends(e,t),e.prototype.register=function(t){i.ok(!this.isRegistered(t.id),"item already registered: "+t.id),this.items[t.id]={item:t,disposable:this.addEmitter2(t)}},e.prototype.deregister=function(t){i.ok(this.isRegistered(t.id),"item not registered: "+t.id),this.items[t.id].disposable.dispose(),delete this.items[t.id]},e.prototype.isRegistered=function(t){return this.items.hasOwnProperty(t)},e.prototype.getItem=function(t){var e=this.items[t];return e?e.item:null},e.prototype.dispose=function(){t.prototype.dispose.call(this),this.items=null,this._isDisposed=!0},e.prototype.isDisposed=function(){return this._isDisposed},e}(o.EventEmitter);e.ItemRegistry=p;var c=function(t){function e(e,i,s,r,n){t.call(this),this.registry=i,this.context=s,this.lock=r,this.element=n,this.id=e,this.registry.register(this),this.doesHaveChildren=this.context.dataSource.hasChildren(this.context.tree,this.element),this.needsChildrenRefresh=!0,this.parent=null,this.previous=null,this.next=null,this.firstChild=null,this.lastChild=null,this.userContent=null,this.traits={},this.depth=0,this.expanded=!1,this.emit("item:create",{item:this}),this.visible=this._isVisible(),this.height=this._getHeight(),this._isDisposed=!1}return __extends(e,t),e.prototype.getElement=function(){return this.element},e.prototype.hasChildren=function(){return this.doesHaveChildren},e.prototype.getDepth=function(){return this.depth},e.prototype.isVisible=function(){return this.visible},e.prototype.setVisible=function(t){this.visible=t},e.prototype.isExpanded=function(){return this.expanded},e.prototype._setExpanded=function(t){this.expanded=t},e.prototype.reveal=function(t){void 0===t&&(t=null);var e={item:this,relativeTop:t};this.emit("item:reveal",e)},e.prototype.expand=function(){var t=this;if(this.isExpanded()||!this.doesHaveChildren||this.lock.isLocked(this))return h.TPromise.as(!1);var e=this.lock.run(this,function(){var e,i={item:t};return t.emit("item:expanding",i),e=t.needsChildrenRefresh?t.refreshChildren(!1,!0,!0):h.TPromise.as(null),e.then(function(){return t._setExpanded(!0),t.emit("item:expanded",i),!0})});return e.then(function(e){return!t.isDisposed()&&(t.context.options.autoExpandSingleChildren&&e&&null!==t.firstChild&&t.firstChild===t.lastChild&&t.firstChild.isVisible()?t.firstChild.expand().then(function(){return!0}):e)})},e.prototype.collapse=function(t){var e=this;if(void 0===t&&(t=!1),t){var i=h.TPromise.as(null);return this.forEachChild(function(t){i=i.then(function(){return t.collapse(!0)})}),i.then(function(){return e.collapse(!1)})}return!this.isExpanded()||this.lock.isLocked(this)?h.TPromise.as(!1):this.lock.run(this,function(){var t={item:e};return e.emit("item:collapsing",t),e._setExpanded(!1),e.emit("item:collapsed",t),h.TPromise.as(!0)})},e.prototype.addTrait=function(t){var e={item:this,trait:t};this.traits[t]=!0,this.emit("item:addTrait",e)},e.prototype.removeTrait=function(t){var e={item:this,trait:t};delete this.traits[t],this.emit("item:removeTrait",e)},e.prototype.hasTrait=function(t){return this.traits[t]||!1},e.prototype.getAllTraits=function(){var t,e=[];for(t in this.traits)this.traits.hasOwnProperty(t)&&this.traits[t]&&e.push(t);return e},e.prototype.getHeight=function(){return this.height},e.prototype.refreshChildren=function(t,i,r){var n=this;if(void 0===i&&(i=!1),void 0===r&&(r=!1),!r&&!this.isExpanded())return this.needsChildrenRefresh=!0,h.TPromise.as(this);this.needsChildrenRefresh=!1;var o=function(){var r={item:n,isNested:i};n.emit("item:childrenRefreshing",r);var o;o=n.doesHaveChildren?n.context.dataSource.getChildren(n.context.tree,n.element):h.TPromise.as([]);var l=o.then(function(i){if(n.isDisposed()||n.registry.isDisposed())return h.TPromise.as(null);i=i?i.slice(0):[],i=n.sort(i);for(var s={};null!==n.firstChild;)s[n.firstChild.id]=n.firstChild,n.removeChild(n.firstChild);for(var r=0,o=i.length;r<o;r++){var l=i[r],u=n.context.dataSource.getId(n.context.tree,l),a=s[u]||new e(u,n.registry,n.context,n.lock,l);a.element=l,t&&(a.needsChildrenRefresh=t),delete s[u],n.addChild(a)}for(var p in s)s.hasOwnProperty(p)&&s[p].dispose();return t?h.Promise.join(n.mapEachChild(function(e){return e.doRefresh(t,!0)})):h.TPromise.as(null)});return l.then(null,s.onUnexpectedError).then(function(){return n.emit("item:childrenRefreshed",r)})};return i?o():this.lock.run(this,o)},e.prototype.doRefresh=function(t,e){void 0===e&&(e=!1);var i={item:this};return this.doesHaveChildren=this.context.dataSource.hasChildren(this.context.tree,this.element),this.height=this._getHeight(),this.setVisible(this._isVisible()),this.emit("item:refresh",i),this.refreshChildren(t,e)},e.prototype.refresh=function(t){return this.doRefresh(t)},e.prototype.getNavigator=function(){return new f(this)},e.prototype.intersects=function(t){return this.isAncestorOf(t)||t.isAncestorOf(this)},e.prototype.getHierarchy=function(){var t=[],e=this;do t.push(e),e=e.parent;while(e);return t.reverse(),t},e.prototype.isAncestorOf=function(t){for(;t;){if(t.id===this.id)return!0;t=t.parent}return!1},e.prototype.addChild=function(t,e){void 0===e&&(e=this.lastChild);var i=null===this.firstChild,s=null===e,r=e===this.lastChild;i?(this.firstChild=this.lastChild=t,t.next=t.previous=null):s?(this.firstChild.previous=t,t.next=this.firstChild,t.previous=null,this.firstChild=t):r?(this.lastChild.next=t,t.next=null,t.previous=this.lastChild,this.lastChild=t):(t.previous=e,t.next=e.next,e.next.previous=t,e.next=t),t.parent=this,t.depth=this.depth+1},e.prototype.removeChild=function(t){var e=this.firstChild===t,i=this.lastChild===t;e&&i?this.firstChild=this.lastChild=null:e?(t.next.previous=null,this.firstChild=t.next):i?(t.previous.next=null,this.lastChild=t.previous):(t.next.previous=t.previous,t.previous.next=t.next),t.parent=null,t.depth=null},e.prototype.forEachChild=function(t){for(var e,i=this.firstChild;i;)e=i.next,t(i),i=e},e.prototype.mapEachChild=function(t){var e=[];return this.forEachChild(function(i){e.push(t(i))}),e},e.prototype.sort=function(t){var e=this;return this.context.sorter?t.sort(function(t,i){return e.context.sorter.compare(e.context.tree,t,i)}):t},e.prototype._getHeight=function(){return this.context.renderer.getHeight(this.context.tree,this.element)},e.prototype._isVisible=function(){return this.context.filter.isVisible(this.context.tree,this.element)},e.prototype.isDisposed=function(){return this._isDisposed},e.prototype.dispose=function(){this.forEachChild(function(t){return t.dispose()}),this.parent=null,this.previous=null,this.next=null,this.firstChild=null,this.lastChild=null;var e={item:this};this.emit("item:dispose",e),this.registry.deregister(this),t.prototype.dispose.call(this),this._isDisposed=!0},e}(o.EventEmitter);e.Item=c;var d=function(t){function e(e,i,s,r,n){t.call(this,e,i,s,r,n)}return __extends(e,t),e.prototype.isVisible=function(){return!1},e.prototype.setVisible=function(t){},e.prototype.isExpanded=function(){return!0},e.prototype._setExpanded=function(t){},e.prototype.render=function(){},e.prototype._getHeight=function(){return 0},e.prototype._isVisible=function(){return!1},e}(c),f=function(){function t(t,e){void 0===e&&(e=!0),this.item=t,this.start=e?t:null}return t.lastDescendantOf=function(e){return e?e.isVisible()&&e.isExpanded()&&null!==e.lastChild?t.lastDescendantOf(e.lastChild):e:null},t.prototype.current=function(){return this.item||null},t.prototype.next=function(){if(this.item)do if((this.item instanceof d||this.item.isVisible()&&this.item.isExpanded())&&this.item.firstChild)this.item=this.item.firstChild;else if(this.item===this.start)this.item=null;else{for(;this.item&&this.item!==this.start&&!this.item.next;)this.item=this.item.parent;this.item===this.start&&(this.item=null),this.item=this.item?this.item.next:null}while(this.item&&!this.item.isVisible());return this.item||null},t.prototype.previous=function(){if(this.item)do{var e=t.lastDescendantOf(this.item.previous);e?this.item=e:this.item.parent&&this.item.parent!==this.start&&this.item.parent.isVisible()?this.item=this.item.parent:this.item=null}while(this.item&&!this.item.isVisible());return this.item||null},t.prototype.parent=function(){if(this.item){var t=this.item.parent;t&&t!==this.start&&t.isVisible()?this.item=t:this.item=null}return this.item||null},t.prototype.first=function(){return this.item=this.start,this.next(),this.item||null},t.prototype.last=function(){return this.start&&this.start.isExpanded()&&(this.item=this.start.lastChild,this.item&&!this.item.isVisible()&&this.previous()),this.item||null},t}();e.TreeNavigator=f;var m=function(t){function e(e){t.call(this),this.context=e,this.input=null,this.traitsToItems={}}return __extends(e,t),e.prototype.setInput=function(t){var e=this,i={item:this.input};this.emit("clearingInput",i),this.setSelection([]),this.setFocus(),this.setHighlight(),this.lock=new a,this.input&&this.input.dispose(),this.registry&&(this.registry.dispose(),this.registryDisposable.dispose()),this.registry=new p,this.registryDisposable=r.combinedDisposable([this.addEmitter2(this.registry),this.registry.addListener2("item:dispose",function(t){t.item.getAllTraits().forEach(function(i){return delete e.traitsToItems[i][t.item.id]})})]);var s=this.context.dataSource.getId(this.context.tree,t);return this.input=new d(s,this.registry,this.context,this.lock,t),i={item:this.input},this.emit("setInput",i),this.refresh(this.input)},e.prototype.getInput=function(){return this.input?this.input.getElement():null},e.prototype.refresh=function(t,e){var i=this;void 0===t&&(t=null),void 0===e&&(e=!0);var s=this.getItem(t);if(!s)return h.TPromise.as(null);var r={item:s,recursive:e};return this.emit("refreshing",r),s.refresh(e).then(function(){i.emit("refreshed",r)})},e.prototype.refreshAll=function(t,e){var i=this;void 0===e&&(e=!0);var s=[];return this.deferredEmit(function(){for(var r=0,n=t.length;r<n;r++)s.push(i.refresh(t[r],e))}),h.Promise.join(s)},e.prototype.expand=function(t){var e=this.getItem(t);return e?e.expand():h.TPromise.as(!1)},e.prototype.expandAll=function(t){if(!t){t=[];for(var e,i=this.getNavigator();e=i.next();)t.push(e)}for(var s=[],r=0,n=t.length;r<n;r++)s.push(this.expand(t[r]));return h.Promise.join(s)},e.prototype.collapse=function(t,e){void 0===e&&(e=!1);var i=this.getItem(t);return i?i.collapse(e):h.TPromise.as(!1)},e.prototype.collapseAll=function(t,e){void 0===t&&(t=null),void 0===e&&(e=!1),t||(t=[this.input],e=!0);for(var i=[],s=0,r=t.length;s<r;s++)i.push(this.collapse(t[s],e));return h.Promise.join(i)},e.prototype.toggleExpansion=function(t){return this.isExpanded(t)?this.collapse(t):this.expand(t)},e.prototype.toggleExpansionAll=function(t){for(var e=[],i=0,s=t.length;i<s;i++)e.push(this.toggleExpansion(t[i]));return h.Promise.join(e)},e.prototype.isExpanded=function(t){var e=this.getItem(t);return!!e&&e.isExpanded()},e.prototype.getExpandedElements=function(){for(var t,e=[],i=this.getNavigator();t=i.next();)t.isExpanded()&&e.push(t.getElement());return e},e.prototype.reveal=function(t,e){var i=this;return void 0===e&&(e=null),this.resolveUnknownParentChain(t).then(function(t){var e=h.TPromise.as(null);return t.forEach(function(t){e=e.then(function(){return i.expand(t)})}),e}).then(function(){var s=i.getItem(t);if(s)return s.reveal(e)})},e.prototype.resolveUnknownParentChain=function(t){var e=this;return this.context.dataSource.getParent(this.context.tree,t).then(function(t){return t?e.resolveUnknownParentChain(t).then(function(e){return e.push(t),e}):h.TPromise.as([])})},e.prototype.setHighlight=function(t,e){this.setTraits("highlighted",t?[t]:[]);var i={highlight:this.getHighlight(),payload:e};this.emit("highlight",i)},e.prototype.getHighlight=function(t){var e=this.getElementsWithTrait("highlighted",t);return 0===e.length?null:e[0]},e.prototype.isHighlighted=function(t){var e=this.getItem(t);return!!e&&e.hasTrait("highlighted")},e.prototype.select=function(t,e){this.selectAll([t],e)},e.prototype.selectRange=function(t,e,i){var s=this.getItem(t),r=this.getItem(e);s&&r&&this.selectAll(l(s,r),i)},e.prototype.deselectRange=function(t,e,i){var s=this.getItem(t),r=this.getItem(e);s&&r&&this.deselectAll(l(s,r),i)},e.prototype.selectAll=function(t,e){this.addTraits("selected",t);var i={selection:this.getSelection(),payload:e};this.emit("selection",i)},e.prototype.deselect=function(t,e){this.deselectAll([t],e)},e.prototype.deselectAll=function(t,e){this.removeTraits("selected",t);var i={selection:this.getSelection(),payload:e};this.emit("selection",i)},e.prototype.setSelection=function(t,e){this.setTraits("selected",t);var i={selection:this.getSelection(),payload:e};this.emit("selection",i)},e.prototype.toggleSelection=function(t,e){this.toggleTrait("selected",t);var i={selection:this.getSelection(),payload:e};this.emit("selection",i)},e.prototype.isSelected=function(t){var e=this.getItem(t);return!!e&&e.hasTrait("selected")},e.prototype.getSelection=function(t){return this.getElementsWithTrait("selected",t)},e.prototype.selectNext=function(t,e,i){void 0===t&&(t=1),void 0===e&&(e=!0);for(var s,r=this.getSelection(),n=r.length>0?r[0]:this.input,o=this.getNavigator(n,!1),h=0;h<t&&(s=o.next(),s);h++)n=s;e?this.setSelection([n],i):this.select(n,i)},e.prototype.selectPrevious=function(t,e,i){void 0===t&&(t=1),void 0===e&&(e=!0);var s=this.getSelection(),r=null,n=null;if(0===s.length){for(var o=this.getNavigator(this.input);r=o.next();)n=r;r=n}else{r=s[0];for(var o=this.getNavigator(r,!1),h=0;h<t&&(n=o.previous(),n);h++)r=n}e?this.setSelection([r],i):this.select(r,i)},e.prototype.selectParent=function(t,e){void 0===e&&(e=!0);var i=this.getSelection(),s=i.length>0?i[0]:this.input,r=this.getNavigator(s,!1),n=r.parent();n&&(e?this.setSelection([n],t):this.select(n,t))},e.prototype.setFocus=function(t,e){this.setTraits("focused",t?[t]:[]);var i={focus:this.getFocus(),payload:e};this.emit("focus",i)},e.prototype.isFocused=function(t){var e=this.getItem(t);return!!e&&e.hasTrait("focused")},e.prototype.getFocus=function(t){var e=this.getElementsWithTrait("focused",t);return 0===e.length?null:e[0]},e.prototype.focusNext=function(t,e){void 0===t&&(t=1);for(var i,s=this.getFocus()||this.input,r=this.getNavigator(s,!1),n=0;n<t&&(i=r.next(),i);n++)s=i;this.setFocus(s,e)},e.prototype.focusPrevious=function(t,e){void 0===t&&(t=1);for(var i,s=this.getFocus()||this.input,r=this.getNavigator(s,!1),n=0;n<t&&(i=r.previous(),i);n++)s=i;this.setFocus(s,e)},e.prototype.focusParent=function(t){var e=this.getFocus()||this.input,i=this.getNavigator(e,!1),s=i.parent();s&&this.setFocus(s,t)},e.prototype.focusFirstChild=function(t){var e=this.getItem(this.getFocus()||this.input),i=this.getNavigator(e,!1),s=i.next(),r=i.parent();r===e&&this.setFocus(s,t)},e.prototype.focusFirst=function(t){this.focusNth(0,t)},e.prototype.focusNth=function(t,e){for(var i=this.getNavigator(this.input),s=i.first(),r=0;r<t;r++)s=i.next();s&&this.setFocus(s,e)},e.prototype.focusLast=function(t){var e=this.getNavigator(this.input),i=e.last();i&&this.setFocus(i,t)},e.prototype.getNavigator=function(t,e){return void 0===t&&(t=null),void 0===e&&(e=!0),new f(this.getItem(t),e)},e.prototype.getItem=function(t){return void 0===t&&(t=null),null===t?this.input:t instanceof c?t:"string"==typeof t?this.registry.getItem(t):this.registry.getItem(this.context.dataSource.getId(this.context.tree,t))},e.prototype.addTraits=function(t,e){for(var i,s=this.traitsToItems[t]||{},r=0,n=e.length;r<n;r++)i=this.getItem(e[r]),i&&(i.addTrait(t),s[i.id]=i);this.traitsToItems[t]=s},e.prototype.removeTraits=function(t,e){var i,s,r=this.traitsToItems[t]||{};if(0===e.length){for(s in r)r.hasOwnProperty(s)&&(i=r[s],i.removeTrait(t));delete this.traitsToItems[t]}else for(var n=0,o=e.length;n<o;n++)i=this.getItem(e[n]),i&&(i.removeTrait(t),delete r[i.id])},e.prototype.hasTrait=function(t,e){var i=this.getItem(e);return i&&i.hasTrait(t)},e.prototype.toggleTrait=function(t,e){var i=this.getItem(e);i&&(i.hasTrait(t)?this.removeTraits(t,[e]):this.addTraits(t,[e]))},e.prototype.setTraits=function(t,e){if(0===e.length)this.removeTraits(t,e);else{for(var i,s={},r=0,n=e.length;r<n;r++)i=this.getItem(e[r]),i&&(s[i.id]=i);var o,h=this.traitsToItems[t]||{},l=[];for(o in h)h.hasOwnProperty(o)&&(s.hasOwnProperty(o)?delete s[o]:l.push(h[o]));for(var r=0,n=l.length;r<n;r++)i=l[r],i.removeTrait(t),delete h[i.id];for(o in s)s.hasOwnProperty(o)&&(i=s[o],i.addTrait(t),h[o]=i);this.traitsToItems[t]=h}},e.prototype.getElementsWithTrait=function(t,e){var i,s=[],r=this.traitsToItems[t]||{};for(i in r)r.hasOwnProperty(i)&&(r[i].isVisible()||e)&&s.push(r[i].getElement());return s},e.prototype.dispose=function(){this.registry&&(this.registry.dispose(),this.registry=null),t.prototype.dispose.call(this)},e}(o.EventEmitter);e.TreeModel=m});