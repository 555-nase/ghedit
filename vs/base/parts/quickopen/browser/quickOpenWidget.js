var __extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)};define(["require","exports","vs/nls","vs/base/common/winjs.base","vs/base/common/platform","vs/base/browser/browser","vs/base/common/events","vs/base/common/types","vs/base/common/errors","vs/base/common/uuid","vs/base/parts/quickopen/common/quickOpen","vs/base/parts/quickopen/browser/quickOpenViewer","vs/base/browser/builder","vs/base/browser/ui/inputbox/inputBox","vs/base/common/severity","vs/base/parts/tree/browser/treeImpl","vs/base/browser/ui/progressbar/progressbar","vs/base/browser/keyboardEvent","vs/base/parts/tree/browser/treeDefaults","vs/base/browser/dom","vs/base/common/keyCodes","vs/base/common/lifecycle","vs/base/common/scrollable","vs/css!./quickopen"],function(e,t,i,o,n,s,r,a,u,l,c,h,p,d,y,f,g,v,C,b,m,E,k){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";var w=function(e){function t(){e.apply(this,arguments)}return __extends(t,e),t.prototype.onContextMenu=function(t,i,o){return n.isMacintosh?this.onLeftClick(t,i,o):e.prototype.onContextMenu.call(this,t,i,o)},t}(C.DefaultController);t.QuickOpenController=w,function(e){e[e.ELEMENT_SELECTED=0]="ELEMENT_SELECTED",e[e.FOCUS_LOST=1]="FOCUS_LOST",e[e.CANCELED=2]="CANCELED"}(t.HideReason||(t.HideReason={}));var T=t.HideReason,x=i.localize("quickOpenAriaLabel","Quick picker. Type to narrow down results."),K=function(){function e(e,t,i,o){this.toUnbind=[],this.container=e,this.callbacks=t,this.options=i,this.usageLogger=o,this.model=null}return e.prototype.getModel=function(){return this.model},e.prototype.setCallbacks=function(e){this.callbacks=e},e.prototype.create=function(){var e=this;this.builder=p.$().div(function(t){t.on(b.EventType.KEY_DOWN,function(t){var i=new v.StandardKeyboardEvent(t);i.keyCode===m.KeyCode.Escape&&(b.EventHelper.stop(t,!0),e.hide(T.CANCELED))}).on(b.EventType.CONTEXT_MENU,function(e){return b.EventHelper.stop(e,!0)}).on(b.EventType.FOCUS,function(t){return e.gainingFocus()},null,!0).on(b.EventType.BLUR,function(t){return e.loosingFocus(t)},null,!0),e.progressBar=new g.ProgressBar(t.clone()),e.progressBar.getContainer().hide(),t.div({"class":"quick-open-input"},function(t){e.inputContainer=t,e.inputBox=new d.InputBox(t.getHTMLElement(),null,{placeholder:e.options.inputPlaceHolder||"",ariaLabel:x}),e.inputElement=e.inputBox.inputElement,e.inputElement.setAttribute("role","combobox"),e.inputElement.setAttribute("aria-haspopup","false"),e.inputElement.setAttribute("aria-autocomplete","list"),b.addDisposableListener(e.inputBox.inputElement,b.EventType.KEY_DOWN,function(t){var i=new v.StandardKeyboardEvent(t);if(n.isMacintosh&&(i.equals(m.CommonKeybindings.WINCTRL_N)?i.keyCode=m.KeyCode.DownArrow:i.equals(m.CommonKeybindings.WINCTRL_P)&&(i.keyCode=m.KeyCode.UpArrow)),i.keyCode!==m.KeyCode.Tab)if(i.keyCode===m.KeyCode.Tab||i.keyCode===m.KeyCode.DownArrow||i.keyCode===m.KeyCode.UpArrow||i.keyCode===m.KeyCode.PageDown||i.keyCode===m.KeyCode.PageUp)b.EventHelper.stop(t,!0),e.navigateInTree(i.keyCode,i.shiftKey);else if(i.keyCode===m.KeyCode.Enter){b.EventHelper.stop(t,!0);var o=e.tree.getFocus();o&&e.elementSelected(o,t)}else!s.isIE9||i.keyCode!==m.KeyCode.Backspace&&i.keyCode!==m.KeyCode.Delete||e.onType()}),b.addDisposableListener(e.inputBox.inputElement,b.EventType.INPUT,function(t){e.onType()})}),e.treeContainer=t.div({"class":"quick-open-tree"},function(t){e.tree=new f.Tree(t.getHTMLElement(),{dataSource:new h.DataSource(e),controller:new w({clickBehavior:C.ClickBehavior.ON_MOUSE_UP}),renderer:new h.Renderer(e),filter:new h.Filter(e),accessibilityProvider:new h.AccessibilityProvider(e)},{twistiePixels:11,indentPixels:0,alwaysFocused:!0,verticalScrollMode:k.ScrollbarVisibility.Visible,ariaLabel:i.localize("treeAriaLabel","Quick Picker")}),e.treeElement=e.tree.getHTMLElement(),e.toUnbind.push(e.tree.addListener2(r.EventType.FOCUS,function(t){e.elementFocused(t.focus,t)})),e.toUnbind.push(e.tree.addListener2(r.EventType.SELECTION,function(t){t.selection&&t.selection.length>0&&e.elementSelected(t.selection[0],t)}))}).on(b.EventType.KEY_DOWN,function(t){var i=new v.StandardKeyboardEvent(t);e.quickNavigateConfiguration&&(n.isMacintosh&&(i.equals(m.CommonKeybindings.WINCTRL_N)?i.keyCode=m.KeyCode.DownArrow:i.equals(m.CommonKeybindings.WINCTRL_P)&&(i.keyCode=m.KeyCode.UpArrow)),i.keyCode!==m.KeyCode.DownArrow&&i.keyCode!==m.KeyCode.UpArrow&&i.keyCode!==m.KeyCode.PageDown&&i.keyCode!==m.KeyCode.PageUp||(b.EventHelper.stop(t,!0),e.navigateInTree(i.keyCode)))}).on(b.EventType.KEY_UP,function(t){var i=new v.StandardKeyboardEvent(t),o=i.keyCode;if(e.quickNavigateConfiguration){var s=e.quickNavigateConfiguration.keybindings,r=o===m.KeyCode.Enter||s.some(function(e){if(e.hasShift()&&o===m.KeyCode.Shift)return!(i.ctrlKey||i.altKey||i.metaKey);if(e.hasAlt()&&o===m.KeyCode.Alt)return!0;if(n.isMacintosh){if(e.hasCtrlCmd()&&o===m.KeyCode.Meta)return!0;if(e.hasWinCtrl()&&o===m.KeyCode.Ctrl)return!0}else{if(e.hasCtrlCmd()&&o===m.KeyCode.Ctrl)return!0;if(e.hasWinCtrl()&&o===m.KeyCode.Meta)return!0}return!1});if(r){var a=e.tree.getFocus();a&&e.elementSelected(a,t)}}}).clone()}).addClass("quick-open-widget").addClass(s.isIE10orEarlier?" no-shadow":"").build(this.container),this.layoutDimensions&&this.layout(this.layoutDimensions)},e.prototype.onType=function(){var e=this.inputBox.value;this.helpText&&(e?this.helpText.hide():this.helpText.show()),this.callbacks.onType(e)},e.prototype.quickNavigate=function(e,t){this.isVisible&&(this.quickNavigateConfiguration||(this.quickNavigateConfiguration=e,this.tree.DOMFocus()),this.navigateInTree(t?m.KeyCode.DownArrow:m.KeyCode.UpArrow))},e.prototype.navigateInTree=function(e,t){var i=this.tree.getInput(),o=i?i.entries:[],n=this.tree.getFocus(),s=!1,r=!1;if(o.length>1&&(!(e===m.KeyCode.UpArrow||e===m.KeyCode.Tab&&t)||n!==o[0]&&n?e!==m.KeyCode.DownArrow&&(e!==m.KeyCode.Tab||t)||n!==o[o.length-1]||(this.tree.focusFirst(),s=!0):(this.tree.focusLast(),s=!0)),!s)switch(e){case m.KeyCode.DownArrow:this.tree.focusNext();break;case m.KeyCode.UpArrow:this.tree.focusPrevious();break;case m.KeyCode.PageDown:this.tree.focusNextPage();break;case m.KeyCode.PageUp:this.tree.focusPreviousPage();break;case m.KeyCode.Tab:t?this.tree.focusPrevious():this.tree.focusNext()}n=this.tree.getFocus(),n&&(r?this.tree.reveal(n,0).done(null,u.onUnexpectedError):this.tree.reveal(n).done(null,u.onUnexpectedError))},e.prototype.elementFocused=function(e,t){if(e&&this.isVisible()){this.inputElement.setAttribute("aria-activedescendant",this.treeElement.getAttribute("aria-activedescendant"));var i={event:t,keymods:this.extractKeyMods(t),quickNavigateConfiguration:this.quickNavigateConfiguration};this.model.runner.run(e,c.Mode.PREVIEW,i)}},e.prototype.elementSelected=function(e,t){var i=!0;if(this.isVisible()){var o={event:t,keymods:this.extractKeyMods(t),quickNavigateConfiguration:this.quickNavigateConfiguration};i=this.model.runner.run(e,c.Mode.OPEN,o)}if(this.usageLogger){var n=this.model.entries.indexOf(e),s=this.model.entries.length;this.usageLogger.publicLog("quickOpenWidgetItemAccepted",{index:n,count:s,isQuickNavigate:!!this.quickNavigateConfiguration})}i&&this.hide(T.ELEMENT_SELECTED)},e.prototype.extractKeyMods=function(e){var t=e&&(e.ctrlKey||e.metaKey||e.payload&&e.payload.originalEvent&&(e.payload.originalEvent.ctrlKey||e.payload.originalEvent.metaKey));return t?[m.KeyMod.CtrlCmd]:[]},e.prototype.show=function(e,t){this.visible=!0,this.isLoosingFocus=!1,this.quickNavigateConfiguration=t?t.quickNavigateConfiguration:void 0,this.quickNavigateConfiguration?(this.inputContainer.hide(),this.options.enableAnimations&&this.treeContainer.removeClass("transition"),this.builder.show(),this.tree.DOMFocus()):(this.inputContainer.show(),this.options.enableAnimations&&this.treeContainer.addClass("transition"),this.builder.show(),this.inputBox.focus()),this.helpText&&(this.quickNavigateConfiguration||a.isString(e)?this.helpText.hide():this.helpText.show()),a.isString(e)?this.doShowWithPrefix(e):this.doShowWithInput(e,t&&t.autoFocus?t.autoFocus:{}),this.callbacks.onShow&&this.callbacks.onShow()},e.prototype.doShowWithPrefix=function(e){this.inputBox.value=e,this.callbacks.onType(e)},e.prototype.doShowWithInput=function(e,t){this.setInput(e,t)},e.prototype.setInputAndLayout=function(e,t){var i=this,o=l.generateUuid();this.currentInputToken=o,this.setTreeHeightForInput(e).then(function(){i.currentInputToken===o&&i.tree.setInput(null).then(function(){return i.model=e,i.inputElement.setAttribute("aria-haspopup",String(e&&e.entries&&e.entries.length>0)),i.tree.setInput(e)}).done(function(){i.tree.layout(),e&&e.entries.some(function(t){return i.isElementVisible(e,t)})&&i.autoFocus(e,t)},u.onUnexpectedError)})},e.prototype.isElementVisible=function(e,t){return!e.filter||e.filter.isVisible(t)},e.prototype.autoFocus=function(e,t){var i=this;void 0===t&&(t={});var o=e.entries.filter(function(t){return i.isElementVisible(e,t)});if(t.autoFocusPrefixMatch){for(var n=void 0,s=void 0,r=t.autoFocusPrefixMatch,a=r.toLowerCase(),l=0;l<o.length;l++){var c=o[l],h=e.dataSource.getLabel(c);if(n||0!==h.indexOf(r)?s||0!==h.toLowerCase().indexOf(a)||(s=c):n=c,n&&s)break}var p=n||s;if(p)return this.tree.setFocus(p),void this.tree.reveal(p,0).done(null,u.onUnexpectedError)}t.autoFocusFirstEntry?(this.tree.focusFirst(),this.tree.reveal(this.tree.getFocus(),0).done(null,u.onUnexpectedError)):"number"==typeof t.autoFocusIndex?o.length>t.autoFocusIndex&&(this.tree.focusNth(t.autoFocusIndex),this.tree.reveal(this.tree.getFocus()).done(null,u.onUnexpectedError)):t.autoFocusSecondEntry?o.length>1&&this.tree.focusNth(1):t.autoFocusLastEntry&&o.length>1&&this.tree.focusLast()},e.prototype.refresh=function(e,t){var i=this;this.isVisible()&&this.setTreeHeightForInput(e).then(function(){i.tree.refresh().done(function(){i.tree.layout();var o=t&&e&&e.entries.some(function(t){return i.isElementVisible(e,t)});o&&!t.autoFocusPrefixMatch&&(o=!i.tree.getFocus()),o&&i.autoFocus(e,t)},u.onUnexpectedError)})},e.prototype.setTreeHeightForInput=function(e){var t=this,i=this.getHeight(e)+"px",n=this.treeContainer.style("height");return this.treeContainer.style({height:i}),this.treeContainer.hasClass("transition")&&n!==i?new o.TPromise(function(e,i){var o=[],n=!1,s=function(){n||(n=!0,o=E.dispose(o),e(null))};t.treeContainer.once("webkitTransitionEnd",s,o),t.treeContainer.once("transitionend",s,o)}):o.TPromise.as(null)},e.prototype.getHeight=function(t){var i=this,o=t.renderer;if(!t){var n=o.getHeight(null);return this.options.minItemsToShow?this.options.minItemsToShow*n:0}var s,r=0;this.layoutDimensions&&this.layoutDimensions.height&&(s=.4*(this.layoutDimensions.height-50)),(!s||s>e.MAX_ITEMS_HEIGHT)&&(s=e.MAX_ITEMS_HEIGHT);for(var a=t.entries.filter(function(e){return i.isElementVisible(t,e)}),u=this.options.maxItemsToShow||a.length,l=0;l<u&&l<a.length;l++){var c=o.getHeight(a[l]);if(!(r+c<=s))break;r+=c}return r},e.prototype.hide=function(e){var t=this;if(this.isVisible()){if(this.visible=!1,this.builder.hide(),this.builder.domBlur(),e===T.CANCELED&&this.model){var i=this.model.entries.filter(function(e){return t.isElementVisible(t.model,e)}).length;this.usageLogger&&this.usageLogger.publicLog("quickOpenWidgetCancelled",{count:i,isQuickNavigate:!!this.quickNavigateConfiguration})}this.inputBox.value="",this.tree.setInput(null),this.inputElement.setAttribute("aria-haspopup","false"),this.treeContainer.style({height:(this.options.minItemsToShow?22*this.options.minItemsToShow:0)+"px"}),this.progressBar.stop().getContainer().hide(),this.tree.isDOMFocused()?this.tree.DOMBlur():this.inputBox.hasFocus()&&this.inputBox.blur(),e===T.CANCELED?this.callbacks.onCancel():this.callbacks.onOk(),this.callbacks.onHide&&this.callbacks.onHide(e===T.FOCUS_LOST)}},e.prototype.getQuickNavigateConfiguration=function(){return this.quickNavigateConfiguration},e.prototype.setPlaceHolder=function(e){this.inputBox&&this.inputBox.setPlaceHolder(e)},e.prototype.setValue=function(e,t){this.inputBox&&(this.inputBox.value=e,t&&this.inputBox.select())},e.prototype.setPassword=function(e){this.inputBox&&(this.inputBox.inputElement.type=e?"password":"text")},e.prototype.setInput=function(e,t,i){this.isVisible()&&(this.setInputAndLayout(e,t),this.inputBox&&this.inputBox.setAriaLabel(i||x))},e.prototype.getInput=function(){return this.tree.getInput()},e.prototype.showInputDecoration=function(e){this.inputBox&&this.inputBox.showMessage({type:e===y["default"].Info?d.MessageType.INFO:e===y["default"].Warning?d.MessageType.WARNING:d.MessageType.ERROR,content:""})},e.prototype.clearInputDecoration=function(){this.inputBox&&this.inputBox.hideMessage()},e.prototype.runFocus=function(){var e=this.tree.getFocus();return!!e&&(this.elementSelected(e),!0)},e.prototype.getProgressBar=function(){return this.progressBar},e.prototype.setExtraClass=function(e){var t=this.builder.getProperty("extra-class");t&&this.builder.removeClass(t),e?(this.builder.addClass(e),this.builder.setProperty("extra-class",e)):t&&this.builder.removeProperty("extra-class")},e.prototype.isVisible=function(){return this.visible},e.prototype.layout=function(t){this.layoutDimensions=t;var i=Math.min(.62*this.layoutDimensions.width,e.MAX_WIDTH);this.builder&&(this.builder.style({width:i+"px",marginLeft:"-"+i/2+"px"}),this.inputContainer.style({width:i-12+"px"}))},e.prototype.gainingFocus=function(){this.isLoosingFocus=!1},e.prototype.loosingFocus=function(e){var t=this;if(this.isVisible()){var i=e.relatedTarget;!this.quickNavigateConfiguration&&b.isAncestor(i,this.builder.getHTMLElement())||(this.isLoosingFocus=!0,o.TPromise.timeout(0).then(function(){if(t.isLoosingFocus){var e=t.callbacks.onFocusLost&&t.callbacks.onFocusLost();e||t.hide(T.FOCUS_LOST)}}))}},e.prototype.dispose=function(){this.toUnbind=E.dispose(this.toUnbind),this.progressBar.dispose(),this.inputBox.dispose(),this.tree.dispose()},e.MAX_WIDTH=600,e.MAX_ITEMS_HEIGHT=440,e}();t.QuickOpenWidget=K});