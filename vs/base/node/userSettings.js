/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","fs","path","vs/base/common/json","vs/base/common/objects","vs/base/common/winjs.base","vs/base/common/event"],function(t,e,n,r,i,o,s,a){"use strict";var c=function(){function t(t,e){this.appSettingsPath=t,this.appKeybindingsPath=e,this._onChange=new a.Emitter,this.registerWatchers()}return t.getValue=function(e,o,a){var c=r.join(e,"User","settings.json");return new s.TPromise(function(e,r){n.readFile(c,function(n,r){var s=Object.create(null),c=r?r.toString():"{}",u=Object.create(null);try{u=i.parse(c)}catch(n){}for(var h in u)t.setNode(s,h,u[h]);return e(t.doGetValue(s,o,a))})})},Object.defineProperty(t.prototype,"onChange",{get:function(){return this._onChange.event},enumerable:!0,configurable:!0}),t.prototype.getValue=function(e,n){return t.doGetValue(this.globalSettings.settings,e,n)},t.doGetValue=function(t,e,n){if(!e)return n;for(var r=t,i=e.split(".");i.length&&r;){var o=i.shift();r=r[o]}return"undefined"!=typeof r?r:n},t.prototype.registerWatchers=function(){var t=this;this.watcher=n.watch(r.dirname(this.appSettingsPath)),this.watcher.on("change",function(e,n){return t.onSettingsFileChange(e,n)})},t.prototype.onSettingsFileChange=function(e,n){var r=this;this.timeoutHandle&&(global.clearTimeout(this.timeoutHandle),this.timeoutHandle=null),this.timeoutHandle=global.setTimeout(function(){var t=r.loadSync();t&&r._onChange.fire(r.globalSettings)},t.CHANGE_BUFFER_DELAY)},t.prototype.loadSync=function(){var t=this.doLoadSync();return!o.equals(t,this.globalSettings)&&(this.globalSettings=t,!0)},t.prototype.doLoadSync=function(){var t=this.doLoadSettingsSync();return{settings:t.contents,settingsParseErrors:t.parseErrors,keybindings:this.doLoadKeybindingsSync()}},t.prototype.doLoadSettingsSync=function(){var e=Object.create(null),r="{}";try{r=n.readFileSync(this.appSettingsPath).toString()}catch(o){}var s=Object.create(null);try{s=i.parse(r)}catch(o){return{contents:Object.create(null),parseErrors:[this.appSettingsPath]}}for(var a in s)t.setNode(e,a,s[a]);return{contents:e}},t.setNode=function(t,e,n){var r=e.split("."),i=r.pop(),o=t;r.forEach(function(t){var n=o[t];switch(typeof n){case"undefined":n=o[t]={};break;case"object":break;default:console.log("Conflicting user settings: "+e+" at "+t+" with "+JSON.stringify(n))}o=n}),o[i]=n},t.prototype.doLoadKeybindingsSync=function(){try{return i.parse(n.readFileSync(this.appKeybindingsPath).toString())}catch(t){}return[]},t.prototype.dispose=function(){this.watcher&&(this.watcher.close(),this.watcher=null)},t.CHANGE_BUFFER_DELAY=300,t}();e.UserSettings=c});