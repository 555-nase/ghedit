/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","vs/base/common/uuid","vs/base/common/strings","vs/base/common/platform","vs/base/node/flow","fs","path"],function(n,t,i,o,r,e,u,c){"use strict";function l(n,t){return r.isMacintosh?f(n,function(n,i){return n?t(n,null):t(null,i.map(function(n){return o.normalizeNFC(n)}))}):f(n,t)}function f(n,t){u.readdir(n,function(n,i){return n?t(n,null):t(null,i.filter(function(n){return"."!==n&&".."!==n}))})}function d(n,t,i){u.exists(n,function(o){return o?s(n,function(t,o){return t?i(t):o?void i(null):i(new Error('"'+n+'" is not a directory.'))}):void d(c.dirname(n),t,function(o){return o?void i(o):void(t?u.mkdir(n,t,function(o){return o?i(o):void u.chmod(n,t,i)}):u.mkdir(n,null,i))})})}function s(n,t){u.stat(n,function(n,i){return n?t(n):void t(null,i.isDirectory())})}function a(n,t,i,o){o||(o=Object.create(null)),u.stat(n,function(r,e){return r?i(r):e.isDirectory()?o[n]?i(null):(o[n]=!0,void d(t,511&e.mode,function(r){l(n,function(r,e){y(e,function(i,r){a(c.join(n,i),c.join(t,i),r,o)},i)})})):m(n,t,511&e.mode,i)})}function m(n,t,i,o){var r=!1,e=u.createReadStream(n),c=u.createWriteStream(t,{mode:i}),l=function(n){r||(r=!0,o(n))};e.on("error",l),c.on("error",l),e.on("end",function(){c.end(function(){r||(r=!0,u.chmod(t,i,o))})}),e.pipe(c,{end:!1})}function v(n,t,r,e){u.exists(n,function(l){return l?void u.stat(n,function(l,f){if(l||!f)return r(l);if("."===n[n.length-1]||o.endsWith(n,"./")||o.endsWith(n,".\\"))return h(n,r);var d=c.join(t,i.generateUuid());u.rename(n,d,function(t){return t?h(n,r):(r(null),void h(d,function(n){n&&console.error(n),e&&e(n)}))})}):r(null)})}function h(n,t){return"\\"===n||"/"===n?t(new Error("Will not delete root!")):void u.exists(n,function(i){i?u.lstat(n,function(i,o){if(i||!o)t(i);else if(!o.isDirectory()||o.isSymbolicLink()){var r=o.mode;128&r?u.unlink(n,t):u.chmod(n,128|r,function(i){i?t(i):u.unlink(n,t)})}else l(n,function(i,o){if(i||!o)t(i);else if(0===o.length)u.rmdir(n,t);else{var r=null,e=o.length;o.forEach(function(i){h(c.join(n,i),function(i){e--,i&&(r=r||i),0===e&&(r?t(r):u.rmdir(n,t))})})}})}):t(null)})}function p(n,t,i){function r(n){return n?i(n):void u.stat(t,function(n,o){return n?i(n):o.isDirectory()?i(null):void u.open(t,"a",null,function(n,t){return n?i(n):void u.futimes(t,o.atime,new Date,function(n){return n?i(n):void u.close(t,i)})})})}return n===t?i(null):void u.rename(n,t,function(e){return e?e&&n.toLowerCase()!==t.toLowerCase()&&"EXDEV"===e.code||o.endsWith(n,".")?a(n,t,function(t){return t?i(t):void h(n,r)}):i(e):r(null)})}var y=e.loop;t.readdir=l,t.mkdirp=d,t.copy=a,t.del=v,t.mv=p});