/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","vs/nls","path","fs","vs/base/common/async","vs/base/node/pfs","vs/base/common/winjs.base","yauzl"],function(n,e,r,t,o,u,i,c,f){"use strict";function a(n){var e=n.externalFileAttributes>>16||33188;return[448,56,7].map(function(n){return e&n}).reduce(function(n,e){return n+e},61440&e)}function s(n,e,r,u,f){var a=t.dirname(e),s=t.join(u,a),l=t.join(u,e);return i.mkdirp(s).then(function(){return new c.Promise(function(e,t){var u=o.createWriteStream(l,{mode:r});u.once("finish",function(){return e(null)}),u.once("error",t),n.once("error",t),n.pipe(u)})})}function l(n,e,r){return new c.Promise(function(o,f){var l=new u.SimpleThrottler,m=c.TPromise.as(null);n.once("error",f),n.once("close",function(){return m.then(o,f)}),n.on("entry",function(o){if(r.sourcePathRegex.test(o.fileName)){var c=o.fileName.replace(r.sourcePathRegex,"");if(/\/$/.test(c)){var f=t.join(e,c);return void(m=i.mkdirp(f))}var v=u.ninvoke(n,n.openReadStream,o),d=a(o);m=l.queue(function(){return v.then(function(n){return s(n,c,d,e,r)})})}})})}function m(n,e,r){void 0===r&&(r={});var t=new RegExp(r.sourcePath?"^"+r.sourcePath:""),o=u.nfcall(f.open,n);return r.overwrite&&(o=o.then(function(n){return i.rimraf(e),n})),o.then(function(n){return l(n,e,{sourcePathRegex:t})})}function v(n,e){return u.nfcall(f.open,n).then(function(n){return new c.TPromise(function(t,o){n.on("entry",function(r){r.fileName===e&&u.ninvoke(n,n.openReadStream,r).done(function(n){return t(n)},function(n){return o(n)})}),n.once("close",function(){return o(new Error(r.localize("notFound","{0} not found inside zip.",e)))})})})}function d(n,e){return v(n,e).then(function(n){return new c.TPromise(function(e,r){var t=[];n.once("error",r),n.on("data",function(n){return t.push(n)}),n.on("end",function(){return e(Buffer.concat(t))})})})}e.extract=m,e.buffer=d});