var __extends=this&&this.__extends||function(e,t){function s(){this.constructor=e}for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);e.prototype=null===t?Object.create(t):(s.prototype=t.prototype,new s)};define(["require","exports","path","child_process","stream","./stdFork","vs/nls","vs/base/common/winjs.base","vs/base/common/types","vs/base/common/uri","vs/base/common/objects","vs/base/common/paths","vs/base/common/platform","vs/base/node/decoder","vs/base/common/processes"],function(e,t,s,r,n,o,i,c,u,d,a,l,h,p,m){/*---------------------------------------------------------------------------------------------
     *  Copyright (c) Microsoft Corporation. All rights reserved.
     *  Licensed under the MIT License. See License.txt in the project root for license information.
     *--------------------------------------------------------------------------------------------*/
"use strict";function f(t,s){if(h.isWindows)try{var n={stdio:["pipe","pipe","ignore"]};s&&(n.cwd=s),r.execFileSync("taskkill",["/T","/F","/PID",t.pid.toString()],n)}catch(o){return{success:!1,error:o}}else if(h.isLinux||h.isMacintosh)try{var i=d["default"].parse(e.toUrl("vs/base/node/terminateProcess.sh")).fsPath,c=r.spawnSync(i,[t.pid.toString()]);if(c.error)return{success:!1,error:c.error}}catch(o){return{success:!1,error:o}}else t.kill("SIGKILL");return{success:!0}}function v(){return process.env.comspec||"cmd.exe"}var P=r.exec,w=r.spawn;t.Source=m.Source,t.terminateProcess=f,t.getWindowsShell=v;var g=function(){function e(e,t,s,r){var n=this;if(r)this.cmd=e,this.args=t,this.shell=s,this.options=r;else if(s&&t)this.module=e,this.args=t,this.shell=!1,this.options=s;else{var o=e;this.cmd=o.command,this.shell=o.isShellCommand,this.args=o.args.slice(0),this.options=o.options||{}}if(this.childProcess=null,this.terminateRequested=!1,this.options.env){var i=Object.create(null);Object.keys(process.env).forEach(function(e){i[e]=process.env[e]}),Object.keys(this.options.env).forEach(function(e){i[e]=n.options.env[e]}),this.options.env=i}}return e.prototype.getSanitizedCommand=function(){var t=this.cmd.toLowerCase(),r=t.lastIndexOf(s.sep);return r!==-1&&(t=t.substring(r+1)),e.WellKnowCommands[t]?t:"other"},e.prototype.start=function(){var e=this;return h.isWindows&&(this.options&&this.options.cwd&&l.isUNC(this.options.cwd)||!this.options&&!this.options.cwd&&l.isUNC(process.cwd()))?c.Promise.wrapError(i.localize("TaskRunner.UNC","Can't execute a shell command on an UNC drive.")):this.useExec().then(function(t){var s,r,n,i=new c.PPromise(function(e,t,o){s=e,r=t,n=o});if(t){var d=e.cmd;e.args&&(d=d+" "+e.args.join(" ")),e.childProcess=P(d,e.options,function(t,o,i){e.childProcess=null;var c=t;c&&c.killed?r({killed:e.terminateRequested,stdout:o.toString(),stderr:i.toString()}):e.handleExec(s,n,t,o,i)})}else{var l=null,p=function(t){e.childProcess=null,e.childProcessPromise=null,e.handleClose(t,s,n,r);var o={terminated:e.terminateRequested};u.isNumber(t)&&(o.cmdCode=t),s(o)};if(e.shell&&h.isWindows){var m=a.clone(e.options);m.windowsVerbatimArguments=!0,m.detached=!1;var f=!1,g=!1,S=[],y=e.ensureQuotes(e.cmd);S.push(y.value),f=y.quoted,e.args&&e.args.forEach(function(t){y=e.ensureQuotes(t),S.push(y.value),g=g&&y.quoted});var b=["/s","/c"];f?g?b.push('"'+S.join(" ")+'"'):S.length>1?b.push('"'+S[0]+'" '+S.slice(1).join(" ")):b.push('"'+S[0]+'"'):b.push(S.join(" ")),l=w(v(),b,m)}else e.cmd?l=w(e.cmd,e.args,e.options):e.module&&(e.childProcessPromise=new c.TPromise(function(t,i,c){o.fork(e.module,e.args,e.options,function(o,c){return o?(i(o),void r({terminated:e.terminateRequested,error:o})):(e.childProcess=c,e.childProcess.on("close",p),e.handleSpawn(c,s,n,r,!1),void t(c))})}));l&&(e.childProcess=l,e.childProcessPromise=c.TPromise.as(l),l.on("error",function(t){e.childProcess=null,r({terminated:e.terminateRequested,error:t})}),l.pid&&(e.childProcess.on("close",p),e.handleSpawn(l,s,n,r,!0)))}return i})},e.prototype.handleClose=function(e,t,s,r){},e.prototype.ensureQuotes=function(t){return e.regexp.test(t)?{value:'"'+t+'"',quoted:!0}:{value:t,quoted:t.length>0&&'"'===t[0]&&'"'===t[t.length-1]}},e.prototype.isRunning=function(){return null!==this.childProcessPromise},Object.defineProperty(e.prototype,"pid",{get:function(){return this.childProcessPromise.then(function(e){return e.pid},function(e){return-1})},enumerable:!0,configurable:!0}),e.prototype.terminate=function(){var e=this;return this.childProcessPromise?this.childProcessPromise.then(function(t){e.terminateRequested=!0;var s=f(t,e.options.cwd);return s.success&&(e.childProcess=null),s},function(e){return{success:!0}}):c.TPromise.as({success:!0})},e.prototype.useExec=function(){var e=this;return new c.TPromise(function(t,s,r){e.shell&&h.isWindows||t(!1);var n=w(v(),["/s","/c"]);n.on("error",function(e){t(!0)}),n.on("exit",function(e){t(!1)})})},e.WellKnowCommands={ant:!0,cmake:!0,eslint:!0,gradle:!0,grunt:!0,gulp:!0,jake:!0,jenkins:!0,jshint:!0,make:!0,maven:!0,msbuild:!0,msc:!0,nmake:!0,npm:!0,rake:!0,tsc:!0,xbuild:!0},e.regexp=/^[^"].* .*[^"]/,e}();t.AbstractProcess=g;var S=function(e){function t(t,s,r,n){e.call(this,t,s,r,n)}return __extends(t,e),t.prototype.handleExec=function(e,t,s,r,n){[r,n].forEach(function(e,s){var r=new p.LineDecoder,n=r.write(e);n.forEach(function(e){t({line:e,source:0===s?m.Source.stdout:m.Source.stderr})});var o=r.end();o&&t({line:o,source:0===s?m.Source.stdout:m.Source.stderr})}),e({terminated:this.terminateRequested,error:s})},t.prototype.handleSpawn=function(e,t,s,r,n){var o=this;this.stdoutLineDecoder=new p.LineDecoder,this.stderrLineDecoder=new p.LineDecoder,e.stdout.on("data",function(e){var t=o.stdoutLineDecoder.write(e);t.forEach(function(e){return s({line:e,source:m.Source.stdout})})}),e.stderr.on("data",function(e){var t=o.stderrLineDecoder.write(e);t.forEach(function(e){return s({line:e,source:m.Source.stderr})})})},t.prototype.handleClose=function(e,t,s,r){[this.stdoutLineDecoder.end(),this.stderrLineDecoder.end()].forEach(function(e,t){e&&s({line:e,source:0===t?m.Source.stdout:m.Source.stderr})})},t}(g);t.LineProcess=S;var y=function(e){function t(t,s,r,n){e.call(this,t,s,r,n)}return __extends(t,e),t.prototype.handleExec=function(e,t,s,r,n){t({data:r,source:m.Source.stdout}),t({data:n,source:m.Source.stderr}),e({terminated:this.terminateRequested,error:s})},t.prototype.handleSpawn=function(e,t,s,r,n){e.stdout.on("data",function(e){s({data:e,source:m.Source.stdout})}),e.stderr.on("data",function(e){s({data:e,source:m.Source.stderr})})},t}(g);t.BufferProcess=y;var b=function(e){function t(t,s,r,n){e.call(this,t,s,r,n)}return __extends(t,e),t.prototype.handleExec=function(e,t,s,r,o){var i=new n.PassThrough;i.end(r);var c=new n.PassThrough;c.end(o),t({stdin:null,stdout:i,stderr:c}),e({terminated:this.terminateRequested,error:s})},t.prototype.handleSpawn=function(e,t,s,r,n){n?process.nextTick(function(){s({stdin:e.stdin,stdout:e.stdout,stderr:e.stderr})}):s({stdin:e.stdin,stdout:e.stdout,stderr:e.stderr})},t}(g);t.StreamProcess=b});