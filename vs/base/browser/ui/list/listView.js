/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","vs/base/common/objects","vs/base/common/lifecycle","vs/base/browser/touch","vs/base/browser/dom","vs/base/browser/event","vs/base/browser/ui/scrollbar/scrollableElement","vs/base/common/scrollable","./rangeMap","./rowCache"],function(e,t,n,o,r,i,s,a,l,h,p){"use strict";var d=["click","dblclick","mouseup","mousedown","mouseover","mousemove","mouseout","contextmenu"],c={useShadows:!0},m=function(){function e(e,t,o,i){void 0===i&&(i=c),this.delegate=t,this.items=[],this.itemId=0,this.rangeMap=new h.RangeMap,this.renderers=n.toObject(o,function(e){return e.templateId}),this.cache=new p.RowCache(this.renderers),this.lastRenderTop=0,this.lastRenderHeight=0,this._domNode=document.createElement("div"),this._domNode.className="monaco-list",this.rowsContainer=document.createElement("div"),this.rowsContainer.className="monaco-list-rows",this.gesture=new r.Gesture(this.rowsContainer),this.scrollableElement=new a.ScrollableElement(this.rowsContainer,{canUseTranslate3d:!1,horizontal:l.ScrollbarVisibility.Hidden,vertical:l.ScrollbarVisibility.Auto,useShadows:n.getOrDefault(i,function(e){return e.useShadows},c.useShadows),saveLastScrollTimeOnClassName:"monaco-list-row"}),this._domNode.appendChild(this.scrollableElement.getDomNode()),e.appendChild(this._domNode),this.disposables=[this.rangeMap,this.gesture,this.scrollableElement],this.scrollableElement.onScroll(this.onScroll,this,this.disposables),s.domEvent(this.rowsContainer,r.EventType.Change)(this.onTouchChange,this,this.disposables),this.layout()}return Object.defineProperty(e.prototype,"domNode",{get:function(){return this._domNode},enumerable:!0,configurable:!0}),e.prototype.splice=function(e,t){for(var n=this,o=[],r=2;r<arguments.length;r++)o[r-2]=arguments[r];var i=this.getRenderRange(this.lastRenderTop,this.lastRenderHeight);h.each(i,function(e){return n.removeItemFromDOM(n.items[e])});var s=o.map(function(e){return{id:String(n.itemId++),element:e,size:n.delegate.getHeight(e),templateId:n.delegate.getTemplateId(e),row:null}});(d=this.rangeMap).splice.apply(d,[e,t].concat(s));var a=(c=this.items).splice.apply(c,[e,t].concat(s)),l=this.getRenderRange(this.lastRenderTop,this.lastRenderHeight);h.each(l,function(e){return n.insertItemInDOM(n.items[e],e)});var p=this.getContentHeight();return this.rowsContainer.style.height=p+"px",this.scrollableElement.updateState({scrollHeight:p}),a.map(function(e){return e.element});var d,c},Object.defineProperty(e.prototype,"length",{get:function(){return this.items.length},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"renderHeight",{get:function(){return this.scrollableElement.getHeight()},enumerable:!0,configurable:!0}),e.prototype.element=function(e){return this.items[e].element},e.prototype.elementHeight=function(e){return this.items[e].size},e.prototype.elementTop=function(e){return this.rangeMap.positionAt(e)},e.prototype.indexAt=function(e){return this.rangeMap.indexAt(e)},e.prototype.indexAfter=function(e){return this.rangeMap.indexAfter(e)},e.prototype.layout=function(e){this.scrollableElement.updateState({height:e||i.getContentHeight(this._domNode)})},e.prototype.render=function(e,t){var n=this,o=this.getRenderRange(this.lastRenderTop,this.lastRenderHeight),r=this.getRenderRange(e,t),i=h.relativeComplement(r,o),s=h.relativeComplement(o,r);i.forEach(function(e){return h.each(e,function(e){return n.insertItemInDOM(n.items[e],e)})}),s.forEach(function(e){return h.each(e,function(e){return n.removeItemFromDOM(n.items[e])})}),this.rowsContainer.style.transform="translate3d(0px, -"+e+"px, 0px)",this.lastRenderTop=e,this.lastRenderHeight=t},e.prototype.insertItemInDOM=function(e,t){e.row||(e.row=this.cache.alloc(e.templateId)),e.row.domNode.parentElement||this.rowsContainer.appendChild(e.row.domNode);var n=this.renderers[e.templateId];e.row.domNode.style.top=this.elementTop(t)+"px",e.row.domNode.style.height=e.size+"px",e.row.domNode.setAttribute("data-index",""+t),n.renderElement(e.element,t,e.row.templateData)},e.prototype.removeItemFromDOM=function(e){this.cache.release(e.row),e.row=null},e.prototype.getContentHeight=function(){return this.rangeMap.size},e.prototype.getScrollTop=function(){return this.scrollableElement.getScrollTop()},e.prototype.setScrollTop=function(e){this.scrollableElement.updateState({scrollTop:e})},Object.defineProperty(e.prototype,"scrollTop",{get:function(){return this.getScrollTop()},set:function(e){this.setScrollTop(e)},enumerable:!0,configurable:!0}),e.prototype.addListener=function(e,t,n){var o=this,s=t,a=this.domNode;return d.indexOf(e)>-1?t=function(e){return o.fireScopedEvent(s,o.getItemIndexFromMouseEvent(e))}:e===r.EventType.Tap&&(a=this.rowsContainer,t=function(e){return o.fireScopedEvent(s,o.getItemIndexFromGestureEvent(e))}),i.addDisposableListener(a,e,t,n)},e.prototype.fireScopedEvent=function(e,t){if(!(t<0)){var o=this.items[t].element;e(n.assign(event,{element:o,index:t}))}},e.prototype.onScroll=function(e){this.render(e.scrollTop,e.height)},e.prototype.onTouchChange=function(e){event.preventDefault(),event.stopPropagation(),this.scrollTop-=e.translationY},e.prototype.getItemIndexFromMouseEvent=function(e){return this.getItemIndexFromEventTarget(e.target)},e.prototype.getItemIndexFromGestureEvent=function(e){return this.getItemIndexFromEventTarget(e.initialTarget)},e.prototype.getItemIndexFromEventTarget=function(e){for(;e instanceof HTMLElement&&e!==this.rowsContainer;){var t=e,n=t.getAttribute("data-index");if(n){var o=Number(n);if(!isNaN(o))return o}e=t.parentElement}return-1},e.prototype.getRenderRange=function(e,t){return{start:this.rangeMap.indexAt(e),end:this.rangeMap.indexAfter(e+t-1)}},e.prototype.dispose=function(){this.items=null,this._domNode&&this._domNode.parentElement&&(this._domNode.parentNode.removeChild(this._domNode),this._domNode=null),this.disposables=o.dispose(this.disposables)},e}();t.ListView=m});