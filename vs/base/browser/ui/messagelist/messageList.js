/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","vs/nls","vs/base/common/winjs.base","vs/base/browser/builder","vs/base/browser/dom","vs/base/common/errors","vs/base/browser/ui/aria/aria","vs/base/common/types","vs/base/common/event","vs/base/common/actions","vs/base/browser/htmlContentRenderer","vs/base/browser/keyboardEvent","vs/base/common/keyCodes","vs/css!./messageList"],function(e,s,t,n,i,r,a,o,g,c,l,u,h,m){"use strict";!function(e){e[e.Info=0]="Info",e[e.Warning=1]="Warning",e[e.Error=2]="Error"}(s.Severity||(s.Severity={}));var p=s.Severity,f=function(){function e(){}return e}();s.IMessageListOptions=f;var d=function(){function e(s,t,n){void 0===n&&(n={purgeInterval:e.DEFAULT_MESSAGE_PURGER_INTERVAL,maxMessages:e.DEFAULT_MAX_MESSAGES,maxMessageLength:e.DEFAULT_MAX_MESSAGE_LENGTH}),this.messages=[],this.messageListPurger=null,this.containerElementId=s,this.usageLogger=t,this.options=n,this._onMessagesShowing=new c.Emitter,this._onMessagesCleared=new c.Emitter}return Object.defineProperty(e.prototype,"onMessagesShowing",{get:function(){return this._onMessagesShowing.event},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"onMessagesCleared",{get:function(){return this._onMessagesCleared.event},enumerable:!0,configurable:!0}),e.prototype.showMessage=function(e,s){var t=this;if(Array.isArray(s)){var n=[];return s.forEach(function(s){return n.push(t.showMessage(e,s))}),function(){return n.forEach(function(e){return e()})}}var i=this.getMessageText(s);return i&&"string"==typeof i?this.doShowMessage(s,i,e):function(){}},e.prototype.getMessageText=function(e){return g.isString(e)?e:e instanceof Error?a.toErrorMessage(e,!1):e.message?e.message:null},e.prototype.doShowMessage=function(e,s,n){var i=this;this.purgeMessages(),this.messages.unshift({id:e,text:s,severity:n,time:Date.now(),actions:e.actions}),this.renderMessages(!0,1);var r;return r=n===p.Error?t.localize("alertErrorMessage","Error: {0}",s):n===p.Warning?t.localize("alertWarningMessage","Warning: {0}",s):t.localize("alertInfoMessage","Info: {0}",s),o.alert(r),function(){i.hideMessage(e)}},e.prototype.renderMessages=function(e,s){var t=this,n=i.withElementById(this.containerElementId);n&&(this.messageListContainer?(i.$(this.messageListContainer).empty(),i.$(this.messageListContainer).removeClass("transition")):this.messageListContainer=i.$(".global-message-list").appendTo(n),e&&i.$(this.messageListContainer).style("top","-35px"),i.$(this.messageListContainer).ul({"class":"message-list"},function(n){var r=t.prepareMessages();r.length>0?t._onMessagesShowing.fire():t._onMessagesCleared.fire(),r.forEach(function(e,a){t.renderMessage(e,i.$(n),r.length,s)}),e&&setTimeout(function(){i.$(t.messageListContainer).addClass("transition"),i.$(t.messageListContainer).style("top","0")},50)}))},e.prototype.renderMessage=function(e,s,a,o){var g=this;s.li({"class":"message-list-entry message-list-entry-with-action"},function(s){var a=g.getMessageActions(e);s.div({"class":"actions-container"},function(s){for(var t=function(t){var i=a[t];s.div({"class":"message-action"},function(s){s.a({"class":"action-button",tabindex:"0",role:"button"}).text(i.label).on([r.EventType.CLICK,r.EventType.KEY_DOWN],function(s){if(s instanceof KeyboardEvent){var t=new h.StandardKeyboardEvent(s);if(!t.equals(m.CommonKeybindings.ENTER)&&!t.equals(m.CommonKeybindings.SPACE))return}r.EventHelper.stop(s,!0),g.usageLogger&&g.usageLogger.publicLog("workbenchActionExecuted",{id:i.id,from:"message"}),(i.run()||n.TPromise.as(null)).then(null,function(e){return g.showMessage(p.Error,e)}).done(function(s){s!==!1&&g.hideMessage(e.text)})})})},i=a.length-1;i>=0;i--)t(i)});var o=e.text.substr(0,g.options.maxMessageLength);s.div({"class":"message-left-side"},function(s){s.addClass("message-overflow-ellipsis");var n=e.severity,r=n===p.Error?t.localize("error","Error"):n===p.Warning?t.localize("warning","Warn"):t.localize("info","Info");i.$().span({"class":"message-left-side severity "+(n===p.Error?"app-error":n===p.Warning?"app-warning":"app-info"),text:r}).appendTo(s);var a=u.renderHtml({tagName:"span",className:"message-left-side",formattedText:o});i.$(a).title(a.textContent).appendTo(s)})})},e.prototype.getMessageActions=function(e){var s,i=this;return s=e.actions&&e.actions.length>0?e.actions:[new l.Action("close.message.action",t.localize("close","Close"),null,(!0),function(){return i.hideMessage(e.text),n.TPromise.as(!0)})]},e.prototype.prepareMessages=function(){for(var e=[],s={},t=0,n=0;n<this.messages.length;n++){var i=this.messages[n];g.isUndefinedOrNull(s[i.text])?(i.count=1,e.push(i),s[i.text]=t++):e[s[i.text]].count++}return e.length>this.options.maxMessages?e.splice(e.length-this.options.maxMessages,e.length):e},e.prototype.disposeMessages=function(e){e.forEach(function(e){e.actions&&e.actions.forEach(function(e){e.dispose()})})},e.prototype.hideMessages=function(){this.hideMessage()},e.prototype.show=function(){this.messageListContainer&&this.messageListContainer.isHidden()&&this.messageListContainer.show()},e.prototype.hide=function(){this.messageListContainer&&!this.messageListContainer.isHidden()&&this.messageListContainer.hide()},e.prototype.hideMessage=function(e){for(var s=!1,t=0;t<this.messages.length;t++){var n=this.messages[t],i=!1;i=!e||(g.isString(e)&&n.text===e||n.id===e),i&&(this.disposeMessages(this.messages.splice(t,1)),t--,s=!0)}s&&this.renderMessages(!1,-1)},e.prototype.purgeMessages=function(){var e=this;this.messageListPurger&&this.messageListPurger.cancel(),this.messageListPurger=n.TPromise.timeout(this.options.purgeInterval).then(function(){for(var s=!1,t=0,n=0;n<e.messages.length;n++){var i=e.messages[n];i.severity===p.Error||i.actions||(e.disposeMessages(e.messages.splice(n,1)),t--,n--,s=!0)}s&&e.renderMessages(!1,t)})},e.DEFAULT_MESSAGE_PURGER_INTERVAL=1e4,e.DEFAULT_MAX_MESSAGES=5,e.DEFAULT_MAX_MESSAGE_LENGTH=500,e}();s.MessageList=d});