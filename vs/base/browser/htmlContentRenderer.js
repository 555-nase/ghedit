/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require","exports","vs/base/browser/dom","vs/base/common/idGenerator","vs/base/common/strings","vs/base/common/winjs.base","vs/base/common/marked/marked"],function(e,t,n,r,o,i,a){"use strict";function c(e,t){void 0===t&&(t={});var n=e.map(function(e){return"string"==typeof e?{markdown:e}:"object"==typeof e?{code:e}:void 0});return d(n,t)}function d(e,t){return void 0===t&&(t={}),"string"==typeof e?s({isText:!0,text:e},t):Array.isArray(e)?s({children:e},t):e?s(e,t):void 0}function s(e,t){void 0===t&&(t={});var c=t.codeBlockRenderer,s=t.actionCallback;if(e.isText)return document.createTextNode(e.text);var f=l(e.tagName)||"div",m=document.createElement(f);if(e.className&&(m.className=e.className),e.text&&(m.textContent=e.text),e.style&&m.setAttribute("style",e.style),e.customStyle&&Object.keys(e.customStyle).forEach(function(t){m.style[t]=e.customStyle[t]}),e.children&&e.children.forEach(function(e){m.appendChild(d(e,t))}),e.formattedText&&u(m,p(e.formattedText),s),e.code&&c){var h=e.code,v=h.language,y=h.value;e.markdown="```"+v+"\n"+y+"\n```"}if(e.markdown){var x,k=new i.TPromise(function(e){return x=e}),b=new a.marked.Renderer;b.link=function(e,t,n){return'<a href="#" data-href="'+e+'" title="'+(t||n)+'">'+n+"</a>"},b.paragraph=function(e){return"<div>"+e+"</div>"},t.codeBlockRenderer&&(b.code=function(e,n){var a=t.codeBlockRenderer(n,e);if("string"==typeof a)return a;if(i.TPromise.is(a)){var c=r.defaultGenerator.nextId();return i.TPromise.join([a,k]).done(function(e){var t=e[0],n=m.querySelector('span[data-code="'+c+'"]');n&&(n.innerHTML=t)},function(e){}),'<span data-code="'+c+'">'+o.escape(e)+"</span>"}return e}),t.actionCallback&&n.addStandardDisposableListener(m,"click",function(e){if("A"===e.target.tagName){var n=e.target.dataset.href;n&&t.actionCallback(n,e)}}),m.innerHTML=a.marked(e.markdown,{sanitize:!0,renderer:b}),x()}return m}function l(e){return e&&v.hasOwnProperty(e)?e:null}function u(e,t,r){var o;if(t.type===h.Text)o=document.createTextNode(t.content);else if(t.type===h.Bold)o=document.createElement("b");else if(t.type===h.Italics)o=document.createElement("i");else if(t.type===h.Action){var i=document.createElement("a");i.href="#",n.addStandardDisposableListener(i,"click",function(e){r(String(t.index),e)}),o=i}else t.type===h.NewLine?o=document.createElement("br"):t.type===h.Root&&(o=e);e!==o&&e.appendChild(o),Array.isArray(t.children)&&t.children.forEach(function(e){u(o,e,r)})}function p(e){for(var t={type:h.Root,children:[]},n=0,r=t,o=[],i=new y(e);!i.eos();){var a=i.next(),c="\\"===a&&m(i.peek())!==h.Invalid;if(c&&(a=i.next()),!c&&f(a)&&a===i.peek()){i.advance(),r.type===h.Text&&(r=o.pop());var d=m(a);if(r.type===d||r.type===h.Action&&d===h.ActionClose)r=o.pop();else{var s={type:d,children:[]};d===h.Action&&(s.index=n,n++),r.children.push(s),o.push(r),r=s}}else if("\n"===a)r.type===h.Text&&(r=o.pop()),r.children.push({type:h.NewLine});else if(r.type!==h.Text){var l={type:h.Text,content:a};r.children.push(l),o.push(r),r=l}else r.content+=a}return r.type===h.Text&&(r=o.pop()),o.length,t}function f(e){return m(e)!==h.Invalid}function m(e){switch(e){case"*":return h.Bold;case"_":return h.Italics;case"[":return h.Action;case"]":return h.ActionClose;default:return h.Invalid}}t.renderMarkedString=c,t.renderHtml=d;var h,v={a:!0,b:!0,blockquote:!0,code:!0,del:!0,dd:!0,div:!0,dl:!0,dt:!0,em:!0,h1h2h3i:!0,img:!0,kbd:!0,li:!0,ol:!0,p:!0,pre:!0,s:!0,span:!0,sup:!0,sub:!0,strong:!0,strike:!0,ul:!0,br:!0,hr:!0},y=function(){function e(e){this.source=e,this.index=0}return e.prototype.eos=function(){return this.index>=this.source.length},e.prototype.next=function(){var e=this.peek();return this.advance(),e},e.prototype.peek=function(){return this.source[this.index]},e.prototype.advance=function(){this.index++},e}();!function(e){e[e.Invalid=0]="Invalid",e[e.Root=1]="Root",e[e.Text=2]="Text",e[e.Bold=3]="Bold",e[e.Italics=4]="Italics",e[e.Action=5]="Action",e[e.ActionClose=6]="ActionClose",e[e.NewLine=7]="NewLine"}(h||(h={}))});