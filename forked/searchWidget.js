/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)};define(["require","exports","vs/nls","vs/base/common/strings","vs/base/browser/dom","vs/base/common/winjs.base","vs/base/browser/ui/widget","vs/base/common/actions","forked/findInput","vs/base/browser/ui/inputbox/inputBox","vs/base/browser/ui/button/button","vs/platform/keybinding/common/keybindingsRegistry","vs/platform/keybinding/common/keybinding","vs/base/common/keyCodes","vs/base/common/event","vs/workbench/services/viewlet/common/viewletService","forked/searchActions","vs/editor/contrib/find/common/findController"],function(e,t,n,i,o,r,s,a,c,l,p,h,u,d,g,A,y,f){"use strict";function E(){h.KeybindingsRegistry.registerCommandDesc({id:v.ID,weight:h.KeybindingsRegistry.WEIGHT.workbenchContrib(),when:u.KbExpr.and(u.KbExpr.has("searchViewletVisible"),u.KbExpr.has(b.REPLACE_ACTIVE_CONTEXT_KEY),u.KbExpr.not(f.CONTEXT_FIND_WIDGET_VISIBLE)),primary:d.KeyMod.Alt|d.KeyMod.CtrlCmd|d.KeyCode.Enter,handler:function(e){y.isSearchViewletFocussed(e.get(A.IViewletService))&&v.INSTANCE.run()}})}var v=function(e){function t(){e.call(this,t.ID,"","action-replace-all",!1),this._searchWidget=null}return __extends(t,e),Object.defineProperty(t,"INSTANCE",{get:function(){return null===t.fgInstance&&(t.fgInstance=new t),t.fgInstance},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"searchWidget",{set:function(e){this._searchWidget=e},enumerable:!0,configurable:!0}),t.prototype.run=function(){return this._searchWidget?this._searchWidget.triggerReplaceAll():r.TPromise.as(null)},t.fgInstance=null,t.ID="search.action.replaceAll",t}(a.Action),b=function(e){function t(n,i,o,r,s){void 0===o&&(o=Object.create(null)),e.call(this),this.contextViewService=i,this.keyBindingService=r,this.instantiationService=s,this._onSearchSubmit=this._register(new g.Emitter),this.onSearchSubmit=this._onSearchSubmit.event,this._onSearchCancel=this._register(new g.Emitter),this.onSearchCancel=this._onSearchCancel.event,this._onReplaceToggled=this._register(new g.Emitter),this.onReplaceToggled=this._onReplaceToggled.event,this._onReplaceStateChange=this._register(new g.Emitter),this.onReplaceStateChange=this._onReplaceStateChange.event,this._onReplaceValueChanged=this._register(new g.Emitter),this.onReplaceValueChanged=this._onReplaceValueChanged.event,this._onKeyDownArrow=this._register(new g.Emitter),this.onKeyDownArrow=this._onKeyDownArrow.event,this._onReplaceAll=this._register(new g.Emitter),this.onReplaceAll=this._onReplaceAll.event,this.replaceActive=this.keyBindingService.createKey(t.REPLACE_ACTIVE_CONTEXT_KEY,!1),this.render(n,o)}return __extends(t,e),t.prototype.focus=function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!1),!t&&this.searchInput.inputBox.hasFocus()||t&&this.replaceInput.hasFocus()||(t&&this.isReplaceShown()?(this.replaceInput.focus(),e&&this.replaceInput.select()):(this.searchInput.focus(),e&&this.searchInput.select()))},t.prototype.setWidth=function(e){this.searchInput.setWidth(e-2),this.replaceInput.width=e-28},t.prototype.clear=function(){this.searchInput.clear(),this.replaceInput.value="",this.setReplaceAllActionState(!1)},t.prototype.isReplaceShown=function(){return!o.hasClass(this.replaceInputContainer,"disabled")},t.prototype.getReplaceValue=function(){return this.replaceInput.value},t.prototype.toggleReplace=function(e){void 0!==e&&e===this.isReplaceShown()||this.onToggleReplaceButton()},t.prototype.render=function(e,t){this.domNode=e.div({"class":"search-widget"}).style({position:"relative"}).getHTMLElement(),this.renderToggleReplaceButton(this.domNode),this.renderSearchInput(this.domNode,t),this.renderReplaceInput(this.domNode)},t.prototype.renderToggleReplaceButton=function(e){var t=this;this.toggleReplaceButton=this._register(new p.Button(e)),this.toggleReplaceButton.icon="toggle-replace-button collapse",this.toggleReplaceButton.addListener2("click",function(){return t.onToggleReplaceButton()}),this.toggleReplaceButton.getElement().title=n.localize("search.replace.toggle.button.title","Toggle Replace")},t.prototype.renderSearchInput=function(e,t){var i=this,r={label:n.localize("label.Search","Search: Type Search Term and press Enter to search or Escape to cancel"),validation:function(e){return i.validatSearchInput(e)},placeholder:n.localize("search.placeHolder","Search")},s=o.append(e,o.emmet(".search-box.input-box"));this.searchInput=this._register(new c.FindInput(s,this.contextViewService,r)),this.searchInput.onKeyUp(function(e){return i.onSearchInputKeyUp(e)}),this.searchInput.onKeyDown(function(e){return i.onSearchInputKeyDown(e)}),this.searchInput.setValue(t.value||""),this.searchInput.setRegex(!!t.isRegex),this.searchInput.setCaseSensitive(!!t.isCaseSensitive),this.searchInput.setWholeWords(!!t.isWholeWords)},t.prototype.renderReplaceInput=function(e){var i=this;this.replaceAllAction=v.INSTANCE,this.replaceAllAction.searchWidget=this,this.replaceAllAction.label=t.REPLACE_ALL_DISABLED_LABEL,this.replaceInputContainer=o.append(e,o.emmet(".replace-box.input-box.disabled")),this.replaceInput=this._register(new l.InputBox(this.replaceInputContainer,this.contextViewService,{ariaLabel:n.localize("label.Replace","Replace: Type replace term and press Enter to preview or Escape to cancel"),placeholder:n.localize("search.replace.placeHolder","Replace"),actions:[this.replaceAllAction]})),this.onkeydown(this.replaceInput.inputElement,function(e){return i.onReplaceInputKeyDown(e)}),this.onkeyup(this.replaceInput.inputElement,function(e){return i.onReplaceInputKeyUp(e)}),this.replaceInput.onDidChange(function(){return i._onReplaceValueChanged.fire()}),this.searchInput.inputBox.onDidChange(function(){return i.onSearchInputChanged()})},t.prototype.triggerReplaceAll=function(){return this._onReplaceAll.fire(),r.TPromise.as(null)},t.prototype.onToggleReplaceButton=function(){o.toggleClass(this.replaceInputContainer,"disabled"),o.toggleClass(this.toggleReplaceButton.getElement(),"collapse"),o.toggleClass(this.toggleReplaceButton.getElement(),"expand"),this.updateReplaceActiveState(),this._onReplaceToggled.fire()},t.prototype.setReplaceAllActionState=function(e){this.replaceAllAction.enabled!==e&&(this.replaceAllAction.enabled=e,this.replaceAllAction.label=e?t.REPLACE_ALL_ENABLED_LABEL(this.keyBindingService):t.REPLACE_ALL_DISABLED_LABEL,this.updateReplaceActiveState())},t.prototype.isReplaceActive=function(){return this.keyBindingService.getContextValue(t.REPLACE_ACTIVE_CONTEXT_KEY)},t.prototype.updateReplaceActiveState=function(){var e=this.isReplaceActive(),t=this.isReplaceShown()&&this.replaceAllAction.enabled;e!==t&&(this.replaceActive.set(t),this._onReplaceStateChange.fire(t))},t.prototype.validatSearchInput=function(e){if(0===e.length)return null;if(!this.searchInput.getRegex())return null;var t;try{t=new RegExp(e)}catch(o){return{content:o.message}}return i.regExpLeadsToEndlessLoop(t)?{content:n.localize("regexp.validationFailure","Expression matches everything")}:void 0},t.prototype.onSearchInputChanged=function(){this.setReplaceAllActionState(!1)},t.prototype.onSearchInputKeyUp=function(e){switch(e.keyCode){case d.KeyCode.Enter:return void this.submitSearch();case d.KeyCode.Escape:return void this._onSearchCancel.fire();default:return}},t.prototype.onSearchInputKeyDown=function(e){var t=!1;switch(e.keyCode){case d.KeyCode.DownArrow:this.isReplaceShown()?this.focus(!0,!0):this._onKeyDownArrow.fire(),t=!0}t&&e.preventDefault()},t.prototype.onReplaceInputKeyUp=function(e){switch(e.keyCode){case d.KeyCode.Enter:return void this.submitSearch();case d.KeyCode.Escape:return this.onToggleReplaceButton(),void this.searchInput.focus();default:return}},t.prototype.onReplaceInputKeyDown=function(e){var t=!1;switch(e.keyCode){case d.KeyCode.UpArrow:this.focus(!0),t=!0;break;case d.KeyCode.DownArrow:this._onKeyDownArrow.fire(),t=!0}t&&e.preventDefault()},t.prototype.submitSearch=function(e){void 0===e&&(e=!0),this.searchInput.getValue()&&this._onSearchSubmit.fire(e)},t.prototype.dispose=function(){this.setReplaceAllActionState(!1),this.replaceAllAction.searchWidget=null,e.prototype.dispose.call(this)},t.REPLACE_ACTIVE_CONTEXT_KEY="replaceActive",t.REPLACE_ALL_DISABLED_LABEL=n.localize("search.action.replaceAll.disabled.label","Replace All (Submit Search to Enable)"),t.REPLACE_ALL_ENABLED_LABEL=function(e){var t=e.lookupKeybindings(v.ID);return y.appendKeyBindingLabel(n.localize("search.action.replaceAll.enabled.label","Replace All"),t[0],e)},t}(s.Widget);t.SearchWidget=b,t.registerContributions=E});