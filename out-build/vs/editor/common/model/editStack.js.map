{"version":3,"file":"editStack.js","sourceRoot":"","sources":["../../../../../src/vs/editor/common/model/editStack.ts"],"names":[],"mappings":"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","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n'use strict';\n\nimport {onUnexpectedError} from 'vs/base/common/errors';\nimport {ICursorStateComputer, IEditableTextModel, IEditorSelection, IIdentifiedSingleEditOperation} from 'vs/editor/common/editorCommon';\n\ninterface IEditOperation {\n\toperations: IIdentifiedSingleEditOperation[];\n}\n\ninterface IStackElement {\n\tbeforeVersionId: number;\n\tbeforeCursorState: IEditorSelection[];\n\n\teditOperations: IEditOperation[];\n\n\tafterCursorState: IEditorSelection[];\n\tafterVersionId: number;\n}\n\nexport interface IUndoRedoResult {\n\tselections: IEditorSelection[];\n\trecordedVersionId: number;\n}\n\nexport class EditStack {\n\n\tprivate model:IEditableTextModel;\n\tprivate currentOpenStackElement:IStackElement;\n\tprivate past:IStackElement[];\n\tprivate future:IStackElement[];\n\n\tconstructor(model:IEditableTextModel) {\n\t\tthis.model = model;\n\t\tthis.currentOpenStackElement = null;\n\t\tthis.past = [];\n\t\tthis.future = [];\n\t}\n\n\tpublic pushStackElement(): void {\n\t\tif (this.currentOpenStackElement !== null) {\n\t\t\tthis.past.push(this.currentOpenStackElement);\n\t\t\tthis.currentOpenStackElement = null;\n\t\t}\n\t}\n\n\tpublic clear(): void {\n\t\tthis.currentOpenStackElement = null;\n\t\tthis.past = [];\n\t\tthis.future = [];\n\t}\n\n\tpublic pushEditOperation(beforeCursorState: IEditorSelection[], editOperations:IIdentifiedSingleEditOperation[], cursorStateComputer:ICursorStateComputer): IEditorSelection[] {\n\t\t// No support for parallel universes :(\n\t\tthis.future = [];\n\n\t\tif (!this.currentOpenStackElement) {\n\t\t\tthis.currentOpenStackElement = {\n\t\t\t\tbeforeVersionId: this.model.getAlternativeVersionId(),\n\t\t\t\tbeforeCursorState: beforeCursorState,\n\t\t\t\teditOperations: [],\n\t\t\t\tafterCursorState: null,\n\t\t\t\tafterVersionId: -1\n\t\t\t};\n\t\t}\n\n\t\tvar inverseEditOperation:IEditOperation = {\n\t\t\toperations: this.model.applyEdits(editOperations)\n\t\t};\n\n\t\tthis.currentOpenStackElement.editOperations.push(inverseEditOperation);\n\t\ttry {\n\t\t\tthis.currentOpenStackElement.afterCursorState = cursorStateComputer ? cursorStateComputer(inverseEditOperation.operations) : null;\n\t\t} catch (e) {\n\t\t\tonUnexpectedError(e);\n\t\t\tthis.currentOpenStackElement.afterCursorState = null;\n\t\t}\n\t\tthis.currentOpenStackElement.afterVersionId = this.model.getVersionId();\n\t\treturn this.currentOpenStackElement.afterCursorState;\n\t}\n\n\tpublic undo(): IUndoRedoResult {\n\n\t\tthis.pushStackElement();\n\n\t\tif (this.past.length > 0) {\n\t\t\tvar pastStackElement = this.past.pop();\n\n\t\t\ttry {\n\t\t\t\t// Apply all operations in reverse order\n\t\t\t\tfor (var i = pastStackElement.editOperations.length - 1; i >= 0; i--) {\n\t\t\t\t\tpastStackElement.editOperations[i] = {\n\t\t\t\t\t\toperations: this.model.applyEdits(pastStackElement.editOperations[i].operations)\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t} catch(e) {\n\t\t\t\tthis.clear();\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tthis.future.push(pastStackElement);\n\n\t\t\treturn {\n\t\t\t\tselections: pastStackElement.beforeCursorState,\n\t\t\t\trecordedVersionId: pastStackElement.beforeVersionId\n\t\t\t};\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tpublic redo(): IUndoRedoResult {\n\n\t\tif (this.future.length > 0) {\n\t\t\tif (this.currentOpenStackElement) {\n\t\t\t\tthrow new Error('How is this possible?');\n\t\t\t}\n\n\t\t\tvar futureStackElement = this.future.pop();\n\n\t\t\ttry {\n\t\t\t\t// Apply all operations\n\t\t\t\tfor (var i = 0; i < futureStackElement.editOperations.length; i++) {\n\t\t\t\t\tfutureStackElement.editOperations[i] = {\n\t\t\t\t\t\toperations: this.model.applyEdits(futureStackElement.editOperations[i].operations)\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t} catch(e) {\n\t\t\t\tthis.clear();\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\tthis.past.push(futureStackElement);\n\n\t\t\treturn {\n\t\t\t\tselections: futureStackElement.afterCursorState,\n\t\t\t\trecordedVersionId: futureStackElement.afterVersionId\n\t\t\t};\n\t\t}\n\n\t\treturn null;\n\t}\n}\n"]}